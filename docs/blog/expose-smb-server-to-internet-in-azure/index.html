<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><title>Exposing a Samba Server to the Internet in Azure | Ef's log</title><meta name=keywords content="Microsoft Azure,Samba,Cloud"><meta name=description content="And wait for bad things to happen"><meta name=author content="Fahmi FJ"><link rel=canonical href=https://fahmifj.github.io/blog/expose-smb-server-to-internet-in-azure/><meta name=google-site-verification content="LlCRq--iL8r1HTz1DMbMvQyX2lZjWD-KnwFeO_OWlg8"><link crossorigin=anonymous href=https://fahmifj.github.io/assets/css/stylesheet.min.bd459bfe4940cb0279a97213c67be3816bd3751510c3b6af22df24e8740767ba.css integrity="sha256-vUWb/klAywJ5qXITxnvjgWvTdRUQw7avIt8k6HQHZ7o=" rel="preload stylesheet" as=style><link crossorigin=anonymous rel=preload as=fetch href=https://fahmifj.github.io/index.json><script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/search.min.dbf3c8b1e1d3feb24da21a556bdfb2f51a0273aa11efcd4640113536ee29d424.js integrity="sha256-2/PIseHT/rJNohpVa9+y9RoCc6oR781GQBE1Nu4p1CQ="></script>
<script defer crossorigin=anonymous src=https://fahmifj.github.io/assets/js/highlight.min.22059b46810f6ad868c7821e09643fcd3324a7aece939a3b9d810ddf8cc89e0d.js integrity="sha256-IgWbRoEPathox4IeCWQ/zTMkp67Ok5o7nYEN34zIng0=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://fahmifj.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fahmifj.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fahmifj.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fahmifj.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fahmifj.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.102.1"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-PDN0GP97D1"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-PDN0GP97D1",{anonymize_ip:!1})}</script><meta property="og:title" content="Exposing a Samba Server to the Internet in Azure"><meta property="og:description" content="And wait for bad things to happen"><meta property="og:type" content="article"><meta property="og:url" content="https://fahmifj.github.io/blog/expose-smb-server-to-internet-in-azure/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-07-04T19:45:21+07:00"><meta property="article:modified_time" content="2021-07-04T19:45:21+07:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Exposing a Samba Server to the Internet in Azure"><meta name=twitter:description content="And wait for bad things to happen"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Blog","item":"https://fahmifj.github.io/blog/"},{"@type":"ListItem","position":2,"name":"Exposing a Samba Server to the Internet in Azure","item":"https://fahmifj.github.io/blog/expose-smb-server-to-internet-in-azure/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Exposing a Samba Server to the Internet in Azure","name":"Exposing a Samba Server to the Internet in Azure","description":"And wait for bad things to happen","keywords":["Microsoft Azure","Samba","Cloud"],"articleBody":"Last month, I was asked to setup a Samba/SMB server that is accessible over the Internet. Because it will only be used temporarily, I decided to use an Azure Virtual Machine (VM) instead of buying a dedicated VPS.\nIn the end the server was not used though, but I’ll share my documentation about it.\nBefore proceeding further, I will state that:\nExposing an SMB Server directly to the Internet is not recommended, or not considered to be ‘best practice’. The safest way to make it accessible over the Internet is by setting up a VPN server and putting the SMB inside the VPN network.\nGoals and Outcomes The goals here are exactly the same as what’s written in the title, but by the end of this post, you should be able to:\nDeploy an Ubuntu server in Azure Setup and Configure a Samba server Exposing Samba server over Internet (but don’t) Prerequisites The one and only prerequisite is:\nAzure Account Also, since this post won’t be detailed step by step, I’ll assume that you have:\nBasic knowledge of Azure, at least menu navigation and creating a resource group. Basic knowledge of Linux Let’s jump in!\nVM Configuration \u0026 Deploy At this step, I already have a resource group called IAMF_SMB-TEST and I’ll be creating a VM instance inside this resource. It’s a small server used by 4-5 users, so B1s will be enough. You’re free to customize the VM.\nThe VM details of mine can be seen in the following image:\nFor authentication to the server, I’ll be using an SSH public key here instead of a password. The account for server administration is called azure-smb. Since the authentication is SSH, this VM will have an SSH port open publicly (internet).\nIn the following section, I’ll use a standard SSD and leave the other settings at their defaults.\nIn the Networking section, I’ll just create a new virtual network. See the following image for details:\nIn the Management section, because it will be temporary, I’ll just disable the boot diagnostics.\nI’ll leave the Advanced with the default settings and skip the Tags section.\nThe last section is Review + Create, which basically reviews the VM configuration. After I finish the review, I’ll press the Create button.\nWhen the Create button is clicked, the VM will be automatically deployed.\nTest SSH Login The next step is to login to the deployed VM instance via SSH using the previously created username and key/password. The public IP of the VM instance can be found at the Dashboard \u003e RESOURCE_GROUP_NAME \u003e PUBLIC_IP_NAME. In my case, it is Dashboard \u003e IAMF_SMB-TEST \u003e smb-server-ip.\n$ ssh -i private_key azure-smb@PUBLIC_IP_ADDRESS Samba Configuration Installation and Initial Setup First thing first, let’s update the repository list.\nazure-smb@smb-server:~$ sudo apt update After that, install Samba with the following command.\nazure-smb@smb-server:~$ sudo apt install samba Once the installation is done, check the Samba service daemon status.\nazure-smb@smb-server:~$ sudo systemctl status smbd ● smbd.service - Samba SMB Daemon Loaded: loaded (/lib/systemd/system/smbd.service; enabled; vendor preset: enabled) Active: active (running) since Thu 2021-05-13 10:17:45 UTC; 3min 48s ago Docs: man:smbd(8) man:samba(7) man:smb.conf(5) Main PID: 2098 (smbd) Status: \"smbd: ready to serve connections...\" Tasks: 4 (limit: 1056) CGroup: /system.slice/smbd.service ├─2098 /usr/sbin/smbd --foreground --no-process-group ├─2123 /usr/sbin/smbd --foreground --no-process-group ├─2124 /usr/sbin/smbd --foreground --no-process-group └─2129 /usr/sbin/smbd --foreground --no-process-group May 13 10:17:44 smb-server systemd[1]: Starting Samba SMB Daemon... May 13 10:17:45 smb-server systemd[1]: Started Samba SMB Daemon. Samba is ready, and now let’s configure the share folder.\nShares Configuration First, let’s create a backup file of the original configuration, so we can reset it to the default configuration, just in case something goes wrong.\nazure-smb@smb-server:~$ sudo cp /etc/samba/smb.conf{,.backup} Now create a share folder name it sambashare.\nazure-smb@smb-server:~$ mkdir sambashare Then open the samba configuration file with a text editor like nano.\nazure-smb@smb-server:~$ sudo nano /etc/samba/smb.conf Go straight to the bottom of the file and add the following lines.\n[sambashare] comment = Samba Share path = /home/azure-smb/sambashare read only = no browsable = yes Details for configuring share can be read here or here.\nSave the file and restart the SMB daemon with the following command:\nazure-smb@smb-server:~$ sudo service smbd restart Lastly, update the firewall to allow network traffic for Samba/SMB.\nazure-smb@smb-server:~$ sudo ufw allow samba This is the basic configuration of creating a Samba share, but from here you can create another share with more complex configuration. Here are my references:\nhttps://linuxize.com/post/how-to-install-and-configure-samba-on-ubuntu-18-04/ https://confluence.jaytaala.com/display/TKB/Create+samba+share+writeable+by+all%2C+group%2C+or+only+a+user https://www.digitalocean.com/community/tutorials/how-to-set-up-a-samba-share-for-a-small-organization-on-ubuntu-16-04 Add Samba User Currently, our Linux account for administering the server is azure-smb and we can’t use this account password to access the SMB shares yet. Instead, we need to create a password and bind it to azure-smb.\nBut now, let’s just create a dedicated user for SMB called user1.\nazure-smb@smb-server:~$ sudo useradd --system -s /usr/sbin/nologin user1 Assign user1 to be the owner of the share\nazure-smb@smb-server:~$ sudo chown user1 /home/azure-smb/sambashare After that, create a Samba password for user1.\nazure-smb@smb-server:~$ sudo smbpasswd -a user1 New SMB password: Retype new SMB password: Added user user1. Finally, enable the user.\nazure-smb@smb-server:~$ sudo smbpasswd -e user1 Enabled user user1. Expose to Internet Allow Inbound Connection Now if we want to make it available on the Internet, we have to go back to the Azure Portal to open the SMB port (445) on the NIC Public IP and allow inbound connection through that port. The connection is then forwarded to our SMB port on the NIC Private IP.\nPUBLIC_IP:445 --\u003e PRIVATE_IP:445 To do that open up the Networking settings of the SMB VM and click on Add inbound port rule button.\nOn the new Windows, configure the rule to allow any source (incoming IP) and any source port (incoming port) to connect to the SMB port (445). The details configuration is as follows:\nAt the bottom, the configuration is as follows:\nWhen you’re done, click on the Add button and the new rule should listed in the Inbound port rules section.\nTest Access We can use Nmap to see if the SMB port has been opened.\n$ nmap -p445 -sV VM_PUBLIC_IP To interact with the SMB server via CLI, you can use smbclient. Install it with:\n$ sudo apt install smbclient Once it installed, connect to the share with following command:\n$ smbclient //[IP]/[sharename] Adding -N -L can list all the available shares.\nYou can also provide the password directly in the terminal:\n$ smbclient //[IP]/[sharename] -U [username] [password] $ smbclient //[IP]/[sharename] -U 'username%password' And that’s all. It is not that detailed, but I hope you will find it useful.\n","wordCount":"1081","inLanguage":"en","datePublished":"2021-07-04T19:45:21+07:00","dateModified":"2021-07-04T19:45:21+07:00","author":{"@type":"Person","name":"Fahmi FJ"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fahmifj.github.io/blog/expose-smb-server-to-internet-in-azure/"},"publisher":{"@type":"Organization","name":"Ef's log","logo":{"@type":"ImageObject","url":"https://fahmifj.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class="header sticky"><nav id=navbar class=nav><div class=logo><a href=https://fahmifj.github.io/ accesskey=h title="Fahmi FJ">F's log</a></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://fahmifj.github.io/blog/ title=blog>blog</a></li><li><a href=https://fahmifj.github.io/ctf/ title=ctf>ctf</a></li><li><a href=https://fahmifj.github.io/series/ title=series>series</a></li><li><a href=https://fahmifj.github.io/archives/ title=archives>archives</a></li></ul><div class=search-container><div id=searchBox><input class=searchInput id=searchInput aria-label=search type=search><div class=searchResults-container><span class="search-results hidden" id=searchResults aria-label="search results"></span></div></div><button id=theme-toggle accesskey=t title><svg id="moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></nav></header><div id=mask></div><main class=main><div class=content-wrapper><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://fahmifj.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://fahmifj.github.io/blog/>Blog</a></div><h1 class=post-title>Exposing a Samba Server to the Internet in Azure</h1><p class=post-description>And wait for bad things to happen</p><div class=post-meta><span class=author>Fahmi FJ</span>&nbsp;&#183;&nbsp;<span class=date>July 04, 2021</span>&nbsp;&#183;&nbsp;<span class=meta-read>6 min read</span></div><hr><div class=series-info>Series:&nbsp;<a href=https://fahmifj.github.io/series/sysadmin/>Sysadmin</a></div></header><div class=post-content-container><aside class=toc><div class=inner><ul><li><a href=#vm-configuration--deploy aria-label="VM Configuration &amp;amp; Deploy">VM Configuration & Deploy</a><ul><li><a href=#test-ssh-login aria-label="Test SSH Login">Test SSH Login</a></li></ul></li><li><a href=#samba-configuration aria-label="Samba Configuration">Samba Configuration</a><ul><li><a href=#installation-and-initial-setup aria-label="Installation and Initial Setup">Installation and Initial Setup</a></li><li><a href=#shares-configuration aria-label="Shares Configuration">Shares Configuration</a></li><li><a href=#add-samba-user aria-label="Add Samba User">Add Samba User</a></li></ul></li><li><a href=#expose-to-internet aria-label="Expose to Internet">Expose to Internet</a><ul><li><a href=#allow-inbound-connection aria-label="Allow Inbound Connection">Allow Inbound Connection</a></li><li><a href=#test-access aria-label="Test Access">Test Access</a></li></ul></li></ul></div></aside><div class=post-content><p>Last month, I was asked to setup a Samba/SMB server that is accessible over the Internet. Because it will only be used temporarily, I decided to use an Azure Virtual Machine (VM) instead of buying a dedicated VPS.</p><p>In the end the server was not used though, but I’ll share my documentation about it.</p><p>Before proceeding further, I will state that:</p><blockquote><p>Exposing an SMB Server directly to the Internet is not recommended, or not considered to be &lsquo;best practice&rsquo;. The safest way to make it accessible over the Internet is by setting up a VPN server and putting the SMB inside the VPN network.</p></blockquote><h4 id=goals-and-outcomes>Goals and Outcomes<a class=anchor aria-hidden=true href=#goals-and-outcomes>#</a></h4><p>The goals here are exactly the same as what’s written in the title, but by the end of this post, you should be able to:</p><ul><li>Deploy an Ubuntu server in Azure</li><li>Setup and Configure a Samba server</li><li>Exposing Samba server over Internet (but don&rsquo;t)</li></ul><h4 id=prerequisites>Prerequisites<a class=anchor aria-hidden=true href=#prerequisites>#</a></h4><p>The one and only prerequisite is:</p><ul><li>Azure Account</li></ul><p>Also, since this post won&rsquo;t be detailed step by step, I&rsquo;ll assume that you have:</p><ul><li>Basic knowledge of Azure, at least menu navigation and creating a resource group.</li><li>Basic knowledge of Linux</li></ul><p>Let&rsquo;s jump in!</p><h2 id=vm-configuration--deploy>VM Configuration & Deploy<a class=anchor aria-hidden=true href=#vm-configuration--deploy>#</a></h2><p>At this step, I already have a resource group called <code>IAMF_SMB-TEST</code> and I&rsquo;ll be creating a VM instance inside this resource. It&rsquo;s a small server used by 4-5 users, so B1s will be enough. You&rsquo;re free to customize the VM.</p><p>The VM details of mine can be seen in the following image:</p><p><div class=img-container><img src=imgs/image-20210513170545346.png alt=image-20210513170545346></div></p><p>For authentication to the server, I&rsquo;ll be using an SSH public key here instead of a password. The account for server administration is called <code>azure-smb</code>. Since the authentication is SSH, this VM will have an SSH port open publicly (internet).</p><p><div class=img-container><img src=imgs/image-20210513170638603.png alt=image-20210513170638603></div></p><p>In the following section, I&rsquo;ll use a standard SSD and leave the other settings at their defaults.</p><p><div class=img-container><img src=imgs/image-20210513170710958.png alt=image-20210513170710958></div></p><p>In the <strong>Networking</strong> section, I&rsquo;ll just create a new virtual network. See the following image for details:</p><p><div class=img-container><img src=imgs/image-20210513170824172.png alt=image-20210513170824172></div></p><p>In the <strong>Management</strong> section, because it will be temporary, I&rsquo;ll just disable the boot diagnostics.</p><p><div class=img-container><img src=imgs/image-20210513171009570.png alt=image-20210513171009570></div></p><p>I&rsquo;ll leave the <strong>Advanced</strong> with the default settings and skip the <strong>Tags</strong> section.</p><p>The last section is <strong>Review + Create</strong>, which basically reviews the VM configuration. After I finish the review, I&rsquo;ll press the <strong>Create</strong> button.</p><p><div class=img-container><img src=imgs/image-20210513171153896.png alt=image-20210513171153896></div></p><p>When the <strong>Create</strong> button is clicked, the VM will be automatically deployed.</p><p><div class=img-container><img src=imgs/image-20210513171501031.png alt=image-20210513171501031></div></p><h3 id=test-ssh-login>Test SSH Login<a class=anchor aria-hidden=true href=#test-ssh-login>#</a></h3><p>The next step is to login to the deployed VM instance via SSH using the previously created username and key/password. The public IP of the VM instance can be found at the <code>Dashboard</code> > <code>RESOURCE_GROUP_NAME</code> > <code>PUBLIC_IP_NAME</code>. In my case, it is <code>Dashboard</code> > <code>IAMF_SMB-TEST</code> > <code>smb-server-ip</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ssh -i private_key azure-smb@PUBLIC_IP_ADDRESS
</span></span></code></pre></div><p><div class=img-container><img src=imgs/image-20210513171606268.png alt=image-20210513171606268></div></p><h2 id=samba-configuration>Samba Configuration<a class=anchor aria-hidden=true href=#samba-configuration>#</a></h2><h3 id=installation-and-initial-setup>Installation and Initial Setup<a class=anchor aria-hidden=true href=#installation-and-initial-setup>#</a></h3><p>First thing first, let&rsquo;s update the repository list.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo apt update
</span></span></code></pre></div><p>After that, install <code>Samba</code> with the following command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo apt install samba
</span></span></code></pre></div><p>Once the installation is done, check the Samba service daemon status.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo systemctl status smbd
</span></span><span class=line><span class=cl>● smbd.service - Samba SMB Daemon
</span></span><span class=line><span class=cl>   Loaded: loaded <span class=o>(</span>/lib/systemd/system/smbd.service<span class=p>;</span> enabled<span class=p>;</span> vendor preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>   Active: active <span class=o>(</span>running<span class=o>)</span> since Thu 2021-05-13 10:17:45 UTC<span class=p>;</span> 3min 48s ago
</span></span><span class=line><span class=cl>     Docs: man:smbd<span class=o>(</span>8<span class=o>)</span>
</span></span><span class=line><span class=cl>           man:samba<span class=o>(</span>7<span class=o>)</span>
</span></span><span class=line><span class=cl>           man:smb.conf<span class=o>(</span>5<span class=o>)</span>
</span></span><span class=line><span class=cl> Main PID: <span class=m>2098</span> <span class=o>(</span>smbd<span class=o>)</span>
</span></span><span class=line><span class=cl>   Status: <span class=s2>&#34;smbd: ready to serve connections...&#34;</span>
</span></span><span class=line><span class=cl>    Tasks: <span class=m>4</span> <span class=o>(</span>limit: 1056<span class=o>)</span>
</span></span><span class=line><span class=cl>   CGroup: /system.slice/smbd.service
</span></span><span class=line><span class=cl>           ├─2098 /usr/sbin/smbd --foreground --no-process-group
</span></span><span class=line><span class=cl>           ├─2123 /usr/sbin/smbd --foreground --no-process-group
</span></span><span class=line><span class=cl>           ├─2124 /usr/sbin/smbd --foreground --no-process-group
</span></span><span class=line><span class=cl>           └─2129 /usr/sbin/smbd --foreground --no-process-group
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>May <span class=m>13</span> 10:17:44 smb-server systemd<span class=o>[</span>1<span class=o>]</span>: Starting Samba SMB Daemon...
</span></span><span class=line><span class=cl>May <span class=m>13</span> 10:17:45 smb-server systemd<span class=o>[</span>1<span class=o>]</span>: Started Samba SMB Daemon.
</span></span></code></pre></div><p>Samba is ready, and now let&rsquo;s configure the share folder.</p><h3 id=shares-configuration>Shares Configuration<a class=anchor aria-hidden=true href=#shares-configuration>#</a></h3><p>First, let&rsquo;s create a backup file of the original configuration, so we can reset it to the default configuration, just in case something goes wrong.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo cp /etc/samba/smb.conf<span class=o>{</span>,.backup<span class=o>}</span>
</span></span></code></pre></div><p>Now create a share folder name it <code>sambashare</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ mkdir sambashare
</span></span></code></pre></div><p>Then open the samba configuration file with a text editor like <code>nano</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo nano /etc/samba/smb.conf
</span></span></code></pre></div><p>Go straight to the bottom of the file and add the following lines.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>sambashare<span class=o>]</span>
</span></span><span class=line><span class=cl>    <span class=nv>comment</span> <span class=o>=</span> Samba Share
</span></span><span class=line><span class=cl>    <span class=nv>path</span> <span class=o>=</span> /home/azure-smb/sambashare
</span></span><span class=line><span class=cl>    <span class=nb>read</span> <span class=nv>only</span> <span class=o>=</span> no
</span></span><span class=line><span class=cl>    <span class=nv>browsable</span> <span class=o>=</span> yes
</span></span></code></pre></div><p>Details for configuring share can be read <a href=https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html>here</a> or <a href=https://web.mit.edu/rhel-doc/5/RHEL-5-manual/Deployment_Guide-en-US/s1-samba-configuring.html>here</a>.</p><p>Save the file and restart the SMB daemon with the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo service smbd restart
</span></span></code></pre></div><p>Lastly, update the firewall to allow network traffic for Samba/SMB.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo ufw allow samba
</span></span></code></pre></div><p>This is the basic configuration of creating a Samba share, but from here you can create another share with more complex configuration. Here are my references:</p><ul><li><a href=https://linuxize.com/post/how-to-install-and-configure-samba-on-ubuntu-18-04/>https://linuxize.com/post/how-to-install-and-configure-samba-on-ubuntu-18-04/</a></li><li><a href=https://confluence.jaytaala.com/display/TKB/Create+samba+share+writeable+by+all%2C+group%2C+or+only+a+user>https://confluence.jaytaala.com/display/TKB/Create+samba+share+writeable+by+all%2C+group%2C+or+only+a+user</a></li><li><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-a-samba-share-for-a-small-organization-on-ubuntu-16-04>https://www.digitalocean.com/community/tutorials/how-to-set-up-a-samba-share-for-a-small-organization-on-ubuntu-16-04</a></li></ul><h3 id=add-samba-user>Add Samba User<a class=anchor aria-hidden=true href=#add-samba-user>#</a></h3><p>Currently, our Linux account for administering the server is <code>azure-smb</code> and we can&rsquo;t use this account password to access the SMB shares yet. Instead, we need to create a password and bind it to <code>azure-smb</code>.</p><p>But now, let&rsquo;s just create a dedicated user for SMB called <code>user1</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo useradd --system -s /usr/sbin/nologin user1
</span></span></code></pre></div><p>Assign <code>user1</code> to be the owner of the share</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo chown user1 /home/azure-smb/sambashare
</span></span></code></pre></div><p>After that, create a Samba password for <code>user1</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo smbpasswd -a user1
</span></span><span class=line><span class=cl>New SMB password: 
</span></span><span class=line><span class=cl>Retype new SMB password: 
</span></span><span class=line><span class=cl>Added user user1.
</span></span></code></pre></div><p>Finally, enable the user.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>azure-smb@smb-server:~$ sudo smbpasswd -e user1
</span></span><span class=line><span class=cl>Enabled user user1.
</span></span></code></pre></div><h2 id=expose-to-internet>Expose to Internet<a class=anchor aria-hidden=true href=#expose-to-internet>#</a></h2><h3 id=allow-inbound-connection>Allow Inbound Connection<a class=anchor aria-hidden=true href=#allow-inbound-connection>#</a></h3><p>Now if we want to make it available on the Internet, we have to go back to the Azure Portal to open the SMB port (445) on the NIC Public IP and allow inbound connection through that port. The connection is then forwarded to our SMB port on the NIC Private IP.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>PUBLIC_IP:445 --&gt; PRIVATE_IP:445
</span></span></code></pre></div><p>To do that open up the Networking settings of the SMB VM and click on <strong>Add inbound port rule</strong> button.</p><p><div class=img-container><img src=imgs/image-20210513173838694.png alt=image-20210513173838694></div></p><p>On the new Windows, configure the rule to allow any source (incoming IP) and any source port (incoming port) to connect to the SMB port (445). The details configuration is as follows:</p><p><div class=img-container><img src=imgs/image-20210513173858659.png alt=image-20210513173858659></div></p><p>At the bottom, the configuration is as follows:</p><p><div class=img-container><img src=imgs/image-20210513173929271.png alt=image-20210513173929271></div></p><p>When you&rsquo;re done, click on the <strong>Add</strong> button and the new rule should listed in the <strong>Inbound port rules</strong> section.</p><p><div class=img-container><img src=imgs/image-20210513174018895.png alt=image-20210513174018895></div></p><h3 id=test-access>Test Access<a class=anchor aria-hidden=true href=#test-access>#</a></h3><p>We can use Nmap to see if the SMB port has been opened.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ nmap -p445 -sV VM_PUBLIC_IP
</span></span></code></pre></div><p><div class=img-container><img src=imgs/image-20210513174227862.png alt=image-20210513174227862></div></p><p>To interact with the SMB server via CLI, you can use <code>smbclient</code>. Install it with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt install smbclient
</span></span></code></pre></div><p>Once it installed, connect to the share with following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ smbclient //<span class=o>[</span>IP<span class=o>]</span>/<span class=o>[</span>sharename<span class=o>]</span> 
</span></span></code></pre></div><p>Adding <code>-N -L</code> can list all the available shares.</p><p><div class=img-container><img src=imgs/image-20210513174416250.png alt=image-20210513174416250></div></p><p>You can also provide the password directly in the terminal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ smbclient //<span class=o>[</span>IP<span class=o>]</span>/<span class=o>[</span>sharename<span class=o>]</span> -U <span class=o>[</span>username<span class=o>]</span> <span class=o>[</span>password<span class=o>]</span>
</span></span><span class=line><span class=cl>$ smbclient //<span class=o>[</span>IP<span class=o>]</span>/<span class=o>[</span>sharename<span class=o>]</span> -U <span class=s1>&#39;username%password&#39;</span>
</span></span></code></pre></div><p>And that&rsquo;s all. It is not that detailed, but I hope you will find it useful.</p></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://fahmifj.github.io/tags/azure/>Azure</a></li><li><a href=https://fahmifj.github.io/tags/samba/>Samba</a></li><li><a href=https://fahmifj.github.io/tags/smb/>SMB</a></li><li><a href=https://fahmifj.github.io/tags/linux/>Linux</a></li><li><a href=https://fahmifj.github.io/tags/tutorial/>Tutorial</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Exposing a Samba Server to the Internet in Azure on twitter" href="https://twitter.com/intent/tweet/?text=Exposing%20a%20Samba%20Server%20to%20the%20Internet%20in%20Azure&url=https%3a%2f%2ffahmifj.github.io%2fblog%2fexpose-smb-server-to-internet-in-azure%2f&hashtags=Azure%2cSamba%2cSMB%2cLinux%2cTutorial"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exposing a Samba Server to the Internet in Azure on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2ffahmifj.github.io%2fblog%2fexpose-smb-server-to-internet-in-azure%2f&title=Exposing%20a%20Samba%20Server%20to%20the%20Internet%20in%20Azure&summary=Exposing%20a%20Samba%20Server%20to%20the%20Internet%20in%20Azure&source=https%3a%2f%2ffahmifj.github.io%2fblog%2fexpose-smb-server-to-internet-in-azure%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exposing a Samba Server to the Internet in Azure on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffahmifj.github.io%2fblog%2fexpose-smb-server-to-internet-in-azure%2f&title=Exposing%20a%20Samba%20Server%20to%20the%20Internet%20in%20Azure"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exposing a Samba Server to the Internet in Azure on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffahmifj.github.io%2fblog%2fexpose-smb-server-to-internet-in-azure%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exposing a Samba Server to the Internet in Azure on whatsapp" href="https://api.whatsapp.com/send?text=Exposing%20a%20Samba%20Server%20to%20the%20Internet%20in%20Azure%20-%20https%3a%2f%2ffahmifj.github.io%2fblog%2fexpose-smb-server-to-internet-in-azure%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Exposing a Samba Server to the Internet in Azure on telegram" href="https://telegram.me/share/url?text=Exposing%20a%20Samba%20Server%20to%20the%20Internet%20in%20Azure&url=https%3a%2f%2ffahmifj.github.io%2fblog%2fexpose-smb-server-to-internet-in-azure%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></div></main><footer class=footer><span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a>&nbsp;&&nbsp;<a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>&nbsp;(mod)</span>
<span><span class=copyright>&copy; 2022&nbsp;<a href=https://fahmifj.github.io/about>Fahmi FJ</a></span>
&nbsp;·&nbsp;
<span class=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a></span></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>